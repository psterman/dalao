# 目录解析逻辑深度优化总结

## 🚀 优化目标
解决"获取目录失败"的问题，提高目录解析的准确率和兼容性，特别是针对结构复杂或不规范的小说网站。

## 💡 核心算法改进

### 1. 智能目录链接寻找 (`findCatalogLink`)

**旧逻辑**: 
- 简单匹配 "目录", "章节列表", "Index"。
- 容易匹配到无关链接或找不到链接。

**新逻辑**:
- **多关键词支持**: 增加了 "全部章节", "完整目录", "Chapter List", "Table of Contents" 等关键词。
- **优先级排序**: 优先匹配更明确的关键词（如"全部章节"优于"目录"）。
- **排除干扰**: 排除可能是"返回目录"的链接（如果存在更好的选择），优先选择"查看目录"。

### 2. 基于结构的目录解析 (`parseCatalogFromWebView`)

**旧逻辑**:
- 寻找包含 >5 个链接的容器。
- 强制要求链接文本包含 "章"、"节" 或以数字开头。
- **缺点**: 无法识别只有标题没有数字的目录，容易漏掉章节。

**新逻辑 (State of the Art)**:
- **链接聚类**: 遍历页面所有容器，收集其中的有效链接。
- **评分系统**:
  - **数量得分**: 链接越多得分越高。
  - **文本特征得分**: 如果链接文本包含数字或"章"字，给予额外加分（但不强制要求）。
  - **密度得分**: 计算链接数量与容器文本长度的比率，优先选择链接密集的区域（典型的目录特征）。
- **智能选择**:
  - 计算每个容器的总分。
  - 选择得分最高的容器作为目录区域。
- **兼容性**:
  - 不再强制依赖中文关键词，支持纯英文或纯数字标题。
  - 自动过滤 JS 链接和锚点链接。
  - 忽略 Header/Footer/Nav 等干扰区域。

### 3. 后台加载优化

- **UserAgent 设置**: 模拟真实手机浏览器，防止被网站识别为爬虫拦截。
- **延时执行**: 页面加载完成后等待 500ms 再执行解析脚本，确保动态渲染的内容已就绪。
- **错误处理**: 增加了加载失败的回调处理。

## 📝 修改文件

- `app/src/main/java/com/example/aifloatingball/reader/NovelReaderManager.kt`
  - 更新了 `findCatalogLink` JS 函数。
  - 重写了 `parseCatalogFromWebView` JS 函数。
  - 优化了 `loadCatalogInBackground` 配置。

## 🧪 预期效果

1. **准确率提升**: 能正确识别绝大多数小说网站的目录页。
2. **容错性增强**: 即使目录页包含广告或推荐列表，也能通过评分系统定位到真正的章节列表。
3. **体验优化**: 获取目录的过程更加稳定，减少"获取失败"的情况。

## ⚠️ 建议

如果仍然遇到特定网站无法解析的情况，建议：
1. 检查该网站是否使用了复杂的动态加载（如滚动加载更多）。
2. 检查该网站是否使用了非标准的标签结构（如 `div` 模拟链接）。
3. 考虑添加手动输入目录 URL 的功能作为兜底方案。
