# 搜索tab与AI助手中心档案同步修复测试指南

## 修复内容概述
本次修复解决了用户在搜索tab的AI助手档案中建立新档案，但在设置页面的提示词管理里的AI助手中心没有同步显示的问题：

### 1. 主要修复内容
- **MasterPromptSettingsActivity**：添加档案变更监听器和onResume方法
- **MasterPromptFragment**：修复档案加载逻辑，添加档案变更监听器
- **统一保存机制**：确保所有档案操作都通过SettingsManager触发通知

### 2. 技术实现
- 在MasterPromptSettingsActivity中注册档案变更监听器
- 在MasterPromptFragment中修复loadSavedProfiles方法，从SettingsManager加载真实数据
- 添加onResume方法确保页面切换时数据同步
- 修复createNewProfile方法使用正确的保存机制

## 测试步骤

### 1. 搜索tab新建档案测试

#### 1.1 在搜索tab中新建档案
1. 启动应用
2. 进入搜索tab
3. 点击AI助手按钮，选择"选择AI指令档案"
4. 点击"新建档案"按钮
5. 输入档案名称（如"测试档案1"）
6. 点击"创建"按钮
7. **预期结果**：
   - 显示"档案「测试档案1」创建成功"提示
   - 档案选择器显示新档案
   - 新档案自动被设置为当前活跃档案

#### 1.2 验证档案保存
1. 关闭应用
2. 重新启动应用
3. 进入搜索tab的档案选择器
4. **预期结果**：
   - 新创建的档案仍然存在
   - 档案数据正确保存

### 2. AI助手中心同步测试

#### 2.1 测试实时同步
1. 在搜索tab中新建档案（如"测试档案2"）
2. 不关闭应用，直接进入设置页面
3. 进入"提示词管理" -> "AI助手中心"
4. **预期结果**：
   - AI助手中心立即显示新创建的档案
   - 档案列表是最新的
   - 不需要手动刷新

#### 2.2 测试页面切换同步
1. 在搜索tab中新建档案（如"测试档案3"）
2. 进入AI助手中心
3. 返回搜索tab
4. 再次进入AI助手中心
5. **预期结果**：
   - 每次进入AI助手中心都能看到最新档案
   - 档案数据完全同步

#### 2.3 测试多界面操作
1. 同时打开搜索tab和AI助手中心（通过不同方式）
2. 在搜索tab中新建档案
3. **预期结果**：
   - AI助手中心立即显示新档案
   - 两个界面的档案列表完全一致

### 3. AI助手中心内部操作测试

#### 3.1 测试AI助手中心新建档案
1. 在AI助手中心点击"+"按钮新建档案
2. 输入档案名称并保存
3. 返回搜索tab的档案选择器
4. **预期结果**：
   - 搜索tab的档案选择器显示新档案
   - 档案数据完全同步

#### 3.2 测试AI助手中心修改档案
1. 在AI助手中心选择一个档案
2. 修改档案的各种配置
3. 保存修改
4. 返回搜索tab的档案选择器
5. **预期结果**：
   - 搜索tab中显示修改后的档案信息
   - 档案数据完全同步

#### 3.3 测试AI助手中心删除档案
1. 在AI助手中心删除一个非默认档案
2. 返回搜索tab的档案选择器
3. **预期结果**：
   - 搜索tab中不再显示被删除的档案
   - 档案数据完全同步

### 4. 数据一致性测试

#### 4.1 测试应用重启后的数据一致性
1. 在搜索tab中新建多个档案
2. 在AI助手中心修改一些档案
3. 关闭应用
4. 重新启动应用
5. **预期结果**：
   - 搜索tab和AI助手中心显示完全一致的档案列表
   - 所有修改都正确保存

#### 4.2 测试不同服务间的数据同步
1. 在DynamicIslandService中新建档案
2. 在SimpleModeActivity中查看档案列表
3. 在AI助手中心查看档案列表
4. **预期结果**：
   - 所有界面显示完全一致的档案数据
   - 档案变更实时同步

### 5. 错误处理测试

#### 5.1 测试网络异常情况
1. 断开网络连接
2. 进行档案操作
3. **预期结果**：
   - 本地操作正常进行
   - 数据正确保存到本地存储
   - 同步机制正常工作

#### 5.2 测试存储异常情况
1. 模拟存储空间不足
2. 尝试保存档案
3. **预期结果**：
   - 显示适当的错误提示
   - 不会导致应用崩溃
   - 同步机制不会中断

## 预期结果总结

### 修复前的问题
- 用户在搜索tab中新建档案后，AI助手中心不会显示新档案
- 需要手动刷新或重新打开AI助手中心才能看到新档案
- 不同界面间的档案数据不一致
- MasterPromptFragment使用硬编码数据，不读取真实档案

### 修复后的改进
- ✅ 搜索tab新建档案后，AI助手中心立即显示新档案
- ✅ 所有档案操作都通过统一的通知机制同步
- ✅ MasterPromptFragment从SettingsManager加载真实数据
- ✅ 添加了档案变更监听器，实现实时同步
- ✅ 添加了onResume方法，确保页面切换时数据同步
- ✅ 跨界面档案数据完全一致

## 技术细节

### 1. 通知机制
- 使用SettingsManager的`registerOnSettingChangeListener`注册监听器
- 监听`prompt_profiles`键的变化
- 档案变更时自动触发`notifyListeners`方法

### 2. 数据加载修复
- MasterPromptFragment的`loadSavedProfiles`方法现在从SettingsManager加载真实数据
- 不再使用硬编码的示例数据
- 确保数据来源的一致性

### 3. 保存方法统一
- 所有档案操作都使用`savePromptProfile`方法
- 确保触发通知机制
- 保证数据同步的可靠性

### 4. 生命周期处理
- 添加onResume方法确保页面切换时数据同步
- 在主线程中刷新UI，避免线程安全问题

## 测试完成标准

- [ ] 搜索tab新建档案后，AI助手中心立即显示新档案
- [ ] AI助手中心新建档案后，搜索tab立即显示新档案
- [ ] 档案修改、删除操作在所有界面间实时同步
- [ ] 应用重启后数据完全一致
- [ ] 不同服务间的档案数据完全同步
- [ ] 错误处理机制完善
- [ ] 性能表现良好，无卡顿现象

通过以上测试，确保搜索tab与AI助手中心的档案同步问题得到完美解决，用户体验得到显著提升。

