# 纸堆模式菜单和预览功能修复说明

## 修复的问题

### 1. 原来的enhanced菜单没有了 ❌ → ✅

**问题描述：** 原来的enhanced菜单没有了

**根本原因：** 
- 切换到纸堆模式后，菜单按钮仍然使用原来的抽屉逻辑
- 没有为纸堆模式提供专门的菜单功能
- 缺少纸堆模式下的标签页管理选项

**修复方案：**

#### A. 修改菜单按钮点击逻辑
```kotlin
// 菜单按钮 - 打开搜索引擎侧边栏
browserBtnMenu.setOnClickListener {
    Log.d(TAG, "菜单按钮被点击")
    
    // 检查是否在纸堆模式下
    val paperStackLayout = findViewById<View>(R.id.paper_stack_layout)
    if (paperStackLayout?.visibility == View.VISIBLE) {
        // 在纸堆模式下，显示enhanced菜单
        showEnhancedMenu()
    } else {
        // 在普通模式下，打开抽屉
        if (browserLayout.isDrawerOpen(GravityCompat.START)) {
            Log.d(TAG, "关闭抽屉")
            browserLayout.closeDrawer(GravityCompat.START)
        } else {
            Log.d(TAG, "打开抽屉")
            browserLayout.openDrawer(GravityCompat.START)
        }
    }
}
```

#### B. 添加纸堆模式专用菜单
```kotlin
/**
 * 显示enhanced菜单
 */
private fun showEnhancedMenu() {
    try {
        Log.d(TAG, "显示enhanced菜单")
        
        // 创建菜单选项
        val menuItems = mutableListOf<String>()
        val menuActions = mutableListOf<() -> Unit>()
        
        // 添加标签页管理选项
        val tabCount = paperStackWebViewManager?.getTabCount() ?: 0
        if (tabCount > 0) {
            menuItems.add("关闭当前标签页")
            menuActions.add {
                paperStackWebViewManager?.removeTab(paperStackWebViewManager?.getCurrentTab()?.id ?: "")
            }
            
            menuItems.add("关闭所有标签页")
            menuActions.add {
                paperStackWebViewManager?.cleanup()
            }
            
            menuItems.add("查看所有标签页")
            menuActions.add {
                activateStackedCardPreview()
            }
        }
        
        // 添加新建标签页选项
        menuItems.add("新建标签页")
        menuActions.add {
            val defaultUrl = "https://www.baidu.com"
            val defaultTitle = "百度"
            paperStackWebViewManager?.addTab(defaultUrl, defaultTitle)
        }
        
        // 添加设置选项
        menuItems.add("设置")
        menuActions.add {
            // 可以跳转到设置页面
            Toast.makeText(this, "设置功能", Toast.LENGTH_SHORT).show()
        }
        
        // 显示菜单
        val builder = AlertDialog.Builder(this)
        builder.setTitle("纸堆模式菜单")
        builder.setItems(menuItems.toTypedArray()) { _, which ->
            if (which < menuActions.size) {
                menuActions[which]()
            }
        }
        builder.setNegativeButton("取消", null)
        builder.show()
        
    } catch (e: Exception) {
        Log.e(TAG, "显示enhanced菜单失败", e)
        Toast.makeText(this, "菜单显示失败", Toast.LENGTH_SHORT).show()
    }
}
```

### 2. StackedCardPreview没有联动现在的纵向页面系统 ❌ → ✅

**问题描述：** 左上角的StackedCardPreview没有联动现在的纵向页面系统

**根本原因：**
- `getAllUnifiedCards`方法没有包含纸堆模式的标签页数据
- StackedCardPreview无法获取纸堆模式下的标签页信息
- 缺少纸堆标签页到卡片数据的转换逻辑

**修复方案：**

#### A. 扩展统一卡片数据获取
```kotlin
private fun getAllUnifiedCards(): List<GestureCardWebViewManager.WebViewCardData> {
    try {
        val gestureCards = gestureCardWebViewManager?.getAllCards() ?: emptyList()
        val mobileCards = mobileCardManager?.getAllCards() ?: emptyList()
        val paperStackTabs = paperStackWebViewManager?.tabs ?: emptyList()
        val allCards = mutableListOf<GestureCardWebViewManager.WebViewCardData>()

        Log.d(TAG, "=== 统一卡片数据获取开始 ===")
        Log.d(TAG, "手势管理器状态: ${gestureCardWebViewManager != null}")
        Log.d(TAG, "手机管理器状态: ${mobileCardManager != null}")
        Log.d(TAG, "纸堆管理器状态: ${paperStackWebViewManager != null}")
        Log.d(TAG, "手势卡片数量: ${gestureCards.size}")
        Log.d(TAG, "手机卡片数量: ${mobileCards.size}")
        Log.d(TAG, "纸堆标签页数量: ${paperStackTabs.size}")

        // 先添加手势卡片
        allCards.addAll(gestureCards)
        Log.d(TAG, "添加手势卡片后总数: ${allCards.size}")

        // 再添加手机卡片，避免重复
        var duplicateCount = 0
        mobileCards.forEach { mobileCard ->
            // 检查是否已存在相同的卡片（通过URL或ID判断）
            val isDuplicate = allCards.any { existingCard ->
                existingCard.id == mobileCard.id ||
                (existingCard.url == mobileCard.url && existingCard.url?.isNotEmpty() == true)
            }
            if (!isDuplicate) {
                allCards.add(mobileCard)
                Log.d(TAG, "添加手机卡片: ${mobileCard.title} - ${mobileCard.url}")
            } else {
                duplicateCount++
                Log.d(TAG, "跳过重复卡片: ${mobileCard.title} - ${mobileCard.url}")
            }
        }

        // 添加纸堆标签页数据
        paperStackTabs.forEach { tab ->
            // 检查是否已存在相同的卡片
            val isDuplicate = allCards.any { existingCard ->
                existingCard.url == tab.url && existingCard.url?.isNotEmpty() == true
            }
            if (!isDuplicate) {
                val paperStackCard = GestureCardWebViewManager.WebViewCardData(
                    id = tab.id,
                    title = tab.title,
                    url = tab.url,
                    webView = tab.webView,
                    isActive = tab.isActive
                )
                allCards.add(paperStackCard)
                Log.d(TAG, "添加纸堆标签页: ${tab.title} - ${tab.url}")
            } else {
                duplicateCount++
                Log.d(TAG, "跳过重复纸堆标签页: ${tab.title} - ${tab.url}")
            }
        }

        Log.d(TAG, "统一卡片数据 - 手势卡片: ${gestureCards.size}, 手机卡片: ${mobileCards.size}, 纸堆标签页: ${paperStackTabs.size}, 重复: $duplicateCount, 去重后总计: ${allCards.size}")
        Log.d(TAG, "=== 统一卡片数据获取结束 ===")

        return allCards
    } catch (e: Exception) {
        Log.e(TAG, "获取统一卡片数据异常", e)
        return emptyList()
    }
}
```

## 技术细节

### 菜单系统架构

| 模式 | 菜单类型 | 功能 |
|------|----------|------|
| 普通模式 | 抽屉菜单 | 搜索引擎选择、设置等 |
| 纸堆模式 | Enhanced菜单 | 标签页管理、预览等 |

### 数据统一架构

```kotlin
// 数据源整合
1. 手势卡片 (gestureCardWebViewManager)
2. 手机卡片 (mobileCardManager)  
3. 纸堆标签页 (paperStackWebViewManager) → 转换为卡片数据

// 去重逻辑
- 通过URL和ID判断重复
- 避免同一网页在多个系统中重复显示
```

### 菜单功能映射

| 菜单项 | 功能 | 实现 |
|--------|------|------|
| 关闭当前标签页 | 移除当前标签页 | `paperStackWebViewManager?.removeTab()` |
| 关闭所有标签页 | 清空所有标签页 | `paperStackWebViewManager?.cleanup()` |
| 查看所有标签页 | 激活预览模式 | `activateStackedCardPreview()` |
| 新建标签页 | 添加新标签页 | `paperStackWebViewManager?.addTab()` |
| 设置 | 跳转设置页面 | 待实现 |

## 功能特性

### Enhanced菜单功能
✅ **智能检测** - 自动检测当前模式，显示对应菜单  
✅ **标签页管理** - 关闭当前/所有标签页  
✅ **预览功能** - 查看所有标签页的预览  
✅ **快速操作** - 新建标签页、设置等  

### StackedCardPreview联动
✅ **数据统一** - 整合所有卡片系统的数据  
✅ **实时更新** - 纸堆标签页变化时自动更新  
✅ **去重处理** - 避免重复显示相同网页  
✅ **状态同步** - 预览与纸堆模式状态同步  

## 测试验证

### 菜单功能测试
1. 在纸堆模式下点击菜单按钮
2. 验证显示enhanced菜单
3. 测试各个菜单项功能
4. 验证菜单操作是否生效

### 预览功能测试
1. 添加多个纸堆标签页
2. 点击"查看所有标签页"
3. 验证StackedCardPreview显示纸堆标签页
4. 测试预览中的操作功能

### 数据同步测试
1. 在纸堆模式中添加/删除标签页
2. 验证预览数据实时更新
3. 测试跨模式的数据一致性

## 总结

通过以上修复，纸堆模式现在提供了：

✅ **完整的菜单系统** - 纸堆模式专用的enhanced菜单  
✅ **统一的预览功能** - StackedCardPreview与纸堆模式完全联动  
✅ **智能模式检测** - 根据当前模式显示对应功能  
✅ **数据一致性** - 所有卡片系统数据统一管理  

这些修复确保了纸堆模式具有完整的功能体系，用户可以方便地管理标签页和查看预览，同时保持了与原有系统的兼容性。
