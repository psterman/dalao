# 统一收藏管理系统设计方案

## 📋 一、需求概述

将应用内所有收藏和历史记录整合到AI助手Tab的任务场景中，统一管理，支持丰富的元数据标记和二次整理。

## 🗂️ 二、数据模型设计

### 2.1 统一收藏项数据模型

```kotlin
/**
 * 统一收藏项数据模型
 * 支持所有类型的收藏和历史记录
 */
data class UnifiedCollectionItem(
    // 基础信息
    val id: String = UUID.randomUUID().toString(),
    val title: String,                    // 标题/内容预览
    val content: String,                  // 完整内容（AI回复、文本等）
    val preview: String? = null,          // 预览文本（截取前200字符）
    val thumbnail: String? = null,        // 缩略图路径/URL（图片、视频、网页favicon）
    
    // 收藏类型和来源
    val collectionType: CollectionType,   // 收藏类型（12种）
    val sourceLocation: String,           // 收藏地点（如"AI对话Tab"、"搜索Tab"）
    val sourceDetail: String? = null,     // 收藏来源详情（如"DeepSeek对话"、"百度搜索"）
    
    // 元数据（11个字段）
    val collectedTime: Long = System.currentTimeMillis(),  // 收藏时间
    val customTags: List<String> = emptyList(),            // 自定义标签
    val priority: Priority = Priority.NORMAL,              // 优先级
    val completionStatus: CompletionStatus = CompletionStatus.NOT_STARTED, // 完成状态
    val likeLevel: Int = 0,                                // 喜欢程度（0-5星）
    val emotionTag: EmotionTag = EmotionTag.NEUTRAL,       // 情感标签
    val isEncrypted: Boolean = false,                     // 加密状态
    val reminderTime: Long? = null,                       // 提醒时间（null表示无提醒）
    
    // 类型特定数据（根据collectionType存储不同数据）
    val extraData: Map<String, Any> = emptyMap()  // 扩展数据
) : Serializable

/**
 * 收藏类型枚举（12种）
 */
enum class CollectionType(
    val displayName: String,
    val icon: String,
    val color: Int
) {
    AI_REPLY("AI回复收藏", "🤖", 0xFF2196F3.toInt()),
    SEARCH_HISTORY("搜索历史", "🔍", 0xFF4CAF50.toInt()),
    WEB_BOOKMARK("网页收藏", "🌐", 0xFF2196F3.toInt()),
    EBOOK_BOOKMARK("电子书收藏", "📚", 0xFFFF9800.toInt()),
    IMAGE_COLLECTION("图片收藏", "🖼️", 0xFFE91E63.toInt()),
    VIDEO_COLLECTION("视频收藏", "🎬", 0xFF9C27B0.toInt()),
    READING_HIGHLIGHT("读书划线", "✏️", 0xFF00BCD4.toInt()),
    APP_SEARCH_HISTORY("软件搜索历史", "📱", 0xFF607D8B.toInt()),
    VOICE_SEARCH_HISTORY("语音搜索历史", "🎤", 0xFF795548.toInt()),
    FLOATING_BALL_SEARCH("悬浮球搜索", "⚪", 0xFF009688.toInt()),
    DYNAMIC_ISLAND_SEARCH("灵动岛搜索", "🏝️", 0xFF3F51B5.toInt()),
    CLIPBOARD_HISTORY("剪贴板历史", "📋", 0xFF9E9E9E.toInt())
}

/**
 * 优先级枚举
 */
enum class Priority(val displayName: String, val value: Int) {
    HIGH("高", 3),
    NORMAL("中", 2),
    LOW("低", 1)
}

/**
 * 完成状态枚举
 */
enum class CompletionStatus(val displayName: String) {
    NOT_STARTED("未开始"),
    IN_PROGRESS("进行中"),
    COMPLETED("已完成")
}

/**
 * 情感标签枚举
 */
enum class EmotionTag(val displayName: String) {
    POSITIVE("正面"),
    NEUTRAL("中性"),
    NEGATIVE("负面"),
    INSPIRING("激励"),
    FUNNY("有趣"),
    SERIOUS("严肃")
}
```

### 2.2 扩展数据字段说明

不同类型的收藏项在`extraData`中存储特定数据：

- **AI回复收藏**: `aiServiceType`, `sessionId`, `messageId`, `conversationContext`
- **网页收藏**: `url`, `faviconPath`, `folder`
- **电子书收藏**: `bookTitle`, `author`, `filePath`, `pageIndex`
- **图片收藏**: `imagePath`, `imageSize`, `imageFormat`
- **视频收藏**: `videoUrl`, `videoTitle`, `duration`, `thumbnailUrl`
- **读书划线**: `filePath`, `pageIndex`, `startPosition`, `endPosition`, `highlightColor`
- **搜索历史**: `searchQuery`, `searchEngine`, `searchResultCount`
- **剪贴板历史**: `clipboardText`, `clipboardType`

## 🏗️ 三、UI布局设计

### 3.1 左侧标签分类结构

```
任务场景（左侧竖标签，宽度100dp）
├─ 📌 我的收藏（原有，保留）
├─ 🤖 AI回复收藏 ⭐ 新增
├─ 🔍 搜索历史 ⭐ 新增
│   ├─ 搜索Tab搜索历史
│   ├─ 软件Tab搜索历史
│   ├─ 语音Tab搜索历史
│   ├─ 悬浮球搜索历史
│   └─ 灵动岛搜索历史
├─ 🌐 网页收藏 ⭐ 新增
├─ 📚 电子书收藏 ⭐ 新增
├─ 🖼️ 图片收藏 ⭐ 新增
├─ 🎬 视频收藏 ⭐ 新增
├─ ✏️ 读书划线 ⭐ 新增
└─ 📋 剪贴板历史 ⭐ 新增
```

**标签显示规则**：
- 每个标签显示图标 + 文字
- 选中标签高亮显示（蓝色背景 + 蓝色文字）
- 支持长按拖拽排序
- 支持点击展开子分类（如搜索历史）

### 3.2 右侧列表布局

#### 3.2.1 收藏项卡片布局（item_unified_collection.xml）

```
┌─────────────────────────────────────────┐
│ [图标] 标题文本                    [优先级] │
│        来源信息 · 收藏时间              │
│        ─────────────────────            │
│        内容预览（最多3行）...            │
│        ─────────────────────            │
│        [标签1] [标签2] [情感] [完成状态] │
│        ─────────────────────            │
│        ⭐⭐⭐⭐☆  [加密🔒] [提醒⏰] │
└─────────────────────────────────────────┘
```

**卡片元素说明**：
- **图标区域**：根据`collectionType`显示对应图标（32dp × 32dp）
- **标题**：16sp，粗体，最多2行，超出省略
- **来源信息**：12sp，灰色，格式："来源地点 · 相对时间"
- **内容预览**：14sp，最多3行，超出省略
- **标签区域**：显示自定义标签、情感标签、完成状态（小标签样式）
- **底部信息**：喜欢程度（星星）、加密状态、提醒状态

#### 3.2.2 列表展示模式

支持三种展示模式（通过右上角按钮切换）：
1. **列表模式**：单列，卡片式布局（默认）
2. **网格模式**：2列网格，适合图片/视频收藏
3. **时间线模式**：按时间排序，显示时间轴

### 3.3 编辑界面设计

#### 3.3.1 编辑对话框布局（dialog_edit_collection.xml）

```
┌─────────────────────────────────────┐
│  编辑收藏项                    [关闭] │
├─────────────────────────────────────┤
│  标题: [___________________]        │
│  内容: [___________________]        │
│       [多行文本输入框]               │
│                                      │
│  📋 基础信息                         │
│  收藏类型: [AI回复收藏 ▼]            │
│  收藏地点: [AI对话Tab ▼]             │
│  收藏来源: [DeepSeek对话]            │
│                                      │
│  🏷️ 标签和分类                       │
│  自定义标签: [#标签1] [#标签2] [+]  │
│  优先级: [高] [中] [低]              │
│  完成状态: [未开始] [进行中] [已完成] │
│  喜欢程度: ⭐⭐⭐⭐⭐                │
│  情感标签: [正面] [中性] [负面]...   │
│                                      │
│  🔒 安全和提醒                       │
│  [✓] 加密保护                        │
│  [✓] 设置提醒 [选择时间]             │
│                                      │
│         [取消]      [保存]            │
└─────────────────────────────────────┘
```

**编辑功能**：
- 支持修改所有11个元数据字段
- 标签输入支持自动补全（基于已有标签）
- 优先级、完成状态、喜欢程度、情感标签使用单选/多选控件
- 提醒时间使用日期时间选择器
- 加密状态使用开关控件

### 3.4 筛选和搜索功能

#### 3.4.1 筛选栏（位于右侧列表顶部）

```
[全部] [优先级:高] [未完成] [最近7天] [搜索框🔍]
```

**筛选选项**：
- 按收藏类型筛选
- 按优先级筛选（高/中/低）
- 按完成状态筛选（未开始/进行中/已完成）
- 按时间范围筛选（今天/最近7天/最近30天/全部）
- 按情感标签筛选
- 按自定义标签筛选

#### 3.4.2 搜索功能

- 搜索范围：标题、内容、标签、来源
- 支持关键词高亮显示
- 搜索结果实时更新

## 🔄 四、数据迁移方案

### 4.1 数据来源映射

| 收藏类型 | 数据来源 | 迁移方法 |
|---------|---------|---------|
| AI回复收藏 | `ChatDataManager.favoriteMessages` | 读取收藏消息，转换为`UnifiedCollectionItem` |
| 搜索历史 | `SearchHistoryManager` | 读取搜索历史，按来源分类 |
| 网页收藏 | `BookmarkManager` | 读取书签列表，转换为统一格式 |
| 电子书收藏 | 搜索Tab收藏的书籍 | 从搜索历史中筛选书籍类型 |
| 图片收藏 | 图片收藏管理器（需创建） | 读取图片收藏列表 |
| 视频收藏 | `VideoPlaylistManager` | 读取视频播放列表 |
| 读书划线 | `ReaderDataManager.getAllHighlights()` | 读取划线数据 |
| 软件搜索历史 | `AppSelectionHistoryManager` | 读取应用选择历史 |
| 语音搜索历史 | 语音搜索历史（需创建） | 读取语音搜索记录 |
| 悬浮球搜索历史 | 悬浮球搜索历史（需创建） | 读取悬浮球搜索记录 |
| 灵动岛搜索历史 | 灵动岛搜索历史（需创建） | 读取灵动岛搜索记录 |
| 剪贴板历史 | `ClipboardHelper` | 读取剪贴板历史 |

### 4.2 迁移时机

- **首次启动**：检测到新版本时自动迁移
- **手动迁移**：在设置中提供"迁移收藏数据"选项
- **增量同步**：新收藏项自动添加到统一管理系统

### 4.3 数据兼容性

- 保留原有数据存储，不删除
- 统一管理系统作为新的管理入口
- 支持双向同步（统一管理 → 原系统）

## 📁 五、文件结构

```
app/src/main/java/com/example/aifloatingball/
├── model/
│   ├── UnifiedCollectionItem.kt          # 统一收藏项数据模型
│   ├── CollectionType.kt                  # 收藏类型枚举
│   └── CollectionMetadata.kt              # 元数据相关枚举
├── manager/
│   └── UnifiedCollectionManager.kt        # 统一收藏管理器
├── adapter/
│   ├── UnifiedCollectionAdapter.kt        # 收藏列表适配器
│   └── CollectionTypeAdapter.kt            # 左侧标签适配器
├── fragment/
│   └── TaskFragmentTwoColumn.kt            # 任务Fragment（修改）
├── dialog/
│   ├── EditCollectionDialog.kt             # 编辑收藏对话框
│   └── FilterCollectionDialog.kt           # 筛选对话框
└── res/layout/
    ├── item_unified_collection.xml          # 收藏项卡片布局
    ├── dialog_edit_collection.xml           # 编辑对话框布局
    └── dialog_filter_collection.xml         # 筛选对话框布局
```

## 🎯 六、实现步骤

### 阶段一：数据模型和基础功能（1-2天）
1. ✅ 创建`UnifiedCollectionItem`数据模型
2. ✅ 创建`UnifiedCollectionManager`管理器
3. ✅ 实现基础的增删改查功能

### 阶段二：UI布局实现（2-3天）
1. ✅ 修改`TaskFragmentTwoColumn`，添加新的标签分类
2. ✅ 创建`UnifiedCollectionAdapter`和布局文件
3. ✅ 实现列表展示、筛选、搜索功能

### 阶段三：编辑功能（1-2天）
1. ✅ 创建编辑对话框
2. ✅ 实现所有元数据字段的编辑
3. ✅ 实现标签管理功能

### 阶段四：数据迁移（1-2天）
1. ✅ 实现各数据源的读取和转换
2. ✅ 实现数据迁移逻辑
3. ✅ 测试数据完整性

### 阶段五：优化和测试（1-2天）
1. ✅ 性能优化（大量数据时的分页加载）
2. ✅ UI优化（动画、交互）
3. ✅ 完整测试

## ✅ 七、需求确认（已确认）

### ✅ 问题1：左侧标签分类结构
**已确认**：将4种搜索历史合并为1个"搜索历史"标签，但要标记搜索来源，方便用户识别
- 搜索历史标签下显示子分类：搜索Tab、软件Tab、语音Tab、悬浮球、灵动岛
- 每个搜索历史项显示来源标记

### ✅ 问题2：右侧列表展示模式
**已确认**：支持三种视图模式（网格、卡片、时间线），并可按照多维度排序和过滤
- **排序维度**：新建时间、修改时间、地点、类型、加密状态
- **过滤维度**：时间范围、收藏类型、优先级、完成状态、标签、加密状态

### ✅ 问题3：编辑界面形式
**已确认**：使用侧滑面板（Drawer），包含常用灵活可编辑的分类

### ✅ 问题4：收藏项在不同分类间移动
**已确认**：支持所有收藏项在不同类别间移动和转移

### ✅ 问题5：批量操作
**已确认**：支持批量选中、删除、编辑、移动

### ✅ 问题6：数据导入导出
**已确认**：支持导入/导出到电脑可读的通用数据格式（JSON/CSV）

### ✅ 问题7：搜索面板
**已确认**：设计专门的搜索面板，支持：
- 搜索文本（标题、内容）
- 搜索标签
- 搜索分类
- 过滤时间
- 过滤收藏类型

---

## 📝 实现状态

- [x] 需求确认完成
- [ ] 数据模型实现
- [ ] UI布局实现
- [ ] 功能实现
- [ ] 测试完成

开始实现！

