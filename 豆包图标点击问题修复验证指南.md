# 豆包图标点击问题修复验证指南

## 问题描述
用户在对话tab中和AI对话，通过AI回复的文本下方的豆包图标跳转到豆包app后，但是没有将用户的提问文本提炼并向豆包app直接提问。

## 修复内容

### 1. 优化豆包跳转逻辑
在 `PlatformJumpManager.kt` 中添加了专门针对豆包的Intent发送方法：

```kotlin
/**
 * 尝试使用Intent直接发送文本到豆包应用
 */
private fun tryIntentSendForDoubao(packageName: String, query: String, appName: String): Boolean {
    // 方案1：使用ACTION_SEND直接发送文本
    val sendIntent = Intent().apply {
        action = Intent.ACTION_SEND
        type = "text/plain"
        putExtra(Intent.EXTRA_TEXT, query)
        setPackage(packageName)
        addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
    }
    
    // 方案2：使用豆包特定的URL Scheme
    val doubaoUrl = "doubao://chat?text=${Uri.encode(query)}"
    val urlIntent = Intent(Intent.ACTION_VIEW, Uri.parse(doubaoUrl))
}
```

### 2. 确保悬浮窗功能完整
悬浮窗包含以下功能：
- **返回按钮**：返回到主应用或灵动岛
- **AI按钮**：显示AI菜单，查看更多AI应用
- **关闭按钮**：关闭悬浮窗
- **拖拽功能**：可以拖拽悬浮窗到任意位置

## 验证步骤

### 步骤1：测试豆包图标点击
1. 打开应用，进入对话tab
2. 在输入框中输入问题，例如："你好"
3. 点击发送，等待AI回复
4. 在AI回复下方找到豆包图标
5. 点击豆包图标

### 步骤2：验证文本传递
**预期结果**：
- 豆包应用启动
- 用户原始问题"你好"被传递到豆包
- 显示Toast提示："正在向豆包发送问题..."

**验证方法**：
1. 检查豆包应用是否打开
2. 检查豆包输入框是否包含"你好"
3. 检查Toast提示是否正确显示

### 步骤3：验证悬浮窗功能
**预期结果**：
- 2秒后显示悬浮窗
- 悬浮窗包含三个按钮：返回、AI、关闭
- 悬浮窗可以拖拽

**验证方法**：
1. 等待2秒，检查悬浮窗是否出现
2. 点击"返回"按钮，验证是否返回主应用
3. 点击"AI"按钮，验证是否显示AI菜单
4. 点击"关闭"按钮，验证悬浮窗是否消失
5. 尝试拖拽悬浮窗，验证是否可以移动

### 步骤4：验证AI菜单功能
**预期结果**：
- AI菜单显示多个AI应用图标
- 点击AI应用图标可以跳转到对应应用
- 用户原始问题被复制到剪贴板

**验证方法**：
1. 点击悬浮窗的"AI"按钮
2. 检查AI菜单是否显示
3. 点击任意AI应用图标
4. 验证是否跳转到对应应用
5. 检查剪贴板是否包含用户原始问题

## 技术实现细节

### 数据流
1. **用户提问** → `ChatActivity.sendMessage()` → `ChatMessage(..., messageText)`
2. **AI回复** → `ChatMessageAdapter.bind()` → `showPlatformIcons(message.userQuery)`
3. **平台图标** → `PlatformIconsView.createPlatformIcon()` → `platformJumpManager.jumpToPlatform()`
4. **豆包跳转** → `PlatformJumpManager.jumpToAIApp()` → `tryIntentSendForDoubao()`
5. **悬浮窗** → `showAIAppOverlay()` → `AIAppOverlayService`

### 关键改进
1. **多方案跳转**：Intent发送 + URL Scheme + 剪贴板备选
2. **智能回退**：如果Intent失败，自动回退到剪贴板方案
3. **悬浮窗集成**：所有跳转方式都会显示悬浮窗
4. **用户原始问题保持**：整个流程中用户原始问题始终被正确传递

## 故障排除

### 如果豆包没有接收文本
1. 检查豆包应用是否支持Intent接收
2. 检查剪贴板是否包含用户问题
3. 手动在豆包中粘贴验证

### 如果悬浮窗没有显示
1. 检查悬浮窗权限是否已授予
2. 检查AIAppOverlayService是否正常启动
3. 查看日志输出确认服务状态

### 如果AI菜单没有显示
1. 检查AI应用是否已安装
2. 检查历史应用记录
3. 验证图标加载是否正常

## 日志关键词
- `PlatformJumpManager`: 跳转相关日志
- `AIAppOverlayService`: 悬浮窗相关日志
- `豆包Intent发送成功`: Intent发送成功
- `豆包URL Scheme发送成功`: URL Scheme发送成功
- `显示AI应用悬浮窗`: 悬浮窗显示成功
