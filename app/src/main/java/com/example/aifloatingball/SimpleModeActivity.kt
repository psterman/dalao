
package com.example.aifloatingball

import android.Manifest
import android.animation.AnimatorSet
import android.animation.ObjectAnimator
import android.animation.ValueAnimator
import android.app.Activity
import android.app.ActivityManager
import android.content.ActivityNotFoundException
import android.content.ClipData
import android.content.ClipboardManager
import android.content.Intent
import android.content.pm.PackageManager
import android.net.Uri
import android.content.Context
import android.content.res.ColorStateList
import android.graphics.Bitmap
import android.graphics.Canvas
import android.graphics.Color
import android.graphics.drawable.Drawable
import android.graphics.drawable.GradientDrawable
import androidx.appcompat.app.AlertDialog
import com.example.aifloatingball.voice.VoiceInputManager
import com.example.aifloatingball.voice.VoskManager
import com.example.aifloatingball.adapter.AppSelectionDialogAdapter
import com.example.aifloatingball.adapter.ProfileSelectorAdapter
import com.example.aifloatingball.service.MyAccessibilityService
import com.example.aifloatingball.webview.PaperStackWebViewManager
import android.os.Bundle
import android.os.Handler
import android.os.Looper
import android.speech.RecognitionListener
import android.speech.RecognizerIntent
import android.speech.SpeechRecognizer
import android.text.Editable
import android.text.TextWatcher
import android.util.Log
import android.widget.Toast
import android.view.GestureDetector
import android.view.Gravity
import android.view.LayoutInflater
import android.view.MotionEvent
import android.view.View
import android.view.ViewGroup
import android.view.WindowManager
import android.view.inputmethod.EditorInfo
import android.view.inputmethod.InputMethodManager
import android.view.KeyEvent
import android.text.InputType
import kotlin.math.abs
import android.webkit.WebView
import android.webkit.WebViewClient
import android.webkit.WebResourceRequest
import android.webkit.WebResourceError
import android.webkit.WebChromeClient
import android.webkit.WebSettings
import android.widget.*
import android.widget.ArrayAdapter
import androidx.coordinatorlayout.widget.CoordinatorLayout
import androidx.drawerlayout.widget.DrawerLayout
import androidx.viewpager2.widget.ViewPager2
import com.example.aifloatingball.gesture.TouchConflictResolver
import androidx.core.view.GravityCompat
import androidx.core.view.GestureDetectorCompat
import androidx.core.view.ViewCompat
import androidx.interpolator.view.animation.FastOutSlowInInterpolator
import androidx.swiperefreshlayout.widget.SwipeRefreshLayout
import androidx.recyclerview.widget.GridLayoutManager
import androidx.recyclerview.widget.LinearLayoutManager
import androidx.recyclerview.widget.RecyclerView
import com.google.android.material.appbar.AppBarLayout
import com.google.android.material.button.MaterialButton
import com.google.android.material.card.MaterialCardView
import java.io.File
import org.json.JSONObject
import org.json.JSONArray
import androidx.appcompat.app.AppCompatActivity
import androidx.core.app.ActivityCompat
import androidx.core.content.ContextCompat
import com.example.aifloatingball.manager.ModeManager
import com.example.aifloatingball.manager.AIApiManager
import com.example.aifloatingball.manager.AIServiceType
import com.example.aifloatingball.SettingsManager
import com.example.aifloatingball.manager.SimpleChatHistoryManager
import com.example.aifloatingball.adapter.TaskTemplateAdapter
import com.example.aifloatingball.data.SimpleTaskTemplates
import com.example.aifloatingball.model.PromptTemplate
import com.example.aifloatingball.model.PromptField
import com.example.aifloatingball.model.FieldType
import com.example.aifloatingball.model.PromptProfile
import com.example.aifloatingball.model.UserPromptData
import com.example.aifloatingball.model.ChatContact
import com.example.aifloatingball.model.ContactType
import com.example.aifloatingball.model.ContactCategory
import com.example.aifloatingball.adapter.ChatContactAdapter
import com.example.aifloatingball.manager.AITagManager
import com.example.aifloatingball.model.AppSearchConfig
import com.example.aifloatingball.model.AppCategory
import com.example.aifloatingball.model.AppSearchSettings
import com.example.aifloatingball.adapter.AppSearchGridAdapter
import com.example.aifloatingball.utils.FaviconLoader
import com.example.aifloatingball.ui.TabSwitchAnimationManager
import com.example.aifloatingball.video.FloatingVideoPlayerManager
import com.example.aifloatingball.video.SystemOverlayVideoManager
import com.example.aifloatingball.webview.VideoDetectionBridge
import com.example.aifloatingball.download.DownloadManagerActivity
import com.example.aifloatingball.download.EnhancedDownloadManager
import com.google.gson.Gson
import com.google.gson.reflect.TypeToken
import androidx.lifecycle.lifecycleScope
import kotlinx.coroutines.launch
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.withContext
import kotlinx.coroutines.delay
import kotlinx.coroutines.CompletableDeferred
import kotlinx.coroutines.withTimeout
import java.util.UUID
import kotlinx.coroutines.TimeoutCancellationException
import java.net.HttpURLConnection
import java.net.URL
import android.content.BroadcastReceiver
import android.content.IntentFilter

import com.example.aifloatingball.service.SimpleModeService
import com.example.aifloatingball.service.FloatingWindowService
import com.example.aifloatingball.service.DynamicIslandService
import com.example.aifloatingball.service.DualFloatingWebViewService
import com.example.aifloatingball.voice.VoicePromptBranchManager
import com.example.aifloatingball.manager.UnifiedCollectionManager
import com.example.aifloatingball.model.UnifiedCollectionItem
import com.example.aifloatingball.model.CollectionType
import com.example.aifloatingball.model.Priority
import com.example.aifloatingball.model.CompletionStatus
import com.example.aifloatingball.model.EmotionTag
import com.example.aifloatingball.dialog.NewCardSelectionDialog
import com.example.aifloatingball.model.HistoryEntry
import com.example.aifloatingball.model.BookmarkEntry
import com.example.aifloatingball.webview.MultiPageWebViewManager
import com.example.aifloatingball.webview.CardWebViewManager
import com.example.aifloatingball.webview.GestureCardWebViewManager
import com.example.aifloatingball.webview.MobileCardManager
import com.example.aifloatingball.webview.UnifiedWebViewManager
import com.example.aifloatingball.webview.WebViewManagerAdapter
import com.example.aifloatingball.manager.GroupChatManager
import com.example.aifloatingball.manager.UnifiedGroupChatManager
import com.example.aifloatingball.manager.GroupChatDataChangeListener
import com.example.aifloatingball.manager.GroupChatDataChangeEvent
import com.example.aifloatingball.model.MemberType
import com.example.aifloatingball.model.GroupChat
import com.example.aifloatingball.views.WebViewTabBar
import com.example.aifloatingball.views.MaterialSearchEngineSelector
import com.example.aifloatingball.views.CardPreviewOverlay
import com.example.aifloatingball.views.QuarterArcOperationBar
import com.example.aifloatingball.service.AIAppOverlayService
import com.example.aifloatingball.ui.TabGroupManagerFragment
import com.example.aifloatingball.manager.TabGroupManager
import com.example.aifloatingball.model.TabGroup
import com.example.aifloatingball.adapter.TabGroupAdapter
import com.example.aifloatingball.adapter.GroupItemTouchHelperCallback
import androidx.recyclerview.widget.ItemTouchHelper

import com.example.aifloatingball.engine.SearchEngineHandler
import com.example.aifloatingball.ui.cardview.CardViewModeManager
import com.example.aifloatingball.ui.cardview.TabBarView
import com.example.aifloatingball.model.SearchEngine
import com.example.aifloatingball.model.AISearchEngine
import com.example.aifloatingball.model.SearchEngineCategory
import com.google.android.material.switchmaterial.SwitchMaterial
import android.widget.EditText
import android.widget.Button
import androidx.appcompat.app.AppCompatDelegate
import android.provider.Settings
import android.os.Build
import com.example.aifloatingball.tts.TTSManager
import com.example.aifloatingball.tts.TTSDiagnosticTool
import com.example.aifloatingball.tts.TTSSupportLevel
import com.example.aifloatingball.tts.TTSEngineInfo

class SimpleModeActivity : AppCompatActivity(), VoicePromptBranchManager.BranchViewListener, GroupChatDataChangeListener {

    companion object {
        private const val TAG = "SimpleModeActivity"
        // ä¸ºäº¤äº’æ¨¡å¼å®šä¹‰ä¸€ä¸ªå­˜å‚¨é”®
        private const val KEY_VOICE_INTERACTION_MODE = "voice_interaction_mode"
        // ç”¨äºä¿å­˜å½“å‰ç•Œé¢çŠ¶æ€çš„é”®
        private const val KEY_CURRENT_STATE = "current_state"
        
        /**
         * è·å–å…¨å±€é˜…è¯»æ¨¡å¼ç®¡ç†å™¨å®ä¾‹ï¼ˆä¾› EnhancedMenuManager ä½¿ç”¨ï¼‰
         */
        fun getGlobalReaderModeManager(): com.example.aifloatingball.reader.NovelReaderModeManager? {
            return INSTANCE?.globalReaderModeManager
        }
        // æ‰‹åŠ¿æŒ‡å—æ˜¾ç¤ºæ§åˆ¶
        private const val PREF_GESTURE_GUIDE_SHOWN = "gesture_guide_shown"
        // ç³»ç»Ÿè¯­éŸ³è¾“å…¥è¯·æ±‚ç 
        private const val SYSTEM_VOICE_REQUEST_CODE = 1002
        // è”ç³»äººæ•°æ®æŒä¹…åŒ–ç›¸å…³
        private const val CONTACTS_PREFS_NAME = "chat_contacts"
        private const val KEY_SAVED_CONTACTS = "saved_contacts"
        // Activityè¯·æ±‚ç 
        private const val REQUEST_CODE_ADD_AI_CONTACT = 1101
        private const val REQUEST_CODE_PICK_FILE = 1102
        
        // ä¸Šä¸€æ¬¡é˜…è¯»è®°å½•å­˜å‚¨é”®
        private const val KEY_LAST_READ_URL = "last_read_url"
        private const val KEY_LAST_READ_TIME = "last_read_time"
        private const val PREFS_LAST_READ = "last_read_record"
        
        // å•ä¾‹å®ä¾‹ï¼Œç”¨äºWebViewFactoryè®¿é—®
        @Volatile
        private var INSTANCE: SimpleModeActivity? = null
        
        fun getInstance(): SimpleModeActivity? = INSTANCE
        
        fun isVoiceCapsuleModeActive(): Boolean {
            return INSTANCE?.isVoiceCapsuleMode ?: false
        }
    }

    /**
     * å®‰å…¨å¯åŠ¨Activityçš„é€šç”¨æ–¹æ³•
     */
    private fun safeStartActivity(activityClass: Class<*>, activityName: String) {
        try {
            Log.d(TAG, "å°è¯•å¯åŠ¨$activityName")

            // æ£€æŸ¥Activityç±»æ˜¯å¦å­˜åœ¨
            val intent = Intent(this, activityClass)

            // æ£€æŸ¥æ˜¯å¦æœ‰å¯ä»¥å¤„ç†è¿™ä¸ªIntentçš„Activity
            val resolveInfo = packageManager.resolveActivity(intent, 0)
            if (resolveInfo == null) {
                Log.e(TAG, "æ‰¾ä¸åˆ°å¯ä»¥å¤„ç†Intentçš„Activity: $activityName")
                Toast.makeText(this, "æ— æ³•æ‰¾åˆ°$activityName", Toast.LENGTH_LONG).show()
                return
            }

            Log.d(TAG, "IntentéªŒè¯æˆåŠŸï¼Œå‡†å¤‡å¯åŠ¨$activityName")
            startActivity(intent)
            Log.d(TAG, "$activityName å¯åŠ¨æˆåŠŸ")

        } catch (e: SecurityException) {
            Log.e(TAG, "å¯åŠ¨$activityName æ—¶æƒé™ä¸è¶³", e)
            Toast.makeText(this, "å¯åŠ¨$activityName æƒé™ä¸è¶³", Toast.LENGTH_LONG).show()
        } catch (e: android.content.ActivityNotFoundException) {
            Log.e(TAG, "æ‰¾ä¸åˆ°$activityName", e)
            Toast.makeText(this, "æ‰¾ä¸åˆ°$activityName", Toast.LENGTH_LONG).show()
        } catch (e: Exception) {
            Log.e(TAG, "å¯åŠ¨$activityName å¤±è´¥", e)
            Toast.makeText(this, "å¯åŠ¨$activityName å¤±è´¥: ${e.message}", Toast.LENGTH_LONG).show()
        }
    }

    /**
     * æ£€æµ‹AIåº”ç”¨æ˜¯å¦å·²å®‰è£…
     */
    private fun isAIAppInstalled(packageName: String): Boolean {
        return try {
            packageManager.getPackageInfo(packageName, 0)
            true
        } catch (e: PackageManager.NameNotFoundException) {
            false
        }
    }

    /**
     * è·å–å·²å®‰è£…çš„AIåº”ç”¨åŒ…å
     */
    private fun getInstalledAIPackageName(possiblePackages: List<String>): String? {
        for (packageName in possiblePackages) {
            if (isAIAppInstalled(packageName)) {
                Log.d(TAG, "æ‰¾åˆ°å·²å®‰è£…çš„AIåº”ç”¨: $packageName")
                return packageName
            }
        }
        return null
    }

    /**
     * ç»Ÿä¸€å¤„ç† WebView çš„ URL åŠ è½½é€»è¾‘ï¼š
     * - http/https å†…è”åŠ è½½
     * - å…¶ä»–è‡ªå®šä¹‰ schemeï¼ˆå¦‚ clash://ã€intent://ã€mailto: ç­‰ï¼‰èµ°å¤–éƒ¨åº”ç”¨
     */
    private fun handleUrlForWebView(view: WebView?, url: String): Boolean {
        return try {
            val lower = url.lowercase()
            if (lower.startsWith("http://") || lower.startsWith("https://")) {
                view?.loadUrl(url)
                true
            } else {
                // è‡ªå®šä¹‰ schemeï¼Œå…ˆå¼¹å‡ºç¡®è®¤å¯¹è¯æ¡†å†å°è¯•æ‹‰èµ·å¤–éƒ¨åº”ç”¨
                confirmAndLaunchExternal(view, url)
                true
            }
        } catch (e: Exception) {
            Log.e(TAG, "å¤„ç†WebView URLå¤±è´¥: $url", e)
            true
        }
    }

    /**
     * ä»¿ Alook/Chrome çš„å¤–éƒ¨å”¤èµ·ç¡®è®¤å¯¹è¯æ¡†
     */
    private fun confirmAndLaunchExternal(view: WebView?, targetUrl: String) {
        val originHost = try { Uri.parse(view?.url ?: "").host } catch (_: Exception) { null }
        val displayUrl = if (targetUrl.length > 512) targetUrl.substring(0, 512) + "â€¦" else targetUrl
        val title = if (!originHost.isNullOrBlank()) "$originHost æƒ³å¯åŠ¨ç¬¬ä¸‰æ–¹åº”ç”¨:" else "ç½‘é¡µæƒ³å¯åŠ¨ç¬¬ä¸‰æ–¹åº”ç”¨:"

        val dialog = createThemedDialogBuilder()
            .setTitle(title)
            .setMessage(displayUrl)
            .setNeutralButton("æ‹·è´") { _, _ ->
                try {
                    val cm = getSystemService(Context.CLIPBOARD_SERVICE) as ClipboardManager
                    cm.setPrimaryClip(ClipData.newPlainText("url", targetUrl))
                    Toast.makeText(this, "å·²æ‹·è´", Toast.LENGTH_SHORT).show()
                } catch (_: Exception) {}
            }
            .setNegativeButton("ä¸å…è®¸") { dialog, _ -> dialog.dismiss() }
            .setPositiveButton("å…è®¸") { _, _ ->
                launchExternalFromUrl(view, targetUrl)
            }
            .create()
        
        // ç¡®ä¿å¯¹è¯æ¡†æ–‡å­—åœ¨æš—è‰²/äº®è‰²æ¨¡å¼ä¸‹æ¸…æ™°å¯è§
        dialog.setOnShowListener {
            try {
                // è·å–å½“å‰ä¸»é¢˜çš„æ–‡å­—é¢œè‰²
                val textColorPrimary = ContextCompat.getColor(this, R.color.material_dialog_text_primary)
                val textColorSecondary = ContextCompat.getColor(this, R.color.material_dialog_text_secondary)
                
                // è®¾ç½®æ ‡é¢˜æ–‡å­—é¢œè‰²
                val titleView = dialog.findViewById<TextView>(androidx.appcompat.R.id.alertTitle)
                titleView?.setTextColor(textColorPrimary)
                
                // è®¾ç½®æ¶ˆæ¯æ–‡å­—é¢œè‰²
                val messageView = dialog.findViewById<TextView>(android.R.id.message)
                messageView?.setTextColor(textColorSecondary)
                
                // è®¾ç½®æŒ‰é’®æ–‡å­—é¢œè‰²
                val positiveButton = dialog.getButton(AlertDialog.BUTTON_POSITIVE)
                val negativeButton = dialog.getButton(AlertDialog.BUTTON_NEGATIVE)
                val neutralButton = dialog.getButton(AlertDialog.BUTTON_NEUTRAL)
                
                // ä½¿ç”¨ä¸»é¢˜é¢œè‰²è®¾ç½®æŒ‰é’®æ–‡å­—ï¼Œç¡®ä¿åœ¨æš—è‰²/äº®è‰²æ¨¡å¼ä¸‹éƒ½æ¸…æ™°å¯è§
                val buttonTextColor = ContextCompat.getColor(this, R.color.material_dialog_button_text_outlined)
                positiveButton?.setTextColor(buttonTextColor)
                negativeButton?.setTextColor(buttonTextColor)
                neutralButton?.setTextColor(buttonTextColor)
            } catch (e: Exception) {
                Log.e(TAG, "è®¾ç½®å¯¹è¯æ¡†æ–‡å­—é¢œè‰²å¤±è´¥", e)
            }
        }
        
        dialog.show()
    }

    private fun launchExternalFromUrl(view: WebView?, url: String) {
        val lower = url.lowercase()
        if (lower.startsWith("intent://")) {
            openExternalByIntentUri(view, url)
            return
        }

        val uri = try { Uri.parse(url) } catch (_: Exception) { null }
        if (uri == null) {
            Toast.makeText(this, "æ— æ•ˆé“¾æ¥", Toast.LENGTH_SHORT).show()
            return
        }

        if (uri.scheme.equals("clash", ignoreCase = true)) {
            launchClashUrl(uri)
        } else {
            openExternalByScheme(uri)
        }
    }

    private fun openExternalByIntentUri(view: WebView?, intentUrl: String) {
        try {
            val intent = Intent.parseUri(intentUrl, Intent.URI_INTENT_SCHEME)
            intent.addCategory(Intent.CATEGORY_BROWSABLE)
            intent.flags = Intent.FLAG_ACTIVITY_NEW_TASK

            // ä¼˜å…ˆæŒ‡å®š Clash åŒ…ï¼Œç¡®ä¿ç²¾ç¡®æ‹‰èµ·
            val data = intent.dataString
            if ((intent.`package` == null) && data != null && data.startsWith("clash://")) {
                val clashPkg = getInstalledAIPackageName(listOf("com.github.kr328.clash", "com.github.metacubex.clash"))
                if (!clashPkg.isNullOrBlank()) intent.`package` = clashPkg
            }

            if (intent.resolveActivity(packageManager) != null) {
                startActivity(intent)
                return
            }

            // è§£æ browser_fallback_url
            val fallback = intent.getStringExtra("browser_fallback_url")
            if (!fallback.isNullOrBlank()) {
                view?.loadUrl(fallback)
                return
            }

            Toast.makeText(this, "æœªæ‰¾åˆ°å¯å¤„ç†çš„åº”ç”¨", Toast.LENGTH_SHORT).show()
        } catch (e: Exception) {
            Log.e(TAG, "å¤„ç† intent:// å¤±è´¥", e)
            Toast.makeText(this, "æ‹‰èµ·åº”ç”¨å¤±è´¥", Toast.LENGTH_SHORT).show()
        }
    }

    private fun launchClashUrl(uri: Uri) {
        val candidates = listOf("com.github.kr328.clash", "com.github.metacubex.clash")
        val installed = getInstalledAIPackageName(candidates)

        // å…ˆå°è¯•ç²¾ç¡®åŒ…åå¯åŠ¨
        if (!installed.isNullOrBlank()) {
            try {
                val intent = Intent(Intent.ACTION_VIEW, uri).apply {
                    `package` = installed
                    addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
                }
                startActivity(intent)
                return
            } catch (e: ActivityNotFoundException) {
                Log.w(TAG, "æŒ‡å®šåŒ…åå¯åŠ¨å¤±è´¥ï¼Œå°è¯•é€šç”¨å¤„ç†", e)
            }
        }

        // å†å°è¯•é€šç”¨å¤„ç†
        openExternalByScheme(uri)
    }

    private fun openExternalByScheme(uri: Uri) {
        try {
            val intent = Intent(Intent.ACTION_VIEW, uri).apply {
                addCategory(Intent.CATEGORY_BROWSABLE)
                addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
            }
            if (intent.resolveActivity(packageManager) != null) {
                startActivity(intent)
            } else {
                Toast.makeText(this, "æœªæ‰¾åˆ°å¯å¤„ç†çš„åº”ç”¨", Toast.LENGTH_SHORT).show()
            }
        } catch (e: Exception) {
            Log.e(TAG, "å¤–éƒ¨åº”ç”¨æ‰“å¼€å¤±è´¥: ${uri}", e)
            Toast.makeText(this, "æ‹‰èµ·åº”ç”¨å¤±è´¥", Toast.LENGTH_SHORT).show()
        }
    }
    
    /**
     * å¤„ç†ç‰¹æ®Š scheme URLï¼ˆå¦‚ clash://ã€intent:// ç­‰ï¼‰
     * @param url URL å­—ç¬¦ä¸²
     * @param view WebView å®ä¾‹
     * @return true è¡¨ç¤ºå·²å¤„ç†ï¼ˆå·²æ˜¾ç¤ºå¯¹è¯æ¡†ï¼‰ï¼Œfalse è¡¨ç¤ºéç‰¹æ®Š scheme
     */
    private fun handleSpecialSchemeUrl(url: String, view: WebView?): Boolean {
        if (url.isBlank()) {
            Log.d(TAG, "handleSpecialSchemeUrl: URL ä¸ºç©º")
            return false
        }
        
        // å°è¯•ä» URL ä¸­æå–çœŸå®çš„ç‰¹æ®Š scheme URL
        // ä¾‹å¦‚ï¼šå¦‚æœ URL æ˜¯ "clash://install-config?url=https://..."ï¼Œæˆ‘ä»¬éœ€è¦æå–å‡ºå®Œæ•´çš„ clash:// URL
        var processedUrl = url.trim()
        
        // æ£€æŸ¥æ˜¯å¦åŒ…å« clash:// ä½†å¯èƒ½è¢«æˆªæ–­æˆ–ç¼–ç 
        val lower = processedUrl.lowercase()
        
        // æ£€æŸ¥æ˜¯å¦ä¸º HTTP/HTTPSï¼Œè¿™äº›åº”è¯¥åœ¨ WebView ä¸­åŠ è½½
        if (lower.startsWith("http://") || lower.startsWith("https://")) {
            Log.d(TAG, "handleSpecialSchemeUrl: æ˜¯ HTTP/HTTPS URLï¼Œä¸åœ¨ WebView ä¸­å¤„ç†")
            return false
        }
        
        // æ£€æŸ¥æ˜¯å¦ä¸ºç‰¹æ®Š schemeï¼ˆç›´æ¥åŒ¹é…æˆ–åŒ…å«ï¼‰
        val isSpecialScheme = when {
            lower.startsWith("clash://") -> {
                // clash:// URL å·²ç»å®Œæ•´ï¼Œç›´æ¥ä½¿ç”¨
                Log.d(TAG, "handleSpecialSchemeUrl: æ£€æµ‹åˆ°å®Œæ•´çš„ clash:// URL: $processedUrl")
                true
            }
            lower.startsWith("intent://") -> true
            lower.startsWith("baidumap://") -> true
            lower.startsWith("amap://") -> true
            lower.startsWith("alipay://") -> true
            lower.startsWith("wechat://") -> true
            lower.startsWith("weixin://") -> true
            lower.startsWith("qq://") -> true
            // æ£€æŸ¥æ˜¯å¦åŒ…å«ä»»ä½•å·²çŸ¥çš„ç‰¹æ®Š schemeï¼ˆä»é”™è¯¯ä¿¡æ¯ä¸­æå–ï¼‰
            lower.contains("clash://") -> {
                // ä»é”™è¯¯ä¿¡æ¯ä¸­æå–å®Œæ•´çš„ clash:// URL
                val clashIndex = lower.indexOf("clash://")
                if (clashIndex >= 0) {
                    val remaining = processedUrl.substring(clashIndex)
                    // æå–å®Œæ•´çš„ URLï¼Œç›´åˆ°é‡åˆ°ç©ºæ ¼ã€æ¢è¡Œæˆ–å­—ç¬¦ä¸²æœ«å°¾
                    // ä½†ä¿ç•™æŸ¥è¯¢å‚æ•°ï¼ˆ? åçš„å†…å®¹ï¼‰
                    val spaceIndex = remaining.indexOfFirst { it == ' ' || it == '\n' || it == '\r' }
                    processedUrl = if (spaceIndex > 0) remaining.substring(0, spaceIndex) else remaining
                    Log.d(TAG, "handleSpecialSchemeUrl: ä»é”™è¯¯ä¿¡æ¯ä¸­æå–çš„ clash:// URL: $processedUrl")
                }
                true
            }
            lower.contains("://") && !lower.startsWith("http://") && !lower.startsWith("https://") && 
            !lower.startsWith("file://") && !lower.startsWith("javascript:") -> {
                // å°è¯•æå– scheme
                val schemeIndex = lower.indexOf("://")
                if (schemeIndex > 0) {
                    val scheme = processedUrl.substring(0, schemeIndex + 3)
                    Log.d(TAG, "handleSpecialSchemeUrl: æ£€æµ‹åˆ°æœªçŸ¥ç‰¹æ®Š scheme: $scheme")
                }
                true
            }
            else -> false
        }
        
        if (!isSpecialScheme) {
            Log.d(TAG, "handleSpecialSchemeUrl: ä¸æ˜¯ç‰¹æ®Š scheme URL: $url")
            return false
        }
        
        // å¯¹äºç‰¹æ®Š schemeï¼Œæ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†è®©ç”¨æˆ·é€‰æ‹©æ˜¯å¦æ‰“å¼€å¤–éƒ¨åº”ç”¨
        Log.d(TAG, "handleSpecialSchemeUrl: æ£€æµ‹åˆ°ç‰¹æ®Š scheme URL: $processedUrlï¼Œæ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†")
        
        // ä½¿ç”¨ç°æœ‰çš„ç¡®è®¤å¯¹è¯æ¡†æ–¹æ³•
        confirmAndLaunchExternal(view, processedUrl)
        
        return true // è¿”å› true è¡¨ç¤ºå·²å¤„ç†ï¼Œé˜»æ­¢åœ¨ WebView ä¸­åŠ è½½
    }

    /**
     * é€šç”¨AIåº”ç”¨è·³è½¬æ–¹æ³•
     */
    private fun launchAIAppWithFallback(
        appName: String,
        possiblePackages: List<String>,
        query: String,
        fallbackPackage: String = possiblePackages.firstOrNull() ?: ""
    ) {
        try {
            Log.d(TAG, "å°è¯•å¯åŠ¨$appNameï¼ŒæŸ¥è¯¢: $query")
            
            // é¦–å…ˆæ£€æµ‹å·²å®‰è£…çš„åº”ç”¨
            val installedPackage = getInstalledAIPackageName(possiblePackages)
            if (installedPackage != null) {
                val launchIntent = packageManager.getLaunchIntentForPackage(installedPackage)
                if (launchIntent != null) {
                    launchIntent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
                    startActivity(launchIntent)
                    Toast.makeText(this, "æ­£åœ¨å¯åŠ¨$appName...", Toast.LENGTH_SHORT).show()
                    Log.d(TAG, "${appName}ç›´æ¥å¯åŠ¨æˆåŠŸï¼ŒåŒ…å: $installedPackage")
                    
                    // å»¶è¿Ÿå‘é€æ–‡æœ¬åˆ°å‰ªè´´æ¿
                    Handler(Looper.getMainLooper()).postDelayed({
                        sendQuestionViaClipboard(installedPackage, query, appName)
                    }, 2000)
                    return
                }
            }
            
            // å¦‚æœæ£€æµ‹å¤±è´¥ï¼Œå°è¯•æ‰€æœ‰åŒ…å
            for (packageName in possiblePackages) {
                val launchIntent = packageManager.getLaunchIntentForPackage(packageName)
                if (launchIntent != null) {
                    launchIntent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
                    startActivity(launchIntent)
                    Toast.makeText(this, "æ­£åœ¨å¯åŠ¨$appName...", Toast.LENGTH_SHORT).show()
                    Log.d(TAG, "${appName}ç›´æ¥å¯åŠ¨æˆåŠŸï¼ŒåŒ…å: $packageName")
                    
                    // å»¶è¿Ÿå‘é€æ–‡æœ¬åˆ°å‰ªè´´æ¿
                    Handler(Looper.getMainLooper()).postDelayed({
                        sendQuestionViaClipboard(packageName, query, appName)
                    }, 2000)
                    return
                }
            }
            
            // æ–¹æ³•2: å°è¯•Intentå‘é€
            val intent = Intent(Intent.ACTION_SEND).apply {
                type = "text/plain"
                putExtra(Intent.EXTRA_TEXT, query)
                setPackage(fallbackPackage)
                addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
            }
            
            if (intent.resolveActivity(packageManager) != null) {
                startActivity(intent)
                Toast.makeText(this, "æ­£åœ¨å‘${appName}å‘é€é—®é¢˜...", Toast.LENGTH_SHORT).show()
                Log.d(TAG, "${appName} Intentå‘é€æˆåŠŸ")
                return
            }
            
            // æ–¹æ³•3: å°è¯•å…¶ä»–å¯èƒ½çš„åŒ…å
            for (pkg in possiblePackages) {
                try {
                    val altIntent = Intent(Intent.ACTION_SEND).apply {
                        type = "text/plain"
                        putExtra(Intent.EXTRA_TEXT, query)
                        setPackage(pkg)
                        addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
                    }
                    if (altIntent.resolveActivity(packageManager) != null) {
                        startActivity(altIntent)
                        Toast.makeText(this, "æ­£åœ¨å‘${appName}å‘é€é—®é¢˜...", Toast.LENGTH_SHORT).show()
                        Log.d(TAG, "${appName}å¤‡ç”¨åŒ…åå‘é€æˆåŠŸ: $pkg")
                        return
                    }
                } catch (e: Exception) {
                    Log.w(TAG, "${appName}å¤‡ç”¨åŒ…åå¤±è´¥: $pkg", e)
                }
            }
            
            // æ–¹æ³•4: ä½¿ç”¨å‰ªè´´æ¿å¤‡ç”¨æ–¹æ¡ˆ
            sendQuestionViaClipboard(fallbackPackage, query, appName)
            
        } catch (e: Exception) {
            Log.e(TAG, "${appName}å‘é€å¤±è´¥", e)
            Toast.makeText(this, "${appName}å¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥åº”ç”¨æ˜¯å¦å·²å®‰è£…", Toast.LENGTH_LONG).show()
            sendQuestionViaClipboard(fallbackPackage, query, appName)
        }
    }

    // ç•Œé¢çŠ¶æ€
    private enum class UIState {
        CHAT,              // å¯¹è¯é¡µé¢
        BROWSER,           // æœç´¢é¡µé¢
        AI_ASSISTANT_CENTER, // AIåŠ©æ‰‹ä¸­å¿ƒé¡µé¢
        TASK_SELECTION,    // ä»»åŠ¡é€‰æ‹©é¡µé¢
        STEP_GUIDANCE,     // æ­¥éª¤å¼•å¯¼é¡µé¢
        PROMPT_PREVIEW,    // æç¤ºé¢„è§ˆé¡µé¢
        VOICE,             // è¯­éŸ³é¡µé¢
        APP_SEARCH,        // åº”ç”¨æœç´¢é¡µé¢
        SETTINGS           // è®¾ç½®é¡µé¢
    }

    private var currentState = UIState.AI_ASSISTANT_CENTER
    private var currentTemplate: PromptTemplate? = null
    private var currentStepIndex = 0
    private lateinit var userPromptData: UserPromptData
    private lateinit var settingsManager: SettingsManager
    
    // ä¼šè¯çº§åˆ«çš„æ¢å¤å¯¹è¯æ¡†æ ‡è®°ï¼Œé˜²æ­¢é‡å¤å¼¹å‡º
    private var hasShownRestoreDialog = false

    // è®°å½•ä¸Šæ¬¡æ£€æŸ¥æ¢å¤å¯¹è¯æ¡†çš„æ—¶é—´ï¼Œé¿å…çŸ­æ—¶é—´å†…é‡å¤å¼¹å‡º
    private var lastRestoreCheckTime = 0L
    private val RESTORE_CHECK_INTERVAL = 3000L // 3ç§’é—´éš”

    // UIç»„ä»¶
    private lateinit var chatLayout: LinearLayout
    private lateinit var aiAssistantCenterLayout: LinearLayout
    private lateinit var taskSelectionLayout: LinearLayout
    private lateinit var stepGuidanceLayout: LinearLayout
    private lateinit var promptPreviewLayout: LinearLayout
    private lateinit var voiceLayout: ScrollView
    private lateinit var appSearchLayout: androidx.coordinatorlayout.widget.CoordinatorLayout
    private lateinit var browserLayout: androidx.drawerlayout.widget.DrawerLayout
    private lateinit var settingsLayout: ScrollView
    // private lateinit var modeSwitchWidget: ModeSwitchWidget  // æš‚æ—¶ç¦ç”¨

    // AIåŠ©æ‰‹ä¸­å¿ƒç»„ä»¶
    private lateinit var aiCenterViewPager: androidx.viewpager2.widget.ViewPager2
    private lateinit var aiCenterTabLayout: com.google.android.material.tabs.TabLayout
    private lateinit var aiCenterPagerAdapter: com.example.aifloatingball.adapter.AIAssistantCenterPagerAdapter

    // ä»»åŠ¡é€‰æ‹©é¡µé¢ç»„ä»¶
    private lateinit var taskRecyclerView: RecyclerView
    private lateinit var taskAdapter: TaskTemplateAdapter
    private lateinit var directSearchInput: EditText
    private lateinit var directSearchButton: ImageButton

    // æ­¥éª¤å¼•å¯¼é¡µé¢ç»„ä»¶
    private lateinit var stepTitleText: TextView
    private lateinit var stepQuestionText: TextView
    private lateinit var stepInputLayout:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              LinearLayout
    private lateinit var stepInputText: EditText
    private lateinit var stepChoiceGroup: RadioGroup
    private lateinit var stepMultiChoiceLayout: LinearLayout
    private lateinit var nextStepButton: MaterialButton
    private lateinit var prevStepButton: MaterialButton
    private lateinit var skipStepButton: MaterialButton

    // Prompté¢„è§ˆé¡µé¢ç»„ä»¶
    private lateinit var finalPromptText: TextView
    private lateinit var recommendedEnginesText: TextView
    private lateinit var executeSearchButton: MaterialButton
    private lateinit var backToTasksButton: MaterialButton

    // è¯­éŸ³é¡µé¢ç»„ä»¶
    private lateinit var voiceMicContainer: MaterialCardView
    private lateinit var voiceMicIcon: ImageView
    private lateinit var voiceMicRipple: MaterialCardView
    private lateinit var voiceRecordingIndicator: View
    private lateinit var voiceStatusText: TextView
    private lateinit var voiceTextInputLayout: LinearLayout
    private lateinit var voiceTextInput: EditText
    private lateinit var voiceClearButton: MaterialButton
    private lateinit var voicePauseButton: MaterialButton
    private lateinit var voiceSaveButton: MaterialButton
    private lateinit var voiceSearchButton: MaterialButton
    private lateinit var voiceInteractionModeSwitch: com.google.android.material.switchmaterial.SwitchMaterial
    
    // å½•éŸ³ç›¸å…³
    private var audioRecorderManager: com.example.aifloatingball.voice.AudioRecorderManager? = null
    private var recordingTagManager: com.example.aifloatingball.voice.VoiceRecordingTagManager? = null
    private var isRecordingAudio = false
    private var isRecordingPaused = false
    private var currentRecordingFile: File? = null
    
    // å½•éŸ³è®¡æ—¶å™¨
    private var recordingTimerHandler: Handler? = null
    private var recordingTimerRunnable: Runnable? = null
    private var recordingStartTime: Long = 0
    private var totalPausedTime: Long = 0
    
    // è½¬æ¢è®¡æ—¶å™¨ç›¸å…³
    private var conversionTimerHandler: Handler? = null
    private var conversionTimerRunnable: Runnable? = null
    private var conversionStartTime: Long = 0
    private var totalConversionPausedTime: Long = 0
    private var conversionPauseStartTime: Long = 0  // æš‚åœå¼€å§‹æ—¶é—´
    private var isConversionPaused: Boolean = false
    
    // æ–‡æœ¬è½¬åŒ–è®¡æ—¶å™¨ç›¸å…³ï¼ˆæ–‡æœ¬è½¬åŒ–æ—¶å¼€å§‹è®¡æ—¶ï¼‰
    private var textConversionTimerHandler: Handler? = null
    private var textConversionTimerRunnable: Runnable? = null
    private var textConversionStartTime: Long = 0
    private var totalTextConversionPausedTime: Long = 0
    private var textConversionPauseStartTime: Long = 0
    private var isTextConversionPaused: Boolean = false
    private var hasTextConverted: Boolean = false  // æ˜¯å¦æœ‰æ–‡æœ¬è½¬åŒ–
    
    // è¯­éŸ³æ–‡æœ¬æ ‡ç­¾ç®¡ç†å™¨
    private var voiceTextTagManager: com.example.aifloatingball.voice.VoiceTextTagManager? = null

    // éœ€è¦æ ¹æ®è¯­éŸ³æ”¯æŒæƒ…å†µæ§åˆ¶æ˜¾ç¤ºçš„UIå…ƒç´ 
    private var voiceHintText: TextView? = null
    private var voiceSettingsCard: MaterialCardView? = null
    private var voiceModelStatusText: TextView? = null
    private var voiceModelStatusContainer: LinearLayout? = null
    private var voiceModelSegmentedControl: com.example.aifloatingball.ui.IOSSegmentedControl? = null
    private var downloadProgressBottomSheet: com.google.android.material.bottomsheet.BottomSheetDialog? = null

    // åº”ç”¨æœç´¢é¡µé¢ç»„ä»¶
    private lateinit var appCategorySidebar: LinearLayout
    private lateinit var appSearchInput: EditText
    private lateinit var appSearchHint: TextView
    private lateinit var appSearchGrid: RecyclerView
    private lateinit var appSearchAdapter: AppSearchGridAdapter
    private var currentAppCategory = AppCategory.ALL
    private var currentAppConfigs = mutableListOf<AppSearchConfig>()
    private lateinit var appSearchSettings: AppSearchSettings
    private lateinit var searchHistoryManager: SearchHistoryManager
    private lateinit var appSortManager: com.example.aifloatingball.manager.AppSortManager
    private lateinit var appUsageTracker: com.example.aifloatingball.manager.AppUsageTracker
    private lateinit var categoryDragHelper: CategoryDragHelper
    private lateinit var appSelectionHistoryManager: AppSelectionHistoryManager

    // æ–°çš„åº”ç”¨å›¾æ ‡æ˜¾ç¤ºç»„ä»¶
    private lateinit var selectedAppIconContainer: com.google.android.material.card.MaterialCardView
    private lateinit var selectedAppIcon: ImageView
    // å½“å‰é€‰ä¸­çš„appé…ç½®ï¼ˆç”¨äºè‡ªåŠ¨æ‰§è¡Œæœç´¢ï¼‰
    private var currentSelectedAppConfig: AppSearchConfig? = null

    // æµè§ˆå™¨é¡µé¢ç»„ä»¶ - å¤šé¡µé¢WebViewç‰ˆæœ¬
    private lateinit var browserWebViewContainer: FrameLayout
    private lateinit var browserHomeContent: LinearLayout
    private lateinit var browserBtnClose: TextView
    private lateinit var browserSearchInput: EditText
    
    // ğŸ”§ ä¿®å¤4ï¼šæœç´¢è¾“å…¥æ¡†æ–‡å­—å·¥å…·æ ç›¸å…³
    private var searchInputToolbarContainer: View? = null
    private var searchInputToolbarLayout: LinearLayout? = null
    private var isKeyboardVisible = false // è½¯é”®ç›˜æ˜¾ç¤ºçŠ¶æ€
    
    // ä¸Šæ»‘æ¿€æ´»æ‚¬æµ®å¡ç‰‡ç›¸å…³å˜é‡
    private var swipeUpStartY = 0f
    private var swipeUpStartTime = 0L
    private var isSwipeUpActivating = false
    private val SWIPE_UP_THRESHOLD = 60f // ä¸Šæ»‘è·ç¦»é˜ˆå€¼ï¼ˆdpè½¬pxï¼‰
    private val SWIPE_UP_VELOCITY_THRESHOLD = 600f // ä¸Šæ»‘é€Ÿåº¦é˜ˆå€¼ï¼ˆpx/sï¼‰
    private var swipeUpProgress = 0f // ä¸Šæ»‘è¿›åº¦ï¼ˆ0-1ï¼‰
    private var swipeUpStartX = 0f // è®°å½•èµ·å§‹Xåæ ‡ï¼Œç”¨äºåˆ¤æ–­æ˜¯å¦ä¸ºå‚ç›´æ»‘åŠ¨
    private lateinit var browserBtnMenu: ImageButton
    private lateinit var browserProgressBar: ProgressBar
    private var browserLoadingOverlay: FrameLayout? = null // ğŸ”§ æ–°å¢ï¼šé¡µé¢åŠ è½½é®ç½©å±‚
    private lateinit var browserTabContainer: LinearLayout
    private lateinit var browserTabBar: WebViewTabBar
    private lateinit var browserNewTabButton: ImageButton

    // Safarié£æ ¼åŠŸèƒ½ç»„ä»¶
    private lateinit var browserToolbar: LinearLayout
    private lateinit var browserSwipeRefresh: SwipeRefreshLayout
    private lateinit var browserBtnClear: ImageButton
    private lateinit var browserBtnAi: ImageButton
    private lateinit var browserBtnSite: ImageButton
    
    // Safarié£æ ¼ä¸‹æ‹‰å·¥å…·æ 
    private lateinit var browserPullDownToolbar: FrameLayout
    private lateinit var pullDownToolbarButtons: LinearLayout
    private lateinit var pullDownBtnBack: LinearLayout
    private lateinit var pullDownBtnClose: LinearLayout
    private lateinit var pullDownBtnRefresh: LinearLayout
    private lateinit var pullDownBtnHome: LinearLayout
    private lateinit var pullDownBtnSecret: LinearLayout
    private lateinit var pullDownIndicator: View
    private var pullDownButtons: Array<LinearLayout>? = null
    private var isPullDownToolbarVisible = false
    private var pullDownAnimation: android.animation.ValueAnimator? = null
    private var selectedButtonIndex = -1 // å½“å‰é€‰ä¸­çš„æŒ‰é’®ç´¢å¼•
    
    // ç»„æ ‡ç­¾æ ç›¸å…³
    private var groupTabsContainer: HorizontalScrollView? = null
    private var groupTabsLayout: LinearLayout? = null
    private val groupChips = mutableMapOf<String, com.google.android.material.chip.Chip>()

    // éœ‡åŠ¨åé¦ˆç®¡ç†å™¨
    private var vibrator: android.os.Vibrator? = null

    // é˜²é‡å¤ç‚¹å‡»ä¿æŠ¤
    private var lastSearchTabClickTime = 0L
    private val SEARCH_TAB_CLICK_INTERVAL = 500L // 500msé˜²é‡å¤ç‚¹å‡»é—´éš”
    
    // åŒå‡»æ£€æµ‹
    private var lastSearchTabDoubleClickTime = 0L
    private val DOUBLE_CLICK_INTERVAL = 300L // 300msåŒå‡»é—´éš”

    // å¤šé¡µé¢WebViewç®¡ç†å™¨
    private var multiPageWebViewManager: MultiPageWebViewManager? = null
    
    // çº¸å †WebViewç®¡ç†å™¨
    private var paperStackWebViewManager: PaperStackWebViewManager? = null
    
    // ç»Ÿä¸€WebViewç®¡ç†å™¨
    private lateinit var unifiedWebViewManager: UnifiedWebViewManager
    
    // ğŸ”§ å…¨å±€é˜…è¯»æ¨¡å¼ç®¡ç†å™¨å®ä¾‹ï¼ˆç¡®ä¿æ‰€æœ‰åœ°æ–¹ä½¿ç”¨åŒä¸€ä¸ªå®ä¾‹ï¼Œç›‘å¬å™¨ä¸è¢«è¦†ç›–ï¼‰
    private var globalReaderModeManager: com.example.aifloatingball.reader.NovelReaderModeManager? = null
    
    // ğŸ”§ é˜…è¯»æ¨¡å¼2ï¼ˆåŸç”Ÿé˜…è¯»æ¨¡å¼ï¼‰UIå®ä¾‹
    private var novelReaderUI2: com.example.aifloatingball.reader.NovelReaderUI? = null
    private var isReaderMode2Initialized = false
    private var isToolbarControllerCalling = false // é˜²æ­¢å·¥å…·æ æ§åˆ¶å™¨é€’å½’è°ƒç”¨
    private var isPullDownToolbarDetectionEnabled = true // ä¸‹æ‹‰å·¥å…·æ æ£€æµ‹æ˜¯å¦å¯ç”¨
    
    // ç›®å½•é¡µé˜…è¯»æ¨¡å¼æŒ‰é’®ï¼ˆè‡ªåŠ¨å¼¹å‡ºï¼‰
    private var catalogReaderModeButton: MaterialButton? = null
    private var catalogReaderModeButtonContainer: FrameLayout? = null

    // èŠå¤©è”ç³»äººç›¸å…³
    private var chatContactAdapter: ChatContactAdapter? = null
    private var allContacts = mutableListOf<ContactCategory>()
    private var currentFilteredContacts = mutableListOf<ContactCategory>()

    // æ ‡ç­¾åˆ‡æ¢åŠ¨ç”»ç®¡ç†å™¨
    private val tabSwitchAnimationManager = TabSwitchAnimationManager()
    private var currentTabPosition = 0

    // æ ‡ç­¾é¡µæ‹–æ‹½çŠ¶æ€æ ‡å¿—
    private var isDraggingTabs = false

    // æ ‡ç­¾é¡µåˆå§‹åŒ–å®Œæˆæ ‡å¿—
    private var isTabsInitialized = false



    // æ‰‹åŠ¿å¡ç‰‡å¼WebViewç®¡ç†å™¨
    private var gestureCardWebViewManager: GestureCardWebViewManager? = null

    // æ–°çš„æ‰‹æœºå¡ç‰‡ç®¡ç†å™¨
    private var mobileCardManager: MobileCardManager? = null

    // å››åˆ†ä¹‹ä¸€åœ†å¼§æ“ä½œæ 
    private var quarterArcOperationBar: QuarterArcOperationBar? = null

    // è¯­éŸ³èƒ¶å›Šä¸‰æ®µå¼å¸ƒå±€ç›¸å…³
    private var voiceCapsuleLayout: LinearLayout? = null
    private var voiceCapsuleTextInput: EditText? = null
    private var voiceCapsuleSearchInput: EditText? = null
    private var voiceCapsuleWebViewContainer: FrameLayout? = null
    private var voiceCapsuleWebView: WebView? = null
    private var isVoiceCapsuleMode = false
    private var shouldContinueRecording = true
    
    // å¤šæ ‡ç­¾æœç´¢å¼•æ“ä¿¡æ¯æµç›¸å…³
    private var voiceCapsuleCardViewManager: CardViewModeManager? = null
    private var voiceCapsuleTabBarView: TabBarView? = null
    private var voiceCapsuleTabBarContainer: FrameLayout? = null
    private var voiceCapsuleCardViewContainer: FrameLayout? = null
    private var voiceCapsuleSearchHandler: Handler? = null
    private var voiceCapsuleLastSearchQuery: String = ""
    
    // è¯­éŸ³èƒ¶å›Šå¹³å°å›¾æ ‡ç›¸å…³
    private var voiceCapsulePlatformIconsContainer: LinearLayout? = null
    private var voiceCapsulePlatformIconsView: com.example.aifloatingball.ui.PlatformIconsView? = null
    private var voiceCapsuleAIAppsContainer: LinearLayout? = null
    private var voiceCapsuleAIAppsView: LinearLayout? = null

    // APIå¯†é’¥åŒæ­¥å¹¿æ’­æ¥æ”¶å™¨
    private var apiKeySyncReceiver: BroadcastReceiver? = null
    private var addAIContactReceiver: BroadcastReceiver? = null
    private var groupChatCreatedReceiver: BroadcastReceiver? = null
    
    // é“¾æ¥æ“ä½œå¹¿æ’­æ¥æ”¶å™¨
    private var linkActionReceiver: BroadcastReceiver? = null
    
    // é¦–é¡µæŒ‰é’®åˆ·æ–°å¹¿æ’­æ¥æ”¶å™¨
    private var homeButtonRefreshReceiver: BroadcastReceiver? = null
    
    // ç¾¤èŠç®¡ç†å™¨
    // ç»Ÿä¸€ç¾¤èŠç®¡ç†å™¨
    private lateinit var unifiedGroupChatManager: UnifiedGroupChatManager


    private lateinit var browserShortcutsGrid: androidx.recyclerview.widget.RecyclerView
    private lateinit var browserGestureHint: TextView
    private lateinit var browserNavDrawer: LinearLayout
    private lateinit var browserLetterTitle: TextView
    private lateinit var browserPreviewEngineList: androidx.recyclerview.widget.RecyclerView
    private lateinit var draggableEngineAdapter: com.example.aifloatingball.adapter.DraggableSearchEngineAdapter
    private lateinit var browserExitButton: Button
    private lateinit var browserLetterIndexBar: com.example.aifloatingball.view.LetterIndexBar
    private lateinit var browserGestureOverlay: FrameLayout
    private lateinit var browserGestureHintClose: MaterialButton
    private lateinit var cardPreviewOverlay: CardPreviewOverlay

    // æœç´¢tabæ‰‹åŠ¿é®ç½©åŒºç›¸å…³
    private var searchTabGestureOverlay: FrameLayout? = null
    private var isSearchTabGestureOverlayActive = false
    private var gestureDetectorForOverlay: GestureDetectorCompat? = null
    
    
    // ä¿å­˜tabåŸå§‹å¸ƒå±€å‚æ•°ï¼Œç”¨äºæ¢å¤
    private val originalTabLayoutParams = mutableMapOf<Int, ViewGroup.LayoutParams>()
    private val originalTabTextViews = mutableMapOf<Int, TextView?>()
    private var navBackButton: Button? = null
    private var navForwardButton: Button? = null



    // æ‰‹åŠ¿çŠ¶æ€è·Ÿè¸ª
    private var isLongPressDetected = false
    private var isDoubleTapDetected = false

    // Safarié£æ ¼åŠŸèƒ½çŠ¶æ€
    private var isToolbarVisible = true
    private var lastScrollY = 0
    private var toolbarAnimator: android.animation.ValueAnimator? = null
    private val toolbarHideThreshold = 80  // ç´¯è®¡æ»šåŠ¨é«˜åº¦é˜ˆå€¼ï¼ˆæ›´æ˜“è§¦å‘ï¼‰
    private val toolbarShowThreshold = 20  // åå‘æ»šåŠ¨è½»é˜ˆå€¼
    
    // åº•éƒ¨å¿«æ·æ“ä½œæ 
    private lateinit var browserQuickActionsBar: LinearLayout
    private var isQuickActionsBarVisible = false
    private var quickActionsBarAnimator: android.animation.ValueAnimator? = null

    // åº•éƒ¨å¯¼èˆªæ æ˜¾éšæ§åˆ¶
    private var isBottomNavVisible = true
    private var bottomNavAnimator: android.animation.ValueAnimator? = null

    // æµè§ˆå™¨åŠŸèƒ½ç›¸å…³
    private lateinit var browserGestureDetector: GestureDetectorCompat
    private var currentSearchEngine: com.example.aifloatingball.model.SearchEngine? = null

    // Materialæ³¢æµªè¿½è¸ªå™¨ï¼ˆå·²å¼ƒç”¨ï¼‰
    private var materialWaveTracker: com.example.aifloatingball.views.MaterialWaveTracker? = null

    // å±‚å å¡ç‰‡é¢„è§ˆå™¨
    private var stackedCardPreview: com.example.aifloatingball.views.StackedCardPreview? = null

    // è§¦æ‘¸å†²çªè§£å†³å™¨
    private var touchConflictResolver: TouchConflictResolver? = null

    // æ‚¬æµ®è§†é¢‘æ’­æ”¾å™¨ï¼ˆä¼˜å…ˆç³»ç»Ÿçº§è¦†ç›–ï¼Œå…¶æ¬¡Activityå†…è¦†ç›–ï¼‰
    private lateinit var systemOverlayVideoManager: SystemOverlayVideoManager
    private lateinit var floatingVideoManager: FloatingVideoPlayerManager



    // éšè—çš„ç»„ä»¶ç”¨äºå…¼å®¹æ€§
    private lateinit var browserViewPager: androidx.viewpager2.widget.ViewPager2
    private lateinit var browserTabPreviewContainer: LinearLayout
    private lateinit var browserBtnAddTab: ImageButton
    private lateinit var browserAppbar: com.google.android.material.appbar.AppBarLayout
    private lateinit var browserVoiceSearch: ImageButton
    private lateinit var browserBottomBar: LinearLayout
    private lateinit var browserLeftButtons: LinearLayout
    private lateinit var browserRightButtons: LinearLayout
    private lateinit var browserBtnHistory: ImageButton
    private lateinit var browserBtnBookmarks: ImageButton
    private lateinit var browserBtnSettings: ImageButton
    private lateinit var browserAutoHideSwitch: androidx.appcompat.widget.SwitchCompat
    private lateinit var browserClipboardSwitch: androidx.appcompat.widget.SwitchCompat

    // è¯­éŸ³è¯†åˆ«ç›¸å…³
    private var speechRecognizer: SpeechRecognizer? = null
    private var isListening = false
    private var isVoiceRecognitionPaused = false  // è¯­éŸ³è¯†åˆ«æš‚åœçŠ¶æ€
    private var recognizedText = ""  // å·²ç¡®è®¤çš„æœ€ç»ˆæ–‡æœ¬
    private var currentPartialText = ""  // å½“å‰éƒ¨åˆ†è¯†åˆ«ç»“æœï¼ˆä¸´æ—¶æ˜¾ç¤ºï¼‰
    private var lastRecognizedText = ""  // ä¸Šä¸€æ¬¡è¯†åˆ«çš„æ–‡æœ¬ï¼Œç”¨äºå»é‡
    private lateinit var voiceInputManager: VoiceInputManager
    private var voiceSupportInfo: VoiceInputManager.VoiceSupportInfo? = null
    private val handler = Handler(Looper.getMainLooper())
    
    // Voskç¦»çº¿è¯­éŸ³è¯†åˆ«ç›¸å…³
    private var voskManager: VoskManager? = null
    private var isVoskInitialized = false
    
    // TTSæœ—è¯»ç›¸å…³
    private lateinit var ttsManager: TTSManager
    private var isTTSEnabled = false
    
    // éº¦å…‹é£æŒ‰é’®æ¨¡å¼ï¼štrueä¸ºTTSæœ—è¯»æ¨¡å¼ï¼Œfalseä¸ºè¯­éŸ³è¾“å…¥æ¨¡å¼
    private var isMicInTTSMode = false

    // è¯­éŸ³æç¤ºåˆ†æ”¯ç®¡ç†å™¨
    private lateinit var promptBranchManager: VoicePromptBranchManager
    
    // è¯­éŸ³å‘½ä»¤ç®¡ç†å™¨
    private lateinit var voiceCommandManager: com.example.aifloatingball.voicecommand.VoiceCommandManager

    // é•¿æŒ‰å¤„ç†ç›¸å…³
    private val longPressHandler = Handler(Looper.getMainLooper())
    private var isLongPress = false
    private val longPressRunnable = Runnable {
        isLongPress = true
        // é•¿æŒ‰å¼€å§‹ï¼Œå‡†å¤‡åˆ‡æ¢éº¦å…‹é£æ¨¡å¼
        // å®é™…çš„æ¨¡å¼åˆ‡æ¢åœ¨ACTION_UPäº‹ä»¶ä¸­å¤„ç†
    }

    // è®¾ç½®é¡µé¢ç»„ä»¶ - æ‰©å±•æ‰€æœ‰è®¾ç½®é€‰é¡¹
    private lateinit var displayModeSpinner: Spinner
    private lateinit var windowCountSpinner: Spinner
    private lateinit var clipboardMonitorSwitch: SwitchMaterial
    private lateinit var autoHideSwitch: SwitchMaterial
    private lateinit var aiModeSwitch: SwitchMaterial
    private lateinit var themeModeSpinner: Spinner
    private lateinit var ballAlphaSeekbar: SeekBar
    private lateinit var leftHandedSwitch: SwitchMaterial
    private lateinit var autoPasteSwitch: SwitchMaterial
    private lateinit var multiTabBrowserSwitch: SwitchMaterial
    private lateinit var notificationListenerSwitch: SwitchMaterial
    private lateinit var voskOfflineVoiceSwitch: SwitchMaterial


    private lateinit var floatingBallSettingsContainer: MaterialCardView
    private lateinit var aiApiSettingsItem: LinearLayout
    private lateinit var searchEngineSettingsItem: LinearLayout
    private lateinit var aiSearchEngineSettingsItem: LinearLayout
    private lateinit var masterPromptSettingsItem: LinearLayout
    private lateinit var appSearchSettingsItem: LinearLayout
    private lateinit var permissionManagementItem: LinearLayout
    private lateinit var viewSearchHistoryItem: LinearLayout
    private lateinit var onboardingGuideItem: LinearLayout
    private lateinit var bottomNavTabsRecyclerView: RecyclerView
    private lateinit var bottomNavTabSettingsAdapter: com.example.aifloatingball.adapter.BottomNavTabSettingsAdapter
    private lateinit var appVersionText: TextView

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)

        Log.d(TAG, "onCreate called")
        
        // è®¾ç½®å•ä¾‹å®ä¾‹
        INSTANCE = this

        // æ£€æŸ¥ä¸Šæ¬¡æ˜¯å¦æ­£å¸¸å…³é—­ï¼Œå¦‚æœæ˜¯åˆ™æ¸…é™¤æ¢å¤æ•°æ®
        try {
            val recoveryManager = com.example.aifloatingball.manager.TabRecoveryManager.getInstance(this)
            // æ£€æŸ¥ä¸Šæ¬¡æ˜¯å¦æ­£å¸¸å…³é—­ï¼ˆåœ¨æ¸…é™¤æ ‡è®°ä¹‹å‰æ£€æŸ¥ï¼‰
            val wasNormalShutdown = recoveryManager.isNormalShutdown()
            if (wasNormalShutdown) {
                // æ­£å¸¸å…³é—­ï¼Œæ¸…é™¤æ¢å¤æ•°æ®
                recoveryManager.clearRecoveryData()
                Log.d(TAG, "ä¸Šæ¬¡æ­£å¸¸å…³é—­ï¼Œå·²æ¸…é™¤æ¢å¤æ•°æ®")
            }
            // æ¸…é™¤æ­£å¸¸å…³é—­æ ‡è®°ï¼Œä¸ºä¸‹æ¬¡å¯åŠ¨åšå‡†å¤‡
            recoveryManager.clearNormalShutdownFlag()
            Log.d(TAG, "å·²æ¸…é™¤æ­£å¸¸å…³é—­æ ‡è®°")
        } catch (e: Exception) {
            Log.e(TAG, "æ£€æŸ¥å…³é—­çŠ¶æ€å¤±è´¥", e)
        }

        // åˆå§‹åŒ–SettingsManager
        settingsManager = SettingsManager.getInstance(this)
        
        // æ³¨å†Œæ¡£æ¡ˆå˜æ›´ç›‘å¬å™¨
        settingsManager.registerOnSettingChangeListener<List<PromptProfile>>("prompt_profiles") { key, value ->
            Log.d(TAG, "æ¡£æ¡ˆåˆ—è¡¨å·²æ›´æ–°ï¼Œé‡æ–°åŠ è½½æ¡£æ¡ˆé€‰æ‹©å™¨")
            // å¦‚æœå½“å‰æœ‰æ¡£æ¡ˆé€‰æ‹©å™¨æ˜¾ç¤ºï¼Œéœ€è¦åˆ·æ–°
            refreshProfileSelectorIfVisible()
        }
        
        // åˆå§‹åŒ–BookmarkManagerå¹¶æ‰§è¡Œæ•°æ®è¿ç§»
        try {
            val bookmarkManager = com.example.aifloatingball.manager.BookmarkManager.getInstance(this)
            val migratedCount = bookmarkManager.migrateFromBookmarkEntry()
            // åŒæ­¥æ‰€æœ‰ä¹¦ç­¾åˆ°ç»Ÿä¸€æ”¶è—ç®¡ç†ç³»ç»Ÿ
            bookmarkManager.syncAllBookmarksToUnifiedCollection()
            if (migratedCount > 0) {
                Log.d(TAG, "ä¹¦ç­¾æ•°æ®è¿ç§»å®Œæˆ: $migratedCount æ¡")
            }
        } catch (e: Exception) {
            Log.e(TAG, "ä¹¦ç­¾æ•°æ®è¿ç§»å¤±è´¥", e)
        }

        // åˆå§‹åŒ–è§¦æ‘¸å†²çªè§£å†³å™¨
        touchConflictResolver = TouchConflictResolver(this)

        // åˆå§‹åŒ–ç»Ÿä¸€ç¾¤èŠç®¡ç†å™¨
        unifiedGroupChatManager = UnifiedGroupChatManager.getInstance(this)
        
        // è®¾ç½®æ•°æ®å˜æ›´ç›‘å¬å™¨
        unifiedGroupChatManager.addDataChangeListener(this)

        // åˆå§‹åŒ–è¯­éŸ³æç¤ºåˆ†æ”¯ç®¡ç†å™¨
        promptBranchManager = VoicePromptBranchManager(this, this)
        
        // åˆå§‹åŒ–è¯­éŸ³å‘½ä»¤ç®¡ç†å™¨
        voiceCommandManager = com.example.aifloatingball.voicecommand.VoiceCommandManager(this)
        // å…³é”®ï¼šä»è®¾ç½®ä¸­è¯»å–å¹¶åº”ç”¨ä¿å­˜çš„äº¤äº’æ¨¡å¼
        val savedMode = settingsManager.getString(KEY_VOICE_INTERACTION_MODE, "CLICK")
        promptBranchManager.interactionMode = if (savedMode == "DRAG") {
            VoicePromptBranchManager.InteractionMode.DRAG
        } else {
            VoicePromptBranchManager.InteractionMode.CLICK
        }
        
        // åˆå§‹åŒ–ç»Ÿä¸€WebViewç®¡ç†å™¨
        unifiedWebViewManager = UnifiedWebViewManager()

        // ç¡®ä¿ SimpleModeService ä¸åœ¨è¿è¡Œ
        if (SimpleModeService.isRunning(this)) {
            Log.d(TAG, "SimpleModeService is running, stopping it")
            stopService(Intent(this, SimpleModeService::class.java))
        }

        // ç¡®ä¿æˆ‘ä»¬å¤„äºç®€æ˜“æ¨¡å¼æ˜¾ç¤ºæ¨¡å¼
        val previousMode = settingsManager.getDisplayMode()
        Log.d(TAG, "Previous display mode: $previousMode, setting to simple_mode")
        settingsManager.setDisplayMode("simple_mode")

        // æ£€æŸ¥æƒé™çŠ¶æ€
        checkOverlayPermission()

        // åº”ç”¨ä¸»é¢˜è®¾ç½®
        applyTheme()

        setContentView(R.layout.activity_simple_mode)

        // åº”ç”¨UIé¢œè‰²
        updateUIColors()

        // åˆå§‹åŒ–éœ‡åŠ¨ç®¡ç†å™¨
        initializeVibrator()

        initializeViews()
        setupAIAssistantCenter()
        setupTaskSelection()
        setupChat()
        
        // åˆå§‹åŒ–TTSç®¡ç†å™¨
        initializeTTS()

        // æ³¨å†ŒAPIå¯†é’¥åŒæ­¥å¹¿æ’­æ¥æ”¶å™¨
        setupApiKeySyncReceiver()

        // å¤„ç†ä»å°ç»„ä»¶ä¼ å…¥çš„å‚æ•°
        handleWidgetIntent(intent)
        
        // å¤„ç†ä»AIAppOverlayServiceè¿”å›è½¯ä»¶tabçš„Intentå‚æ•°
        if (intent?.getBooleanExtra("show_app_search", false) == true || intent?.getStringExtra("state") == "APP_SEARCH") {
            Log.d(TAG, "æ£€æµ‹åˆ°show_app_searchå‚æ•°ï¼Œåˆ‡æ¢åˆ°è½¯ä»¶tab")
            handler.postDelayed({
                showAppSearch()
            }, 300) // å»¶è¿Ÿ300msç¡®ä¿è§†å›¾å·²åˆå§‹åŒ–
        }

        // æ³¨å†Œæ·»åŠ AIè”ç³»äººå¹¿æ’­æ¥æ”¶å™¨
        setupAddAIContactReceiver()
        
        // æ³¨å†ŒAIå¯¹è¯æ›´æ–°å¹¿æ’­æ¥æ”¶å™¨
        setupAIChatUpdateReceiver()
        
        // å¯åŠ¨æ–‡ä»¶ç›‘å¬åŒæ­¥æœºåˆ¶
        startFileSyncMonitoring()
        
        // å¯åŠ¨å®šæ—¶å¼ºåˆ¶åŒæ­¥æœºåˆ¶
        startPeriodicSync()
        
        // æ³¨å†Œå¹¿æ’­æ¥æ”¶å™¨
        registerBroadcastReceiver()
        
        // æ³¨å†Œé“¾æ¥æ“ä½œå¹¿æ’­æ¥æ”¶å™¨
        setupLinkActionReceiver()
        
        // æ³¨å†Œç¾¤èŠåˆ›å»ºå¹¿æ’­æ¥æ”¶å™¨
        setupGroupChatCreatedReceiver()
        
        // è°ƒè¯•ï¼šæ£€æŸ¥æ‰€æœ‰AIçš„æ•°æ®çŠ¶æ€
        debugAllAIData()
        
        // æ·»åŠ æµ‹è¯•æŒ‰é’®æ¥æ‰‹åŠ¨åˆ·æ–°æ•°æ®ï¼ˆå·²ç¦ç”¨ï¼‰
        // addTestRefreshButton()

        // æ£€æŸ¥æ˜¯å¦éœ€è¦æ¢å¤ä¹‹å‰çš„çŠ¶æ€
        val savedState = savedInstanceState?.getString(KEY_CURRENT_STATE)
        if (savedState != null) {
            Log.d(TAG, "Restoring saved state: $savedState")
            restoreState(savedState)

            // æ¢å¤é¢å¤–çš„çŠ¶æ€ä¿¡æ¯
            handler.postDelayed({
                try {
                    // æ£€æŸ¥ActivityçŠ¶æ€
                    if (isFinishing || isDestroyed) {
                        Log.w(TAG, "Activityæ­£åœ¨é”€æ¯ï¼Œè·³è¿‡çŠ¶æ€æ¢å¤")
                        return@postDelayed
                    }

                    // æ¢å¤æ‰‹åŠ¿åŒºçŠ¶æ€
                    val gestureOverlayActive = savedInstanceState.getBoolean("gesture_overlay_active", false)
                    if (gestureOverlayActive && currentState == UIState.BROWSER) {
                        Log.d(TAG, "æ¢å¤æ‰‹åŠ¿åŒºæ¿€æ´»çŠ¶æ€")
                        activateSearchTabGestureOverlay()
                    }

                    // æ¢å¤å¤šå¡ç‰‡é¢„è§ˆçŠ¶æ€
                    val stackedPreviewVisible = savedInstanceState.getBoolean("stacked_preview_visible", false)
                    if (stackedPreviewVisible && currentState == UIState.BROWSER) {
                        Log.d(TAG, "æ¢å¤å¤šå¡ç‰‡é¢„è§ˆçŠ¶æ€")
                        activateStackedCardPreview()
                    }

                    // æ¢å¤WebViewæ»šåŠ¨ä½ç½®
                    val savedUrl = savedInstanceState.getString("current_webview_url")
                    val scrollX = savedInstanceState.getInt("current_webview_scroll_x", 0)
                    val scrollY = savedInstanceState.getInt("current_webview_scroll_y", 0)

                    if (savedUrl != null && (scrollX != 0 || scrollY != 0)) {
                        val currentCard = gestureCardWebViewManager?.getCurrentCard()
                        val currentWebView = currentCard?.webView
                        if (currentWebView?.url == savedUrl) {
                            currentWebView.scrollTo(scrollX, scrollY)
                            Log.d(TAG, "æ¢å¤WebViewæ»šåŠ¨ä½ç½®: scrollX=$scrollX, scrollY=$scrollY")
                        }
                    }

                } catch (e: Exception) {
                    Log.e(TAG, "æ¢å¤é¢å¤–çŠ¶æ€å¤±è´¥", e)
                }
            }, 500) // å»¶è¿Ÿç¡®ä¿UIå®Œå…¨åˆå§‹åŒ–

        } else {
            // æ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„æ‚¬æµ®å¡ç‰‡çŠ¶æ€
            val sharedPreferences = getSharedPreferences("gesture_cards_state", MODE_PRIVATE)
            val savedCardUrls = sharedPreferences.getStringSet("floating_card_urls", emptySet())
            
            Log.d(TAG, "onCreate: æ£€æŸ¥ä¿å­˜çš„æ‚¬æµ®å¡ç‰‡çŠ¶æ€")
            Log.d(TAG, "onCreate: savedCardUrls = $savedCardUrls")
            Log.d(TAG, "onCreate: savedCardUrls?.size = ${savedCardUrls?.size}")
            
            if (savedCardUrls?.isNotEmpty() == true) {
                Log.d(TAG, "Found saved cards, showing browser")
                showBrowser()
                // ğŸ”§ ä¿®å¤ï¼šç¡®ä¿æ˜¾ç¤ºæµè§ˆå™¨æ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°æœç´¢tabå¹¶åŠ è½½åŠŸèƒ½ä¸»é¡µ
                handler.postDelayed({
                    switchToSearchTab()
                }, 300) // å»¶è¿Ÿ300msï¼Œç¡®ä¿UIå®Œå…¨åˆå§‹åŒ–
            } else {
                Log.d(TAG, "No saved state or cards, showing chat")
                showChat()
            }
        }

        // å¤„ç†ä»å…¶ä»–åœ°æ–¹ä¼ å…¥çš„æœç´¢å†…å®¹
        handleIntentData()
        
        // å¦‚æœå¯åŠ¨æ—¶å°±è¦æ˜¾ç¤ºè½¯ä»¶tabï¼Œæ£€æŸ¥æ˜¯å¦æœ‰æœç´¢å…³é”®è¯
        if (intent?.getBooleanExtra("show_app_search", false) == true || intent?.getStringExtra("state") == "APP_SEARCH") {
            // å»¶è¿Ÿå¤„ç†ï¼Œç¡®ä¿UIå·²åˆå§‹åŒ–
            handler.postDelayed({
                handleAppSearchIntentQuery()
            }, 500)
        }

        // åˆå§‹åŒ–æ—¶åº”ç”¨å·¦æ‰‹æ¨¡å¼å¸ƒå±€æ–¹å‘
        applyLayoutDirection(settingsManager.isLeftHandedModeEnabled())
    }

    override fun onConfigurationChanged(newConfig: android.content.res.Configuration) {
        super.onConfigurationChanged(newConfig)

        Log.d(TAG, "é…ç½®å˜åŒ–: orientation=${newConfig.orientation}")

        try {
            // ä¿å­˜å½“å‰WebViewçŠ¶æ€
            val currentCard = gestureCardWebViewManager?.getCurrentCard()
            val currentWebView = currentCard?.webView
            val currentUrl = currentWebView?.url
            val scrollX = currentWebView?.scrollX ?: 0
            val scrollY = currentWebView?.scrollY ?: 0

            Log.d(TAG, "å±å¹•æ—‹è½¬å‰ä¿å­˜çŠ¶æ€: url=$currentUrl, scrollX=$scrollX, scrollY=$scrollY")

            // é…ç½®å˜åŒ–æ—¶é‡æ–°åº”ç”¨UIæ ·å¼ï¼Œä½†ä¸åˆ·æ–°å†…å®¹
            updateUIColors()
            updateTabColors()

            // é‡æ–°è°ƒæ•´å¸ƒå±€ï¼Œä½†ä¿æŒWebViewå†…å®¹
            handler.postDelayed({
                try {
                    // æ£€æŸ¥ActivityçŠ¶æ€
                    if (isFinishing || isDestroyed) {
                        Log.w(TAG, "Activityæ­£åœ¨é”€æ¯ï¼Œè·³è¿‡å±å¹•æ—‹è½¬åçš„çŠ¶æ€æ¢å¤")
                        return@postDelayed
                    }

                    // æ¢å¤WebViewæ»šåŠ¨ä½ç½®
                    if (currentUrl != null && currentWebView != null) {
                        currentWebView.scrollTo(scrollX, scrollY)
                        Log.d(TAG, "å±å¹•æ—‹è½¬åæ¢å¤æ»šåŠ¨ä½ç½®: scrollX=$scrollX, scrollY=$scrollY")
                    }

                    // é‡æ–°è°ƒæ•´æ‰‹åŠ¿åŒºå¸ƒå±€ï¼ˆå¦‚æœæ¿€æ´»ï¼‰
                    if (isSearchTabGestureOverlayActive) {
                        // é‡æ–°è®¡ç®—æ‰‹åŠ¿åŒºå¸ƒå±€
                        searchTabGestureOverlay?.requestLayout()
                    }

                    // é‡æ–°è°ƒæ•´å¤šå¡ç‰‡é¢„è§ˆå¸ƒå±€ï¼ˆå¦‚æœæ¿€æ´»ï¼‰
                    stackedCardPreview?.let { preview ->
                        if (preview.visibility == View.VISIBLE) {
                            preview.requestLayout()
                        }
                    }

                } catch (e: Exception) {
                    Log.e(TAG, "å±å¹•æ—‹è½¬åæ¢å¤çŠ¶æ€å¤±è´¥", e)
                }
            }, 100) // çŸ­æš‚å»¶è¿Ÿç¡®ä¿å¸ƒå±€å®Œæˆ

        } catch (e: Exception) {
            Log.e(TAG, "å¤„ç†é…ç½®å˜åŒ–å¤±è´¥", e)
        }
    }

    override fun onNewIntent(intent: Intent?) {
        super.onNewIntent(intent)
        Log.d(TAG, "onNewIntent called")

        // æ›´æ–°å½“å‰Intent
        setIntent(intent)

        // å¤„ç†æ–°çš„å°ç»„ä»¶Intent
        handleWidgetIntent(intent)
        
        // å¤„ç†ä»AIAppOverlayServiceè¿”å›è½¯ä»¶tabçš„Intentå‚æ•°
        if (intent?.getBooleanExtra("show_app_search", false) == true || intent?.getStringExtra("state") == "APP_SEARCH") {
            Log.d(TAG, "onNewIntent: æ£€æµ‹åˆ°show_app_searchå‚æ•°ï¼Œåˆ‡æ¢åˆ°è½¯ä»¶tab")
            handler.postDelayed({
                showAppSearch()
                // å¤„ç†æœç´¢å…³é”®è¯
                handleAppSearchIntentQuery()
            }, 300) // å»¶è¿Ÿ300msç¡®ä¿è§†å›¾å·²åˆå§‹åŒ–
        } else if (currentState == UIState.APP_SEARCH) {
            // å¦‚æœå·²ç»åœ¨è½¯ä»¶tabï¼Œæ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„æœç´¢å…³é”®è¯
            handler.postDelayed({
                handleAppSearchIntentQuery()
            }, 300)
        }
    }

    override fun onSaveInstanceState(outState: Bundle) {
        super.onSaveInstanceState(outState)

        try {
            // ä¿å­˜å½“å‰ç•Œé¢çŠ¶æ€
            outState.putString(KEY_CURRENT_STATE, currentState.name)

            // ä¿å­˜æ‰‹åŠ¿åŒºæ¿€æ´»çŠ¶æ€
            outState.putBoolean("gesture_overlay_active", isSearchTabGestureOverlayActive)

            // ä¿å­˜å½“å‰WebViewçš„URLå’Œæ»šåŠ¨ä½ç½®
            val currentCard = gestureCardWebViewManager?.getCurrentCard()
            val currentWebView = currentCard?.webView
            currentWebView?.let { webView ->
                outState.putString("current_webview_url", webView.url)
                outState.putInt("current_webview_scroll_x", webView.scrollX)
                outState.putInt("current_webview_scroll_y", webView.scrollY)
            }

            // ä¿å­˜å¤šå¡ç‰‡é¢„è§ˆçŠ¶æ€
            stackedCardPreview?.let { preview ->
                outState.putBoolean("stacked_preview_visible", preview.visibility == View.VISIBLE)
            }

            Log.d(TAG, "ä¿å­˜çŠ¶æ€: ${currentState.name}, æ‰‹åŠ¿åŒºæ¿€æ´»: $isSearchTabGestureOverlayActive")

        } catch (e: Exception) {
            Log.e(TAG, "ä¿å­˜å®ä¾‹çŠ¶æ€å¤±è´¥", e)
        }
    }

    /**
     * æ¢å¤ä¿å­˜çš„ç•Œé¢çŠ¶æ€
     */
    private fun restoreState(stateName: String) {
        try {
            val state = UIState.valueOf(stateName)
            Log.d(TAG, "Restoring to state: $state")

            when (state) {
                UIState.CHAT -> showChat()
                UIState.AI_ASSISTANT_CENTER -> showAIAssistantCenter()
                UIState.TASK_SELECTION -> showTaskSelection()
                UIState. STEP_GUIDANCE -> {
                    // å¦‚æœæœ‰ä¿å­˜çš„ä»»åŠ¡æ•°æ®ï¼Œæ¢å¤åˆ°æ­¥éª¤å¼•å¯¼é¡µé¢
                    // å¦åˆ™å›åˆ°AIåŠ©æ‰‹ä¸­å¿ƒé¡µé¢
                    if (::userPromptData.isInitialized) {
                        showStepGuidance()
                    } else {
                        showAIAssistantCenter()
                    }
                }
                UIState.PROMPT_PREVIEW -> {
                    // å¦‚æœæœ‰ä¿å­˜çš„æç¤ºè¯æ•°æ®ï¼Œæ¢å¤åˆ°é¢„è§ˆé¡µé¢
                    // å¦åˆ™å›åˆ°AIåŠ©æ‰‹ä¸­å¿ƒé¡µé¢
                    if (::userPromptData.isInitialized) {
                        showPromptPreview()
                    } else {
                        showAIAssistantCenter()
                    }
                }
                UIState.VOICE -> showVoice()
                UIState.BROWSER -> switchToSearchTab()
                UIState.APP_SEARCH -> showAppSearch()
                UIState.SETTINGS -> showSettings()
            }
        } catch (e: Exception) {
            Log.e(TAG, "Error restoring state: $stateName", e)
            // å¦‚æœæ¢å¤å¤±è´¥ï¼Œå›åˆ°é»˜è®¤çŠ¶æ€
            showChat()
        }
    }

    private fun checkOverlayPermission() {
        if (android.os.Build.VERSION.SDK_INT >= android.os.Build.VERSION_CODES.M) {
            val hasPermission = android.provider.Settings.canDrawOverlays(this)
            Log.d(TAG, "Overlay permission status: $hasPermission")
            // ç§»é™¤æƒé™æé†’ï¼Œåªè®°å½•æ—¥å¿—
            if (!hasPermission) {
                Log.w(TAG, "Overlay permission not granted, but continuing without notification")
            }
        } else {
            Log.d(TAG, "Android version < M, no overlay permission check needed")
        }
    }

    /**
     * åº”ç”¨ä¸»é¢˜è®¾ç½®
     */
    private fun applyTheme() {
        val themeMode = settingsManager.getThemeMode()
        val targetNightMode = when (themeMode) {
            SettingsManager.THEME_MODE_LIGHT -> AppCompatDelegate.MODE_NIGHT_NO
            SettingsManager.THEME_MODE_DARK -> AppCompatDelegate.MODE_NIGHT_YES
            else -> AppCompatDelegate.MODE_NIGHT_FOLLOW_SYSTEM
        }

        // åªæœ‰å½“ç›®æ ‡æ¨¡å¼ä¸å½“å‰æ¨¡å¼ä¸åŒæ—¶æ‰åº”ç”¨æ–°ä¸»é¢˜
        val currentNightMode = AppCompatDelegate.getDefaultNightMode()
        if (currentNightMode != targetNightMode) {
            Log.d(TAG, "Applying theme change: $currentNightMode -> $targetNightMode")
            AppCompatDelegate.setDefaultNightMode(targetNightMode)

            // ç«‹å³æ›´æ–°UIé¢œè‰²ï¼Œå‡å°‘å»¶è¿Ÿ
            updateUIColors()
            
            // å¼ºåˆ¶åˆ·æ–°æ‰€æœ‰è§†å›¾ä»¥ç¡®ä¿ä¸»é¢˜ç«‹å³ç”Ÿæ•ˆ
            window.decorView.post {
                updateUIColors()
            }
        } else {
            Log.d(TAG, "Theme mode unchanged: $targetNightMode")
            // å³ä½¿ä¸»é¢˜æ¨¡å¼æ²¡æœ‰æ”¹å˜ï¼Œä¹Ÿè¦æ›´æ–°UIé¢œè‰²ä»¥ç¡®ä¿æ­£ç¡®æ˜¾ç¤º
            updateUIColors()
        }
    }

    /**
     * æ£€æŸ¥æ˜¯å¦ä¸ºæš—è‰²æ¨¡å¼
     */
    private fun isDarkMode(): Boolean {
        return (resources.configuration.uiMode and android.content.res.Configuration.UI_MODE_NIGHT_MASK) ==
               android.content.res.Configuration.UI_MODE_NIGHT_YES
    }

    /**
     * åŠ¨æ€æ›´æ–°ç•Œé¢é¢œè‰²
     */
    private fun updateUIColors() {
        try {
            val isDarkMode = isDarkMode()

            Log.d(TAG, "æ›´æ–°UIé¢œè‰² - æš—è‰²æ¨¡å¼: $isDarkMode")

            // æ›´æ–°çŠ¶æ€æ å’Œå¯¼èˆªæ é¢œè‰²
            val backgroundColor = androidx.core.content.ContextCompat.getColor(this, R.color.simple_mode_background_light)
            window.statusBarColor = backgroundColor
            window.navigationBarColor = backgroundColor

            // æ›´æ–°æ ¹å¸ƒå±€èƒŒæ™¯
            findViewById<View>(android.R.id.content)?.setBackgroundColor(backgroundColor)

            // æ›´æ–°ä¸»å¸ƒå±€èƒŒæ™¯
            val mainLayout = findViewById<LinearLayout>(R.id.simple_mode_main_layout)
            mainLayout?.setBackgroundColor(backgroundColor)

            // æ›´æ–°å„ä¸ªé¡µé¢å¸ƒå±€çš„èƒŒæ™¯
            updatePageBackgrounds()

            // æ›´æ–°å¯¹è¯é¡µé¢é¢œè‰²
            updateChatPageColors()

            // æ›´æ–°è½¯ä»¶tabé¡µé¢é¢œè‰²
            updateAppSearchPageColors()

            // æ›´æ–°æ ‡é¢˜æ é¢œè‰²
            updateHeaderColors()

            // æ›´æ–°åº•éƒ¨å¯¼èˆªé¢œè‰²
            updateBottomNavigationColors()

            // æ›´æ–°æ‰€æœ‰æ–‡æœ¬é¢œè‰²
            updateAllTextColors()

            // æ›´æ–°è¾“å…¥æ¡†å’ŒæŒ‰é’®é¢œè‰²
            updateInputAndButtonColors()

            // æ›´æ–°å¡ç‰‡èƒŒæ™¯é¢œè‰²
            updateCardBackgrounds()

        } catch (e: Exception) {
            android.util.Log.e("SimpleModeActivity", "Error updating UI colors", e)
        }
    }

    /**
     * æ›´æ–°æ‰€æœ‰æ–‡æœ¬é¢œè‰²
     */
    private fun updateAllTextColors() {
        // é€’å½’æ›´æ–°æ‰€æœ‰TextViewçš„é¢œè‰²
        val rootView = findViewById<ViewGroup>(android.R.id.content)
        updateTextColorsRecursively(rootView)
    }

    /**
     * é€’å½’æ›´æ–°ViewGroupä¸­æ‰€æœ‰TextViewçš„é¢œè‰²
     */
    private fun updateTextColorsRecursively(viewGroup: ViewGroup) {
        val isDarkMode = isDarkMode()
        for (i in 0 until viewGroup.childCount) {
            val child = viewGroup.getChildAt(i)
            when (child) {
                is TextView -> {
                    // æ ¹æ®TextViewçš„ç”¨é€”è®¾ç½®ä¸åŒçš„é¢œè‰²
                    when (child.id) {
                        R.id.final_prompt_text -> {
                            child.setTextColor(androidx.core.content.ContextCompat.getColor(this, R.color.simple_mode_text_primary_light))
                        }
                        R.id.recommended_engines_text -> {
                            child.setTextColor(androidx.core.content.ContextCompat.getColor(this, R.color.simple_mode_text_secondary_light))
                        }
                        else -> {
                            // é»˜è®¤ä½¿ç”¨ä¸»è¦æ–‡æœ¬é¢œè‰²
                            child.setTextColor(androidx.core.content.ContextCompat.getColor(this, R.color.simple_mode_text_primary_light))
                        }
                    }
                }
                is ViewGroup -> {
                    // é€’å½’å¤„ç†å­ViewGroup
                    updateTextColorsRecursively(child)
                }
            }
        }
    }

    /**
     * æ›´æ–°é¡µé¢èƒŒæ™¯é¢œè‰²
     */
    private fun updatePageBackgrounds() {
        val isDarkMode = isDarkMode()
        val backgroundColor = androidx.core.content.ContextCompat.getColor(this, R.color.simple_mode_background_light)

        // æ›´æ–°å„ä¸ªé¡µé¢å¸ƒå±€çš„èƒŒæ™¯
        findViewById<LinearLayout>(R.id.step_guidance_layout)?.setBackgroundColor(backgroundColor)
        findViewById<LinearLayout>(R.id.prompt_preview_layout)?.setBackgroundColor(backgroundColor)
        findViewById<ScrollView>(R.id.voice_layout)?.setBackgroundColor(backgroundColor)
        findViewById<ScrollView>(R.id.settings_layout)?.setBackgroundColor(backgroundColor)
        findViewById<DrawerLayout>(R.id.browser_layout)?.setBackgroundColor(backgroundColor)
        findViewById<View>(R.id.app_search_layout)?.setBackgroundColor(backgroundColor)
    }

    /**
     * æ›´æ–°è¾“å…¥æ¡†å’ŒæŒ‰é’®é¢œè‰²
     */
    private fun updateInputAndButtonColors() {
        val isDarkMode = isDarkMode()
        // æ›´æ–°æœç´¢æ¡†èƒŒæ™¯
        val inputBackground = androidx.core.content.ContextCompat.getColor(this, R.color.simple_mode_input_background_light)
        val inputTextColor = androidx.core.content.ContextCompat.getColor(this, R.color.simple_mode_text_primary_light)
        val inputHintColor = androidx.core.content.ContextCompat.getColor(this, R.color.simple_mode_text_secondary_light)

        // ç›´æ¥æœç´¢è¾“å…¥æ¡†
        findViewById<EditText>(R.id.direct_search_input)?.apply {
            setTextColor(inputTextColor)
            setHintTextColor(inputHintColor)
            setBackgroundColor(inputBackground)
        }

        // æ­¥éª¤è¾“å…¥æ¡†
        findViewById<com.google.android.material.textfield.TextInputEditText>(R.id.step_input_text)?.apply {
            setTextColor(inputTextColor)
            setBackgroundColor(inputBackground)
        }

        // è¯­éŸ³è¾“å…¥æ¡†
        findViewById<com.google.android.material.textfield.TextInputEditText>(R.id.voice_text_input)?.apply {
            setTextColor(inputTextColor)
            setBackgroundColor(inputBackground)
        }
    }

    /**
     * æ›´æ–°å¡ç‰‡èƒŒæ™¯é¢œè‰²
     */
    private fun updateCardBackgrounds() {
        val isDarkMode = isDarkMode()
        val cardBackground = androidx.core.content.ContextCompat.getColor(this, R.color.simple_mode_card_background_light)

        // æ›´æ–°Prompté¢„è§ˆé¡µé¢ä¸­çš„å¡ç‰‡ï¼ˆprompt_preview_layoutæ˜¯LinearLayoutï¼Œéœ€è¦æŸ¥æ‰¾å…¶ä¸­çš„CardViewï¼‰
        findViewById<android.widget.LinearLayout>(R.id.prompt_preview_layout)?.let { layout ->
            // åœ¨LinearLayoutä¸­æŸ¥æ‰¾CardViewå­è§†å›¾
            for (i in 0 until layout.childCount) {
                val child = layout.getChildAt(i)
                if (child is androidx.cardview.widget.CardView) {
                    child.setCardBackgroundColor(cardBackground)
                    break
                }
            }
        }

        // æ›´æ–°è¯­éŸ³é¡µé¢ä¸­çš„å¡ç‰‡
        val voiceLayout = findViewById<ScrollView>(R.id.voice_layout)
        voiceLayout?.let { updateCardBackgroundsRecursively(it, cardBackground) }

        // æ›´æ–°è®¾ç½®é¡µé¢ä¸­çš„å¡ç‰‡
        val settingsLayout = findViewById<ScrollView>(R.id.settings_layout)
        settingsLayout?.let { updateCardBackgroundsRecursively(it, cardBackground) }

        // æ›´æ–°æµè§ˆå™¨é¡µé¢ä¸­çš„å¡ç‰‡å’Œæœç´¢æ¡†èƒŒæ™¯
        updateBrowserPageColors()
    }

    /**
     * æ›´æ–°æµè§ˆå™¨é¡µé¢é¢œè‰²
     */
    private fun updateBrowserPageColors() {
        val cardBackground = androidx.core.content.ContextCompat.getColor(this, R.color.simple_mode_card_background_light)
        val inputBackground = androidx.core.content.ContextCompat.getColor(this, R.color.simple_mode_input_background_light)
        val textColor = androidx.core.content.ContextCompat.getColor(this, R.color.simple_mode_text_primary_light)

        // æ›´æ–°æµè§ˆå™¨é¡µé¢çš„æœç´¢æ¡†èƒŒæ™¯ï¼ˆbrowser_layoutæ˜¯DrawerLayoutï¼Œéœ€è¦é€’å½’æŸ¥æ‰¾å…¶ä¸­çš„å­è§†å›¾ï¼‰
        val browserLayout = findViewById<androidx.drawerlayout.widget.DrawerLayout>(R.id.browser_layout)
        browserLayout?.let { layout ->
            // é€’å½’æ›´æ–°æµè§ˆå™¨é¡µé¢ä¸­çš„æ‰€æœ‰å…ƒç´ 
            updateBrowserElementsRecursively(layout, cardBackground, inputBackground, textColor)
        }
    }

    /**
     * é€’å½’æ›´æ–°æµè§ˆå™¨é¡µé¢å…ƒç´ 
     */
    private fun updateBrowserElementsRecursively(view: View, cardBackground: Int, inputBackground: Int, textColor: Int) {
        when (view) {
            is com.google.android.material.card.MaterialCardView -> {
                view.setCardBackgroundColor(cardBackground)
            }
            is androidx.cardview.widget.CardView -> {
                view.setCardBackgroundColor(cardBackground)
            }
            is LinearLayout -> {
                // æ£€æŸ¥æ˜¯å¦æ˜¯æœç´¢æ¡†å®¹å™¨
                if (view.background != null) {
                    view.setBackgroundColor(inputBackground)
                }
                // ç»§ç»­é€’å½’å¤„ç†å­è§†å›¾
                for (i in 0 until view.childCount) {
                    updateBrowserElementsRecursively(view.getChildAt(i), cardBackground, inputBackground, textColor)
                }
            }
            is TextView -> {
                view.setTextColor(textColor)
            }
            is ViewGroup -> {
                for (i in 0 until view.childCount) {
                    updateBrowserElementsRecursively(view.getChildAt(i), cardBackground, inputBackground, textColor)
                }
            }
        }
    }

    /**
     * éšè—æ‚¬æµ®å¡ç‰‡é¢„è§ˆå¹¶é‡ç½®å…¶çŠ¶æ€
     */
    private fun deactivateStackedCardPreview() {
        stackedCardPreview?.let {
            it.visibility = View.GONE
            it.reset()
            Log.d(TAG, "æ‚¬æµ®å¡ç‰‡é¢„è§ˆå·²åœç”¨")
        }
        
        // ç§»é™¤å¤–éƒ¨ç‚¹å‡»ç›‘å¬
        removeStackedCardPreviewOutsideClick()

        // ç¡®ä¿tabé¢œè‰²çŠ¶æ€æ­£ç¡®æ›´æ–°
        updateTabColors()
    }
    
    /**
     * è®¾ç½®é¢„è§ˆçª—å£ç‚¹å‡»å¤–éƒ¨åŒºåŸŸé€€å‡ºåŠŸèƒ½
     */
    private fun setupStackedCardPreviewOutsideClick() {
        try {
            val rootView = window.decorView.rootView
            rootView.setOnTouchListener { view, event ->
                if (stackedCardPreview?.visibility == View.VISIBLE) {
                    when (event.action) {
                        android.view.MotionEvent.ACTION_DOWN -> {
                            // æ£€æŸ¥ç‚¹å‡»ä½ç½®æ˜¯å¦åœ¨é¢„è§ˆçª—å£å¤–éƒ¨
                            val location = IntArray(2)
                            stackedCardPreview?.getLocationOnScreen(location)
                            val previewX = location[0]
                            val previewY = location[1]
                            val previewWidth = stackedCardPreview?.width ?: 0
                            val previewHeight = stackedCardPreview?.height ?: 0
                            
                            val clickX = event.rawX
                            val clickY = event.rawY
                            
                            // å¦‚æœç‚¹å‡»ä½ç½®åœ¨é¢„è§ˆçª—å£å¤–éƒ¨ï¼Œé€€å‡ºé¢„è§ˆçª—å£
                            if (clickX < previewX || clickX > previewX + previewWidth ||
                                clickY < previewY || clickY > previewY + previewHeight) {
                                Log.d(TAG, "ç‚¹å‡»é¢„è§ˆçª—å£å¤–éƒ¨ï¼Œé€€å‡ºé¢„è§ˆçª—å£")
                                deactivateStackedCardPreview()
                                return@setOnTouchListener true
                            }
                        }
                    }
                }
                false
            }
            Log.d(TAG, "é¢„è§ˆçª—å£å¤–éƒ¨ç‚¹å‡»ç›‘å¬å·²è®¾ç½®")
        } catch (e: Exception) {
            Log.e(TAG, "è®¾ç½®é¢„è§ˆçª—å£å¤–éƒ¨ç‚¹å‡»ç›‘å¬å¤±è´¥", e)
        }
    }
    
    /**
     * ç§»é™¤é¢„è§ˆçª—å£å¤–éƒ¨ç‚¹å‡»ç›‘å¬
     */
    private fun removeStackedCardPreviewOutsideClick() {
        try {
            val rootView = window.decorView.rootView
            rootView.setOnTouchListener(null)
            Log.d(TAG, "é¢„è§ˆçª—å£å¤–éƒ¨ç‚¹å‡»ç›‘å¬å·²ç§»é™¤")
        } catch (e: Exception) {
            Log.e(TAG, "ç§»é™¤é¢„è§ˆçª—å£å¤–éƒ¨ç‚¹å‡»ç›‘å¬å¤±è´¥", e)
        }
    }

    /**
     * é€’å½’æ›´æ–°å¡ç‰‡èƒŒæ™¯
     */
    private fun updateCardBackgroundsRecursively(view: View, cardBackground: Int) {
        val inputBackground = androidx.core.content.ContextCompat.getColor(this, R.color.simple_mode_input_background_light)
        val textColor = androidx.core.content.ContextCompat.getColor(this, R.color.simple_mode_text_primary_light)

        when (view) {
            is com.google.android.material.card.MaterialCardView -> {
                view.setCardBackgroundColor(cardBackground)
            }
            is androidx.cardview.widget.CardView -> {
                view.setCardBackgroundColor(cardBackground)
            }
            is EditText -> {
                // æ›´æ–°è¾“å…¥æ¡†èƒŒæ™¯å’Œæ–‡å­—é¢œè‰²
                view.setBackgroundColor(inputBackground)
                view.setTextColor(textColor)
                view.setHintTextColor(androidx.core.content.ContextCompat.getColor(this, R.color.simple_mode_text_secondary_light))
            }
            is TextView -> {
                // æ›´æ–°æ–‡å­—é¢œè‰²
                view.setTextColor(textColor)
            }
            is LinearLayout -> {
                // å¦‚æœLinearLayoutæœ‰èƒŒæ™¯ï¼Œå¯èƒ½æ˜¯ä¸€ä¸ªå®¹å™¨ï¼Œæ›´æ–°å…¶èƒŒæ™¯
                if (view.background != null) {
                    view.setBackgroundColor(cardBackground)
                }
                // ç»§ç»­é€’å½’å¤„ç†å­è§†å›¾
                for (i in 0 until view.childCount) {
                    updateCardBackgroundsRecursively(view.getChildAt(i), cardBackground)
                }
            }
            is ViewGroup -> {
                for (i in 0 until view.childCount) {
                    updateCardBackgroundsRecursively(view.getChildAt(i), cardBackground)
                }
            }
        }
    }

    /**
     * æ›´æ–°æ ‡é¢˜æ é¢œè‰² (å·²ç§»é™¤æ ‡é¢˜æ ï¼Œæ­¤æ–¹æ³•ä¿ç•™ä»¥é¿å…è°ƒç”¨é”™è¯¯)
     */
    private fun updateHeaderColors() {
        // æ ‡é¢˜æ å·²ç§»é™¤ï¼Œæ­¤æ–¹æ³•ä¸å†éœ€è¦æ‰§è¡Œä»»ä½•æ“ä½œ
        // ä¿ç•™æ­¤æ–¹æ³•ä»¥é¿å…å…¶ä»–åœ°æ–¹çš„è°ƒç”¨å‡ºé”™
    }

    /**
     * æ›´æ–°åº•éƒ¨å¯¼èˆªé¢œè‰²
     */
    private fun updateBottomNavigationColors() {
        val bottomNav = findViewById<LinearLayout>(R.id.bottom_navigation) ?: return

        // è®¾ç½®å¯¼èˆªæ èƒŒæ™¯è‰²
        bottomNav.setBackgroundColor(androidx.core.content.ContextCompat.getColor(this, R.color.simple_mode_tab_background_light))

        // æ›´æ–°æ‰€æœ‰Tabçš„é¢œè‰²
        updateTabColors()
        // åˆ‡æ¢tabæ—¶ï¼Œåœç”¨æ‚¬æµ®å¡ç‰‡é¢„è§ˆ
        deactivateStackedCardPreview()
    }

    /**
     * æ›´æ–°Tabé¢œè‰²
     */
    private fun updateTabColors() {
        val bottomNav = findViewById<LinearLayout>(R.id.bottom_navigation) ?: return

        for (i in 0 until bottomNav.childCount) {
            val tabView = bottomNav.getChildAt(i) as? LinearLayout ?: continue
            
            // ç”±äºåº•éƒ¨å¯¼èˆªæ å§‹ç»ˆä¿æŒLTRæ–¹å‘ï¼Œtabé¡ºåºåœ¨å·¦å³æ‰‹æ¨¡å¼ä¸‹éƒ½æ˜¯ä¸€è‡´çš„
            // åŠ¨æ€å¤„ç†è¯­éŸ³tabçš„éšè—æƒ…å†µ
            val isSelected = when (tabView.id) {
                R.id.tab_chat -> currentState == UIState.CHAT
                R.id.tab_search -> currentState == UIState.BROWSER
                R.id.tab_home -> currentState == UIState.AI_ASSISTANT_CENTER
                R.id.tab_voice -> currentState == UIState.VOICE
                R.id.tab_app_search -> currentState == UIState.APP_SEARCH
                R.id.tab_settings -> currentState == UIState.SETTINGS
                else -> false
            }

            // æœç´¢tabæœ‰ç‰¹æ®Šçš„å¸ƒå±€ç»“æ„ï¼ˆFrameLayoutåŒ…å«å›¾æ ‡å’Œå¾½æ ‡ï¼‰
            if (tabView.id == R.id.tab_search) {
                // æœç´¢tabï¼šå›¾æ ‡åœ¨FrameLayoutä¸­ï¼Œæ–‡å­—æ˜¯ç¬¬äºŒä¸ªå­è§†å›¾
                val frameLayout = tabView.getChildAt(0) as? FrameLayout
                val iconView = frameLayout?.findViewById<ImageView>(R.id.search_tab_icon)
                val textView = tabView.getChildAt(1) as? TextView
                
                if (iconView != null && textView != null) {
                    if (isSelected) {
                        // é€‰ä¸­çŠ¶æ€
                        tabView.setBackgroundColor(androidx.core.content.ContextCompat.getColor(this, R.color.simple_mode_tab_selected_light))
                        iconView.setColorFilter(androidx.core.content.ContextCompat.getColor(this, R.color.simple_mode_tab_icon_selected_light))
                        textView.setTextColor(androidx.core.content.ContextCompat.getColor(this, R.color.simple_mode_tab_text_selected_light))
                    } else {
                        // æ­£å¸¸çŠ¶æ€
                        tabView.setBackgroundColor(android.graphics.Color.TRANSPARENT)
                        iconView.setColorFilter(androidx.core.content.ContextCompat.getColor(this, R.color.simple_mode_tab_icon_normal_light))
                        textView.setTextColor(androidx.core.content.ContextCompat.getColor(this, R.color.simple_mode_tab_text_normal_light))
                    }
                }
            } else {
                // å…¶ä»–tabï¼šå›¾æ ‡æ˜¯ç¬¬ä¸€ä¸ªå­è§†å›¾ï¼Œæ–‡å­—æ˜¯ç¬¬äºŒä¸ªå­è§†å›¾
                val iconView = tabView.getChildAt(0) as? ImageView
                val textView = tabView.getChildAt(1) as? TextView
                
                if (iconView != null && textView != null) {
                    if (isSelected) {
                        // é€‰ä¸­çŠ¶æ€
                        tabView.setBackgroundColor(androidx.core.content.ContextCompat.getColor(this, R.color.simple_mode_tab_selected_light))
                        iconView.setColorFilter(androidx.core.content.ContextCompat.getColor(this, R.color.simple_mode_tab_icon_selected_light))
                        textView.setTextColor(androidx.core.content.ContextCompat.getColor(this, R.color.simple_mode_tab_text_selected_light))
                    } else {
                        // æ­£å¸¸çŠ¶æ€
                        tabView.setBackgroundColor(android.graphics.Color.TRANSPARENT)
                        iconView.setColorFilter(androidx.core.content.ContextCompat.getColor(this, R.color.simple_mode_tab_icon_normal_light))
                        textView.setTextColor(androidx.core.content.ContextCompat.getColor(this, R.color.simple_mode_tab_text_normal_light))
                    }
                }
            }
        }
    }

    /**
     * æ›´æ–°å¯¹è¯é¡µé¢é¢œè‰²
     */
    private fun updateChatPageColors() {
        val chatLayout = findViewById<LinearLayout>(R.id.chat_layout)
        val searchInput = findViewById<EditText>(R.id.chat_search_input)
        val addButton = findViewById<ImageButton>(R.id.chat_add_contact_button)
        val tabLayout = findViewById<com.google.android.material.tabs.TabLayout>(R.id.chat_tab_layout)
        val recyclerView = findViewById<androidx.recyclerview.widget.RecyclerView>(R.id.chat_contacts_recycler_view)

        // æ›´æ–°èƒŒæ™¯é¢œè‰²
        chatLayout?.setBackgroundColor(androidx.core.content.ContextCompat.getColor(this, R.color.chat_background_light))
        recyclerView?.setBackgroundColor(androidx.core.content.ContextCompat.getColor(this, R.color.chat_background_light))

        // æ›´æ–°æœç´¢æ¡†é¢œè‰²
        searchInput?.apply {
            setTextColor(androidx.core.content.ContextCompat.getColor(this@SimpleModeActivity, R.color.simple_mode_text_primary_light))
            setHintTextColor(androidx.core.content.ContextCompat.getColor(this@SimpleModeActivity, R.color.chat_search_hint_light))
        }

        // æ›´æ–°æ·»åŠ æŒ‰é’®é¢œè‰²
        addButton?.setColorFilter(androidx.core.content.ContextCompat.getColor(this, R.color.chat_add_button_light))

        // æ›´æ–°TabLayouté¢œè‰²
        tabLayout?.apply {
            setBackgroundColor(androidx.core.content.ContextCompat.getColor(this@SimpleModeActivity, R.color.chat_tab_background_light))
            setTabTextColors(
                androidx.core.content.ContextCompat.getColor(this@SimpleModeActivity, R.color.chat_tab_unselected_light),
                androidx.core.content.ContextCompat.getColor(this@SimpleModeActivity, R.color.chat_tab_selected_light)
            )
            setSelectedTabIndicatorColor(androidx.core.content.ContextCompat.getColor(this@SimpleModeActivity, R.color.chat_tab_selected_light))
        }
    }

    /**
     * æ›´æ–°è½¯ä»¶tabé¡µé¢é¢œè‰²
     */
    private fun updateAppSearchPageColors() {
        try {
            val textColor = androidx.core.content.ContextCompat.getColor(this, R.color.simple_mode_text_primary_light)
            val secondaryTextColor = androidx.core.content.ContextCompat.getColor(this, R.color.simple_mode_text_secondary_light)
            val accentColor = androidx.core.content.ContextCompat.getColor(this, R.color.simple_mode_accent_light)
            val cardBackground = androidx.core.content.ContextCompat.getColor(this, R.color.simple_mode_card_background_light)

            // æ›´æ–°å·¦ä¾§åˆ†ç±»å¯¼èˆªæŒ‰é’®
            val categorySidebar = findViewById<LinearLayout>(R.id.app_category_sidebar)
            categorySidebar?.let { sidebar ->
                updateCategorySidebarColors(sidebar, textColor, accentColor)
            }

            // æ›´æ–°æœç´¢æ¡†æç¤ºæ–‡å­—
            findViewById<TextView>(R.id.app_search_hint)?.setTextColor(secondaryTextColor)

            // æ›´æ–°æœç´¢è¾“å…¥æ¡†é¢œè‰²ï¼ˆå¦‚æœæœ‰TextInputLayoutåˆ™æ›´æ–°ï¼Œæ–°å¸ƒå±€ä½¿ç”¨CardView+EditTextï¼‰
            findViewById<com.google.android.material.textfield.TextInputLayout>(R.id.app_search_input_layout)?.apply {
                boxStrokeColor = accentColor
                hintTextColor = ColorStateList.valueOf(secondaryTextColor)
                setStartIconTintList(ColorStateList.valueOf(secondaryTextColor))
                setEndIconTintList(ColorStateList.valueOf(secondaryTextColor))
            }
            // æ–°å¸ƒå±€çš„æœç´¢æ¡†èƒŒæ™¯è‰²å·²åœ¨CardViewä¸­è®¾ç½®ï¼Œæ— éœ€é¢å¤–æ›´æ–°

            // æ›´æ–°æœç´¢è¾“å…¥æ¡†æ–‡å­—é¢œè‰²ï¼ˆä½¿ç”¨EditTextï¼Œä¸æ˜¯TextInputEditTextï¼‰
            findViewById<android.widget.EditText>(R.id.app_search_input)?.setTextColor(textColor)

            // æ›´æ–°å¡ç‰‡èƒŒæ™¯è‰²
            updateAppSearchCardBackgrounds(cardBackground)

        } catch (e: Exception) {
            Log.e(TAG, "æ›´æ–°è½¯ä»¶tabé¡µé¢é¢œè‰²å¤±è´¥", e)
        }
    }

    /**
     * æ›´æ–°åˆ†ç±»ä¾§è¾¹æ é¢œè‰²
     */
    private fun updateCategorySidebarColors(sidebar: LinearLayout, textColor: Int, accentColor: Int) {
        try {
            for (i in 0 until sidebar.childCount) {
                val categoryView = sidebar.getChildAt(i) as? LinearLayout ?: continue

                // æ›´æ–°åˆ†ç±»å›¾æ ‡é¢œè‰²
                val iconView = categoryView.getChildAt(0) as? ImageView
                iconView?.setColorFilter(accentColor)

                // æ›´æ–°åˆ†ç±»æ–‡å­—é¢œè‰²
                val textView = categoryView.getChildAt(1) as? TextView
                textView?.setTextColor(textColor)
            }
        } catch (e: Exception) {
            Log.e(TAG, "æ›´æ–°åˆ†ç±»ä¾§è¾¹æ é¢œè‰²å¤±è´¥", e)
        }
    }

    /**
     * æ›´æ–°è½¯ä»¶tabé¡µé¢çš„å¡ç‰‡èƒŒæ™¯è‰²
     */
    private fun updateAppSearchCardBackgrounds(cardBackground: Int) {
        try {
            // æ›´æ–°æœç´¢æ¡†å¡ç‰‡èƒŒæ™¯
            val appSearchLayout = findViewById<View>(R.id.app_search_layout)
            appSearchLayout?.let { layout ->
                updateCardBackgroundsRecursively(layout, cardBackground)
            }
        } catch (e: Exception) {
            Log.e(TAG, "æ›´æ–°è½¯ä»¶tabå¡ç‰‡èƒŒæ™¯å¤±è´¥", e)
        }
    }

    private fun initializeViews() {
        try {
            // ä¸»è¦å¸ƒå±€ - ä½¿ç”¨å®‰å…¨çš„findViewById
            chatLayout = findViewById<LinearLayout>(R.id.chat_layout)
            aiAssistantCenterLayout = findViewById<LinearLayout>(R.id.ai_assistant_center_layout)
            taskSelectionLayout = findViewById<LinearLayout>(R.id.task_selection_layout)
            stepGuidanceLayout = findViewById<LinearLayout>(R.id.step_guidance_layout)
            promptPreviewLayout = findViewById<LinearLayout>(R.id.prompt_preview_layout)
            voiceLayout = findViewById<ScrollView>(R.id.voice_layout)
            appSearchLayout = findViewById<androidx.coordinatorlayout.widget.CoordinatorLayout>(R.id.app_search_layout)
            browserLayout = findViewById<androidx.drawerlayout.widget.DrawerLayout>(R.id.browser_layout)
            settingsLayout = findViewById<ScrollView>(R.id.settings_layout)

            Log.d(TAG, "ä¸»è¦å¸ƒå±€åˆå§‹åŒ–å®Œæˆ")
        } catch (e: Exception) {
            Log.e(TAG, "åˆå§‹åŒ–ä¸»è¦å¸ƒå±€å¤±è´¥", e)
            throw e
        }
        // modeSwitchWidget = findViewById(R.id.mode_switch_widget)  // æš‚æ—¶ç¦ç”¨

        // AIåŠ©æ‰‹ä¸­å¿ƒ
        try {
            aiCenterViewPager = findViewById<androidx.viewpager2.widget.ViewPager2>(R.id.ai_center_view_pager)
            aiCenterTabLayout = findViewById<com.google.android.material.tabs.TabLayout>(R.id.ai_center_tab_layout)
            Log.d(TAG, "AIåŠ©æ‰‹ä¸­å¿ƒç»„ä»¶åˆå§‹åŒ–å®Œæˆ")
        } catch (e: Exception) {
            Log.e(TAG, "åˆå§‹åŒ–AIåŠ©æ‰‹ä¸­å¿ƒç»„ä»¶å¤±è´¥", e)
        }

        // ä»»åŠ¡é€‰æ‹©é¡µé¢
        try {
            taskRecyclerView = findViewById<RecyclerView>(R.id.task_recycler_view)
            directSearchInput = findViewById<EditText>(R.id.direct_search_input)
            directSearchButton = findViewById<ImageButton>(R.id.direct_search_button)
            Log.d(TAG, "ä»»åŠ¡é€‰æ‹©é¡µé¢ç»„ä»¶åˆå§‹åŒ–å®Œæˆ")
        } catch (e: Exception) {
            Log.e(TAG, "åˆå§‹åŒ–ä»»åŠ¡é€‰æ‹©é¡µé¢ç»„ä»¶å¤±è´¥", e)
        }

        // æ­¥éª¤å¼•å¯¼é¡µé¢
        try {
            stepTitleText = findViewById<TextView>(R.id.step_title_text)
            stepQuestionText = findViewById<TextView>(R.id.step_question_text)
            stepInputLayout = findViewById<com.google.android.material.textfield.TextInputLayout>(R.id.step_input_layout)
            stepInputText = findViewById<com.google.android.material.textfield.TextInputEditText>(R.id.step_input_text)
            stepChoiceGroup = findViewById<RadioGroup>(R.id.step_choice_group)
            stepMultiChoiceLayout = findViewById<LinearLayout>(R.id.step_multi_choice_layout)
            prevStepButton = findViewById<com.google.android.material.button.MaterialButton>(R.id.prev_step_button)
            skipStepButton = findViewById<com.google.android.material.button.MaterialButton>(R.id.skip_step_button)
            nextStepButton = findViewById<com.google.android.material.button.MaterialButton>(R.id.next_step_button)
            Log.d(TAG, "æ­¥éª¤å¼•å¯¼é¡µé¢ç»„ä»¶åˆå§‹åŒ–å®Œæˆ")
        } catch (e: Exception) {
            Log.e(TAG, "åˆå§‹åŒ–æ­¥éª¤å¼•å¯¼é¡µé¢ç»„ä»¶å¤±è´¥", e)
        }

        // éªŒè¯æŒ‰é’®æ˜¯å¦æ­£ç¡®åˆå§‹åŒ–
        Log.d(TAG, "æ­¥éª¤æŒ‰é’®åˆå§‹åŒ–å®Œæˆ:")
        Log.d(TAG, "  ä¸Šä¸€æ­¥æŒ‰é’®: ${if (::prevStepButton.isInitialized) "å·²åˆå§‹åŒ–" else "æœªåˆå§‹åŒ–"}")
        Log.d(TAG, "  ä¸‹ä¸€æ­¥æŒ‰é’®: ${if (::nextStepButton.isInitialized) "å·²åˆå§‹åŒ–" else "æœªåˆå§‹åŒ–"}")
        Log.d(TAG, "  è·³è¿‡æŒ‰é’®: ${if (::skipStepButton.isInitialized) "å·²åˆå§‹åŒ–" else "æœªåˆå§‹åŒ–"}")

        // Prompté¢„è§ˆé¡µé¢
        finalPromptText = findViewById(R.id.final_prompt_text)
        recommendedEnginesText = findViewById(R.id.recommended_engines_text)
        executeSearchButton = findViewById(R.id.execute_search_button)
        backToTasksButton = findViewById(R.id.back_to_tasks_button)

        // è¯­éŸ³é¡µé¢
        voiceMicContainer = findViewById(R.id.voice_mic_container)
        voiceMicIcon = findViewById(R.id.voice_mic_icon)
        voiceMicRipple = findViewById(R.id.voice_mic_ripple)
        voiceRecordingIndicator = findViewById(R.id.voice_recording_indicator)
        voiceStatusText = findViewById(R.id.voice_status_text)
        voiceTextInputLayout = findViewById(R.id.voice_text_input_layout)
        voiceTextInput = findViewById(R.id.voice_text_input)
        voiceClearButton = findViewById(R.id.voice_clear_button)
        voicePauseButton = findViewById(R.id.voice_pause_button)
        voiceSaveButton = findViewById(R.id.voice_save_button)
        voiceSearchButton = findViewById(R.id.voice_search_button)
        
        // ç§»é™¤éŸ³é¢‘å½•åˆ¶ç®¡ç†å™¨ï¼ˆä¸å†éœ€è¦éŸ³é¢‘å½•åˆ¶ï¼Œåªä¿ç•™è¯­éŸ³è¯†åˆ«è½¬æ–‡æœ¬ï¼‰
        // audioRecorderManager = com.example.aifloatingball.voice.AudioRecorderManager(this)
        recordingTagManager = com.example.aifloatingball.voice.VoiceRecordingTagManager(this)
        recordingTagManager?.ensureRecordingTagExists()
        
        // åˆå§‹åŒ–å½•éŸ³è®¡æ—¶å™¨
        recordingTimerHandler = Handler(Looper.getMainLooper())
        conversionTimerHandler = Handler(Looper.getMainLooper())
        textConversionTimerHandler = Handler(Looper.getMainLooper())
        voiceTextTagManager = com.example.aifloatingball.voice.VoiceTextTagManager(this)
        voiceInteractionModeSwitch = findViewById(R.id.voice_interaction_mode_switch)
        
        // åˆå§‹åŒ–æ¨¡å‹çŠ¶æ€ç›¸å…³UI
        voiceModelStatusText = findViewById(R.id.voice_model_status_text)
        voiceModelStatusContainer = findViewById(R.id.voice_model_status_container)
        voiceModelSegmentedControl = findViewById(R.id.voice_model_segmented_control)
        
        // TTSæœ—è¯»æŒ‰é’® - ä½¿ç”¨éº¦å…‹é£æŒ‰é’®ä»£æ›¿

        // æŸ¥æ‰¾éœ€è¦æ ¹æ®è¯­éŸ³æ”¯æŒæƒ…å†µæ§åˆ¶çš„UIå…ƒç´ 
        voiceHintText = findViewById(R.id.voice_hint_text)
        voiceSettingsCard = findViewById(R.id.voice_settings_card)

        // åº”ç”¨æœç´¢é¡µé¢ç»„ä»¶åˆå§‹åŒ–
        try {
            appCategorySidebar = findViewById<LinearLayout>(R.id.app_category_sidebar)
            appSearchInput = findViewById<com.google.android.material.textfield.TextInputEditText>(R.id.app_search_input)
            appSearchHint = findViewById<TextView>(R.id.app_search_hint)
            appSearchGrid = findViewById<RecyclerView>(R.id.app_search_grid)
            selectedAppIconContainer = findViewById<com.google.android.material.card.MaterialCardView>(R.id.selected_app_icon_container)
            selectedAppIcon = findViewById<ImageView>(R.id.selected_app_icon)
            appSearchSettings = AppSearchSettings.getInstance(this)
            searchHistoryManager = SearchHistoryManager.getInstance(this)
            categoryDragHelper = CategoryDragHelper(this)
            appSelectionHistoryManager = AppSelectionHistoryManager.getInstance(this)
            appSortManager = com.example.aifloatingball.manager.AppSortManager.getInstance(this)
            appUsageTracker = com.example.aifloatingball.manager.AppUsageTracker.getInstance(this)

            // ä¸´æ—¶ï¼šå¼ºåˆ¶æ›´æ–°åˆ°æœ€æ–°é…ç½®ä»¥æ˜¾ç¤ºæ–°å¢çš„åº”ç”¨
            // è¿™å°†ç¡®ä¿ç”¨æˆ·èƒ½çœ‹åˆ°æ‰€æœ‰æ–°å¢çš„åº”ç”¨
            Log.d(TAG, "å¼ºåˆ¶æ›´æ–°åº”ç”¨é…ç½®åˆ°æœ€æ–°ç‰ˆæœ¬")
            appSearchSettings.forceResetToLatestConfig()

            // å¯åŠ¨å›¾æ ‡é¢„åŠ è½½
            startIconPreloading()
            Log.d(TAG, "åº”ç”¨æœç´¢é¡µé¢ç»„ä»¶åˆå§‹åŒ–å®Œæˆ")
        } catch (e: Exception) {
            Log.e(TAG, "åˆå§‹åŒ–åº”ç”¨æœç´¢é¡µé¢ç»„ä»¶å¤±è´¥", e)
        }

        // æµè§ˆå™¨é¡µé¢ - å¤šé¡µé¢WebViewç‰ˆæœ¬ç»„ä»¶åˆå§‹åŒ–
        browserWebViewContainer = findViewById(R.id.browser_webview_container)
        browserHomeContent = findViewById(R.id.browser_home_content)
        browserBtnClose = findViewById<TextView>(R.id.browser_btn_close)
        browserSearchInput = findViewById(R.id.browser_search_input)
        browserBtnMenu = findViewById(R.id.browser_btn_menu)
        browserProgressBar = findViewById(R.id.browser_progress_bar)
        browserLoadingOverlay = findViewById(R.id.browser_loading_overlay) // ğŸ”§ æ–°å¢ï¼šåˆå§‹åŒ–åŠ è½½é®ç½©å±‚
        
        // ğŸ”§ ä¿®å¤4ï¼šåˆå§‹åŒ–æœç´¢è¾“å…¥æ¡†æ–‡å­—å·¥å…·æ 
        searchInputToolbarContainer = findViewById(R.id.search_input_toolbar_container)
        searchInputToolbarLayout = findViewById(R.id.search_input_toolbar_layout)
        browserTabContainer = findViewById(R.id.browser_tab_container)
        browserTabBar = findViewById(R.id.browser_tab_bar)
        browserNewTabButton = findViewById(R.id.browser_new_tab_button)
        
        // åˆå§‹åŒ–åº•éƒ¨å¿«æ·æ“ä½œæ 
        browserQuickActionsBar = findViewById(R.id.browser_quick_actions_bar)
        setupQuickActionsBar()

        // Safarié£æ ¼åŠŸèƒ½ç»„ä»¶åˆå§‹åŒ–
        browserToolbar = findViewById(R.id.browser_toolbar)
        browserSwipeRefresh = findViewById<SwipeRefreshLayout>(R.id.browser_swipe_refresh)
        browserBtnClear = findViewById(R.id.browser_btn_clear)
        browserBtnAi = findViewById(R.id.browser_btn_ai)
        browserBtnSite = findViewById(R.id.browser_btn_site)
        browserShortcutsGrid = findViewById(R.id.browser_shortcuts_grid)
        
        // åˆå§‹åŒ–ä¸‹æ‹‰å·¥å…·æ 
        browserPullDownToolbar = findViewById(R.id.browser_pull_down_toolbar)
        pullDownToolbarButtons = findViewById(R.id.pull_down_toolbar_buttons)
        pullDownBtnBack = findViewById(R.id.pull_down_btn_back)
        pullDownBtnClose = findViewById(R.id.pull_down_btn_close)
        pullDownBtnRefresh = findViewById(R.id.pull_down_btn_refresh)
        pullDownBtnHome = findViewById(R.id.pull_down_btn_home)
        pullDownBtnSecret = findViewById(R.id.pull_down_btn_secret)
        pullDownIndicator = findViewById(R.id.pull_down_indicator)
        // åˆå§‹åŒ–æŒ‰é’®æ•°ç»„ï¼Œæ–¹ä¾¿ç´¢å¼•è®¿é—®
        pullDownButtons = arrayOf(pullDownBtnBack, pullDownBtnClose, pullDownBtnRefresh, pullDownBtnHome)
        
        // è®¾ç½®æŒ‰é’®ç‚¹å‡»äº‹ä»¶ï¼ˆä¿ç•™åŸæœ‰åŠŸèƒ½ï¼‰
        setupPullDownToolbarButtons()
        
        // åˆå§‹åŒ–ç»„æ ‡ç­¾æ 
        groupTabsContainer = findViewById(R.id.group_tabs_container)
        groupTabsLayout = findViewById(R.id.group_tabs_layout)
        
        // åˆ·æ–°ç»„æ ‡ç­¾æ 
        refreshGroupTabs()
        
        // ç›‘å¬ç»„å˜åŒ–ï¼Œè‡ªåŠ¨åˆ·æ–°æ ‡ç­¾æ 
        val groupManager = TabGroupManager.getInstance(this)
        groupManager.addGroupChangeListener {
            refreshGroupTabs()
        }

        // å¼€å§‹æµè§ˆæŒ‰é’®
        val browserStartBrowsingButton = findViewById<MaterialButton>(R.id.browser_start_browsing_button)
        browserGestureHint = findViewById(R.id.browser_gesture_hint)
        browserNavDrawer = findViewById(R.id.browser_nav_drawer)
        browserLetterTitle = findViewById(R.id.browser_letter_title)
        browserPreviewEngineList = findViewById(R.id.browser_preview_engine_list)
        browserExitButton = findViewById(R.id.browser_exit_button)
        browserLetterIndexBar = findViewById(R.id.browser_letter_index_bar)
        browserGestureOverlay = findViewById(R.id.browser_gesture_overlay)
        browserGestureHintClose = findViewById(R.id.browser_gesture_hint_close)

        // åˆ›å»ºè™šæ‹Ÿç»„ä»¶ç”¨äºå…¼å®¹æ€§ï¼ˆè¿™äº›ç»„ä»¶åœ¨å½“å‰å¸ƒå±€ä¸­ä¸å­˜åœ¨ï¼‰
        browserViewPager = androidx.viewpager2.widget.ViewPager2(this@SimpleModeActivity)
        browserTabPreviewContainer = LinearLayout(this@SimpleModeActivity)
        browserBtnAddTab = ImageButton(this@SimpleModeActivity)
        browserAppbar = com.google.android.material.appbar.AppBarLayout(this@SimpleModeActivity)
        browserVoiceSearch = ImageButton(this@SimpleModeActivity)
        browserBottomBar = LinearLayout(this@SimpleModeActivity)
        browserLeftButtons = LinearLayout(this@SimpleModeActivity)
        browserRightButtons = LinearLayout(this@SimpleModeActivity)
        browserBtnHistory = ImageButton(this@SimpleModeActivity)
        browserBtnBookmarks = ImageButton(this@SimpleModeActivity)
        browserBtnSettings = ImageButton(this@SimpleModeActivity)
        browserAutoHideSwitch = androidx.appcompat.widget.SwitchCompat(this@SimpleModeActivity)
        browserClipboardSwitch = androidx.appcompat.widget.SwitchCompat(this@SimpleModeActivity)



        // è®¾ç½®é¡µé¢ - æ‰©å±•æ‰€æœ‰è®¾ç½®é€‰é¡¹
        displayModeSpinner = findViewById(R.id.display_mode_spinner)
        windowCountSpinner = findViewById(R.id.window_count_spinner)
        clipboardMonitorSwitch = findViewById(R.id.clipboard_monitor_switch)
        autoHideSwitch = findViewById(R.id.auto_hide_switch)
        aiModeSwitch = findViewById(R.id.ai_mode_switch)
        themeModeSpinner = findViewById(R.id.theme_mode_spinner)
        ballAlphaSeekbar = findViewById(R.id.ball_alpha_seekbar)
        leftHandedSwitch = findViewById(R.id.left_handed_switch)
        autoPasteSwitch = findViewById(R.id.auto_paste_switch)
        multiTabBrowserSwitch = findViewById(R.id.multi_tab_browser_switch)
        notificationListenerSwitch = findViewById(R.id.notification_listener_switch)
        voskOfflineVoiceSwitch = findViewById(R.id.vosk_offline_voice_switch)


        aiApiSettingsItem = findViewById(R.id.ai_api_settings_item)
        searchEngineSettingsItem = findViewById(R.id.search_engine_settings_item)
        aiSearchEngineSettingsItem = findViewById(R.id.ai_search_engine_settings_item)
        masterPromptSettingsItem = findViewById(R.id.master_prompt_settings_item)
        appSearchSettingsItem = findViewById(R.id.app_search_settings_item)
        permissionManagementItem = findViewById(R.id.permission_management_item)
        viewSearchHistoryItem = findViewById(R.id.view_search_history_item)
        onboardingGuideItem = findViewById(R.id.onboarding_guide_item)
        bottomNavTabsRecyclerView = findViewById(R.id.bottom_nav_tabs_recycler_view)
        appVersionText = findViewById(R.id.app_version_text)
        floatingBallSettingsContainer = findViewById(R.id.floating_ball_settings_container)

        // è®¾ç½®æœç´¢æ¡†ç›‘å¬å™¨
        setupSearchListeners()

        // è®¾ç½®æœç´¢å¼•æ“RecyclerView
        setupSearchEngineRecyclerView()

        // è®¾ç½®è¯­éŸ³é¡µé¢
        setupVoicePage()

        // è®¾ç½®è®¾ç½®é¡µé¢
        setupSettingsPage()
        
        // è®¾ç½®åº•éƒ¨å¯¼èˆªæ æŒ‰é’®é…ç½®
        setupBottomNavTabsSettings()

        // æ ‡é¢˜æ æŒ‰é’®å·²ç§»é™¤ï¼Œä¸å†éœ€è¦è®¾ç½®æŒ‰é’®ç›‘å¬å™¨
        Log.d(TAG, "æ ‡é¢˜æ å·²ç§»é™¤ï¼Œè·³è¿‡æŒ‰é’®è®¾ç½®")

        // è®¾ç½®åº•éƒ¨å¯¼èˆªæ 
        setupBottomNavigation()

        // è®¾ç½®æµè§ˆå™¨
        setupBrowserWebView()

        // åˆå§‹åŒ–UIé¢œè‰²
        updateUIColors()
        updateTabColors()

        // åˆå§‹åŒ–ç«™ç‚¹ä¿¡æ¯æŒ‰é’®
        setupBrowserSiteButton()
    }

    private fun setupVoicePage() {
        // è¯­éŸ³äº¤äº’æ¨¡å¼åˆ‡æ¢
        voiceInteractionModeSwitch.setOnCheckedChangeListener { _, isChecked ->
            promptBranchManager.interactionMode = if (isChecked) {
                Toast.makeText(this, "å·²åˆ‡æ¢åˆ°æ‹–åŠ¨æ¨¡å¼", Toast.LENGTH_SHORT).show()
                updateVoiceInteractionModeUI(VoicePromptBranchManager.InteractionMode.DRAG)
                // ä¿å­˜è®¾ç½®
                settingsManager.putString(KEY_VOICE_INTERACTION_MODE, "DRAG")
                VoicePromptBranchManager.InteractionMode.DRAG
            } else {
                Toast.makeText(this, "å·²åˆ‡æ¢åˆ°ç‚¹å‡»æ¨¡å¼", Toast.LENGTH_SHORT).show()
                updateVoiceInteractionModeUI(VoicePromptBranchManager.InteractionMode.CLICK)
                // ä¿å­˜è®¾ç½®
                settingsManager.putString(KEY_VOICE_INTERACTION_MODE, "CLICK")
                VoicePromptBranchManager.InteractionMode.CLICK
            }
        }

        // æ ¹æ®ä¿å­˜çš„æ¨¡å¼åˆå§‹åŒ–å¼€å…³çŠ¶æ€
        val isDragMode = promptBranchManager.interactionMode == VoicePromptBranchManager.InteractionMode.DRAG
        voiceInteractionModeSwitch.isChecked = isDragMode
        updateVoiceInteractionModeUI(promptBranchManager.interactionMode)

        // è®¾ç½®éº¦å…‹é£ç›‘å¬å™¨
        setupVoiceMicListener()
        
        // åˆå§‹åŒ–éº¦å…‹é£æŒ‰é’®å¤–è§‚
        updateMicButtonAppearance()
        
        // åˆå§‹åŒ–è¯­éŸ³æ¨¡å‹çŠ¶æ€æ˜¾ç¤º
        setupVoiceModelStatus()
        
        // é›†æˆè¯­éŸ³å‘½ä»¤æ‰§è¡ŒåŠŸèƒ½
        setupVoiceCommandExecution()
        
        // è°ƒè¯•ï¼šæ£€æŸ¥éº¦å…‹é£æŒ‰é’®çŠ¶æ€
        Log.d(TAG, "éº¦å…‹é£æŒ‰é’®åˆå§‹åŒ–å®Œæˆ:")
        Log.d(TAG, "  æŒ‰é’®å¯è§æ€§: ${voiceMicContainer.visibility}")
        Log.d(TAG, "  æŒ‰é’®æ˜¯å¦å¯ç”¨: ${voiceMicContainer.isEnabled}")
        Log.d(TAG, "  å½“å‰æ¨¡å¼: ${if (isMicInTTSMode) "TTSæœ—è¯»" else "è¯­éŸ³è¾“å…¥"}")
    }
    
    /**
     * è®¾ç½®è¯­éŸ³æ¨¡å‹çŠ¶æ€æ˜¾ç¤ºå’Œç®¡ç†
     */
    private fun setupVoiceModelStatus() {
        val segmentedControl = voiceModelSegmentedControl ?: return
        
        // åˆ›å»ºé€‰é¡¹åˆ—è¡¨
        val segments = listOf(
            com.example.aifloatingball.ui.IOSSegmentedControl.Segment("ç³»ç»Ÿè¯­éŸ³", "SYSTEM"),
            com.example.aifloatingball.ui.IOSSegmentedControl.Segment("å°æ¨¡å‹", "SMALL"),
            com.example.aifloatingball.ui.IOSSegmentedControl.Segment("å®Œæ•´æ¨¡å‹", "FULL")
        )
        segmentedControl.setSegments(segments)
        
        // æ›´æ–°åˆ‡æ¢å™¨é€‰ä¸­çŠ¶æ€å’Œæ¨¡å‹çŠ¶æ€æ˜¾ç¤º
        updateVoiceModelSegmentedControl()
        updateVoiceModelStatus()
        
        // è®¾ç½®é€‰æ‹©ç›‘å¬å™¨
        segmentedControl.setOnSegmentSelectedListener(
            object : com.example.aifloatingball.ui.IOSSegmentedControl.OnSegmentSelectedListener {
                override fun onSegmentSelected(index: Int, segment: com.example.aifloatingball.ui.IOSSegmentedControl.Segment) {
                    handleVoiceModelSwitch(index, segment.value as String)
                }
            }
        )
    }
    
    /**
     * è®¾ç½®è¯­éŸ³å‘½ä»¤æ‰§è¡ŒåŠŸèƒ½
     */
    private fun setupVoiceCommandExecution() {
        // ç›‘å¬è¯­éŸ³è¾“å…¥æ¡†çš„å®Œæˆæ“ä½œï¼ˆå›è½¦é”®æˆ–æœç´¢æŒ‰é’®ï¼‰
        voiceTextInput.setOnEditorActionListener { _, actionId, _ ->
            if (actionId == EditorInfo.IME_ACTION_DONE || actionId == EditorInfo.IME_ACTION_SEARCH) {
                val command = voiceTextInput.text?.toString()?.trim()
                if (!command.isNullOrBlank()) {
                    Log.d(TAG, "æ‰§è¡Œè¯­éŸ³å‘½ä»¤: $command")
                    voiceCommandManager.executeCommand(command)
                    voiceTextInput.text?.clear()
                    val imm = getSystemService(Context.INPUT_METHOD_SERVICE) as InputMethodManager
                    imm.hideSoftInputFromWindow(voiceTextInput.windowToken, 0)
                }
                true
            } else {
                false
            }
        }
        
        // ç›‘å¬æœç´¢æŒ‰é’®ç‚¹å‡»
        voiceSearchButton.setOnClickListener {
            val command = voiceTextInput.text?.toString()?.trim()
            if (!command.isNullOrBlank()) {
                Log.d(TAG, "æ‰§è¡Œè¯­éŸ³å‘½ä»¤ï¼ˆæœç´¢æŒ‰é’®ï¼‰: $command")
                voiceCommandManager.executeCommand(command)
                voiceTextInput.text?.clear()
                val imm = getSystemService(Context.INPUT_METHOD_SERVICE) as InputMethodManager
                imm.hideSoftInputFromWindow(voiceTextInput.windowToken, 0)
            }
        }
    }
    
    /**
     * æ›´æ–°è¯­éŸ³æ¨¡å‹åˆ‡æ¢å™¨çš„é€‰ä¸­çŠ¶æ€
     */
    private fun updateVoiceModelSegmentedControl() {
        val segmentedControl = voiceModelSegmentedControl ?: return
        
        // æ ¹æ®å½“å‰è®¾ç½®è®¾ç½®é€‰ä¸­é¡¹
        val useVosk = settingsManager.getBoolean("use_vosk_offline_voice", false)
        val voskManager = VoskManager(this)
        val currentModelType = if (useVosk) {
            voskManager.getCurrentModelType()
        } else {
            null
        }
        
        val selectedIndex = when {
            !useVosk -> 0 // ç³»ç»Ÿè¯­éŸ³
            currentModelType == VoskManager.ModelType.SMALL -> 1 // å°æ¨¡å‹
            currentModelType == VoskManager.ModelType.FULL -> 2 // å®Œæ•´æ¨¡å‹
            else -> 0
        }
        segmentedControl.setSelectedIndex(selectedIndex)
    }
    
    /**
     * å¤„ç†è¯­éŸ³æ¨¡å‹åˆ‡æ¢
     */
    private fun handleVoiceModelSwitch(index: Int, value: String) {
        val voskManager = VoskManager(this)
        val downloadedTypes = voskManager.getDownloadedModelTypes()
        
        when (value) {
            "SYSTEM" -> {
                // åˆ‡æ¢åˆ°ç³»ç»Ÿè¯­éŸ³
                settingsManager.putBoolean("use_vosk_offline_voice", false)
                // æ˜¾ç¤ºåˆ‡æ¢æç¤º
                android.widget.Toast.makeText(this, "âœ“ å·²åˆ‡æ¢åˆ°ç³»ç»Ÿè¯­éŸ³è¯†åˆ«", android.widget.Toast.LENGTH_SHORT).show()
                updateVoiceModelStatus()
            }
            "SMALL" -> {
                // åˆ‡æ¢åˆ°å°æ¨¡å‹
                if (downloadedTypes.contains(VoskManager.ModelType.SMALL)) {
                    // å·²ä¸‹è½½ï¼Œç›´æ¥åˆ‡æ¢
                    settingsManager.putString("vosk_model_type", "SMALL")
                    settingsManager.putBoolean("use_vosk_offline_voice", true)
                    voskManager.setModelType(VoskManager.ModelType.SMALL)
                    // æ˜¾ç¤ºåˆ‡æ¢æç¤º
                    android.widget.Toast.makeText(this, "âœ“ å·²åˆ‡æ¢åˆ°Voskå°æ¨¡å‹", android.widget.Toast.LENGTH_SHORT).show()
                    updateVoiceModelStatus()
                } else {
                    // æœªä¸‹è½½ï¼Œæç¤ºä¸‹è½½
                    showModelDownloadConfirmation(VoskManager.ModelType.SMALL)
                }
            }
            "FULL" -> {
                // åˆ‡æ¢åˆ°å®Œæ•´æ¨¡å‹
                if (downloadedTypes.contains(VoskManager.ModelType.FULL)) {
                    // å·²ä¸‹è½½ï¼Œç›´æ¥åˆ‡æ¢
                    settingsManager.putString("vosk_model_type", "FULL")
                    settingsManager.putBoolean("use_vosk_offline_voice", true)
                    voskManager.setModelType(VoskManager.ModelType.FULL)
                    // æ˜¾ç¤ºåˆ‡æ¢æç¤º
                    android.widget.Toast.makeText(this, "âœ“ å·²åˆ‡æ¢åˆ°Voskå®Œæ•´æ¨¡å‹", android.widget.Toast.LENGTH_SHORT).show()
                    updateVoiceModelStatus()
                } else {
                    // æœªä¸‹è½½ï¼Œæç¤ºä¸‹è½½
                    showModelDownloadConfirmation(VoskManager.ModelType.FULL)
                }
            }
        }
    }
    
    /**
     * æ˜¾ç¤ºæ¨¡å‹ä¸‹è½½ç¡®è®¤å¯¹è¯æ¡†
     */
    private fun showModelDownloadConfirmation(modelType: VoskManager.ModelType) {
        val modelName = when (modelType) {
            VoskManager.ModelType.SMALL -> "Voskå°æ¨¡å‹"
            VoskManager.ModelType.FULL -> "Voskå®Œæ•´æ¨¡å‹"
        }
        val modelSize = VoskManager(this).getModelSize(modelType)
        
        createThemedDialogBuilder()
            .setTitle("ä¸‹è½½è¯­éŸ³æ¨¡å‹")
            .setMessage("$modelName å°šæœªä¸‹è½½ï¼ˆçº¦${modelSize}MBï¼‰ã€‚\n\næ˜¯å¦ç°åœ¨ä¸‹è½½å¹¶è‡ªåŠ¨å®‰è£…ï¼Ÿ")
            .setPositiveButton("ä¸‹è½½") { _, _ ->
                startVoskModelDownloadWithBottomSheet(modelType)
            }
            .setNegativeButton("å–æ¶ˆ") { _, _ ->
                // æ¢å¤åˆ‡æ¢å™¨çŠ¶æ€
                val useVosk = settingsManager.getBoolean("use_vosk_offline_voice", false)
                val voskManager = VoskManager(this)
                val currentModelType = if (useVosk) {
                    voskManager.getCurrentModelType()
                } else {
                    null
                }
                val selectedIndex = when {
                    !useVosk -> 0
                    currentModelType == VoskManager.ModelType.SMALL -> 1
                    currentModelType == VoskManager.ModelType.FULL -> 2
                    else -> 0
                }
                voiceModelSegmentedControl?.setSelectedIndex(selectedIndex)
            }
            .show()
    }
    
    /**
     * ä½¿ç”¨BottomSheetæ˜¾ç¤ºä¸‹è½½è¿›åº¦å¹¶å¼€å§‹ä¸‹è½½æ¨¡å‹
     */
    private fun startVoskModelDownloadWithBottomSheet(modelType: VoskManager.ModelType) {
        val modelName = when (modelType) {
            VoskManager.ModelType.SMALL -> "Voskå°æ¨¡å‹"
            VoskManager.ModelType.FULL -> "Voskå®Œæ•´æ¨¡å‹"
        }
        val modelSize = VoskManager(this).getModelSize(modelType)
        
        // å…³é—­ä¹‹å‰çš„BottomSheetï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        downloadProgressBottomSheet?.dismiss()
        
        // åˆ›å»ºBottomSheet
        val bottomSheetView = LayoutInflater.from(this).inflate(R.layout.bottom_sheet_download_progress, null)
        val progressBar = bottomSheetView.findViewById<ProgressBar>(R.id.download_progress_bar)
        val progressText = bottomSheetView.findViewById<TextView>(R.id.download_progress_text)
        val speedText = bottomSheetView.findViewById<TextView>(R.id.download_speed_text)
        val statusText = bottomSheetView.findViewById<TextView>(R.id.download_status_text)
        
        // åˆå§‹åŒ–UI
        progressBar.max = 100
        progressBar.progress = 0
        progressText.text = "0%"
        speedText.text = ""
        statusText.text = "å‡†å¤‡ä¸‹è½½ $modelName (${modelSize}MB)..."
        
        // åˆ›å»ºBottomSheetDialog
        downloadProgressBottomSheet = com.google.android.material.bottomsheet.BottomSheetDialog(this)
        downloadProgressBottomSheet?.setContentView(bottomSheetView)
        downloadProgressBottomSheet?.setCancelable(false)
        downloadProgressBottomSheet?.setCanceledOnTouchOutside(false)
        downloadProgressBottomSheet?.show()
        
        // å¦‚æœå·²æœ‰VoskManagerå®ä¾‹ï¼Œå…ˆé‡Šæ”¾
        if (voskManager != null) {
            releaseVoskManager()
        }
        
        // åˆ›å»ºæ–°çš„VoskManagerå®ä¾‹ç”¨äºä¸‹è½½
        val downloadManager = VoskManager(this)
        downloadManager.setModelType(modelType)
        
        // è®¾ç½®ä¸‹è½½è¿›åº¦å›è°ƒ
        downloadManager.setCallback(object : VoskManager.VoskCallback {
            override fun onPartialResult(text: String) {
                // ä¸‹è½½æ—¶ä¸éœ€è¦å¤„ç†
            }
            
            override fun onFinalResult(text: String) {
                // ä¸‹è½½æ—¶ä¸éœ€è¦å¤„ç†
            }
            
            override fun onError(error: String) {
                handler.post {
                    downloadProgressBottomSheet?.dismiss()
                    downloadProgressBottomSheet = null
                    downloadManager.release()
                    
                    // æ¢å¤åˆ‡æ¢å™¨çŠ¶æ€
                    val useVosk = settingsManager.getBoolean("use_vosk_offline_voice", false)
                    val voskManager = VoskManager(this@SimpleModeActivity)
                    val currentModelType = if (useVosk) {
                        voskManager.getCurrentModelType()
                    } else {
                        null
                    }
                    val selectedIndex = when {
                        !useVosk -> 0
                        currentModelType == VoskManager.ModelType.SMALL -> 1
                        currentModelType == VoskManager.ModelType.FULL -> 2
                        else -> 0
                    }
                    voiceModelSegmentedControl?.setSelectedIndex(selectedIndex)
                    
                    android.widget.Toast.makeText(this@SimpleModeActivity, "ä¸‹è½½å¤±è´¥: $error", android.widget.Toast.LENGTH_LONG).show()
                }
            }
            
            override fun onModelStatus(isReady: Boolean, message: String) {
                handler.post {
                    if (isReady) {
                        // æ¨¡å‹ä¸‹è½½å¹¶åŠ è½½å®Œæˆ
                        downloadProgressBottomSheet?.dismiss()
                        downloadProgressBottomSheet = null
                        downloadManager.release()
                        
                        // åˆ‡æ¢åˆ°ä¸‹è½½çš„æ¨¡å‹
                        val modelNameValue = when (modelType) {
                            VoskManager.ModelType.SMALL -> "SMALL"
                            VoskManager.ModelType.FULL -> "FULL"
                        }
                        settingsManager.putString("vosk_model_type", modelNameValue)
                        settingsManager.putBoolean("use_vosk_offline_voice", true)
                        
                        // è‡ªåŠ¨åˆå§‹åŒ–å¹¶åŠ è½½æ¨¡å‹
                        kotlinx.coroutines.CoroutineScope(kotlinx.coroutines.Dispatchers.IO + kotlinx.coroutines.SupervisorJob()).launch {
                            try {
                                // ç¡®ä¿voskManagerå­˜åœ¨
                                if (voskManager == null) {
                                    voskManager = VoskManager(this@SimpleModeActivity)
                                }
                                
                                // è®¾ç½®æ¨¡å‹ç±»å‹
                                voskManager?.setModelType(modelType)
                                
                                // åˆå§‹åŒ–æ¨¡å‹ï¼ˆæ­¤æ—¶æ¨¡å‹å·²ä¸‹è½½ï¼Œåªéœ€è¦åŠ è½½ï¼‰
                                val initialized = voskManager?.initializeModel(autoDownload = false) ?: false
                                
                                handler.post {
                                    if (initialized) {
                                        // æ›´æ–°UI
                                        updateVoiceModelStatus()
                                        val selectedIndex = when (modelType) {
                                            VoskManager.ModelType.SMALL -> 1
                                            VoskManager.ModelType.FULL -> 2
                                        }
                                        voiceModelSegmentedControl?.setSelectedIndex(selectedIndex)
                                        
                                        android.widget.Toast.makeText(this@SimpleModeActivity, "âœ“ $modelName ä¸‹è½½å®Œæˆå¹¶å·²è‡ªåŠ¨åŠ è½½", android.widget.Toast.LENGTH_SHORT).show()
                                    } else {
                                        // åŠ è½½å¤±è´¥ï¼Œä½†ä¸‹è½½æˆåŠŸ
                                        updateVoiceModelStatus()
                                        android.widget.Toast.makeText(this@SimpleModeActivity, "âœ“ $modelName ä¸‹è½½å®Œæˆï¼Œä½†åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•", android.widget.Toast.LENGTH_LONG).show()
                                    }
                                }
                            } catch (e: Exception) {
                                Log.e(TAG, "è‡ªåŠ¨åŠ è½½æ¨¡å‹å¤±è´¥", e)
                                handler.post {
                                    updateVoiceModelStatus()
                                    android.widget.Toast.makeText(this@SimpleModeActivity, "âœ“ $modelName ä¸‹è½½å®Œæˆï¼Œä½†åŠ è½½å¤±è´¥: ${e.message}", android.widget.Toast.LENGTH_LONG).show()
                                }
                            }
                        }
                    } else {
                        // æ›´æ–°çŠ¶æ€æ–‡æœ¬ï¼ˆä¸‹è½½ä¸­æˆ–åŠ è½½ä¸­ï¼‰
                        statusText.text = message
                    }
                }
            }
            
            override fun onDownloadProgress(progress: Int, downloaded: Long, total: Long, speed: Long) {
                handler.post {
                    // æ›´æ–°è¿›åº¦æ¡
                    progressBar.progress = progress
                    
                    // æ›´æ–°è¿›åº¦ç™¾åˆ†æ¯”æ–‡æœ¬
                    if (total > 0) {
                        // æœ‰æ€»å¤§å°ï¼Œæ˜¾ç¤ºç²¾ç¡®ç™¾åˆ†æ¯”
                        progressText.text = "$progress%"
                    } else {
                        // æ²¡æœ‰æ€»å¤§å°ï¼Œæ˜¾ç¤ºä¼°ç®—ç™¾åˆ†æ¯”æˆ–å·²ä¸‹è½½å¤§å°
                        if (progress > 0) {
                            progressText.text = "$progress%"
                        } else {
                            val downloadedMB = downloaded / 1024.0 / 1024.0
                            progressText.text = "${String.format("%.1f", downloadedMB)}MB"
                        }
                    }
                    
                    // æ›´æ–°ä¸‹è½½å¤§å°ä¿¡æ¯
                    val downloadedMB = downloaded / 1024.0 / 1024.0
                    
                    // å¦‚æœå·²ä¸‹è½½å¤§äºæ€»å¤§å°ï¼Œè¯´æ˜æ˜¯è§£å‹åçš„å®é™…å¤§å°ï¼Œä½¿ç”¨é¢„æœŸå¤§å°ä½œä¸ºæ€»å¤§å°
                    val totalMB = when {
                        total > 0 && downloaded <= total -> total / 1024.0 / 1024.0 // æ­£å¸¸æƒ…å†µ
                        total > 0 && downloaded > total -> modelSize.toDouble() // è§£å‹åå¤§äºZIPå¤§å°ï¼Œä½¿ç”¨é¢„æœŸå¤§å°
                        else -> modelSize.toDouble() // æ²¡æœ‰æ€»å¤§å°ï¼Œä½¿ç”¨é¢„æœŸå¤§å°
                    }
                    
                    // æ„å»ºçŠ¶æ€æ–‡æœ¬ï¼Œç¡®ä¿æ˜¾ç¤ºå…·ä½“çš„è¿›åº¦æ•°å€¼
                    val statusMessage = when {
                        progress >= 100 -> {
                            // ä¸‹è½½å®Œæˆ
                            "ä¸‹è½½å®Œæˆ: ${String.format("%.1f", downloadedMB)}MB / ${String.format("%.1f", totalMB)}MB"
                        }
                        total > 0 && downloaded <= total -> {
                            // æœ‰æ€»å¤§å°ä¸”æ­£å¸¸ï¼Œæ˜¾ç¤ºç²¾ç¡®è¿›åº¦
                            "æ­£åœ¨ä¸‹è½½ $modelName: $progress% (${String.format("%.1f", downloadedMB)}MB / ${String.format("%.1f", totalMB)}MB)"
                        }
                        else -> {
                            // è§£å‹é˜¶æ®µæˆ–æ²¡æœ‰æ€»å¤§å°ï¼Œæ˜¾ç¤ºå·²ä¸‹è½½å¤§å°å’Œé¢„æœŸå¤§å°
                            "æ­£åœ¨ä¸‹è½½ $modelName: $progress% (${String.format("%.1f", downloadedMB)}MB / ${String.format("%.1f", totalMB)}MB)"
                        }
                    }
                    statusText.text = statusMessage
                    
                    // æ›´æ–°ä¸‹è½½é€Ÿåº¦
                    if (speed > 0) {
                        val speedMB = speed / 1024.0 / 1024.0
                        if (speedMB >= 1.0) {
                            speedText.text = "${String.format("%.2f", speedMB)} MB/s"
                        } else {
                            val speedKB = speed / 1024.0
                            speedText.text = "${String.format("%.1f", speedKB)} KB/s"
                        }
                    } else {
                        speedText.text = ""
                    }
                    
                    // ç¡®ä¿UIæ›´æ–°
                    progressBar.invalidate()
                    progressText.invalidate()
                    statusText.invalidate()
                    speedText.invalidate()
                }
            }
        })
        
        // åœ¨åå°åç¨‹ä¸­å¼€å§‹ä¸‹è½½
        kotlinx.coroutines.CoroutineScope(kotlinx.coroutines.Dispatchers.Main + kotlinx.coroutines.SupervisorJob()).launch {
            val success = downloadManager.initializeModel(autoDownload = true)
            if (!success) {
                handler.post {
                    downloadProgressBottomSheet?.dismiss()
                    downloadProgressBottomSheet = null
                    downloadManager.release()
                    
                    // æ¢å¤åˆ‡æ¢å™¨çŠ¶æ€
                    val useVosk = settingsManager.getBoolean("use_vosk_offline_voice", false)
                    val voskManager = VoskManager(this@SimpleModeActivity)
                    val currentModelType = if (useVosk) {
                        voskManager.getCurrentModelType()
                    } else {
                        null
                    }
                    val selectedIndex = when {
                        !useVosk -> 0
                        currentModelType == VoskManager.ModelType.SMALL -> 1
                        currentModelType == VoskManager.ModelType.FULL -> 2
                        else -> 0
                    }
                    voiceModelSegmentedControl?.setSelectedIndex(selectedIndex)
                }
            }
        }
    }
    
    /**
     * æ›´æ–°è¯­éŸ³äº¤äº’æ¨¡å¼UIæ˜¾ç¤º
     */
    private fun updateVoiceInteractionModeUI(mode: VoicePromptBranchManager.InteractionMode) {
        val iconView = findViewById<ImageView>(R.id.voice_interaction_mode_icon)
        val descView = findViewById<TextView>(R.id.voice_interaction_mode_desc)

        when (mode) {
            VoicePromptBranchManager.InteractionMode.CLICK -> {
                iconView?.setImageResource(R.drawable.ic_click)
                descView?.text = "ç‚¹å‡»æ¨¡å¼ï¼šç‚¹å‡»å¼€å§‹/åœæ­¢å½•éŸ³"
            }
            VoicePromptBranchManager.InteractionMode.DRAG -> {
                iconView?.setImageResource(R.drawable.ic_drag_handle)
                descView?.text = "æ‹–åŠ¨æ¨¡å¼ï¼šé•¿æŒ‰æ‹–åŠ¨å½•éŸ³"
            }
        }
    }

    
    private fun setupVoiceMicListener() {
        Log.d(TAG, "è®¾ç½®éº¦å…‹é£æŒ‰é’®ç›‘å¬å™¨")
        
        // éº¦å…‹é£æŒ‰é’®è§¦æ‘¸ç›‘å¬ï¼Œå¤„ç†å•å‡»å’Œé•¿æŒ‰
        voiceMicContainer.setOnTouchListener { _, event ->
            Log.d(TAG, "éº¦å…‹é£æŒ‰é’®è§¦æ‘¸äº‹ä»¶: ${event.action}")
            when (event.action) {
                MotionEvent.ACTION_DOWN -> {
                    Log.d(TAG, "éº¦å…‹é£æŒ‰é’®æŒ‰ä¸‹")
                    isLongPress = false
                    longPressHandler.postDelayed(longPressRunnable, 500) // 500msç®—é•¿æŒ‰
                    true // æ¶ˆè´¹äº‹ä»¶
                }
                MotionEvent.ACTION_MOVE -> {
                    // é•¿æŒ‰æ¨¡å¼åˆ‡æ¢ä¸éœ€è¦å¤„ç†MOVEäº‹ä»¶
                    true
                }
                MotionEvent.ACTION_UP, MotionEvent.ACTION_CANCEL -> {
                    Log.d(TAG, "éº¦å…‹é£æŒ‰é’®æŠ¬èµ· - isLongPress: $isLongPress")
                    longPressHandler.removeCallbacks(longPressRunnable)
                    if (isLongPress) {
                        // é•¿æŒ‰ï¼šåˆ‡æ¢éº¦å…‹é£æ¨¡å¼ï¼ˆè¯­éŸ³è¾“å…¥/TTSæœ—è¯»ï¼‰
                        Log.d(TAG, "æ£€æµ‹åˆ°é•¿æŒ‰ï¼Œåˆ‡æ¢æ¨¡å¼")
                        toggleMicMode()
                    } else {
                        // å•å‡»ï¼šæ‰§è¡Œå½“å‰æ¨¡å¼çš„åŠŸèƒ½
                        Log.d(TAG, "æ£€æµ‹åˆ°å•å‡»ï¼Œæ‰§è¡Œå½“å‰æ¨¡å¼åŠŸèƒ½")
                        toggleVoiceRecognition()
                    }
                    isLongPress = false
                    true // æ¶ˆè´¹äº‹ä»¶
                }
                else -> false
            }
        }

        voiceClearButton.setOnClickListener { 
            performVibration("light")
            clearVoiceText() 
        }
        voicePauseButton.setOnClickListener { 
            performVibration("light")
            toggleRecordingPause() 
        }
        voiceSaveButton.setOnClickListener { 
            performVibration("light")
            saveRecording() 
        }
        voiceSearchButton.setOnClickListener { 
            performVibration("light")
            executeVoiceSearch() 
        }
        
        // æ·»åŠ æ–‡æœ¬è¾“å…¥ç›‘å¬å™¨ï¼Œå®æ—¶æ›´æ–°ä¿å­˜æŒ‰é’®å¯è§æ€§
        voiceTextInput.addTextChangedListener(object : TextWatcher {
            override fun beforeTextChanged(s: CharSequence?, start: Int, count: Int, after: Int) {}
            override fun onTextChanged(s: CharSequence?, start: Int, before: Int, count: Int) {}
            override fun afterTextChanged(s: android.text.Editable?) {
                updateSaveButtonVisibility()
            }
        })
    }

    private fun setupSettingsPage() {
        // è®¾ç½®æ¨¡å¼åˆ‡æ¢ç»„ä»¶ (æš‚æ—¶ç¦ç”¨)
        // setupModeSwitchWidget()

        // å…ˆè®¾ç½®ä¸‹æ‹‰èœå•é€‚é…å™¨ - ä½¿ç”¨è‡ªå®šä¹‰å¸ƒå±€æ”¯æŒæš—è‰²æ¨¡å¼
        val displayModeAdapter = ArrayAdapter.createFromResource(
            this,
            R.array.display_mode_entries,
            R.layout.spinner_item
        ).apply {
            setDropDownViewResource(R.layout.dropdown_item)
        }
        displayModeSpinner.adapter = displayModeAdapter
        Log.d(TAG, "æ˜¾ç¤ºæ¨¡å¼Spinneré€‚é…å™¨å·²è®¾ç½®ï¼Œé¡¹ç›®æ•°é‡: ${displayModeAdapter.count}")

        val themeAdapter = ArrayAdapter.createFromResource(
            this,
            R.array.theme_mode_entries,
            R.layout.spinner_item
        ).apply {
            setDropDownViewResource(R.layout.dropdown_item)
        }
        themeModeSpinner.adapter = themeAdapter
        Log.d(TAG, "ä¸»é¢˜æ¨¡å¼Spinneré€‚é…å™¨å·²è®¾ç½®ï¼Œé¡¹ç›®æ•°é‡: ${themeAdapter.count}")

        val windowCountAdapter = ArrayAdapter.createFromResource(
            this,
            R.array.window_count_entries,
            R.layout.spinner_item
        ).apply {
            setDropDownViewResource(R.layout.dropdown_item)
        }
        windowCountSpinner.adapter = windowCountAdapter

        // è®¾ç½®ä¸‹æ‹‰èœå•ç›‘å¬å™¨
        displayModeSpinner.onItemSelectedListener = object : AdapterView.OnItemSelectedListener {
            override fun onItemSelected(parent: AdapterView<*>, view: View?, position: Int, id: Long) {
                val displayModeValues = resources.getStringArray(R.array.display_mode_values)
                if (position < displayModeValues.size) {
                    val selectedMode = displayModeValues[position]
                    val currentMode = settingsManager.getDisplayMode()

                    // åªæœ‰å½“æ¨¡å¼çœŸæ­£æ”¹å˜æ—¶æ‰æ‰§è¡Œåˆ‡æ¢
                    if (selectedMode != currentMode) {
                        Log.d(TAG, "Display mode changed from $currentMode to $selectedMode")
                        settingsManager.setDisplayMode(selectedMode)

                        // æ ¹æ®é€‰æ‹©çš„æ¨¡å¼æ‰§è¡Œç›¸åº”çš„åˆ‡æ¢æ“ä½œ
                        when (selectedMode) {
                            "floating_ball" -> {
                                // åˆ‡æ¢åˆ°æ‚¬æµ®çƒæ¨¡å¼
                                switchToFloatingBallMode()
                            }
                            "dynamic_island" -> {
                                // åˆ‡æ¢åˆ°çµåŠ¨å²›æ¨¡å¼
                                switchToDynamicIslandMode()
                            }
                            "simple_mode" -> {
                                // å·²ç»åœ¨ç®€æ˜“æ¨¡å¼ï¼Œæ— éœ€åˆ‡æ¢ï¼Œä½†éœ€è¦æ›´æ–°è®¾ç½®å¯è§æ€§
                                Log.d(TAG, "Already in simple mode")

                                updateFloatingBallSettingsVisibility()
                            }
                        }
                    } else {
                        // å³ä½¿æ¨¡å¼æ²¡æœ‰æ”¹å˜ï¼Œä¹Ÿè¦ç¡®ä¿è®¾ç½®å¯è§æ€§æ­£ç¡®
                        updateFloatingBallSettingsVisibility()
                    }
                }
            }
            override fun onNothingSelected(parent: AdapterView<*>) {}
        }

        themeModeSpinner.onItemSelectedListener = object : AdapterView.OnItemSelectedListener {
            override fun onItemSelected(parent: AdapterView<*>, view: View?, position: Int, id: Long) {
                // ä¿®å¤ä¸»é¢˜æ¨¡å¼æ˜ å°„ï¼š
                // æ•°ç»„é¡ºåºï¼š[è·Ÿéšç³»ç»Ÿ, æµ…è‰²æ¨¡å¼, æ·±è‰²æ¨¡å¼] â†’ ç´¢å¼• [0, 1, 2]
                // å¯¹åº”å¸¸é‡ï¼š[THEME_MODE_SYSTEM, THEME_MODE_LIGHT, THEME_MODE_DARK]
                val selectedTheme = when(position) {
                    0 -> SettingsManager.THEME_MODE_SYSTEM  // è·Ÿéšç³»ç»Ÿ
                    1 -> SettingsManager.THEME_MODE_LIGHT   // æµ…è‰²æ¨¡å¼
                    2 -> SettingsManager.THEME_MODE_DARK    // æ·±è‰²æ¨¡å¼
                    else -> SettingsManager.THEME_MODE_SYSTEM
                }

                val currentTheme = settingsManager.getThemeMode()
                // åªæœ‰å½“ä¸»é¢˜çœŸæ­£æ”¹å˜æ—¶æ‰åº”ç”¨æ–°ä¸»é¢˜
                if (selectedTheme != currentTheme) {
                    Log.d(TAG, "Theme mode changed from $currentTheme to $selectedTheme")
                    settingsManager.setThemeMode(selectedTheme)

                    // ç«‹å³åº”ç”¨æ–°ä¸»é¢˜
                    applyTheme()
                    
                    // å¼ºåˆ¶åˆ·æ–°UIä»¥ç¡®ä¿ä¸»é¢˜ç«‹å³ç”Ÿæ•ˆ
                    window.decorView.post {
                        updateUIColors()
                    }
                } else {
                    Log.d(TAG, "Theme mode unchanged: $selectedTheme")
                    // å³ä½¿ä¸»é¢˜æ²¡æœ‰æ”¹å˜ï¼Œä¹Ÿç¡®ä¿UIé¢œè‰²æ­£ç¡®æ˜¾ç¤º
                    updateUIColors()
                }
            }
            override fun onNothingSelected(parent: AdapterView<*>) {}
        }

        windowCountSpinner.onItemSelectedListener = object : AdapterView.OnItemSelectedListener {
            override fun onItemSelected(parent: AdapterView<*>, view: View?, position: Int, id: Long) {
                // çª—å£æ•°é‡é€‰é¡¹ï¼š1, 2, 3
                val windowCount = position + 1
                settingsManager.setDefaultWindowCount(windowCount)
            }
            override fun onNothingSelected(parent: AdapterView<*>) {}
        }

        // è®¾ç½®å¼€å…³ç›‘å¬å™¨
        leftHandedSwitch.setOnCheckedChangeListener { _, isChecked ->
            settingsManager.setLeftHandedMode(isChecked)
            // ç«‹å³åº”ç”¨å·¦æ‰‹æ¨¡å¼
            updateLayoutForHandedness(isChecked)
        }

        clipboardMonitorSwitch.setOnCheckedChangeListener { _, isChecked ->
            settingsManager.setClipboardListenerEnabled(isChecked)
        }

        autoHideSwitch.setOnCheckedChangeListener { _, isChecked ->
            settingsManager.setAutoHide(isChecked)
        }

        aiModeSwitch.setOnCheckedChangeListener { _, isChecked ->
            settingsManager.setIsAIMode(isChecked)
        }

        autoPasteSwitch.setOnCheckedChangeListener { _, isChecked ->
            settingsManager.setAutoPasteEnabled(isChecked)
        }

        multiTabBrowserSwitch.setOnCheckedChangeListener { _, isChecked ->
            settingsManager.putBoolean("use_multi_tab_browser", isChecked)
            Log.d(TAG, "å¤šæ ‡ç­¾é¡µæµè§ˆå™¨è®¾ç½®: $isChecked")
        }

        notificationListenerSwitch.setOnCheckedChangeListener { _, isChecked ->
            // é€šçŸ¥ç›‘å¬å™¨è®¾ç½®éœ€è¦ä½¿ç”¨é€šç”¨çš„putBooleanæ–¹æ³•
            settingsManager.putBoolean("enable_notification_listener", isChecked)
        }

        voskOfflineVoiceSwitch.setOnCheckedChangeListener { _, isChecked ->
            if (isChecked) {
                // æ‰“å¼€å¼€å…³æ—¶ï¼Œæ˜¾ç¤ºæ¨¡å‹é€‰æ‹©å¯¹è¯æ¡†
                showVoskModelSelectionDialog()
            } else {
                // å…³é—­å¼€å…³æ—¶ï¼Œç›´æ¥ä¿å­˜è®¾ç½®
                settingsManager.putBoolean("use_vosk_offline_voice", false)
                Log.d(TAG, "Voskç¦»çº¿è¯­éŸ³è¯†åˆ«è®¾ç½®: å·²å…³é—­")
                Toast.makeText(this, "å·²åˆ‡æ¢åˆ°ç³»ç»Ÿè¯­éŸ³è¯†åˆ«", Toast.LENGTH_SHORT).show()
            }
        }



        // è®¾ç½®é€æ˜åº¦SeekBarç›‘å¬å™¨
        ballAlphaSeekbar.setOnSeekBarChangeListener(object : SeekBar.OnSeekBarChangeListener {
            override fun onProgressChanged(seekBar: SeekBar?, progress: Int, fromUser: Boolean) {
                if (fromUser) {
                    // å°†0-100çš„è¿›åº¦è½¬æ¢ä¸º0-255çš„alphaå€¼
                    val alphaValue = ((progress / 100.0) * 255).toInt()
                    settingsManager.setBallAlpha(alphaValue)
                }
            }
            override fun onStartTrackingTouch(seekBar: SeekBar?) {}
            override fun onStopTrackingTouch(seekBar: SeekBar?) {}
        })



        // è®¾ç½®ç‚¹å‡»äº‹ä»¶
        aiApiSettingsItem.setOnClickListener {
            try {
                startActivity(Intent(this, AIApiSettingsActivity::class.java))
            } catch (e: Exception) {
                Log.e(TAG, "Failed to open AIApiSettings", e)
                Toast.makeText(this, "æ— æ³•æ‰“å¼€AI APIè®¾ç½®", Toast.LENGTH_SHORT).show()
            }
        }

        searchEngineSettingsItem.setOnClickListener {
            safeStartActivity(SearchEngineManagerActivity::class.java, "æœç´¢å¼•æ“è®¾ç½®")
        }

        aiSearchEngineSettingsItem.setOnClickListener {
            safeStartActivity(AISearchEngineSettingsActivity::class.java, "AIæœç´¢å¼•æ“è®¾ç½®")
        }

        masterPromptSettingsItem.setOnClickListener {
            safeStartActivity(MasterPromptSettingsActivity::class.java, "ä¸»æç¤ºè¯è®¾ç½®")
        }

        appSearchSettingsItem.setOnClickListener {
            safeStartActivity(com.example.aifloatingball.settings.AppSearchSettingsActivity::class.java, "åº”ç”¨æœç´¢è®¾ç½®")
        }

        permissionManagementItem.setOnClickListener {
            try {
                startActivity(Intent(this, PermissionManagementActivity::class.java))
            } catch (e: Exception) {
                Log.e(TAG, "Failed to open PermissionManagement", e)
                Toast.makeText(this, "æ— æ³•æ‰“å¼€æƒé™ç®¡ç†", Toast.LENGTH_SHORT).show()
            }
        }

        viewSearchHistoryItem.setOnClickListener {
            try {
                startActivity(Intent(this, SearchHistoryActivity::class.java))
            } catch (e: Exception) {
                Log.e(TAG, "Failed to open SearchHistory", e)
                Toast.makeText(this, "æ— æ³•æ‰“å¼€æœç´¢å†å²", Toast.LENGTH_SHORT).show()
            }
        }

        onboardingGuideItem.setOnClickListener {
            try {
                startActivity(Intent(this, com.example.aifloatingball.ui.onboarding.OnboardingActivity::class.java))
            } catch (e: Exception) {
                Log.e(TAG, "Failed to open OnboardingGuide", e)
                Toast.makeText(this, "æ— æ³•æ‰“å¼€æ–°æ‰‹æŒ‡å—", Toast.LENGTH_SHORT).show()
            }
        }

        // åº•éƒ¨å¯¼èˆªæ è®¾ç½®å·²é›†æˆåˆ°åŸºç¡€è®¾ç½®ä¸­ï¼Œä¸å†éœ€è¦å•ç‹¬çš„Activity

        // è®¾ç½®Appç‰ˆæœ¬å·
        try {
            val pInfo = packageManager.getPackageInfo(packageName, 0)
            val version = pInfo.versionName
            appVersionText.text = "ç‰ˆæœ¬: $version"
        } catch (e: PackageManager.NameNotFoundException) {
            e.printStackTrace()
            appVersionText.text = "ç‰ˆæœ¬: N/A"
        }

        // åˆå§‹åŒ–è¯­éŸ³è¾“å…¥ç®¡ç†å™¨
        voiceInputManager = VoiceInputManager(this)
        
        // åˆå§‹åŒ–ä¸‰æ®µå¼èƒ¶å›Šå¸ƒå±€
        initializeVoiceCapsuleLayout()
        voiceInputManager.setCallback(object : VoiceInputManager.VoiceInputCallback {
            override fun onVoiceInputResult(text: String) {
                runOnUiThread {
                    try {
                        // æµå¼æ˜¾ç¤ºï¼šå°†è¯†åˆ«ç»“æœæ·»åŠ åˆ°ç°æœ‰æ–‡æœ¬ä¸­
                        val currentText = voiceCapsuleTextInput?.text?.toString() ?: ""
                        val newText = if (currentText.isEmpty()) text else "$currentText $text"

                        // æ›´æ–°èƒ¶å›Šè¾“å…¥æ¡† - æµå¼æ˜¾ç¤ºæ–‡å­—
                        voiceCapsuleTextInput?.let { input ->
                            input.setText(newText)
                            input.setSelection(newText.length)
                            
                            // ç¡®ä¿è¾“å…¥æ¡†ä¿æŒå›ºå®šé«˜åº¦
                            input.requestLayout()
                        }

                        // æ›´æ–°åŸå§‹è¾“å…¥æ¡†ï¼ˆä¿æŒåŒæ­¥ï¼‰
                        voiceTextInput.setText(newText)
                        voiceTextInput.setSelection(newText.length)
                        // ç§»é™¤çŠ¶æ€æ–‡æœ¬æç¤ºï¼Œä¸“æ³¨äºæ˜¾ç¤ºè¯†åˆ«ç»“æœ
                        voiceSearchButton.isEnabled = true

                                // åœ¨èƒ¶å›Šæ¨¡å¼ä¸‹ï¼Œä¿æŒå½•éŸ³çŠ¶æ€ï¼Œä¸é‡ç½®isListening
                                // è¿™æ ·éº¦å…‹é£æŒ‰é’®ä¼šä¿æŒéšè—ï¼Œæš‚åœæŒ‰é’®ä¿æŒæ˜¾ç¤º
                                // æ³¨æ„ï¼šä¸è°ƒç”¨ updateVoiceListeningState(false)ï¼Œä¿æŒå½•éŸ³UIçŠ¶æ€

                        // åœ¨èƒ¶å›Šæ¨¡å¼ä¸‹ï¼Œå§‹ç»ˆç»§ç»­å½•éŸ³ï¼Œç›´åˆ°ç”¨æˆ·ç‚¹å‡»éº¦å…‹é£åœæ­¢
                        if (isVoiceCapsuleMode && shouldContinueRecording) {
                            // ç«‹å³ç»§ç»­å½•éŸ³ï¼Œå®ç°è¿ç»­å½•éŸ³
                            voiceCapsuleTextInput?.postDelayed({
                                if (shouldContinueRecording) {
                                    continueRecording()
                                }
                            }, 200) // è¿›ä¸€æ­¥å‡å°‘å»¶è¿Ÿæ—¶é—´ï¼Œå®ç°æ›´å¿«çš„è¿ç»­å½•éŸ³
                        } else {
                            // åˆ‡æ¢åˆ°ä¸‰æ®µå¼èƒ¶å›Šå¸ƒå±€
                            switchToVoiceCapsuleLayout(newText)
                            // æ˜¾ç¤ºå¹³å°å›¾æ ‡
                            showVoiceCapsulePlatformIcons(newText)
                        }
                    } catch (e: Exception) {
                        Log.e(TAG, "å¤„ç†è¯­éŸ³è¯†åˆ«ç»“æœå¤±è´¥", e)
                    }
                }
            }

            override fun onVoiceInputError(error: String) {
                runOnUiThread {
                    voiceStatusText.text = error
                    isListening = false
                    updateVoiceListeningState(false)
                    
                    // æ›´æ–°èƒ¶å›Šå½•éŸ³çŠ¶æ€
                    updateCapsuleRecordingState(false)
                }
            }

            override fun onVoiceInputCancelled() {
                runOnUiThread {
                    voiceStatusText.text = "è¯­éŸ³è¾“å…¥å·²å–æ¶ˆ"
                    isListening = false
                    updateVoiceListeningState(false)
                    
                    // æ›´æ–°èƒ¶å›Šå½•éŸ³çŠ¶æ€
                    updateCapsuleRecordingState(false)
                }
            }
        })

        // æ£€æµ‹è¯­éŸ³æ”¯æŒæƒ…å†µå¹¶æ›´æ–°UI
        detectAndUpdateVoiceSupport()

        // åœ¨è®¾ç½®å®Œæ‰€æœ‰é€‚é…å™¨å’Œç›‘å¬å™¨åï¼Œå»¶è¿ŸåŠ è½½å½“å‰è®¾ç½®ä»¥ç¡®ä¿UIå®Œå…¨åˆå§‹åŒ–
        Handler(Looper.getMainLooper()).post {
            loadSettings()
            // åˆå§‹åŒ–åº•éƒ¨å¯¼èˆªæ æ˜¾ç¤º
            refreshBottomNavigation()
        }
    }

    /**
     * è®¾ç½®åº•éƒ¨å¯¼èˆªæ æŒ‰é’®é…ç½®
     * åœ¨åŸºç¡€è®¾ç½®ä¸­æ˜¾ç¤ºå¯¼èˆªæ æŒ‰é’®ï¼Œæ”¯æŒç‚¹å‡»åˆ‡æ¢æ˜¾ç¤º/éšè—ï¼Œé•¿æŒ‰æ‹–åŠ¨è°ƒæ•´é¡ºåº
     */
    private fun setupBottomNavTabsSettings() {
        val settingsManager = SettingsManager.getInstance(this)
        
        // åŠ è½½é…ç½®
        val configs = settingsManager.getBottomNavTabConfigs().toMutableList()
        
        // åˆ›å»ºé€‚é…å™¨
        bottomNavTabSettingsAdapter = com.example.aifloatingball.adapter.BottomNavTabSettingsAdapter(configs) { newConfigs ->
            // å®æ—¶ä¿å­˜é…ç½®
            settingsManager.saveBottomNavTabConfigs(newConfigs)
            // åˆ·æ–°åº•éƒ¨å¯¼èˆªæ 
            refreshBottomNavigation()
        }
        
        // è®¾ç½®RecyclerView - ä½¿ç”¨LinearLayoutManageræ¨ªå‘å¸ƒå±€
        bottomNavTabsRecyclerView.layoutManager = LinearLayoutManager(this, LinearLayoutManager.HORIZONTAL, false)
        bottomNavTabsRecyclerView.adapter = bottomNavTabSettingsAdapter
        
        // è®¾ç½®æ‹–æ‹½æ’åº
        val callback = object : ItemTouchHelper.SimpleCallback(
            ItemTouchHelper.LEFT or ItemTouchHelper.RIGHT,
            0
        ) {
            override fun onMove(
                recyclerView: RecyclerView,
                viewHolder: RecyclerView.ViewHolder,
                target: RecyclerView.ViewHolder
            ): Boolean {
                val fromPosition = viewHolder.adapterPosition
                val toPosition = target.adapterPosition
                
                if (fromPosition == RecyclerView.NO_POSITION || 
                    toPosition == RecyclerView.NO_POSITION) {
                    return false
                }
                
                // ç§»åŠ¨item
                bottomNavTabSettingsAdapter.moveItem(fromPosition, toPosition)
                return true
            }
            
            override fun onSwiped(viewHolder: RecyclerView.ViewHolder, direction: Int) {
                // ä¸æ”¯æŒæ»‘åŠ¨åˆ é™¤
            }
            
            override fun onSelectedChanged(viewHolder: RecyclerView.ViewHolder?, actionState: Int) {
                super.onSelectedChanged(viewHolder, actionState)
                
                if (actionState == ItemTouchHelper.ACTION_STATE_DRAG && viewHolder != null) {
                    // æ‹–åŠ¨å¼€å§‹æ—¶çš„åŠ¨ç”»æ•ˆæœ
                    val itemView = viewHolder.itemView
                    ViewCompat.setElevation(itemView, 16f)
                    itemView.animate()
                        .scaleX(1.1f)
                        .scaleY(1.1f)
                        .setDuration(200)
                        .setInterpolator(androidx.interpolator.view.animation.FastOutSlowInInterpolator())
                        .start()
                }
            }
            
            override fun clearView(recyclerView: RecyclerView, viewHolder: RecyclerView.ViewHolder) {
                super.clearView(recyclerView, viewHolder)
                
                // æ‹–åŠ¨ç»“æŸæ—¶çš„åŠ¨ç”»æ•ˆæœ
                val itemView = viewHolder.itemView
                ViewCompat.setElevation(itemView, 0f)
                itemView.animate()
                    .scaleX(1f)
                    .scaleY(1f)
                    .setDuration(200)
                    .setInterpolator(androidx.interpolator.view.animation.FastOutSlowInInterpolator())
                    .start()
            }
            
            override fun isLongPressDragEnabled(): Boolean {
                return true
            }
        }
        
        val itemTouchHelper = ItemTouchHelper(callback)
        itemTouchHelper.attachToRecyclerView(bottomNavTabsRecyclerView)
    }
    
    /**
     * åˆ·æ–°åº•éƒ¨å¯¼èˆªæ æ˜¾ç¤º
     * æ ¹æ®é…ç½®æ›´æ–°æŒ‰é’®çš„æ˜¾ç¤º/éšè—çŠ¶æ€å’Œé¡ºåº
     */
    private fun refreshBottomNavigation() {
        val settingsManager = SettingsManager.getInstance(this)
        val configs = settingsManager.getBottomNavTabConfigs()
        val bottomNav = findViewById<LinearLayout>(R.id.bottom_navigation) ?: return
        
        // åˆ›å»ºtabIdåˆ°Viewçš„æ˜ å°„
        val tabViewMap = mapOf(
            "tab_chat" to findViewById<LinearLayout>(R.id.tab_chat),
            "tab_search" to findViewById<LinearLayout>(R.id.tab_search),
            "tab_home" to findViewById<LinearLayout>(R.id.tab_home),
            "tab_voice" to findViewById<LinearLayout>(R.id.tab_voice),
            "tab_browser" to findViewById<LinearLayout>(R.id.tab_browser),
            "tab_app_search" to findViewById<LinearLayout>(R.id.tab_app_search),
            "tab_settings" to findViewById<LinearLayout>(R.id.tab_settings)
        )
        
        // å…ˆéšè—æ‰€æœ‰tab
        tabViewMap.values.forEach { view ->
            view?.visibility = View.GONE
        }
        
        // æŒ‰é…ç½®é¡ºåºæ˜¾ç¤ºå¯è§çš„tab
        val sortedConfigs = configs.sortedBy { it.order }
        sortedConfigs.forEach { config ->
            val view = tabViewMap[config.tabId]
            view?.visibility = if (config.isVisible) View.VISIBLE else View.GONE
        }
        
        // æ›´æ–°tabé¢œè‰²
        updateTabColors()
    }
    
    private fun detectAndUpdateVoiceSupport() {
        try {
            voiceSupportInfo = voiceInputManager.detectVoiceSupport()
            updateVoiceButtonState(voiceSupportInfo!!)
            Log.d(TAG, "è¯­éŸ³æ”¯æŒæ£€æµ‹å®Œæˆ: ${voiceSupportInfo!!.statusMessage}")

            // å¦‚æœä¸æ”¯æŒè¯­éŸ³è¾“å…¥ï¼Œæ˜¾ç¤ºæç¤º
            if (voiceSupportInfo!!.supportLevel == VoiceInputManager.SupportLevel.NO_SUPPORT) {
                showNoVoiceSupportHint()
            }
        } catch (e: Exception) {
            Log.e(TAG, "è¯­éŸ³æ”¯æŒæ£€æµ‹å¤±è´¥", e)
            // å¦‚æœæ£€æµ‹å¤±è´¥ï¼Œé»˜è®¤ä¸ºä¸æ”¯æŒçŠ¶æ€
            voiceSupportInfo = VoiceInputManager.VoiceSupportInfo(
                isSupported = false,
                supportLevel = VoiceInputManager.SupportLevel.NO_SUPPORT,
                availableMethods = listOf("æ‰‹åŠ¨è¾“å…¥"),
                recommendedMethod = "æ‰‹åŠ¨è¾“å…¥",
                statusMessage = "è¯­éŸ³åŠŸèƒ½æ£€æµ‹å¤±è´¥"
            )
            updateVoiceButtonState(voiceSupportInfo!!)
            showNoVoiceSupportHint()
        }
    }

    /**
     * æ˜¾ç¤ºä¸æ”¯æŒè¯­éŸ³è¾“å…¥çš„æç¤º - å·²ä¿®æ”¹ä¸ºé™é»˜å¤„ç†
     */
    private fun showNoVoiceSupportHint() {
        // ä¸å†æ˜¾ç¤ºToastæç¤ºï¼Œé™é»˜åˆ‡æ¢åˆ°æ–‡æœ¬è¾“å…¥æ¨¡å¼
        Log.d(TAG, "æ£€æµ‹åˆ°è®¾å¤‡ä¸æ”¯æŒè¯­éŸ³è¾“å…¥ï¼Œå·²è‡ªåŠ¨åˆ‡æ¢åˆ°æ–‡æœ¬è¾“å…¥æ¨¡å¼")
    }

    /**
     * æ ¹æ®è¯­éŸ³æ”¯æŒæƒ…å†µæ›´æ–°è¯­éŸ³æŒ‰é’®çŠ¶æ€
     */
    private fun updateVoiceButtonState(supportInfo: VoiceInputManager.VoiceSupportInfo) {
        runOnUiThread {
            if (supportInfo.isSupported) {
                // æ”¯æŒSpeechRecognizerï¼šæ˜¾ç¤ºè¯­éŸ³ç›¸å…³UI
                voiceMicContainer.visibility = View.VISIBLE
                voiceMicContainer.isEnabled = true
                voiceStatusText.text = "ç‚¹å‡»éº¦å…‹é£å¼€å§‹è¯­éŸ³è¾“å…¥"
                voiceStatusText.setTextColor(ContextCompat.getColor(this, R.color.simple_mode_text_primary_light))

                // æ˜¾ç¤ºè¯­éŸ³æç¤ºæ–‡æœ¬å’Œè®¾ç½®
                voiceHintText?.visibility = View.VISIBLE
                voiceSettingsCard?.visibility = View.VISIBLE

                Log.d(TAG, "æ˜¾ç¤ºè¯­éŸ³UIï¼šSpeechRecognizerå¯ç”¨")
            } else {
                // ä¸æ”¯æŒSpeechRecognizerï¼šéšè—è¯­éŸ³ç›¸å…³UIï¼Œè‡ªåŠ¨æ˜¾ç¤ºè¾“å…¥æ³•
                voiceMicContainer.visibility = View.GONE
                voiceStatusText.text = "è¯·ç›´æ¥è¾“å…¥æ–‡æœ¬"
                voiceStatusText.setTextColor(ContextCompat.getColor(this, R.color.simple_mode_text_secondary_light))

                // éšè—åœ¨çº¿è¯­éŸ³ç›¸å…³çš„æç¤ºå’Œè®¾ç½®
                voiceHintText?.visibility = View.GONE
                voiceSettingsCard?.visibility = View.GONE

                // è‡ªåŠ¨èšç„¦åˆ°æ–‡æœ¬è¾“å…¥æ¡†å¹¶æ˜¾ç¤ºè¾“å…¥æ³•
                voiceTextInput.requestFocus()
                val imm = getSystemService(Context.INPUT_METHOD_SERVICE) as InputMethodManager
                imm.showSoftInput(voiceTextInput, InputMethodManager.SHOW_IMPLICIT)

                Log.d(TAG, "éšè—è¯­éŸ³UIï¼šSpeechRecognizerä¸å¯ç”¨ï¼Œè‡ªåŠ¨æ˜¾ç¤ºè¾“å…¥æ³•")
            }
        }
    }

    /**
     * æ›´æ–°å·¦å³æ‰‹æ¨¡å¼å¸ƒå±€
     */
    private fun updateLayoutForHandedness(isLeftHanded: Boolean) {
        // åº”ç”¨RTLå¸ƒå±€æ–¹å‘
        applyLayoutDirection(isLeftHanded)

        // æ›´æ–°æœç´¢å¼•æ“æŠ½å±‰ä½ç½®å’ŒæŒ‰é’®
        updateSearchDrawerForHandedness(isLeftHanded)

        // æ›´æ–°è®¾ç½®é¡µé¢æ ‡é¢˜å¯¹é½
        updateSettingsPageLayout(isLeftHanded)

        // æ›´æ–°åº•éƒ¨å¯¼èˆªæ å¸ƒå±€æ–¹å‘
        updateBottomNavigationDirection(isLeftHanded)

        // ä¸å†å¯¹æ•´ä¸ªå¸ƒå±€è¿›è¡Œé•œåƒç¿»è½¬ï¼Œé¿å…å½±å“WebViewå†…å®¹
        // åªæ›´æ–°éœ€è¦é€‚åº”å·¦æ‰‹æ¨¡å¼çš„ç‰¹å®šç»„ä»¶

        // æ›´æ–°å››åˆ†ä¹‹ä¸€åœ†å¼§æ“ä½œæ çš„ä½ç½®å’Œæ¨¡å¼
        quarterArcOperationBar?.let { operationBar ->
            // å…ˆæ›´æ–°å¸ƒå±€å‚æ•°
            val layoutParams = operationBar.layoutParams as? FrameLayout.LayoutParams
            layoutParams?.let { params ->
                params.gravity = if (isLeftHanded) {
                    android.view.Gravity.BOTTOM or android.view.Gravity.START
                } else {
                    android.view.Gravity.BOTTOM or android.view.Gravity.END
                }

                val margin = (16 * resources.displayMetrics.density).toInt()
                params.leftMargin = if (isLeftHanded) margin else 0
                params.rightMargin = if (isLeftHanded) 0 else margin
                params.bottomMargin = margin

                operationBar.layoutParams = params

                // å¼ºåˆ¶é‡æ–°å¸ƒå±€
                operationBar.requestLayout()

                Log.d(TAG, "å››åˆ†ä¹‹ä¸€åœ†å¼§æ“ä½œæ å¸ƒå±€å‚æ•°å·²æ›´æ–°ä¸ºå·¦æ‰‹æ¨¡å¼: $isLeftHanded")
            }

            // ç„¶åè®¾ç½®å·¦æ‰‹æ¨¡å¼ï¼ˆè¿™ä¼šè§¦å‘å†…éƒ¨é‡æ–°è®¡ç®—ï¼‰
            operationBar.setLeftHandedMode(isLeftHanded)
        }

        // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ å…¶ä»–éœ€è¦é€‚åº”å·¦æ‰‹æ¨¡å¼çš„UIç»„ä»¶
        // ä½†ä¸å½±å“WebViewçš„å†…å®¹æ’åˆ—
    }

    /**
     * åº”ç”¨å¸ƒå±€æ–¹å‘ï¼ˆRTLæ”¯æŒï¼‰
     */
    private fun applyLayoutDirection(isLeftHanded: Boolean) {
        if (isLeftHanded) {
            window.decorView.layoutDirection = View.LAYOUT_DIRECTION_RTL
        } else {
            window.decorView.layoutDirection = View.LAYOUT_DIRECTION_LTR
        }
    }

    /**
     * æ›´æ–°æœç´¢å¼•æ“æŠ½å±‰ä½ç½®ä»¥é€‚åº”å·¦æ‰‹æ¨¡å¼
     */
    private fun updateSearchDrawerForHandedness(isLeftHanded: Boolean) {
        // æŸ¥æ‰¾æœç´¢é¡µé¢ä¸­çš„æŠ½å±‰å¸ƒå±€
        val drawerLayout = findViewById<androidx.drawerlayout.widget.DrawerLayout>(R.id.browser_layout)
        val drawerContent = findViewById<LinearLayout>(R.id.browser_nav_drawer)

        if (drawerLayout != null && drawerContent != null) {
            // æŠ½å±‰åœ¨å¸ƒå±€æ–‡ä»¶ä¸­å›ºå®šä¸ºSTARTä½ç½®ï¼Œä¸éœ€è¦åŠ¨æ€ä¿®æ”¹
            // åªéœ€è¦ç¡®ä¿æŠ½å±‰æ˜¯è§£é”çŠ¶æ€
            drawerLayout.setDrawerLockMode(androidx.drawerlayout.widget.DrawerLayout.LOCK_MODE_UNLOCKED, androidx.core.view.GravityCompat.START)
            drawerLayout.setDrawerLockMode(androidx.drawerlayout.widget.DrawerLayout.LOCK_MODE_LOCKED_CLOSED, androidx.core.view.GravityCompat.END)

            Log.d(TAG, "æŠ½å±‰é”å®šæ¨¡å¼å·²æ›´æ–°ï¼ŒSTART: ${drawerLayout.getDrawerLockMode(androidx.core.view.GravityCompat.START)}")
        }

        // æ›´æ–°æ ‡é¢˜æ æŒ‰é’®ä½ç½®
        updateToolbarButtonsForHandedness(isLeftHanded)
    }

    /**
     * æ›´æ–°æ ‡é¢˜æ æŒ‰é’®ä½ç½®ä»¥é€‚åº”å·¦æ‰‹æ¨¡å¼
     */
    private fun updateToolbarButtonsForHandedness(isLeftHanded: Boolean) {
        // æŸ¥æ‰¾æœç´¢é¡µé¢çš„æ ‡é¢˜æ æŒ‰é’®
        val closeButton = findViewById<TextView>(R.id.browser_btn_close)
        val menuButton = findViewById<ImageButton>(R.id.browser_btn_menu)
        val searchInput = findViewById<EditText>(R.id.browser_search_input)
        val toolbar = closeButton?.parent as? LinearLayout

        if (toolbar != null && closeButton != null && menuButton != null && searchInput != null) {
            // ç¡®ä¿æŒ‰é’®å¯è§
            closeButton.visibility = View.VISIBLE
            menuButton.visibility = View.VISIBLE
            searchInput.visibility = View.VISIBLE

            // ä¸é‡æ–°æ’åˆ—æŒ‰é’®ï¼Œåªæ˜¯ç¡®ä¿å®ƒä»¬éƒ½å¯è§
            // è®©RTLå¸ƒå±€è‡ªåŠ¨å¤„ç†è§†è§‰ä½ç½®

            // è®¾ç½®èœå•æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶æ¥æ‰“å¼€æŠ½å±‰
            menuButton.setOnClickListener {
                val drawerLayout = findViewById<androidx.drawerlayout.widget.DrawerLayout>(R.id.browser_layout)
                if (drawerLayout != null) {
                    // æŠ½å±‰åœ¨å¸ƒå±€ä¸­å›ºå®šä¸ºSTARTä½ç½®ï¼Œæ‰€ä»¥ç»Ÿä¸€ä½¿ç”¨START
                    if (drawerLayout.isDrawerOpen(androidx.core.view.GravityCompat.START)) {
                        Log.d(TAG, "å…³é—­æŠ½å±‰")
                        drawerLayout.closeDrawer(androidx.core.view.GravityCompat.START)
                    } else {
                        Log.d(TAG, "æ‰“å¼€æŠ½å±‰")
                        drawerLayout.openDrawer(androidx.core.view.GravityCompat.START)
                    }
                } else {
                    Log.e(TAG, "æ‰¾ä¸åˆ°æµè§ˆå™¨æŠ½å±‰å¸ƒå±€")
                }
            }
        }
    }

    /**
     * æ›´æ–°åº•éƒ¨å¯¼èˆªæ å¸ƒå±€æ–¹å‘
     */
    private fun updateBottomNavigationDirection(isLeftHanded: Boolean) {
        try {
            val bottomNav = findViewById<LinearLayout>(R.id.bottom_navigation)
            if (bottomNav != null) {
                // æ— è®ºå·¦æ‰‹è¿˜æ˜¯å³æ‰‹æ¨¡å¼ï¼Œéƒ½ä¿æŒLTRæ–¹å‘ï¼Œç¡®ä¿tabé¡ºåºä¸€è‡´
                bottomNav.layoutDirection = View.LAYOUT_DIRECTION_LTR
                Log.d(TAG, "åº•éƒ¨å¯¼èˆªæ å¸ƒå±€æ–¹å‘å·²è®¾ç½®ä¸ºLTRï¼Œä¿æŒtabé¡ºåºä¸€è‡´")
            }
        } catch (e: Exception) {
            Log.e(TAG, "æ›´æ–°åº•éƒ¨å¯¼èˆªæ å¸ƒå±€æ–¹å‘æ—¶å‡ºé”™", e)
        }
    }













    /**
     * æ›´æ–°è®¾ç½®é¡µé¢å¸ƒå±€ä»¥é€‚åº”å·¦æ‰‹æ¨¡å¼
     */
    private fun updateSettingsPageLayout(isLeftHanded: Boolean) {
        try {
            Log.d(TAG, "æ›´æ–°è®¾ç½®é¡µé¢å¸ƒå±€ï¼Œå·¦æ‰‹æ¨¡å¼: $isLeftHanded")

            // æŸ¥æ‰¾è®¾ç½®é¡µé¢çš„ä¸»è¦æ ‡é¢˜å…ƒç´ 
            val settingsLayout = findViewById<ScrollView>(R.id.settings_layout)
            if (settingsLayout == null) {
                Log.d(TAG, "è®¾ç½®é¡µé¢å¸ƒå±€æœªæ‰¾åˆ°")
                return
            }

            // æŸ¥æ‰¾å¹¶æ›´æ–°æ‰€æœ‰è®¾ç½®æ ‡é¢˜çš„å¯¹é½æ–¹å¼
            updateSettingsTitleAlignment(settingsLayout, isLeftHanded)

        } catch (e: Exception) {
            Log.e(TAG, "æ›´æ–°è®¾ç½®é¡µé¢å¸ƒå±€æ—¶å‡ºé”™", e)
        }
    }

    /**
     * æ›´æ–°è®¾ç½®æ ‡é¢˜çš„å¯¹é½æ–¹å¼
     */
    private fun updateSettingsTitleAlignment(parentView: View, isLeftHanded: Boolean) {
        try {
            when (parentView) {
                is ViewGroup -> {
                    // æ£€æŸ¥å½“å‰ViewGroupæ˜¯å¦æ˜¯æ ‡é¢˜å¸ƒå±€
                    if (parentView is LinearLayout && parentView.orientation == LinearLayout.HORIZONTAL) {
                        // æ£€æŸ¥æ˜¯å¦åŒ…å«ImageViewå’ŒTextViewï¼ˆæ ‡é¢˜çš„å…¸å‹ç»“æ„ï¼‰
                        var hasImageView = false
                        var hasTextView = false
                        var textView: TextView? = null

                        for (i in 0 until parentView.childCount) {
                            val child = parentView.getChildAt(i)
                            when (child) {
                                is ImageView -> hasImageView = true
                                is TextView -> {
                                    hasTextView = true
                                    textView = child
                                }
                            }
                        }

                        // å¦‚æœæ˜¯æ ‡é¢˜å¸ƒå±€ï¼Œæ›´æ–°å¯¹é½æ–¹å¼
                        if (hasImageView && hasTextView && textView != null) {
                            // æ£€æŸ¥æ–‡å­—å¤§å°ï¼Œç¡®ä¿æ˜¯æ ‡é¢˜è€Œä¸æ˜¯æ™®é€šæ–‡æœ¬
                            val textSizeInSp = textView.textSize / resources.displayMetrics.scaledDensity
                            if (textSizeInSp >= 16f) { // æ ‡é¢˜é€šå¸¸æ˜¯16spæˆ–æ›´å¤§
                                if (isLeftHanded) {
                                    // å·¦æ‰‹æ¨¡å¼ï¼šæ ‡é¢˜é å³å¯¹é½
                                    parentView.gravity = android.view.Gravity.END or android.view.Gravity.CENTER_VERTICAL
                                    Log.d(TAG, "è®¾ç½®æ ‡é¢˜å³å¯¹é½: ${textView.text}")
                                } else {
                                    // å³æ‰‹æ¨¡å¼ï¼šæ ‡é¢˜é å·¦å¯¹é½
                                    parentView.gravity = android.view.Gravity.START or android.view.Gravity.CENTER_VERTICAL
                                    Log.d(TAG, "è®¾ç½®æ ‡é¢˜å·¦å¯¹é½: ${textView.text}")
                                }
                            }
                        }
                    }

                    // é€’å½’å¤„ç†å­è§†å›¾
                    for (i in 0 until parentView.childCount) {
                        updateSettingsTitleAlignment(parentView.getChildAt(i), isLeftHanded)
                    }
                }
            }
        } catch (e: Exception) {
            Log.w(TAG, "æ›´æ–°æ ‡é¢˜å¯¹é½æ—¶å‡ºé”™", e)
        }
    }

    /**
     * é€’å½’æŸ¥æ‰¾æ‰€æœ‰TextView
     */
    private fun findAllTextViews(view: View, textViews: ArrayList<TextView>) {
        if (view is TextView) {
            textViews.add(view)
        } else if (view is ViewGroup) {
            for (i in 0 until view.childCount) {
                findAllTextViews(view.getChildAt(i), textViews)
            }
        }
    }

    private fun loadSettings() {
        try {
            // åŠ è½½æ˜¾ç¤ºæ¨¡å¼
            val currentDisplayMode = settingsManager.getDisplayMode()
            val displayModeValues = resources.getStringArray(R.array.display_mode_values)
            val displayModeEntries = resources.getStringArray(R.array.display_mode_entries)
            val displayModeIndex = displayModeValues.indexOf(currentDisplayMode)

            Log.d(TAG, "å½“å‰æ˜¾ç¤ºæ¨¡å¼: $currentDisplayMode")
            Log.d(TAG, "æ˜¾ç¤ºæ¨¡å¼å€¼æ•°ç»„: ${displayModeValues.joinToString(", ")}")
            Log.d(TAG, "æ˜¾ç¤ºæ¨¡å¼æ¡ç›®æ•°ç»„: ${displayModeEntries.joinToString(", ")}")
            Log.d(TAG, "æ˜¾ç¤ºæ¨¡å¼ç´¢å¼•: $displayModeIndex")

            if (displayModeIndex != -1) {
                displayModeSpinner.setSelection(displayModeIndex, false)
                Log.d(TAG, "è®¾ç½®æ˜¾ç¤ºæ¨¡å¼Spinneré€‰æ‹©: $displayModeIndex (${displayModeEntries.getOrNull(displayModeIndex)})")

                // éªŒè¯è®¾ç½®æ˜¯å¦æˆåŠŸï¼Œå¦‚æœå¤±è´¥åˆ™å¼ºåˆ¶åˆ·æ–°
                displayModeSpinner.post {
                    val actualSelection = displayModeSpinner.selectedItemPosition
                    Log.d(TAG, "æ˜¾ç¤ºæ¨¡å¼Spinnerå®é™…é€‰æ‹©: $actualSelection")
                    if (actualSelection != displayModeIndex) {
                        Log.w(TAG, "æ˜¾ç¤ºæ¨¡å¼Spinneré€‰æ‹©å¤±è´¥ï¼Œå°è¯•å¼ºåˆ¶è®¾ç½®")
                        displayModeSpinner.setSelection(displayModeIndex, true)
                    }
                }
            } else {
                // æ•°æ®è¢«æ—§ç‰ˆæœ¬å†™åæˆ–ç¼ºå¤±æ—¶ï¼Œå›é€€åˆ°ç¬¬ä¸€ä¸ªé€‰é¡¹å¹¶å†™å›
                displayModeSpinner.setSelection(0, false)
                if (displayModeValues.isNotEmpty()) {
                    settingsManager.setDisplayMode(displayModeValues[0])
                }
                Log.d(TAG, "æ˜¾ç¤ºæ¨¡å¼ç´¢å¼•æ— æ•ˆï¼Œå›é€€åˆ°ç¬¬ä¸€ä¸ªé€‰é¡¹")
            }

            // åŠ è½½ä¸»é¢˜è®¾ç½®
            val themeMode = settingsManager.getThemeMode()
            val themeEntries = resources.getStringArray(R.array.theme_mode_entries)
            Log.d(TAG, "å½“å‰ä¸»é¢˜æ¨¡å¼: $themeMode")
            Log.d(TAG, "ä¸»é¢˜æ¨¡å¼æ¡ç›®æ•°ç»„: ${themeEntries.joinToString(", ")}")

            // ä¿®å¤ä¸»é¢˜æ¨¡å¼åŠ è½½æ˜ å°„ï¼š
            // å¸¸é‡å€¼ â†’ æ•°ç»„ç´¢å¼•ï¼š
            // THEME_MODE_SYSTEM(-1) â†’ 0 (è·Ÿéšç³»ç»Ÿ)
            // THEME_MODE_LIGHT(0) â†’ 1 (æµ…è‰²æ¨¡å¼)
            // THEME_MODE_DARK(1) â†’ 2 (æ·±è‰²æ¨¡å¼)
            val themeIndex = when(themeMode) {
                SettingsManager.THEME_MODE_SYSTEM -> 0  // è·Ÿéšç³»ç»Ÿ
                SettingsManager.THEME_MODE_LIGHT -> 1   // æµ…è‰²æ¨¡å¼
                SettingsManager.THEME_MODE_DARK -> 2    // æ·±è‰²æ¨¡å¼
                else -> 0 // é»˜è®¤è·Ÿéšç³»ç»Ÿ
            }

            Log.d(TAG, "è®¾ç½®ä¸»é¢˜æ¨¡å¼Spinneré€‰æ‹©: $themeIndex (${themeEntries.getOrNull(themeIndex)})")
            themeModeSpinner.setSelection(themeIndex, false)

            // éªŒè¯è®¾ç½®æ˜¯å¦æˆåŠŸï¼Œå¦‚æœå¤±è´¥åˆ™å¼ºåˆ¶åˆ·æ–°
            themeModeSpinner.post {
                val actualSelection = themeModeSpinner.selectedItemPosition
                Log.d(TAG, "ä¸»é¢˜æ¨¡å¼Spinnerå®é™…é€‰æ‹©: $actualSelection")
                if (actualSelection != themeIndex) {
                    Log.w(TAG, "ä¸»é¢˜æ¨¡å¼Spinneré€‰æ‹©å¤±è´¥ï¼Œå°è¯•å¼ºåˆ¶è®¾ç½®")
                    themeModeSpinner.setSelection(themeIndex, true)
                }
            }

            // åŠ è½½å¼€å…³çŠ¶æ€
            clipboardMonitorSwitch.isChecked = settingsManager.isClipboardListenerEnabled()
            autoHideSwitch.isChecked = settingsManager.getAutoHide()
            aiModeSwitch.isChecked = settingsManager.getIsAIMode()
            leftHandedSwitch.isChecked = settingsManager.isLeftHandedModeEnabled()
            autoPasteSwitch.isChecked = settingsManager.isAutoPasteEnabled()
            multiTabBrowserSwitch.isChecked = settingsManager.getBoolean("use_multi_tab_browser", false)
            notificationListenerSwitch.isChecked = settingsManager.getBoolean("enable_notification_listener", false)
            voskOfflineVoiceSwitch.isChecked = settingsManager.getBoolean("use_vosk_offline_voice", false)

            // åŠ è½½é€æ˜åº¦è®¾ç½® - getBallAlpha()è¿”å›0-255ï¼Œéœ€è¦è½¬æ¢ä¸º0-100
            ballAlphaSeekbar.progress = ((settingsManager.getBallAlpha() / 255.0) * 100).toInt()



            // åŠ è½½çª—å£æ•°é‡è®¾ç½®
            val windowCount = settingsManager.getDefaultWindowCount().coerceIn(1, resources.getStringArray(R.array.window_count_entries).size)
            windowCountSpinner.setSelection(windowCount - 1) // è½¬æ¢ä¸º0-basedç´¢å¼•

            // ç«‹å³åº”ç”¨å·¦æ‰‹æ¨¡å¼
            val isLeftHanded = settingsManager.isLeftHandedModeEnabled()
            updateLayoutForHandedness(isLeftHanded)
            applyLayoutDirection(isLeftHanded)
        } catch (e: Exception) {
            Log.e(TAG, "Error loading settings", e)
            Toast.makeText(this, "åŠ è½½è®¾ç½®æ—¶å‡ºé”™", Toast.LENGTH_SHORT).show()
        }
    }

    private fun showVoice() {
        currentState = UIState.VOICE
        chatLayout.visibility = View.GONE
        aiAssistantCenterLayout.visibility = View.GONE
        taskSelectionLayout.visibility = View.GONE
        stepGuidanceLayout.visibility = View.GONE
        promptPreviewLayout.visibility = View.GONE
        voiceLayout.visibility = View.VISIBLE
        appSearchLayout.visibility = View.GONE
        browserLayout.visibility = View.GONE
        settingsLayout.visibility = View.GONE

        // ç¡®ä¿è¯­éŸ³è¾“å…¥ç®¡ç†å™¨å·²åˆå§‹åŒ–
        if (!::voiceInputManager.isInitialized) {
            voiceInputManager = VoiceInputManager(this)
            Log.d(TAG, "é‡æ–°åˆå§‹åŒ–VoiceInputManager")
        }

        // ä¼˜å…ˆæ£€æŸ¥Voskæ¨¡å‹æ˜¯å¦å·²ä¸‹è½½ï¼ˆæ— è®ºæ˜¯å¦å¯ç”¨è®¾ç½®ï¼Œåªè¦å·²ä¸‹è½½å°±å…è®¸ä½¿ç”¨ï¼‰
        val voskManager = VoskManager(this)
        val downloadedTypes = voskManager.getDownloadedModelTypes()
        
        if (downloadedTypes.isNotEmpty()) {
            // Voskæ¨¡å‹å·²ä¸‹è½½ï¼Œç›´æ¥ä½¿ç”¨Voskï¼Œä¸æ˜¾ç¤ºå¼¹çª—
            Log.d(TAG, "æ£€æµ‹åˆ°Voskæ¨¡å‹å·²ä¸‹è½½ï¼ˆå·²ä¸‹è½½ç±»å‹: ${downloadedTypes.joinToString()}ï¼‰ï¼Œä½¿ç”¨Voskç¦»çº¿è¯­éŸ³è¯†åˆ«ï¼Œä¸æ˜¾ç¤ºä¸‹è½½æç¤º")
            // åç»­ä¼šåœ¨startAutoRecording()ä¸­è‡ªåŠ¨å¯åŠ¨Voskè¯†åˆ«
        } else {
            // Voskæ¨¡å‹æœªä¸‹è½½ï¼Œæ£€æŸ¥ç³»ç»Ÿè¯­éŸ³è¯†åˆ«æ”¯æŒæƒ…å†µ
            val hasSystemSpeechRecognizer = android.speech.SpeechRecognizer.isRecognitionAvailable(this)
            
            if (!hasSystemSpeechRecognizer) {
                // å¦‚æœè®¾å¤‡ä¸æ”¯æŒç³»ç»Ÿè¯­éŸ³è¯†åˆ«ä¸”Voskæ¨¡å‹æœªä¸‹è½½ï¼Œæ˜¾ç¤ºä¸‹è½½æç¤º
                Log.d(TAG, "è®¾å¤‡ä¸æ”¯æŒç³»ç»Ÿè¯­éŸ³è¯†åˆ«ä¸”Voskæ¨¡å‹æœªä¸‹è½½ï¼Œæ˜¾ç¤ºä¸‹è½½æç¤º")
                showVoskModelDownloadPrompt()
                // ä¸ç»§ç»­æ‰§è¡Œåç»­é€»è¾‘ï¼Œç­‰å¾…ç”¨æˆ·ä¸‹è½½æ¨¡å‹
                updateTabColors()
                return
            } else {
                Log.d(TAG, "ç³»ç»Ÿè¯­éŸ³è¯†åˆ«å¯ç”¨ï¼Œä½¿ç”¨ç³»ç»Ÿè¯­éŸ³è¯†åˆ«")
            }
        }

        // é»˜è®¤æ˜¾ç¤ºä¸‰æ®µå¼èƒ¶å›Šå¸ƒå±€
        showVoiceCapsuleLayout()
        
        // æ˜¾ç¤ºAIåº”ç”¨å›¾æ ‡ï¼ˆä½¿ç”¨ç©ºæŸ¥è¯¢ï¼Œæ˜¾ç¤ºæ‰€æœ‰å¸¸ç”¨AIï¼‰
        showVoiceCapsuleAIApps("")
        
        // æ›´æ–°æ¨¡å‹çŠ¶æ€æ˜¾ç¤º
        updateVoiceModelStatus()

        // æ£€æŸ¥å½•éŸ³æƒé™
        if (ContextCompat.checkSelfPermission(this, Manifest.permission.RECORD_AUDIO)
            != PackageManager.PERMISSION_GRANTED) {
            ActivityCompat.requestPermissions(this,
                arrayOf(Manifest.permission.RECORD_AUDIO), 1001)
        } else {
            // å¦‚æœæœ‰æƒé™ï¼Œç¡®ä¿è‡ªåŠ¨å¼€å§‹å½•éŸ³
            if (isVoiceCapsuleMode) {
                startAutoRecording()
            }
        }

        updateTabColors()
    }

    /**
     * æ˜¾ç¤ºVoskæ¨¡å‹ä¸‹è½½æç¤ºå¯¹è¯æ¡†
     * å½“è®¾å¤‡ä¸æ”¯æŒç³»ç»Ÿè¯­éŸ³è¯†åˆ«ä¸”Voskæ¨¡å‹æœªä¸‹è½½æ—¶è°ƒç”¨
     */
    private fun showVoskModelDownloadPrompt() {
        val voskManager = VoskManager(this)
        val smallModelSize = voskManager.getModelSize(VoskManager.ModelType.SMALL)
        val fullModelSize = voskManager.getModelSize(VoskManager.ModelType.FULL)
        
        createThemedDialogBuilder()
            .setTitle("ä¸‹è½½è¯­éŸ³è¯†åˆ«æ¨¡å‹")
            .setMessage("æ‚¨çš„è®¾å¤‡ä¸æ”¯æŒç³»ç»Ÿè¯­éŸ³è½¬æ–‡æœ¬åŠŸèƒ½ã€‚\n\n" +
                    "æ‚¨å¯ä»¥ä¸‹è½½Voskç¦»çº¿è¯­éŸ³è¯†åˆ«æ¨¡å‹æ¥å®ç°è¯­éŸ³åŠŸèƒ½ï¼š\n\n" +
                    "â€¢ Voskå°æ¨¡å‹ï¼šçº¦${smallModelSize}MBï¼Œè¯†åˆ«ç²¾åº¦ä¸­ç­‰\n" +
                    "â€¢ Voskå®Œæ•´æ¨¡å‹ï¼šçº¦${fullModelSize}MBï¼Œè¯†åˆ«ç²¾åº¦æ›´é«˜\n\n" +
                    "å»ºè®®å…ˆä¸‹è½½å°æ¨¡å‹ä½“éªŒã€‚")
            .setPositiveButton("ä¸‹è½½å°æ¨¡å‹") { _, _ ->
                Log.d(TAG, "ç”¨æˆ·é€‰æ‹©ä¸‹è½½Voskå°æ¨¡å‹")
                startVoskModelDownloadWithBottomSheet(VoskManager.ModelType.SMALL)
            }
            .setNeutralButton("ä¸‹è½½å®Œæ•´æ¨¡å‹") { _, _ ->
                Log.d(TAG, "ç”¨æˆ·é€‰æ‹©ä¸‹è½½Voskå®Œæ•´æ¨¡å‹")
                startVoskModelDownloadWithBottomSheet(VoskManager.ModelType.FULL)
            }
            .setNegativeButton("ç¨åå†è¯´") { _, _ ->
                Log.d(TAG, "ç”¨æˆ·é€‰æ‹©ç¨åä¸‹è½½æ¨¡å‹ï¼Œç»§ç»­ä½¿ç”¨æ–‡æœ¬è¾“å…¥")
                // å…è®¸ç”¨æˆ·ç»§ç»­ä½¿ç”¨æ–‡æœ¬è¾“å…¥åŠŸèƒ½
                voiceStatusText?.text = "è¯·åœ¨ä¸‹æ–¹è¾“å…¥æ–‡æœ¬ï¼Œç„¶åç‚¹å‡»æœç´¢"
                voiceTextInput?.requestFocus()
                val imm = getSystemService(Context.INPUT_METHOD_SERVICE) as InputMethodManager
                imm.showSoftInput(voiceTextInput, InputMethodManager.SHOW_IMPLICIT)
            }
            .setCancelable(true)
            .setOnCancelListener {
                Log.d(TAG, "ç”¨æˆ·å–æ¶ˆä¸‹è½½æç¤ºå¯¹è¯æ¡†")
                // å…è®¸ç”¨æˆ·ç»§ç»­ä½¿ç”¨æ–‡æœ¬è¾“å…¥åŠŸèƒ½
                voiceStatusText?.text = "è¯·åœ¨ä¸‹æ–¹è¾“å…¥æ–‡æœ¬ï¼Œç„¶åç‚¹å‡»æœç´¢"
                voiceTextInput?.requestFocus()
                val imm = getSystemService(Context.INPUT_METHOD_SERVICE) as InputMethodManager
                imm.showSoftInput(voiceTextInput, InputMethodManager.SHOW_IMPLICIT)
            }
            .show()
    }

    private fun showAppSearch() {
        currentState = UIState.APP_SEARCH
        chatLayout.visibility = View.GONE
        aiAssistantCenterLayout.visibility = View.GONE
        taskSelectionLayout.visibility = View.GONE
        stepGuidanceLayout.visibility = View.GONE
        promptPreviewLayout.visibility = View.GONE
        voiceLayout.visibility = View.GONE
        appSearchLayout.visibility = View.VISIBLE
        browserLayout.visibility = View.GONE
        settingsLayout.visibility = View.GONE

        // åˆå§‹åŒ–åº”ç”¨æœç´¢é¡µé¢
        setupAppSearchPage()

        updateTabColors()
        
        // æ£€æŸ¥å¹¶å¯åŠ¨ç½‘é€Ÿæ‚¬æµ®çª—æœåŠ¡ï¼ˆç¡®ä¿åœ¨æœç´¢tabä¸­å¸¸é©»æ˜¾ç¤ºï¼‰
        checkAndStartNetworkSpeedService()
        
        // æ£€æµ‹å¹¶å¤„ç†intentä¸­çš„æœç´¢å…³é”®è¯
        handleAppSearchIntentQuery()
    }

    /**
     * è®¾ç½®åº”ç”¨æœç´¢é¡µé¢
     * ä¼˜åŒ–ï¼šå…ˆæ˜¾ç¤ºUIæ¡†æ¶ï¼Œåå°å¼‚æ­¥åŠ è½½åº”ç”¨åˆ—è¡¨
     */
    private fun setupAppSearchPage() {
        Log.d(TAG, "setupAppSearchPageè¢«è°ƒç”¨")
        Log.d(TAG, "appSearchAdapteræ˜¯å¦å·²åˆå§‹åŒ–: ${::appSearchAdapter.isInitialized}")
        
        // æ£€æŸ¥å“ªäº›åº”ç”¨æ”¯æŒIntentæœç´¢ï¼ˆè¾“å‡ºåˆ°æ—¥å¿—ï¼‰
        lifecycleScope.launch(Dispatchers.IO) {
            com.example.aifloatingball.utils.IntentSearchChecker.checkAllApps(this@SimpleModeActivity)
        }
        
        // åˆå§‹åŒ–åº”ç”¨æœç´¢é€‚é…å™¨
        if (!::appSearchAdapter.isInitialized) {
            Log.d(TAG, "å¼€å§‹åˆå§‹åŒ–appSearchAdapter")
            
            // å…ˆå°è¯•ä½¿ç”¨ç¼“å­˜çš„åº”ç”¨åˆ—è¡¨ï¼Œç«‹å³æ˜¾ç¤ºUI
            val cachedApps = com.example.aifloatingball.manager.InstalledAppsRepository.getInstance(this).getCached()
            if (cachedApps != null && cachedApps.isNotEmpty()) {
                Log.d(TAG, "ä½¿ç”¨ç¼“å­˜çš„åº”ç”¨åˆ—è¡¨ï¼Œå…± ${cachedApps.size} ä¸ªåº”ç”¨")
                currentAppConfigs.clear()
                currentAppConfigs.addAll(cachedApps)
            }
            
            appSearchAdapter = AppSearchGridAdapter(this, currentAppConfigs,
                onAppClick = { appConfig, query ->
                    handleAppSearch(appConfig, query)
                },
                onAppSelected = { appConfig ->
                    updateSelectedAppDisplay(appConfig)
                },
                getCurrentQuery = {
                    appSearchInput.text.toString()
                }
            )

            // è®¾ç½®ç½‘æ ¼å¸ƒå±€ - é‡‡ç”¨launcheré£æ ¼çš„4åˆ—å¸ƒå±€
            val gridLayoutManager = GridLayoutManager(this, 4) // 4åˆ—ç½‘æ ¼ï¼Œç±»ä¼¼æ ‡å‡†launcher
            appSearchGrid.layoutManager = gridLayoutManager
            appSearchGrid.adapter = appSearchAdapter

            // è®¾ç½®åˆ†ç±»ç‚¹å‡»äº‹ä»¶
            setupCategoryClickListeners()

            // è®¾ç½®æœç´¢è¾“å…¥æ¡†
            setupAppSearchInput()

            // è®¾ç½®æ’åºå›¾æ ‡æŒ‰é’®
            setupSortIconButtons()

            // å¦‚æœæœ‰ç¼“å­˜æ•°æ®ï¼Œå…ˆæ˜¾ç¤ºç¼“å­˜ï¼Œç„¶ååå°åˆ·æ–°
            if (cachedApps != null && cachedApps.isNotEmpty()) {
                appSearchAdapter.updateAppConfigs(currentAppConfigs)
                resetSearchInputIcon()
                updateSortIconButtonsState()
                // éšè—åŠ è½½æç¤ºï¼ˆå¦‚æœæœ‰ï¼‰
                findViewById<android.view.View>(R.id.app_search_loading_overlay)?.visibility = android.view.View.GONE
                
                // åå°å¼‚æ­¥åˆ·æ–°åº”ç”¨åˆ—è¡¨ï¼ˆå¦‚æœç¼“å­˜å¯èƒ½è¿‡æœŸï¼‰
                handler.postDelayed({
                    loadAppsByCategory(AppCategory.ALL)
                }, 100) // å»¶è¿Ÿ100msï¼Œç¡®ä¿UIå…ˆæ˜¾ç¤º
            } else {
                // æ²¡æœ‰ç¼“å­˜ï¼Œå¼‚æ­¥åŠ è½½åº”ç”¨åˆ—è¡¨
                loadAppsByCategory(AppCategory.ALL)
            }
        } else {
            // é€‚é…å™¨å·²åˆå§‹åŒ–ï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦åˆ·æ–°æ•°æ®
            if (currentAppConfigs.isEmpty()) {
                // å°è¯•ä½¿ç”¨ç¼“å­˜
                val cachedApps = com.example.aifloatingball.manager.InstalledAppsRepository.getInstance(this).getCached()
                if (cachedApps != null && cachedApps.isNotEmpty()) {
                    currentAppConfigs.clear()
                    currentAppConfigs.addAll(cachedApps)
                    appSearchAdapter.updateAppConfigs(currentAppConfigs)
                    resetSearchInputIcon()
                    updateSortIconButtonsState()
                    findViewById<android.view.View>(R.id.app_search_loading_overlay)?.visibility = android.view.View.GONE
                } else {
                    // æ²¡æœ‰ç¼“å­˜ï¼Œå¼‚æ­¥åŠ è½½
                    loadAppsByCategory(AppCategory.ALL)
                }
            }
        }
    }

    /**
     * è®¾ç½®æ’åºå›¾æ ‡æŒ‰é’®
     */
    private fun setupSortIconButtons() {
        val sortAlphabetical = findViewById<LinearLayout>(R.id.sort_alphabetical)
        val sortUsageCount = findViewById<LinearLayout>(R.id.sort_usage_count)
        val sortRecentPosition = findViewById<LinearLayout>(R.id.sort_recent_position)

        sortAlphabetical?.setOnClickListener {
            selectSortType(com.example.aifloatingball.manager.AppSortType.ALPHABETICAL)
        }

        sortUsageCount?.setOnClickListener {
            selectSortType(com.example.aifloatingball.manager.AppSortType.USAGE_COUNT)
        }

        sortRecentPosition?.setOnClickListener {
            selectSortType(com.example.aifloatingball.manager.AppSortType.RECENT_POSITION)
        }

        // åˆå§‹åŒ–é€‰ä¸­çŠ¶æ€
        updateSortIconButtonsState()
    }

    /**
     * é€‰æ‹©æ’åºç±»å‹
     */
    private fun selectSortType(sortType: com.example.aifloatingball.manager.AppSortType) {
        appSortManager.setSortType(currentAppCategory, sortType)
        updateSortIconButtonsState()
        // å®æ—¶æ’åºå½“å‰å·²åŠ è½½çš„åº”ç”¨åˆ—è¡¨
        applySortToCurrentList()
    }

    /**
     * æ›´æ–°æ’åºå›¾æ ‡æŒ‰é’®çš„é€‰ä¸­çŠ¶æ€
     */
    private fun updateSortIconButtonsState() {
        val currentSortType = appSortManager.getSortType(currentAppCategory)
        
        val sortAlphabeticalIcon = findViewById<ImageView>(R.id.sort_alphabetical_icon)
        val sortUsageCountIcon = findViewById<ImageView>(R.id.sort_usage_count_icon)
        val sortRecentPositionIcon = findViewById<ImageView>(R.id.sort_recent_position_icon)
        
        val sortAlphabeticalLayout = findViewById<LinearLayout>(R.id.sort_alphabetical)
        val sortUsageCountLayout = findViewById<LinearLayout>(R.id.sort_usage_count)
        val sortRecentPositionLayout = findViewById<LinearLayout>(R.id.sort_recent_position)

        // é‡ç½®æ‰€æœ‰æŒ‰é’®çŠ¶æ€
        val unselectedColor = ContextCompat.getColor(this, R.color.simple_mode_text_secondary_light)
        val selectedColor = ContextCompat.getColor(this, R.color.simple_mode_accent_light)
        
        sortAlphabeticalIcon?.setColorFilter(unselectedColor)
        sortUsageCountIcon?.setColorFilter(unselectedColor)
        sortRecentPositionIcon?.setColorFilter(unselectedColor)
        
        sortAlphabeticalLayout?.alpha = 0.6f
        sortUsageCountLayout?.alpha = 0.6f
        sortRecentPositionLayout?.alpha = 0.6f

        // è®¾ç½®é€‰ä¸­çŠ¶æ€
        when (currentSortType) {
            com.example.aifloatingball.manager.AppSortType.ALPHABETICAL -> {
                sortAlphabeticalIcon?.setColorFilter(selectedColor)
                sortAlphabeticalLayout?.alpha = 1.0f
            }
            com.example.aifloatingball.manager.AppSortType.USAGE_COUNT -> {
                sortUsageCountIcon?.setColorFilter(selectedColor)
                sortUsageCountLayout?.alpha = 1.0f
            }
            com.example.aifloatingball.manager.AppSortType.RECENT_POSITION -> {
                sortRecentPositionIcon?.setColorFilter(selectedColor)
                sortRecentPositionLayout?.alpha = 1.0f
            }
        }
    }

    /**
     * å¯¹å½“å‰å·²åŠ è½½çš„åº”ç”¨åˆ—è¡¨åº”ç”¨æ’åº
     */
    private fun applySortToCurrentList() {
        if (currentAppConfigs.isEmpty()) {
            return
        }
        
        try {
            // åˆ›å»ºå½“å‰åˆ—è¡¨çš„å‰¯æœ¬è¿›è¡Œæ’åº
            val sortedList = appSortManager.sortApps(currentAppConfigs.toList(), currentAppCategory)
            
            // æ›´æ–°åˆ—è¡¨
            currentAppConfigs.clear()
            currentAppConfigs.addAll(sortedList)
            
            // æ›´æ–°é€‚é…å™¨ï¼Œè§¦å‘UIåˆ·æ–°
            appSearchAdapter.updateAppConfigs(currentAppConfigs)
            
            Log.d(TAG, "å·²åº”ç”¨æ’åº: ${appSortManager.getSortType(currentAppCategory).displayName}, å…± ${sortedList.size} ä¸ªåº”ç”¨")
        } catch (e: Exception) {
            Log.e(TAG, "åº”ç”¨æ’åºå¤±è´¥", e)
            Toast.makeText(this, "æ’åºå¤±è´¥: ${e.message}", Toast.LENGTH_SHORT).show()
        }
    }

    /**
     * è®¾ç½®åˆ†ç±»ç‚¹å‡»äº‹ä»¶
     */
    private fun setupCategoryClickListeners() {
        // è·å–æ‰€æœ‰åˆ†ç±»æŒ‰é’®
        val categoryButtons = mapOf(
            AppCategory.CUSTOM to findViewById<LinearLayout>(R.id.category_custom),
            AppCategory.ALL to findViewById<LinearLayout>(R.id.category_all),
            AppCategory.AI to findViewById<LinearLayout>(R.id.category_ai),
            AppCategory.SHOPPING to findViewById<LinearLayout>(R.id.category_shopping),
            AppCategory.SOCIAL to findViewById<LinearLayout>(R.id.category_social),
            AppCategory.VIDEO to findViewById<LinearLayout>(R.id.category_video),
            AppCategory.MUSIC to findViewById<LinearLayout>(R.id.category_music),
            AppCategory.LIFESTYLE to findViewById<LinearLayout>(R.id.category_lifestyle),
            AppCategory.MAPS to findViewById<LinearLayout>(R.id.category_maps),
            AppCategory.BROWSER to findViewById<LinearLayout>(R.id.category_browser),
            AppCategory.FINANCE to findViewById<LinearLayout>(R.id.category_finance),
            AppCategory.TRAVEL to findViewById<LinearLayout>(R.id.category_travel),
            AppCategory.JOBS to findViewById<LinearLayout>(R.id.category_jobs),
            AppCategory.EDUCATION to findViewById<LinearLayout>(R.id.category_education),
            AppCategory.NEWS to findViewById<LinearLayout>(R.id.category_news)
        )

        // è°ƒè¯•ï¼šæ£€æŸ¥AIåˆ†ç±»æŒ‰é’®æ˜¯å¦æ‰¾åˆ°
        val aiButton = categoryButtons[AppCategory.AI]
        Log.d(TAG, "AIåˆ†ç±»æŒ‰é’®æ˜¯å¦æ‰¾åˆ°: ${aiButton != null}")
        if (aiButton != null) {
            Log.d(TAG, "AIåˆ†ç±»æŒ‰é’®ID: ${aiButton.id}")
            Log.d(TAG, "AIåˆ†ç±»æŒ‰é’®å¯è§æ€§: ${aiButton.visibility}")
        }

        // è®¾ç½®åˆ†ç±»æŒ‰é’®çš„å›¾æ ‡å’Œæ–‡å­—
        setupCategoryButtonContent(categoryButtons)

        // æ ¹æ®ä¿å­˜çš„æ’åºé‡æ–°æ’åˆ—æŒ‰é’®
        val categoryOrder = categoryDragHelper.getCategoryOrder()
        categoryDragHelper.reorderCategoryButtons(appCategorySidebar, categoryButtons, categoryOrder)

        // è®¾ç½®ç‚¹å‡»äº‹ä»¶
        categoryButtons.forEach { (category, button) ->
            button?.setOnClickListener {
                selectAppCategory(category, categoryButtons)
            }
        }

        // è®¾ç½®æ‹–æ‹½åŠŸèƒ½
        categoryDragHelper.setupDragListeners(appCategorySidebar, categoryButtons) { newOrder ->
            // æ‹–æ‹½æ’åºæ”¹å˜åçš„å›è°ƒ
            Toast.makeText(this, "åˆ†ç±»æ’åºå·²æ›´æ–°", Toast.LENGTH_SHORT).show()
        }

        // é»˜è®¤é€‰ä¸­"å…¨éƒ¨"åˆ†ç±»
        selectAppCategory(AppCategory.ALL, categoryButtons)
    }

    /**
     * è®¾ç½®åˆ†ç±»æŒ‰é’®çš„å›¾æ ‡å’Œæ–‡å­—å†…å®¹
     */
    private fun setupCategoryButtonContent(categoryButtons: Map<AppCategory, LinearLayout?>) {
        val categoryData = mapOf(
            AppCategory.CUSTOM to Pair(R.drawable.ic_star, "è‡ªå®šä¹‰"),
            AppCategory.ALL to Pair(R.drawable.ic_apps, "å…¨éƒ¨"),
            AppCategory.AI to Pair(R.drawable.ic_ai, "AI"),
            AppCategory.SHOPPING to Pair(R.drawable.ic_shopping, "è´­ç‰©"),
            AppCategory.SOCIAL to Pair(R.drawable.ic_people, "ç¤¾äº¤"),
            AppCategory.VIDEO to Pair(R.drawable.ic_video, "è§†é¢‘"),
            AppCategory.MUSIC to Pair(R.drawable.ic_music, "éŸ³ä¹"),
            AppCategory.LIFESTYLE to Pair(R.drawable.ic_home, "ç”Ÿæ´»"),
            AppCategory.MAPS to Pair(R.drawable.ic_map, "åœ°å›¾"),
            AppCategory.BROWSER to Pair(R.drawable.ic_web, "æµè§ˆå™¨"),
            AppCategory.FINANCE to Pair(R.drawable.ic_payment, "é‡‘è"),
            AppCategory.TRAVEL to Pair(R.drawable.ic_directions_car, "å‡ºè¡Œ"),
            AppCategory.JOBS to Pair(R.drawable.ic_work, "æ‹›è˜"),
            AppCategory.EDUCATION to Pair(R.drawable.ic_school, "æ•™è‚²"),
            AppCategory.NEWS to Pair(R.drawable.ic_article, "æ–°é—»")
        )

        categoryButtons.forEach { (category, button) ->
            button?.let { layout ->
                val data = categoryData[category]
                if (data != null) {
                    val iconView = layout.findViewById<ImageView>(R.id.category_icon)
                    val textView = layout.findViewById<TextView>(R.id.category_text)

                    iconView?.setImageResource(data.first)
                    textView?.text = data.second
                }
            }
        }
    }

    /**
     * é€‰æ‹©åº”ç”¨åˆ†ç±»
     */
    private fun selectAppCategory(category: AppCategory, categoryButtons: Map<AppCategory, LinearLayout?>) {
        currentAppCategory = category

        // æ›´æ–°åˆ†ç±»æŒ‰é’®çš„é€‰ä¸­çŠ¶æ€
        categoryButtons.forEach { (cat, button) ->
            button?.let { layout ->
                if (cat == category) {
                    // é€‰ä¸­çŠ¶æ€ï¼šä½¿ç”¨Material Designé€‰ä¸­æ ·å¼
                    layout.setBackgroundResource(R.drawable.material_category_button_selected)

                    // æ›´æ–°å›¾æ ‡å’Œæ–‡å­—é¢œè‰²ä¸ºé€‰ä¸­çŠ¶æ€
                    val iconView = layout.findViewById<ImageView>(R.id.category_icon)
                    val textView = layout.findViewById<TextView>(R.id.category_text)

                    iconView?.setColorFilter(ContextCompat.getColor(this, R.color.simple_mode_accent_light))
                    textView?.setTextColor(ContextCompat.getColor(this, R.color.simple_mode_accent_light))
                } else {
                    // æœªé€‰ä¸­çŠ¶æ€ï¼šé€æ˜èƒŒæ™¯
                    layout.setBackgroundResource(R.drawable.material_category_button_background)

                    // æ›´æ–°å›¾æ ‡å’Œæ–‡å­—é¢œè‰²ä¸ºæœªé€‰ä¸­çŠ¶æ€
                    val iconView = layout.findViewById<ImageView>(R.id.category_icon)
                    val textView = layout.findViewById<TextView>(R.id.category_text)

                    iconView?.setColorFilter(ContextCompat.getColor(this, R.color.simple_mode_accent_light))
                    textView?.setTextColor(ContextCompat.getColor(this, R.color.simple_mode_text_primary_light))
                }
            }
        }

        // åŠ è½½å¯¹åº”åˆ†ç±»çš„åº”ç”¨
        loadAppsByCategory(category)
        // æ›´æ–°æ’åºå›¾æ ‡æŒ‰é’®çŠ¶æ€
        updateSortIconButtonsState()
    }

    /**
     * æ ¹æ®åˆ†ç±»åŠ è½½åº”ç”¨
     */
    private fun loadAppsByCategory(category: AppCategory) {
        // ä¼˜å…ˆï¼šè®¾å¤‡å·²å®‰è£…åº”ç”¨æ‰«æï¼ˆæ»¡è¶³"å…¨éƒ¨æ ‡ç­¾ä¸­åŠ è½½æ‰€æœ‰å·²å®‰è£…appå›¾æ ‡ã€è‡ªåŠ¨åˆ†ç±»ä¸è¿‡æ»¤"ï¼‰
        try {
            val loadingOverlay = findViewById<android.view.View>(R.id.app_search_loading_overlay)
            // åªåœ¨æ²¡æœ‰ç¼“å­˜æ•°æ®æ—¶æ‰æ˜¾ç¤ºåŠ è½½æç¤º
            if (currentAppConfigs.isEmpty()) {
                loadingOverlay?.visibility = android.view.View.VISIBLE
            }

            kotlinx.coroutines.CoroutineScope(kotlinx.coroutines.Dispatchers.IO).launch {
                val startTime = System.currentTimeMillis()
                val repo = com.example.aifloatingball.manager.InstalledAppsRepository.getInstance(this@SimpleModeActivity)
                
                // å…ˆå°è¯•ä½¿ç”¨ç¼“å­˜
                var allApps = repo.getCached()
                if (allApps == null || allApps.isEmpty()) {
                    // ç¼“å­˜ä¸å­˜åœ¨æˆ–ä¸ºç©ºï¼Œæ‰«æåº”ç”¨
                    Log.d(TAG, "ç¼“å­˜ä¸å­˜åœ¨ï¼Œå¼€å§‹æ‰«æå·²å®‰è£…åº”ç”¨")
                    allApps = repo.scanInstalledSearchableApps()
                    val scanTime = System.currentTimeMillis() - startTime
                    Log.d(TAG, "åº”ç”¨æ‰«æå®Œæˆï¼Œè€—æ—¶: ${scanTime}msï¼Œå…± ${allApps.size} ä¸ªåº”ç”¨")
                } else {
                    val cacheTime = System.currentTimeMillis() - startTime
                    Log.d(TAG, "ä½¿ç”¨ç¼“å­˜çš„åº”ç”¨åˆ—è¡¨ï¼Œè€—æ—¶: ${cacheTime}msï¼Œå…± ${allApps.size} ä¸ªåº”ç”¨")
                }
                
                val list = if (category == AppCategory.ALL) {
                    allApps
                } else if (category == AppCategory.CUSTOM) {
                    // è‡ªå®šä¹‰åˆ†ç±»ä»æ²¿ç”¨åŸæœ‰é…ç½®
                    appSearchSettings.getAppConfigsByCategory(category)
                } else {
                    allApps.filter { it.category == category }
                }

                withContext(kotlinx.coroutines.Dispatchers.Main) {
                    val updateStartTime = System.currentTimeMillis()
                    currentAppConfigs.clear()
                    // åº”ç”¨æ’åº
                    val sortedList = appSortManager.sortApps(list, category)
                    currentAppConfigs.addAll(sortedList)
                    appSearchAdapter.updateAppConfigs(currentAppConfigs)
                    resetSearchInputIcon()
                    updateSortIconButtonsState()
                    loadingOverlay?.visibility = android.view.View.GONE
                    val updateTime = System.currentTimeMillis() - updateStartTime
                    Log.d(TAG, "åº”ç”¨åˆ—è¡¨æ›´æ–°å®Œæˆï¼Œè€—æ—¶: ${updateTime}msï¼Œå…± ${currentAppConfigs.size} ä¸ªåº”ç”¨")
                }
            }
        } catch (e: Exception) {
            android.util.Log.e(TAG, "åŠ è½½å·²å®‰è£…åº”ç”¨å¤±è´¥ï¼Œå›é€€åˆ°å†…ç½®é…ç½®", e)
            currentAppConfigs.clear()
            val fallbackList = appSearchSettings.getAppConfigsByCategory(category)
            // åº”ç”¨æ’åº
            val sortedList = appSortManager.sortApps(fallbackList, category)
            currentAppConfigs.addAll(sortedList)
            appSearchAdapter.updateAppConfigs(currentAppConfigs)
            resetSearchInputIcon()
            updateSortIconButtonsState()
            findViewById<android.view.View>(R.id.app_search_loading_overlay)?.visibility = android.view.View.GONE
        }
    }

    /**
     * è®¾ç½®åº”ç”¨æœç´¢è¾“å…¥æ¡†
     */
    private fun setupAppSearchInput() {
        // å…¼å®¹æ—§å¸ƒå±€ï¼ˆå¦‚æœæœ‰TextInputLayoutï¼‰
        val textInputLayout = try {
            findViewById<com.google.android.material.textfield.TextInputLayout>(R.id.app_search_input_layout)
        } catch (e: Exception) {
            null
        }
        // æ–°å¸ƒå±€ä½¿ç”¨å•ç‹¬çš„ history button
        val historyButton = findViewById<ImageButton>(R.id.app_search_history_button)

        // è®¾ç½®æœç´¢åŠ¨ä½œç›‘å¬
        appSearchInput.setOnEditorActionListener { _, actionId, _ ->
            if (actionId == EditorInfo.IME_ACTION_SEARCH) {
                val query = appSearchInput.text.toString().trim()
                if (query.isNotEmpty()) {
                    // æ£€æŸ¥æ˜¯å¦æœ‰é€‰ä¸­çš„appï¼ˆæˆ–æ²¿ç”¨ä¸Šä¸€ä¸ªappï¼‰
                    val appToUse = getAppForSearch()
                    if (appToUse != null) {
                        // æœ‰é€‰ä¸­çš„appï¼Œç›´æ¥æ‰§è¡Œæœç´¢è·³è½¬
                        Log.d(TAG, "æ‰§è¡Œæœç´¢è·³è½¬: app=${appToUse.appName}, query=$query")
                        handleAppSearch(appToUse, query)
                        // æ›´æ–°æœç´¢é€‚é…å™¨æŸ¥è¯¢ï¼ˆç”¨äºé«˜äº®æ˜¾ç¤ºï¼‰
                        appSearchAdapter.updateSearchQuery(query)
                        // æ˜¾ç¤ºæ¸…ç©ºæŒ‰é’®
                        updateInputLayoutEndIcon(true)
                        updateHistoryButtonIcon(true)
                    } else {
                        // æ²¡æœ‰é€‰ä¸­çš„appï¼Œåªæ›´æ–°æœç´¢æŸ¥è¯¢
                        appSearchAdapter.updateSearchQuery(query)
                        appSearchHint.text = "è¾“å…¥å…³é”®è¯ï¼š$queryï¼Œç‚¹å‡»åº”ç”¨å›¾æ ‡è¿›è¡Œæœç´¢"
                        // æ˜¾ç¤ºæ¸…ç©ºæŒ‰é’®
                        updateInputLayoutEndIcon(true)
                        updateHistoryButtonIcon(true)
                        
                        // è®°å½•æœç´¢å†å²ï¼ˆå³ä½¿æ²¡æœ‰é€‰ä¸­åº”ç”¨ï¼Œä¹Ÿè®°å½•è¾“å…¥å†…å®¹ï¼‰
                        com.example.aifloatingball.manager.SearchHistoryAutoRecorder.recordSearchHistory(
                            context = this,
                            query = query,
                            source = com.example.aifloatingball.manager.SearchHistoryAutoRecorder.SearchSource.APP_TAB,
                            tags = listOf("å¾…é€‰æ‹©åº”ç”¨"),
                            searchType = "åº”ç”¨æœç´¢"
                        )
                    }
                } else {
                    appSearchAdapter.updateSearchQuery("")
                    appSearchHint.text = "é€‰æ‹©${currentAppCategory.displayName}åº”ç”¨è¿›è¡Œæœç´¢"
                    // æ˜¾ç¤ºå†å²æŒ‰é’®
                    updateInputLayoutEndIcon(false)
                    updateHistoryButtonIcon(false)
                }
                true
            } else {
                false
            }
        }

        // è®¾ç½®æ–‡æœ¬å˜åŒ–ç›‘å¬
        appSearchInput.addTextChangedListener(object : android.text.TextWatcher {
            override fun beforeTextChanged(s: CharSequence?, start: Int, count: Int, after: Int) {}
            override fun onTextChanged(s: CharSequence?, start: Int, before: Int, count: Int) {}
            override fun afterTextChanged(s: android.text.Editable?) {
                val hasText = !s.isNullOrEmpty()
                updateInputLayoutEndIcon(hasText)
                updateHistoryButtonIcon(hasText)
            }
        })
        
        // è®¾ç½®ç„¦ç‚¹å˜åŒ–ç›‘å¬ï¼Œåœ¨å¤±å»ç„¦ç‚¹æ—¶è®°å½•æœç´¢å†å²ï¼ˆå¦‚æœè¾“å…¥æ¡†æœ‰å†…å®¹ï¼‰
        appSearchInput.setOnFocusChangeListener { _, hasFocus ->
            if (!hasFocus) {
                // å¤±å»ç„¦ç‚¹æ—¶ï¼Œå¦‚æœè¾“å…¥æ¡†æœ‰å†…å®¹ï¼Œè®°å½•æœç´¢å†å²
                val query = appSearchInput.text.toString().trim()
                if (query.isNotEmpty()) {
                    // ä½¿ç”¨å»¶è¿Ÿè®°å½•ï¼Œé¿å…ä¸æŒ‰å›è½¦é”®æˆ–ç‚¹å‡»åº”ç”¨æ—¶çš„è®°å½•é‡å¤
                    // SearchHistoryAutoRecorder å†…éƒ¨å·²æœ‰é˜²é‡å¤æœºåˆ¶ï¼ˆ5ç§’å†…ç›¸åŒæœç´¢ä¸é‡å¤è®°å½•ï¼‰
                    android.os.Handler(android.os.Looper.getMainLooper()).postDelayed({
                        val currentQuery = appSearchInput.text.toString().trim()
                        if (currentQuery == query && currentQuery.isNotEmpty()) {
                            // æ£€æŸ¥æ˜¯å¦æœ‰é€‰ä¸­çš„appï¼ˆæˆ–æ²¿ç”¨ä¸Šä¸€ä¸ªappï¼‰
                            val appToUse = getAppForSearch()
                            if (appToUse == null) {
                                // æ²¡æœ‰é€‰ä¸­çš„appï¼Œè®°å½•æœç´¢å†å²ï¼ˆå¸¦"å¾…é€‰æ‹©åº”ç”¨"æ ‡ç­¾ï¼‰
                                com.example.aifloatingball.manager.SearchHistoryAutoRecorder.recordSearchHistory(
                                    context = this,
                                    query = currentQuery,
                                    source = com.example.aifloatingball.manager.SearchHistoryAutoRecorder.SearchSource.APP_TAB,
                                    tags = listOf("å¾…é€‰æ‹©åº”ç”¨"),
                                    searchType = "åº”ç”¨æœç´¢"
                                )
                            } else {
                                // æœ‰é€‰ä¸­çš„appï¼Œä¹Ÿè®°å½•æœç´¢å†å²ï¼ˆå¸¦åº”ç”¨åç§°æ ‡ç­¾ï¼‰
                                // æ³¨æ„ï¼šå¦‚æœç”¨æˆ·éšåç‚¹å‡»åº”ç”¨å›¾æ ‡ï¼ŒhandleAppSearch ä¸­ä¹Ÿä¼šè®°å½•ï¼Œä½†é˜²é‡å¤æœºåˆ¶ä¼šé¿å…é‡å¤
                                com.example.aifloatingball.manager.SearchHistoryAutoRecorder.recordSearchHistory(
                                    context = this,
                                    query = currentQuery,
                                    source = com.example.aifloatingball.manager.SearchHistoryAutoRecorder.SearchSource.APP_TAB,
                                    tags = listOf(appToUse.appName),
                                    searchType = "åº”ç”¨æœç´¢"
                                )
                            }
                        }
                    }, 500) // å»¶è¿Ÿ500msï¼Œé¿å…ä¸æŒ‰å›è½¦é”®æˆ–ç‚¹å‡»åº”ç”¨æ—¶çš„è®°å½•é‡å¤
                }
            }
        }

        // è®¾ç½®å†å²/æ¸…ç©ºæŒ‰é’®ç‚¹å‡»ç›‘å¬ï¼ˆå…¼å®¹æ–°å¸ƒå±€ï¼‰
        historyButton?.setOnClickListener {
            val query = appSearchInput.text.toString().trim()
            if (query.isNotEmpty()) {
                // æ£€æŸ¥æ˜¯å¦æœ‰é€‰ä¸­çš„appï¼ˆæˆ–æ²¿ç”¨ä¸Šä¸€ä¸ªappï¼‰
                val appToUse = getAppForSearch()
                if (appToUse != null) {
                    // æœ‰é€‰ä¸­çš„appï¼Œæ‰§è¡Œæœç´¢è·³è½¬
                    Log.d(TAG, "ç‚¹å‡»å†å²å›¾æ ‡æ‰§è¡Œæœç´¢è·³è½¬: app=${appToUse.appName}, query=$query")
                    handleAppSearch(appToUse, query)
                    // æ›´æ–°æœç´¢é€‚é…å™¨æŸ¥è¯¢ï¼ˆç”¨äºé«˜äº®æ˜¾ç¤ºï¼‰
                    appSearchAdapter.updateSearchQuery(query)
                } else {
                    // æ²¡æœ‰é€‰ä¸­çš„appï¼Œæ¸…ç©ºè¾“å…¥æ¡†
                    appSearchInput.text?.clear()
                    appSearchAdapter.updateSearchQuery("")
                    resetSearchInputIcon()
                }
            } else {
                // æ˜¾ç¤ºæœç´¢å†å²
                showSearchHistory()
            }
        }

        // è®¾ç½®ç»“æŸå›¾æ ‡ç‚¹å‡»ç›‘å¬ï¼ˆå…¼å®¹æ—§å¸ƒå±€ï¼Œå¦‚æœTextInputLayoutå­˜åœ¨ï¼‰
        textInputLayout?.setEndIconOnClickListener {
            val query = appSearchInput.text.toString().trim()
            if (query.isNotEmpty()) {
                // æ£€æŸ¥æ˜¯å¦æœ‰é€‰ä¸­çš„appï¼ˆæˆ–æ²¿ç”¨ä¸Šä¸€ä¸ªappï¼‰
                val appToUse = getAppForSearch()
                if (appToUse != null) {
                    // æœ‰é€‰ä¸­çš„appï¼Œæ‰§è¡Œæœç´¢è·³è½¬
                    Log.d(TAG, "ç‚¹å‡»endIconæ‰§è¡Œæœç´¢è·³è½¬: app=${appToUse.appName}, query=$query")
                    handleAppSearch(appToUse, query)
                    // æ›´æ–°æœç´¢é€‚é…å™¨æŸ¥è¯¢ï¼ˆç”¨äºé«˜äº®æ˜¾ç¤ºï¼‰
                    appSearchAdapter.updateSearchQuery(query)
                } else {
                    // æ²¡æœ‰é€‰ä¸­çš„appï¼Œæ¸…ç©ºè¾“å…¥æ¡†
                    appSearchInput.text?.clear()
                    appSearchAdapter.updateSearchQuery("")
                    resetSearchInputIcon()
                }
            } else {
                // æ˜¾ç¤ºæœç´¢å†å²
                showSearchHistory()
            }
        }

        // è®¾ç½®å¼€å§‹å›¾æ ‡ç‚¹å‡»ç›‘å¬ï¼ˆæ”¾å¤§é•œå›¾æ ‡ï¼‰
        textInputLayout?.setStartIconOnClickListener {
            showAppSelectionHistory()
        }
    }

    /**
     * æ›´æ–°é€‰ä¸­åº”ç”¨æ˜¾ç¤º
     */
    private fun updateSelectedAppDisplay(appConfig: AppSearchConfig) {
        try {
            Log.d(TAG, "å¼€å§‹æ›´æ–°é€‰ä¸­åº”ç”¨æ˜¾ç¤º: ${appConfig.appName}, åŒ…å: ${appConfig.packageName}")

            // åœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡ŒUIæ›´æ–°
            runOnUiThread {
                try {
                    // è·å–åº”ç”¨å›¾æ ‡
                    val drawable = getAppIconDrawable(appConfig)

                    if (drawable != null) {
                        // è®¾ç½®åº”ç”¨å›¾æ ‡
                        selectedAppIcon.setImageDrawable(drawable)

                        // æ˜¾ç¤ºå›¾æ ‡å®¹å™¨
                        selectedAppIconContainer.visibility = View.VISIBLE

                        // æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œç‚¹å‡»å›¾æ ‡å¯ä»¥å¿«é€Ÿæœç´¢
                        selectedAppIconContainer.setOnClickListener {
                            val query = appSearchInput.text.toString().trim()
                            if (query.isNotEmpty()) {
                                handleAppSearch(appConfig, query)
                            } else {
                                Toast.makeText(this@SimpleModeActivity, "è¯·è¾“å…¥æœç´¢å…³é”®è¯", Toast.LENGTH_SHORT).show()
                            }
                        }

                        Log.d(TAG, "æˆåŠŸè®¾ç½®é€‰ä¸­åº”ç”¨å›¾æ ‡")

                        // ä¿å­˜åˆ°é€‰æ‹©å†å²
                        appSelectionHistoryManager.addAppSelection(appConfig)
                        
                        // è®°å½•åº”ç”¨é€‰æ‹©ï¼ˆåŒ…æ‹¬ä½ç½®ï¼‰
                        val position = currentAppConfigs.indexOfFirst { it.packageName == appConfig.packageName }
                        appUsageTracker.recordUsage(appConfig.packageName, appConfig.appName, position)

                        // æ›´æ–°æç¤ºæ–‡æœ¬
                        appSearchHint.text = "å·²é€‰æ‹© ${appConfig.appName}ï¼Œè¾“å…¥å…³é”®è¯è¿›è¡Œæœç´¢"
                        
                        // ä¿å­˜å½“å‰é€‰ä¸­çš„appé…ç½®
                        currentSelectedAppConfig = appConfig
                    } else {
                        Log.w(TAG, "æ— æ³•è·å–åº”ç”¨å›¾æ ‡")
                        hideSelectedAppDisplay()
                        currentSelectedAppConfig = null
                    }
                } catch (e: Exception) {
                    Log.e(TAG, "åœ¨UIçº¿ç¨‹ä¸­æ›´æ–°é€‰ä¸­åº”ç”¨æ˜¾ç¤ºå¤±è´¥", e)
                }
            }
        } catch (e: Exception) {
            Log.e(TAG, "æ›´æ–°é€‰ä¸­åº”ç”¨æ˜¾ç¤ºå¤±è´¥", e)
        }
    }

    /**
     * éšè—é€‰ä¸­åº”ç”¨æ˜¾ç¤º
     */
    private fun hideSelectedAppDisplay() {
        selectedAppIconContainer.visibility = View.GONE
        appSearchHint.text = "é€‰æ‹©å…¨éƒ¨åº”ç”¨è¿›è¡Œæœç´¢"
        // æ³¨æ„ï¼šä¸æ¸…ç©ºcurrentSelectedAppConfigï¼Œä»¥ä¾¿æ²¿ç”¨ä¸Šä¸€ä¸ªapp
    }

    /**
     * æ˜¾ç¤ºåº”ç”¨é€‰æ‹©å†å²
     */
    private fun showAppSelectionHistory() {
        try {
            val recentApps = appSelectionHistoryManager.getRecentApps()

            if (recentApps.isEmpty()) {
                Toast.makeText(this, "æš‚æ— åº”ç”¨é€‰æ‹©å†å²", Toast.LENGTH_SHORT).show()
                return
            }

            // åˆ›å»ºè‡ªå®šä¹‰å¯¹è¯æ¡†æ˜¾ç¤ºåº”ç”¨å›¾æ ‡ç½‘æ ¼
            showAppSelectionDialog(recentApps)

        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºåº”ç”¨é€‰æ‹©å†å²å¤±è´¥", e)
            Toast.makeText(this, "åŠ è½½å†å²è®°å½•å¤±è´¥", Toast.LENGTH_SHORT).show()
        }
    }

    /**
     * æ˜¾ç¤ºåº”ç”¨é€‰æ‹©å¯¹è¯æ¡†
     */
    private fun showAppSelectionDialog(recentApps: List<AppSelectionHistoryManager.AppSelectionItem>) {
        val dialogView = layoutInflater.inflate(R.layout.dialog_app_selection, null)
        val gridView = dialogView.findViewById<androidx.recyclerview.widget.RecyclerView>(R.id.app_selection_grid)

        // è®¾ç½®ç½‘æ ¼å¸ƒå±€
        gridView.layoutManager = androidx.recyclerview.widget.GridLayoutManager(this, 4)

        // åˆ›å»ºé€‚é…å™¨
        val adapter = AppSelectionDialogAdapter(this, recentApps) { selectionItem: AppSelectionHistoryManager.AppSelectionItem ->
            // ç‚¹å‡»åº”ç”¨æ—¶çš„å›è°ƒ
            selectAppFromHistory(selectionItem)
        }
        gridView.adapter = adapter

        // åˆ›å»ºå¯¹è¯æ¡†
        createThemedDialogBuilder()
            .setTitle("æœ€è¿‘é€‰æ‹©çš„åº”ç”¨")
            .setView(dialogView)
            .setNegativeButton("æ¸…ç©ºå†å²") { _, _ ->
                createThemedDialogBuilder()
                    .setTitle("ç¡®è®¤æ¸…ç©º")
                    .setMessage("ç¡®å®šè¦æ¸…ç©ºåº”ç”¨é€‰æ‹©å†å²å—ï¼Ÿ")
                    .setPositiveButton("ç¡®å®š") { _, _ ->
                        appSelectionHistoryManager.clearSelectionHistory()
                        Toast.makeText(this, "å†å²è®°å½•å·²æ¸…ç©º", Toast.LENGTH_SHORT).show()
                    }
                    .setNegativeButton("å–æ¶ˆ", null)
                    .show()
            }
            .setNeutralButton("å–æ¶ˆ", null)
            .show()
    }

    /**
     * è·å–ç”¨äºæœç´¢çš„appï¼ˆä¼˜å…ˆä½¿ç”¨å½“å‰é€‰ä¸­çš„appï¼Œå¦åˆ™ä½¿ç”¨æœ€è¿‘é€‰æ‹©çš„appï¼‰
     */
    private fun getAppForSearch(): AppSearchConfig? {
        // ä¼˜å…ˆä½¿ç”¨å½“å‰é€‰ä¸­çš„app
        if (currentSelectedAppConfig != null) {
            Log.d(TAG, "ä½¿ç”¨å½“å‰é€‰ä¸­çš„app: ${currentSelectedAppConfig!!.appName}")
            return currentSelectedAppConfig
        }
        
        // å¦‚æœæ²¡æœ‰å½“å‰é€‰ä¸­çš„appï¼Œå°è¯•è·å–æœ€è¿‘é€‰æ‹©çš„app
        try {
            val recentApps = appSelectionHistoryManager.getRecentApps()
            if (recentApps.isNotEmpty()) {
                val lastSelectedItem = recentApps.first()
                val appConfig = currentAppConfigs.find { it.packageName == lastSelectedItem.packageName }
                if (appConfig != null) {
                    Log.d(TAG, "æ²¿ç”¨ä¸Šä¸€ä¸ªapp: ${appConfig.appName}")
                    // æ›´æ–°å½“å‰é€‰ä¸­çš„appé…ç½®ï¼Œä½†ä¸æ˜¾ç¤ºå›¾æ ‡ï¼ˆå› ä¸ºç”¨æˆ·å¯èƒ½å·²ç»æ¸…ç©ºäº†å›¾æ ‡æ˜¾ç¤ºï¼‰
                    currentSelectedAppConfig = appConfig
                    return appConfig
                }
            }
        } catch (e: Exception) {
            Log.e(TAG, "è·å–æœ€è¿‘é€‰æ‹©çš„appå¤±è´¥", e)
        }
        
        return null
    }

    /**
     * ä»å†å²è®°å½•ä¸­é€‰æ‹©åº”ç”¨
     */
    private fun selectAppFromHistory(selectionItem: AppSelectionHistoryManager.AppSelectionItem) {
        // æ‰¾åˆ°å¯¹åº”çš„åº”ç”¨é…ç½®
        val appConfig = currentAppConfigs.find { it.packageName == selectionItem.packageName }

        if (appConfig != null) {
            // æ›´æ–°é€‰ä¸­åº”ç”¨æ˜¾ç¤º
            updateSelectedAppDisplay(appConfig)
            Toast.makeText(this, "å·²é€‰æ‹© ${appConfig.appName}", Toast.LENGTH_SHORT).show()
        } else {
            Toast.makeText(this, "åº”ç”¨ ${selectionItem.appName} ä¸å¯ç”¨", Toast.LENGTH_SHORT).show()
        }
    }

    /**
     * è·å–åº”ç”¨å›¾æ ‡Drawable
     */
    private fun getAppIconDrawable(appConfig: AppSearchConfig): android.graphics.drawable.Drawable? {
        return try {
            if (isAppInstalled(appConfig.packageName)) {
                Log.d(TAG, "åº”ç”¨å·²å®‰è£…ï¼Œè·å–çœŸå®å›¾æ ‡")
                packageManager.getApplicationIcon(appConfig.packageName)
            } else {
                Log.d(TAG, "åº”ç”¨æœªå®‰è£…ï¼Œä½¿ç”¨åˆ†ç±»å›¾æ ‡: ${appConfig.category.iconResId}")
                ContextCompat.getDrawable(this, appConfig.category.iconResId)
            }
        } catch (e: Exception) {
            Log.e(TAG, "è·å–åº”ç”¨å›¾æ ‡å¤±è´¥", e)
            ContextCompat.getDrawable(this, R.drawable.ic_search)
        }
    }

    /**
     * åˆ›å»ºç¼©æ”¾åçš„å›¾æ ‡
     */
    private fun createScaledIcon(originalDrawable: android.graphics.drawable.Drawable): android.graphics.drawable.Drawable {
        return try {
            val size = resources.getDimensionPixelSize(R.dimen.search_input_icon_size_small) // 20dp

            // åˆ›å»ºbitmap
            val bitmap = android.graphics.Bitmap.createBitmap(size, size, android.graphics.Bitmap.Config.ARGB_8888)
            val canvas = android.graphics.Canvas(bitmap)

            // è®¾ç½®drawableçš„è¾¹ç•Œå¹¶ç»˜åˆ¶
            originalDrawable.setBounds(0, 0, size, size)
            originalDrawable.draw(canvas)

            // åˆ›å»ºBitmapDrawable
            android.graphics.drawable.BitmapDrawable(resources, bitmap)
        } catch (e: Exception) {
            Log.e(TAG, "åˆ›å»ºç¼©æ”¾å›¾æ ‡å¤±è´¥ï¼Œè¿”å›åŸå›¾æ ‡", e)
            originalDrawable
        }
    }

    /**
     * é‡ç½®æœç´¢è¾“å…¥æ¡†å›¾æ ‡ä¸ºé»˜è®¤çŠ¶æ€
     */
    private fun resetSearchInputIcon() {
        hideSelectedAppDisplay()
        appSearchHint.text = "é€‰æ‹©${currentAppCategory.displayName}åº”ç”¨è¿›è¡Œæœç´¢"
        updateInputLayoutEndIcon(false)
        updateHistoryButtonIcon(false)
    }

    /**
     * æ›´æ–°è¾“å…¥æ¡†ç»“æŸå›¾æ ‡ï¼ˆå…¼å®¹æ—§å¸ƒå±€ï¼Œå¦‚æœTextInputLayoutå­˜åœ¨ï¼‰
     */
    private fun updateInputLayoutEndIcon(hasText: Boolean) {
        try {
            val textInputLayout = try {
                findViewById<com.google.android.material.textfield.TextInputLayout>(R.id.app_search_input_layout)
            } catch (e: Exception) {
                null
            }

            if (textInputLayout != null) {
                if (hasText) {
                    // æ˜¾ç¤ºæ¸…ç©ºå›¾æ ‡
                    textInputLayout.endIconDrawable = ContextCompat.getDrawable(this, R.drawable.ic_clear)
                } else {
                    // æ˜¾ç¤ºå†å²å›¾æ ‡
                    textInputLayout.endIconDrawable = ContextCompat.getDrawable(this, R.drawable.ic_history)
                }
            }
        } catch (e: Exception) {
            Log.e("SimpleModeActivity", "æ›´æ–°è¾“å…¥æ¡†ç»“æŸå›¾æ ‡å¤±è´¥", e)
        }
    }

    /**
     * æ›´æ–°å†å²æŒ‰é’®å›¾æ ‡ï¼ˆæ–°å¸ƒå±€ï¼‰
     */
    private fun updateHistoryButtonIcon(hasText: Boolean) {
        try {
            val historyButton = findViewById<ImageButton>(R.id.app_search_history_button)

            if (historyButton != null) {
                if (hasText) {
                    // æ˜¾ç¤ºæ¸…ç©ºå›¾æ ‡
                    historyButton.setImageDrawable(ContextCompat.getDrawable(this, R.drawable.ic_clear))
                    historyButton.contentDescription = "æ¸…ç©ºæœç´¢"
                } else {
                    // æ˜¾ç¤ºå†å²å›¾æ ‡
                    historyButton.setImageDrawable(ContextCompat.getDrawable(this, R.drawable.ic_history))
                    historyButton.contentDescription = "æœç´¢å†å²"
                }
            }
        } catch (e: Exception) {
            Log.e("SimpleModeActivity", "æ›´æ–°å†å²æŒ‰é’®å›¾æ ‡å¤±è´¥", e)
        }
    }

    /**
     * æ˜¾ç¤ºæœç´¢å†å²
     */
    private fun showSearchHistory() {
        try {
            val historyList = searchHistoryManager.getSearchHistory()
            if (historyList.isEmpty()) {
                Toast.makeText(this, "æš‚æ— æœç´¢å†å²", Toast.LENGTH_SHORT).show()
                return
            }

            val historyItems = historyList.map { "${it.query} (${it.appName})" }.toTypedArray()

            createThemedDialogBuilder()
                .setTitle("æœç´¢å†å²")
                .setItems(historyItems) { _, which ->
                    val selectedHistory = historyList[which]
                    // å¡«å……åˆ°è¾“å…¥æ¡†
                    appSearchInput.setText(selectedHistory.query)
                    appSearchInput.setSelection(selectedHistory.query.length)

                    // æ›´æ–°æœç´¢æŸ¥è¯¢
                    appSearchAdapter.updateSearchQuery(selectedHistory.query)
                    appSearchHint.text = "è¾“å…¥å…³é”®è¯ï¼š${selectedHistory.query}ï¼Œç‚¹å‡»åº”ç”¨å›¾æ ‡è¿›è¡Œæœç´¢"
                    updateInputLayoutEndIcon(true)
                }
                .setNegativeButton("æ¸…ç©ºå†å²") { _, _ ->
                    createThemedDialogBuilder()
                        .setTitle("ç¡®è®¤æ¸…ç©º")
                        .setMessage("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æœç´¢å†å²å—ï¼Ÿ")
                        .setPositiveButton("ç¡®å®š") { _, _ ->
                            searchHistoryManager.clearSearchHistory()
                            Toast.makeText(this, "æœç´¢å†å²å·²æ¸…ç©º", Toast.LENGTH_SHORT).show()
                        }
                        .setNegativeButton("å–æ¶ˆ", null)
                        .show()
                }
                .setNeutralButton("å–æ¶ˆ", null)
                .show()

        } catch (e: Exception) {
            Log.e("SimpleModeActivity", "æ˜¾ç¤ºæœç´¢å†å²å¤±è´¥", e)
        }
    }

    /**
     * æ˜¾ç¤ºæœç´¢å†å²å¹¶æ”¯æŒè®¾ç½®é»˜è®¤é€‰é¡¹
     */
    private fun showSearchHistoryWithDefault() {
        try {
            val historyList = searchHistoryManager.getSearchHistory()
            val defaultSearch = searchHistoryManager.getDefaultSearch()

            if (historyList.isEmpty() && defaultSearch == null) {
                Toast.makeText(this, "æš‚æ— æœç´¢å†å²", Toast.LENGTH_SHORT).show()
                return
            }

            val items = mutableListOf<String>()
            val actions = mutableListOf<() -> Unit>()

            // æ·»åŠ é»˜è®¤æœç´¢é€‰é¡¹
            defaultSearch?.let { (appName, _) ->
                items.add("ğŸŒŸ é»˜è®¤æœç´¢ï¼š$appName")
                actions.add {
                    // æ‰§è¡Œé»˜è®¤æœç´¢
                    executeDefaultSearch()
                }
            }

            // æ·»åŠ å†å²è®°å½•
            historyList.forEach { history ->
                val isDefault = defaultSearch?.second == history.packageName
                val prefix = if (isDefault) "â­ " else ""
                items.add("$prefix${history.query} (${history.appName})")
                actions.add {
                    // å¡«å……åˆ°è¾“å…¥æ¡†
                    appSearchInput.setText(history.query)
                    appSearchInput.setSelection(history.query.length)

                    // æ›´æ–°æœç´¢æŸ¥è¯¢
                    appSearchAdapter.updateSearchQuery(history.query)
                    appSearchHint.text = "è¾“å…¥å…³é”®è¯ï¼š${history.query}ï¼Œç‚¹å‡»åº”ç”¨å›¾æ ‡è¿›è¡Œæœç´¢"
                    updateInputLayoutEndIcon(true)
                }
            }

            createThemedDialogBuilder()
                .setTitle("æœç´¢é€‰é¡¹")
                .setItems(items.toTypedArray()) { _, which ->
                    actions[which].invoke()
                }
                .setNegativeButton("ç®¡ç†") { _, _ ->
                    showSearchManagement()
                }
                .setNeutralButton("å–æ¶ˆ", null)
                .show()

        } catch (e: Exception) {
            Log.e("SimpleModeActivity", "æ˜¾ç¤ºæœç´¢é€‰é¡¹å¤±è´¥", e)
        }
    }

    /**
     * æ‰§è¡Œé»˜è®¤æœç´¢
     */
    private fun executeDefaultSearch() {
        val defaultSearch = searchHistoryManager.getDefaultSearch() ?: return
        val (appName, packageName) = defaultSearch

        // æ‰¾åˆ°å¯¹åº”çš„åº”ç”¨é…ç½®
        val appConfig = currentAppConfigs.find { it.packageName == packageName }
        if (appConfig != null) {
            val query = appSearchInput.text.toString().trim()
            if (query.isNotEmpty()) {
                handleAppSearch(appConfig, query)
            } else {
                // æ›´æ–°é€‰ä¸­åº”ç”¨æ˜¾ç¤º
                updateSelectedAppDisplay(appConfig)
                Toast.makeText(this, "å·²é€‰æ‹©é»˜è®¤æœç´¢ï¼š$appName", Toast.LENGTH_SHORT).show()
            }
        } else {
            Toast.makeText(this, "é»˜è®¤æœç´¢åº”ç”¨ä¸å¯ç”¨", Toast.LENGTH_SHORT).show()
        }
    }

    /**
     * æ˜¾ç¤ºæœç´¢ç®¡ç†ç•Œé¢
     */
    private fun showSearchManagement() {
        val historyList = searchHistoryManager.getSearchHistory()
        val defaultSearch = searchHistoryManager.getDefaultSearch()

        if (historyList.isEmpty()) {
            Toast.makeText(this, "æš‚æ— æœç´¢å†å²", Toast.LENGTH_SHORT).show()
            return
        }

        val items = historyList.map { history ->
            val isDefault = defaultSearch?.second == history.packageName
            val prefix = if (isDefault) "â­ " else ""
            "$prefix${history.query} (${history.appName})"
        }.toTypedArray()

        createThemedDialogBuilder()
            .setTitle("æœç´¢ç®¡ç†")
            .setItems(items) { _, which ->
                val selectedHistory = historyList[which]
                showHistoryItemMenu(selectedHistory)
            }
            .setNegativeButton("æ¸…ç©ºæ‰€æœ‰") { _, _ ->
                createThemedDialogBuilder()
                    .setTitle("ç¡®è®¤æ¸…ç©º")
                    .setMessage("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æœç´¢å†å²å—ï¼Ÿ")
                    .setPositiveButton("ç¡®å®š") { _, _ ->
                        searchHistoryManager.clearSearchHistory()
                        searchHistoryManager.clearDefaultSearch()
                        Toast.makeText(this, "æœç´¢å†å²å·²æ¸…ç©º", Toast.LENGTH_SHORT).show()
                    }
                    .setNegativeButton("å–æ¶ˆ", null)
                    .show()
            }
            .setNeutralButton("å–æ¶ˆ", null)
            .show()
    }

    /**
     * æ˜¾ç¤ºå†å²é¡¹ç›®èœå•
     */
    private fun showHistoryItemMenu(historyItem: SearchHistoryManager.SearchHistoryItem) {
        val defaultSearch = searchHistoryManager.getDefaultSearch()
        val isDefault = defaultSearch?.second == historyItem.packageName

        val options = if (isDefault) {
            arrayOf("ä½¿ç”¨æ­¤æœç´¢", "å–æ¶ˆé»˜è®¤è®¾ç½®", "åˆ é™¤æ­¤é¡¹")
        } else {
            arrayOf("ä½¿ç”¨æ­¤æœç´¢", "è®¾ä¸ºé»˜è®¤", "åˆ é™¤æ­¤é¡¹")
        }

        createThemedDialogBuilder()
            .setTitle("${historyItem.query} (${historyItem.appName})")
            .setItems(options) { _, which ->
                when (which) {
                    0 -> {
                        // ä½¿ç”¨æ­¤æœç´¢
                        appSearchInput.setText(historyItem.query)
                        appSearchInput.setSelection(historyItem.query.length)
                        appSearchAdapter.updateSearchQuery(historyItem.query)
                        appSearchHint.text = "è¾“å…¥å…³é”®è¯ï¼š${historyItem.query}ï¼Œç‚¹å‡»åº”ç”¨å›¾æ ‡è¿›è¡Œæœç´¢"
                        updateInputLayoutEndIcon(true)
                    }
                    1 -> {
                        if (isDefault) {
                            // å–æ¶ˆé»˜è®¤è®¾ç½®
                            searchHistoryManager.clearDefaultSearch()
                            Toast.makeText(this, "å·²å–æ¶ˆé»˜è®¤è®¾ç½®", Toast.LENGTH_SHORT).show()
                        } else {
                            // è®¾ä¸ºé»˜è®¤
                            searchHistoryManager.setDefaultSearch(historyItem.appName, historyItem.packageName)
                            Toast.makeText(this, "å·²è®¾ä¸ºé»˜è®¤æœç´¢", Toast.LENGTH_SHORT).show()
                        }
                    }
                    2 -> {
                        // åˆ é™¤æ­¤é¡¹
                        searchHistoryManager.removeSearchHistory(historyItem.query, historyItem.packageName)
                        Toast.makeText(this, "å·²åˆ é™¤", Toast.LENGTH_SHORT).show()
                    }
                }
            }
            .setNegativeButton("å–æ¶ˆ", null)
            .show()
    }

    /**
     * å¤„ç†åº”ç”¨æœç´¢
     */
    private fun handleAppSearch(appConfig: AppSearchConfig, query: String) {
        try {
            // è®°å½•åº”ç”¨ä½¿ç”¨ï¼ˆåŒ…æ‹¬ä½ç½®ï¼‰
            val position = currentAppConfigs.indexOfFirst { it.packageName == appConfig.packageName }
            appUsageTracker.recordUsage(appConfig.packageName, appConfig.appName, position)
            
            if (query.isNotEmpty()) {
                // æ£€æŸ¥æ˜¯å¦ä¸ºAIåº”ç”¨
                if (isAIApp(appConfig)) {
                    // AIåº”ç”¨ï¼šä½¿ç”¨ç›´æ¥æé—®åŠŸèƒ½
                    handleAIDirectQuestion(appConfig, query)
                } else {
                    // æ™®é€šåº”ç”¨ï¼šä½¿ç”¨å¤šå±‚æ¬¡æœç´¢intentå°è¯•
                    val searchSuccess = tryLaunchAppWithSearch(appConfig, query)
                    
                    if (searchSuccess) {
                        // ä¿å­˜æœç´¢å†å²ï¼ˆåŸæœ‰ç³»ç»Ÿï¼‰
                        searchHistoryManager.addSearchHistory(query, appConfig.appName, appConfig.packageName)
                        
                        // è®°å½•åˆ°ç»Ÿä¸€æ”¶è—ç®¡ç†ç³»ç»Ÿ
                        com.example.aifloatingball.manager.SearchHistoryAutoRecorder.recordSearchHistory(
                            context = this,
                            query = query,
                            source = com.example.aifloatingball.manager.SearchHistoryAutoRecorder.SearchSource.APP_TAB,
                            tags = listOf(appConfig.appName), // æ·»åŠ åº”ç”¨åç§°ä½œä¸ºæ ‡ç­¾
                            searchType = "åº”ç”¨æœç´¢"
                        )
                        
                        // å»¶è¿Ÿæ˜¾ç¤ºAIAppOverlayServiceé¢æ¿ï¼ˆsoftware_tabæ¨¡å¼ï¼‰
                        Handler(Looper.getMainLooper()).postDelayed({
                            showAIAppOverlay(appConfig.packageName, query, appConfig.appName)
                        }, 2000) // å»¶è¿Ÿ2ç§’ï¼Œç¡®ä¿åº”ç”¨å·²å¯åŠ¨
                    } else {
                        // æ‰€æœ‰æœç´¢æ–¹æ³•éƒ½å¤±è´¥ï¼Œé™çº§åˆ°æ™®é€šå¯åŠ¨
                        Log.w(TAG, "æ‰€æœ‰æœç´¢æ–¹æ³•éƒ½å¤±è´¥ï¼Œé™çº§åˆ°æ™®é€šå¯åŠ¨: ${appConfig.appName}")
                        val launchIntent = packageManager.getLaunchIntentForPackage(appConfig.packageName)
                        if (launchIntent != null) {
                            launchIntent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
                            startActivity(launchIntent)
                            Toast.makeText(this, "æ­£åœ¨å¯åŠ¨${appConfig.appName}ï¼Œè¯·æ‰‹åŠ¨æœç´¢", Toast.LENGTH_SHORT).show()
                            
                            // å»¶è¿Ÿæ˜¾ç¤ºAIAppOverlayServiceé¢æ¿ï¼ˆsoftware_tabæ¨¡å¼ï¼‰
                            Handler(Looper.getMainLooper()).postDelayed({
                                showAIAppOverlay(appConfig.packageName, query, appConfig.appName)
                            }, 2000)
                        } else {
                            Toast.makeText(this, "å¯åŠ¨${appConfig.appName}å¤±è´¥ï¼Œè¯·æ£€æŸ¥åº”ç”¨æ˜¯å¦å·²å®‰è£…", Toast.LENGTH_SHORT).show()
                        }
                    }
                }
            } else {
                // æ²¡æœ‰æœç´¢å†…å®¹æ—¶ï¼Œç›´æ¥å¯åŠ¨åº”ç”¨
                val launchIntent = packageManager.getLaunchIntentForPackage(appConfig.packageName)
                if (launchIntent != null) {
                    launchIntent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
                    startActivity(launchIntent)
                    Toast.makeText(this, "æ­£åœ¨å¯åŠ¨${appConfig.appName}", Toast.LENGTH_SHORT).show()
                    Log.d(TAG, "ç›´æ¥å¯åŠ¨åº”ç”¨: ${appConfig.appName}")
                    
                    // å»¶è¿Ÿæ˜¾ç¤ºAIAppOverlayServiceé¢æ¿ï¼ˆsoftware_tabæ¨¡å¼ï¼‰
                    Handler(Looper.getMainLooper()).postDelayed({
                        showAIAppOverlay(appConfig.packageName, "", appConfig.appName)
                    }, 2000) // å»¶è¿Ÿ2ç§’ï¼Œç¡®ä¿åº”ç”¨å·²å¯åŠ¨
                } else {
                    Log.w(TAG, "æ— æ³•å¯åŠ¨åº”ç”¨: ${appConfig.appName}, åº”ç”¨å¯èƒ½æœªå®‰è£…")
                    Toast.makeText(this, "å¯åŠ¨${appConfig.appName}å¤±è´¥ï¼Œè¯·æ£€æŸ¥åº”ç”¨æ˜¯å¦å·²å®‰è£…", Toast.LENGTH_SHORT).show()
                    return
                }
            }

            // æ˜¾ç¤ºæ‚¬æµ®è¿”å›æŒ‰é’®
            showFloatingBackButton()

        } catch (e: Exception) {
            Log.e(TAG, "å¯åŠ¨åº”ç”¨å¤±è´¥: ${e.message}")
            // å°è¯•ç›´æ¥å¯åŠ¨åº”ç”¨ä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆ
            try {
                val launchIntent = packageManager.getLaunchIntentForPackage(appConfig.packageName)
                if (launchIntent != null) {
                    launchIntent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
                    startActivity(launchIntent)
                    Toast.makeText(this, "æ­£åœ¨å¯åŠ¨${appConfig.appName}", Toast.LENGTH_SHORT).show()
                    Log.d(TAG, "å¤‡ç”¨æ–¹æ¡ˆå¯åŠ¨åº”ç”¨æˆåŠŸ: ${appConfig.appName}")
                    
                    // å»¶è¿Ÿæ˜¾ç¤ºAIAppOverlayServiceé¢æ¿ï¼ˆsoftware_tabæ¨¡å¼ï¼‰
                    Handler(Looper.getMainLooper()).postDelayed({
                        val currentQuery = appSearchInput?.text?.toString() ?: ""
                        showAIAppOverlay(appConfig.packageName, currentQuery, appConfig.appName)
                    }, 2000) // å»¶è¿Ÿ2ç§’ï¼Œç¡®ä¿åº”ç”¨å·²å¯åŠ¨
                } else {
                    Toast.makeText(this, "å¯åŠ¨${appConfig.appName}å¤±è´¥ï¼Œè¯·æ£€æŸ¥åº”ç”¨æ˜¯å¦å·²å®‰è£…", Toast.LENGTH_SHORT).show()
                }
            } catch (fallbackException: Exception) {
                Log.e(TAG, "å¤‡ç”¨å¯åŠ¨æ–¹æ¡ˆä¹Ÿå¤±è´¥: ${fallbackException.message}")
                Toast.makeText(this, "å¯åŠ¨${appConfig.appName}å¤±è´¥", Toast.LENGTH_SHORT).show()
            }
        }
    }

    /**
     * å°è¯•ä½¿ç”¨å¤šç§æ–¹å¼å¯åŠ¨åº”ç”¨å¹¶æœç´¢
     * æŒ‰ä¼˜å…ˆçº§å°è¯•ï¼šURL scheme -> ACTION_SEARCH -> ACTION_SEND -> æ™®é€šå¯åŠ¨
     * @return æ˜¯å¦æˆåŠŸå¯åŠ¨æœç´¢
     */
    private fun tryLaunchAppWithSearch(appConfig: AppSearchConfig, query: String): Boolean {
        try {
            var intentHandled = false
            val encodedQuery = android.net.Uri.encode(query, "UTF-8")
            
            // æ–¹æ¡ˆ1ï¼šå°è¯•ä½¿ç”¨ä¸“ç”¨URL schemeï¼ˆé’ˆå¯¹å·²çŸ¥åº”ç”¨ï¼‰
            val searchUrl = getAppSearchUrlScheme(appConfig.packageName, query, encodedQuery)
            if (searchUrl != null) {
                try {
                    val intent = Intent(Intent.ACTION_VIEW, android.net.Uri.parse(searchUrl)).apply {
                        addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
                        setPackage(appConfig.packageName)
                    }
                    
                    Log.d(TAG, "å°è¯•URL schemeè·³è½¬: ${appConfig.appName}, URL: $searchUrl")
                    
                    // æ£€æŸ¥Intentæ˜¯å¦å¯ä»¥è§£æ
                    val resolveInfo = intent.resolveActivity(packageManager)
                    if (resolveInfo != null) {
                        Log.d(TAG, "Intentå¯ä»¥è§£æï¼Œå‡†å¤‡å¯åŠ¨: ${appConfig.appName}")
                        try {
                            startActivity(intent)
                            Toast.makeText(this, "æ­£åœ¨æ‰“å¼€${appConfig.appName}æœç´¢ï¼š$query", Toast.LENGTH_SHORT).show()
                            Log.d(TAG, "âœ… æˆåŠŸé€šè¿‡URL schemeè·³è½¬åˆ°${appConfig.appName}æœç´¢: $query, URL: $searchUrl")
                            return true
                        } catch (e: android.content.ActivityNotFoundException) {
                            Log.w(TAG, "âŒ ActivityNotFoundException: ${appConfig.appName}, URL: $searchUrl", e)
                            // ActivityNotFoundExceptionè¡¨ç¤ºURL schemeå¯èƒ½ä¸æ­£ç¡®ï¼Œç»§ç»­å°è¯•å…¶ä»–æ–¹æ³•
                        } catch (e: Exception) {
                            Log.w(TAG, "âŒ URL schemeè·³è½¬å¤±è´¥: ${appConfig.appName}, URL: $searchUrl", e)
                            // å…¶ä»–å¼‚å¸¸ä¹Ÿç»§ç»­å°è¯•å…¶ä»–æ–¹æ³•
                        }
                    } else {
                        Log.w(TAG, "âŒ Intentæ— æ³•è§£æ: ${appConfig.appName}, URL: $searchUrl")
                    }
                } catch (e: Exception) {
                    Log.w(TAG, "âŒ URL schemeæ„å»ºå¤±è´¥: ${appConfig.appName}", e)
                }
            } else if (appConfig.searchUrl.isNotEmpty() && appConfig.searchUrl.contains("{q}")) {
                // å¦‚æœæ²¡æœ‰ä¸“ç”¨URL schemeï¼Œå°è¯•ä½¿ç”¨é…ç½®çš„searchUrl
                try {
                    val searchUrl = appConfig.getSearchUrl(query)
                    val intent = Intent(Intent.ACTION_VIEW, android.net.Uri.parse(searchUrl)).apply {
                        addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
                        setPackage(appConfig.packageName)
                    }
                    
                    Log.d(TAG, "å°è¯•é…ç½®çš„URL schemeè·³è½¬: ${appConfig.appName}, URL: $searchUrl")
                    
                    val resolveInfo = intent.resolveActivity(packageManager)
                    if (resolveInfo != null) {
                        try {
                            startActivity(intent)
                            Toast.makeText(this, "æ­£åœ¨æ‰“å¼€${appConfig.appName}æœç´¢ï¼š$query", Toast.LENGTH_SHORT).show()
                            Log.d(TAG, "âœ… æˆåŠŸé€šè¿‡é…ç½®çš„URL schemeè·³è½¬åˆ°${appConfig.appName}æœç´¢: $query")
                            return true
                        } catch (e: Exception) {
                            Log.w(TAG, "âŒ é…ç½®çš„URL schemeè·³è½¬å¤±è´¥: ${appConfig.appName}", e)
                        }
                    }
                } catch (e: Exception) {
                    Log.w(TAG, "âŒ é…ç½®çš„URL schemeæ„å»ºå¤±è´¥: ${appConfig.appName}", e)
                }
            }
            
            // æ–¹æ¡ˆ2ï¼šå°è¯•ä½¿ç”¨ACTION_SEARCH intent
            if (!intentHandled) {
                try {
                    val searchIntent = Intent(Intent.ACTION_SEARCH).apply {
                        `package` = appConfig.packageName
                        putExtra(android.app.SearchManager.QUERY, query)
                        addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
                    }
                    
                    if (searchIntent.resolveActivity(packageManager) != null) {
                        try {
                            startActivity(searchIntent)
                            Toast.makeText(this, "æ­£åœ¨æ‰“å¼€${appConfig.appName}æœç´¢ï¼š$query", Toast.LENGTH_SHORT).show()
                            Log.d(TAG, "é€šè¿‡ACTION_SEARCHè·³è½¬åˆ°${appConfig.appName}æœç´¢: $query")
                            return true
                        } catch (e: Exception) {
                            Log.w(TAG, "ACTION_SEARCHè·³è½¬å¤±è´¥: ${appConfig.appName}", e)
                        }
                    }
                } catch (e: Exception) {
                    Log.d(TAG, "ACTION_SEARCHä¸æ”¯æŒ: ${appConfig.appName}", e)
                }
            }
            
            // æ–¹æ¡ˆ3ï¼šå°è¯•ä½¿ç”¨ACTION_SEND intentï¼ˆå‘é€æ–‡æœ¬ï¼‰
            if (!intentHandled) {
                try {
                    val sendIntent = Intent(Intent.ACTION_SEND).apply {
                        type = "text/plain"
                        putExtra(Intent.EXTRA_TEXT, query)
                        setPackage(appConfig.packageName)
                        addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
                    }
                    
                    if (sendIntent.resolveActivity(packageManager) != null) {
                        try {
                            startActivity(sendIntent)
                            Toast.makeText(this, "æ­£åœ¨æ‰“å¼€${appConfig.appName}å¹¶å‘é€æ–‡æœ¬ï¼š$query", Toast.LENGTH_SHORT).show()
                            Log.d(TAG, "é€šè¿‡ACTION_SENDè·³è½¬åˆ°${appConfig.appName}: $query")
                            return true
                        } catch (e: Exception) {
                            Log.w(TAG, "ACTION_SENDè·³è½¬å¤±è´¥: ${appConfig.appName}", e)
                        }
                    }
                } catch (e: Exception) {
                    Log.d(TAG, "ACTION_SENDä¸æ”¯æŒ: ${appConfig.appName}", e)
                }
            }
            
            // æ‰€æœ‰æ–¹æ¡ˆéƒ½å¤±è´¥
            Log.w(TAG, "æ‰€æœ‰æœç´¢intentæ–¹æ¡ˆéƒ½å¤±è´¥: ${appConfig.appName}")
            return false
            
        } catch (e: Exception) {
            Log.e(TAG, "å°è¯•å¯åŠ¨åº”ç”¨æœç´¢å¤±è´¥: ${appConfig.appName}", e)
            return false
        }
    }
    
    /**
     * è·å–åº”ç”¨çš„ä¸“ç”¨æœç´¢URL scheme
     * æ ¹æ®åŒ…åè¿”å›æ­£ç¡®çš„æœç´¢ç»“æœé¡µé¢URL
     */
    private fun getAppSearchUrlScheme(packageName: String, query: String, encodedQuery: String): String? {
        return when (packageName) {
            // ç¤¾äº¤åª’ä½“ç±»
            "com.sina.weibo" -> "sinaweibo://searchall?q=$encodedQuery" // å¾®åš
            "com.xingin.xhs" -> "xhsdiscover://search/result/?keyword=$encodedQuery" // å°çº¢ä¹¦
            "com.zhihu.android" -> "zhihu://search?q=$encodedQuery" // çŸ¥ä¹
            "com.douban.frodo" -> "douban:///search?q=$encodedQuery" // è±†ç“£
            
            // è§†é¢‘ç±»
            "com.ss.android.ugc.aweme" -> "snssdk1128://search/tabs?keyword=$encodedQuery" // æŠ–éŸ³
            "tv.danmaku.bili" -> "bilibili://search?keyword=$encodedQuery" // å“”å“©å“”å“©
            "com.smile.gifmaker" -> "kwai://search?keyword=$encodedQuery" // å¿«æ‰‹
            "com.youku.phone" -> "youku://search?word=$encodedQuery" // ä¼˜é…·
            "com.iqiyi.app", "com.iqiyi.hd" -> "iqiyi://search?key=$encodedQuery" // çˆ±å¥‡è‰º
            "com.tencent.qqlive" -> "tenvideo://search?query=$encodedQuery" // è…¾è®¯è§†é¢‘
            
            // è´­ç‰©ç±»
            "com.taobao.taobao" -> "taobao://s.taobao.com/search?q=$encodedQuery" // æ·˜å®
            "com.tmall.wireless" -> "tmall://page.tm/search?q=$encodedQuery" // å¤©çŒ«
            "com.jingdong.app.mall" -> "openapp.jdmobile://virtual?params={\"des\":\"productList\",\"keyWord\":\"$encodedQuery\"}" // äº¬ä¸œ
            "com.xunmeng.pinduoduo" -> "pinduoduo://com.xunmeng.pinduoduo/search_result.html?search_key=$encodedQuery" // æ‹¼å¤šå¤š
            "com.taobao.fleamarket" -> "fleamarket://x_search_items?keyword=$encodedQuery" // é—²é±¼
            
            // ç”Ÿæ´»æœåŠ¡ç±»
            "com.sankuai.meituan" -> "imeituan://www.meituan.com/search?q=$encodedQuery" // ç¾å›¢
            "me.ele" -> "eleme://search?keyword=$encodedQuery" // é¥¿äº†ä¹ˆ
            "com.dianping.v1" -> "dianping://searchshoplist?keyword=$encodedQuery" // å¤§ä¼—ç‚¹è¯„
            
            // æµè§ˆå™¨ç±»
            "com.UCMobile" -> "ucbrowser://search?keyword=$encodedQuery" // UCæµè§ˆå™¨
            "com.tencent.mtt" -> "mttbrowser://search?query=$encodedQuery" // QQæµè§ˆå™¨
            "com.quark.browser" -> "quark://search?query=$encodedQuery" // å¤¸å…‹
            
            // éŸ³ä¹ç±»
            "com.tencent.qqmusic" -> "qqmusic://search?key=$encodedQuery" // QQéŸ³ä¹
            "com.netease.cloudmusic" -> "orpheus://search?keyword=$encodedQuery" // ç½‘æ˜“äº‘éŸ³ä¹
            
            // åœ°å›¾å¯¼èˆªç±»
            "com.autonavi.minimap" -> "androidamap://poi?sourceApplication=aifloatingball&keywords=$encodedQuery" // é«˜å¾·åœ°å›¾
            "com.tencent.map" -> "qqmap://search?keyword=$encodedQuery" // è…¾è®¯åœ°å›¾
            "com.baidu.BaiduMap" -> "baidumap://map/place/search?query=$encodedQuery" // ç™¾åº¦åœ°å›¾
            
            // åŠå…¬è½¯ä»¶ç±»
            "cn.wps.moffice_eng" -> "wps://search?keyword=$encodedQuery" // WPS Office
            "cn.wps.moffice" -> "wps://search?keyword=$encodedQuery" // WPS Office
            "cn.wps.xiaomi.launcher" -> "wps://search?keyword=$encodedQuery" // WPS Office
            "com.microsoft.office.onenote" -> "onenote://search?query=$encodedQuery" // Microsoft OneNote
            
            // æœç´¢å¼•æ“ä¸æµè§ˆå™¨ç±»
            "com.google.android.googlequicksearchbox" -> "google://search?q=$encodedQuery" // Googleæœç´¢
            "com.baidu.searchbox" -> "baiduboxapp://search?keyword=$encodedQuery" // ç™¾åº¦æœç´¢
            "com.sohu.inputmethod.sogou" -> "sogou://search?keyword=$encodedQuery" // æœç‹—æœç´¢
            "com.qihoo.browser" -> "qihoobrowser://search?keyword=$encodedQuery" // 360æµè§ˆå™¨
            "me.mycake.browser" -> "alook://search?q=$encodedQuery" // Alookæµè§ˆå™¨
            
            // AIæ™ºèƒ½æœç´¢ç±»
            "com.tiangong.search" -> "tiangong://search?query=$encodedQuery" // å¤©å·¥AIæœç´¢
            "com.metaso" -> "metaso://search?query=$encodedQuery" // ç§˜å¡”AIæœç´¢ï¼ˆMetaSoï¼‰
            "com.qihoo.aisearch" -> "qihooai://search?keyword=$encodedQuery" // 360AIæœç´¢
            "com.deepseek.chat" -> "deepseek://search?query=$encodedQuery" // DeepSeek
            "ai.perplexity.app.android" -> "perplexity://search?q=$encodedQuery" // Perplexity AI
            "com.mindsearch.app" -> "mindsearch://search?query=$encodedQuery" // MindSearch
            
            // è´­ç‰©ç”µå•†ç±»
            "com.achievo.vipshop" -> "vipshop://search?keyword=$encodedQuery" // å”¯å“ä¼š
            "com.dangdang.buy2" -> "dangdang://search?keyword=$encodedQuery" // å½“å½“
            "com.amazon.mShop.android.shopping" -> "amazon://search?query=$encodedQuery" // äºšé©¬é€Š
            "com.mogujie" -> "mogujie://search?keyword=$encodedQuery" // è˜‘è‡è¡—
            
            // å›¾ç‰‡ä¸è®¾è®¡ç±»
            "com.picsart.studio" -> "picsart://search?query=$encodedQuery" // PicsArt
            "com.canva.editor" -> "canva://search?query=$encodedQuery" // Canva
            "com.vsco.android" -> "vsco://search?query=$encodedQuery" // VSCO
            
            // å­¦ä¹ ä¸æ•™è‚²ç±»
            "cn.xuexi.android" -> "xuexi://search?keyword=$encodedQuery" // å­¦ä¹ å¼ºå›½
            "com.netease.edu.study" -> "icourse163://search?keyword=$encodedQuery" // ä¸­å›½å¤§å­¦MOOC
            "com.netease.open.iStudy" -> "neteaseopen://search?keyword=$encodedQuery" // ç½‘æ˜“å…¬å¼€è¯¾
            "com.shanbay.words" -> "shanbay://search?keyword=$encodedQuery" // æ‰‡è´å•è¯
            
            // å¥åº·åŒ»ç–—ç±»
            "com.dxy.pharmacy" -> "dxy://search?keyword=$encodedQuery" // ä¸é¦™åŒ»ç”Ÿ
            "com.gotokeep.keep" -> "keep://search?keyword=$encodedQuery" // Keep
            "com.boohee.one" -> "boohee://search?keyword=$encodedQuery" // è–„è·å¥åº·
            
            // æ–°é—»èµ„è®¯ç±»
            "com.ss.android.article.news" -> "snssdk141://search?keyword=$encodedQuery" // ä»Šæ—¥å¤´æ¡
            "com.thepaper.cn" -> "thepaper://search?keyword=$encodedQuery" // æ¾æ¹ƒæ–°é—»
            "com.netease.newsreader.activity" -> "netease://search?keyword=$encodedQuery" // ç½‘æ˜“æ–°é—»
            "com.tencent.news" -> "tencentnews://search?keyword=$encodedQuery" // è…¾è®¯æ–°é—»
            
            // å¼€å‘å·¥å…·ç±»
            "com.microsoft.vscode" -> "vscode://search?query=$encodedQuery" // Visual Studio Code
            "com.google.android.studio" -> "androidstudio://search?query=$encodedQuery" // Android Studio
            "com.sublimetext.three" -> "sublime://search?query=$encodedQuery" // Sublime Text
            
            else -> null // æœªçŸ¥åº”ç”¨ï¼Œè¿”å›nullä½¿ç”¨å…¶ä»–æ–¹æ¡ˆ
        }
    }
    
    /**
     * åˆ¤æ–­æ˜¯å¦ä¸ºAIåº”ç”¨
     */
    private fun isAIApp(appConfig: AppSearchConfig): Boolean {
        return appConfig.category == AppCategory.AI || 
               appConfig.appId in listOf(
                   "deepseek", "doubao", "chatgpt", "kimi", "tencent_yuanbao",
                   "xinghuo", "zhipu_qingyan", "tongyi", "wenxiaoyan", 
                   "grok", "perplexity", "manus", "mita_ai", "poe", "ima", "nano_ai", "gemini", "copilot"
               )
    }

    /**
     * å¤„ç†AIåº”ç”¨ç›´æ¥æé—®
     */
    private fun handleAIDirectQuestion(appConfig: AppSearchConfig, query: String) {
        try {
            Log.d(TAG, "å¤„ç†AIåº”ç”¨ç›´æ¥æé—®: ${appConfig.appName}, é—®é¢˜: $query")
            
            // é¦–å…ˆæ£€æŸ¥åº”ç”¨æ˜¯å¦å·²å®‰è£…
            if (!isAppInstalled(appConfig.packageName)) {
                Log.w(TAG, "AIåº”ç”¨æœªå®‰è£…: ${appConfig.appName} (${appConfig.packageName})")
                showAppNotInstalledDialog(appConfig)
                return
            }
            
            when (appConfig.appId) {
                "deepseek" -> sendToDeepSeek(query)
                "doubao" -> sendToDouBao(query)
                "chatgpt" -> sendToChatGPT(query)
                "kimi" -> sendToKimi(query)
                "tencent_yuanbao" -> sendToYuanBao(query)
                "xinghuo" -> sendToXingHuo(query)
                "zhipu_qingyan" -> sendToZhipuQingyan(query)
                "tongyi" -> sendToTongyi(query)
                "wenxiaoyan" -> sendToWenxiaoyan(query)
                "grok" -> sendToGrok(query)
                "perplexity" -> sendToPerplexity(query)
                "manus" -> sendToManus(query)
                "mita_ai" -> sendToMita(query)
                "poe" -> sendToPoe(query)
                "ima" -> sendToIma(query)
                "nano_ai" -> sendToNano(query)
                "gemini" -> sendToGemini(query)
                "copilot" -> sendToCopilot(query)
                else -> {
                    // é€šç”¨æ–¹æ³•ï¼šå°è¯•é€šè¿‡Intentå‘é€æ–‡æœ¬
                    sendTextToApp(appConfig.packageName, query, appConfig.appName)
                }
            }
            
            // ä¿å­˜æœç´¢å†å²ï¼ˆåŸæœ‰ç³»ç»Ÿï¼‰
            searchHistoryManager.addSearchHistory(query, appConfig.appName, appConfig.packageName)
            
            // è®°å½•åˆ°ç»Ÿä¸€æ”¶è—ç®¡ç†ç³»ç»Ÿ
            com.example.aifloatingball.manager.SearchHistoryAutoRecorder.recordSearchHistory(
                context = this,
                query = query,
                source = com.example.aifloatingball.manager.SearchHistoryAutoRecorder.SearchSource.APP_TAB,
                tags = listOf(appConfig.appName), // æ·»åŠ åº”ç”¨åç§°ä½œä¸ºæ ‡ç­¾
                searchType = "åº”ç”¨æœç´¢"
            )
            
            // ä¸å†è‡ªåŠ¨æ˜¾ç¤ºAIAppOverlayServiceé¢æ¿ï¼Œç”±ç”¨æˆ·æ‰‹åŠ¨è§¦å‘
            
        } catch (e: Exception) {
            Log.e(TAG, "AIç›´æ¥æé—®å¤±è´¥: ${appConfig.appName}", e)
            handleAIError(appConfig, e)
        }
    }

    /**
     * å‘é€æ–‡æœ¬åˆ°DeepSeek
     */
    private fun sendToDeepSeek(query: String) {
        val possiblePackages = listOf(
            "com.deepseek.chat", // ä¸»è¦åŒ…å
            "com.deepseek.ai",
            "ai.deepseek.chat",
            "com.deepseek.mobile"
        )
        launchAIAppWithAutoPaste("DeepSeek", possiblePackages, query)
    }

    /**
     * å‘é€æ–‡æœ¬åˆ°è±†åŒ…
     */
    private fun sendToDouBao(query: String) {
        try {
            // æ–¹æ¡ˆ1ï¼šå°è¯•é€šè¿‡Intentç›´æ¥å‘é€
            val intent = Intent(Intent.ACTION_SEND).apply {
                type = "text/plain"
                putExtra(Intent.EXTRA_TEXT, query)
                setPackage("com.larus.nova")
                addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
            }
            
            if (intent.resolveActivity(packageManager) != null) {
                startActivity(intent)
                Toast.makeText(this, "æ­£åœ¨å‘è±†åŒ…å‘é€é—®é¢˜...", Toast.LENGTH_SHORT).show()
                Log.d(TAG, "è±†åŒ…Intentå‘é€æˆåŠŸ")
                return
            }
            
            // æ–¹æ¡ˆ2ï¼šå¦‚æœIntentå¤±è´¥ï¼Œä½¿ç”¨å‰ªè´´æ¿æ–¹æ¡ˆ
            sendQuestionViaClipboard("com.larus.nova", query, "è±†åŒ…")
            
        } catch (e: Exception) {
            Log.e(TAG, "è±†åŒ…å‘é€å¤±è´¥", e)
            sendQuestionViaClipboard("com.larus.nova", query, "è±†åŒ…")
        }
    }

    /**
     * å‘é€æ–‡æœ¬åˆ°ChatGPT
     */
    private fun sendToChatGPT(query: String) {
        try {
            // æ–¹æ¡ˆ1ï¼šå°è¯•é€šè¿‡Intentç›´æ¥å‘é€
            val intent = Intent(Intent.ACTION_SEND).apply {
                type = "text/plain"
                putExtra(Intent.EXTRA_TEXT, query)
                setPackage("com.openai.chatgpt")
                addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
            }
            
            if (intent.resolveActivity(packageManager) != null) {
                startActivity(intent)
                Toast.makeText(this, "æ­£åœ¨å‘ChatGPTå‘é€é—®é¢˜...", Toast.LENGTH_SHORT).show()
                Log.d(TAG, "ChatGPT Intentå‘é€æˆåŠŸ")
                return
            }
            
            // æ–¹æ¡ˆ2ï¼šå¦‚æœIntentå¤±è´¥ï¼Œä½¿ç”¨å‰ªè´´æ¿æ–¹æ¡ˆ
            sendQuestionViaClipboard("com.openai.chatgpt", query, "ChatGPT")
            
        } catch (e: Exception) {
            Log.e(TAG, "ChatGPTå‘é€å¤±è´¥", e)
            sendQuestionViaClipboard("com.openai.chatgpt", query, "ChatGPT")
        }
    }

    /**
     * å‘é€æ–‡æœ¬åˆ°Kimi
     */
    private fun sendToKimi(query: String) {
        try {
            // æ–¹æ¡ˆ1ï¼šå°è¯•é€šè¿‡Intentç›´æ¥å‘é€
            val intent = Intent(Intent.ACTION_SEND).apply {
                type = "text/plain"
                putExtra(Intent.EXTRA_TEXT, query)
                setPackage("com.moonshot.kimichat")
                addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
            }
            
            if (intent.resolveActivity(packageManager) != null) {
                startActivity(intent)
                Toast.makeText(this, "æ­£åœ¨å‘Kimiå‘é€é—®é¢˜...", Toast.LENGTH_SHORT).show()
                Log.d(TAG, "Kimi Intentå‘é€æˆåŠŸ")
                return
            }
            
            // æ–¹æ¡ˆ2ï¼šå°è¯•å¯åŠ¨åº”ç”¨å¹¶ä½¿ç”¨è‡ªåŠ¨åŒ–ç²˜è´´
            launchAppWithAutoPaste("com.moonshot.kimichat", query, "Kimi")
            
        } catch (e: Exception) {
            Log.e(TAG, "Kimiå‘é€å¤±è´¥", e)
            launchAppWithAutoPaste("com.moonshot.kimichat", query, "Kimi")
        }
    }

    /**
     * å‘é€æ–‡æœ¬åˆ°è…¾è®¯å…ƒå®
     */
    private fun sendToYuanBao(query: String) {
        try {
            // æ–¹æ¡ˆ1ï¼šå°è¯•é€šè¿‡Intentç›´æ¥å‘é€
            val intent = Intent(Intent.ACTION_SEND).apply {
                type = "text/plain"
                putExtra(Intent.EXTRA_TEXT, query)
                setPackage("com.tencent.hunyuan.app.chat")
                addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
            }
            
            if (intent.resolveActivity(packageManager) != null) {
                startActivity(intent)
                Toast.makeText(this, "æ­£åœ¨å‘è…¾è®¯å…ƒå®å‘é€é—®é¢˜...", Toast.LENGTH_SHORT).show()
                Log.d(TAG, "è…¾è®¯å…ƒå®Intentå‘é€æˆåŠŸ")
                return
            }
            
            // æ–¹æ¡ˆ2ï¼šå¦‚æœIntentå¤±è´¥ï¼Œä½¿ç”¨å‰ªè´´æ¿æ–¹æ¡ˆ
            sendQuestionViaClipboard("com.tencent.hunyuan.app.chat", query, "è…¾è®¯å…ƒå®")
            
        } catch (e: Exception) {
            Log.e(TAG, "è…¾è®¯å…ƒå®å‘é€å¤±è´¥", e)
            sendQuestionViaClipboard("com.tencent.hunyuan.app.chat", query, "è…¾è®¯å…ƒå®")
        }
    }

    /**
     * å‘é€æ–‡æœ¬åˆ°è®¯é£æ˜Ÿç«
     */
    private fun sendToXingHuo(query: String) {
        try {
            val intent = Intent(Intent.ACTION_SEND).apply {
                type = "text/plain"
                putExtra(Intent.EXTRA_TEXT, query)
                setPackage("com.iflytek.voiceassistant")
                addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
            }
            
            if (intent.resolveActivity(packageManager) != null) {
                startActivity(intent)
                Toast.makeText(this, "æ­£åœ¨å‘è®¯é£æ˜Ÿç«å‘é€é—®é¢˜...", Toast.LENGTH_SHORT).show()
                Log.d(TAG, "è®¯é£æ˜Ÿç«Intentå‘é€æˆåŠŸ")
                return
            }
            
            sendQuestionViaClipboard("com.iflytek.voiceassistant", query, "è®¯é£æ˜Ÿç«")
            
        } catch (e: Exception) {
            Log.e(TAG, "è®¯é£æ˜Ÿç«å‘é€å¤±è´¥", e)
            sendQuestionViaClipboard("com.iflytek.voiceassistant", query, "è®¯é£æ˜Ÿç«")
        }
    }

    /**
     * å‘é€æ–‡æœ¬åˆ°æ™ºè°±æ¸…è¨€
     */
    private fun sendToZhipuQingyan(query: String) {
        val possiblePackages = listOf(
            "com.zhipuai.qingyan", // ä¸»è¦åŒ…å
            "com.zhipuai.chat",
            "cn.zhipuai.qingyan",
            "com.zhipuai.mobile",
            "com.zhipuai.app"
        )
        launchAIAppWithAutoPaste("æ™ºè°±æ¸…è¨€", possiblePackages, query)
    }

    /**
     * å‘é€æ–‡æœ¬åˆ°é€šä¹‰åƒé—®
     */
    private fun sendToTongyi(query: String) {
        try {
            val intent = Intent(Intent.ACTION_SEND).apply {
                type = "text/plain"
                putExtra(Intent.EXTRA_TEXT, query)
                setPackage("com.alibaba.damo.tongyi")
                addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
            }
            
            if (intent.resolveActivity(packageManager) != null) {
                startActivity(intent)
                Toast.makeText(this, "æ­£åœ¨å‘é€šä¹‰åƒé—®å‘é€é—®é¢˜...", Toast.LENGTH_SHORT).show()
                Log.d(TAG, "é€šä¹‰åƒé—®Intentå‘é€æˆåŠŸ")
                return
            }
            
            sendQuestionViaClipboard("com.alibaba.damo.tongyi", query, "é€šä¹‰åƒé—®")
            
        } catch (e: Exception) {
            Log.e(TAG, "é€šä¹‰åƒé—®å‘é€å¤±è´¥", e)
            sendQuestionViaClipboard("com.alibaba.damo.tongyi", query, "é€šä¹‰åƒé—®")
        }
    }

    /**
     * å‘é€æ–‡æœ¬åˆ°æ–‡å°è¨€
     */
    private fun sendToWenxiaoyan(query: String) {
        val possiblePackages = listOf(
            "com.baidu.newapp", // æ–‡å°è¨€çœŸå®åŒ…å
            "com.baidu.wenxiaoyan", // å¤‡ç”¨åŒ…å
            "com.volcengine.doubao", // è±†åŒ…æµ·å¤–ç‰ˆ
            "com.larus.nova", // è±†åŒ…
            "com.volcengine.ark", // è±†åŒ…
            "com.volcengine.arklite" // è±†åŒ…è½»é‡ç‰ˆ
        )
        launchAIAppUniversal("æ–‡å°è¨€", possiblePackages, query)
    }

    /**
     * å‘é€æ–‡æœ¬åˆ°Grok
     */
    private fun sendToGrok(query: String) {
        val possiblePackages = listOf(
            "ai.x.grok", // çœŸå®åŒ…å
            "com.xai.grok",
            "com.xai.grok.app",
            "com.xai.grok.android"
        )
        launchAIAppWithAutoPaste("Grok", possiblePackages, query)
    }

    /**
     * å‘é€æ–‡æœ¬åˆ°Perplexity
     */
    private fun sendToPerplexity(query: String) {
        val possiblePackages = listOf(
            "ai.perplexity.app.android", // çœŸå®åŒ…å
            "ai.perplexity.app",
            "com.perplexity.app",
            "ai.perplexity.mobile",
            "com.perplexity.app.android"
        )
        launchAIAppUniversal("Perplexity", possiblePackages, query)
    }


    /**
     * å‘é€æ–‡æœ¬åˆ°Gemini
     */
    private fun sendToGemini(query: String) {
        try {
            val intent = Intent(Intent.ACTION_SEND).apply {
                type = "text/plain"
                putExtra(Intent.EXTRA_TEXT, query)
                setPackage("com.google.android.apps.bard")
                addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
            }
            
            if (intent.resolveActivity(packageManager) != null) {
                startActivity(intent)
                Toast.makeText(this, "æ­£åœ¨å‘Geminiå‘é€é—®é¢˜...", Toast.LENGTH_SHORT).show()
                Log.d(TAG, "Gemini Intentå‘é€æˆåŠŸ")
                return
            }
            
            sendQuestionViaClipboard("com.google.android.apps.bard", query, "Gemini")
            
        } catch (e: Exception) {
            Log.e(TAG, "Geminiå‘é€å¤±è´¥", e)
            sendQuestionViaClipboard("com.google.android.apps.bard", query, "Gemini")
        }
    }

    /**
     * å‘é€æ–‡æœ¬åˆ°Copilot
     */
    private fun sendToCopilot(query: String) {
        try {
            val intent = Intent(Intent.ACTION_SEND).apply {
                type = "text/plain"
                putExtra(Intent.EXTRA_TEXT, query)
                setPackage("com.microsoft.copilot")
                addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
            }
            
            if (intent.resolveActivity(packageManager) != null) {
                startActivity(intent)
                Toast.makeText(this, "æ­£åœ¨å‘Copilotå‘é€é—®é¢˜...", Toast.LENGTH_SHORT).show()
                Log.d(TAG, "Copilot Intentå‘é€æˆåŠŸ")
                return
            }
            
            sendQuestionViaClipboard("com.microsoft.copilot", query, "Copilot")
            
        } catch (e: Exception) {
            Log.e(TAG, "Copilotå‘é€å¤±è´¥", e)
            sendQuestionViaClipboard("com.microsoft.copilot", query, "Copilot")
        }
    }

    /**
     * å‘é€æ–‡æœ¬åˆ°Manus
     */
    private fun sendToManus(query: String) {
        val possiblePackages = listOf(
            "tech.butterfly.app", // çœŸå®åŒ…å
            "com.manus.im.app",
            "com.manus.search",
            "com.manus.app",
            "com.manus.ai",
            "com.manus.openai",
            "com.manus.mobile",
            "com.manus.butterfly"
        )
        launchAIAppWithAutoPaste("Manus", possiblePackages, query)
    }

    /**
     * å‘é€æ–‡æœ¬åˆ°ç§˜å¡”AIæœç´¢
     */
    private fun sendToMita(query: String) {
        val possiblePackages = listOf(
            "com.metaso", // ç§˜å¡”AIæœç´¢çœŸå®åŒ…å
            "com.mita.ai", // å¤‡ç”¨åŒ…å
            "com.metaso.search",
            "com.mita.search",
            "com.metaso.ai",
            "com.mita.ai.search"
        )
        launchAIAppUniversal("ç§˜å¡”AIæœç´¢", possiblePackages, query)
    }


    /**
     * å‘é€æ–‡æœ¬åˆ°Poe
     */
    private fun sendToPoe(query: String) {
        val possiblePackages = listOf(
            "com.poe.android", // çœŸå®åŒ…å
            "com.quora.poe",
            "com.poe.app",
            "com.poe.mobile",
            "com.quora.poe.android"
        )
        launchAIAppWithAutoPaste("Poe", possiblePackages, query)
    }


    /**
     * å‘é€æ–‡æœ¬åˆ°IMA
     */
    private fun sendToIma(query: String) {
        val possiblePackages = listOf(
            "com.tencent.ima", // çœŸå®åŒ…å
            "com.tencent.ima.copilot",
            "com.ima.ai",
            "com.ima.app",
            "com.ima.mobile",
            "com.ima.android",
            "com.ima.ai.app"
        )
        launchAIAppUniversal("IMA", possiblePackages, query)
    }

    /**
     * å‘é€æ–‡æœ¬åˆ°çº³ç±³AI
     */
    private fun sendToNano(query: String) {
        val possiblePackages = listOf(
            "com.qihoo.namiso", // çœŸå®åŒ…å
            "com.qihoo.nanoai",
            "com.360.nanoai",
            "com.nanoai.app",
            "com.nano.ai",
            "com.nanoai.mobile",
            "com.nanoai.android",
            "com.nanoai.chat"
        )
        launchAIAppWithAutoPaste("çº³ç±³AI", possiblePackages, query)
    }


    /**
     * é€šç”¨æ–¹æ³•ï¼šå‘é€æ–‡æœ¬åˆ°æŒ‡å®šåº”ç”¨
     */
    private fun sendTextToApp(packageName: String, query: String, appName: String) {
        try {
            // æ–¹æ¡ˆ1ï¼šå°è¯•é€šè¿‡ACTION_SENDå‘é€
            val sendIntent = Intent(Intent.ACTION_SEND).apply {
                type = "text/plain"
                putExtra(Intent.EXTRA_TEXT, query)
                setPackage(packageName)
                addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
            }
            
            if (sendIntent.resolveActivity(packageManager) != null) {
                startActivity(sendIntent)
                Toast.makeText(this, "æ­£åœ¨å‘${appName}å‘é€é—®é¢˜...", Toast.LENGTH_SHORT).show()
                Log.d(TAG, "${appName} Intentå‘é€æˆåŠŸ")
                return
            }
            
            // æ–¹æ¡ˆ2ï¼šå¦‚æœIntentå¤±è´¥ï¼Œä½¿ç”¨å‰ªè´´æ¿æ–¹æ¡ˆ
            sendQuestionViaClipboard(packageName, query, appName)
            
        } catch (e: Exception) {
            Log.e(TAG, "å‘é€æ–‡æœ¬åˆ°${appName}å¤±è´¥", e)
            sendQuestionViaClipboard(packageName, query, appName)
        }
    }

    /**
     * é€šè¿‡å‰ªè´´æ¿ä¼ é€’é—®é¢˜åˆ°AIåº”ç”¨
     */
    private fun sendQuestionViaClipboard(packageName: String, query: String, appName: String) {
        try {
            // å°†é—®é¢˜å¤åˆ¶åˆ°å‰ªè´´æ¿
            val clipboard = getSystemService(Context.CLIPBOARD_SERVICE) as ClipboardManager
            val clip = ClipData.newPlainText("AIé—®é¢˜", query)
            clipboard.setPrimaryClip(clip)
            
            // å¯åŠ¨AIåº”ç”¨
            val launchIntent = packageManager.getLaunchIntentForPackage(packageName)
            if (launchIntent != null) {
                launchIntent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
                startActivity(launchIntent)
                Toast.makeText(this, "å·²å¤åˆ¶é—®é¢˜åˆ°å‰ªè´´æ¿ï¼Œè¯·ç²˜è´´åˆ°${appName}çš„è¾“å…¥æ¡†ä¸­", Toast.LENGTH_LONG).show()
                Log.d(TAG, "å‰ªè´´æ¿ä¼ é€’æˆåŠŸ: ${appName}")
            } else {
                Toast.makeText(this, "æ— æ³•å¯åŠ¨${appName}ï¼Œè¯·æ£€æŸ¥åº”ç”¨æ˜¯å¦å·²å®‰è£…", Toast.LENGTH_SHORT).show()
            }
        } catch (e: Exception) {
            Log.e(TAG, "å‰ªè´´æ¿ä¼ é€’å¤±è´¥: ${appName}", e)
            Toast.makeText(this, "ä¼ é€’å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥é—®é¢˜", Toast.LENGTH_SHORT).show()
        }
    }

    /**
     * å¤„ç†AIåº”ç”¨é”™è¯¯
     */
    private fun handleAIError(appConfig: AppSearchConfig, e: Exception) {
        Log.e(TAG, "AIåº”ç”¨æ“ä½œå¤±è´¥: ${appConfig.appName}", e)
        
        // æ ¹æ®é”™è¯¯ç±»å‹æä¾›ä¸åŒçš„æç¤º
        val errorMessage = when {
            e is SecurityException -> "æƒé™ä¸è¶³ï¼Œè¯·æ£€æŸ¥åº”ç”¨æƒé™è®¾ç½®"
            e is ActivityNotFoundException -> "${appConfig.appName}æœªå®‰è£…æˆ–æ— æ³•å¯åŠ¨"
            e.message?.contains("NameNotFoundException") == true -> 
                "${appConfig.appName}æœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…è¯¥åº”ç”¨"
            e.message?.contains("SecurityException") == true -> 
                "æ²¡æœ‰æƒé™å¯åŠ¨${appConfig.appName}ï¼Œè¯·æ£€æŸ¥åº”ç”¨æƒé™è®¾ç½®"
            else -> "å¯åŠ¨${appConfig.appName}å¤±è´¥: ${e.message}"
        }
        
        Toast.makeText(this, errorMessage, Toast.LENGTH_LONG).show()
        
        // å°è¯•ä½¿ç”¨å‰ªè´´æ¿å¤‡ç”¨æ–¹æ¡ˆ
        sendQuestionViaClipboard(appConfig.packageName, "", appConfig.appName)
    }
    
    /**
     * æ˜¾ç¤ºåº”ç”¨æœªå®‰è£…å¯¹è¯æ¡†
     */
    /**
     * åˆ›å»ºæ”¯æŒæš—è‰²/äº®è‰²æ¨¡å¼çš„å¯¹è¯æ¡†æ„å»ºå™¨
     */
    private fun createThemedDialogBuilder(): AlertDialog.Builder {
        return AlertDialog.Builder(this, R.style.Theme_MaterialDialog)
    }
    
    /**
     * æ˜¾ç¤ºVoskæ¨¡å‹é€‰æ‹©å¯¹è¯æ¡†
     */
    private fun showVoskModelSelectionDialog() {
        val dialogView = LayoutInflater.from(this).inflate(R.layout.dialog_vosk_model_selection, null)
        val smallModelRadio = dialogView.findViewById<RadioButton>(R.id.radio_small_model)
        val fullModelRadio = dialogView.findViewById<RadioButton>(R.id.radio_full_model)
        val modelDescription = dialogView.findViewById<TextView>(R.id.model_description)
        
        // é»˜è®¤é€‰æ‹©å°æ¨¡å‹
        smallModelRadio.isChecked = true
        updateModelDescription(modelDescription, VoskManager.ModelType.SMALL)
        
        // ç›‘å¬å•é€‰æŒ‰é’®å˜åŒ–
        smallModelRadio.setOnCheckedChangeListener { _, isChecked ->
            if (isChecked) {
                updateModelDescription(modelDescription, VoskManager.ModelType.SMALL)
            }
        }
        
        fullModelRadio.setOnCheckedChangeListener { _, isChecked ->
            if (isChecked) {
                updateModelDescription(modelDescription, VoskManager.ModelType.FULL)
            }
        }
        
        val dialog = createThemedDialogBuilder()
            .setTitle("é€‰æ‹©Voskç¦»çº¿è¯­éŸ³æ¨¡å‹")
            .setView(dialogView)
            .setPositiveButton("ä¸‹è½½å¹¶æ¿€æ´»") { _, _ ->
                val selectedModelType = if (smallModelRadio.isChecked) {
                    VoskManager.ModelType.SMALL
                } else {
                    VoskManager.ModelType.FULL
                }
                // ä¿å­˜é€‰æ‹©çš„æ¨¡å‹ç±»å‹
                settingsManager.putString("vosk_model_type", if (selectedModelType == VoskManager.ModelType.SMALL) "SMALL" else "FULL")
                // å¯ç”¨Vosk
                settingsManager.putBoolean("use_vosk_offline_voice", true)
                // å¼€å§‹ä¸‹è½½æ¨¡å‹
                startVoskModelDownload(selectedModelType)
            }
            .setNegativeButton("å–æ¶ˆ") { _, _ ->
                // å–æ¶ˆæ—¶å…³é—­å¼€å…³
                voskOfflineVoiceSwitch.isChecked = false
            }
            .setCancelable(false)
            .create()
        
        dialog.show()
    }
    
    /**
     * æ›´æ–°æ¨¡å‹æè¿°æ–‡æœ¬
     */
    private fun updateModelDescription(textView: TextView, modelType: VoskManager.ModelType) {
        val voskManager = VoskManager(this)
        val modelSize = voskManager.getModelSize(modelType)
        val description = when (modelType) {
            VoskManager.ModelType.SMALL -> {
                "å°æ¨¡å‹ï¼ˆçº¦${modelSize}MBï¼‰\n" +
                "â€¢ ä¸‹è½½é€Ÿåº¦å¿«\n" +
                "â€¢ å ç”¨å­˜å‚¨ç©ºé—´å°\n" +
                "â€¢ è¯†åˆ«ç²¾åº¦ä¸­ç­‰\n" +
                "â€¢ é€‚åˆæ—¥å¸¸ä½¿ç”¨"
            }
            VoskManager.ModelType.FULL -> {
                "å®Œæ•´æ¨¡å‹ï¼ˆçº¦${modelSize}MBï¼‰\n" +
                "â€¢ è¯†åˆ«ç²¾åº¦é«˜\n" +
                "â€¢ æ”¯æŒæ›´å¤šè¯æ±‡\n" +
                "â€¢ éœ€è¦æ›´å¤šå­˜å‚¨ç©ºé—´\n" +
                "â€¢ å»ºè®®åœ¨WiFiç¯å¢ƒä¸‹ä¸‹è½½"
            }
        }
        textView.text = description
    }
    
    /**
     * æ›´æ–°è¯­éŸ³æ¨¡å‹çŠ¶æ€æ˜¾ç¤º
     */
    private fun updateVoiceModelStatus() {
        try {
            val useVosk = settingsManager.getBoolean("use_vosk_offline_voice", false)
            val voskManager = VoskManager(this)
            
            val statusText = if (useVosk) {
                // ä½¿ç”¨Voskç¦»çº¿è¯†åˆ«
                val downloadedTypes = voskManager.getDownloadedModelTypes()
                val currentModelType = voskManager.getCurrentModelType()
                
                if (downloadedTypes.isEmpty()) {
                    "å½“å‰åŠ è½½ï¼šVoskæ¨¡å‹æœªä¸‹è½½"
                } else {
                    val modelSize = voskManager.getModelSize(currentModelType)
                    val actualSize = voskManager.getDownloadedModelSize(currentModelType)
                    when (currentModelType) {
                        VoskManager.ModelType.SMALL -> {
                            if (actualSize > 0) {
                                "å½“å‰åŠ è½½ï¼šVoskå°æ¨¡å‹ (${actualSize}MB)"
                            } else {
                                "å½“å‰åŠ è½½ï¼šVoskå°æ¨¡å‹ (${modelSize}MB)"
                            }
                        }
                        VoskManager.ModelType.FULL -> {
                            if (actualSize > 0) {
                                "å½“å‰åŠ è½½ï¼šVoskå®Œæ•´æ¨¡å‹ (${actualSize}MB)"
                            } else {
                                "å½“å‰åŠ è½½ï¼šVoskå®Œæ•´æ¨¡å‹ (${modelSize}MB)"
                            }
                        }
                    }
                }
            } else {
                // ä½¿ç”¨ç³»ç»Ÿè¯­éŸ³è¯†åˆ«
                "å½“å‰åŠ è½½ï¼šç³»ç»Ÿè¯­éŸ³è¯†åˆ«"
            }
            
            voiceModelStatusText?.text = statusText
            
            // åŒæ­¥æ›´æ–°åˆ‡æ¢å™¨çŠ¶æ€
            updateVoiceModelSegmentedControl()
            
            Log.d(TAG, "æ¨¡å‹çŠ¶æ€å·²æ›´æ–°: $statusText")
        } catch (e: Exception) {
            Log.e(TAG, "æ›´æ–°æ¨¡å‹çŠ¶æ€å¤±è´¥", e)
            voiceModelStatusText?.text = "å½“å‰åŠ è½½ï¼šç³»ç»Ÿè¯­éŸ³è¯†åˆ«"
            // åŒæ­¥æ›´æ–°åˆ‡æ¢å™¨çŠ¶æ€
            updateVoiceModelSegmentedControl()
        }
    }
    
    /**
     * æ˜¾ç¤ºè¯­éŸ³æ¨¡å‹ç®¡ç†å¯¹è¯æ¡†
     */
    private fun showVoiceModelManagementDialog() {
        val voskManager = VoskManager(this)
        val useVosk = settingsManager.getBoolean("use_vosk_offline_voice", false)
        val downloadedTypes = voskManager.getDownloadedModelTypes()
        val currentModelType = voskManager.getCurrentModelType()
        
        val dialogView = LayoutInflater.from(this).inflate(R.layout.dialog_voice_model_management, null)
        val modelInfoText = dialogView.findViewById<TextView>(R.id.model_info_text)
        val smallModelCard = dialogView.findViewById<MaterialCardView>(R.id.small_model_card)
        val fullModelCard = dialogView.findViewById<MaterialCardView>(R.id.full_model_card)
        val smallModelStatus = dialogView.findViewById<TextView>(R.id.small_model_status)
        val fullModelStatus = dialogView.findViewById<TextView>(R.id.full_model_status)
        val smallModelSize = dialogView.findViewById<TextView>(R.id.small_model_size)
        val fullModelSize = dialogView.findViewById<TextView>(R.id.full_model_size)
        val smallModelDeleteBtn = dialogView.findViewById<MaterialButton>(R.id.small_model_delete_btn)
        val fullModelDeleteBtn = dialogView.findViewById<MaterialButton>(R.id.full_model_delete_btn)
        val useSystemVoiceBtn = dialogView.findViewById<MaterialButton>(R.id.use_system_voice_btn)
        
        // æ›´æ–°æ¨¡å‹ä¿¡æ¯
        val infoText = if (useVosk) {
            val modelSize = voskManager.getModelSize(currentModelType)
            val actualSize = voskManager.getDownloadedModelSize(currentModelType)
            when (currentModelType) {
                VoskManager.ModelType.SMALL -> "å½“å‰ä½¿ç”¨: Voskå°æ¨¡å‹ (${if (actualSize > 0) "${actualSize}MB" else "${modelSize}MB"})"
                VoskManager.ModelType.FULL -> "å½“å‰ä½¿ç”¨: Voskå®Œæ•´æ¨¡å‹ (${if (actualSize > 0) "${actualSize}MB" else "${modelSize}MB"})"
            }
        } else {
            "å½“å‰ä½¿ç”¨: ç³»ç»Ÿè¯­éŸ³è¯†åˆ«"
        }
        modelInfoText.text = infoText
        
        // æ›´æ–°å°æ¨¡å‹çŠ¶æ€
        val hasSmallModel = downloadedTypes.contains(VoskManager.ModelType.SMALL)
        if (hasSmallModel) {
            val size = voskManager.getDownloadedModelSize(VoskManager.ModelType.SMALL)
            smallModelStatus.text = "å·²ä¸‹è½½"
            smallModelSize.text = "${size}MB"
            smallModelDeleteBtn.isEnabled = true
            smallModelDeleteBtn.visibility = View.VISIBLE
        } else {
            smallModelStatus.text = "æœªä¸‹è½½"
            smallModelSize.text = "${voskManager.getModelSize(VoskManager.ModelType.SMALL)}MB"
            smallModelDeleteBtn.isEnabled = false
            smallModelDeleteBtn.visibility = View.GONE
        }
        
        // æ›´æ–°å®Œæ•´æ¨¡å‹çŠ¶æ€
        val hasFullModel = downloadedTypes.contains(VoskManager.ModelType.FULL)
        if (hasFullModel) {
            val size = voskManager.getDownloadedModelSize(VoskManager.ModelType.FULL)
            fullModelStatus.text = "å·²ä¸‹è½½"
            fullModelSize.text = "${size}MB"
            fullModelDeleteBtn.isEnabled = true
            fullModelDeleteBtn.visibility = View.VISIBLE
        } else {
            fullModelStatus.text = "æœªä¸‹è½½"
            fullModelSize.text = "${voskManager.getModelSize(VoskManager.ModelType.FULL)}MB"
            fullModelDeleteBtn.isEnabled = false
            fullModelDeleteBtn.visibility = View.GONE
        }
        
        // å°æ¨¡å‹å¡ç‰‡ç‚¹å‡» - åˆ‡æ¢åˆ°å°æ¨¡å‹
        smallModelCard.setOnClickListener {
            if (!hasSmallModel) {
                // æœªä¸‹è½½ï¼Œæ˜¾ç¤ºä¸‹è½½å¯¹è¯æ¡†
                settingsManager.putString("vosk_model_type", "SMALL")
                settingsManager.putBoolean("use_vosk_offline_voice", true)
                startVoskModelDownload(VoskManager.ModelType.SMALL)
            } else {
                // å·²ä¸‹è½½ï¼Œåˆ‡æ¢åˆ°å°æ¨¡å‹
                settingsManager.putString("vosk_model_type", "SMALL")
                settingsManager.putBoolean("use_vosk_offline_voice", true)
                Toast.makeText(this, "å·²åˆ‡æ¢åˆ°Voskå°æ¨¡å‹", Toast.LENGTH_SHORT).show()
                updateVoiceModelStatus()
            }
        }
        
        // å®Œæ•´æ¨¡å‹å¡ç‰‡ç‚¹å‡» - åˆ‡æ¢åˆ°å®Œæ•´æ¨¡å‹
        fullModelCard.setOnClickListener {
            if (!hasFullModel) {
                // æœªä¸‹è½½ï¼Œæ˜¾ç¤ºä¸‹è½½å¯¹è¯æ¡†
                settingsManager.putString("vosk_model_type", "FULL")
                settingsManager.putBoolean("use_vosk_offline_voice", true)
                startVoskModelDownload(VoskManager.ModelType.FULL)
            } else {
                // å·²ä¸‹è½½ï¼Œåˆ‡æ¢åˆ°å®Œæ•´æ¨¡å‹
                settingsManager.putString("vosk_model_type", "FULL")
                settingsManager.putBoolean("use_vosk_offline_voice", true)
                Toast.makeText(this, "å·²åˆ‡æ¢åˆ°Voskå®Œæ•´æ¨¡å‹", Toast.LENGTH_SHORT).show()
                updateVoiceModelStatus()
            }
        }
        
        // åˆ é™¤å°æ¨¡å‹
        smallModelDeleteBtn.setOnClickListener {
            createThemedDialogBuilder()
                .setTitle("åˆ é™¤å°æ¨¡å‹")
                .setMessage("ç¡®å®šè¦åˆ é™¤Voskå°æ¨¡å‹å—ï¼Ÿåˆ é™¤åéœ€è¦é‡æ–°ä¸‹è½½æ‰èƒ½ä½¿ç”¨ã€‚")
                .setPositiveButton("åˆ é™¤") { _, _ ->
                    if (voskManager.deleteModel(VoskManager.ModelType.SMALL)) {
                        Toast.makeText(this, "å°æ¨¡å‹å·²åˆ é™¤", Toast.LENGTH_SHORT).show()
                        updateVoiceModelStatus()
                        // å¦‚æœå½“å‰ä½¿ç”¨çš„æ˜¯å°æ¨¡å‹ï¼Œåˆ‡æ¢åˆ°ç³»ç»Ÿè¯­éŸ³
                        if (useVosk && currentModelType == VoskManager.ModelType.SMALL) {
                            settingsManager.putBoolean("use_vosk_offline_voice", false)
                            updateVoiceModelStatus()
                        }
                    } else {
                        Toast.makeText(this, "åˆ é™¤å¤±è´¥", Toast.LENGTH_SHORT).show()
                    }
                }
                .setNegativeButton("å–æ¶ˆ", null)
                .show()
        }
        
        // åˆ é™¤å®Œæ•´æ¨¡å‹
        fullModelDeleteBtn.setOnClickListener {
            createThemedDialogBuilder()
                .setTitle("åˆ é™¤å®Œæ•´æ¨¡å‹")
                .setMessage("ç¡®å®šè¦åˆ é™¤Voskå®Œæ•´æ¨¡å‹å—ï¼Ÿåˆ é™¤åéœ€è¦é‡æ–°ä¸‹è½½æ‰èƒ½ä½¿ç”¨ã€‚")
                .setPositiveButton("åˆ é™¤") { _, _ ->
                    if (voskManager.deleteModel(VoskManager.ModelType.FULL)) {
                        Toast.makeText(this, "å®Œæ•´æ¨¡å‹å·²åˆ é™¤", Toast.LENGTH_SHORT).show()
                        updateVoiceModelStatus()
                        // å¦‚æœå½“å‰ä½¿ç”¨çš„æ˜¯å®Œæ•´æ¨¡å‹ï¼Œåˆ‡æ¢åˆ°ç³»ç»Ÿè¯­éŸ³
                        if (useVosk && currentModelType == VoskManager.ModelType.FULL) {
                            settingsManager.putBoolean("use_vosk_offline_voice", false)
                            updateVoiceModelStatus()
                        }
                    } else {
                        Toast.makeText(this, "åˆ é™¤å¤±è´¥", Toast.LENGTH_SHORT).show()
                    }
                }
                .setNegativeButton("å–æ¶ˆ", null)
                .show()
        }
        
        // ä½¿ç”¨ç³»ç»Ÿè¯­éŸ³
        useSystemVoiceBtn.setOnClickListener {
            settingsManager.putBoolean("use_vosk_offline_voice", false)
            Toast.makeText(this, "å·²åˆ‡æ¢åˆ°ç³»ç»Ÿè¯­éŸ³è¯†åˆ«", Toast.LENGTH_SHORT).show()
            updateVoiceModelStatus()
        }
        
        val dialog = createThemedDialogBuilder()
            .setTitle("è¯­éŸ³æ¨¡å‹ç®¡ç†")
            .setView(dialogView)
            .setPositiveButton("å…³é—­", null)
            .create()
        
        dialog.show()
    }
    
    /**
     * å¼€å§‹ä¸‹è½½Voskæ¨¡å‹å¹¶æ˜¾ç¤ºè¿›åº¦
     */
    private fun startVoskModelDownload(modelType: VoskManager.ModelType) {
        // å¦‚æœå·²æœ‰å®ä¾‹ï¼Œå…ˆé‡Šæ”¾
        if (voskManager != null) {
            releaseVoskManager()
        }
        
        // åˆ›å»ºæ–°çš„VoskManagerå®ä¾‹å¹¶ä¿å­˜åˆ°æˆå‘˜å˜é‡
        this.voskManager = VoskManager(this)
        this.voskManager?.setModelType(modelType)
        
        // åˆ›å»ºä¸‹è½½è¿›åº¦å¯¹è¯æ¡†
        val progressDialogView = LayoutInflater.from(this).inflate(R.layout.dialog_vosk_download_progress, null)
        val progressBar = progressDialogView.findViewById<ProgressBar>(R.id.download_progress_bar)
        val progressText = progressDialogView.findViewById<TextView>(R.id.download_progress_text)
        val statusText = progressDialogView.findViewById<TextView>(R.id.download_status_text)
        
        progressBar.max = 100
        progressBar.progress = 0
        progressText.text = "0%"
        statusText.text = "å‡†å¤‡ä¸‹è½½æ¨¡å‹..."
        
        val progressDialog = createThemedDialogBuilder()
            .setTitle("ä¸‹è½½Voskæ¨¡å‹")
            .setView(progressDialogView)
            .setCancelable(false)
            .setNegativeButton("å–æ¶ˆ") { dialog, _ ->
                dialog.dismiss()
                voskOfflineVoiceSwitch.isChecked = false
                settingsManager.putBoolean("use_vosk_offline_voice", false)
            }
            .create()
        
        progressDialog.show()
        
        // è®¾ç½®Voskå›è°ƒä»¥æ›´æ–°è¿›åº¦
        this.voskManager?.setCallback(object : VoskManager.VoskCallback {
            override fun onPartialResult(text: String) {
                // ä¸‹è½½æ—¶ä¸éœ€è¦å¤„ç†éƒ¨åˆ†ç»“æœ
            }
            
            override fun onFinalResult(text: String) {
                // ä¸‹è½½æ—¶ä¸éœ€è¦å¤„ç†æœ€ç»ˆç»“æœ
            }
            
            override fun onError(error: String) {
                handler.post {
                    progressDialog.dismiss()
                    Toast.makeText(this@SimpleModeActivity, "æ¨¡å‹ä¸‹è½½å¤±è´¥: $error", Toast.LENGTH_LONG).show()
                    voskOfflineVoiceSwitch.isChecked = false
                    settingsManager.putBoolean("use_vosk_offline_voice", false)
                }
            }
            
            override fun onModelStatus(isReady: Boolean, message: String) {
                handler.post {
                    if (isReady) {
                        // æ¨¡å‹å·²å°±ç»ª
                        progressDialog.dismiss()
                        // æ ‡è®°ä¸ºå·²åˆå§‹åŒ–ï¼ˆå®ä¾‹å·²åœ¨æ–¹æ³•å¼€å§‹æ—¶ä¿å­˜ï¼‰
                        this@SimpleModeActivity.isVoskInitialized = true
                        showVoskActivationDialog()
                    } else {
                        // æ›´æ–°ä¸‹è½½è¿›åº¦
                        statusText.text = message
                        
                        // å°è¯•ä»æ¶ˆæ¯ä¸­æå–è¿›åº¦ç™¾åˆ†æ¯”
                        val progressMatch = Regex("(\\d+)%").find(message)
                        if (progressMatch != null) {
                            val progress = progressMatch.groupValues[1].toIntOrNull() ?: 0
                            progressBar.isIndeterminate = false
                            progressBar.progress = progress
                            progressText.text = "$progress%"
                        } else if (message.contains("ä¸‹è½½")) {
                            // æ­£åœ¨ä¸‹è½½ï¼Œæ˜¾ç¤ºä¸ç¡®å®šè¿›åº¦
                            progressBar.isIndeterminate = true
                            progressText.text = "ä¸‹è½½ä¸­..."
                        } else if (message.contains("åŠ è½½")) {
                            // æ­£åœ¨åŠ è½½æ¨¡å‹
                            progressBar.isIndeterminate = true
                            progressText.text = "åŠ è½½ä¸­..."
                        }
                    }
                }
            }
        })
        
        // åœ¨åå°åç¨‹ä¸­åˆå§‹åŒ–æ¨¡å‹ï¼ˆä¼šè‡ªåŠ¨ä¸‹è½½ï¼‰
        kotlinx.coroutines.CoroutineScope(kotlinx.coroutines.Dispatchers.Main).launch {
            try {
                this@SimpleModeActivity.voskManager?.initializeModel(true)
            } catch (e: Exception) {
                handler.post {
                    progressDialog.dismiss()
                    Toast.makeText(this@SimpleModeActivity, "æ¨¡å‹åˆå§‹åŒ–å¤±è´¥: ${e.message}", Toast.LENGTH_LONG).show()
                    voskOfflineVoiceSwitch.isChecked = false
                    settingsManager.putBoolean("use_vosk_offline_voice", false)
                }
            }
        }
    }
    
    /**
     * æ˜¾ç¤ºVoskæ¿€æ´»æç¤ºå¯¹è¯æ¡†
     */
    private fun showVoskActivationDialog() {
        createThemedDialogBuilder()
            .setTitle("Voskæ¨¡å‹å·²å°±ç»ª")
            .setMessage("Voskç¦»çº¿è¯­éŸ³è¯†åˆ«æ¨¡å‹å·²ä¸‹è½½å®Œæˆï¼\n\n" +
                    "ç°åœ¨æ‚¨å¯ä»¥ä½¿ç”¨ç¦»çº¿è¯­éŸ³è¯†åˆ«åŠŸèƒ½äº†ï¼š\n" +
                    "â€¢ æ— éœ€ç½‘ç»œè¿æ¥\n" +
                    "â€¢ ä¿æŠ¤éšç§\n" +
                    "â€¢ è¯†åˆ«é€Ÿåº¦å¿«\n\n" +
                    "ç‚¹å‡»è¯­éŸ³æŒ‰é’®å³å¯å¼€å§‹ä½¿ç”¨ã€‚")
            .setPositiveButton("çŸ¥é“äº†") { _, _ ->
                Toast.makeText(this, "Voskç¦»çº¿è¯­éŸ³è¯†åˆ«å·²æ¿€æ´»", Toast.LENGTH_SHORT).show()
            }
            .setCancelable(false)
            .show()
    }
    
    private fun showAppNotInstalledDialog(appConfig: AppSearchConfig) {
        val dialog = createThemedDialogBuilder()
            .setTitle("åº”ç”¨æœªå®‰è£…")
            .setMessage("${appConfig.appName}å°šæœªå®‰è£…ï¼Œæ˜¯å¦è¦ï¼š\n\n1. æ‰“å¼€åº”ç”¨å•†åº—å®‰è£…\n2. ä½¿ç”¨å‰ªè´´æ¿å¤‡ç”¨æ–¹æ¡ˆ\n3. å–æ¶ˆ")
            .setPositiveButton("æ‰“å¼€åº”ç”¨å•†åº—") { _, _ ->
                openAppStore(appConfig.packageName, appConfig.appName)
            }
            .setNeutralButton("å‰ªè´´æ¿æ–¹æ¡ˆ") { _, _ ->
                sendQuestionViaClipboard(appConfig.packageName, "", appConfig.appName)
                Toast.makeText(this, "é—®é¢˜å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼Œè¯·æ‰‹åŠ¨ç²˜è´´åˆ°${appConfig.appName}", Toast.LENGTH_LONG).show()
            }
            .setNegativeButton("å–æ¶ˆ", null)
            .create()
        
        dialog.show()
    }
    
    /**
     * æ‰“å¼€åº”ç”¨å•†åº—
     */
    private fun openAppStore(packageName: String, appName: String) {
        try {
            // å°è¯•æ‰“å¼€Google Play Store
            val playStoreIntent = Intent(Intent.ACTION_VIEW, Uri.parse("market://details?id=$packageName"))
            if (playStoreIntent.resolveActivity(packageManager) != null) {
                startActivity(playStoreIntent)
                Toast.makeText(this, "æ­£åœ¨æ‰“å¼€åº”ç”¨å•†åº—å®‰è£…$appName", Toast.LENGTH_SHORT).show()
                return
            }
            
            // å¤‡ç”¨æ–¹æ¡ˆï¼šæ‰“å¼€ç½‘é¡µç‰ˆåº”ç”¨å•†åº—
            val webIntent = Intent(Intent.ACTION_VIEW, Uri.parse("https://play.google.com/store/apps/details?id=$packageName"))
            startActivity(webIntent)
            Toast.makeText(this, "æ­£åœ¨æ‰“å¼€ç½‘é¡µç‰ˆåº”ç”¨å•†åº—", Toast.LENGTH_SHORT).show()
            
        } catch (e: Exception) {
            Log.e(TAG, "æ‰“å¼€åº”ç”¨å•†åº—å¤±è´¥", e)
            Toast.makeText(this, "æ— æ³•æ‰“å¼€åº”ç”¨å•†åº—ï¼Œè¯·æ‰‹åŠ¨æœç´¢å®‰è£…$appName", Toast.LENGTH_LONG).show()
        }
    }
    
    /**
     * æ£€æŸ¥åº”ç”¨æ˜¯å¦å·²å®‰è£…ï¼ˆå¢å¼ºç‰ˆï¼‰
     */
    private fun isAppInstalled(packageName: String): Boolean {
        return try {
            // æ–¹æ³•1: ä½¿ç”¨getPackageInfo
            packageManager.getPackageInfo(packageName, 0)
            Log.d(TAG, "âœ… åº”ç”¨å·²å®‰è£… (getPackageInfo): $packageName")
            true
        } catch (e: PackageManager.NameNotFoundException) {
            try {
                // æ–¹æ³•2: ä½¿ç”¨getApplicationInfo
                packageManager.getApplicationInfo(packageName, 0)
                Log.d(TAG, "âœ… åº”ç”¨å·²å®‰è£… (getApplicationInfo): $packageName")
                true
            } catch (e2: PackageManager.NameNotFoundException) {
                // æ–¹æ³•3: å°è¯•å¯åŠ¨Intent
                val launchIntent = packageManager.getLaunchIntentForPackage(packageName)
                if (launchIntent != null) {
                    Log.d(TAG, "âœ… åº”ç”¨å·²å®‰è£… (getLaunchIntent): $packageName")
                    true
                } else {
                    Log.d(TAG, "âŒ åº”ç”¨æœªå®‰è£…: $packageName")
                    false
                }
            }
        }
    }

    /**
     * æ£€æŸ¥AIåº”ç”¨æ˜¯å¦å·²å®‰è£…ï¼ˆæ”¯æŒå¤šä¸ªå¯èƒ½çš„åŒ…åï¼‰
     */
    private fun isAIAppInstalledWithAlternatives(possiblePackages: List<String>): String? {
        for (packageName in possiblePackages) {
            if (isAppInstalled(packageName)) {
                Log.d(TAG, "ğŸ¯ æ‰¾åˆ°å·²å®‰è£…çš„AIåº”ç”¨: $packageName")
                return packageName
            }
        }
        Log.w(TAG, "âš ï¸ æœªæ‰¾åˆ°ä»»ä½•å·²å®‰è£…çš„åŒ…å: ${possiblePackages.joinToString(", ")}")
        return null
    }

    /**
     * é€šç”¨AIåº”ç”¨å¯åŠ¨æ–¹æ³•ï¼ˆæ”¯æŒå¤šé‡å¤‡ç”¨æ–¹æ¡ˆï¼‰
     */
    private fun launchAIAppUniversal(appName: String, possiblePackages: List<String>, query: String) {
        try {
            Log.d(TAG, "ğŸš€ å°è¯•å¯åŠ¨$appNameï¼ŒæŸ¥è¯¢: $query")

            // ç¬¬ä¸€æ­¥ï¼šæ£€æŸ¥æ˜¯å¦æœ‰å·²å®‰è£…çš„åº”ç”¨
            val installedPackage = isAIAppInstalledWithAlternatives(possiblePackages)

            if (installedPackage != null) {
                // æ–¹æ¡ˆ1ï¼šå°è¯•Intentå‘é€
                if (tryIntentSend(installedPackage, query, appName)) return

                // æ–¹æ¡ˆ2ï¼šç›´æ¥å¯åŠ¨åº”ç”¨å¹¶ä½¿ç”¨å‰ªè´´æ¿
                if (tryDirectLaunchWithClipboard(installedPackage, query, appName)) return
            }

            // æ–¹æ¡ˆ3ï¼šå°è¯•æ‰€æœ‰å¯èƒ½çš„åŒ…å
            for (packageName in possiblePackages) {
                if (tryIntentSend(packageName, query, appName)) return
            }

            // æ–¹æ¡ˆ4ï¼šä½¿ç”¨å‰ªè´´æ¿å¤‡ç”¨æ–¹æ¡ˆ
            sendQuestionViaClipboard(possiblePackages.first(), query, appName)

        } catch (e: Exception) {
            Log.e(TAG, "$appName å¯åŠ¨å¤±è´¥", e)
            Toast.makeText(this, "$appName å¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥åº”ç”¨æ˜¯å¦å·²å®‰è£…", Toast.LENGTH_LONG).show()
            sendQuestionViaClipboard(possiblePackages.first(), query, appName)
        }
    }

    /**
     * å°è¯•é€šè¿‡Intentå‘é€æ–‡æœ¬
     */
    private fun tryIntentSend(packageName: String, query: String, appName: String): Boolean {
        return try {
            val intent = Intent(Intent.ACTION_SEND).apply {
                type = "text/plain"
                putExtra(Intent.EXTRA_TEXT, query)
                setPackage(packageName)
                addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
            }

            if (intent.resolveActivity(packageManager) != null) {
                startActivity(intent)
                Toast.makeText(this, "æ­£åœ¨å‘$appName å‘é€é—®é¢˜...", Toast.LENGTH_SHORT).show()
                Log.d(TAG, "âœ… $appName Intentå‘é€æˆåŠŸ: $packageName")
                true
            } else {
                Log.d(TAG, "âŒ $appName Intentå‘é€å¤±è´¥: $packageName")
                false
            }
        } catch (e: Exception) {
            Log.w(TAG, "$appName Intentå‘é€å¼‚å¸¸: $packageName", e)
            false
        }
    }

    /**
     * å°è¯•ç›´æ¥å¯åŠ¨åº”ç”¨å¹¶ä½¿ç”¨å‰ªè´´æ¿
     */
    private fun tryDirectLaunchWithClipboard(packageName: String, query: String, appName: String): Boolean {
        return try {
            val launchIntent = packageManager.getLaunchIntentForPackage(packageName)
            if (launchIntent != null) {
                launchIntent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
                startActivity(launchIntent)
                Toast.makeText(this, "æ­£åœ¨å¯åŠ¨$appName...", Toast.LENGTH_SHORT).show()
                Log.d(TAG, "âœ… $appName ç›´æ¥å¯åŠ¨æˆåŠŸ: $packageName")

                // å»¶è¿Ÿå‘é€æ–‡æœ¬åˆ°å‰ªè´´æ¿
                Handler(Looper.getMainLooper()).postDelayed({
                    sendQuestionViaClipboard(packageName, query, appName)
                }, 2000)
                true
            } else {
                Log.d(TAG, "âŒ $appName ç›´æ¥å¯åŠ¨å¤±è´¥: $packageName")
                false
            }
        } catch (e: Exception) {
            Log.w(TAG, "$appName ç›´æ¥å¯åŠ¨å¼‚å¸¸: $packageName", e)
            false
        }
    }

    /**
     * æ˜¾ç¤ºæ‚¬æµ®è¿”å›æŒ‰é’®
     */
    private fun showFloatingBackButton() {
        try {
            // æ£€æŸ¥æ‚¬æµ®çª—æƒé™
            if (android.os.Build.VERSION.SDK_INT >= android.os.Build.VERSION_CODES.M && !android.provider.Settings.canDrawOverlays(this)) {
                Log.w(TAG, "æ²¡æœ‰æ‚¬æµ®çª—æƒé™ï¼Œæ— æ³•æ˜¾ç¤ºè¿”å›æŒ‰é’®")
                return
            }

            // å¯åŠ¨æ‚¬æµ®è¿”å›æŒ‰é’®æœåŠ¡
            val intent = Intent(this, FloatingBackButtonService::class.java)
            startService(intent)

        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºæ‚¬æµ®è¿”å›æŒ‰é’®å¤±è´¥", e)
        }
    }

    private fun showSettings() {
        currentState = UIState.SETTINGS
        chatLayout.visibility = View.GONE
        aiAssistantCenterLayout.visibility = View.GONE
        taskSelectionLayout.visibility = View.GONE
        stepGuidanceLayout.visibility = View.GONE
        promptPreviewLayout.visibility = View.GONE
        voiceLayout.visibility = View.GONE
        appSearchLayout.visibility = View.GONE
        browserLayout.visibility = View.GONE
        settingsLayout.visibility = View.VISIBLE

        loadSettings() // æ¯æ¬¡æ˜¾ç¤ºæ—¶é‡æ–°åŠ è½½è®¾ç½®
        updateFloatingBallSettingsVisibility() // æ ¹æ®æ˜¾ç¤ºæ¨¡å¼æ§åˆ¶æ‚¬æµ®çƒè®¾ç½®å¯è§æ€§
        updateTabColors()
    }

    /**
     * æ ¹æ®å½“å‰æ˜¾ç¤ºæ¨¡å¼æ§åˆ¶æ‚¬æµ®çƒè®¾ç½®çš„å¯è§æ€§
     */
    private fun updateFloatingBallSettingsVisibility() {
        try {
            val currentDisplayMode = settingsManager.getDisplayMode()
            val shouldShowFloatingBallSettings = currentDisplayMode == "floating_ball"

            Log.d(TAG, "Current display mode: $currentDisplayMode, show floating ball settings: $shouldShowFloatingBallSettings")

            floatingBallSettingsContainer.visibility = if (shouldShowFloatingBallSettings) {
                View.VISIBLE
            } else {
                View.GONE
            }
        } catch (e: Exception) {
            Log.e(TAG, "Error updating floating ball settings visibility", e)
            // é»˜è®¤éšè—æ‚¬æµ®çƒè®¾ç½®
            floatingBallSettingsContainer.visibility = View.GONE
        }
    }

    private fun showBrowser() {
        try {
            // æ£€æŸ¥ActivityçŠ¶æ€
            if (isFinishing || isDestroyed) {
                Log.w(TAG, "Activityæ­£åœ¨é”€æ¯ï¼Œè·³è¿‡æ˜¾ç¤ºæµè§ˆå™¨")
                return
            }

            Log.d(TAG, "æ˜¾ç¤ºæµè§ˆå™¨ç•Œé¢")

            currentState = UIState.BROWSER
            chatLayout.visibility = View.GONE
            aiAssistantCenterLayout.visibility = View.GONE
            taskSelectionLayout.visibility = View.GONE
            stepGuidanceLayout.visibility = View.GONE
            promptPreviewLayout.visibility = View.GONE
            voiceLayout.visibility = View.GONE
            appSearchLayout.visibility = View.GONE
            settingsLayout.visibility = View.GONE
            browserLayout.visibility = View.VISIBLE

            // ç¡®ä¿çº¸å †WebViewç®¡ç†å™¨å·²æ­£ç¡®åˆå§‹åŒ–
            if (paperStackWebViewManager == null) {
                setupBrowserWebView()
            }

            // é»˜è®¤éšè—åŸç”ŸåŠŸèƒ½ä¸»é¡µï¼Œä¼˜å…ˆä½¿ç”¨WebViewå¡ç‰‡
            browserHomeContent.visibility = View.GONE
            browserTabContainer.visibility = View.GONE

            // ğŸ”§ ä¿®å¤ï¼šæ£€æŸ¥æ˜¯å¦æœ‰æ ‡ç­¾é¡µï¼Œå¦‚æœæ²¡æœ‰åˆ™è‡ªåŠ¨åˆ›å»ºåŠŸèƒ½ä¸»é¡µ
            val tabCount = paperStackWebViewManager?.getTabCount() ?: 0
            if (tabCount == 0) {
                Log.d(TAG, "æ˜¾ç¤ºæµè§ˆå™¨ç•Œé¢ï¼šæ²¡æœ‰æ ‡ç­¾é¡µï¼Œè‡ªåŠ¨åˆ›å»ºåŠŸèƒ½ä¸»é¡µ")
                // å»¶è¿Ÿä¸€ç‚¹æ—¶é—´ç¡®ä¿UIå®Œå…¨åˆå§‹åŒ–åå†åˆ›å»º
                handler.postDelayed({
                    createFunctionalHomeTab()
                }, 200)
            } else {
                // æœ‰æ ‡ç­¾é¡µï¼Œè¿›å…¥çº¸å †æ¨¡å¼
                Log.d(TAG, "æ˜¾ç¤ºæµè§ˆå™¨ç•Œé¢ï¼šæœ‰ $tabCount ä¸ªæ ‡ç­¾é¡µï¼Œè¿›å…¥çº¸å †æ¨¡å¼")
                enterPaperStackMode()
            }

            updateTabColors()

            Log.d(TAG, "æµè§ˆå™¨ç•Œé¢æ˜¾ç¤ºå®Œæˆ")
        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºæµè§ˆå™¨ç•Œé¢å¼‚å¸¸", e)
        }
    }

    /**
     * è¿›å…¥çº¸å †æ¨¡å¼
     */
    private fun enterPaperStackMode() {
        try {
            Log.d(TAG, "è¿›å…¥çº¸å †æ¨¡å¼")
            
            // æ˜¾ç¤ºçº¸å †å®¹å™¨
            val paperStackLayout = findViewById<View>(R.id.paper_stack_layout)
            paperStackLayout?.visibility = View.VISIBLE
            
            // ç¡®ä¿çº¸å †WebViewç®¡ç†å™¨å·²åˆå§‹åŒ–
            if (paperStackWebViewManager == null) {
                Log.d(TAG, "çº¸å †WebViewç®¡ç†å™¨æœªåˆå§‹åŒ–ï¼Œé‡æ–°åˆå§‹åŒ–")
                setupBrowserWebView()
            }
            
            // æ£€æŸ¥æ ‡ç­¾é¡µæ•°é‡
            val tabCount = paperStackWebViewManager?.getTabCount() ?: 0
            if (tabCount == 0) {
                Log.d(TAG, "è¿›å…¥çº¸å †æ¨¡å¼ï¼šæ²¡æœ‰æ ‡ç­¾é¡µï¼Œåº”è¯¥ç”±switchToSearchTabæˆ–createFunctionalHomeTabåˆ›å»º")
                // ä¸åœ¨è¿™é‡Œåˆ›å»ºï¼Œé¿å…é‡å¤åˆ›å»º
                // éšè—åŸç”ŸåŠŸèƒ½ä¸»é¡µï¼Œç­‰å¾…æ ‡ç­¾é¡µåˆ›å»º
                paperStackLayout?.visibility = View.GONE
                browserHomeContent.visibility = View.GONE
                browserTabContainer.visibility = View.GONE
                browserSearchInput.setText("")
            } else {
                Log.d(TAG, "å·²æœ‰ $tabCount ä¸ªæ ‡ç­¾é¡µï¼Œåˆ‡æ¢åˆ°çº¸å †æ¨¡å¼")
                // éšè—ä¸»é¡µå†…å®¹ï¼Œæ˜¾ç¤ºçº¸å †æ ‡ç­¾é¡µ
                browserHomeContent.visibility = View.GONE
                
                // ç¡®ä¿çº¸å †æ¨¡å¼æ­£ç¡®æ˜¾ç¤º
                val currentTab = paperStackWebViewManager?.getCurrentTab()
                if (currentTab != null) {
                    // ğŸ”§ ä¿®å¤ï¼šç¡®ä¿WebViewå¯è§
                    currentTab.webView.visibility = View.VISIBLE
                    currentTab.webView.bringToFront()
                    
                    // ğŸ”§ ä¿®å¤ï¼šå¦‚æœæ˜¯åŠŸèƒ½ä¸»é¡µï¼Œæ˜¾ç¤º"é¦–é¡µ"è€Œä¸æ˜¯URL
                    val displayText = if (currentTab.url == "home://functional" || currentTab.url == "file:///android_asset/functional_home.html") {
                        "é¦–é¡µ"
                    } else {
                        currentTab.url
                    }
                    browserSearchInput.setText(displayText)
                    Log.d(TAG, "æ›´æ–°æœç´¢æ¡†æ˜¾ç¤º: $displayText (åŸå§‹URL: ${currentTab.url})")
                    
                    // ğŸ”§ ä¿®å¤ï¼šå¦‚æœå½“å‰æ ‡ç­¾é¡µæ˜¯åŠŸèƒ½ä¸»é¡µä½†æœªåŠ è½½ï¼Œå¼ºåˆ¶åŠ è½½
                    if (currentTab.url == "home://functional" && 
                        (currentTab.webView.url.isNullOrEmpty() || 
                         currentTab.webView.url != "file:///android_asset/functional_home.html")) {
                        Log.d(TAG, "ğŸ”§ åŠŸèƒ½ä¸»é¡µæœªæ­£ç¡®åŠ è½½ï¼Œé‡æ–°åŠ è½½")
                        currentTab.webView.loadUrl("file:///android_asset/functional_home.html")
                    }
                    
                    // ğŸ”§ ä¿®å¤ï¼šé»˜è®¤é¦–é¡µæ—¶ä¹Ÿæ˜¾ç¤ºtabæ ï¼Œæ–¹ä¾¿ç”¨æˆ·è·³è½¬åˆ°å…¶ä»–tab
                    val isHomePage = currentTab.url == "home://functional" || 
                                   currentTab.url == "file:///android_asset/functional_home.html"
                    if (isHomePage) {
                        browserTabContainer.visibility = View.VISIBLE
                        Log.d(TAG, "é»˜è®¤é¦–é¡µï¼šæ˜¾ç¤ºtabæ ï¼Œæ–¹ä¾¿ç”¨æˆ·è·³è½¬åˆ°å…¶ä»–tab")
                    } else {
                        browserTabContainer.visibility = View.GONE
                    }
                } else {
                    browserTabContainer.visibility = View.GONE
                }
            }
            
            Log.d(TAG, "çº¸å †æ¨¡å¼å·²æ¿€æ´»")
        } catch (e: Exception) {
            Log.e(TAG, "è¿›å…¥çº¸å †æ¨¡å¼å¤±è´¥", e)
        }
    }

    /**
     * æ·»åŠ é»˜è®¤æ ‡ç­¾é¡µ - ä¼˜åŒ–ç‰ˆæœ¬ï¼Œé¿å…ä¸å¿…è¦çš„è‡ªåŠ¨åˆ›å»º
     */
    private fun addDefaultTab() {
        // æ­¤æ–¹æ³•å·²åºŸå¼ƒï¼Œç°åœ¨ç›´æ¥åœ¨enterPaperStackModeä¸­å¤„ç†
        Log.d(TAG, "addDefaultTabæ–¹æ³•å·²åºŸå¼ƒï¼Œç°åœ¨ç›´æ¥åœ¨enterPaperStackModeä¸­å¤„ç†")
    }

    /**
     * æ£€æŸ¥ä¿å­˜çš„å¡ç‰‡çŠ¶æ€å¹¶å¼¹å‡ºåŠ è½½æç¤º
     * åªåœ¨æœç´¢tabä¸­æ˜¾ç¤ºæ¢å¤æç¤ºå¯¹è¯æ¡†ï¼Œä¸”æ¯ä¸ªä¼šè¯åªæ˜¾ç¤ºä¸€æ¬¡
     */
    private fun checkAndPromptForSavedCards() {
        // åªåœ¨æœç´¢tabï¼ˆUIState.BROWSERï¼‰ä¸­æ˜¾ç¤ºæ¢å¤æç¤º
        if (currentState != UIState.BROWSER) {
            Log.d(TAG, "checkAndPromptForSavedCards: å½“å‰ä¸åœ¨æœç´¢tabï¼Œè·³è¿‡æ¢å¤æç¤ºï¼Œå½“å‰çŠ¶æ€: $currentState")
            forceRefreshUIState()
            return
        }

        // æ£€æŸ¥æ—¶é—´é—´éš”ï¼Œé¿å…çŸ­æ—¶é—´å†…é‡å¤å¼¹å‡º
        val currentTime = System.currentTimeMillis()
        if (currentTime - lastRestoreCheckTime < RESTORE_CHECK_INTERVAL) {
            Log.d(TAG, "checkAndPromptForSavedCards: è·ç¦»ä¸Šæ¬¡æ£€æŸ¥æ—¶é—´è¿‡çŸ­ï¼Œè·³è¿‡ (${currentTime - lastRestoreCheckTime}ms < ${RESTORE_CHECK_INTERVAL}ms)")
            forceRefreshUIState()
            return
        }

        // æ£€æŸ¥å½“å‰æ˜¯å¦å·²æœ‰å¡ç‰‡ï¼Œå¦‚æœæœ‰åˆ™ä¸æ˜¾ç¤ºæ¢å¤å¯¹è¯æ¡†
        val currentCards = getAllUnifiedCards()
        if (currentCards.isNotEmpty()) {
            Log.d(TAG, "checkAndPromptForSavedCards: å½“å‰å·²æœ‰ ${currentCards.size} ä¸ªå¡ç‰‡ï¼Œè·³è¿‡æ¢å¤æç¤º")
            forceRefreshUIState()
            return
        }
        
        val sharedPreferences = getSharedPreferences("gesture_cards_state", Context.MODE_PRIVATE)
        val savedUrls = sharedPreferences.getStringSet("floating_card_urls", emptySet()) ?: emptySet()
        
        Log.d(TAG, "checkAndPromptForSavedCards: åœ¨æœç´¢tabä¸­æ£€æŸ¥ä¿å­˜çš„å¡ç‰‡çŠ¶æ€")
        Log.d(TAG, "checkAndPromptForSavedCards: savedUrls = $savedUrls")
        Log.d(TAG, "checkAndPromptForSavedCards: savedUrls.size = ${savedUrls.size}")
        
        if (savedUrls.isNotEmpty()) {
            Log.d(TAG, "checkAndPromptForSavedCards: å‘ç°ä¿å­˜çš„å¡ç‰‡ï¼Œæ˜¾ç¤ºæ¢å¤å¯¹è¯æ¡†")
            // æ›´æ–°æ£€æŸ¥æ—¶é—´
            lastRestoreCheckTime = currentTime
            
            // å¼¹å‡ºå¯¹è¯æ¡†è¯¢é—®ç”¨æˆ·æ˜¯å¦è¦æ¢å¤ä¹‹å‰çš„é¡µé¢
            androidx.appcompat.app.AlertDialog.Builder(this)
                .setTitle("æ¢å¤æœªå…³é—­çš„é¡µé¢")
                .setMessage("æ£€æµ‹åˆ°æ‚¨æœ‰ ${savedUrls.size} ä¸ªæœªå…³é—­çš„é¡µé¢ï¼Œè¯·é€‰æ‹©æ“ä½œï¼š")
                .setPositiveButton("æ¢å¤æ‰€æœ‰é¡µé¢") { _, _ ->
                    Log.d(TAG, "ç”¨æˆ·é€‰æ‹©ï¼šæ¢å¤æ‰€æœ‰é¡µé¢")
                    // æ¢å¤ä¿å­˜çš„å¡ç‰‡
                    gestureCardWebViewManager?.restoreCardsState()
                    // ğŸ”§ ä¿®å¤ï¼šæ¢å¤åç›´æ¥è¿›å…¥æ¢å¤é¡µé¢ï¼ˆæ¿€æ´»é¢„è§ˆçª—å£ï¼‰
                    Handler(Looper.getMainLooper()).postDelayed({
                        // æ¢å¤å®Œæˆåï¼Œæ¿€æ´»é¢„è§ˆçª—å£æ˜¾ç¤ºæ¢å¤çš„é¡µé¢
                        activateStackedCardPreview()
                        forceRefreshUIState()
                    }, 500)
                }
                .setNegativeButton("æ¸…é™¤æ‰€æœ‰é¡µé¢") { _, _ ->
                    Log.d(TAG, "ç”¨æˆ·é€‰æ‹©ï¼šæ¸…é™¤æ‰€æœ‰é¡µé¢")
                    // æ¸…é™¤ä¿å­˜çš„çŠ¶æ€
                    sharedPreferences.edit().remove("floating_card_urls").apply()
                    // ä¸è°ƒç”¨restoreCardsStateï¼Œç›´æ¥åˆ·æ–°UIçŠ¶æ€
                    forceRefreshUIState()
                }
                .setNeutralButton("ç¨åå†³å®š") { _, _ ->
                    Log.d(TAG, "ç”¨æˆ·é€‰æ‹©ï¼šç¨åå†³å®š")
                    // æš‚æ—¶ä¸å¤„ç†ï¼Œä¿æŒå½“å‰çŠ¶æ€ï¼Œä¸è°ƒç”¨restoreCardsState
                    forceRefreshUIState()
                }
                .setCancelable(false)
                .show()
        } else {
            // å¦‚æœæ²¡æœ‰ä¿å­˜çš„å¡ç‰‡ï¼Œç«‹å³åˆ·æ–°UIçŠ¶æ€
            forceRefreshUIState()
        }
    }

    private fun setupBottomNavigation() {
        // åˆ›å»ºwebviewå¡ç‰‡åˆ‡æ¢æ‰‹åŠ¿æ£€æµ‹å™¨
        val webViewCardSwipeDetector = createWebViewCardSwipeDetector()

        // åˆå§‹åŒ–Materialæ³¢æµªè¿½è¸ªå™¨
        setupMaterialWaveTracker()

        // å¯¹è¯tab (æœ€å·¦è¾¹)
        findViewById<LinearLayout>(R.id.tab_chat)?.apply {
            setOnClickListener {
                deactivateStackedCardPreview()
                // ğŸ”§ ä¿®å¤ï¼šé€€å‡ºæœç´¢tabæ—¶ï¼Œæ¢å¤tabæ ï¼ˆç»„æ ‡ç­¾æ ï¼‰æ˜¾ç¤º
                if (currentState == UIState.BROWSER) {
                    groupTabsContainer?.let { container ->
                        container.visibility = View.VISIBLE
                        container.alpha = 1f
                        container.translationY = 0f
                        Log.d(TAG, "ğŸ”§ é€€å‡ºæœç´¢tabæ—¶ï¼Œæ¢å¤ç»„æ ‡ç­¾æ ï¼ˆtabæ ï¼‰")
                    }
                }
                showChat()
                // é€€å‡ºæœç´¢tabæ‰‹åŠ¿é®ç½©åŒº
                deactivateSearchTabGestureOverlay()
                // é‡ç½®æ¢å¤å¯¹è¯æ¡†æ£€æŸ¥çŠ¶æ€ï¼Œå…è®¸ä¸‹æ¬¡è¿›å…¥æœç´¢tabæ—¶é‡æ–°æ£€æŸ¥
                resetRestoreDialogState()
            }
            setupTabGestureDetection(this, webViewCardSwipeDetector)
        }

        // æœç´¢tab (ç¬¬äºŒä½)
        findViewById<LinearLayout>(R.id.tab_search)?.apply {
            setOnClickListener {
                val currentTime = System.currentTimeMillis()
                
                // æ£€æµ‹åŒå‡»
                val timeSinceLastClick = currentTime - lastSearchTabDoubleClickTime
                if (lastSearchTabDoubleClickTime > 0 && timeSinceLastClick < DOUBLE_CLICK_INTERVAL) {
                    // åŒå‡»äº‹ä»¶ - æ‰“å¼€ä¸‹è½½ç®¡ç†
                    Log.d(TAG, "æœç´¢tabåŒå‡»ï¼Œæ‰“å¼€ä¸‹è½½ç®¡ç†")
                    lastSearchTabDoubleClickTime = 0L // é‡ç½®åŒå‡»æ—¶é—´
                    try {
                        val intent = Intent(this@SimpleModeActivity, DownloadManagerActivity::class.java)
                        startActivity(intent)
                    } catch (e: Exception) {
                        Log.e(TAG, "æ‰“å¼€ä¸‹è½½ç®¡ç†å¤±è´¥", e)
                        Toast.makeText(this@SimpleModeActivity, "æ‰“å¼€ä¸‹è½½ç®¡ç†å¤±è´¥", Toast.LENGTH_SHORT).show()
                    }
                    return@setOnClickListener
                }
                
                // é˜²é‡å¤ç‚¹å‡»ä¿æŠ¤
                if (currentTime - lastSearchTabClickTime < SEARCH_TAB_CLICK_INTERVAL) {
                    Log.d(TAG, "æœç´¢tabç‚¹å‡»è¿‡äºé¢‘ç¹ï¼Œå¿½ç•¥æ­¤æ¬¡ç‚¹å‡»")
                    return@setOnClickListener
                }
                
                lastSearchTabClickTime = currentTime
                lastSearchTabDoubleClickTime = currentTime

                Log.d(TAG, "æœç´¢tabè¢«ç‚¹å‡»ï¼Œå½“å‰é®ç½©å±‚çŠ¶æ€: $isSearchTabGestureOverlayActive")

                try {
                    // æ£€æŸ¥ActivityçŠ¶æ€
                    if (isFinishing || isDestroyed) {
                        Log.w(TAG, "Activityæ­£åœ¨é”€æ¯ï¼Œå¿½ç•¥æœç´¢tabç‚¹å‡»")
                        return@setOnClickListener
                    }

                    deactivateStackedCardPreview()
                    // ä½¿ç”¨switchToSearchTab()æ¥ç¡®ä¿è‡ªåŠ¨åˆ›å»ºåŠŸèƒ½ä¸»é¡µ
                    switchToSearchTab()

                    // å•å‡»æœç´¢tabæ—¶ï¼Œå¦‚æœé®ç½©å±‚å·²æ¿€æ´»ï¼Œåˆ™é€€å‡ºé®ç½©å±‚
                    if (isSearchTabGestureOverlayActive) {
                        Log.d(TAG, "é®ç½©å±‚å·²æ¿€æ´»ï¼Œé€€å‡ºé®ç½©å±‚")
                        deactivateSearchTabGestureOverlay()
                    } else {
                        Log.d(TAG, "é®ç½©å±‚æœªæ¿€æ´»ï¼Œæ­£å¸¸åˆ‡æ¢åˆ°æœç´¢tab")
                    }
                } catch (e: Exception) {
                    Log.e(TAG, "æœç´¢tabç‚¹å‡»å¤„ç†å¼‚å¸¸", e)
                }
            }

            // è®¾ç½®é•¿æŒ‰ç›‘å¬å™¨ - é•¿æŒ‰æ¿€æ´»enhancedtabmanagerèœå•æˆ–é®ç½©å±‚
            setOnLongClickListener {
                Log.d(TAG, "æœç´¢tabé•¿æŒ‰äº‹ä»¶è§¦å‘")

                try {
                    // æ£€æŸ¥æ˜¯å¦åœ¨çº¸å †æ¨¡å¼ä¸‹
                    val paperStackLayout = findViewById<View>(R.id.paper_stack_layout)
                    if (paperStackLayout?.visibility == View.VISIBLE) {
                        // åœ¨çº¸å †æ¨¡å¼ä¸‹ï¼Œé•¿æŒ‰æ¿€æ´»enhancedtabmanagerèœå•
                        Log.d(TAG, "é•¿æŒ‰æœç´¢tabæ¿€æ´»enhancedtabmanagerèœå•")
                        showEnhancedTabManagerMenu()
                    } else if (isSearchTabGestureOverlayActive) {
                        // å¦‚æœé®ç½©å±‚å·²æ¿€æ´»ï¼Œé•¿æŒ‰é€€å‡ºé®ç½©å±‚
                        Log.d(TAG, "é•¿æŒ‰æœç´¢tabé€€å‡ºé®ç½©å±‚")
                        deactivateSearchTabGestureOverlay()
                    }
                    // å·²ç§»é™¤ï¼šé•¿æŒ‰æ¿€æ´»é®ç½©å±‚åŠŸèƒ½ï¼Œç°åœ¨ç”±ä¸‹æ»‘é¡µé¢è‡ªåŠ¨å¼¹å‡ºæ‚¬æµ®å¿«æ·æ“ä½œèœå•æ›¿ä»£
                } catch (e: Exception) {
                    Log.e(TAG, "æœç´¢tabé•¿æŒ‰å¤„ç†å¼‚å¸¸", e)
                }
                true // æ¶ˆè´¹é•¿æŒ‰äº‹ä»¶
            }

            setupTabGestureDetection(this, webViewCardSwipeDetector)
        }

        // AIåŠ©æ‰‹ä¸­å¿ƒtab (ç¬¬ä¸‰ä½ï¼ŒåŸä»»åŠ¡tab)
        findViewById<LinearLayout>(R.id.tab_home)?.apply {
            setOnClickListener {
                deactivateStackedCardPreview()
                // ğŸ”§ ä¿®å¤ï¼šé€€å‡ºæœç´¢tabæ—¶ï¼Œæ¢å¤tabæ ï¼ˆç»„æ ‡ç­¾æ ï¼‰æ˜¾ç¤º
                if (currentState == UIState.BROWSER) {
                    groupTabsContainer?.let { container ->
                        container.visibility = View.VISIBLE
                        container.alpha = 1f
                        container.translationY = 0f
                        Log.d(TAG, "ğŸ”§ é€€å‡ºæœç´¢tabæ—¶ï¼Œæ¢å¤ç»„æ ‡ç­¾æ ï¼ˆtabæ ï¼‰")
                    }
                }
                showAIAssistantCenter()
                // é€€å‡ºæœç´¢tabæ‰‹åŠ¿é®ç½©åŒº
                deactivateSearchTabGestureOverlay()
                // é‡ç½®æ¢å¤å¯¹è¯æ¡†æ£€æŸ¥çŠ¶æ€
                resetRestoreDialogState()
            }
            setupTabGestureDetection(this, webViewCardSwipeDetector)
        }

        // è¯­éŸ³tab (ç¬¬å››ä½)
        findViewById<LinearLayout>(R.id.tab_voice)?.apply {
            setOnClickListener {
                deactivateStackedCardPreview()
                // ğŸ”§ ä¿®å¤ï¼šé€€å‡ºæœç´¢tabæ—¶ï¼Œæ¢å¤tabæ ï¼ˆç»„æ ‡ç­¾æ ï¼‰æ˜¾ç¤º
                if (currentState == UIState.BROWSER) {
                    groupTabsContainer?.let { container ->
                        container.visibility = View.VISIBLE
                        container.alpha = 1f
                        container.translationY = 0f
                        Log.d(TAG, "ğŸ”§ é€€å‡ºæœç´¢tabæ—¶ï¼Œæ¢å¤ç»„æ ‡ç­¾æ ï¼ˆtabæ ï¼‰")
                    }
                }
                showVoice()
                // é€€å‡ºæœç´¢tabæ‰‹åŠ¿é®ç½©åŒº
                deactivateSearchTabGestureOverlay()
                // é‡ç½®æ¢å¤å¯¹è¯æ¡†æ£€æŸ¥çŠ¶æ€
                resetRestoreDialogState()
            }
            setupTabGestureDetection(this, webViewCardSwipeDetector)
        }

        // è½¯ä»¶tab (ç¬¬äº”ä½)
        findViewById<LinearLayout>(R.id.tab_app_search)?.apply {
            setOnClickListener {
                deactivateStackedCardPreview()
                // ğŸ”§ ä¿®å¤ï¼šé€€å‡ºæœç´¢tabæ—¶ï¼Œæ¢å¤tabæ ï¼ˆç»„æ ‡ç­¾æ ï¼‰æ˜¾ç¤º
                if (currentState == UIState.BROWSER) {
                    groupTabsContainer?.let { container ->
                        container.visibility = View.VISIBLE
                        container.alpha = 1f
                        container.translationY = 0f
                        Log.d(TAG, "ğŸ”§ é€€å‡ºæœç´¢tabæ—¶ï¼Œæ¢å¤ç»„æ ‡ç­¾æ ï¼ˆtabæ ï¼‰")
                    }
                }
                showAppSearch()
                // é€€å‡ºæœç´¢tabæ‰‹åŠ¿é®ç½©åŒº
                deactivateSearchTabGestureOverlay()
                // é‡ç½®æ¢å¤å¯¹è¯æ¡†æ£€æŸ¥çŠ¶æ€
                resetRestoreDialogState()
            }
            setupTabGestureDetection(this, webViewCardSwipeDetector)
        }

        // è®¾ç½®tab (æœ€å³è¾¹)
        findViewById<LinearLayout>(R.id.tab_settings)?.apply {
            setOnClickListener {
                deactivateStackedCardPreview()
                // ğŸ”§ ä¿®å¤ï¼šé€€å‡ºæœç´¢tabæ—¶ï¼Œæ¢å¤tabæ ï¼ˆç»„æ ‡ç­¾æ ï¼‰æ˜¾ç¤º
                if (currentState == UIState.BROWSER) {
                    groupTabsContainer?.let { container ->
                        container.visibility = View.VISIBLE
                        container.alpha = 1f
                        container.translationY = 0f
                        Log.d(TAG, "ğŸ”§ é€€å‡ºæœç´¢tabæ—¶ï¼Œæ¢å¤ç»„æ ‡ç­¾æ ï¼ˆtabæ ï¼‰")
                    }
                }
                showSettings()
                // é€€å‡ºæœç´¢tabæ‰‹åŠ¿é®ç½©åŒº
                deactivateSearchTabGestureOverlay()
            }
            setupTabGestureDetection(this, webViewCardSwipeDetector)
        }

        // åˆå§‹åŒ–æœç´¢tabå›¾æ ‡å’Œå¾½æ ‡
        updateSearchTabIcon()
        updateSearchTabBadge()
        
        // åº”ç”¨åº•éƒ¨å¯¼èˆªæ é…ç½®ï¼ˆæ˜¾ç¤º/éšè—å’Œæ’åºï¼‰
        applyBottomNavigationConfig()

        // æ£€æµ‹è¯­éŸ³æ”¯æŒæƒ…å†µå¹¶éšè—è¯­éŸ³tabï¼ˆå¦‚æœä¸æ”¯æŒï¼‰
        updateVoiceTabVisibility()

        // è®¾ç½®åº•éƒ¨tabåŒºåŸŸçš„æ¨ªæ»‘æ‰‹åŠ¿
        setupTabAreaSwipeGesture()

        // åˆ›å»ºåº•éƒ¨tabæ‰‹åŠ¿æŒ‡ç¤ºå™¨
        createTabSwipeGestureIndicator()

        // è®¾ç½®tabåŒºåŸŸä¹‹é—´çš„æ»‘åŠ¨åˆ‡æ¢
        setupTabAreaSwipeForWebPageSwitch()

        // åˆ›å»ºtabæ»‘åŠ¨æŒ‡ç¤ºå™¨
        createTabSwipeIndicator()

        // åˆ›å»ºå¯¹è¯tabæ¨ªæ»‘æŒ‡ç¤ºå™¨
        createChatTabSwipeIndicator()

        // æœç´¢tabæ¨ªæ»‘åŠŸèƒ½å·²é›†æˆåˆ°å…¨å±€æ¨ªæ»‘æ‰‹åŠ¿ä¸­
        // createSearchTabSwipeHotArea() // å·²ç§»é™¤ï¼Œé¿å…å†²çª
    }

    /**
     * åº”ç”¨åº•éƒ¨å¯¼èˆªæ é…ç½®ï¼ˆæ˜¾ç¤º/éšè—å’Œæ’åºï¼‰
     */
    private fun applyBottomNavigationConfig() {
        try {
            val bottomNav = findViewById<LinearLayout>(R.id.bottom_navigation) ?: return
            val configs = settingsManager.getBottomNavTabConfigs()
            
            // åˆ›å»ºtab IDåˆ°Viewçš„æ˜ å°„
            val tabMap = mapOf(
                "tab_chat" to findViewById<LinearLayout>(R.id.tab_chat),
                "tab_search" to findViewById<LinearLayout>(R.id.tab_search),
                "tab_home" to findViewById<LinearLayout>(R.id.tab_home),
                "tab_voice" to findViewById<LinearLayout>(R.id.tab_voice),
                "tab_browser" to findViewById<LinearLayout>(R.id.tab_browser),
                "tab_app_search" to findViewById<LinearLayout>(R.id.tab_app_search),
                "tab_settings" to findViewById<LinearLayout>(R.id.tab_settings)
            )
            
            // å…ˆéšè—æ‰€æœ‰tab
            tabMap.values.forEach { it?.visibility = View.GONE }
            
            // æŒ‰é…ç½®çš„é¡ºåºæ’åºå¹¶æ˜¾ç¤ºå¯è§çš„tab
            val sortedConfigs = configs.filter { it.isVisible }.sortedBy { it.order }
            
            // ä¿å­˜æ‰€æœ‰tabçš„å¼•ç”¨ï¼ˆé¿å…ä¸¢å¤±ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨ï¼‰
            val allTabs = mutableListOf<View>()
            for (i in 0 until bottomNav.childCount) {
                allTabs.add(bottomNav.getChildAt(i))
            }
            
            // ç§»é™¤æ‰€æœ‰tabï¼ˆä½†ä¿ç•™å¼•ç”¨ï¼‰
            allTabs.forEach { bottomNav.removeView(it) }
            
            // æŒ‰é¡ºåºæ·»åŠ å¯è§çš„tab
            sortedConfigs.forEach { config ->
                val tabView = tabMap[config.tabId]
                tabView?.let { view ->
                    view.visibility = View.VISIBLE
                    bottomNav.addView(view)
                }
            }
            
            // æ›´æ–°tabæƒé‡
            updateTabWeights()
            
            Log.d(TAG, "åº•éƒ¨å¯¼èˆªæ é…ç½®å·²åº”ç”¨ï¼Œæ˜¾ç¤º${sortedConfigs.size}ä¸ªtab")
        } catch (e: Exception) {
            Log.e(TAG, "åº”ç”¨åº•éƒ¨å¯¼èˆªæ é…ç½®å¤±è´¥", e)
        }
    }
    
    /**
     * æ›´æ–°è¯­éŸ³tabçš„å¯è§æ€§
     * æ³¨æ„ï¼šç°åœ¨å§‹ç»ˆæ˜¾ç¤ºè¯­éŸ³tabï¼Œå³ä½¿è®¾å¤‡ä¸æ”¯æŒç³»ç»Ÿè¯­éŸ³è¯†åˆ«
     * å¦‚æœè®¾å¤‡ä¸æ”¯æŒç³»ç»Ÿè¯­éŸ³è¯†åˆ«ï¼Œä¼šåœ¨è¿›å…¥è¯­éŸ³é¡µé¢æ—¶æç¤ºç”¨æˆ·ä¸‹è½½Voskæ¨¡å‹
     */
    private fun updateVoiceTabVisibility() {
        try {
            // å§‹ç»ˆæ˜¾ç¤ºè¯­éŸ³tabï¼Œä¸å†æ ¹æ®ç³»ç»Ÿè¯­éŸ³æ”¯æŒæƒ…å†µéšè—
            val voiceTab = findViewById<LinearLayout>(R.id.tab_voice)
            voiceTab?.visibility = View.VISIBLE
            Log.d(TAG, "è¯­éŸ³tabå§‹ç»ˆæ˜¾ç¤ºï¼Œå…è®¸ç”¨æˆ·é€šè¿‡Voskæ¨¡å‹ä½¿ç”¨è¯­éŸ³åŠŸèƒ½")

            // æ›´æ–°tabçš„æƒé‡åˆ†é…
            updateTabWeights()

        } catch (e: Exception) {
            Log.e(TAG, "æ›´æ–°è¯­éŸ³tabå¯è§æ€§å¤±è´¥", e)
            // å‡ºé”™æ—¶ä¹Ÿæ˜¾ç¤ºè¯­éŸ³tab
            findViewById<LinearLayout>(R.id.tab_voice)?.visibility = View.VISIBLE
        }
    }

    /**
     * æ›´æ–°tabçš„æƒé‡åˆ†é…
     */
    private fun updateTabWeights() {
        val bottomNav = findViewById<LinearLayout>(R.id.bottom_navigation) ?: return
        val voiceTab = findViewById<LinearLayout>(R.id.tab_voice)

        // è®¡ç®—å¯è§tabçš„æ•°é‡
        var visibleTabCount = 0
        for (i in 0 until bottomNav.childCount) {
            val tabView = bottomNav.getChildAt(i)
            if (tabView.visibility == View.VISIBLE) {
                visibleTabCount++
            }
        }

        // é‡æ–°åˆ†é…æƒé‡
        for (i in 0 until bottomNav.childCount) {
            val tabView = bottomNav.getChildAt(i) as? LinearLayout ?: continue
            val layoutParams = tabView.layoutParams as LinearLayout.LayoutParams

            if (tabView.visibility == View.VISIBLE) {
                layoutParams.weight = 1f
            } else {
                layoutParams.weight = 0f
            }

            tabView.layoutParams = layoutParams
        }
    }

    /**
     * æ›´æ–°æœç´¢tabçš„å›¾æ ‡ - ä½¿ç”¨FaviconLoader
     */
    private fun updateSearchTabIcon() {
        val searchTab = findViewById<LinearLayout>(R.id.tab_search)
        val searchTabIcon = searchTab?.findViewById<ImageView>(R.id.search_tab_icon)

        if (searchTabIcon != null && currentSearchEngine != null) {
            // ä½¿ç”¨å½“å‰æœç´¢å¼•æ“çš„å›¾æ ‡
            com.example.aifloatingball.utils.FaviconLoader.loadIcon(
                searchTabIcon,
                currentSearchEngine!!.url,
                R.drawable.ic_search
            )
        }
    }

    /**
     * æ›´æ–°æœç´¢tabçš„å¾½æ ‡ - æ˜¾ç¤ºåå°å·²å¼€å¯çš„ç½‘é¡µæ•°é‡
     */
    private fun updateSearchTabBadge() {
        val searchTab = findViewById<LinearLayout>(R.id.tab_search)
        val searchTabBadge = searchTab?.findViewById<TextView>(R.id.search_tab_badge)

        if (searchTabBadge != null) {
            // è·å–å½“å‰æ‰“å¼€çš„ç½‘é¡µæ•°é‡
            val cardCount = gestureCardWebViewManager?.getAllCards()?.size ?: 0
            
            if (cardCount > 0) {
                searchTabBadge.text = cardCount.toString()
                searchTabBadge.visibility = View.VISIBLE
            } else {
                searchTabBadge.visibility = View.GONE
            }
        }
    }

    /**
     * æ›´æ–°æœç´¢tabæ ‡é¢˜æ å·¦ä¾§æŒ‰é’®çš„é¡µé¢æ•°å­—æ˜¾ç¤ºï¼ˆMaterial Designé£æ ¼ï¼‰
     */
    /**
     * æ›´æ–°é¡µé¢æ•°é‡æ˜¾ç¤ºï¼ˆMaterial Designé£æ ¼ï¼‰
     * ç²¾å‡†æ˜ å°„å½“å‰æœç´¢tabæ‰“å¼€çš„é¡µé¢æ•°é‡ï¼Œä¸åŒ…æ‹¬é»˜è®¤ä¸»é¡µ
     */
    private fun updatePageCountDisplay() {
        try {
            // è·å–å½“å‰ç»„çš„æ‰€æœ‰æ ‡ç­¾é¡µï¼ˆä½¿ç”¨getAllTabsè·å–å½“å‰ç»„çš„æ ‡ç­¾é¡µï¼‰
            val allTabs = paperStackWebViewManager?.getAllTabs() ?: emptyList()
            
            // ç²¾å‡†æ’é™¤é»˜è®¤ä¸»é¡µï¼šæ’é™¤æ‰€æœ‰åŠŸèƒ½ä¸»é¡µç›¸å…³çš„URL
            val pageCount = allTabs.count { tab -> 
                val url = tab.url
                url != "home://functional" && 
                url != "file:///android_asset/functional_home.html" &&
                !url.startsWith("home://") // æ’é™¤æ‰€æœ‰home://åè®®
            }
            
            // æ›´æ–°æ ‡é¢˜æ å·¦ä¾§çš„æ•°å­—æ˜¾ç¤ºï¼ˆbrowser_btn_closeï¼‰
            if (::browserBtnClose.isInitialized) {
                browserBtnClose.text = pageCount.toString()
                Log.d(TAG, "âœ… æ›´æ–°æ ‡é¢˜æ é¡µé¢æ•°å­—: $pageCount (æ€»æ ‡ç­¾é¡µ: ${allTabs.size}, æ’é™¤åŠŸèƒ½ä¸»é¡µ)")
            }
            
            // ä¼˜å…ˆä½¿ç”¨æ ‡é¢˜æ å·¦ä¾§çš„MaterialæŒ‰é’®ï¼ˆactivity_search.xmlä¸­çš„btn_menuï¼‰
            var pageCountButton = findViewById<com.google.android.material.button.MaterialButton>(R.id.btn_menu)
            if (pageCountButton == null) {
                // å¦‚æœæ ‡é¢˜æ æŒ‰é’®ä¸å­˜åœ¨ï¼Œå°è¯•ä½¿ç”¨å·¦ä¸‹è§’çš„
                pageCountButton = findViewById<com.google.android.material.button.MaterialButton>(R.id.btn_menu_bottom)
            }
            
            if (pageCountButton != null) {
                pageCountButton.text = pageCount.toString()
                // å§‹ç»ˆæ˜¾ç¤ºæŒ‰é’®ï¼Œå³ä½¿æ•°é‡ä¸º0
                pageCountButton.visibility = View.VISIBLE
            }
            
            Log.d(TAG, "ğŸ“Š æ›´æ–°é¡µé¢æ•°å­—: $pageCount (æ’é™¤é»˜è®¤ä¸»é¡µ), æ€»æ ‡ç­¾é¡µæ•°: ${allTabs.size}, åŠŸèƒ½ä¸»é¡µæ•°: ${allTabs.count { it.url == "home://functional" || it.url == "file:///android_asset/functional_home.html" }}")
        } catch (e: Exception) {
            Log.e(TAG, "âŒ æ›´æ–°é¡µé¢æ•°å­—å¤±è´¥", e)
        }
    }
    
    /**
     * è®¾ç½®æœç´¢å¼•æ“RecyclerView
     */
    private fun setupSearchEngineRecyclerView() {
        try {
            // è®¾ç½®LayoutManager
            browserPreviewEngineList.layoutManager = androidx.recyclerview.widget.LinearLayoutManager(this)

            // å®Œå…¨ç§»é™¤æœç´¢å¼•æ“åˆ—è¡¨ï¼Œä¸æ˜¾ç¤ºä»»ä½•æœç´¢å¼•æ“
            val emptyEngines = emptyList<com.example.aifloatingball.model.SearchEngine>()

            // åˆå§‹åŒ–é€‚é…å™¨
            draggableEngineAdapter = com.example.aifloatingball.adapter.DraggableSearchEngineAdapter(
                engines = emptyEngines.toMutableList(),
                onEngineClick = { engine ->
                    // ç‚¹å‡»æœç´¢å¼•æ“æ—¶çš„å¤„ç†
                    val searchText = browserSearchInput.text.toString().trim()
                    if (searchText.isNotEmpty()) {
                        val searchUrl = engine.getSearchUrl(searchText)
                        loadBrowserContent(searchUrl)
                    } else {
                        // å¦‚æœæ²¡æœ‰æœç´¢æ–‡æœ¬ï¼Œæ‰“å¼€æœç´¢å¼•æ“ä¸»é¡µ
                        val baseUrl = engine.url.split("?")[0]
                        loadBrowserContent(baseUrl)
                    }
                },
                onEngineReorder = { reorderedEngines ->
                    // ä¿å­˜æ–°çš„æ’åºåˆ°è®¾ç½®ä¸­
                    saveSearchEngineOrder(reorderedEngines)
                }
            )

            // è®¾ç½®é€‚é…å™¨
            browserPreviewEngineList.adapter = draggableEngineAdapter

            // é™„åŠ æ‹–åŠ¨åŠŸèƒ½
            draggableEngineAdapter.attachToRecyclerView(browserPreviewEngineList)

            Log.d(TAG, "æœç´¢å¼•æ“RecyclerViewè®¾ç½®å®Œæˆ")
        } catch (e: Exception) {
            Log.e(TAG, "è®¾ç½®æœç´¢å¼•æ“RecyclerViewå¤±è´¥", e)
        }
    }

    /**
     * ä¿å­˜æœç´¢å¼•æ“æ’åº
     */
    private fun saveSearchEngineOrder(engines: List<com.example.aifloatingball.model.SearchEngine>) {
        try {
            // è¿™é‡Œå¯ä»¥ä¿å­˜åˆ°SharedPreferencesæˆ–æ•°æ®åº“
            val engineNames = engines.map { it.name }
            val editor = getSharedPreferences("search_engine_order", MODE_PRIVATE).edit()
            editor.putString("engine_order", engineNames.joinToString(","))
            editor.apply()
            Log.d(TAG, "æœç´¢å¼•æ“æ’åºå·²ä¿å­˜: ${engineNames.joinToString(", ")}")
        } catch (e: Exception) {
            Log.e(TAG, "ä¿å­˜æœç´¢å¼•æ“æ’åºå¤±è´¥", e)
        }
    }

    private fun setupSearchListeners() {
        // æœç´¢æŒ‰é’®ç‚¹å‡»
        directSearchButton.setOnClickListener {
            performDirectSearch()
        }

        // æœç´¢æ¡†å›è½¦
        directSearchInput.setOnEditorActionListener { _, actionId, _ ->
            if (actionId == EditorInfo.IME_ACTION_SEARCH) {
                performDirectSearch()
                true
            } else {
                false
            }
        }
    }

    private fun performDirectSearch() {
        val query = directSearchInput.text.toString().trim()
        if (query.isNotEmpty()) {
            // ä½¿ç”¨å†…åµŒæµè§ˆå™¨è¿›è¡Œæœç´¢
            showBrowser()
            browserSearchInput.setText(query)
            performBrowserSearch()
        }
    }

    private fun setupAIAssistantCenter() {
        try {
            // è®¾ç½®ViewPager2é€‚é…å™¨
            aiCenterPagerAdapter = com.example.aifloatingball.adapter.AIAssistantCenterPagerAdapter(this)
            aiCenterViewPager.adapter = aiCenterPagerAdapter
            
            // è®¾ç½®TabLayoutä¸ViewPager2çš„è”åŠ¨
            com.google.android.material.tabs.TabLayoutMediator(aiCenterTabLayout, aiCenterViewPager) { tab, position ->
                when (position) {
                    0 -> tab.text = "ä»»åŠ¡"
                    1 -> tab.text = "AIæŒ‡ä»¤"
                    2 -> tab.text = "APIè®¾ç½®"
                    3 -> tab.text = "è¯­éŸ³æ–‡æœ¬"
                }
            }.attach()
            
            Log.d(TAG, "AIåŠ©æ‰‹ä¸­å¿ƒè®¾ç½®å®Œæˆ")
        } catch (e: Exception) {
            Log.e(TAG, "è®¾ç½®AIåŠ©æ‰‹ä¸­å¿ƒå¤±è´¥", e)
        }
    }

    private fun setupTaskSelection() {
        taskAdapter = TaskTemplateAdapter(SimpleTaskTemplates.templates) { template ->
            selectTask(template)
        }
        taskRecyclerView.layoutManager = GridLayoutManager(this, 2)
        taskRecyclerView.adapter = taskAdapter
    }

    private fun selectTask(template: PromptTemplate) {
        Log.d(TAG, "é€‰æ‹©ä»»åŠ¡: ${template.intentName}")
        currentTemplate = template
        userPromptData = UserPromptData(template.intentId)
        currentStepIndex = 0
        showStepGuidance()
    }

    private fun showChat() {
        try {
            currentState = UIState.CHAT
            chatLayout.visibility = View.VISIBLE
            aiAssistantCenterLayout.visibility = View.GONE
            taskSelectionLayout.visibility = View.GONE
            stepGuidanceLayout.visibility = View.GONE
            promptPreviewLayout.visibility = View.GONE
            voiceLayout.visibility = View.GONE
            appSearchLayout.visibility = View.GONE
            browserLayout.visibility = View.GONE
            settingsLayout.visibility = View.GONE

            // åŒæ­¥ç¾¤èŠæ•°æ®ï¼Œç¡®ä¿æ˜¾ç¤ºæœ€æ–°çš„ç¾¤èŠåˆ—è¡¨
            try {
                if (::unifiedGroupChatManager.isInitialized) {
                    syncGroupChatsFromUnifiedManager()
                    // åˆ·æ–°å½“å‰æ˜¾ç¤ºçš„è”ç³»äººåˆ—è¡¨
                    chatContactAdapter?.updateContacts(allContacts)
                    Log.d(TAG, "showChat: å·²åŒæ­¥ç¾¤èŠæ•°æ®å¹¶åˆ·æ–°æ˜¾ç¤º")
                } else {
                    Log.w(TAG, "showChat: unifiedGroupChatManageræœªåˆå§‹åŒ–ï¼Œè·³è¿‡æ•°æ®åŒæ­¥")
                }
            } catch (e: Exception) {
                Log.e(TAG, "showChat: åŒæ­¥ç¾¤èŠæ•°æ®å¤±è´¥", e)
            }

            // æ›´æ–°Tabé¢œè‰²çŠ¶æ€
            updateTabColors()
        } catch (e: Exception) {
            Log.e(TAG, "showChat: æ˜¾ç¤ºèŠå¤©ç•Œé¢å¤±è´¥", e)
        }
    }

    private fun showAIAssistantCenter() {
        currentState = UIState.AI_ASSISTANT_CENTER
        chatLayout.visibility = View.GONE
        aiAssistantCenterLayout.visibility = View.VISIBLE
        taskSelectionLayout.visibility = View.GONE
        stepGuidanceLayout.visibility = View.GONE
        promptPreviewLayout.visibility = View.GONE
        voiceLayout.visibility = View.GONE
        appSearchLayout.visibility = View.GONE
        browserLayout.visibility = View.GONE
        settingsLayout.visibility = View.GONE

        // æ›´æ–°tabé¢œè‰²
        updateTabColors()
    }

    private fun showTaskSelection() {
        currentState = UIState.TASK_SELECTION
        chatLayout.visibility = View.GONE
        aiAssistantCenterLayout.visibility = View.GONE
        taskSelectionLayout.visibility = View.VISIBLE
        stepGuidanceLayout.visibility = View.GONE
        promptPreviewLayout.visibility = View.GONE
        voiceLayout.visibility = View.GONE
        appSearchLayout.visibility = View.GONE
        browserLayout.visibility = View.GONE
        settingsLayout.visibility = View.GONE

        // æ›´æ–°Tabé¢œè‰²çŠ¶æ€
        updateTabColors()
    }

    private fun showStepGuidance() {
        currentState = UIState.STEP_GUIDANCE
        chatLayout.visibility = View.GONE
        aiAssistantCenterLayout.visibility = View.GONE
        taskSelectionLayout.visibility = View.GONE
        stepGuidanceLayout.visibility = View.VISIBLE
        promptPreviewLayout.visibility = View.GONE
        voiceLayout.visibility = View.GONE
        appSearchLayout.visibility = View.GONE
        browserLayout.visibility = View.GONE
        settingsLayout.visibility = View.GONE

        setupCurrentStep()
        // æ›´æ–°Tabé¢œè‰²çŠ¶æ€
        updateTabColors()
    }

    private fun showPromptPreview() {
        currentState = UIState.PROMPT_PREVIEW
        chatLayout.visibility = View.GONE
        aiAssistantCenterLayout.visibility = View.GONE
        taskSelectionLayout.visibility = View.GONE
        stepGuidanceLayout.visibility = View.GONE
        promptPreviewLayout.visibility = View.VISIBLE
        voiceLayout.visibility = View.GONE
        appSearchLayout.visibility = View.GONE
        browserLayout.visibility = View.GONE
        settingsLayout.visibility = View.GONE

        generateFinalPrompt()
        // æ›´æ–°Tabé¢œè‰²çŠ¶æ€
        updateTabColors()
    }

    private fun setupCurrentStep() {
        val template = currentTemplate ?: return
        val fields = template.fields

        Log.d(TAG, "è®¾ç½®å½“å‰æ­¥éª¤: $currentStepIndex, æ€»æ­¥éª¤æ•°: ${fields.size}")

        if (currentStepIndex >= fields.size) {
            // æ‰€æœ‰æ­¥éª¤å®Œæˆï¼Œæ˜¾ç¤ºé¢„è§ˆ
            Log.d(TAG, "æ‰€æœ‰æ­¥éª¤å®Œæˆï¼Œæ˜¾ç¤ºé¢„è§ˆ")
            showPromptPreview()
            return
        }

        val currentField = fields[currentStepIndex]

        // æ›´æ–°æ ‡é¢˜å’Œé—®é¢˜
        stepTitleText.text = "${template.intentName} - æ­¥éª¤ ${currentStepIndex + 1}/${fields.size}"
        stepQuestionText.text = currentField.question

        // éšè—æ‰€æœ‰è¾“å…¥ç»„ä»¶
        stepInputLayout.visibility = View.GONE
        stepChoiceGroup.visibility = View.GONE
        stepMultiChoiceLayout.visibility = View.GONE

        // æ ¹æ®å­—æ®µç±»å‹æ˜¾ç¤ºå¯¹åº”çš„è¾“å…¥ç»„ä»¶
        when (currentField.type) {
            FieldType.TEXT_INPUT -> {
                stepInputLayout.visibility = View.VISIBLE
                stepInputText.setText(userPromptData.collectedData[currentField.id]?.toString() ?: "")
            }
            FieldType.SINGLE_CHOICE -> {
                stepChoiceGroup.visibility = View.VISIBLE
                setupSingleChoice(currentField)
            }
            FieldType.MULTIPLE_CHOICE -> {
                stepMultiChoiceLayout.visibility = View.VISIBLE
                setupMultipleChoice(currentField)
            }
        }

        // è®¾ç½®æŒ‰é’®çŠ¶æ€
        val canGoPrev = currentStepIndex > 0
        prevStepButton.isEnabled = true  // æ€»æ˜¯å¯ç”¨ï¼Œå› ä¸ºç¬¬ä¸€æ­¥æ—¶å¯ä»¥è¿”å›é¦–é¡µ
        prevStepButton.text = if (canGoPrev) "ä¸Šä¸€æ­¥" as CharSequence else "è¿”å›é¦–é¡µ" as CharSequence
        skipStepButton.visibility = if (currentField.isOptional) View.VISIBLE else View.GONE

        Log.d(TAG, "ä¸Šä¸€æ­¥æŒ‰é’®çŠ¶æ€: enabled=true, text=${prevStepButton.text}")

        // è®¾ç½®æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        setupStepButtons(currentField)
    }

    private fun setupSingleChoice(field: PromptField) {
        stepChoiceGroup.removeAllViews()
        field.options?.forEachIndexed { index, option ->
            val radioButton = RadioButton(this).apply {
                text = option
                id = index
                isChecked = userPromptData.collectedData[field.id] == option
            }
            stepChoiceGroup.addView(radioButton)
        }
    }

    private fun setupMultipleChoice(field: PromptField) {
        stepMultiChoiceLayout.removeAllViews()
        val selectedOptions = userPromptData.collectedData[field.id] as? List<String> ?: emptyList()

        field.options?.forEach { option ->
            val checkBox = CheckBox(this).apply {
                text = option
                isChecked = selectedOptions.contains(option)
            }
            stepMultiChoiceLayout.addView(checkBox)
        }
    }

    private fun setupStepButtons(field: PromptField) {
        // æ¸…é™¤ä¹‹å‰çš„ç›‘å¬å™¨ï¼Œé¿å…é‡å¤è®¾ç½®
        nextStepButton.setOnClickListener(null)
        prevStepButton.setOnClickListener(null)
        skipStepButton.setOnClickListener(null)

        nextStepButton.setOnClickListener {
            Log.d(TAG, "ä¸‹ä¸€æ­¥æŒ‰é’®è¢«ç‚¹å‡»ï¼Œå½“å‰æ­¥éª¤: $currentStepIndex")
            if (collectCurrentStepData(field)) {
                currentStepIndex++
                setupCurrentStep()
            }
        }

        prevStepButton.setOnClickListener {
            Log.d(TAG, "ä¸Šä¸€æ­¥æŒ‰é’®è¢«ç‚¹å‡»ï¼Œå½“å‰æ­¥éª¤: $currentStepIndex")
            if (currentStepIndex > 0) {
                currentStepIndex--
                Log.d(TAG, "è¿”å›åˆ°æ­¥éª¤: $currentStepIndex")
                setupCurrentStep()
            } else {
                // å¦‚æœæ˜¯ç¬¬ä¸€æ­¥ï¼Œè¿”å›AIåŠ©æ‰‹ä¸­å¿ƒé¡µé¢
                Log.d(TAG, "å·²æ˜¯ç¬¬ä¸€æ­¥ï¼Œè¿”å›AIåŠ©æ‰‹ä¸­å¿ƒé¡µé¢")
                showAIAssistantCenter()
            }
        }

        skipStepButton.setOnClickListener {
            Log.d(TAG, "è·³è¿‡æŒ‰é’®è¢«ç‚¹å‡»ï¼Œå½“å‰æ­¥éª¤: $currentStepIndex")
            if (field.isOptional) {
                currentStepIndex++
                setupCurrentStep()
            }
        }
    }

    private fun collectCurrentStepData(field: PromptField): Boolean {
        when (field.type) {
            FieldType.TEXT_INPUT -> {
                val text = stepInputText.text.toString().trim()
                if (text.isEmpty() && !field.isOptional) {
                    Toast.makeText(this, "è¯·å¡«å†™å¿…å¡«ä¿¡æ¯", Toast.LENGTH_SHORT).show()
                    return false
                }
                if (text.isNotEmpty()) {
                    userPromptData.collectedData[field.id] = text
                }
            }
            FieldType.SINGLE_CHOICE -> {
                val selectedId = stepChoiceGroup.checkedRadioButtonId
                if (selectedId == -1 && !field.isOptional) {
                    Toast.makeText(this, "è¯·é€‰æ‹©ä¸€ä¸ªé€‰é¡¹", Toast.LENGTH_SHORT).show()
                    return false
                }
                if (selectedId != -1) {
                    val selectedOption = field.options?.get(selectedId)
                    if (selectedOption != null) {
                        userPromptData.collectedData[field.id] = selectedOption
                    }
                }
            }
            FieldType.MULTIPLE_CHOICE -> {
                val selectedOptions = mutableListOf<String>()
                for (i in 0 until stepMultiChoiceLayout.childCount) {
                    val checkBox = stepMultiChoiceLayout.getChildAt(i) as CheckBox
                    if (checkBox.isChecked) {
                        selectedOptions.add(checkBox.text.toString())
                    }
                }
                if (selectedOptions.isEmpty() && !field.isOptional) {
                    Toast.makeText(this, "è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªé€‰é¡¹", Toast.LENGTH_SHORT).show()
                    return false
                }
                if (selectedOptions.isNotEmpty()) {
                    userPromptData.collectedData[field.id] = selectedOptions
                }
            }
        }
        return true
    }

    private fun generateFinalPrompt() {
        val template = currentTemplate ?: return
        var finalPrompt = template.finalPromptFormat

        // æ›¿æ¢å ä½ç¬¦
        userPromptData.collectedData.forEach { (key, value) ->
            val placeholder = "{$key}"
            val replacement = when (value) {
                is List<*> -> value.joinToString("ã€")
                else -> value.toString()
            }
            finalPrompt = finalPrompt.replace(placeholder, replacement)
        }

        finalPromptText.text = finalPrompt
        recommendedEnginesText.text = "æ¨èå¼•æ“ï¼š${template.recommendedEngines.joinToString("ã€")}"

        // è®¾ç½®æŒ‰é’®äº‹ä»¶
        executeSearchButton.setOnClickListener {
            executeSearch(finalPrompt, template.recommendedEngines.firstOrNull() ?: "deepseek")
        }

        backToTasksButton.setOnClickListener {
            showAIAssistantCenter()
        }
    }

    private fun executeSearch(prompt: String, engineKey: String) {
        Log.d(TAG, "æ‰§è¡Œæœç´¢: prompt='$prompt', engine='$engineKey'")

        // ä½¿ç”¨å†…åµŒæµè§ˆå™¨è¿›è¡Œæœç´¢
        showBrowser()
        browserSearchInput.setText(prompt)

        // æ ¹æ®å¼•æ“ç±»å‹æ„å»ºæœç´¢URL
        val searchUrl = when (engineKey) {
            "Google" -> "https://www.google.com/search?q=${java.net.URLEncoder.encode(prompt, "UTF-8")}"
            "Bing" -> "https://www.bing.com/search?q=${java.net.URLEncoder.encode(prompt, "UTF-8")}"
            "ç™¾åº¦" -> "https://m.baidu.com/s?wd=${java.net.URLEncoder.encode(prompt, "UTF-8")}"
            else -> "https://www.google.com/search?q=${java.net.URLEncoder.encode(prompt, "UTF-8")}"
        }

        loadBrowserContent(searchUrl)
    }

    private fun handleIntentData() {
        intent?.let {
            val searchContent = it.getStringExtra("search_content")
            if (!searchContent.isNullOrEmpty()) {
                // å¦‚æœæœ‰é¢„å¡«å†…å®¹ï¼Œå¯ä»¥é€‰æ‹©ç›´æ¥å¡«å…¥ç¬¬ä¸€ä¸ªæ–‡æœ¬å­—æ®µ
                Log.d(TAG, "æ”¶åˆ°æœç´¢å†…å®¹: $searchContent")
                // TODO: æ ¹æ®éœ€è¦å®ç°é¢„å¡«é€»è¾‘
            }
            
            // æ£€æŸ¥æ˜¯å¦æœ‰è½¯ä»¶tabçš„æœç´¢å…³é”®è¯
            val appSearchQuery = it.getStringExtra("search_query")
                ?: it.getStringExtra("app_search_query")
                ?: it.getStringExtra("query")
            
            if (!appSearchQuery.isNullOrEmpty() && currentState == UIState.APP_SEARCH) {
                // å¦‚æœå·²ç»åœ¨è½¯ä»¶tabï¼Œç«‹å³å¤„ç†æœç´¢å…³é”®è¯
                handler.postDelayed({
                    applyAppSearchQuery(appSearchQuery)
                }, 300)
            }
        }
    }
    
    /**
     * å¤„ç†è½¯ä»¶tabçš„intentæœç´¢å…³é”®è¯
     * åˆ¤æ–­æ˜¯å¦æœ‰æœç´¢å…³é”®è¯ï¼Œå¦‚æœæœ‰åˆ™å¡«å……åˆ°æœç´¢æ¡†ï¼Œå¦‚æœæ²¡æœ‰åˆ™æ­£å¸¸æ˜¾ç¤ºåº”ç”¨åˆ—è¡¨
     */
    private fun handleAppSearchIntentQuery() {
        try {
            val currentIntent = intent
            if (currentIntent == null) {
                Log.d(TAG, "handleAppSearchIntentQuery: intentä¸ºnullï¼Œæ­£å¸¸æ˜¾ç¤ºåº”ç”¨åˆ—è¡¨")
                return
            }
            
            // å°è¯•ä»å¤šä¸ªå¯èƒ½çš„keyä¸­è·å–æœç´¢å…³é”®è¯
            val searchQuery = currentIntent.getStringExtra("search_query")
                ?: currentIntent.getStringExtra("app_search_query")
                ?: currentIntent.getStringExtra("query")
                ?: currentIntent.getStringExtra("search_content")
            
            if (!searchQuery.isNullOrEmpty()) {
                Log.d(TAG, "æ£€æµ‹åˆ°intentæœç´¢å…³é”®è¯: $searchQuery")
                // å»¶è¿Ÿåº”ç”¨ï¼Œç¡®ä¿æœç´¢æ¡†å·²åˆå§‹åŒ–
                handler.postDelayed({
                    applyAppSearchQuery(searchQuery)
                }, 300)
            } else {
                Log.d(TAG, "æ²¡æœ‰æ£€æµ‹åˆ°intentæœç´¢å…³é”®è¯ï¼Œæ­£å¸¸æ˜¾ç¤ºåº”ç”¨åˆ—è¡¨")
                // æ²¡æœ‰æœç´¢å…³é”®è¯ï¼Œæ­£å¸¸æ˜¾ç¤ºåº”ç”¨åˆ—è¡¨
                // ç¡®ä¿æœç´¢æ¡†ä¸ºç©º
                if (::appSearchInput.isInitialized) {
                    appSearchInput.text?.clear()
                    if (::appSearchAdapter.isInitialized) {
                        appSearchAdapter.updateSearchQuery("")
                    }
                    appSearchHint?.text = "é€‰æ‹©${currentAppCategory.displayName}åº”ç”¨è¿›è¡Œæœç´¢"
                }
            }
        } catch (e: Exception) {
            Log.e(TAG, "å¤„ç†è½¯ä»¶tabæœç´¢å…³é”®è¯å¤±è´¥", e)
        }
    }
    
    /**
     * åº”ç”¨æœç´¢å…³é”®è¯åˆ°æœç´¢æ¡†
     * @param query æœç´¢å…³é”®è¯
     */
    private fun applyAppSearchQuery(query: String) {
        try {
            if (!::appSearchInput.isInitialized) {
                Log.w(TAG, "applyAppSearchQuery: appSearchInputæœªåˆå§‹åŒ–ï¼Œå»¶è¿Ÿé‡è¯•")
                handler.postDelayed({
                    applyAppSearchQuery(query)
                }, 200)
                return
            }
            
            val trimmedQuery = query.trim()
            if (trimmedQuery.isEmpty()) {
                Log.d(TAG, "applyAppSearchQuery: æœç´¢å…³é”®è¯ä¸ºç©ºï¼Œè·³è¿‡")
                return
            }
            
            Log.d(TAG, "åº”ç”¨æœç´¢å…³é”®è¯åˆ°æœç´¢æ¡†: $trimmedQuery")
            
            // è®¾ç½®æœç´¢æ¡†æ–‡æœ¬
            appSearchInput.setText(trimmedQuery)
            appSearchInput.setSelection(trimmedQuery.length)
            
            // æ›´æ–°æœç´¢é€‚é…å™¨çš„æŸ¥è¯¢ï¼ˆç”¨äºé«˜äº®æ˜¾ç¤ºï¼‰
            if (::appSearchAdapter.isInitialized) {
                appSearchAdapter.updateSearchQuery(trimmedQuery)
            }
            
            // æ›´æ–°æç¤ºæ–‡æœ¬
            appSearchHint?.text = "è¾“å…¥å…³é”®è¯ï¼š$trimmedQueryï¼Œç‚¹å‡»åº”ç”¨å›¾æ ‡è¿›è¡Œæœç´¢"
            
            // æ›´æ–°è¾“å…¥æ¡†å›¾æ ‡ï¼ˆæ˜¾ç¤ºæ¸…ç©ºæŒ‰é’®ï¼‰
            updateInputLayoutEndIcon(true)
            updateHistoryButtonIcon(true)
            
            Log.d(TAG, "æœç´¢å…³é”®è¯å·²åº”ç”¨åˆ°æœç´¢æ¡†")
        } catch (e: Exception) {
            Log.e(TAG, "åº”ç”¨æœç´¢å…³é”®è¯å¤±è´¥", e)
        }
    }

    override fun onBackPressed() {
        // å¦‚æœå¤„äºé˜…è¯»æ¨¡å¼2ï¼Œå…ˆé€€å‡ºé˜…è¯»æ¨¡å¼2
        val readerManager2 = com.example.aifloatingball.reader.NovelReaderManager.getInstance(this)
        if (readerManager2.isReaderModeActive) {
            novelReaderUI2?.exitReaderMode2()
            return
        }
        // å¦‚æœåˆ†æ”¯è§†å›¾å¯è§ï¼Œåˆ™ä¼˜å…ˆå¤„ç†å®ƒçš„è¿”å›é€»è¾‘
        if (promptBranchManager.isBranchViewVisible) {
            if (promptBranchManager.canNavigateBack()) {
                promptBranchManager.navigateBack()
                } else {
                promptBranchManager.hideBranchView()
            }
            return // æ¶ˆè´¹è¿”å›äº‹ä»¶
        }

        // å¦‚æœåœ¨æµè§ˆå™¨é¡µé¢ï¼Œå¤„ç†è¿”å›é€»è¾‘
        if (currentState == UIState.BROWSER) {
            // å¦‚æœå¡ç‰‡é¢„è§ˆè¦†ç›–å±‚å¯è§ï¼Œå…ˆå…³é—­é¢„è§ˆ
            if (::cardPreviewOverlay.isInitialized && cardPreviewOverlay.visibility == View.VISIBLE) {
                cardPreviewOverlay.hide()
                return
            }

            // å¦‚æœæ‰‹åŠ¿æç¤ºè¦†ç›–å±‚å¯è§ï¼Œå…ˆå…³é—­æç¤º
            if (browserGestureOverlay.visibility == View.VISIBLE) {
                hideGestureHint()
                return
            }

            // å¦‚æœæŠ½å±‰æ‰“å¼€ï¼Œå…ˆå…³é—­æŠ½å±‰
            if (browserLayout.isDrawerOpen(GravityCompat.START)) {
                browserLayout.closeDrawer(GravityCompat.START)
                return
            }

            // æ£€æŸ¥æ˜¯å¦æœ‰å¯è¿”å›çš„é¡µé¢
            val hasPaperStackTabs = paperStackWebViewManager?.getTabCount() ?: 0 > 0
            val canPaperStackGoBack = paperStackWebViewManager?.canGoBack() == true
            val canUnifiedGoBack = unifiedWebViewManager.canGoBack()
            
            // å¦‚æœæœ‰å¯è¿”å›çš„é¡µé¢ï¼Œæ‰§è¡Œè¿”å›
            if (hasPaperStackTabs && canPaperStackGoBack) {
                performUnifiedWebViewBack("ç³»ç»Ÿè¿”å›é”®")
                return
            } else if (canUnifiedGoBack) {
                performUnifiedWebViewBack("ç³»ç»Ÿè¿”å›é”®")
                return
            } else if (hasPaperStackTabs) {
                // æœ‰æ ‡ç­¾é¡µä½†æ— æ³•è¿”å›ï¼ˆå·²åœ¨é¦–é¡µï¼‰ï¼Œæ˜¾ç¤ºæµè§ˆå™¨é¦–é¡µ
                showBrowserHome()
                return
            } else {
                // æ²¡æœ‰æ ‡ç­¾é¡µï¼Œä¹Ÿæ²¡æœ‰å¯è¿”å›çš„é¡µé¢ï¼Œå…è®¸è¿”å›åˆ°ä¸Šä¸€çº§
                // ç»§ç»­æ‰§è¡Œï¼Œå…è®¸è¿”å›åˆ°å…¶ä»–çŠ¶æ€
            }
        }

        // å¦‚æœåœ¨æ­¥éª¤å¼•å¯¼é¡µé¢ï¼Œå¤„ç†è¿”å›é€»è¾‘
        if (currentState == UIState.STEP_GUIDANCE) {
            if (currentStepIndex > 0) {
                // è¿”å›ä¸Šä¸€æ­¥
                currentStepIndex--
                setupCurrentStep()
            } else {
                // å¦‚æœæ˜¯ç¬¬ä¸€æ­¥ï¼Œè¿”å›AIåŠ©æ‰‹ä¸­å¿ƒé¡µé¢
                showAIAssistantCenter()
            }
            return
        }

        // å¦‚æœåœ¨æç¤ºé¢„è§ˆé¡µé¢ï¼Œè¿”å›æ­¥éª¤å¼•å¯¼
        if (currentState == UIState.PROMPT_PREVIEW) {
            showStepGuidance()
            return
        }

        // å¦åˆ™ï¼Œæ‰§è¡ŒActivityçš„é»˜è®¤è¿”å›é€»è¾‘
        super.onBackPressed()
    }

    /**
     * åˆ†æ”¯è§†å›¾éšè—æ—¶çš„å›è°ƒ
     */
    override fun onBranchViewHidden() {
        applyBackgroundBlur(false)
        setBottomNavigationEnabled(true) // æ¢å¤åº•éƒ¨å¯¼èˆª
    }

    /**
     * æ˜¾ç¤ºè¯­éŸ³æç¤ºåˆ†æ”¯è§†å›¾
     */
    private fun showPromptBranches() {
        if (promptBranchManager.isBranchViewVisible) {
            return
        }

        val rootView = window.decorView.rootView as ViewGroup
        val micCenterX = voiceMicContainer.x + voiceMicContainer.width / 2
        val micCenterY = voiceMicContainer.y + voiceMicContainer.height / 2

        promptBranchManager.showBranchView(rootView, voiceTextInput, micCenterX, micCenterY)
        applyBackgroundBlur(true)
        setBottomNavigationEnabled(false) // ç¦ç”¨åº•éƒ¨å¯¼èˆª
    }

    /**
     * å¯ç”¨æˆ–ç¦ç”¨åº•éƒ¨å¯¼èˆªæ 
     */
    private fun setBottomNavigationEnabled(enabled: Boolean) {
        val bottomNav = findViewById<LinearLayout>(R.id.bottom_navigation)
        for (i in 0 until bottomNav.childCount) {
            val tab = bottomNav.getChildAt(i)
            tab.isEnabled = enabled
            tab.alpha = if (enabled) 1.0f else 0.5f
        }
    }

    /**
     * åº”ç”¨èƒŒæ™¯æ¨¡ç³Šæ•ˆæœ
     * @param blur æ˜¯å¦æ¨¡ç³Š
     */
    fun applyBackgroundBlur(blur: Boolean) {
        // è·å–éœ€è¦ä¿æŒæ¸…æ™°çš„è§†å›¾
        val textInputLayout = findViewById<LinearLayout>(R.id.voice_text_input_layout)

        if (blur) {
            // åº”ç”¨æ¨¡ç³Šæ•ˆæœåˆ°æ•´ä¸ªå¸ƒå±€
            voiceLayout.alpha = 0.7f

            // ä¿æŒæ–‡æœ¬è¾“å…¥æ¡†æ¸…æ™°
            textInputLayout.alpha = 1.0f
            textInputLayout.elevation = 10f

            // éšè—éº¦å…‹é£å®¹å™¨
            voiceMicContainer.animate().alpha(0.3f).setDuration(200).start()
        } else {
            // æ¢å¤æ­£å¸¸æ˜¾ç¤º
            voiceLayout.alpha = 1.0f
            textInputLayout.elevation = 0f
            voiceMicContainer.animate().alpha(1.0f).setDuration(200).start()
        }
    }

    private fun resetVoiceUI() {
        voiceTextInput.setText("")
        recognizedText = ""
        currentPartialText = ""
        lastRecognizedText = ""
        isListening = false
        voiceSearchButton.isEnabled = false

        // æ ¹æ®å½“å‰è¯­éŸ³æ”¯æŒæƒ…å†µè®¾ç½®UIçŠ¶æ€
        val supportInfo = voiceSupportInfo
        if (supportInfo != null) {
            updateVoiceButtonState(supportInfo)
        } else {
            // å¦‚æœè¿˜æ²¡æœ‰æ£€æµ‹ç»“æœï¼Œæ˜¾ç¤ºé»˜è®¤çŠ¶æ€
            voiceStatusText.text = "æ­£åœ¨æ£€æµ‹è¯­éŸ³åŠŸèƒ½..."
            voiceMicContainer.visibility = View.VISIBLE
        }

        // æ¢å¤é»˜è®¤èƒŒæ™¯è‰²
        voiceMicContainer.setCardBackgroundColor(ContextCompat.getColor(this, R.color.simple_mode_accent_light))
    }

    private fun toggleVoiceRecognition() {
        Log.d(TAG, "éº¦å…‹é£æŒ‰é’®è¢«ç‚¹å‡» - å½“å‰æ¨¡å¼: ${if (isMicInTTSMode) "TTSæœ—è¯»" else "è¯­éŸ³è¾“å…¥"}")
        
        // æ£€æŸ¥è¯­éŸ³æ”¯æŒæƒ…å†µ
        val supportInfo = voiceSupportInfo
        if (supportInfo == null) {
            Log.w(TAG, "è¯­éŸ³æ”¯æŒä¿¡æ¯ä¸ºç©º")
            voiceStatusText.text = "è¯­éŸ³åŠŸèƒ½æ£€æµ‹ä¸­ï¼Œè¯·ç¨åé‡è¯•"
            return
        }

        // å¦‚æœæ­£åœ¨è¯­éŸ³è¯†åˆ«ï¼Œå…ˆåœæ­¢
        if (isListening) {
            Log.d(TAG, "æ­£åœ¨è¯­éŸ³è¯†åˆ«ï¼Œåœæ­¢è¯†åˆ«")
            stopVoiceRecognition()
            return
        }

        // å¦‚æœå½“å‰æ˜¯TTSæœ—è¯»æ¨¡å¼ï¼Œå¼¹å‡ºTTSè®¾ç½®å¯¹è¯æ¡†
        if (isMicInTTSMode) {
            Log.d(TAG, "TTSæœ—è¯»æ¨¡å¼ - å¼¹å‡ºè®¾ç½®å¯¹è¯æ¡†")
            showSimpleModeTTSSettingsDialog()
            return
        }

        // è¯­éŸ³è¾“å…¥æ¨¡å¼ - å¯åŠ¨è¯­éŸ³è¯†åˆ«
        if (supportInfo.isSupported) {
            Log.d(TAG, "å¯åŠ¨è¯­éŸ³è¯†åˆ«")
            startVoiceRecognition()
        } else {
            // è¿™ç§æƒ…å†µä¸åº”è¯¥å‘ç”Ÿï¼Œå› ä¸ºæŒ‰é’®å·²ç»éšè—äº†
            Log.w(TAG, "è¯­éŸ³æŒ‰é’®è¢«ç‚¹å‡»ä½†ä¸æ”¯æŒSpeechRecognizer")
            voiceStatusText.text = "è¯­éŸ³åŠŸèƒ½ä¸å¯ç”¨"
        }
    }



    private fun startVoiceRecognition() {
        // æ£€æŸ¥æƒé™
        if (ContextCompat.checkSelfPermission(this, Manifest.permission.RECORD_AUDIO)
            != PackageManager.PERMISSION_GRANTED) {
            ActivityCompat.requestPermissions(this,
                arrayOf(Manifest.permission.RECORD_AUDIO), 1001)
            return
        }

        // æ£€æŸ¥æ˜¯å¦å¯ç”¨Voskç¦»çº¿è¯­éŸ³è¯†åˆ«
        val useVosk = settingsManager.getBoolean("use_vosk_offline_voice", false)
        
        if (useVosk) {
            // ä½¿ç”¨Voskç¦»çº¿è¯­éŸ³è¯†åˆ«
            startVoskRecognition()
        } else {
            // ä½¿ç”¨ç³»ç»ŸSpeechRecognizer
            startSystemVoiceRecognition()
        }
    }
    
    /**
     * å¯åŠ¨ç³»ç»Ÿè¯­éŸ³è¯†åˆ«
     */
    private fun startSystemVoiceRecognition() {
        // é‡Šæ”¾ä¹‹å‰çš„è¯†åˆ«å™¨
        releaseSpeechRecognizer()
        releaseVoskManager()

        // åˆ›å»ºæ–°çš„è¯­éŸ³è¯†åˆ«å™¨
        speechRecognizer = SpeechRecognizer.createSpeechRecognizer(this)
        speechRecognizer?.setRecognitionListener(createVoiceRecognitionListener())

        // åˆ›å»ºè¯†åˆ«æ„å›¾
        val intent = Intent(RecognizerIntent.ACTION_RECOGNIZE_SPEECH).apply {
            putExtra(RecognizerIntent.EXTRA_LANGUAGE_MODEL, RecognizerIntent.LANGUAGE_MODEL_FREE_FORM)
            putExtra(RecognizerIntent.EXTRA_LANGUAGE, "zh-CN")
            putExtra(RecognizerIntent.EXTRA_PARTIAL_RESULTS, true)
            putExtra(RecognizerIntent.EXTRA_MAX_RESULTS, 1)
        }

        try {
            isListening = true
            updateVoiceListeningState(true)
            speechRecognizer?.startListening(intent)
            Log.d(TAG, "ç³»ç»Ÿè¯­éŸ³è¯†åˆ«å·²å¯åŠ¨")
        } catch (e: Exception) {
            Log.e(TAG, "SpeechRecognizerå¯åŠ¨å¤±è´¥", e)
            voiceStatusText.text = "è¯­éŸ³è¯†åˆ«å¯åŠ¨å¤±è´¥"
            isListening = false
            updateVoiceListeningState(false)
        }
    }
    
    /**
     * å¯åŠ¨Voskç¦»çº¿è¯­éŸ³è¯†åˆ«
     */
    private fun startVoskRecognition() {
        Log.d(TAG, "å¯åŠ¨Voskç¦»çº¿è¯­éŸ³è¯†åˆ«")
        
        // æ£€æŸ¥å½•éŸ³æƒé™
        val hasPermission = ContextCompat.checkSelfPermission(this, Manifest.permission.RECORD_AUDIO) == PackageManager.PERMISSION_GRANTED
        if (!hasPermission) {
            Log.e(TAG, "Voskè¯†åˆ«éœ€è¦å½•éŸ³æƒé™ï¼Œä½†æƒé™æœªæˆäºˆ")
            voiceStatusText.text = "éœ€è¦å½•éŸ³æƒé™æ‰èƒ½ä½¿ç”¨Voskè¯­éŸ³è¯†åˆ«"
            isListening = false
            updateVoiceListeningState(false)
            updateCapsuleRecordingState(false)
            // è¯·æ±‚æƒé™
            ActivityCompat.requestPermissions(this,
                arrayOf(Manifest.permission.RECORD_AUDIO), 1001)
            return
        }
        
        // é‡Šæ”¾ç³»ç»Ÿè¯­éŸ³è¯†åˆ«å™¨
        releaseSpeechRecognizer()
        
        // ä»è®¾ç½®ä¸­è¯»å–æ¨¡å‹ç±»å‹
        val savedModelType = settingsManager.getString("vosk_model_type", "SMALL")
        val modelType = if (savedModelType == "FULL") {
            VoskManager.ModelType.FULL
        } else {
            VoskManager.ModelType.SMALL
        }
        
        // åˆå§‹åŒ–VoskManagerï¼ˆå¦‚æœå°šæœªåˆå§‹åŒ–ï¼‰
        if (voskManager == null) {
            voskManager = VoskManager(this)
        }
        
        // ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„æ¨¡å‹ç±»å‹ï¼ˆå³ä½¿voskManagerå·²å­˜åœ¨ï¼Œä¹Ÿè¦æ›´æ–°æ¨¡å‹ç±»å‹ï¼‰
        voskManager?.setModelType(modelType)
        Log.d(TAG, "ä½¿ç”¨Voskæ¨¡å‹ç±»å‹: $modelType")
        
        // æ£€æŸ¥è¯¥æ¨¡å‹ç±»å‹æ˜¯å¦å·²ä¸‹è½½
        val downloadedTypes = voskManager?.getDownloadedModelTypes() ?: emptyList()
        if (!downloadedTypes.contains(modelType)) {
            Log.e(TAG, "Voskæ¨¡å‹ç±»å‹ $modelType æœªä¸‹è½½ï¼Œå·²ä¸‹è½½çš„ç±»å‹: $downloadedTypes")
            voiceStatusText.text = "Voskæ¨¡å‹æœªä¸‹è½½ï¼Œè¯·å…ˆä¸‹è½½æ¨¡å‹"
            isListening = false
            updateVoiceListeningState(false)
            updateCapsuleRecordingState(false)
            return
        }
        
        // æ£€æŸ¥use_vosk_offline_voiceè®¾ç½®
        val useVosk = settingsManager.getBoolean("use_vosk_offline_voice", false)
        if (!useVosk) {
            Log.e(TAG, "Voskç¦»çº¿è¯­éŸ³è¯†åˆ«å¼€å…³æœªæ‰“å¼€")
            voiceStatusText.text = "è¯·å…ˆæ‰“å¼€Voskç¦»çº¿è¯­éŸ³è¯†åˆ«å¼€å…³"
            isListening = false
            updateVoiceListeningState(false)
            updateCapsuleRecordingState(false)
            return
        }
        
        // è®¾ç½®å›è°ƒï¼ˆæ¯æ¬¡å¯åŠ¨è¯†åˆ«æ—¶éƒ½é‡æ–°è®¾ç½®ï¼Œç¡®ä¿ä½¿ç”¨æœ€æ–°çš„å›è°ƒï¼‰
        if (voskManager != null) {
            voskManager?.setCallback(object : VoskManager.VoskCallback {
                override fun onPartialResult(text: String) {
                    handler.post {
                        // å¦‚æœå·²æš‚åœï¼Œç«‹å³åœæ­¢å¤„ç†
                        if (isVoiceRecognitionPaused) {
                            Log.d(TAG, "è¯­éŸ³è¯†åˆ«å·²æš‚åœï¼Œå¿½ç•¥Voskéƒ¨åˆ†ç»“æœ")
                            return@post
                        }
                        
                        // å¤„ç†éƒ¨åˆ†è¯†åˆ«ç»“æœ
                        if (text.isNotEmpty() && text != "{\"partial\" : \"\"}") {
                            try {
                                val jsonObject = org.json.JSONObject(text)
                                val partialText = jsonObject.optString("partial", "").trim()
                                if (partialText.isNotEmpty()) {
                                    // å†æ¬¡æ£€æŸ¥æš‚åœçŠ¶æ€
                                    if (isVoiceRecognitionPaused) {
                                        Log.d(TAG, "åœ¨Voskéƒ¨åˆ†ç»“æœå¤„ç†è¿‡ç¨‹ä¸­æ£€æµ‹åˆ°æš‚åœï¼Œåœæ­¢å¤„ç†")
                                        return@post
                                    }
                                    
                                    // æ£€æŸ¥æ˜¯å¦åŒ…å«å¯ç–‘çš„ä»£ç ç‰‡æ®µæˆ–æ— å…³å†…å®¹ï¼ˆé˜²æ­¢æ— å£°éŸ³æ—¶è¾“å…¥æ— å…³ä»£ç ï¼‰
                                    if (isSuspiciousCode(partialText)) {
                                        Log.w(TAG, "âš ï¸ Voskæ£€æµ‹åˆ°å¯ç–‘ä»£ç ç‰‡æ®µï¼Œå¿½ç•¥éƒ¨åˆ†ç»“æœ: '$partialText'")
                                        return@post
                                    }
                                    
                                    // æ£€æŸ¥éƒ¨åˆ†ç»“æœæ˜¯å¦ä¸å½“å‰æ˜¾ç¤ºæ–‡æœ¬ç›¸åŒï¼ˆé¿å…é‡å¤æ›´æ–°ï¼‰
                                    val currentDisplayText = if (isVoiceCapsuleMode) {
                                        voiceCapsuleTextInput?.text?.toString()?.trim() ?: ""
                                    } else {
                                        voiceTextInput.text.toString().trim()
                                    }
                                    
                                    // å¦‚æœéƒ¨åˆ†ç»“æœä¸å½“å‰æ˜¾ç¤ºæ–‡æœ¬ç›¸åŒæˆ–å·²åŒ…å«ï¼Œè·³è¿‡æ›´æ–°
                                    if (currentDisplayText.contains(partialText) && partialText.length < currentDisplayText.length * 0.9) {
                                        Log.d(TAG, "Voskéƒ¨åˆ†ç»“æœå·²åŒ…å«åœ¨å½“å‰æ–‡æœ¬ä¸­ï¼Œè·³è¿‡: '$partialText'")
                                        return@post
                                    }
                                    
                                    // æ›´æ–°å½“å‰éƒ¨åˆ†ç»“æœï¼ˆç”¨äºåç»­ä¸æœ€ç»ˆç»“æœæ¯”è¾ƒï¼‰
                                    currentPartialText = partialText
                                    
                                    // éƒ¨åˆ†ç»“æœåªæ˜¯ä¸´æ—¶æ˜¾ç¤ºï¼Œä¸ç´¯åŠ åˆ°recognizedText
                                    // æ˜¾ç¤ºå·²ç¡®è®¤æ–‡æœ¬ + å½“å‰éƒ¨åˆ†ç»“æœï¼Œç¡®ä¿ç”¨æˆ·èƒ½çœ‹åˆ°æ‰€æœ‰å†…å®¹
                                    val displayText = if (recognizedText.isEmpty()) {
                                        // æ²¡æœ‰å·²ç¡®è®¤æ–‡æœ¬ï¼Œç›´æ¥æ˜¾ç¤ºéƒ¨åˆ†ç»“æœ
                                        partialText
                                    } else {
                                        // æœ‰å·²ç¡®è®¤æ–‡æœ¬ï¼Œç›´æ¥è¿½åŠ æ˜¾ç¤ºéƒ¨åˆ†ç»“æœ
                                        val trimmedRecognized = recognizedText.trim()
                                        val separator = if (trimmedRecognized.endsWith("ã€‚") || 
                                                            trimmedRecognized.endsWith("ï¼Œ") || 
                                                            trimmedRecognized.endsWith("ï¼Ÿ") ||
                                                            trimmedRecognized.endsWith("ï¼") ||
                                                            trimmedRecognized.endsWith(".") ||
                                                            trimmedRecognized.endsWith(",") ||
                                                            trimmedRecognized.endsWith("?") ||
                                                            trimmedRecognized.endsWith("!")) {
                                            "\n"
                                        } else {
                                            " "
                                        }
                                        "$trimmedRecognized$separator$partialText"
                                    }
                                    
                                    // æ ¹æ®å½“å‰æ¨¡å¼é€‰æ‹©è¾“å…¥æ¡†
                                    if (isVoiceCapsuleMode && voiceCapsuleTextInput != null) {
                                        // èƒ¶å›Šæ¨¡å¼ï¼šä½¿ç”¨èƒ¶å›Šè¾“å…¥æ¡†
                                        voiceCapsuleTextInput?.let { input ->
                                            input.setText(displayText)
                                            input.setSelection(displayText.length)
                                            input.post { input.requestLayout() }
                                            Log.d(TAG, "Voskéƒ¨åˆ†ç»“æœå·²æ›´æ–°åˆ°èƒ¶å›Šè¾“å…¥æ¡†: '$displayText'")
                                        }
                                        // åŒæ­¥åˆ°åŸå§‹è¾“å…¥æ¡†
                                        voiceTextInput.setText(displayText)
                                        voiceTextInput.setSelection(displayText.length)
                                    } else {
                                        // åŸå§‹æ¨¡å¼æˆ–èƒ¶å›Šè¾“å…¥æ¡†æœªåˆå§‹åŒ–ï¼šä½¿ç”¨åŸå§‹è¾“å…¥æ¡†
                                        voiceTextInput.setText(displayText)
                                        voiceTextInput.setSelection(displayText.length)
                                        Log.d(TAG, "Voskéƒ¨åˆ†ç»“æœå·²æ›´æ–°åˆ°åŸå§‹è¾“å…¥æ¡†: '$displayText' (isVoiceCapsuleMode=$isVoiceCapsuleMode, voiceCapsuleTextInput=${voiceCapsuleTextInput != null})")
                                    }
                                    
                                    // å¯ç”¨æœç´¢æŒ‰é’®å’Œä¿å­˜æŒ‰é’®
                                    voiceSearchButton.isEnabled = true
                                    updateSaveButtonVisibility()
                                    Log.d(TAG, "Voskéƒ¨åˆ†ç»“æœ: '$partialText' â†’ æ˜¾ç¤º: '$displayText'")
                                }
                            } catch (e: Exception) {
                                Log.e(TAG, "è§£æVoskéƒ¨åˆ†ç»“æœå¤±è´¥: $text", e)
                            }
                        }
                    }
                }
                
                override fun onFinalResult(text: String) {
                    handler.post {
                        // å¦‚æœå·²æš‚åœï¼Œç«‹å³åœæ­¢å¤„ç†
                        if (isVoiceRecognitionPaused) {
                            Log.d(TAG, "è¯­éŸ³è¯†åˆ«å·²æš‚åœï¼Œå¿½ç•¥Voskæœ€ç»ˆç»“æœ")
                            return@post
                        }
                        
                        // å¤„ç†æœ€ç»ˆè¯†åˆ«ç»“æœ
                        if (text.isNotEmpty() && text != "{\"text\" : \"\"}") {
                            try {
                                val jsonObject = org.json.JSONObject(text)
                                val finalText = jsonObject.optString("text", "").trim()
                                if (finalText.isNotEmpty()) {
                                    // å†æ¬¡æ£€æŸ¥æš‚åœçŠ¶æ€
                                    if (isVoiceRecognitionPaused) {
                                        Log.d(TAG, "åœ¨Voskæœ€ç»ˆç»“æœå¤„ç†è¿‡ç¨‹ä¸­æ£€æµ‹åˆ°æš‚åœï¼Œåœæ­¢å¤„ç†")
                                        return@post
                                    }
                                    
                                    // æ£€æŸ¥æ˜¯å¦åŒ…å«å¯ç–‘çš„ä»£ç ç‰‡æ®µæˆ–æ— å…³å†…å®¹ï¼ˆé˜²æ­¢æ— å£°éŸ³æ—¶è¾“å…¥æ— å…³ä»£ç ï¼‰
                                    if (isSuspiciousCode(finalText)) {
                                        Log.w(TAG, "âš ï¸ Voskæ£€æµ‹åˆ°å¯ç–‘ä»£ç ç‰‡æ®µï¼Œå¿½ç•¥æœ€ç»ˆç»“æœ: '$finalText'")
                                        return@post
                                    }
                                    
                                    // æ£€æŸ¥æ˜¯å¦æ˜¯å®Œå…¨é‡å¤çš„å†…å®¹ï¼ˆä¸ä¸Šä¸€æ¬¡è¯†åˆ«ç»“æœå®Œå…¨ç›¸åŒï¼‰
                                    if (finalText == lastRecognizedText) {
                                        Log.d(TAG, "âš ï¸ Voskæ£€æµ‹åˆ°å®Œå…¨é‡å¤çš„è¯†åˆ«ç»“æœï¼Œå¿½ç•¥: '$finalText'")
                                        return@post
                                    }
                                    
                                    // æ¸…é™¤éƒ¨åˆ†ç»“æœï¼Œå‡†å¤‡ä½¿ç”¨æœ€ç»ˆç»“æœ
                                    if (currentPartialText.isNotEmpty()) {
                                        Log.d(TAG, "Voskæ”¶åˆ°æœ€ç»ˆç»“æœï¼Œæ¸…é™¤éƒ¨åˆ†ç»“æœ: '$currentPartialText'")
                                        currentPartialText = ""
                                    }
                                    
                                    // å®Œæ•´ä¿ç•™æ‰€æœ‰è¯­éŸ³å†…å®¹ï¼ŒæŒ‰é¡ºåºè¿½åŠ 
                                    val mergedText = if (recognizedText.isEmpty()) {
                                        // æ²¡æœ‰å·²ç¡®è®¤æ–‡æœ¬ï¼Œç›´æ¥ä½¿ç”¨æœ€ç»ˆç»“æœ
                                        finalText
                                    } else {
                                        // æ£€æŸ¥æ˜¯å¦ä¸ä¸Šæ¬¡è¯†åˆ«ç»“æœå®Œå…¨ç›¸åŒï¼ˆé¿å…é‡å¤ï¼‰
                                        if (finalText == lastRecognizedText) {
                                            Log.d(TAG, "Voskæœ€ç»ˆç»“æœä¸ä¸Šæ¬¡ç›¸åŒï¼Œå¿½ç•¥é‡å¤: '$finalText'")
                                            recognizedText
                                        } else {
                                            // ä¸åŒå†…å®¹ï¼Œè¿½åŠ åˆ°å·²æœ‰æ–‡æœ¬åé¢
                                            // æ ¹æ®å·²æœ‰æ–‡æœ¬æœ«å°¾æ˜¯å¦æœ‰æ ‡ç‚¹å†³å®šåˆ†éš”ç¬¦
                                            val trimmedRecognized = recognizedText.trim()
                                            val endsWithPunctuation = trimmedRecognized.endsWith("ã€‚") || 
                                                                      trimmedRecognized.endsWith("ï¼Œ") || 
                                                                      trimmedRecognized.endsWith("ï¼Ÿ") ||
                                                                      trimmedRecognized.endsWith("ï¼") ||
                                                                      trimmedRecognized.endsWith(".") ||
                                                                      trimmedRecognized.endsWith(",") ||
                                                                      trimmedRecognized.endsWith("?") ||
                                                                      trimmedRecognized.endsWith("!")
                                            
                                            val separator = if (endsWithPunctuation) "\n" else " "
                                            Log.d(TAG, "Voskè¿½åŠ æ–°æ–‡æœ¬: '$recognizedText' + '$finalText'")
                                            "$trimmedRecognized$separator$finalText"
                                        }
                                    }
                                    
                                    // å†æ¬¡æ£€æŸ¥æš‚åœçŠ¶æ€ï¼Œç¡®ä¿åœ¨æ›´æ–°è¿‡ç¨‹ä¸­æ²¡æœ‰è¢«æš‚åœ
                                    if (isVoiceRecognitionPaused) {
                                        Log.d(TAG, "åœ¨Voskæ–‡æœ¬æ›´æ–°è¿‡ç¨‹ä¸­æ£€æµ‹åˆ°æš‚åœï¼Œåœæ­¢æ–‡æœ¬è½¬æ¢å¤„ç†")
                                        return@post
                                    }
                                    
                                    // æ›´æ–°è¯†åˆ«çš„æ–‡æœ¬
                                    recognizedText = mergedText
                                    lastRecognizedText = finalText  // ä¿å­˜æœ¬æ¬¡è¯†åˆ«ç»“æœï¼Œç”¨äºä¸‹æ¬¡å»é‡
                                    
                                    // æ ¹æ®å½“å‰æ¨¡å¼é€‰æ‹©è¾“å…¥æ¡†
                                    if (isVoiceCapsuleMode && voiceCapsuleTextInput != null) {
                                        // èƒ¶å›Šæ¨¡å¼ï¼šä½¿ç”¨èƒ¶å›Šè¾“å…¥æ¡†
                                        voiceCapsuleTextInput?.let { input ->
                                            input.setText(recognizedText)
                                            input.setSelection(recognizedText.length)
                                            input.post { input.requestLayout() }
                                            Log.d(TAG, "Voskæœ€ç»ˆç»“æœå·²æ›´æ–°åˆ°èƒ¶å›Šè¾“å…¥æ¡†: '$recognizedText'")
                                        }
                                        // åŒæ­¥åˆ°åŸå§‹è¾“å…¥æ¡†
                                        voiceTextInput.setText(recognizedText)
                                        voiceTextInput.setSelection(recognizedText.length)
                                    } else {
                                        // åŸå§‹æ¨¡å¼æˆ–èƒ¶å›Šè¾“å…¥æ¡†æœªåˆå§‹åŒ–ï¼šä½¿ç”¨åŸå§‹è¾“å…¥æ¡†
                                        voiceTextInput.setText(recognizedText)
                                        voiceTextInput.setSelection(recognizedText.length)
                                        Log.d(TAG, "Voskæœ€ç»ˆç»“æœå·²æ›´æ–°åˆ°åŸå§‹è¾“å…¥æ¡†: '$recognizedText' (isVoiceCapsuleMode=$isVoiceCapsuleMode, voiceCapsuleTextInput=${voiceCapsuleTextInput != null})")
                                    }
                                    voiceSearchButton.isEnabled = true
                                    updateSaveButtonVisibility()
                                    Log.d(TAG, "Voskæœ€ç»ˆç»“æœ: '$finalText' â†’ åˆå¹¶å: '$recognizedText'")
                                    
                                    // åªæœ‰åœ¨æœªæš‚åœæ—¶æ‰è§¦å‘è‡ªåŠ¨æœç´¢å’Œç»§ç»­è¯†åˆ«
                                    if (!isVoiceRecognitionPaused) {
                                        // è§¦å‘è‡ªåŠ¨æœç´¢ï¼ˆå¦‚æœæœ‰æ–‡æœ¬ï¼‰
                                        if (mergedText.isNotBlank()) {
                                            triggerVoiceCapsuleAutoSearch(mergedText)
                                        }
                                        
                                        // è‡ªåŠ¨é‡å¯è¯†åˆ«ä»¥æ”¯æŒè¿ç»­è¯­éŸ³è¾“å…¥
                                        handler.postDelayed({
                                            if (isListening && !isVoiceRecognitionPaused) {
                                                startVoskRecognition()
                                            }
                                        }, 250)
                                    }
                                }
                            } catch (e: Exception) {
                                Log.e(TAG, "è§£æVoskæœ€ç»ˆç»“æœå¤±è´¥: $text", e)
                            }
                        }
                    }
                }
                
                override fun onError(error: String) {
                    handler.post {
                        Log.e(TAG, "Voskè¯†åˆ«é”™è¯¯: $error")
                        voiceStatusText.text = "Voskè¯†åˆ«é”™è¯¯: $error"
                        isListening = false
                        updateVoiceListeningState(false)
                    }
                }
                
                override fun onModelStatus(isReady: Boolean, message: String) {
                    handler.post {
                        if (isReady) {
                            Log.d(TAG, "Voskæ¨¡å‹å·²å°±ç»ª: $message")
                            // æ¨¡å‹å·²å°±ç»ªï¼Œæ›´æ–°çŠ¶æ€å¹¶å¼€å§‹è¯†åˆ«
                            voiceStatusText.text = "Voskæ¨¡å‹å·²å°±ç»ªï¼Œå¼€å§‹è¯†åˆ«..."
                            isVoskInitialized = true
                            // ç¡®ä¿è¯†åˆ«çŠ¶æ€æ­£ç¡®
                            if (!isListening) {
                                isListening = true
                                updateVoiceListeningState(true)
                                updateCapsuleRecordingState(true) // æ˜¾ç¤ºåŠ¨ç”»
                            }
                            // å¼€å§‹è¯†åˆ«
                            voskManager?.startRecognition()
                            Log.d(TAG, "Voskè¯†åˆ«å·²å¯åŠ¨ï¼Œç­‰å¾…è¯†åˆ«ç»“æœ...")
                        } else {
                            Log.d(TAG, "Voskæ¨¡å‹çŠ¶æ€: $message")
                            voiceStatusText.text = message
                            if (message.contains("ä¸‹è½½") || message.contains("åŠ è½½")) {
                                // æ­£åœ¨ä¸‹è½½æˆ–åŠ è½½æ¨¡å‹ï¼Œä¿æŒç­‰å¾…çŠ¶æ€
                                isVoskInitialized = false
                            } else {
                                // å…¶ä»–é”™è¯¯ï¼Œåœæ­¢è¯†åˆ«
                                isListening = false
                                isVoskInitialized = false
                                updateVoiceListeningState(false)
                                updateCapsuleRecordingState(false) // éšè—åŠ¨ç”»
                            }
                        }
                    }
                }
            })
        }
        
        // æ£€æŸ¥æ¨¡å‹æ˜¯å¦å·²åˆå§‹åŒ–ï¼Œä»¥åŠæ¨¡å‹ç±»å‹æ˜¯å¦åŒ¹é…
        val currentModelType = voskManager?.getCurrentModelType()
        val needReinitialize = !isVoskInitialized || currentModelType != modelType
        
        if (needReinitialize) {
            // å¦‚æœæ¨¡å‹æœªåˆå§‹åŒ–æˆ–æ¨¡å‹ç±»å‹ä¸åŒ¹é…ï¼Œéœ€è¦é‡æ–°åˆå§‹åŒ–
            if (currentModelType != modelType && isVoskInitialized) {
                Log.d(TAG, "æ¨¡å‹ç±»å‹å·²æ”¹å˜ï¼ˆä» $currentModelType åˆ° $modelTypeï¼‰ï¼Œéœ€è¦é‡æ–°åˆå§‹åŒ–")
                // é‡Šæ”¾æ—§çš„æ¨¡å‹
                voskManager?.release()
                voskManager = VoskManager(this)
                voskManager?.setModelType(modelType)
                isVoskInitialized = false
            }
            
            // åˆå§‹åŒ–æ¨¡å‹ï¼ˆå¼‚æ­¥ï¼‰
            isListening = true
            updateVoiceListeningState(true)
            updateCapsuleRecordingState(true) // æ˜¾ç¤ºåŠ¨ç”»
            voiceStatusText.text = "æ­£åœ¨åˆå§‹åŒ–Voskæ¨¡å‹..."
            
            Log.d(TAG, "å¼€å§‹åˆå§‹åŒ–Voskæ¨¡å‹ï¼ˆç±»å‹: $modelTypeï¼‰...")
            kotlinx.coroutines.CoroutineScope(kotlinx.coroutines.Dispatchers.IO).launch {
                val success = voskManager?.initializeModel(false) ?: false // ä¸è‡ªåŠ¨ä¸‹è½½ï¼Œå› ä¸ºæ¨¡å‹åº”è¯¥å·²ç»ä¸‹è½½
                handler.post {
                    if (success) {
                        isVoskInitialized = true
                        voiceStatusText.text = "Voskæ¨¡å‹å·²å°±ç»ªï¼Œå¼€å§‹è¯†åˆ«..."
                        Log.d(TAG, "Voskæ¨¡å‹åˆå§‹åŒ–æˆåŠŸï¼ˆç±»å‹: $modelTypeï¼‰ï¼Œå¼€å§‹è¯†åˆ«")
                        voskManager?.startRecognition()
                    } else {
                        isListening = false
                        isVoskInitialized = false
                        updateVoiceListeningState(false)
                        updateCapsuleRecordingState(false) // éšè—åŠ¨ç”»
                        voiceStatusText.text = "Voskæ¨¡å‹åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ¨¡å‹æ–‡ä»¶"
                        Log.e(TAG, "Voskæ¨¡å‹åˆå§‹åŒ–å¤±è´¥ï¼ˆç±»å‹: $modelTypeï¼‰")
                    }
                }
            }
        } else {
            // æ¨¡å‹å·²åˆå§‹åŒ–ä¸”æ¨¡å‹ç±»å‹åŒ¹é…ï¼Œç›´æ¥å¼€å§‹è¯†åˆ«
            isListening = true
            updateVoiceListeningState(true)
            updateCapsuleRecordingState(true) // æ˜¾ç¤ºåŠ¨ç”»
            voiceStatusText.text = "å¼€å§‹è¯†åˆ«..."
            Log.d(TAG, "Voskæ¨¡å‹å·²åˆå§‹åŒ–ï¼ˆç±»å‹: $modelTypeï¼‰ï¼Œç›´æ¥å¼€å§‹è¯†åˆ«")
            voskManager?.startRecognition()
        }
    }

    private fun stopVoiceRecognition() {
        isListening = false
        
        // åœæ­¢ç³»ç»Ÿè¯­éŸ³è¯†åˆ«
        speechRecognizer?.stopListening()
        
        // åœæ­¢Voskè¯†åˆ«
        voskManager?.stopRecognition()
        
        // æ¸…é™¤éƒ¨åˆ†ç»“æœï¼ˆåœæ­¢è¯†åˆ«æ—¶æ¸…é™¤ä¸´æ—¶æ˜¾ç¤ºï¼‰
        currentPartialText = ""
        
        updateVoiceListeningState(false)
    }

    private fun updateVoiceListeningState(listening: Boolean) {
        if (listening) {
            // ç§»é™¤çŠ¶æ€æ–‡æœ¬æç¤ºï¼Œä¸“æ³¨äºè¯­éŸ³è½¬æ–‡æœ¬åŠŸèƒ½
            voiceMicContainer.setCardBackgroundColor(ContextCompat.getColor(this, android.R.color.holo_green_light))
            // æ˜¾ç¤ºå½•éŸ³æ ‡è¯†
            voiceRecordingIndicator.visibility = View.VISIBLE
            // æ³¨æ„ï¼šä¸å†å¯åŠ¨éŸ³é¢‘å½•åˆ¶ï¼Œåªè¿›è¡Œè¯­éŸ³è¯†åˆ«è½¬æ–‡æœ¬
            // æ·»åŠ éœ‡åŠ¨åé¦ˆ
            performVibration("light")
        } else {
            // ç§»é™¤çŠ¶æ€æ–‡æœ¬æç¤º
            voiceMicContainer.setCardBackgroundColor(ContextCompat.getColor(this, R.color.colorPrimary))
            // éšè—å½•éŸ³æ ‡è¯†
            voiceRecordingIndicator.visibility = View.GONE
            // æ³¨æ„ï¼šä¸å†åœæ­¢éŸ³é¢‘å½•åˆ¶ï¼Œåªåœæ­¢è¯­éŸ³è¯†åˆ«
            // æ·»åŠ éœ‡åŠ¨åé¦ˆ
            performVibration("light")
        }
    }
    
    /**
     * å¼€å§‹éŸ³é¢‘å½•éŸ³ï¼ˆå·²åºŸå¼ƒï¼Œä¸å†ä½¿ç”¨éŸ³é¢‘å½•åˆ¶ï¼‰
     */
    private fun startAudioRecording() {
        // ä¸å†ä½¿ç”¨éŸ³é¢‘å½•åˆ¶ï¼Œåªè¿›è¡Œè¯­éŸ³è¯†åˆ«è½¬æ–‡æœ¬
        Log.d(TAG, "éŸ³é¢‘å½•åˆ¶åŠŸèƒ½å·²ç§»é™¤ï¼Œåªè¿›è¡Œè¯­éŸ³è¯†åˆ«è½¬æ–‡æœ¬")
    }
    
    /**
     * åœæ­¢éŸ³é¢‘å½•éŸ³ï¼ˆå·²åºŸå¼ƒï¼Œä¸å†ä½¿ç”¨éŸ³é¢‘å½•åˆ¶ï¼‰
     */
    private fun stopAudioRecording() {
        // ä¸å†ä½¿ç”¨éŸ³é¢‘å½•åˆ¶ï¼Œåªè¿›è¡Œè¯­éŸ³è¯†åˆ«è½¬æ–‡æœ¬
        Log.d(TAG, "éŸ³é¢‘å½•åˆ¶åŠŸèƒ½å·²ç§»é™¤ï¼Œåªè¿›è¡Œè¯­éŸ³è¯†åˆ«è½¬æ–‡æœ¬")
    }
    
    /**
     * åˆ‡æ¢è¯­éŸ³è¯†åˆ«æš‚åœ/ç»§ç»­ï¼ˆä¸å†æ§åˆ¶éŸ³é¢‘å½•åˆ¶ï¼‰
     */
    private fun toggleRecordingPause() {
        if (!isListening) {
            Log.w(TAG, "æœªåœ¨è¯†åˆ«ï¼Œæ— æ³•æš‚åœ")
            return
        }
        
        // æ·»åŠ ç‚¹å‡»åŠ¨ç”»æ•ˆæœ
        val pauseButton = findViewById<com.google.android.material.button.MaterialButton>(R.id.voice_capsule_start_pause_btn)
        pauseButton?.let { button ->
            // ç¼©æ”¾åŠ¨ç”»
            button.animate()
                .scaleX(0.8f)
                .scaleY(0.8f)
                .setDuration(100)
                .withEndAction {
                    button.animate()
                        .scaleX(1.0f)
                        .scaleY(1.0f)
                        .setDuration(100)
                        .start()
                }
                .start()
        }
        
        if (isVoiceRecognitionPaused) {
            // ç»§ç»­è¯­éŸ³è¯†åˆ«
            isVoiceRecognitionPaused = false
            voicePauseButton.text = "æš‚åœ"
            
            // æ›´æ–°èƒ¶å›Šå¸ƒå±€ä¸­çš„æš‚åœæŒ‰é’®å›¾æ ‡å’ŒçŠ¶æ€
            pauseButton?.text = "æš‚åœ"
            pauseButton?.setIconResource(R.drawable.ic_pause)
            
            // æ¢å¤è®¡æ—¶å™¨
            if (hasTextConverted) {
                textConversionStartTime = System.currentTimeMillis() - (totalPausedTime)
                if (!isTextConversionPaused) {
                    startTextConversionTimer()
                }
            } else {
                conversionStartTime = System.currentTimeMillis() - totalConversionPausedTime
                if (!isConversionPaused) {
                    startConversionTimer()
                }
            }
            
            // æ¢å¤æ³¢åŠ¨åŠ¨ç”»
            startWaveformAnimation()
            
            // ç»§ç»­è¯­éŸ³è¯†åˆ«
            if (shouldContinueRecording) {
                continueRecording()
            }
            
            // åˆ·æ–°UIçŠ¶æ€
            updateCapsuleRecordingState(true)
            
            // æ·»åŠ éœ‡åŠ¨åé¦ˆ
            performVibration("light")
            
            Log.d(TAG, "è¯­éŸ³è¯†åˆ«å·²ç»§ç»­")
            Toast.makeText(this, "è¯­éŸ³è¯†åˆ«å·²ç»§ç»­", Toast.LENGTH_SHORT).show()
        } else {
            // æš‚åœè¯­éŸ³è¯†åˆ«
            isVoiceRecognitionPaused = true
            voicePauseButton.text = "ç»§ç»­"
            voiceStatusText.text = "è¯­éŸ³è¯†åˆ«å·²æš‚åœ"
            
            // æ›´æ–°èƒ¶å›Šå¸ƒå±€ä¸­çš„æš‚åœæŒ‰é’®å›¾æ ‡å’ŒçŠ¶æ€
            pauseButton?.text = "ç»§ç»­"
            pauseButton?.setIconResource(R.drawable.ic_play)
            
            Log.d(TAG, "æš‚åœè¯­éŸ³è¯†åˆ«ï¼Œç«‹å³åœæ­¢å½•åˆ¶å’Œæ–‡æœ¬è½¬æ¢")
            
            // ç«‹å³å–æ¶ˆæ‰€æœ‰å¾…æ‰§è¡Œçš„è‡ªåŠ¨æœç´¢ä»»åŠ¡
            voiceCapsuleSearchHandler?.removeCallbacksAndMessages(null)
            Log.d(TAG, "å·²å–æ¶ˆæ‰€æœ‰å¾…æ‰§è¡Œçš„è‡ªåŠ¨æœç´¢ä»»åŠ¡")
            
            // æš‚åœè®¡æ—¶å™¨
            if (hasTextConverted) {
                totalPausedTime += System.currentTimeMillis() - textConversionStartTime
                stopTextConversionTimer()
            } else {
                totalConversionPausedTime += System.currentTimeMillis() - conversionStartTime
                stopConversionTimer()
            }
            
            // åœæ­¢æ³¢åŠ¨åŠ¨ç”»
            stopWaveformAnimation()
            
            // åœæ­¢è¯­éŸ³è¯†åˆ«
            stopVoiceRecognition()
            
            // åˆ·æ–°UIçŠ¶æ€
            updateCapsuleRecordingState(true)
            
            // æ·»åŠ éœ‡åŠ¨åé¦ˆ
            performVibration("light")
            
            Log.d(TAG, "è¯­éŸ³è¯†åˆ«å·²æš‚åœ")
            Toast.makeText(this, "è¯­éŸ³è¯†åˆ«å·²æš‚åœ", Toast.LENGTH_SHORT).show()
        }
    }

    private fun createVoiceRecognitionListener(): RecognitionListener {
        return object : RecognitionListener {
            override fun onReadyForSpeech(params: Bundle?) {
                // ç§»é™¤çŠ¶æ€æ–‡æœ¬æç¤ºï¼Œä¸“æ³¨äºè¯­éŸ³è½¬æ–‡æœ¬åŠŸèƒ½
            }

            override fun onBeginningOfSpeech() {
                // ç§»é™¤çŠ¶æ€æ–‡æœ¬æç¤ºï¼Œä¸“æ³¨äºè¯­éŸ³è½¬æ–‡æœ¬åŠŸèƒ½
            }

            override fun onRmsChanged(rmsdB: Float) {
                // ç§»é™¤åŠ¨ç”»é€»è¾‘ï¼Œä¸å†éœ€è¦éº¦å…‹é£åŠ¨ç”»
            }

            override fun onBufferReceived(buffer: ByteArray?) {}

            override fun onEndOfSpeech() {
                // ç§»é™¤çŠ¶æ€æ–‡æœ¬æç¤ºï¼Œä¸“æ³¨äºè¯­éŸ³è½¬æ–‡æœ¬åŠŸèƒ½
            }

            override fun onError(error: Int) {
                handler.post {
                    handleVoiceRecognitionError(error)
                }
            }

            override fun onResults(results: Bundle?) {
                handler.post {
                    processVoiceRecognitionResults(results)
                }
            }

            override fun onPartialResults(partialResults: Bundle?) {
                handler.post {
                    processVoicePartialResults(partialResults)
                }
            }

            override fun onEvent(eventType: Int, params: Bundle?) {}
        }
    }

    private fun processVoiceRecognitionResults(results: Bundle?) {
        // å¦‚æœå·²æš‚åœï¼Œç«‹å³åœæ­¢å¤„ç†
        if (isVoiceRecognitionPaused) {
            Log.d(TAG, "è¯­éŸ³è¯†åˆ«å·²æš‚åœï¼Œå¿½ç•¥è¯†åˆ«ç»“æœ")
            return
        }
        
        val matches = results?.getStringArrayList(SpeechRecognizer.RESULTS_RECOGNITION)
        if (!matches.isNullOrEmpty()) {
            val newText = matches[0].trim()
            
            // å†æ¬¡æ£€æŸ¥æš‚åœçŠ¶æ€
            if (isVoiceRecognitionPaused) {
                Log.d(TAG, "åœ¨ç»“æœå¤„ç†è¿‡ç¨‹ä¸­æ£€æµ‹åˆ°æš‚åœï¼Œåœæ­¢å¤„ç†")
                return
            }
            
            // æ£€æŸ¥æ˜¯å¦åŒ…å«å¯ç–‘çš„ä»£ç ç‰‡æ®µæˆ–æ— å…³å†…å®¹ï¼ˆé˜²æ­¢æ— å£°éŸ³æ—¶è¾“å…¥æ— å…³ä»£ç ï¼‰
            if (isSuspiciousCode(newText)) {
                Log.w(TAG, "âš ï¸ æ£€æµ‹åˆ°å¯ç–‘ä»£ç ç‰‡æ®µï¼Œå¿½ç•¥è¯†åˆ«ç»“æœ: '$newText'")
                return
            }
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯å®Œå…¨é‡å¤çš„å†…å®¹ï¼ˆä¸ä¸Šä¸€æ¬¡è¯†åˆ«ç»“æœå®Œå…¨ç›¸åŒï¼‰
            if (newText == lastRecognizedText) {
                Log.d(TAG, "âš ï¸ æ£€æµ‹åˆ°å®Œå…¨é‡å¤çš„è¯†åˆ«ç»“æœï¼Œå¿½ç•¥: '$newText'")
                // å®Œå…¨é‡å¤ï¼Œä¸æ›´æ–°æ–‡æœ¬ï¼Œç›´æ¥è¿”å›
                return
            }
            
            // æ¸…é™¤éƒ¨åˆ†ç»“æœï¼Œå‡†å¤‡ä½¿ç”¨æœ€ç»ˆç»“æœ
            if (currentPartialText.isNotEmpty()) {
                Log.d(TAG, "æ”¶åˆ°æœ€ç»ˆç»“æœï¼Œæ¸…é™¤éƒ¨åˆ†ç»“æœ: '$currentPartialText'")
                currentPartialText = ""
            }
            
            // å®Œæ•´ä¿ç•™æ‰€æœ‰è¯­éŸ³å†…å®¹ï¼ŒæŒ‰é¡ºåºè¿½åŠ 
            val mergedText = if (recognizedText.isEmpty()) {
                // æ²¡æœ‰å·²ç¡®è®¤æ–‡æœ¬ï¼Œç›´æ¥ä½¿ç”¨æœ€ç»ˆç»“æœ
                newText
            } else {
                // æ£€æŸ¥æ˜¯å¦ä¸ä¸Šæ¬¡è¯†åˆ«ç»“æœå®Œå…¨ç›¸åŒï¼ˆé¿å…é‡å¤ï¼‰
                if (newText == lastRecognizedText) {
                    Log.d(TAG, "æœ€ç»ˆç»“æœä¸ä¸Šæ¬¡ç›¸åŒï¼Œå¿½ç•¥é‡å¤: '$newText'")
                    recognizedText
                } else {
                    // ä¸åŒå†…å®¹ï¼Œè¿½åŠ åˆ°å·²æœ‰æ–‡æœ¬åé¢
                    // æ ¹æ®å·²æœ‰æ–‡æœ¬æœ«å°¾æ˜¯å¦æœ‰æ ‡ç‚¹å†³å®šåˆ†éš”ç¬¦
                    val trimmedRecognized = recognizedText.trim()
                    val endsWithPunctuation = trimmedRecognized.endsWith("ã€‚") || 
                                              trimmedRecognized.endsWith("ï¼Œ") || 
                                              trimmedRecognized.endsWith("ï¼Ÿ") ||
                                              trimmedRecognized.endsWith("ï¼") ||
                                              trimmedRecognized.endsWith(".") ||
                                              trimmedRecognized.endsWith(",") ||
                                              trimmedRecognized.endsWith("?") ||
                                              trimmedRecognized.endsWith("!")
                    
                    val separator = if (endsWithPunctuation) "\n" else " "
                    Log.d(TAG, "è¿½åŠ æ–°æ–‡æœ¬: '$recognizedText' + '$newText'")
                    "$trimmedRecognized$separator$newText"
                }
            }
            
            // å†æ¬¡æ£€æŸ¥æš‚åœçŠ¶æ€ï¼Œç¡®ä¿åœ¨æ›´æ–°è¿‡ç¨‹ä¸­æ²¡æœ‰è¢«æš‚åœ
            if (isVoiceRecognitionPaused) {
                Log.d(TAG, "åœ¨æ–‡æœ¬æ›´æ–°è¿‡ç¨‹ä¸­æ£€æµ‹åˆ°æš‚åœï¼Œåœæ­¢æ–‡æœ¬è½¬æ¢å¤„ç†")
                return
            }
            
            // æ›´æ–°è¯†åˆ«çš„æ–‡æœ¬
            recognizedText = mergedText
            lastRecognizedText = newText  // ä¿å­˜æœ¬æ¬¡è¯†åˆ«ç»“æœï¼Œç”¨äºä¸‹æ¬¡å»é‡

            voiceTextInput.setText(recognizedText)
            voiceTextInput.setSelection(recognizedText.length)
            // ç§»é™¤çŠ¶æ€æ–‡æœ¬æç¤ºï¼Œä¸“æ³¨äºæ˜¾ç¤ºè¯†åˆ«ç»“æœ
            voiceSearchButton.isEnabled = true
            // æ›´æ–°ä¿å­˜æŒ‰é’®å¯è§æ€§
            updateSaveButtonVisibility()

            // åªæœ‰åœ¨æœªæš‚åœæ—¶æ‰è§¦å‘è‡ªåŠ¨æœç´¢å’Œç»§ç»­è¯†åˆ«
            if (!isVoiceRecognitionPaused) {
                // è§¦å‘è‡ªåŠ¨æœç´¢ï¼ˆå¦‚æœæœ‰æ–‡æœ¬ï¼‰
                if (mergedText.isNotBlank()) {
                    triggerVoiceCapsuleAutoSearch(mergedText)
                }
                
                // è‡ªåŠ¨é‡å¯è¯†åˆ«ä»¥æ”¯æŒè¿ç»­è¯­éŸ³è¾“å…¥
                handler.postDelayed({
                    if (isListening && !isVoiceRecognitionPaused) {
                        startVoiceRecognition()
                    }
                }, 250)
            }
        }
    }

    private fun processVoicePartialResults(partialResults: Bundle?) {
        // å¦‚æœå·²æš‚åœï¼Œç«‹å³åœæ­¢å¤„ç†
        if (isVoiceRecognitionPaused) {
            Log.d(TAG, "è¯­éŸ³è¯†åˆ«å·²æš‚åœï¼Œå¿½ç•¥éƒ¨åˆ†ç»“æœ")
            return
        }
        
        val matches = partialResults?.getStringArrayList(SpeechRecognizer.RESULTS_RECOGNITION)
        if (!matches.isNullOrEmpty()) {
            val partialText = matches[0].trim()
            
            // å†æ¬¡æ£€æŸ¥æš‚åœçŠ¶æ€
            if (isVoiceRecognitionPaused) {
                Log.d(TAG, "åœ¨éƒ¨åˆ†ç»“æœå¤„ç†è¿‡ç¨‹ä¸­æ£€æµ‹åˆ°æš‚åœï¼Œåœæ­¢å¤„ç†")
                return
            }
            
            // æ£€æŸ¥éƒ¨åˆ†ç»“æœæ˜¯å¦æœ‰æ›´æ–°ï¼ˆé¿å…é‡å¤æ›´æ–°ç›¸åŒå†…å®¹ï¼‰
            if (partialText == currentPartialText) {
                // éƒ¨åˆ†ç»“æœæœªå˜åŒ–ï¼Œä¸æ›´æ–°
                return
            }
            
            // æ£€æŸ¥æ˜¯å¦åŒ…å«å¯ç–‘çš„ä»£ç ç‰‡æ®µæˆ–æ— å…³å†…å®¹ï¼ˆé˜²æ­¢æ— å£°éŸ³æ—¶è¾“å…¥æ— å…³ä»£ç ï¼‰
            if (isSuspiciousCode(partialText)) {
                Log.w(TAG, "âš ï¸ æ£€æµ‹åˆ°å¯ç–‘ä»£ç ç‰‡æ®µï¼Œå¿½ç•¥éƒ¨åˆ†ç»“æœ: '$partialText'")
                return
            }
            
            // æ›´æ–°å½“å‰éƒ¨åˆ†è¯†åˆ«ç»“æœ
            currentPartialText = partialText
            
            // æ˜¾ç¤ºå·²ç¡®è®¤æ–‡æœ¬ + å½“å‰éƒ¨åˆ†è¯†åˆ«ç»“æœ
            // æ³¨æ„ï¼šéƒ¨åˆ†ç»“æœåªæ˜¯ä¸´æ—¶æ˜¾ç¤ºï¼Œä¸ä¼šçœŸæ­£è¿½åŠ åˆ° recognizedText ä¸­
            val displayText = if (recognizedText.isEmpty()) {
                // æ²¡æœ‰å·²ç¡®è®¤æ–‡æœ¬ï¼Œç›´æ¥æ˜¾ç¤ºéƒ¨åˆ†ç»“æœ
                partialText
            } else {
                // æœ‰å·²ç¡®è®¤æ–‡æœ¬ï¼Œç›´æ¥è¿½åŠ æ˜¾ç¤ºéƒ¨åˆ†ç»“æœ
                // ç¡®ä¿ç”¨æˆ·èƒ½çœ‹åˆ°æ‰€æœ‰å†…å®¹
                val trimmedRecognized = recognizedText.trim()
                val separator = if (trimmedRecognized.endsWith("ã€‚") || 
                                    trimmedRecognized.endsWith("ï¼Œ") || 
                                    trimmedRecognized.endsWith("ï¼Ÿ") ||
                                    trimmedRecognized.endsWith("ï¼") ||
                                    trimmedRecognized.endsWith(".") ||
                                    trimmedRecognized.endsWith(",") ||
                                    trimmedRecognized.endsWith("?") ||
                                    trimmedRecognized.endsWith("!")) {
                    "\n"
                } else {
                    " "
                }
                "$trimmedRecognized$separator$partialText"
            }
            
            voiceTextInput.setText(displayText)
            voiceTextInput.setSelection(displayText.length)
            // æ›´æ–°ä¿å­˜æŒ‰é’®å¯è§æ€§
            updateSaveButtonVisibility()
            
            Log.d(TAG, "â†» éƒ¨åˆ†ç»“æœæ›´æ–°: '$partialText' â†’ æ˜¾ç¤º: '$displayText'")
        }
    }
    
    /**
     * è®¡ç®—ä¸¤ä¸ªå­—ç¬¦ä¸²çš„ç›¸ä¼¼åº¦ï¼ˆ0.0-1.0ï¼‰
     * ä½¿ç”¨ç¼–è¾‘è·ç¦»ç®—æ³•ï¼Œç›¸ä¼¼åº¦è¶Šé«˜è¡¨ç¤ºä¸¤ä¸ªæ–‡æœ¬è¶Šç›¸ä¼¼
     * 
     * @param s1 ç¬¬ä¸€ä¸ªå­—ç¬¦ä¸²
     * @param s2 ç¬¬äºŒä¸ªå­—ç¬¦ä¸²
     * @return ç›¸ä¼¼åº¦ï¼ˆ0.0-1.0ï¼‰ï¼Œ1.0è¡¨ç¤ºå®Œå…¨ç›¸åŒ
     */
    private fun calculateTextSimilarity(s1: String, s2: String): Float {
        // ç®€å•å®ç°ï¼šè®¡ç®—æœ€é•¿å…¬å…±å­åºåˆ—
        val longer = if (s1.length > s2.length) s1 else s2
        val shorter = if (s1.length > s2.length) s2 else s1
        
        if (longer.isEmpty()) {
            return 1.0f
        }
        
        val editDistance = levenshteinDistance(longer, shorter)
        val similarity = (longer.length - editDistance).toFloat() / longer.length
        
        Log.d(TAG, "ç›¸ä¼¼åº¦è®¡ç®—: s1='$s1' (${s1.length}), s2='$s2' (${s2.length}), editDistance=$editDistance, similarity=$similarity")
        
        return similarity.coerceIn(0.0f, 1.0f)
    }
    
    /**
     * è®¡ç®—ä¸¤ä¸ªå­—ç¬¦ä¸²çš„ç¼–è¾‘è·ç¦»ï¼ˆLevenshtein Distanceï¼‰
     * ç¼–è¾‘è·ç¦»æ˜¯æŒ‡å°†ä¸€ä¸ªå­—ç¬¦ä¸²è½¬æ¢ä¸ºå¦ä¸€ä¸ªå­—ç¬¦ä¸²æ‰€éœ€çš„æœ€å°‘å•å­—ç¬¦ç¼–è¾‘ï¼ˆæ’å…¥ã€åˆ é™¤æˆ–æ›¿æ¢ï¼‰æ¬¡æ•°
     * 
     * @param s1 ç¬¬ä¸€ä¸ªå­—ç¬¦ä¸²
     * @param s2 ç¬¬äºŒä¸ªå­—ç¬¦ä¸²
     * @return ç¼–è¾‘è·ç¦»
     */
    private fun levenshteinDistance(s1: String, s2: String): Int {
        if (s1 == s2) return 0
        if (s1.isEmpty()) return s2.length
        if (s2.isEmpty()) return s1.length
        
        val m = s1.length
        val n = s2.length
        val dp = Array(m + 1) { IntArray(n + 1) }
        
        // åˆå§‹åŒ–ç¬¬ä¸€è¡Œå’Œç¬¬ä¸€åˆ—
        for (i in 0..m) {
            dp[i][0] = i
        }
        for (j in 0..n) {
            dp[0][j] = j
        }
        
        // å¡«å……åŠ¨æ€è§„åˆ’è¡¨
        for (i in 1..m) {
            for (j in 1..n) {
                val cost = if (s1[i - 1] == s2[j - 1]) 0 else 1
                dp[i][j] = minOf(
                    dp[i - 1][j] + 1,      // åˆ é™¤
                    dp[i][j - 1] + 1,      // æ’å…¥
                    dp[i - 1][j - 1] + cost // æ›¿æ¢
                )
            }
        }
        
        return dp[m][n]
    }
    
    /**
     * æ£€æŸ¥æ–‡æœ¬æ˜¯å¦åŒ…å«å¯ç–‘çš„ä»£ç ç‰‡æ®µæˆ–æ— å…³å†…å®¹
     * ç”¨äºé˜²æ­¢æ— å£°éŸ³æ—¶è¾“å…¥æ— å…³ä»£ç 
     * 
     * @param text è¦æ£€æŸ¥çš„æ–‡æœ¬
     * @return å¦‚æœåŒ…å«å¯ç–‘å†…å®¹è¿”å›trueï¼Œå¦åˆ™è¿”å›false
     */
    private fun isSuspiciousCode(text: String): Boolean {
        if (text.isEmpty()) return false
        
        // æ£€æŸ¥æ˜¯å¦åŒ…å«å¸¸è§çš„ä»£ç å…³é”®å­—æˆ–ç¬¦å·ï¼ˆå¯èƒ½æ˜¯è¯¯è¯†åˆ«ï¼‰
        val suspiciousPatterns = listOf(
            // ä»£ç å…³é”®å­—
            "function", "class", "import", "export", "const", "let", "var",
            "if", "else", "for", "while", "return", "void", "public", "private",
            "static", "final", "extends", "implements", "interface", "abstract",
            // ä»£ç ç¬¦å·ï¼ˆè¿ç»­å‡ºç°ï¼‰
            "\\{\\s*\\}", "\\[\\s*\\]", "\\(\\s*\\)", "=>", "::", "->",
            // å¯ç–‘çš„ä»£ç ç‰‡æ®µæ¨¡å¼
            "\\w+\\.\\w+\\s*\\(",  // æ–¹æ³•è°ƒç”¨ pattern
            "\\w+\\s*=\\s*\\w+",   // èµ‹å€¼è¯­å¥ pattern
            // æ–‡ä»¶è·¯å¾„æ¨¡å¼
            "/[\\w/]+", "\\\\[\\w\\\\]+", "C:\\\\", "D:\\\\",
            // JSON/XMLæ ‡ç­¾
            "<\\w+>", "</\\w+>", "\\{[\\s\\S]*\\}",
            // å¯ç–‘çš„URLæˆ–å‘½ä»¤
            "http://", "https://", "ftp://", "ssh://",
            "sudo", "rm -rf", "chmod", "chown"
        )
        
        val lowerText = text.lowercase()
        
        // æ£€æŸ¥æ˜¯å¦åŒ¹é…å¯ç–‘æ¨¡å¼
        for (pattern in suspiciousPatterns) {
            if (Regex(pattern, RegexOption.IGNORE_CASE).containsMatchIn(text)) {
                Log.d(TAG, "æ£€æµ‹åˆ°å¯ç–‘æ¨¡å¼: '$pattern' åœ¨æ–‡æœ¬: '$text'")
                return true
            }
        }
        
        // æ£€æŸ¥æ˜¯å¦åŒ…å«è¿‡å¤šçš„ç‰¹æ®Šå­—ç¬¦ï¼ˆå¯èƒ½æ˜¯ä»£ç ï¼‰
        val specialCharCount = text.count { it in "{}[]()<>;:=+-*/%&|!~`@#$^\\\"'.,?/" }
        val specialCharRatio = if (text.isNotEmpty()) specialCharCount.toFloat() / text.length else 0f
        if (specialCharRatio > 0.3f && text.length > 10) {
            // ç‰¹æ®Šå­—ç¬¦æ¯”ä¾‹è¶…è¿‡30%ä¸”æ–‡æœ¬é•¿åº¦å¤§äº10ï¼Œå¯èƒ½æ˜¯ä»£ç 
            Log.d(TAG, "æ£€æµ‹åˆ°ç‰¹æ®Šå­—ç¬¦æ¯”ä¾‹è¿‡é«˜: ${(specialCharRatio * 100).toInt()}% åœ¨æ–‡æœ¬: '$text'")
            return true
        }
        
        // æ£€æŸ¥æ˜¯å¦åŒ…å«è¿ç»­çš„å¤§å†™å­—æ¯ï¼ˆå¯èƒ½æ˜¯å¸¸é‡æˆ–ç±»åï¼‰
        if (Regex("[A-Z]{4,}").containsMatchIn(text) && text.length > 15) {
            Log.d(TAG, "æ£€æµ‹åˆ°è¿ç»­å¤§å†™å­—æ¯ï¼ˆå¯èƒ½æ˜¯ä»£ç ï¼‰: '$text'")
            return true
        }
        
        return false
    }

    private fun handleVoiceRecognitionError(error: Int) {
        val errorMessage = when (error) {
            SpeechRecognizer.ERROR_AUDIO -> "éŸ³é¢‘é”™è¯¯"
            SpeechRecognizer.ERROR_NETWORK -> "ç½‘ç»œé”™è¯¯"
            SpeechRecognizer.ERROR_INSUFFICIENT_PERMISSIONS -> "æ²¡æœ‰å½•éŸ³æƒé™"
            SpeechRecognizer.ERROR_NO_MATCH -> "æœªè¯†åˆ«åˆ°è¯­éŸ³"
            SpeechRecognizer.ERROR_RECOGNIZER_BUSY -> "è¯†åˆ«æœåŠ¡å¿™"
            SpeechRecognizer.ERROR_SERVER -> "æœåŠ¡å™¨é”™è¯¯"
            else -> "è¯†åˆ«é”™è¯¯"
        }

        // å¯¹äºéè‡´å‘½é”™è¯¯ï¼Œè‡ªåŠ¨é‡è¯•
        if (error == SpeechRecognizer.ERROR_NO_MATCH ||
            error == SpeechRecognizer.ERROR_SPEECH_TIMEOUT ||
            error == SpeechRecognizer.ERROR_CLIENT) {
            // ç§»é™¤çŠ¶æ€æ–‡æœ¬æç¤ºï¼Œä¸“æ³¨äºè¯­éŸ³è½¬æ–‡æœ¬åŠŸèƒ½
            handler.postDelayed({
                if (isListening) {
                    startVoiceRecognition()
                }
            }, 500)
        } else if (error == SpeechRecognizer.ERROR_RECOGNIZER_BUSY ||
                   error == SpeechRecognizer.ERROR_SERVER ||
                   error == SpeechRecognizer.ERROR_NETWORK) {
            // å¯¹äºæœåŠ¡ç›¸å…³é”™è¯¯ï¼Œä¸å†å°è¯•ç³»ç»Ÿè¯­éŸ³è¾“å…¥ï¼ˆé¿å…ç³»ç»Ÿå¼¹çª—ï¼‰
            Log.w(TAG, "SpeechRecognizeræœåŠ¡é”™è¯¯: $errorMessage")
            isListening = false
            updateVoiceListeningState(false)
            voiceStatusText.text = errorMessage
            // å·²ç¦ç”¨ç³»ç»Ÿè¯­éŸ³è¾“å…¥ï¼Œé¿å…æ˜¾ç¤ºç³»ç»Ÿå¼¹çª—
            // trySystemVoiceInput()
        } else {
            voiceStatusText.text = errorMessage
            isListening = false
            updateVoiceListeningState(false)
        }
    }

    private fun clearVoiceText() {
        voiceTextInput.setText("")
        recognizedText = ""
        currentPartialText = ""
        lastRecognizedText = ""
        voiceSearchButton.isEnabled = false
    }

    /**
     * å°è¯•ä½¿ç”¨ç³»ç»Ÿè¯­éŸ³è¾“å…¥
     */
    private fun trySystemVoiceInput() {
        val intent = Intent(RecognizerIntent.ACTION_RECOGNIZE_SPEECH).apply {
            putExtra(RecognizerIntent.EXTRA_LANGUAGE_MODEL, RecognizerIntent.LANGUAGE_MODEL_FREE_FORM)
            putExtra(RecognizerIntent.EXTRA_LANGUAGE, "zh-CN")
            putExtra(RecognizerIntent.EXTRA_PROMPT, "è¯·è¯´è¯...")
            putExtra(RecognizerIntent.EXTRA_MAX_RESULTS, 1)
        }

        try {
            // æ£€æŸ¥æ˜¯å¦æœ‰åº”ç”¨èƒ½å¤„ç†è¯­éŸ³è¯†åˆ«Intent
            val activities = packageManager.queryIntentActivities(intent, PackageManager.MATCH_DEFAULT_ONLY)

            if (activities.isNotEmpty()) {
                // æœ‰å¯ç”¨çš„è¯­éŸ³è¯†åˆ«åº”ç”¨ï¼Œå¯åŠ¨ç³»ç»Ÿè¯­éŸ³è¾“å…¥
                // ç§»é™¤çŠ¶æ€æ–‡æœ¬æç¤ºï¼Œä¸“æ³¨äºè¯­éŸ³è½¬æ–‡æœ¬åŠŸèƒ½
                startActivityForResult(intent, SYSTEM_VOICE_REQUEST_CODE)
            } else {
                // æ²¡æœ‰å¯ç”¨çš„è¯­éŸ³è¯†åˆ«åº”ç”¨
                showVoiceRecognitionNotAvailableDialog()
            }
        } catch (e: Exception) {
            Log.e(TAG, "å¯åŠ¨ç³»ç»Ÿè¯­éŸ³è¾“å…¥å¤±è´¥: ${e.message}")
            showVoiceRecognitionNotAvailableDialog()
        }
    }

    /**
     * æ˜¾ç¤ºè¯­éŸ³è¯†åˆ«ä¸å¯ç”¨å¯¹è¯æ¡† - å·²ä¿®æ”¹ä¸ºè‡ªåŠ¨åˆ‡æ¢åˆ°æ‰‹åŠ¨è¾“å…¥
     */
    private fun showVoiceRecognitionNotAvailableDialog() {
        // ä¸å†æ˜¾ç¤ºå¼¹çª—ï¼Œç›´æ¥åˆ‡æ¢åˆ°æ‰‹åŠ¨è¾“å…¥æ¨¡å¼
        Log.d(TAG, "è¯­éŸ³è¯†åˆ«ä¸å¯ç”¨ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°æ‰‹åŠ¨è¾“å…¥æ¨¡å¼")

        // å…è®¸ç”¨æˆ·æ‰‹åŠ¨è¾“å…¥æ–‡æœ¬
        voiceStatusText.text = "è¯·åœ¨ä¸‹æ–¹è¾“å…¥æ–‡æœ¬ï¼Œç„¶åç‚¹å‡»æœç´¢"
        voiceMicContainer.setCardBackgroundColor(ContextCompat.getColor(this, android.R.color.darker_gray))
        voiceTextInput.requestFocus()

        // æ˜¾ç¤ºé”®ç›˜
        val imm = getSystemService(Context.INPUT_METHOD_SERVICE) as InputMethodManager
        imm.showSoftInput(voiceTextInput, InputMethodManager.SHOW_IMPLICIT)

        // ç¡®ä¿æœç´¢æŒ‰é’®å¯ç”¨
        voiceSearchButton.isEnabled = true
        Log.d(TAG, "å·²åˆ‡æ¢åˆ°æ‰‹åŠ¨è¾“å…¥æ¨¡å¼")
    }

    private fun executeVoiceSearch() {
        val query = voiceTextInput.text.toString().trim()
        if (query.isNotEmpty()) {
            // åœæ­¢è¯­éŸ³è¯†åˆ«
            stopVoiceRecognition()
            releaseSpeechRecognizer()

            // ç›´æ¥åœ¨è¯­éŸ³èƒ¶å›Šçš„WebViewä¸­æœç´¢ï¼Œè€Œä¸æ˜¯è·³è½¬åˆ°æµè§ˆå™¨tab
            if (isVoiceCapsuleMode) {
                // å¦‚æœå·²ç»åœ¨èƒ¶å›Šæ¨¡å¼ï¼Œç›´æ¥æœç´¢
                performCapsuleWebViewSearch(query)
            } else {
                // å¦‚æœä¸åœ¨èƒ¶å›Šæ¨¡å¼ï¼Œå…ˆåˆ‡æ¢åˆ°èƒ¶å›Šå¸ƒå±€ï¼Œç„¶åæœç´¢
                switchToVoiceCapsuleLayout(query)
                performCapsuleWebViewSearch(query)
            }
        } else {
            Toast.makeText(this, "è¯·å…ˆè¾“å…¥æœç´¢å†…å®¹", Toast.LENGTH_SHORT).show()
        }
    }

    private fun releaseSpeechRecognizer() {
        speechRecognizer?.apply {
            cancel()
            destroy()
        }
        speechRecognizer = null
        isListening = false
    }
    
    /**
     * é‡Šæ”¾VoskManagerèµ„æº
     */
    private fun releaseVoskManager() {
        voskManager?.release()
        voskManager = null
        isVoskInitialized = false
    }

    private fun minimizeToService() {
        // ç®€åŒ–æƒé™æ£€æŸ¥ï¼Œå¦‚æœæ²¡æœ‰æƒé™å°±ç›´æ¥å…³é—­åº”ç”¨
        if (android.os.Build.VERSION.SDK_INT >= android.os.Build.VERSION_CODES.M && !android.provider.Settings.canDrawOverlays(this)) {
            Log.w(TAG, "No overlay permission, closing app instead of minimizing")
            finish()
            return
        }

        // å…ˆæ‰§è¡Œæ·¡å‡ºåŠ¨ç”»
            val rootView = findViewById<View>(android.R.id.content)
            rootView.animate()
            .alpha(0.5f)
                .setDuration(200)
                .setListener(object : android.animation.AnimatorListenerAdapter() {
                    override fun onAnimationEnd(animation: android.animation.Animator) {
                        // å¯åŠ¨æœ€å°åŒ–æœåŠ¡
                        val serviceIntent = Intent(this@SimpleModeActivity, SimpleModeService::class.java).apply {
                            action = SimpleModeService.ACTION_MINIMIZE
                        }
                        startService(serviceIntent)

                        // å»¶è¿Ÿä¸€ç‚¹æ—¶é—´å†å…³é—­Activityï¼Œç¡®ä¿æœåŠ¡æœ‰è¶³å¤Ÿæ—¶é—´åˆ›å»ºçª—å£
                        handler.postDelayed({
                            // å…³é—­Activity
                            finish()
                            overridePendingTransition(0, 0) // ç¦ç”¨Activityåˆ‡æ¢åŠ¨ç”»
                        }, 300) // 300mså»¶è¿Ÿ
                    }
                })
                .start()
    }

    /**
     * åˆ‡æ¢åˆ°æ‚¬æµ®çƒæ¨¡å¼
     */
    private fun switchToFloatingBallMode() {
        Log.d(TAG, "Switching to floating ball mode")
        try {
            // åœæ­¢ç®€æ˜“æ¨¡å¼æœåŠ¡
            if (SimpleModeService.isRunning(this)) {
                stopService(Intent(this, SimpleModeService::class.java))
            }



            // æ£€æŸ¥æ‚¬æµ®çª—æƒé™
            if (android.os.Build.VERSION.SDK_INT >= android.os.Build.VERSION_CODES.M && android.provider.Settings.canDrawOverlays(this)) {
                // å¯åŠ¨æ‚¬æµ®çƒæœåŠ¡
                val serviceIntent = Intent(this, FloatingWindowService::class.java)
                startService(serviceIntent)

                // æ‚¬æµ®çƒæ¨¡å¼ä¸‹ä¸éœ€è¦å¯åŠ¨HomeActivityï¼Œç›´æ¥å…³é—­å½“å‰Activity
                Log.d(TAG, "Floating ball service started, closing SimpleModeActivity")
                finish()
            } else {
                // æ²¡æœ‰æƒé™ï¼Œæç¤ºç”¨æˆ·
                Toast.makeText(this, "éœ€è¦æ‚¬æµ®çª—æƒé™æ‰èƒ½ä½¿ç”¨æ‚¬æµ®çƒæ¨¡å¼", Toast.LENGTH_LONG).show()
                // æ¢å¤åˆ°ç®€æ˜“æ¨¡å¼é€‰æ‹©
                settingsManager.setDisplayMode("simple_mode")
                loadSettings()
            }
        } catch (e: Exception) {
            Log.e(TAG, "Error switching to floating ball mode", e)
            Toast.makeText(this, "åˆ‡æ¢åˆ°æ‚¬æµ®çƒæ¨¡å¼å¤±è´¥", Toast.LENGTH_SHORT).show()
        }
    }

    /**
     * åˆ‡æ¢åˆ°çµåŠ¨å²›æ¨¡å¼
     */
    private fun switchToDynamicIslandMode() {
        Log.d(TAG, "Switching to dynamic island mode")
        try {
            // åœæ­¢ç®€æ˜“æ¨¡å¼æœåŠ¡
            if (SimpleModeService.isRunning(this)) {
                stopService(Intent(this, SimpleModeService::class.java))
            }



            // æ£€æŸ¥æ‚¬æµ®çª—æƒé™
            if (android.os.Build.VERSION.SDK_INT >= android.os.Build.VERSION_CODES.M && android.provider.Settings.canDrawOverlays(this)) {
                // å¯åŠ¨çµåŠ¨å²›æœåŠ¡
                val serviceIntent = Intent(this, DynamicIslandService::class.java)
                startService(serviceIntent)

                // çµåŠ¨å²›æ¨¡å¼ä¸‹ä¸éœ€è¦å¯åŠ¨HomeActivityï¼Œç›´æ¥å…³é—­å½“å‰Activity
                Log.d(TAG, "Dynamic island service started, closing SimpleModeActivity")
                finish()
            } else {
                // æ²¡æœ‰æƒé™ï¼Œæç¤ºç”¨æˆ·
                Toast.makeText(this, "éœ€è¦æ‚¬æµ®çª—æƒé™æ‰èƒ½ä½¿ç”¨çµåŠ¨å²›æ¨¡å¼", Toast.LENGTH_LONG).show()
                // æ¢å¤åˆ°ç®€æ˜“æ¨¡å¼é€‰æ‹©
                settingsManager.setDisplayMode("simple_mode")
                loadSettings()
            }
        } catch (e: Exception) {
            Log.e(TAG, "Error switching to dynamic island mode", e)
            Toast.makeText(this, "åˆ‡æ¢åˆ°çµåŠ¨å²›æ¨¡å¼å¤±è´¥", Toast.LENGTH_SHORT).show()
        }
    }

    private fun closeSimpleMode() {
        Log.d(TAG, "closeSimpleMode() called")
        try {
            // 1. æ ‡é¢˜æ æŒ‰é’®å·²ç§»é™¤ï¼Œè·³è¿‡æŒ‰é’®ç¦ç”¨

            // 2. åœæ­¢ SimpleModeService æœåŠ¡ï¼ˆå¦‚æœæ­£åœ¨è¿è¡Œï¼‰
            Log.d(TAG, "Stopping SimpleModeService if running")
            if (SimpleModeService.isRunning(this)) {
                stopService(Intent(this, SimpleModeService::class.java))
            }

            // 3. å‘Šè¯‰ SettingsManager æˆ‘ä»¬è¦é€€å‡ºç®€æ˜“æ¨¡å¼
            // åˆ‡æ¢åˆ°æ‚¬æµ®çƒæ¨¡å¼
            settingsManager.setDisplayMode("floating_ball")
            Log.d(TAG, "Changed display mode to floating_ball")

            // 4. å¯åŠ¨æ‚¬æµ®çƒæœåŠ¡ï¼Œç¡®ä¿ç”¨æˆ·ä»ç„¶å¯ä»¥è®¿é—®åº”ç”¨åŠŸèƒ½
            if (android.os.Build.VERSION.SDK_INT >= android.os.Build.VERSION_CODES.M && android.provider.Settings.canDrawOverlays(this)) {
                Log.d(TAG, "Starting FloatingWindowService")
                val serviceIntent = Intent(this, FloatingWindowService::class.java)
                serviceIntent.putExtra("closing_from_simple_mode", true)
                startService(serviceIntent)

                Log.d(TAG, "FloatingWindowService started, not launching HomeActivity")
            } else {
                Log.w(TAG, "No overlay permission, cannot start floating ball service")
                Toast.makeText(this, "éœ€è¦æ‚¬æµ®çª—æƒé™æ‰èƒ½ä½¿ç”¨æ‚¬æµ®çƒæ¨¡å¼", Toast.LENGTH_SHORT).show()
            }

            // 5. ä½¿ç”¨ finishAndRemoveTask() å½»åº•å…³é—­æ´»åŠ¨å’Œä»»åŠ¡
            Log.d(TAG, "Calling finishAndRemoveTask()")
            finishAndRemoveTask()

        } catch (e: Exception) {
            Log.e(TAG, "Error during closing", e)
            // æ ‡é¢˜æ æŒ‰é’®å·²ç§»é™¤ï¼Œè·³è¿‡æŒ‰é’®çŠ¶æ€æ¢å¤
            Toast.makeText(this, "å…³é—­å¤±è´¥ï¼Œè¯·é‡è¯•", Toast.LENGTH_SHORT).show()
        }
    }

    // ä¿ç•™æ—§æ–¹æ³•ä»¥é¿å…å…¶ä»–åœ°æ–¹çš„å¼•ç”¨å‡ºé”™
    private fun closeAndSwitchToFloatingBall() {
        // ç›´æ¥è°ƒç”¨æ–°æ–¹æ³•
        closeSimpleMode()
    }



    override fun onResume() {
        super.onResume()
        
        try {
            // é‡æ–°åŠ è½½è”ç³»äººæ•°æ®ï¼Œç¡®ä¿æ–°åˆ›å»ºçš„ç¾¤èŠèƒ½å¤Ÿæ˜¾ç¤º
            val savedContacts = loadSavedContacts()
            if (savedContacts.isNotEmpty()) {
                allContacts = savedContacts.toMutableList()
                
                // é‡æ–°åŠ è½½ç¾¤èŠæ•°æ®å¹¶åˆå¹¶åˆ°è”ç³»äººåˆ—è¡¨ä¸­
                try {
                    val groupChats = unifiedGroupChatManager.getAllGroupChats()
                    Log.d(TAG, "onResume: ä»UnifiedGroupChatManageråŠ è½½åˆ° ${groupChats.size} ä¸ªç¾¤èŠ")
                    if (groupChats.isNotEmpty()) {
                        // å°†GroupChatè½¬æ¢ä¸ºChatContact
                        val groupChatContacts = groupChats.map { groupChat ->
                            ChatContact(
                                id = groupChat.id,
                                name = groupChat.name,
                                avatar = groupChat.avatar,
                                type = ContactType.GROUP,
                                description = groupChat.description,
                                isOnline = true,
                                lastMessage = groupChat.lastMessage,
                                lastMessageTime = groupChat.lastMessageTime,
                                unreadCount = groupChat.unreadCount,
                                isPinned = groupChat.isPinned,
                                isMuted = groupChat.isMuted,
                                groupId = groupChat.id,
                                memberCount = groupChat.members.size,
                                aiMembers = groupChat.members.filter { member -> member.type == MemberType.AI }.map { member -> member.name }
                            )
                        }
                        
                        // æŸ¥æ‰¾æˆ–åˆ›å»º"å…¨éƒ¨"åˆ†ç±»ï¼Œå¹¶æ·»åŠ ç¾¤èŠ
                        val allCategoryIndex = allContacts.indexOfFirst { it.name == "å…¨éƒ¨" }
                        if (allCategoryIndex != -1) {
                            val allCategory = allContacts[allCategoryIndex]
                            val updatedContacts = allCategory.contacts.toMutableList()
                            
                            // ç§»é™¤ç°æœ‰çš„ç¾¤èŠè”ç³»äººï¼Œé¿å…é‡å¤
                            updatedContacts.removeAll { it.type == ContactType.GROUP }
                            
                            // æ·»åŠ æœ€æ–°çš„ç¾¤èŠæ•°æ®
                            updatedContacts.addAll(groupChatContacts)
                            
                            // é‡æ–°æ’åº
                            val sortedContacts = updatedContacts.sortedWith(
                                compareByDescending<ChatContact> { it.isPinned }
                                    .thenByDescending { it.lastMessageTime }
                            ).toMutableList()
                            
                            allContacts[allCategoryIndex] = allCategory.copy(contacts = sortedContacts)
                        } else {
                            // å¦‚æœ"å…¨éƒ¨"åˆ†ç±»ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°åˆ†ç±»
                            allContacts.add(ContactCategory("å…¨éƒ¨", groupChatContacts.toMutableList()))
                        }
                        
                        Log.d(TAG, "onResume: é‡æ–°åŠ è½½äº† ${groupChats.size} ä¸ªç¾¤èŠ")
                    }
                } catch (e: Exception) {
                    Log.e(TAG, "onResume: é‡æ–°åŠ è½½ç¾¤èŠæ•°æ®å¤±è´¥", e)
                }
                
                chatContactAdapter?.updateContacts(allContacts)
                Log.d(TAG, "onResume: é‡æ–°åŠ è½½äº†è”ç³»äººæ•°æ®")
                
                // å¼ºåˆ¶åˆ·æ–°AIè”ç³»äººæ•°æ®ï¼Œç¡®ä¿æ˜¾ç¤ºæœ€æ–°çš„æ¶ˆæ¯
                forceLoadContactDataSummary()
            }
        } catch (e: Exception) {
            Log.e(TAG, "onResume: é‡æ–°åŠ è½½è”ç³»äººæ•°æ®å¤±è´¥", e)
        }
        
        // æ£€æŸ¥å¹¶å¯åŠ¨ç½‘é€Ÿæ‚¬æµ®çª—æœåŠ¡ï¼ˆå…¨å±€æ§åˆ¶ï¼‰
        checkAndStartNetworkSpeedService()
    }

    /**
     * æ£€æŸ¥å¹¶å¯åŠ¨ç½‘é€Ÿæ‚¬æµ®çª—æœåŠ¡
     * å…¨å±€æ§åˆ¶ï¼šå¦‚æœå¼€å…³å·²æ‰“å¼€ï¼Œç«‹å³å¯åŠ¨æœåŠ¡ï¼Œç¡®ä¿æ‚¬æµ®çª—èƒ½å¤Ÿæ˜¾ç¤º
     */
    private fun checkAndStartNetworkSpeedService() {
        try {
            val isNetworkSpeedEnabled = settingsManager.getBoolean("network_speed_display_enabled", false)
            
            if (isNetworkSpeedEnabled) {
                Log.d(TAG, "æ‚¬æµ®çª—ç½‘é€Ÿå¼€å…³å·²æ‰“å¼€ï¼Œæ£€æŸ¥å¹¶å¯åŠ¨æœåŠ¡")
                
                // æ£€æŸ¥æ‚¬æµ®çª—æƒé™ï¼ˆAndroid 6.0+éœ€è¦ï¼‰
                if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
                    if (!android.provider.Settings.canDrawOverlays(this)) {
                        Log.w(TAG, "æ²¡æœ‰æ‚¬æµ®çª—æƒé™ï¼Œæ— æ³•å¯åŠ¨ç½‘é€Ÿæ‚¬æµ®çª—æœåŠ¡")
                        return
                    }
                }
                
                // æ£€æŸ¥æœåŠ¡æ˜¯å¦å·²ç»åœ¨è¿è¡Œ
                val activityManager = getSystemService(Context.ACTIVITY_SERVICE) as ActivityManager
                val runningServices = activityManager.getRunningServices(Integer.MAX_VALUE)
                val isServiceRunning = runningServices.any { 
                    it.service.className == com.example.aifloatingball.service.NetworkMonitorFloatingService::class.java.name 
                }
                
                if (!isServiceRunning) {
                    // æœåŠ¡æœªè¿è¡Œï¼Œå¯åŠ¨æœåŠ¡
                    val intent = Intent(this, com.example.aifloatingball.service.NetworkMonitorFloatingService::class.java)
                    try {
                        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
                            startForegroundService(intent)
                        } else {
                            startService(intent)
                        }
                        Log.d(TAG, "æ‚¬æµ®çª—ç½‘é€ŸæœåŠ¡å·²å¯åŠ¨")
                    } catch (e: SecurityException) {
                        Log.e(TAG, "å¯åŠ¨æ‚¬æµ®çª—ç½‘é€ŸæœåŠ¡å¤±è´¥ï¼šç¼ºå°‘æƒé™", e)
                    } catch (e: Exception) {
                        Log.e(TAG, "å¯åŠ¨æ‚¬æµ®çª—ç½‘é€ŸæœåŠ¡å¤±è´¥", e)
                    }
                } else {
                    // æœåŠ¡å·²åœ¨è¿è¡Œï¼Œè§¦å‘onStartCommandç¡®ä¿çŠ¶æ€æ­£ç¡®
                    val intent = Intent(this, com.example.aifloatingball.service.NetworkMonitorFloatingService::class.java)
                    try {
                        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
                            startForegroundService(intent)
                        } else {
                            startService(intent)
                        }
                        Log.d(TAG, "æ‚¬æµ®çª—ç½‘é€ŸæœåŠ¡å·²åœ¨è¿è¡Œï¼Œå·²è§¦å‘çŠ¶æ€æ›´æ–°")
                    } catch (e: Exception) {
                        Log.e(TAG, "æ›´æ–°æ‚¬æµ®çª—ç½‘é€ŸæœåŠ¡çŠ¶æ€å¤±è´¥", e)
                    }
                }
            } else {
                Log.d(TAG, "æ‚¬æµ®çª—ç½‘é€Ÿå¼€å…³æœªæ‰“å¼€ï¼Œè·³è¿‡æœåŠ¡å¯åŠ¨")
            }
        } catch (e: Exception) {
            Log.e(TAG, "æ£€æŸ¥å¹¶å¯åŠ¨ç½‘é€Ÿæ‚¬æµ®çª—æœåŠ¡å¤±è´¥", e)
        }
    }

    override fun onDestroy() {
        super.onDestroy()

        Log.d(TAG, "Activityæ­£åœ¨é”€æ¯ï¼Œæ¸…ç†æ‰€æœ‰èµ„æº")
        
        // ğŸ”§ é€€å‡ºæš—é“æ¨¡å¼ï¼ˆåº”ç”¨é€€å‡ºæ—¶ï¼‰
        try {
            val groupManager = TabGroupManager.getInstance(this)
            if (groupManager.isSecretModeActive()) {
                groupManager.deactivateSecretMode()
                Log.d(TAG, "onDestroy: å·²é€€å‡ºæš—é“æ¨¡å¼")
            }
        } catch (e: Exception) {
            Log.e(TAG, "onDestroy: é€€å‡ºæš—é“æ¨¡å¼å¤±è´¥", e)
        }
        
        // æ¸…ç†å•ä¾‹å®ä¾‹
        // ğŸ”§ æ¸…ç†å…¨å±€é˜…è¯»æ¨¡å¼ç®¡ç†å™¨
        try {
            // å¦‚æœå¤„äºé˜…è¯»æ¨¡å¼ï¼Œç¡®ä¿é€€å‡ºå¹¶é‡æ–°å¯ç”¨ browserSwipeRefresh
            globalReaderModeManager?.let { manager ->
                if (manager.isReaderModeActive()) {
                    // è·å–å½“å‰WebViewå¹¶é€€å‡ºé˜…è¯»æ¨¡å¼
                    paperStackWebViewManager?.getCurrentTab()?.webView?.let { webView ->
                        manager.exitReaderMode(webView)
                    }
                }
                // æ¸…ç†ç›‘å¬å™¨
                manager.setListener(null)
            }
            globalReaderModeManager = null
            Log.d(TAG, "å…¨å±€é˜…è¯»æ¨¡å¼ç®¡ç†å™¨å·²æ¸…ç†")
        } catch (e: Exception) {
            Log.e(TAG, "æ¸…ç†å…¨å±€é˜…è¯»æ¨¡å¼ç®¡ç†å™¨å¤±è´¥", e)
        }
        
        // ğŸ”§ ç¡®ä¿ browserSwipeRefresh è¢«é‡æ–°å¯ç”¨ï¼ˆé˜²æ­¢é˜…è¯»æ¨¡å¼é€€å‡ºæ—¶æœªå¯ç”¨ï¼‰
        try {
            if (::browserSwipeRefresh.isInitialized) {
                browserSwipeRefresh.isEnabled = true
                Log.d(TAG, "å·²ç¡®ä¿ browserSwipeRefresh è¢«å¯ç”¨")
            }
        } catch (e: Exception) {
            Log.e(TAG, "å¯ç”¨ browserSwipeRefresh å¤±è´¥", e)
        }
        
        INSTANCE = null

        // é‡Šæ”¾è¯­éŸ³è¾“å…¥ç®¡ç†å™¨èµ„æº
        try {
            if (::voiceInputManager.isInitialized) {
                voiceInputManager.release()
                Log.d(TAG, "VoiceInputManagerèµ„æºå·²é‡Šæ”¾")
            }
        } catch (e: Exception) {
            Log.e(TAG, "é‡Šæ”¾VoiceInputManagerèµ„æºå¤±è´¥", e)
        }

        // ç«‹å³æ¸…ç†æ‰€æœ‰å»¶è¿Ÿä»»åŠ¡ï¼Œé˜²æ­¢åœ¨Activityé”€æ¯åæ‰§è¡Œ
        try {
            handler.removeCallbacksAndMessages(null)
            longPressHandler.removeCallbacksAndMessages(null)
            fileSyncHandler?.removeCallbacksAndMessages(null)
            periodicSyncHandler?.removeCallbacksAndMessages(null)
            Log.d(TAG, "æ‰€æœ‰Handlerå»¶è¿Ÿä»»åŠ¡å·²æ¸…ç†")
        } catch (e: Exception) {
            Log.e(TAG, "æ¸…ç†Handlerå»¶è¿Ÿä»»åŠ¡å¤±è´¥", e)
        }

        // æ³¨é”€APIå¯†é’¥åŒæ­¥å¹¿æ’­æ¥æ”¶å™¨
        try {
            apiKeySyncReceiver?.let {
                unregisterReceiver(it)
                apiKeySyncReceiver = null
                Log.d(TAG, "APIå¯†é’¥åŒæ­¥å¹¿æ’­æ¥æ”¶å™¨å·²æ³¨é”€")
            }
        } catch (e: Exception) {
            Log.e(TAG, "æ³¨é”€APIå¯†é’¥åŒæ­¥å¹¿æ’­æ¥æ”¶å™¨å¤±è´¥", e)
        }
        
        // æ³¨é”€AIæ¶ˆæ¯æ›´æ–°å¹¿æ’­æ¥æ”¶å™¨
        unregisterBroadcastReceiver()

        // æ³¨é”€æ·»åŠ AIè”ç³»äººå¹¿æ’­æ¥æ”¶å™¨
        try {
            addAIContactReceiver?.let {
                unregisterReceiver(it)
                addAIContactReceiver = null
                Log.d(TAG, "æ·»åŠ AIè”ç³»äººå¹¿æ’­æ¥æ”¶å™¨å·²æ³¨é”€")
            }
        } catch (e: Exception) {
            Log.e(TAG, "æ³¨é”€æ·»åŠ AIè”ç³»äººå¹¿æ’­æ¥æ”¶å™¨å¤±è´¥", e)
        }

        // æ³¨é”€ç¾¤èŠåˆ›å»ºå¹¿æ’­æ¥æ”¶å™¨
        try {
            groupChatCreatedReceiver?.let {
                unregisterReceiver(it)
                groupChatCreatedReceiver = null
                Log.d(TAG, "ç¾¤èŠåˆ›å»ºå¹¿æ’­æ¥æ”¶å™¨å·²æ³¨é”€")
            }
        } catch (e: Exception) {
            Log.e(TAG, "æ³¨é”€ç¾¤èŠåˆ›å»ºå¹¿æ’­æ¥æ”¶å™¨å¤±è´¥", e)
        }

        // æ³¨é”€é“¾æ¥æ“ä½œå¹¿æ’­æ¥æ”¶å™¨
        try {
            linkActionReceiver?.let {
                unregisterReceiver(it)
                linkActionReceiver = null
                Log.d(TAG, "é“¾æ¥æ“ä½œå¹¿æ’­æ¥æ”¶å™¨å·²æ³¨é”€")
            }
        } catch (e: Exception) {
            Log.e(TAG, "æ³¨é”€é“¾æ¥æ“ä½œå¹¿æ’­æ¥æ”¶å™¨å¤±è´¥", e)
        }

        // æ³¨é”€AIå¯¹è¯æ›´æ–°å¹¿æ’­æ¥æ”¶å™¨
        try {
            unregisterReceiver(aiChatUpdateReceiver)
            Log.d(TAG, "AIå¯¹è¯æ›´æ–°å¹¿æ’­æ¥æ”¶å™¨å·²æ³¨é”€")
        } catch (e: Exception) {
            Log.e(TAG, "æ³¨é”€AIå¯¹è¯æ›´æ–°å¹¿æ’­æ¥æ”¶å™¨å¤±è´¥", e)
        }

        // åœæ­¢æ–‡ä»¶ç›‘å¬åŒæ­¥æœºåˆ¶
        stopFileSyncMonitoring()
        
        // åœæ­¢å®šæ—¶å¼ºåˆ¶åŒæ­¥æœºåˆ¶
        stopPeriodicSync()

        // é‡Šæ”¾è¯­éŸ³è¯†åˆ«å™¨
        releaseSpeechRecognizer()
        
        // é‡Šæ”¾VoskManagerèµ„æº
        releaseVoskManager()

        // ä¿å­˜æ‚¬æµ®å¡ç‰‡çŠ¶æ€
        gestureCardWebViewManager?.saveCardsState()
        
        // æ¸…ç†å¤šé¡µé¢WebViewç®¡ç†å™¨
        multiPageWebViewManager?.destroy()
        multiPageWebViewManager = null
        
        // æ¸…ç†æ‰‹åŠ¿å¡ç‰‡WebViewç®¡ç†å™¨
        gestureCardWebViewManager?.destroy()
        gestureCardWebViewManager = null
        
        // ä¿å­˜æ¢å¤æ•°æ®å¹¶æ ‡è®°æ­£å¸¸å…³é—­
        try {
            paperStackWebViewManager?.saveRecoveryData()
            val recoveryManager = com.example.aifloatingball.manager.TabRecoveryManager.getInstance(this)
            recoveryManager.markNormalShutdown()
            Log.d(TAG, "å·²ä¿å­˜æ¢å¤æ•°æ®å¹¶æ ‡è®°æ­£å¸¸å…³é—­")
        } catch (e: Exception) {
            Log.e(TAG, "ä¿å­˜æ¢å¤æ•°æ®å¤±è´¥", e)
        }

        // æ¸…ç†å››åˆ†ä¹‹ä¸€åœ†å¼§æ“ä½œæ 
        quarterArcOperationBar?.let { operationBar ->
            (operationBar.parent as? ViewGroup)?.removeView(operationBar)
        }
        quarterArcOperationBar = null

        // å–æ¶ˆæ ‡ç­¾åˆ‡æ¢åŠ¨ç”»
        tabSwitchAnimationManager.cancelCurrentAnimation()

        // æ¸…ç†åº”ç”¨æœç´¢é€‚é…å™¨èµ„æº
        
        // ç§»é™¤æ•°æ®å˜æ›´ç›‘å¬å™¨
        try {
            unifiedGroupChatManager.removeDataChangeListener(this)
        } catch (e: Exception) {
            Log.e(TAG, "ç§»é™¤æ•°æ®å˜æ›´ç›‘å¬å™¨å¤±è´¥", e)
        }
        try {
            if (::appSearchAdapter.isInitialized) {
                appSearchAdapter.onDestroy()
            }
        } catch (e: Exception) {
            Log.e(TAG, "æ¸…ç†åº”ç”¨æœç´¢é€‚é…å™¨èµ„æºå¤±è´¥", e)
        }
        
        // æ¸…ç†ç³»ç»Ÿçº§æ‚¬æµ®çª—æ’­æ”¾å™¨
        try {
            if (::systemOverlayVideoManager.isInitialized) {
                systemOverlayVideoManager.destroy()
            }
        } catch (e: Exception) {
            Log.e(TAG, "æ¸…ç†ç³»ç»Ÿçº§æ‚¬æµ®çª—æ’­æ”¾å™¨å¤±è´¥", e)
        }
        
        // æ¸…ç†Activityå†…æ‚¬æµ®çª—æ’­æ”¾å™¨
        try {
            if (::floatingVideoManager.isInitialized && floatingVideoManager.isShowing()) {
                floatingVideoManager.hide()
            }
        } catch (e: Exception) {
            Log.e(TAG, "æ¸…ç†Activityå†…æ‚¬æµ®çª—æ’­æ”¾å™¨å¤±è´¥", e)
        }

        // æ¸…ç†æœç´¢tabæ‰‹åŠ¿é®ç½©åŒº
        deactivateSearchTabGestureOverlay()

        // é‡Šæ”¾TTSèµ„æº
        if (::ttsManager.isInitialized) {
            ttsManager.release()
        }

        Log.d(TAG, "Activityé”€æ¯å®Œæˆ")
    }

    /**
     * å¯åŠ¨å›¾æ ‡é¢„åŠ è½½
     */
    private fun startIconPreloading() {
        lifecycleScope.launch {
            try {
                val iconPreloader = com.example.aifloatingball.manager.IconPreloader.getInstance(this@SimpleModeActivity)

                // è·å–æ‰€æœ‰åº”ç”¨é…ç½®
                val allApps = appSearchSettings.getAppConfigs().filter { it.isEnabled }

                Log.d(TAG, "å¼€å§‹é¢„åŠ è½½${allApps.size}ä¸ªåº”ç”¨å›¾æ ‡")

                // æ™ºèƒ½é¢„åŠ è½½ - ä¼˜å…ˆåŠ è½½çƒ­é—¨åº”ç”¨
                iconPreloader.preloadPopularApps(allApps) { progress, total ->
                    Log.d(TAG, "å›¾æ ‡é¢„åŠ è½½è¿›åº¦: $progress/$total")

                    // å¯ä»¥åœ¨è¿™é‡Œæ›´æ–°UIæ˜¾ç¤ºé¢„åŠ è½½è¿›åº¦
                    // ä¾‹å¦‚åœ¨çŠ¶æ€æ æ˜¾ç¤ºè¿›åº¦
                }

                Log.d(TAG, "å›¾æ ‡é¢„åŠ è½½å®Œæˆ")

            } catch (e: Exception) {
                Log.e(TAG, "å›¾æ ‡é¢„åŠ è½½å¤±è´¥", e)
            }
        }
    }

    override fun onPause() {
        super.onPause()
        
        // ğŸ”§ é€€å‡ºæš—é“æ¨¡å¼ï¼ˆåº”ç”¨è¿›å…¥åå°æ—¶ï¼‰
        try {
            val groupManager = TabGroupManager.getInstance(this)
            if (groupManager.isSecretModeActive()) {
                groupManager.deactivateSecretMode()
                Log.d(TAG, "onPause: å·²é€€å‡ºæš—é“æ¨¡å¼")
            }
        } catch (e: Exception) {
            Log.e(TAG, "onPause: é€€å‡ºæš—é“æ¨¡å¼å¤±è´¥", e)
        }
        
        // ä¿å­˜æ¢å¤æ•°æ®ï¼ˆåº”ç”¨è¿›å…¥åå°æ—¶ä¿å­˜ï¼Œç¡®ä¿å³ä½¿è¢«å¼ºåˆ¶å…³é—­ä¹Ÿèƒ½æ¢å¤ï¼‰
        try {
            paperStackWebViewManager?.saveRecoveryData()
            Log.d(TAG, "onPause: å·²ä¿å­˜æ¢å¤æ•°æ®")
        } catch (e: Exception) {
            Log.e(TAG, "onPause: ä¿å­˜æ¢å¤æ•°æ®å¤±è´¥", e)
        }

        // åœ¨ onPause ä¸­ä¿å­˜æ‚¬æµ®å¡ç‰‡çŠ¶æ€ï¼Œç¡®ä¿å³ä½¿åº”ç”¨è¢«ç³»ç»Ÿæ€æ­»ä¹Ÿèƒ½ä¿å­˜
        gestureCardWebViewManager?.saveCardsState()
        Log.d(TAG, "onPause: å·²ä¿å­˜æ‚¬æµ®å¡ç‰‡çŠ¶æ€")

        // å–æ¶ˆé•¿æŒ‰æ£€æµ‹
        longPressRunnable?.let { longPressHandler.removeCallbacks(it) }

        // éšè—åˆ†æ”¯è§†å›¾
        if (::promptBranchManager.isInitialized) {
            promptBranchManager.hideBranchView()
        }

        // æ¢å¤æ­£å¸¸æ˜¾ç¤º
        applyBackgroundBlur(false)
    }

    /**
     * è®¾ç½®æµè§ˆå™¨WebView - çº¸å¼ å åŠ ç‰ˆæœ¬
     */
    private fun setupBrowserWebView() {
        // åˆå§‹åŒ–çº¸å¼ å åŠ WebViewç®¡ç†å™¨
        val windowManager = getSystemService(Context.WINDOW_SERVICE) as WindowManager
        paperStackWebViewManager = PaperStackWebViewManager(
            context = this,
            container = browserWebViewContainer,
            windowManager = windowManager
        )

        // è®¾ç½®åŠŸèƒ½ä¸»é¡µæ“ä½œç›‘å¬å™¨
        paperStackWebViewManager?.setOnFunctionalHomeActionListener(object : PaperStackWebViewManager.FunctionalHomeActionListener {
            override fun onShowGestureGuide() {
                // æ˜¾ç¤ºæ‰‹åŠ¿æŒ‡å—
                try {
                    if (!::browserGestureOverlay.isInitialized) {
                        Log.e(TAG, "browserGestureOverlayæœªåˆå§‹åŒ–ï¼Œæ— æ³•æ“ä½œæ‰‹åŠ¿æŒ‡å—")
                        showMaterialToast("æ‰‹åŠ¿æŒ‡å—åŠŸèƒ½æš‚æ—¶ä¸å¯ç”¨")
                        return
                    }
                    showGestureInstructions()
                } catch (e: Exception) {
                    Log.e(TAG, "æ‰‹åŠ¿æŒ‡å—æŒ‰é’®ç‚¹å‡»å¤„ç†å¤±è´¥", e)
                    showMaterialToast("âŒ æ‰‹åŠ¿æŒ‡å—åŠŸèƒ½å‡ºç°é”™è¯¯")
                }
            }
            
            override fun onOpenDownloadManager() {
                // æ‰“å¼€ä¸‹è½½ç®¡ç†ç•Œé¢
                try {
                    val intent = android.content.Intent(this@SimpleModeActivity, com.example.aifloatingball.download.DownloadManagerActivity::class.java)
                    intent.addFlags(android.content.Intent.FLAG_ACTIVITY_NEW_TASK)
                    startActivity(intent)
                    Log.d(TAG, "æˆåŠŸæ‰“å¼€ä¸‹è½½ç®¡ç†ç•Œé¢")
                    showMaterialToast("æ‰“å¼€ä¸‹è½½ç®¡ç†")
                } catch (e: Exception) {
                    Log.e(TAG, "ä¸‹è½½ç®¡ç†æŒ‰é’®ç‚¹å‡»å¤„ç†å¤±è´¥", e)
                    showMaterialToast("æ‰“å¼€ä¸‹è½½ç®¡ç†å¤±è´¥")
                }
            }
            
            override fun onCreateNewGroup() {
                // æ‰“å¼€ç»„ç®¡ç†ç•Œé¢ï¼ˆåŒ…å«åˆ›å»ºã€ç¼–è¾‘ã€åˆ é™¤ç­‰åŠŸèƒ½ï¼‰
                try {
                    showGroupManagerDialog()
                    Log.d(TAG, "æˆåŠŸæ‰“å¼€ç»„ç®¡ç†ç•Œé¢")
                } catch (e: Exception) {
                    Log.e(TAG, "ç»„ç®¡ç†æŒ‰é’®ç‚¹å‡»å¤„ç†å¤±è´¥", e)
                    showMaterialToast("æ‰“å¼€ç»„ç®¡ç†å¤±è´¥")
                }
            }
            
            override fun onOpenGroupManager() {
                // æ‰“å¼€ç»„ç®¡ç†ç•Œé¢
                try {
                    showGroupManagerDialog()
                    Log.d(TAG, "æˆåŠŸæ‰“å¼€ç»„ç®¡ç†ç•Œé¢")
                } catch (e: Exception) {
                    Log.e(TAG, "ç»„ç®¡ç†æŒ‰é’®ç‚¹å‡»å¤„ç†å¤±è´¥", e)
                    showMaterialToast("æ‰“å¼€ç»„ç®¡ç†å¤±è´¥")
                }
            }
            
            override fun onOpenBookmarks() {
                // æ‰“å¼€æ”¶è—å¤¹ç•Œé¢
                try {
                    val intent = android.content.Intent(this@SimpleModeActivity, com.example.aifloatingball.BookmarkActivity::class.java)
                    startActivity(intent)
                    Log.d(TAG, "æˆåŠŸæ‰“å¼€æ”¶è—å¤¹ç•Œé¢")
                } catch (e: Exception) {
                    Log.e(TAG, "æ”¶è—å¤¹æŒ‰é’®ç‚¹å‡»å¤„ç†å¤±è´¥", e)
                    showMaterialToast("æ‰“å¼€æ”¶è—å¤¹å¤±è´¥")
                }
            }
            
            override fun onOpenHistory() {
                // æ‰“å¼€å†å²è®°å½•å¯¹è¯æ¡†
                try {
                    showHistoryDialog()
                    Log.d(TAG, "æˆåŠŸæ‰“å¼€å†å²è®°å½•å¯¹è¯æ¡†")
                } catch (e: Exception) {
                    Log.e(TAG, "æ‰“å¼€å†å²è®°å½•å¯¹è¯æ¡†å¤±è´¥", e)
                    showMaterialToast("æ‰“å¼€å†å²è®°å½•å¤±è´¥")
                }
            }
            
            override fun onOpenFileReader() {
                // æ‰“å¼€æ–‡ä»¶é€‰æ‹©å™¨
                try {
                    Log.d(TAG, "åŠŸèƒ½ä¸»é¡µï¼šæ‰“å¼€æ–‡ä»¶é˜…è¯»å™¨")
                    openFilePicker()
                    showMaterialToast("é€‰æ‹©æ–‡ä»¶")
                } catch (e: Exception) {
                    Log.e(TAG, "æ‰“å¼€æ–‡ä»¶é€‰æ‹©å™¨å¤±è´¥", e)
                    showMaterialToast("æ‰“å¼€æ–‡ä»¶é€‰æ‹©å™¨å¤±è´¥")
                }
            }
            
            override fun onOpenSettings() {
                // æ‰“å¼€ç»¼åˆè®¾ç½®ç•Œé¢
                try {
                    val intent = android.content.Intent(this@SimpleModeActivity, com.example.aifloatingball.HomeSettingsActivity::class.java)
                    startActivity(intent)
                    Log.d(TAG, "æˆåŠŸæ‰“å¼€ç»¼åˆè®¾ç½®ç•Œé¢")
                } catch (e: Exception) {
                    Log.e(TAG, "ç»¼åˆè®¾ç½®æŒ‰é’®ç‚¹å‡»å¤„ç†å¤±è´¥", e)
                    showMaterialToast("æ‰“å¼€ç»¼åˆè®¾ç½®å¤±è´¥")
                }
            }
            
            override fun onSaveButtonOrder(orderJson: String) {
                // ä¿å­˜æŒ‰é’®é¡ºåº
                try {
                    settingsManager.putString("home_button_order", orderJson)
                    Log.d(TAG, "æŒ‰é’®é¡ºåºå·²ä¿å­˜: $orderJson")
                } catch (e: Exception) {
                    Log.e(TAG, "ä¿å­˜æŒ‰é’®é¡ºåºå¤±è´¥", e)
                }
            }
            
            override fun getButtonOrder(): String {
                // è·å–æŒ‰é’®é¡ºåº
                try {
                    val order = settingsManager.getString("home_button_order", "[]") ?: "[]"
                    Log.d(TAG, "è·å–æŒ‰é’®é¡ºåº: $order")
                    return order
                } catch (e: Exception) {
                    Log.e(TAG, "è·å–æŒ‰é’®é¡ºåºå¤±è´¥", e)
                    return "[]"
                }
            }
            
            override fun onCancelButtonLongPress() {
                // å–æ¶ˆé•¿æŒ‰ï¼ˆç”¨äºæ‹–æ‹½æ—¶ï¼‰
                // è¿™ä¸ªåŠŸèƒ½åœ¨HTMLä¸­å¤„ç†ï¼Œè¿™é‡Œå¯ä»¥ç•™ç©ºæˆ–æ·»åŠ æ—¥å¿—
                Log.d(TAG, "å–æ¶ˆæŒ‰é’®é•¿æŒ‰")
            }
            
        override fun onHideButton(buttonId: String) {
            // éšè—æŒ‰é’®ï¼ˆåªåœ¨é•¿æŒ‰è¿›åº¦æ¡èµ°å®Œæ—¶è°ƒç”¨ï¼Œä¸åº”è¯¥åœ¨å•å‡»æ—¶è°ƒç”¨ï¼‰
            try {
                val key = "home_button_${buttonId}_visible"
                settingsManager.putBoolean(key, false)
                refreshHomeButtonVisibility()
                showMaterialToast("å·²éšè—æŒ‰é’®")
                Log.d(TAG, "éšè—æŒ‰é’®: $buttonId")
            } catch (e: Exception) {
                Log.e(TAG, "éšè—æŒ‰é’®å¤±è´¥", e)
            }
        }
        
        override fun onShowRestoreButtonsDialog() {
            // æ˜¾ç¤ºæ¢å¤æŒ‰é’®å¯¹è¯æ¡†
            try {
                showRestoreButtonsDialog()
                Log.d(TAG, "æˆåŠŸæ‰“å¼€æ¢å¤æŒ‰é’®å¯¹è¯æ¡†")
            } catch (e: Exception) {
                Log.e(TAG, "æ¢å¤æŒ‰é’®å¯¹è¯æ¡†æ‰“å¼€å¤±è´¥", e)
                showMaterialToast("æ‰“å¼€æ¢å¤æŒ‰é’®å¤±è´¥")
            }
        }
            
            override fun getButtonVisibility(): String {
                // è·å–æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€
                return try {
                    val visibility = getHomeButtonVisibility()
                    com.google.gson.Gson().toJson(visibility)
                } catch (e: Exception) {
                    Log.e(TAG, "è·å–æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€å¤±è´¥", e)
                    "{}"
                }
            }
        })
        
        // è®¾ç½®æ ‡ç­¾é¡µç›‘å¬å™¨ï¼ˆåˆå¹¶æ‰€æœ‰é€»è¾‘åˆ°ä¸€ä¸ªç›‘å¬å™¨ï¼Œé¿å…è¦†ç›–ï¼‰
        paperStackWebViewManager?.setOnTabCreatedListener { tab ->
            // ğŸ”§ ä¿®å¤ï¼šç«‹å³éšè—åŸç”ŸåŠŸèƒ½ä¸»é¡µï¼Œé¿å…åœ¨WebViewåŠ è½½æ—¶çœ‹åˆ°èƒŒé¢çš„æŒ‰é’®
            // åœ¨æ ‡ç­¾é¡µåˆ›å»ºæ—¶ç«‹å³éšè—ï¼Œè€Œä¸æ˜¯ç­‰åˆ°åŠ è½½å®Œæˆ
            browserHomeContent.visibility = View.GONE
            
            // ğŸ”§ ä¿®å¤ï¼šé»˜è®¤é¦–é¡µæ—¶ä¹Ÿæ˜¾ç¤ºtabæ ï¼Œæ–¹ä¾¿ç”¨æˆ·è·³è½¬åˆ°å…¶ä»–tab
            val isHomePage = tab.url == "home://functional" || 
                           tab.url == "file:///android_asset/functional_home.html"
            if (isHomePage) {
                browserTabContainer.visibility = View.VISIBLE
                Log.d(TAG, "é»˜è®¤é¦–é¡µï¼šæ˜¾ç¤ºtabæ ï¼Œæ–¹ä¾¿ç”¨æˆ·è·³è½¬åˆ°å…¶ä»–tab")
            } else {
                browserTabContainer.visibility = View.GONE
            }
            
            // ğŸ”§ ä¿®å¤ï¼šç¡®ä¿WebViewå®¹å™¨èƒŒæ™¯ä¸ºç™½è‰²ï¼Œé¿å…é€è§†åˆ°åŠŸèƒ½ä¸»é¡µæŒ‰é’®
            val webViewContainer = findViewById<FrameLayout>(R.id.browser_webview_container)
            webViewContainer?.setBackgroundColor(Color.WHITE)
            
            // ğŸ”§ ä¿®å¤ï¼šç¡®ä¿WebViewèƒŒæ™¯ä¸ºç™½è‰²ï¼Œé¿å…é€è§†åˆ°åŠŸèƒ½ä¸»é¡µæŒ‰é’®
            // ç›´æ¥è®¾ç½®WebViewèƒŒæ™¯è‰²ï¼Œä¸æ£€æŸ¥å…·ä½“ç±»å‹ï¼ˆPaperWebViewæ˜¯ç§æœ‰ç±»ï¼‰
            tab.webView.setBackgroundColor(Color.WHITE)
            
            // ğŸ”§ æ–°å¢ï¼šæ ‡ç­¾é¡µåˆ›å»ºæ—¶ç«‹å³æ˜¾ç¤ºåŠ è½½é®ç½©å±‚ï¼Œé®æŒ¡åŠŸèƒ½ä¸»é¡µæŒ‰é’®
            showLoadingOverlay()
            
            Log.d(TAG, "æ ‡ç­¾é¡µåˆ›å»ºæ—¶éšè—åŠŸèƒ½ä¸»é¡µå¹¶è®¾ç½®WebViewèƒŒæ™¯ä¸ºç™½è‰²: ${tab.title}")
            
            // å¦‚æœæ˜¯åŠŸèƒ½ä¸»é¡µï¼Œç¡®ä¿æ˜¾ç¤ºçº¸å †å¸ƒå±€
            if (tab.url == "home://functional") {
                val paperStackLayout = findViewById<View>(R.id.paper_stack_layout)
                paperStackLayout?.visibility = View.VISIBLE
                browserSearchInput.setText("")
                
                // ç¡®ä¿WebViewå¯è§å¹¶æ­£ç¡®æ˜¾ç¤º
                tab.webView.visibility = View.VISIBLE
                tab.webView.bringToFront()
                
                // å»¶è¿Ÿä¸€ç‚¹æ—¶é—´ç¡®ä¿WebViewå®Œå…¨åŠ è½½
                handler.postDelayed({
                    tab.webView.visibility = View.VISIBLE
                    paperStackLayout?.visibility = View.VISIBLE
                    Log.d(TAG, "âœ… åŠŸèƒ½ä¸»é¡µæ ‡ç­¾é¡µåˆ›å»ºå®Œæˆ: ${tab.title}, WebViewå·²æ˜¾ç¤º")
                }, 100)
                
                Log.d(TAG, "åŠŸèƒ½ä¸»é¡µæ ‡ç­¾é¡µåˆ›å»º: ${tab.title}, å·²æ˜¾ç¤ºçº¸å †å¸ƒå±€")
            }
            
            // æ ‡ç­¾é¡µåˆ›å»ºæ—¶åŒæ­¥æ›´æ–°
            syncAllCardSystems()
            
            // æ–°å»ºæ ‡ç­¾é¡µä¹Ÿæ³¨å…¥è§†é¢‘æ£€æµ‹
            injectVideoHookToWebView(tab.webView)
            
            // ğŸ”§ ä¿®å¤ï¼šä¸ºæ–°å»ºçš„æ ‡ç­¾é¡µæ·»åŠ æ»šåŠ¨ç›‘å¬å™¨ï¼Œç¡®ä¿å·¥å…·æ èƒ½æ­£å¸¸æ˜¾ç¤º/éšè—
            addScrollListenerToWebView(tab.webView)
            
            // æ›´æ–°æœç´¢tabå¾½æ ‡
            updateSearchTabBadge()
            
            // âš¡ ç«‹å³æ›´æ–°é¡µé¢æ•°å­—ï¼ˆå¿…é¡»åœ¨æ‰€æœ‰é€»è¾‘ä¹‹åï¼Œç¡®ä¿æ•°æ®å·²æ›´æ–°ï¼‰
            handler.post {
                updatePageCountDisplay()
            }
            
            Log.d(TAG, "åˆ›å»ºæ ‡ç­¾é¡µ: ${tab.title}, URL: ${tab.url}")
        }

        paperStackWebViewManager?.setOnTabSwitchedListener { tab, index ->
            // ğŸ”§ ä¿®å¤ï¼šåˆ‡æ¢æ ‡ç­¾é¡µæ—¶éšè—å¿«æ·æ“ä½œæ ï¼Œé¿å…åœ¨WebViewé€æ˜æ—¶çœ‹åˆ°èƒŒé¢çš„æŒ‰é’®
            if (isQuickActionsBarVisible) {
                hideQuickActionsBar()
                Log.d(TAG, "åˆ‡æ¢æ ‡ç­¾é¡µæ—¶éšè—å¿«æ·æ“ä½œæ ï¼Œé¿å…é€è§†é—®é¢˜")
            }
            
            // ğŸ”§ æ–°å¢ï¼šåˆ‡æ¢åˆ°åŠŸèƒ½ä¸»é¡µæ—¶ï¼Œç¡®ä¿æ˜¾ç¤ºtabæ å’Œç»„æ ‡ç­¾
            if (tab.url == "home://functional") {
                // ç¡®ä¿å·¥å…·æ å¯è§
                if (!isToolbarVisible) {
                    showToolbar()
                    showBottomNavigationAndHideQuickActions()
                }
                
                // ç¡®ä¿ç»„æ ‡ç­¾æ å¯è§
                groupTabsContainer?.let { container ->
                    if (container.visibility != View.VISIBLE) {
                        container.visibility = View.VISIBLE
                        container.alpha = 1f
                        container.translationY = 0f
                        Log.d(TAG, "åˆ‡æ¢åˆ°åŠŸèƒ½ä¸»é¡µï¼Œæ¢å¤ç»„æ ‡ç­¾æ æ˜¾ç¤º")
                    }
                }
                
                // åˆ·æ–°ç»„æ ‡ç­¾æ 
                refreshGroupTabs()
            }
            
            // åˆ‡æ¢æ ‡ç­¾é¡µæ—¶éšè—é˜…è¯»æ¨¡å¼æŒ‰é’®
            hideReaderModeButtonForCatalog()
            
            // æ›´æ–°é¡µé¢æ•°å­—
            updatePageCountDisplay()
            // æ›´æ–°æœç´¢æ¡†URLä¸ç«™ç‚¹å›¾æ ‡ï¼ˆåŠŸèƒ½ä¸»é¡µæ˜¾ç¤ºç©ºå­—ç¬¦ä¸²ï¼‰
            if (tab.url == "home://functional") {
                browserSearchInput.setText("")
                
                // åˆ‡æ¢åˆ°åŠŸèƒ½ä¸»é¡µæ—¶ï¼Œåˆ·æ–°æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€å’Œé¡ºåºï¼Œå¹¶è®¾ç½®ä¸»é¢˜
                tab.webView.postDelayed({
                    tab.webView.evaluateJavascript("updateButtonVisibility();", null)
                    tab.webView.evaluateJavascript("loadButtonOrder();", null)
                    tab.webView.evaluateJavascript("updateButtonLayout();", null)
                    
                    // è®¾ç½®æ·±è‰²æ¨¡å¼
                    val themeMode = settingsManager.getThemeMode()
                    val isDarkMode = when (themeMode) {
                        SettingsManager.THEME_MODE_DARK -> true
                        SettingsManager.THEME_MODE_LIGHT -> false
                        else -> {
                            // è·Ÿéšç³»ç»Ÿ
                            val nightModeFlags = resources.configuration.uiMode and android.content.res.Configuration.UI_MODE_NIGHT_MASK
                            nightModeFlags == android.content.res.Configuration.UI_MODE_NIGHT_YES
                        }
                    }
                    val theme = if (isDarkMode) "dark" else "light"
                    tab.webView.evaluateJavascript("setTheme('$theme');", null)
                    
                    Log.d(TAG, "åˆ‡æ¢åˆ°åŠŸèƒ½ä¸»é¡µï¼Œå·²åˆ·æ–°æŒ‰é’®çŠ¶æ€å’Œè®¾ç½®ä¸»é¢˜: $theme")
                }, 300)
            } else {
                // ğŸ”§ ä¿®å¤ï¼šå¦‚æœæ˜¯åŠŸèƒ½ä¸»é¡µï¼Œæ˜¾ç¤º"é¦–é¡µ"è€Œä¸æ˜¯URL
                val displayText = if (tab.url == "home://functional" || tab.url == "file:///android_asset/functional_home.html") {
                    "é¦–é¡µ"
                } else {
                    tab.url
                }
                browserSearchInput.setText(displayText)
            }
            updateBrowserFaviconButtonForUrl(tab.url)

            // ä¸ºå½“å‰æ ‡ç­¾é¡µæ³¨å…¥è§†é¢‘æ£€æµ‹è„šæœ¬
            injectVideoHookToWebView(tab.webView)

            // ğŸ”§ ä¿®å¤ï¼šä¸ºåˆ‡æ¢åˆ°çš„æ ‡ç­¾é¡µæ·»åŠ æ»šåŠ¨ç›‘å¬å™¨ï¼Œç¡®ä¿å·¥å…·æ èƒ½æ­£å¸¸æ˜¾ç¤º/éšè—
            addScrollListenerToWebView(tab.webView)

            // åŒæ­¥æ›´æ–°StackedCardPreviewæ•°æ®
            syncAllCardSystems()

            Log.d(TAG, "åˆ‡æ¢åˆ°æ ‡ç­¾é¡µ: ${tab.title}")
        }
        
        // æ³¨æ„ï¼šsetOnTabCreatedListener å·²åœ¨ä¸Šé¢è®¾ç½®ï¼Œè¿™é‡Œä¸å†é‡å¤è®¾ç½®ï¼Œé¿å…è¦†ç›–
        // å¦‚æœéœ€è¦æ·»åŠ é¢å¤–é€»è¾‘ï¼Œåº”è¯¥åœ¨ä¹‹å‰çš„ç›‘å¬å™¨ä¸­åˆå¹¶

        // ğŸ”§ åˆå§‹åŒ–å…¨å±€é˜…è¯»æ¨¡å¼ç®¡ç†å™¨å®ä¾‹ï¼Œå¹¶è®¾ç½®ç›‘å¬å™¨
        try {
            // åˆ›å»ºå…¨å±€é˜…è¯»æ¨¡å¼ç®¡ç†å™¨å®ä¾‹ï¼ˆå¦‚æœè¿˜æ²¡æœ‰åˆ›å»ºï¼‰
            if (globalReaderModeManager == null) {
                globalReaderModeManager = com.example.aifloatingball.reader.NovelReaderModeManager(this)
                
                // è®¾ç½®é˜…è¯»æ¨¡å¼ç›‘å¬å™¨ï¼Œåœ¨é˜…è¯»æ¨¡å¼è¿›å…¥/é€€å‡ºæ—¶ç¦ç”¨/å¯ç”¨ browserSwipeRefresh
                globalReaderModeManager?.setListener(object : com.example.aifloatingball.reader.NovelReaderModeManager.ReaderModeListener {
                    override fun onReaderModeEntered() {
                        // ==================== è¿›å…¥é˜…è¯»æ¨¡å¼æ—¶çš„åˆå§‹åŒ– ====================
                        // ç›®æ ‡ï¼šè®¾ç½®é˜…è¯»æ¨¡å¼ä¸‹çš„UIçŠ¶æ€ï¼Œç¡®ä¿æœ€å¤§åŒ–é˜…è¯»ç©ºé—´
                        runOnUiThread {
                            try {
                                // ç¡®ä¿åªåœ¨æœç´¢tabä¸­æ‰å¤„ç†
                                if (currentState == UIState.BROWSER) {
                                    // 1. ç¦ç”¨ä¸‹æ‹‰åˆ·æ–°ï¼ˆé˜…è¯»æ¨¡å¼ä¸‹ä¸éœ€è¦ï¼‰
                                    if (::browserSwipeRefresh.isInitialized) {
                                        browserSwipeRefresh.isEnabled = false
                                        Log.d(TAG, "ğŸ“– é˜…è¯»æ¨¡å¼å·²è¿›å…¥ï¼šå·²ç¦ç”¨ä¸‹æ‹‰åˆ·æ–°")
                                    }
                                    
                                    // 2. å¼ºåˆ¶éšè—åº•éƒ¨tabæ ï¼ˆé˜…è¯»æ¨¡å¼ä¸‹å¿…é¡»å®Œå…¨å±è”½ï¼‰
                                    val bottomNav = findViewById<LinearLayout>(R.id.bottom_navigation)
                                    if (bottomNav != null) {
                                        bottomNav.visibility = View.GONE
                                        bottomNav.alpha = 0f
                                        isBottomNavVisible = false
                                        Log.d(TAG, "ğŸ“– é˜…è¯»æ¨¡å¼å·²è¿›å…¥ï¼šå·²å¼ºåˆ¶éšè—åº•éƒ¨tabæ ")
                                    }
                                    
                                    // 3. ç¡®ä¿åº•éƒ¨åœ°å€è¾“å…¥æ å’Œæ‚¬æµ®å·¥å…·æ åˆå§‹çŠ¶æ€æ­£ç¡®
                                    // åˆå§‹æ—¶æ˜¾ç¤ºï¼Œç”¨æˆ·ä¸‹æ»‘æ—¶ä¼šè‡ªåŠ¨éšè—
                                    if (!isToolbarVisible) {
                                        showToolbar()
                                    }
                                    if (!isQuickActionsBarVisible) {
                                        hideBottomNavigationAndShowQuickActions()
                                    }
                                    
                                    Log.d(TAG, "ğŸ“– é˜…è¯»æ¨¡å¼å·²è¿›å…¥ï¼šUIçŠ¶æ€å·²åˆå§‹åŒ–ï¼Œåˆå§‹æ˜¾ç¤ºæ“ä½œæ§ä»¶")
                                } else {
                                    Log.d(TAG, "é˜…è¯»æ¨¡å¼å·²è¿›å…¥ï¼Œä½†å½“å‰ä¸åœ¨æœç´¢tabä¸­ï¼Œè·³è¿‡UIåˆå§‹åŒ–")
                                }
                                
                                // æ”¶è—åˆ°AIåŠ©æ‰‹çš„ç”µå­ä¹¦æ”¶è—
                                addReaderModeToEbookCollection()
                            } catch (e: Exception) {
                                Log.e(TAG, "é˜…è¯»æ¨¡å¼åˆå§‹åŒ–å¤±è´¥", e)
                            }
                        }
                    }
                    
                    override fun onReaderModeExited() {
                        // ğŸ”§ ä¿®å¤ï¼šé€€å‡ºé˜…è¯»æ¨¡å¼æ—¶ï¼Œæ¢å¤UIçŠ¶æ€
                        runOnUiThread {
                            try {
                                // ç¡®ä¿åªåœ¨æœç´¢tabä¸­æ‰æ¢å¤UI
                                if (currentState == UIState.BROWSER) {
                                    // 1. é‡æ–°å¯ç”¨ä¸‹æ‹‰æ‰‹åŠ¿èœå•
                                    if (::browserSwipeRefresh.isInitialized) {
                                        browserSwipeRefresh.isEnabled = true
                                        Log.d(TAG, "âœ… é˜…è¯»æ¨¡å¼å·²é€€å‡ºï¼Œå·²åœ¨æœç´¢tabä¸­å¯ç”¨ browserSwipeRefresh")
                                    }
                                    
                                    // 2. æ¢å¤åº•éƒ¨å¯¼èˆªæ å¯è§æ€§
                                    val bottomNav = findViewById<LinearLayout>(R.id.bottom_navigation)
                                    if (bottomNav != null) {
                                        if (!isBottomNavVisible) {
                                            // å¦‚æœåº•éƒ¨å¯¼èˆªæ è¢«éšè—äº†ï¼Œæ¢å¤æ˜¾ç¤º
                                            if (isQuickActionsBarVisible) {
                                                // å¦‚æœå¿«æ·æ“ä½œæ æ­£åœ¨æ˜¾ç¤ºï¼Œä½¿ç”¨åŒæ­¥æ–¹æ³•
                                                showBottomNavigationAndHideQuickActions()
                                            } else {
                                                // å¦‚æœå¿«æ·æ“ä½œæ æœªæ˜¾ç¤ºï¼Œç›´æ¥æ˜¾ç¤ºåº•éƒ¨å¯¼èˆªæ 
                                                showBottomNavigation()
                                            }
                                            Log.d(TAG, "âœ… é˜…è¯»æ¨¡å¼å·²é€€å‡ºï¼Œå·²æ¢å¤åº•éƒ¨å¯¼èˆªæ æ˜¾ç¤º")
                                        } else {
                                            // ç¡®ä¿åº•éƒ¨å¯¼èˆªæ å¯è§ï¼ˆå¯èƒ½è¢«åŠ¨ç”»éšè—äº†ï¼‰
                                            bottomNav.visibility = View.VISIBLE
                                            bottomNav.alpha = 1f
                                            bottomNav.translationY = 0f
                                            isBottomNavVisible = true
                                            Log.d(TAG, "âœ… é˜…è¯»æ¨¡å¼å·²é€€å‡ºï¼Œåº•éƒ¨å¯¼èˆªæ å·²ç¡®ä¿å¯è§")
                                        }
                                    } else {
                                        Log.w(TAG, "åº•éƒ¨å¯¼èˆªæ æœªæ‰¾åˆ°ï¼Œæ— æ³•æ¢å¤")
                                    }
                                    
                                    // 3. ç¡®ä¿å·¥å…·æ å¯è§ï¼ˆå¦‚æœè¢«éšè—äº†ï¼‰
                                    if (!isToolbarVisible) {
                                        showToolbar()
                                        Log.d(TAG, "âœ… é˜…è¯»æ¨¡å¼å·²é€€å‡ºï¼Œå·²æ¢å¤å·¥å…·æ æ˜¾ç¤º")
                                    }
                                } else {
                                    Log.d(TAG, "é˜…è¯»æ¨¡å¼å·²é€€å‡ºï¼Œä½†å½“å‰ä¸åœ¨æœç´¢tabä¸­ï¼Œè·³è¿‡æ¢å¤UI")
                                }
                            } catch (e: Exception) {
                                Log.e(TAG, "æ¢å¤UIçŠ¶æ€å¤±è´¥", e)
                            }
                        }
                    }
                    
                    override fun onChapterLoaded(chapter: com.example.aifloatingball.reader.NovelReaderModeManager.ChapterInfo) {
                        // ç« èŠ‚åŠ è½½å®Œæˆï¼Œä¸éœ€è¦ç‰¹æ®Šå¤„ç†
                        Log.d(TAG, "ç« èŠ‚åŠ è½½å®Œæˆ: ${chapter.title}")
                    }
                    
                    override fun onNextChapterRequested() {
                        // ä¸‹ä¸€ç« è¯·æ±‚ï¼Œä¸éœ€è¦ç‰¹æ®Šå¤„ç†
                        Log.d(TAG, "ä¸‹ä¸€ç« è¯·æ±‚")
                    }
                    
                    override fun onScroll(scrollTop: Int, scrollDelta: Int, isAtTop: Boolean, isAtBottom: Boolean) {
                        // æ»šåŠ¨äº‹ä»¶ï¼Œåœ¨SimpleModeActivityä¸­ä¸éœ€è¦ç‰¹æ®Šå¤„ç†
                        // å› ä¸ºSimpleModeActivityæœ‰è‡ªå·±çš„æ»šåŠ¨å¤„ç†é€»è¾‘
                    }
                })
                Log.d(TAG, "âœ… å…¨å±€é˜…è¯»æ¨¡å¼ç®¡ç†å™¨å·²åˆå§‹åŒ–ï¼Œç›‘å¬å™¨å·²è®¾ç½®")
            } else {
                Log.d(TAG, "å…¨å±€é˜…è¯»æ¨¡å¼ç®¡ç†å™¨å·²å­˜åœ¨ï¼Œè·³è¿‡åˆå§‹åŒ–")
            }
        } catch (e: Exception) {
            Log.e(TAG, "åˆå§‹åŒ–å…¨å±€é˜…è¯»æ¨¡å¼ç®¡ç†å™¨å¤±è´¥", e)
        }
        
        // favicon æ¥æ”¶æ—¶ï¼Œç«‹å³æ›´æ–°ç«™ç‚¹æŒ‰é’®çš„å›¾æ ‡ä¸å¯è§æ€§
        paperStackWebViewManager?.setOnFaviconReceivedListener { tab, icon ->
            try {
                if (icon != null) {
                    browserBtnSite.setImageBitmap(icon)
                    browserBtnSite.visibility = View.VISIBLE
                } else {
                    // å›é€€åˆ°é€šè¿‡URLåŠ è½½favicon
                    updateBrowserFaviconButtonForUrl(tab.url)
                }
            } catch (e: Exception) {
                Log.w(TAG, "æ›´æ–°faviconæŒ‰é’®å¤±è´¥", e)
            }
        }

        // é¡µé¢å¼€å§‹åŠ è½½æ—¶éšè—æ‚¬æµ®çª—
        paperStackWebViewManager?.setOnPageStartedListener { tab, url ->
            Log.d(TAG, "çº¸å †æ¨¡å¼é¡µé¢å¼€å§‹åŠ è½½: $url")
            
            // ğŸ”§ ä¿®å¤ï¼šé¡µé¢å¼€å§‹åŠ è½½æ—¶æ˜¾ç¤ºåŠ è½½é®ç½©å±‚ï¼ˆå¸¦åŠ¨ç”»ï¼‰ï¼Œé®æŒ¡åŠŸèƒ½ä¸»é¡µæŒ‰é’®
            showLoadingOverlay()
            
            // é¡µé¢å¼€å§‹åŠ è½½æ—¶éšè—é˜…è¯»æ¨¡å¼æŒ‰é’®
            hideReaderModeButtonForCatalog()
            
            // æ›´æ–°åœ°å€æ æ˜¾ç¤ºå½“å‰é¡µé¢URL
            if (url != null && url.isNotEmpty()) {
                runOnUiThread {
                    // ğŸ”§ ä¿®å¤ï¼šå¦‚æœæ˜¯åŠŸèƒ½ä¸»é¡µï¼Œæ˜¾ç¤º"é¦–é¡µ"è€Œä¸æ˜¯URL
                    val displayText = if (url == "home://functional" || url == "file:///android_asset/functional_home.html") {
                        "é¦–é¡µ"
                    } else {
                        url
                    }
                    browserSearchInput.setText(displayText)
                    Log.d(TAG, "é¡µé¢å¼€å§‹åŠ è½½ï¼Œæ›´æ–°åœ°å€æ æ˜¾ç¤º: $displayText (åŸå§‹URL: $url)")
                }
            }
            
            // éšè—æ‚¬æµ®æ’­æ”¾å™¨
            if (::floatingVideoManager.isInitialized && floatingVideoManager.isShowing()) {
                floatingVideoManager.hide()
            }
            if (::systemOverlayVideoManager.isInitialized && systemOverlayVideoManager.isShowing()) {
                systemOverlayVideoManager.hide()
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆæ—¶æ³¨å…¥è§†é¢‘æ£€æµ‹è„šæœ¬
        paperStackWebViewManager?.setOnPageFinishedListener { tab, url ->
            Log.d(TAG, "çº¸å †æ¨¡å¼é¡µé¢åŠ è½½å®Œæˆ: $url")
            
            // ğŸ”§ ä¿®å¤ï¼šé¡µé¢åŠ è½½å®Œæˆæ—¶éšè—åŠ è½½é®ç½©å±‚ï¼ˆå¸¦åŠ¨ç”»ï¼‰
            hideLoadingOverlay()
            
            // æ›´æ–°åœ°å€æ æ˜¾ç¤ºå½“å‰é¡µé¢URL
            if (url != null && url.isNotEmpty()) {
                runOnUiThread {
                    // ğŸ”§ ä¿®å¤ï¼šå¦‚æœæ˜¯åŠŸèƒ½ä¸»é¡µï¼Œæ˜¾ç¤º"é¦–é¡µ"è€Œä¸æ˜¯URL
                    val displayText = if (url == "home://functional" || url == "file:///android_asset/functional_home.html") {
                        "é¦–é¡µ"
                    } else {
                        url
                    }
                    browserSearchInput.setText(displayText)
                    Log.d(TAG, "æ›´æ–°åœ°å€æ æ˜¾ç¤º: $displayText (åŸå§‹URL: $url)")
                }
            }
            
            injectVideoHookToWebView(tab.webView)
            
            // ğŸ”§ ä¿®å¤4ï¼šé¡µé¢åŠ è½½å®Œæˆåä¿å­˜æˆªå›¾
            handler.postDelayed({
                try {
                    if (tab.webView.width > 0 && tab.webView.height > 0) {
                        tab.webView.isDrawingCacheEnabled = true
                        tab.webView.buildDrawingCache()
                        val bitmap = tab.webView.drawingCache
                        if (bitmap != null) {
                            val screenshot = android.graphics.Bitmap.createBitmap(bitmap)
                            tab.screenshot?.recycle()
                            tab.screenshot = screenshot
                            Log.d(TAG, "âœ… é¡µé¢åŠ è½½å®Œæˆï¼Œå·²ä¿å­˜æˆªå›¾: ${tab.title}")
                        }
                        tab.webView.isDrawingCacheEnabled = false
                    }
                } catch (e: Exception) {
                    Log.e(TAG, "é¡µé¢åŠ è½½å®Œæˆæ—¶ä¿å­˜æˆªå›¾å¤±è´¥: ${tab.title}", e)
                }
            }, 500) // å»¶è¿Ÿ500msç¡®ä¿é¡µé¢å®Œå…¨æ¸²æŸ“
            
            // ğŸ”§ ä¿®å¤5ï¼šé¡µé¢åŠ è½½å®Œæˆåç«‹å³æ›´æ–°é¡µé¢æ•°é‡æ˜¾ç¤º
            handler.post {
                updatePageCountDisplay()
            }
            
            // ğŸ”§ é€šçŸ¥é˜…è¯»æ¨¡å¼2é¡µé¢åŠ è½½å®Œæˆï¼ˆå¦‚æœå¤„äºé˜…è¯»æ¨¡å¼2ï¼‰
            if (url != null && url.isNotEmpty()) {
                try {
                    val readerManager2 = com.example.aifloatingball.reader.NovelReaderManager.getInstance(this@SimpleModeActivity)
                    if (readerManager2.isReaderModeActive) {
                        readerManager2.onPageFinished(url)
                        Log.d(TAG, "âœ… å·²é€šçŸ¥é˜…è¯»æ¨¡å¼2é¡µé¢åŠ è½½å®Œæˆ: $url")
                    }
                } catch (e: Exception) {
                    Log.e(TAG, "é€šçŸ¥é˜…è¯»æ¨¡å¼2é¡µé¢åŠ è½½å®Œæˆå¤±è´¥", e)
                }
            }
            
            // ğŸ†• æ£€æµ‹ç›®å½•é¡µå¹¶è‡ªåŠ¨å¼¹å‡ºé˜…è¯»æ¨¡å¼æŒ‰é’®
            if (url != null && url.isNotEmpty() && !url.startsWith("home://")) {
                // åªåœ¨éåŠŸèƒ½ä¸»é¡µæ—¶æ£€æµ‹
                globalReaderModeManager?.let { readerManager ->
                    // ğŸ”§ æ”¾å®½æ¡ä»¶ï¼šä¸å†å¼ºåˆ¶è¦æ±‚æ˜¯å·²çŸ¥çš„å°è¯´ç½‘ç«™ï¼Œå¯¹æ‰€æœ‰é¡µé¢éƒ½è¿›è¡Œæ£€æµ‹
                    // ä½†æ’é™¤æ˜æ˜¾ä¸æ˜¯çš„é¡µé¢ï¼ˆå¦‚æœç´¢å¼•æ“ã€ç¤¾äº¤ç½‘ç«™ç­‰ï¼‰
                    val isExcludedSite = url.contains("google.com") || 
                                        url.contains("baidu.com") || 
                                        url.contains("bing.com") ||
                                        url.contains("weibo.com") ||
                                        url.contains("twitter.com") ||
                                        url.contains("facebook.com") ||
                                        url.contains("youtube.com") ||
                                        url.contains("github.com")
                    
                    if (!isExcludedSite && !readerManager.isReaderModeActive()) {
                        Log.d(TAG, "å¼€å§‹æ£€æµ‹æ˜¯å¦ä¸ºç›®å½•é¡µ: $url (å·²æ”¾å®½æ£€æµ‹æ¡ä»¶)")
                        readerManager.detectCatalogPage(tab.webView, url) { isCatalogPage ->
                            runOnUiThread {
                                if (isCatalogPage) {
                                    Log.d(TAG, "âœ… æ£€æµ‹åˆ°ç›®å½•é¡µï¼Œæ˜¾ç¤ºé˜…è¯»æ¨¡å¼æŒ‰é’®: $url")
                                    showReaderModeButtonForCatalog(tab.webView, url)
                                } else {
                                    Log.d(TAG, "ä¸æ˜¯ç›®å½•é¡µï¼Œéšè—é˜…è¯»æ¨¡å¼æŒ‰é’®: $url")
                                    hideReaderModeButtonForCatalog()
                                }
                            }
                        }
                    } else {
                        if (isExcludedSite) {
                            Log.d(TAG, "æ’é™¤çš„ç½‘ç«™ç±»å‹ï¼Œè·³è¿‡æ£€æµ‹: $url")
                        } else {
                            Log.d(TAG, "å·²å¤„äºé˜…è¯»æ¨¡å¼ï¼Œè·³è¿‡æ£€æµ‹: $url")
                        }
                        hideReaderModeButtonForCatalog()
                    }
                }
            } else {
                // åŠŸèƒ½ä¸»é¡µæˆ–å…¶ä»–ç‰¹æ®Šé¡µé¢ï¼Œéšè—æŒ‰é’®
                hideReaderModeButtonForCatalog()
            }
        }
        
        // é¡µé¢æ ‡é¢˜å˜åŒ–æ—¶ï¼Œä¼˜å…ˆç”¨æ ‡é¢˜å¡«å……æœç´¢æ¡†
        paperStackWebViewManager?.setOnTitleReceivedListener { tab, title ->
            try {
                // åŠŸèƒ½ä¸»é¡µæ˜¾ç¤ºç©ºå­—ç¬¦ä¸²
                if (tab.url == "home://functional") {
                    browserSearchInput.setText("")
                } else {
                    val text = if (!title.isNullOrBlank()) title!! else tab.url
                    browserSearchInput.setText(text)
                }
                updateBrowserFaviconButtonForUrl(tab.url)
            } catch (e: Exception) {
                Log.w(TAG, "æ›´æ–°åœ°å€æ æ ‡é¢˜å¤±è´¥", e)
            }
        }

        // è®¾ç½®é¡µé¢å˜åŒ–ç›‘å¬å™¨ï¼ˆä¿ç•™åŸæœ‰çš„gestureCardWebViewManagerç›‘å¬å™¨ä»¥å…¼å®¹å…¶ä»–åŠŸèƒ½ï¼‰
        gestureCardWebViewManager?.setOnPageChangeListener(object : GestureCardWebViewManager.OnPageChangeListener {
            override fun onCardAdded(cardData: GestureCardWebViewManager.WebViewCardData, position: Int) {
                // éšè—ä¸»é¡µå†…å®¹ï¼Œæ˜¾ç¤ºå…¨å±å¡ç‰‡ç•Œé¢
                browserHomeContent.visibility = View.GONE
                browserTabContainer.visibility = View.GONE

                // å…³é”®ä¿®å¤ï¼šç¡®ä¿ViewPager2å¯è§
                showViewPager2()

                // æ›´æ–°æœç´¢tabå¾½æ ‡
                updateSearchTabBadge()
                // æ›´æ–°é¡µé¢æ•°å­—
                updatePageCountDisplay()

                // åŒæ­¥æ‰€æœ‰å¡ç‰‡ç³»ç»Ÿæ•°æ®
                syncAllCardSystems()

                Log.d(TAG, "æ·»åŠ å¡ç‰‡: ${cardData.title}ï¼ŒViewPager2å·²æ˜¾ç¤ºï¼Œæ•°æ®å·²åŒæ­¥")
            }

            override fun onCardRemoved(cardData: GestureCardWebViewManager.WebViewCardData, position: Int) {
                // å¦‚æœæ²¡æœ‰å¡ç‰‡äº†ï¼Œè¿”å›æœç´¢tabä¸»é¡µ
                if (gestureCardWebViewManager?.getAllCards()?.isEmpty() == true) {
                    // ç¡®ä¿åˆ‡æ¢åˆ°æœç´¢tab
                    switchToSearchTab()
                    // æ˜¾ç¤ºæœç´¢tabä¸»é¡µ
                    showBrowserHome()
                    Log.d(TAG, "æœ€åä¸€ä¸ªå¡ç‰‡å·²å…³é—­ï¼Œè¿”å›æœç´¢tabä¸»é¡µ")
                }

                // æ›´æ–°æœç´¢tabå¾½æ ‡
                updateSearchTabBadge()
                // æ›´æ–°é¡µé¢æ•°å­—
                updatePageCountDisplay()

                // åŒæ­¥æ‰€æœ‰å¡ç‰‡ç³»ç»Ÿæ•°æ®
                syncAllCardSystems()

                Log.d(TAG, "ç§»é™¤å¡ç‰‡: ${cardData.title}")
            }

            override fun onCardSwitched(cardData: GestureCardWebViewManager.WebViewCardData, position: Int) {
                // æ›´æ–°æœç´¢æ¡†URLä¸ç«™ç‚¹å›¾æ ‡
                // ğŸ”§ ä¿®å¤ï¼šå¦‚æœæ˜¯åŠŸèƒ½ä¸»é¡µï¼Œæ˜¾ç¤º"é¦–é¡µ"è€Œä¸æ˜¯URL
                val displayText = if (cardData.url == "home://functional" || cardData.url == "file:///android_asset/functional_home.html") {
                    "é¦–é¡µ"
                } else {
                    cardData.url
                }
                browserSearchInput.setText(displayText)
                updateBrowserFaviconButtonForUrl(cardData.url)

                Log.d(TAG, "åˆ‡æ¢åˆ°å¡ç‰‡: ${cardData.title}")
            }

            override fun onPreviewModeChanged(isPreview: Boolean) {
                // é¢„è§ˆæ¨¡å¼å˜åŒ–
                Log.d(TAG, "é¢„è§ˆæ¨¡å¼å˜åŒ–: $isPreview")
            }

            override fun onPageTitleChanged(cardData: GestureCardWebViewManager.WebViewCardData, title: String) {
                // ä¼˜å…ˆä»¥æ ‡é¢˜æ›´æ–°åœ°å€æ ï¼Œç©ºåˆ™å›é€€åˆ°URL
                try {
                    // ğŸ”§ ä¿®å¤ï¼šå¦‚æœæ˜¯åŠŸèƒ½ä¸»é¡µï¼Œæ˜¾ç¤º"é¦–é¡µ"è€Œä¸æ˜¯URLæˆ–æ ‡é¢˜
                    val text = if (cardData.url == "home://functional" || cardData.url == "file:///android_asset/functional_home.html") {
                        "é¦–é¡µ"
                    } else if (!title.isNullOrBlank()) {
                        title
                    } else {
                        cardData.url
                    }
                    browserSearchInput.setText(text)
                } catch (_: Exception) {}
                Log.d(TAG, "å¡ç‰‡æ ‡é¢˜å˜åŒ–: $title")
            }

            override fun onPageLoadingStateChanged(cardData: GestureCardWebViewManager.WebViewCardData, isLoading: Boolean) {
                // é¡µé¢åŠ è½½çŠ¶æ€å˜åŒ–æ—¶ï¼ŒåŒæ­¥åœ°å€æ ä¸ç«™ç‚¹å›¾æ ‡
                // ğŸ”§ ä¿®å¤ï¼šå¦‚æœæ˜¯åŠŸèƒ½ä¸»é¡µï¼Œæ˜¾ç¤º"é¦–é¡µ"è€Œä¸æ˜¯URL
                val displayText = if (cardData.url == "home://functional" || cardData.url == "file:///android_asset/functional_home.html") {
                    "é¦–é¡µ"
                } else {
                    cardData.url
                }
                browserSearchInput.setText(displayText)
                updateBrowserFaviconButtonForUrl(cardData.url)

                // é¡µé¢åŠ è½½å®Œæˆåæ³¨å…¥è§†é¢‘æ£€æµ‹è„šæœ¬ï¼›åŠ è½½ä¸­åˆ™æ”¶èµ·æ‚¬æµ®æ’­æ”¾å™¨
                if (!isLoading) {
                    cardData.webView?.let { webView ->
                        injectVideoHookToWebView(webView)
                    }
                } else {
                    if (::floatingVideoManager.isInitialized && floatingVideoManager.isShowing()) {
                        floatingVideoManager.hide()
                    }
                    if (::systemOverlayVideoManager.isInitialized && systemOverlayVideoManager.isShowing()) {
                        systemOverlayVideoManager.hide()
                    }
                }

                Log.d(TAG, "å¡ç‰‡åŠ è½½çŠ¶æ€å˜åŒ–: ${cardData.title} - $isLoading")
            }



            override fun onSwipePreviewStarted(cards: List<GestureCardWebViewManager.WebViewCardData>, currentIndex: Int) {
                // æ˜¾ç¤ºæ¨ªæ»‘é¢„è§ˆæŒ‡ç¤ºå™¨
                showSwipePreviewIndicator(cards, currentIndex)
                Log.d(TAG, "å¼€å§‹æ¨ªæ»‘é¢„è§ˆï¼Œå½“å‰ç´¢å¼•: $currentIndexï¼Œæ€»å¡ç‰‡æ•°: ${cards.size}")
            }

            override fun onSwipePreviewUpdated(position: Int, positionOffset: Float) {
                // æ›´æ–°æ¨ªæ»‘é¢„è§ˆæŒ‡ç¤ºå™¨ä½ç½®
                updateSwipePreviewIndicator(position, positionOffset)
            }

            override fun onSwipePreviewEnded() {
                // éšè—æ¨ªæ»‘é¢„è§ˆæŒ‡ç¤ºå™¨
                hideSwipePreviewIndicator()
                Log.d(TAG, "ç»“æŸæ¨ªæ»‘é¢„è§ˆ")
            }

            override fun onGoHome() {
                // è¿”å›ç®€æ˜“æ¨¡å¼æœç´¢tabé¦–é¡µ
                showBrowser() // æ˜¾ç¤ºæµè§ˆå™¨ç•Œé¢
                showBrowserHome() // æ˜¾ç¤ºæµè§ˆå™¨ä¸»é¡µå†…å®¹

                // åˆ‡æ¢åˆ°æœç´¢tab
                findViewById<LinearLayout>(R.id.tab_search)?.performClick()

                Log.d(TAG, "è¿”å›ç®€æ˜“æ¨¡å¼æœç´¢tabé¦–é¡µ")
            }

            override fun onPageRefresh() {
                // åˆ·æ–°æ—¶çš„åœ°å€æ æ»šåŠ¨åŠ¨ç”»
                showAddressBarRefreshAnimation()
                Log.d(TAG, "é¡µé¢åˆ·æ–°")
            }

            override fun onAllCardsRemoved() {
                // æ‰€æœ‰å¡ç‰‡éƒ½è¢«å…³é—­ï¼Œæ˜¾ç¤ºæµè§ˆå™¨é¦–é¡µ
                Log.d(TAG, "æ‰€æœ‰å¡ç‰‡å·²å…³é—­ï¼Œæ˜¾ç¤ºæµè§ˆå™¨é¦–é¡µ")
                showBrowserHome()

                // éšè—æ‚¬æµ®å¡ç‰‡é¢„è§ˆ
                stackedCardPreview?.visibility = View.GONE

                // æ›´æ–°æœç´¢tabå¾½æ ‡
                updateSearchTabBadge()
                // æ›´æ–°é¡µé¢æ•°å­—
                updatePageCountDisplay()

                // æ˜¾ç¤ºæç¤ºä¿¡æ¯
                Toast.makeText(this@SimpleModeActivity, "æ‰€æœ‰æ ‡ç­¾é¡µå·²å…³é—­", Toast.LENGTH_SHORT).show()
            }

            override fun onScroll(dy: Int) {
                // å¤„ç†å¡ç‰‡æ»šåŠ¨äº‹ä»¶ï¼Œå¯ä»¥åœ¨è¿™é‡Œå®ç°æ»šåŠ¨ç›¸å…³çš„UIæ›´æ–°
                // ä¾‹å¦‚ï¼šæ ¹æ®æ»šåŠ¨æ–¹å‘æ˜¾ç¤º/éšè—å·¥å…·æ ç­‰
                // å½“å‰æš‚æ—¶ä¸å¤„ç†ï¼Œä¿æŒç©ºå®ç°
            }
        })

        // å¡ç‰‡å¼æµè§ˆå™¨ä¸éœ€è¦æ ‡ç­¾æ ï¼Œç§»é™¤ç›¸å…³ç›‘å¬å™¨

        // è®¾ç½®æœç´¢æ¡†ç›‘å¬å™¨
        browserSearchInput.setOnEditorActionListener { _, actionId, _ ->
            if (actionId == EditorInfo.IME_ACTION_SEARCH) {
                performBrowserSearch()
                true
            } else {
                false
            }
        }

        // è®¾ç½®æ¸…ç©ºæŒ‰é’®
        val browserBtnClear = findViewById<ImageButton>(R.id.browser_btn_clear)
        browserBtnClear?.setOnClickListener {
            browserSearchInput.setText("")
            browserBtnClear.visibility = View.GONE
            showMaterialToast("æœç´¢æ¡†å·²æ¸…ç©º")
        }

        // è®¾ç½®AIåŠ©æ‰‹æŒ‰é’®ç‚¹å‡»ç›‘å¬
        browserBtnAi?.setOnClickListener {
            Log.d(TAG, "ç®€æ˜“æ¨¡å¼AIåŠ©æ‰‹æŒ‰é’®è¢«ç‚¹å‡»")
            showBrowserTabAIProfileSelector()
        }


        // æ·»åŠ æ–‡æœ¬å˜åŒ–ç›‘å¬å™¨ï¼Œæ£€æµ‹"app"å…³é”®è¯è‡ªåŠ¨åˆ‡æ¢åˆ°åº”ç”¨æœç´¢ï¼Œå¹¶æ§åˆ¶æ¸…ç©ºæŒ‰é’®æ˜¾ç¤º
        browserSearchInput.addTextChangedListener(object : TextWatcher {
            override fun beforeTextChanged(s: CharSequence?, start: Int, count: Int, after: Int) {}
            override fun onTextChanged(s: CharSequence?, start: Int, before: Int, count: Int) {}
            override fun afterTextChanged(s: Editable?) {
                val query = s?.toString()?.trim()?.lowercase() ?: ""

                // æ§åˆ¶æ¸…ç©ºæŒ‰é’®çš„æ˜¾ç¤º/éšè—
                val clearButton = findViewById<ImageButton>(R.id.browser_btn_clear)
                clearButton?.visibility = if (s?.isNotEmpty() == true) View.VISIBLE else View.GONE

                // å½“ç”¨æˆ·è¾“å…¥"app"æ—¶ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°åº”ç”¨æœç´¢ç•Œé¢
                if (query == "app") {
                    Log.d(TAG, "æ£€æµ‹åˆ°ç”¨æˆ·è¾“å…¥'app'ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°åº”ç”¨æœç´¢ç•Œé¢")
                    // å»¶è¿Ÿåˆ‡æ¢ï¼Œé¿å…è¾“å…¥è¿‡ç¨‹ä¸­çš„å¹²æ‰°
                    Handler(Looper.getMainLooper()).postDelayed({
                        if (browserSearchInput.text.toString().trim().lowercase() == "app") {
                            switchToAppSearchWithQuery(null)
                            // æ¸…ç©ºæµè§ˆå™¨æœç´¢æ¡†
                            browserSearchInput.setText("")
                            showMaterialToast("å·²åˆ‡æ¢åˆ°åº”ç”¨æœç´¢")
                        }
                    }, 500) // 500mså»¶è¿Ÿï¼Œç»™ç”¨æˆ·æ—¶é—´å®Œæˆè¾“å…¥
                }
            }
        })

        // è®¾ç½®æ‰‹åŠ¿æ£€æµ‹
        setupBrowserGestureDetector()

        // è®¾ç½®æŒ‰é’®ç›‘å¬å™¨
        setupBrowserButtons()
        
        // ğŸ”§ ä¿®å¤3ï¼šè®¾ç½®æ ‡é¢˜æ ä¸Šæ»‘æ‰‹åŠ¿æ£€æµ‹
        setupToolbarSwipeUpGesture()
        
        // ğŸ”§ ä¿®å¤4ï¼šè®¾ç½®æœç´¢è¾“å…¥æ¡†æ–‡å­—å·¥å…·æ 
        setupSearchInputToolbar()

        // è®¾ç½®å¡ç‰‡é¢„è§ˆæŒ‰é’®å›¾æ ‡
        setupCardPreviewButtonIcon()

        // è®¾ç½®æŠ½å±‰
        setupBrowserDrawer()

        // è®¾ç½®å¿«æ·æ–¹å¼
        setupBrowserShortcuts()

        // åˆå§‹åŒ–æœç´¢å¼•æ“
        initializeBrowserSearchEngine()

        // æœç´¢å¼•æ“é€‰æ‹©å™¨å·²ä»å¸ƒå±€ä¸­åˆ é™¤ï¼Œä¸å†éœ€è¦è®¾ç½®
        // setupBrowserSearchEngineSelector()

        // è®¾ç½®å¡ç‰‡é¢„è§ˆåŠŸèƒ½
        setupCardPreviewFeature()
        
        // æ³¨æ„ï¼šä¸åœ¨è¿™é‡Œè‡ªåŠ¨æ¢å¤å¡ç‰‡çŠ¶æ€ï¼Œè®©ç”¨æˆ·é€šè¿‡å¯¹è¯æ¡†é€‰æ‹©

        // è®¾ç½®æ‰‹åŠ¿æç¤ºåŠŸèƒ½
        setupGestureHintFeature()

        // è®¾ç½®å››åˆ†ä¹‹ä¸€åœ†å¼§æ“ä½œæ 
        setupQuarterArcOperationBar()

        // è®¾ç½®Safarié£æ ¼åŠŸèƒ½
        setupSafariStyleFeatures()

        // è®¾ç½®é•¿æŒ‰èœå•çš„æ–°æ ‡ç­¾é¡µç›‘å¬å™¨
        gestureCardWebViewManager?.let { manager ->
            manager.setOnNewTabListener { url, inBackground ->
                Log.d(TAG, "ğŸ”— é•¿æŒ‰èœå•è¯·æ±‚æ‰“å¼€æ–°æ ‡ç­¾é¡µ: $url (åå°: $inBackground)")
                // åœ¨æ–°å¡ç‰‡ä¸­æ‰“å¼€URL
                manager.addNewCard(url)
            }
        }

        // æ³¨å†Œåˆ°ç»Ÿä¸€WebViewç®¡ç†å™¨
        gestureCardWebViewManager?.let { manager ->
            val adapter = WebViewManagerAdapter(manager, "GestureCardWebViewManager", unifiedWebViewManager)
            unifiedWebViewManager.registerManager(adapter)
            Log.d(TAG, "GestureCardWebViewManagerå·²æ³¨å†Œåˆ°ç»Ÿä¸€WebViewç®¡ç†å™¨")
        }

        // å°†çº¸å †ç®¡ç†å™¨ä¹Ÿæ³¨å†Œåˆ°ç»Ÿä¸€ç®¡ç†å™¨ï¼Œä¾›ç«™ç‚¹ä¿¡æ¯èœå•ä¸å¯¼èˆªä½¿ç”¨
        paperStackWebViewManager?.let { manager ->
            val adapter = WebViewManagerAdapter(manager, "PaperStackWebViewManager", unifiedWebViewManager)
            unifiedWebViewManager.registerManager(adapter)
            Log.d(TAG, "PaperStackWebViewManagerå·²æ³¨å†Œåˆ°ç»Ÿä¸€WebViewç®¡ç†å™¨")
        }

        // åˆå§‹æ˜¾ç¤ºä¸»é¡µå†…å®¹
        showBrowserHome()
    }

    /**
     * è®¾ç½®Safarié£æ ¼åŠŸèƒ½
     */
    private fun setupSafariStyleFeatures() {
        try {
            Log.d(TAG, "å¼€å§‹è®¾ç½®Safarié£æ ¼åŠŸèƒ½")

            // è®¾ç½®ä¸‹æ‹‰åˆ·æ–°
            setupPullToRefresh()

            // è®¾ç½®å·¥å…·æ è‡ªåŠ¨éšè—
            setupToolbarAutoHide()

            // è®¾ç½®æœç´¢æ¡†æŒ‰é’®åŠŸèƒ½
            setupSearchInputButtons()
            
            // è®¾ç½®è¾“å…¥æ³•ç›‘å¬ï¼Œæ˜¾ç¤ºæ–‡æœ¬å·¥å…·æ 
            setupInputMethodListener()

            Log.d(TAG, "Safarié£æ ¼åŠŸèƒ½è®¾ç½®å®Œæˆ")

        } catch (e: Exception) {
            Log.e(TAG, "è®¾ç½®Safarié£æ ¼åŠŸèƒ½å¤±è´¥", e)
        }
    }
    
    /**
     * è®¾ç½®è¾“å…¥æ³•ç›‘å¬ï¼Œå½“è¾“å…¥æ³•æ˜¾ç¤ºæ—¶æ˜¾ç¤ºæ–‡æœ¬å·¥å…·æ 
     */
    private fun setupInputMethodListener() {
        try {
            val rootView = window.decorView.rootView
            rootView.viewTreeObserver.addOnGlobalLayoutListener {
                val rect = android.graphics.Rect()
                rootView.getWindowVisibleDisplayFrame(rect)
                val screenHeight = rootView.height
                val keypadHeight = screenHeight - rect.bottom
                
                // ğŸ”§ ä¼˜åŒ–ï¼šé™ä½é˜ˆå€¼ï¼Œç¡®ä¿è¾“å…¥æ³•æ¿€æ´»æ—¶ä¸€å®šèƒ½æ£€æµ‹åˆ°ï¼ˆä»15%é™åˆ°10%ï¼‰
                val keyboardVisible = keypadHeight > screenHeight * 0.10
                
                // åªåœ¨æœç´¢tabä¸­å¤„ç†
                if (currentState == UIState.BROWSER) {
                    // ğŸ”§ ä¿®å¤ï¼šæ— è®ºè¾“å…¥æ³•æ˜¾ç¤ºæˆ–éšè—ï¼Œéƒ½æ›´æ–°æ–‡æœ¬å·¥å…·æ å¯è§æ€§
                    // updateSearchInputToolbarVisibility å†…éƒ¨ä¼šæ£€æŸ¥è¾“å…¥æ¡†ç„¦ç‚¹å’Œè¾“å…¥æ³•çŠ¶æ€
                    updateSearchInputToolbarVisibility()
                    if (keyboardVisible) {
                        Log.d(TAG, "è¾“å…¥æ³•æ˜¾ç¤ºï¼Œæ›´æ–°æ–‡æœ¬å·¥å…·æ ")
                    } else {
                        Log.d(TAG, "è¾“å…¥æ³•éšè—ï¼Œæ›´æ–°æ–‡æœ¬å·¥å…·æ ")
                    }
                }
            }
            
            Log.d(TAG, "è¾“å…¥æ³•ç›‘å¬è®¾ç½®å®Œæˆ")
        } catch (e: Exception) {
            Log.e(TAG, "è®¾ç½®è¾“å…¥æ³•ç›‘å¬å¤±è´¥", e)
        }
    }

    /**
     * è®¾ç½®ä¸‹æ‹‰åˆ·æ–°åŠŸèƒ½
     */
    private fun setupPullToRefresh() {
        try {
            // ç¦ç”¨ä¸‹æ‹‰åˆ·æ–°ç›‘å¬å™¨ï¼Œä¸æ‰§è¡Œåˆ·æ–°é€»è¾‘
            browserSwipeRefresh.setOnRefreshListener(null)
            
            // è®¾ç½®ä¸€ä¸ªå¾ˆå¤§çš„è§¦å‘è·ç¦»ï¼Œè®©åˆ·æ–°å‡ ä¹ä¸å¯èƒ½è§¦å‘
            // è¿™æ ·å³ä½¿SwipeRefreshLayoutæ£€æµ‹åˆ°ä¸‹æ‹‰ï¼Œä¹Ÿä¸ä¼šè§¦å‘åˆ·æ–°åŠ¨ç”»
            val screenHeight = resources.displayMetrics.heightPixels
            browserSwipeRefresh.setDistanceToTriggerSync(screenHeight * 2)
            
            // ä¿æŒæ­£å¸¸çš„æ»šåŠ¨æ£€æµ‹é€»è¾‘ï¼Œå…è®¸åœ¨é¡µé¢é¡¶éƒ¨æ—¶æ£€æµ‹ä¸‹æ‹‰æ‰‹åŠ¿
            // è¿™æ ·è§¦æ‘¸äº‹ä»¶æ‰èƒ½æ­£å¸¸ä¼ é€’ï¼Œæˆ‘ä»¬çš„è§¦æ‘¸ç›‘å¬å™¨æ‰èƒ½å·¥ä½œ
            browserSwipeRefresh.setOnChildScrollUpCallback { parent, child ->
                // æ£€æŸ¥å½“å‰WebViewæ˜¯å¦å¯ä»¥å‘ä¸Šæ»šåŠ¨
                val currentWebView = getCurrentWebViewForScrollCheck()
                val canScrollUp = currentWebView?.canScrollVertically(-1) ?: false
                // å¦‚æœå¯ä»¥å‘ä¸Šæ»šåŠ¨ï¼Œè¯´æ˜ä¸åœ¨é¡µé¢é¡¶éƒ¨ï¼Œé˜»æ­¢ä¸‹æ‹‰æ£€æµ‹
                // å¦‚æœä¸èƒ½å‘ä¸Šæ»šåŠ¨ï¼Œè¯´æ˜åœ¨é¡µé¢é¡¶éƒ¨ï¼Œå…è®¸ä¸‹æ‹‰æ£€æµ‹ï¼ˆä½†ä¸ä¼šè§¦å‘åˆ·æ–°ï¼Œå› ä¸ºè·ç¦»é˜ˆå€¼å¾ˆå¤§ï¼‰
                canScrollUp
            }

            // è®¾ç½®ä¸‹æ‹‰å·¥å…·æ çš„è§¦æ‘¸æ£€æµ‹
            setupPullDownToolbarDetection()
            
            // è®¾ç½®ä¸‹æ‹‰å·¥å…·æ æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            setupPullDownToolbarButtons()

            Log.d(TAG, "ä¸‹æ‹‰å·¥å…·æ åŠŸèƒ½è®¾ç½®å®Œæˆ")

        } catch (e: Exception) {
            Log.e(TAG, "è®¾ç½®ä¸‹æ‹‰å·¥å…·æ åŠŸèƒ½å¤±è´¥", e)
        }
    }
    
    /**
     * è®¾ç½®ä¸‹æ‹‰å·¥å…·æ çš„è§¦æ‘¸æ£€æµ‹
     */
    private fun setupPullDownToolbarDetection() {
        var startY = 0f
        var startX = 0f
        var isDragging = false
        var isSelecting = false // æ˜¯å¦æ­£åœ¨é€‰æ‹©å›¾æ ‡
        var hasPulledUp = false // æ˜¯å¦ä¸Šæ»‘è¿‡ï¼ˆç”¨äºåˆ¤æ–­æ˜¯å¦åº”è¯¥æ‰§è¡Œå‘½ä»¤ï¼‰
        var maxPullDownY = 0f // è®°å½•æœ€å¤§ä¸‹æ‹‰è·ç¦»
        var menuShowY = 0f // è®°å½•èœå•æ˜¾ç¤ºæ—¶çš„Yåæ ‡
        var menuInitialY = 0f // è®°å½•èœå•åˆå§‹Yä½ç½®ï¼ˆç”¨äºæ»‘åŠ¨åŠ¨ç”»ï¼‰
        var velocityTracker: android.view.VelocityTracker? = null // é€Ÿåº¦è·Ÿè¸ªå™¨
        // ğŸ”§ å‚è€ƒChromeç§»åŠ¨ç«¯ä¼˜åŒ–é˜ˆå€¼ï¼Œå‡å°‘æŠ–åŠ¨
        val pullThreshold = 70f // ä¸‹æ‹‰é˜ˆå€¼ï¼ˆChromeçº¦60-80pxï¼‰ï¼Œé™ä½é˜ˆå€¼ä½¿å“åº”æ›´çµæ•
        val pullUpThreshold = 50f // ä¸Šæ‹‰éšè—é˜ˆå€¼ï¼Œé™ä½é˜ˆå€¼ä½¿å“åº”æ›´çµæ•
        val velocityThreshold = 1000f // é€Ÿåº¦é˜ˆå€¼ï¼ˆpx/sï¼‰ï¼Œå¿«é€Ÿæ»‘åŠ¨æ—¶é™ä½è§¦å‘é˜ˆå€¼
        val followCoefficient = 0.85f // ğŸ”§ ä¼˜åŒ–ï¼šé™ä½è·Ÿéšç³»æ•°ï¼Œå‡å°‘æŠ–åŠ¨ï¼Œä½¿èœå•ç§»åŠ¨æ›´å¹³æ»‘
        
        // ä½¿ç”¨è‡ªå®šä¹‰çš„è§¦æ‘¸ç›‘å¬å™¨ï¼Œæ£€æµ‹ä¸‹æ‹‰æ‰‹åŠ¿å¹¶æ˜¾ç¤ºå·¥å…·æ 
        browserSwipeRefresh.setOnTouchListener { view, event ->
            // ğŸ”§ å¦‚æœå¤„äºé˜…è¯»æ¨¡å¼2ï¼Œç¦ç”¨ä¸‹æ‹‰å·¥å…·æ æ£€æµ‹
            val readerManager2 = com.example.aifloatingball.reader.NovelReaderManager.getInstance(this)
            if (readerManager2.isReaderModeActive) {
                return@setOnTouchListener false // ä¸æ‹¦æˆªè§¦æ‘¸äº‹ä»¶ï¼Œè®©ScrollViewå¤„ç†
            }
            
            // ğŸ”§ å¦‚æœä¸‹æ‹‰å·¥å…·æ æ£€æµ‹è¢«ç¦ç”¨ï¼Œä¸å¤„ç†
            if (!isPullDownToolbarDetectionEnabled) {
                return@setOnTouchListener false
            }
            
            when (event.action) {
                android.view.MotionEvent.ACTION_DOWN -> {
                    startY = event.y
                    startX = event.x
                    isDragging = false
                    isSelecting = false
                    hasPulledUp = false // é‡ç½®ä¸Šæ»‘æ ‡è®°
                    selectedButtonIndex = -1
                    maxPullDownY = 0f
                    // åˆå§‹åŒ–é€Ÿåº¦è·Ÿè¸ªå™¨
                    velocityTracker = android.view.VelocityTracker.obtain()
                    velocityTracker?.addMovement(event)
                    // å¦‚æœèœå•å·²ç»æ˜¾ç¤ºï¼Œè®°å½•å½“å‰Yåæ ‡ä½œä¸ºåŸºå‡†ï¼ˆç”¨äºè®¡ç®—ç›¸å¯¹æ»‘åŠ¨ï¼‰
                    if (isPullDownToolbarVisible) {
                        menuShowY = event.y
                    } else {
                        menuShowY = 0f
                    }
                }
                android.view.MotionEvent.ACTION_MOVE -> {
                    val deltaY = event.y - startY
                    val deltaX = event.x - startX
                    
                    // æ›´æ–°é€Ÿåº¦è·Ÿè¸ªå™¨
                    velocityTracker?.addMovement(event)
                    
                    // å¦‚æœå·¥å…·æ å·²ç»æ˜¾ç¤ºï¼Œæ£€æµ‹å‚ç›´ä½ç½®é€‰æ‹©å›¾æ ‡æˆ–ä¸Šæ‹‰/ä¸‹æ»‘è°ƒæ•´ä½ç½®
                    if (isPullDownToolbarVisible) {
                        // ğŸ”§ å…³é”®ä¿®å¤ï¼šç«‹å³å–æ¶ˆæ‰€æœ‰è‡ªåŠ¨åŠ¨ç”»ï¼Œç¡®ä¿èœå•ä¸¥æ ¼è·Ÿéšæ‰‹æŒ‡
                        pullDownAnimation?.cancel()
                        
                        // è®¡ç®—ç›¸å¯¹äºèœå•æ˜¾ç¤ºæ—¶çš„æ»‘åŠ¨è·ç¦»
                        val relativeY = event.y - menuShowY
                        
                        // ğŸ”§ ä¿®å¤1ï¼šå¦‚æœç”¨æˆ·æ­£åœ¨å·¦å³æ»‘åŠ¨é€‰æ‹©å›¾æ ‡ï¼Œèœå•å’Œå›¾æ ‡å¿…é¡»ä¿æŒå®Œå…¨ä¸é€æ˜
                        val isHorizontalSwipe = kotlin.math.abs(deltaX) > kotlin.math.abs(relativeY) * 0.5f
                        
                        // ğŸ”§ è®¡ç®—æ»‘åŠ¨é€Ÿåº¦ï¼Œç”¨äºåŠ¨æ€è°ƒæ•´é˜ˆå€¼
                        val velocity = velocityTracker?.let {
                            it.computeCurrentVelocity(1000)
                            kotlin.math.abs(it.yVelocity)
                        } ?: 0f
                        
                        // ğŸ”§ ä¿®å¤2ï¼šå°†æ·¡å…¥æ·¡å‡ºåŠ¨ç”»æ”¹ä¸ºä¸Šæ»‘ä¸‹æ»‘åŠ¨ç”»ï¼Œèœå•è·Ÿéšæ‰‹æŒ‡ç§»åŠ¨
                        // è®¡ç®—èœå•åº”è¯¥ç§»åŠ¨åˆ°çš„ä½ç½®ï¼ˆåŸºäºä¸‹æ‹‰è·ç¦»ï¼‰
                        // ç¡®ä¿èœå•å·²ç»æµ‹é‡ï¼Œå¦‚æœé«˜åº¦ä¸º0åˆ™ä½¿ç”¨é»˜è®¤å€¼
                        val menuHeight = if (browserPullDownToolbar.height > 0) {
                            browserPullDownToolbar.height.toFloat()
                        } else {
                            browserPullDownToolbar.measure(0, 0)
                            browserPullDownToolbar.measuredHeight.toFloat().coerceAtLeast(100f)
                        }
                        
                        // ğŸ”§ å…³é”®ä¿®å¤ï¼šèœå•ä¸¥æ ¼è·Ÿéšæ‰‹æŒ‡ï¼Œä¸ä½¿ç”¨å¹³æ»‘è¿‡æ¸¡ï¼Œé¿å…å»¶è¿Ÿå’Œè·³å›
                        if (relativeY < -pullUpThreshold) {
                            // ç”¨æˆ·ä¸Šæ»‘ï¼šèœå•å‘ä¸Šç§»åŠ¨å¹¶å½»åº•æ»‘å‡ºå±å¹•
                            hasPulledUp = true
                            val pullUpDistance = -relativeY - pullUpThreshold
                            val maxPullDown = maxPullDownY.coerceAtLeast(pullThreshold)
                            
                            // ğŸ”§ ç›´æ¥è®¡ç®—ä½ç½®ï¼Œä¸¥æ ¼è·Ÿéšæ‰‹æŒ‡ï¼Œä¸å»¶è¿Ÿ
                            val translationY = -kotlin.math.min(pullUpDistance * followCoefficient, menuHeight * 1.2f)
                            browserPullDownToolbar.translationY = translationY
                            
                            // åªæœ‰åœ¨ä¸æ˜¯æ°´å¹³æ»‘åŠ¨æ—¶æ‰è°ƒæ•´alphaï¼ˆé¿å…é€‰æ‹©å›¾æ ‡æ—¶å˜é€æ˜ï¼‰
                            if (!isHorizontalSwipe && !isSelecting) {
                                // ğŸ”§ ä¼˜åŒ–ï¼šæ ¹æ®é€Ÿåº¦åŠ¨æ€è°ƒæ•´alphaè¡°å‡ï¼Œå¿«é€Ÿæ»‘åŠ¨æ—¶æ›´å¿«æ¶ˆå¤±
                                val alphaDecayFactor = if (velocity > velocityThreshold) 0.5f else 0.6f
                                val alpha = (1f - (pullUpDistance / (maxPullDown * alphaDecayFactor)).coerceIn(0f, 1f)).coerceIn(0f, 1f)
                                browserPullDownToolbar.alpha = alpha
                                pullDownIndicator.alpha = alpha
                                
                                // ğŸ”§ ä¿®å¤ï¼šå½“alphaå¾ˆä½æ—¶ï¼Œä½¿ç”¨INVISIBLEè€Œä¸æ˜¯GONEï¼Œé¿å…å†æ¬¡é—ªç°
                                if (alpha <= 0.05f) {
                                    browserPullDownToolbar.alpha = 0f
                                    pullDownIndicator.alpha = 0f
                                    pullDownIndicator.visibility = View.GONE
                                    // åªæœ‰åœ¨å®Œå…¨æ»‘å‡ºå±å¹•æ—¶æ‰è®¾ç½®ä¸ºINVISIBLEï¼Œé¿å…é—ªç°
                                    if (translationY <= -menuHeight * 0.9f) {
                                        browserPullDownToolbar.visibility = View.INVISIBLE
                                    }
                                } else {
                                    // ç¡®ä¿èœå•å¯è§æ€§æ­£ç¡®
                                    if (browserPullDownToolbar.visibility != View.VISIBLE) {
                                        browserPullDownToolbar.visibility = View.VISIBLE
                                        // ğŸ”§ ä¿®å¤ï¼šç¡®ä¿ä¸‹æ‹‰å·¥å…·æ åœ¨æœ€ä¸Šå±‚ï¼Œä¸è¢«webviewé®æŒ¡
                                        browserPullDownToolbar.bringToFront()
                                    }
                                }
                            } else {
                                // æ°´å¹³æ»‘åŠ¨æˆ–æ­£åœ¨é€‰æ‹©æ—¶ï¼Œä¿æŒå®Œå…¨ä¸é€æ˜
                                browserPullDownToolbar.alpha = 1f
                                pullDownIndicator.alpha = 1f
                                // ç¡®ä¿èœå•å¯è§æ€§æ­£ç¡®
                                if (browserPullDownToolbar.visibility != View.VISIBLE) {
                                    browserPullDownToolbar.visibility = View.VISIBLE
                                    // ğŸ”§ ä¿®å¤ï¼šç¡®ä¿ä¸‹æ‹‰å·¥å…·æ åœ¨æœ€ä¸Šå±‚ï¼Œä¸è¢«webviewé®æŒ¡
                                    browserPullDownToolbar.bringToFront()
                                }
                            }
                        } 
                        else if (relativeY > pullUpThreshold) {
                            // ç”¨æˆ·ä¸‹æ»‘ï¼šèœå•å‘ä¸‹ç§»åŠ¨å¹¶é€æ¸æ˜¾ç¤º
                            if (hasPulledUp) {
                                hasPulledUp = false
                            }
                            val pullDownDistance = relativeY - pullUpThreshold
                            val maxPullDown = maxPullDownY.coerceAtLeast(pullThreshold)
                            
                            // ğŸ”§ ç›´æ¥è®¡ç®—ä½ç½®ï¼Œä¸¥æ ¼è·Ÿéšæ‰‹æŒ‡ï¼Œä¸å»¶è¿Ÿ
                            // ä¸‹æ‹‰æ—¶ï¼Œèœå•ä»é¡¶éƒ¨å‘ä¸‹ç§»åŠ¨ï¼Œè·Ÿéšæ‰‹æŒ‡ä½ç½®
                            // ğŸ”§ ä¿®å¤ï¼šä¸‹æ‹‰å¹…åº¦ä¸è¶…è¿‡èœå•æ€»é«˜åº¦ï¼ˆtranslationYèŒƒå›´ï¼š-menuHeightåˆ°0ï¼‰
                            val translationY = (-menuHeight + pullDownDistance * followCoefficient).coerceIn(-menuHeight, 0f)
                            browserPullDownToolbar.translationY = translationY
                            
                            // ğŸ”§ ä¿®å¤ï¼šç¡®ä¿èœå•å¯è§æ€§æ­£ç¡®ï¼Œé¿å…é—ªç°
                            // åªæœ‰åœ¨èœå•éœ€è¦æ˜¾ç¤ºæ—¶æ‰è®¾ç½®ä¸ºVISIBLE
                            if (browserPullDownToolbar.visibility != View.VISIBLE && translationY > -menuHeight * 0.9f) {
                                browserPullDownToolbar.visibility = View.VISIBLE
                                // ğŸ”§ ä¿®å¤ï¼šç¡®ä¿ä¸‹æ‹‰å·¥å…·æ åœ¨æœ€ä¸Šå±‚ï¼Œä¸è¢«webviewé®æŒ¡
                                browserPullDownToolbar.bringToFront()
                            }
                            
                            // åªæœ‰åœ¨ä¸æ˜¯æ°´å¹³æ»‘åŠ¨æ—¶æ‰è°ƒæ•´alpha
                            if (!isHorizontalSwipe && !isSelecting) {
                                // ğŸ”§ ä¼˜åŒ–ï¼šæ ¹æ®é€Ÿåº¦åŠ¨æ€è°ƒæ•´alphaå¢é•¿ï¼Œå¿«é€Ÿæ»‘åŠ¨æ—¶æ›´å¿«æ˜¾ç¤º
                                val alphaGrowthFactor = if (velocity > velocityThreshold) 0.5f else 0.6f
                                val alpha = ((pullDownDistance / (maxPullDown * alphaGrowthFactor)).coerceIn(0f, 1f)).coerceIn(0f, 1f)
                                browserPullDownToolbar.alpha = alpha
                                if (alpha > 0.1f && pullDownIndicator.visibility != View.VISIBLE) {
                                    pullDownIndicator.visibility = View.VISIBLE
                                }
                                pullDownIndicator.alpha = alpha
                            } else {
                                // æ°´å¹³æ»‘åŠ¨æˆ–æ­£åœ¨é€‰æ‹©æ—¶ï¼Œä¿æŒå®Œå…¨ä¸é€æ˜
                                browserPullDownToolbar.alpha = 1f
                                pullDownIndicator.alpha = 1f
                            }
                        }
                        else {
                        // ğŸ”§ ä¼˜åŒ–ï¼šæ»‘åŠ¨è·ç¦»åœ¨æ­»åŒºå†…ï¼Œå¹³æ»‘è¿‡æ¸¡åˆ°ç¨³å®šä½ç½®ï¼Œé¿å…è·³å›
                        // æ­»åŒºå†…å¹³æ»‘è¿‡æ¸¡åˆ°å®Œå…¨æ˜¾ç¤ºä½ç½®ï¼ˆtranslationY = 0ï¼‰ï¼Œè€Œä¸æ˜¯ä¿æŒä¸åŠ¨
                        val currentTranslationY = browserPullDownToolbar.translationY
                        val targetTranslationY = 0f // ç›®æ ‡ä½ç½®æ˜¯èœå•å®Œå…¨æ˜¾ç¤º
                        // ğŸ”§ ä¼˜åŒ–ï¼šä½¿ç”¨æ›´å¹³æ»‘çš„è¿‡æ¸¡ç³»æ•°ï¼Œå‡å°‘æŠ–åŠ¨
                        val smoothFactor = 0.2f // é™ä½ç³»æ•°ï¼Œä½¿è¿‡æ¸¡æ›´å¹³æ»‘ï¼Œå‡å°‘æŠ–åŠ¨
                        val translationY = currentTranslationY + (targetTranslationY - currentTranslationY) * smoothFactor
                        browserPullDownToolbar.translationY = translationY
                        
                        // ğŸ”§ ä¿®å¤ï¼šç¡®ä¿èœå•å¯è§æ€§æ­£ç¡®
                        if (browserPullDownToolbar.visibility != View.VISIBLE) {
                            browserPullDownToolbar.visibility = View.VISIBLE
                            // ğŸ”§ ä¿®å¤ï¼šç¡®ä¿ä¸‹æ‹‰å·¥å…·æ åœ¨æœ€ä¸Šå±‚ï¼Œä¸è¢«webviewé®æŒ¡
                            browserPullDownToolbar.bringToFront()
                        }
                        
                        // å¦‚æœæ˜¯æ°´å¹³æ»‘åŠ¨ï¼Œç¡®ä¿å®Œå…¨ä¸é€æ˜
                        if (isHorizontalSwipe || isSelecting) {
                            browserPullDownToolbar.alpha = 1f
                            pullDownIndicator.alpha = 1f
                        } else {
                            // ğŸ”§ ä¼˜åŒ–ï¼šåœ¨æ­»åŒºå†…ï¼Œæ ¹æ®ä½ç½®å¹³æ»‘è°ƒæ•´alphaï¼Œé¿å…çªç„¶å˜åŒ–
                            val alphaProgress = 1f - (kotlin.math.abs(translationY) / menuHeight).coerceIn(0f, 1f)
                            val targetAlpha = alphaProgress.coerceIn(0.8f, 1f) // æ­»åŒºå†…ä¿æŒ80%-100%é€æ˜åº¦
                            browserPullDownToolbar.alpha = browserPullDownToolbar.alpha + (targetAlpha - browserPullDownToolbar.alpha) * smoothFactor
                            pullDownIndicator.alpha = browserPullDownToolbar.alpha
                        }
                        }
                        
                        // ğŸ”§ ä¿®å¤1ï¼šæ ¹æ®æ‰‹æŒ‡åœ¨å±å¹•ä¸Šçš„Xåæ ‡ï¼ˆæ°´å¹³ä½ç½®ï¼‰ç›´æ¥é€‰æ‹©å¯¹åº”çš„æŒ‰é’®
                        // ç”¨æˆ·æ‰‹åœ¨å±å¹•çš„å“ªä¸ªä½ç½®ä¸‹æ»‘ï¼Œå‚ç›´å¯¹åº”ä¸Šæ–¹çš„é€‰ä¸­èœå•æŒ‰é’®å°±æ˜¯å“ªä¸ª
                        // å½“ç”¨æˆ·å·¦å³æ»‘åŠ¨æ—¶ï¼Œèœå•å’Œå›¾æ ‡å¿…é¡»ä¿æŒå®Œå…¨ä¸é€æ˜
                        if (browserPullDownToolbar.alpha > 0.3f || isHorizontalSwipe) {
                            isSelecting = true
                            // è·å–å±å¹•åæ ‡
                            val location = IntArray(2)
                            view.getLocationOnScreen(location)
                            val screenX = location[0] + event.x
                            // æ ¹æ®Xåæ ‡é€‰æ‹©æŒ‰é’®ï¼ˆæ‰‹æŒ‡åœ¨å±å¹•çš„æ°´å¹³ä½ç½®å¯¹åº”èœå•æŒ‰é’®ï¼‰
                            updateIndicatorPositionByX(screenX)
                            
                            // ğŸ”§ ä¿®å¤1ï¼šå·¦å³æ»‘åŠ¨æ—¶ï¼Œç¡®ä¿èœå•å’Œå›¾æ ‡å®Œå…¨ä¸é€æ˜
                            browserPullDownToolbar.alpha = 1f
                            pullDownIndicator.alpha = 1f
                        }
                    } else {
                        // ğŸ”§ ä¿®å¤2ï¼šæ›´ä¸¥æ ¼åœ°åŒºåˆ†æ¨ªå‘å’Œçºµå‘æ»‘åŠ¨ï¼Œé¿å…æ¨ªå‘æ»‘åŠ¨è¯¯è§¦å‘ä¸‹æ‹‰èœå•
                        val absDeltaX = kotlin.math.abs(deltaX)
                        val absDeltaY = kotlin.math.abs(deltaY)
                        val isHorizontalSwipe = absDeltaX > absDeltaY * 1.5f && absDeltaX > 80f // æ¨ªå‘æ»‘åŠ¨ï¼šæ°´å¹³è·ç¦»æ˜æ˜¾å¤§äºå‚ç›´è·ç¦»ï¼Œä¸”æ°´å¹³è·ç¦»è¶…è¿‡80px
                        
                        // å¦‚æœæ£€æµ‹åˆ°æ˜æ˜¾çš„æ¨ªå‘æ»‘åŠ¨ï¼Œä¸å¤„ç†ä¸‹æ‹‰èœå•ï¼Œè®©WebViewå¤„ç†æ¨ªå‘æ»‘åŠ¨
                        if (isHorizontalSwipe) {
                            return@setOnTouchListener false
                        }
                        
                        // åªæœ‰åœ¨å‘ä¸‹æ‹–åŠ¨ï¼ˆdeltaY > 0ï¼‰ä¸”è¶…è¿‡é˜ˆå€¼æ—¶æ‰æ˜¾ç¤ºå·¥å…·æ 
                        // å¦‚æœç”¨æˆ·ä¸Šæ»‘ï¼ˆdeltaY < 0ï¼‰ï¼Œç›´æ¥è¿”å›ï¼Œä¸å¤„ç†
                        if (deltaY < 0) {
                            // ç”¨æˆ·ä¸Šæ»‘ï¼Œä¸å¤„ç†ï¼Œè®©WebViewæ­£å¸¸æ»šåŠ¨
                            return@setOnTouchListener false
                        }
                        
                        // è®°å½•æœ€å¤§ä¸‹æ‹‰è·ç¦»
                        if (deltaY > maxPullDownY) {
                            maxPullDownY = deltaY
                        }
                        
                        // ğŸ”§ ä¼˜åŒ–ï¼šæ ¹æ®é€Ÿåº¦åŠ¨æ€è°ƒæ•´ä¸‹æ‹‰é˜ˆå€¼ï¼Œå¿«é€Ÿæ»‘åŠ¨æ—¶é™ä½é˜ˆå€¼
                        val velocity = velocityTracker?.let {
                            it.computeCurrentVelocity(1000)
                            kotlin.math.abs(it.yVelocity)
                        } ?: 0f
                        val dynamicPullThreshold = if (velocity > velocityThreshold) {
                            pullThreshold * 0.7f // å¿«é€Ÿæ»‘åŠ¨æ—¶é˜ˆå€¼é™ä½30%
                        } else {
                            pullThreshold
                        }
                        
                        // å¿…é¡»ä¸¥æ ¼æ£€æŸ¥ï¼šé¡µé¢å¿…é¡»åœ¨æœ€é¡¶éƒ¨ï¼ˆä¸èƒ½å‘ä¸Šæ»šåŠ¨ä¸”scrollYä¸º0ï¼‰
                        if (deltaY > dynamicPullThreshold && !isDragging) {
                            val currentWebView = getCurrentWebViewForScrollCheck()
                            if (currentWebView != null) {
                                val canScrollUp = currentWebView.canScrollVertically(-1)
                                val scrollY = currentWebView.scrollY
                                // ä¸¥æ ¼æ£€æŸ¥ï¼šä¸èƒ½å‘ä¸Šæ»šåŠ¨ ä¸” æ»šåŠ¨ä½ç½®å¿…é¡»åœ¨é¡¶éƒ¨ï¼ˆå…è®¸1pxè¯¯å·®ï¼‰
                                if (!canScrollUp && scrollY <= 1) {
                                    isDragging = true
                                    menuShowY = event.y // è®°å½•èœå•æ˜¾ç¤ºæ—¶çš„Yåæ ‡
                                    menuInitialY = event.y // è®°å½•èœå•åˆå§‹Yä½ç½®
                                    showPullDownToolbar(deltaY, followCoefficient)
                                }
                            } else {
                                // å¦‚æœæ²¡æœ‰WebViewï¼Œå¯èƒ½æ˜¯åŠŸèƒ½ä¸»é¡µï¼Œä¹Ÿå…è®¸ä¸‹æ‹‰
                                isDragging = true
                                menuShowY = event.y // è®°å½•èœå•æ˜¾ç¤ºæ—¶çš„Yåæ ‡
                                menuInitialY = event.y // è®°å½•èœå•åˆå§‹Yä½ç½®
                                showPullDownToolbar(deltaY, followCoefficient)
                            }
                        }
                    }
                }
                android.view.MotionEvent.ACTION_UP, 
                android.view.MotionEvent.ACTION_CANCEL -> {
                    // ğŸ”§ è®¡ç®—æœ€ç»ˆé€Ÿåº¦ï¼Œç”¨äºå†³å®šèœå•æ˜¯éšè—è¿˜æ˜¯æ˜¾ç¤º
                    val finalVelocity = velocityTracker?.let {
                        it.computeCurrentVelocity(1000)
                        it.yVelocity
                    } ?: 0f
                    val absFinalVelocity = kotlin.math.abs(finalVelocity)
                    
                    if (isPullDownToolbarVisible) {
                        // ğŸ”§ ä¼˜åŒ–ï¼šæ ¹æ®é€Ÿåº¦å’Œä½ç½®æ™ºèƒ½å†³å®šæ˜¯éšè—è¿˜æ˜¯æ˜¾ç¤ºèœå•
                        val currentTranslationY = browserPullDownToolbar.translationY
                        val menuHeight = browserPullDownToolbar.height.toFloat().coerceAtLeast(100f)
                        val isMenuPulledUp = currentTranslationY < -menuHeight * 0.1f // èœå•å‘ä¸Šç§»åŠ¨è¶…è¿‡10%å°±è®¤ä¸ºä¸Šæ»‘è¿‡
                        
                        // ğŸ”§ ä¿®å¤bugï¼šå¦‚æœç”¨æˆ·ä¸Šæ»‘è¿‡ï¼Œç»å¯¹ä¸åº”è¯¥æ‰§è¡Œå‘½ä»¤
                        // ğŸ”§ ä¼˜åŒ–ï¼šæ›´ä¸¥æ ¼çš„æ¡ä»¶åˆ¤æ–­ï¼Œç¡®ä¿ç”¨æˆ·æ²¡æœ‰ä¸Šæ»‘è¿‡èœå•
                        // åªæœ‰åœ¨æ²¡æœ‰ä¸Šæ»‘è¿‡ã€èœå•å¯è§åº¦è¶³å¤Ÿã€ä¸”é€‰ä¸­äº†å›¾æ ‡æ—¶ï¼Œæ‰æ‰§è¡Œæ“ä½œ
                        // ğŸ”§ ä¸¥æ ¼æ£€æŸ¥ï¼šhasPulledUpæ ‡å¿—å’Œå®é™…ä½ç½®éƒ½è¦æ£€æŸ¥
                        if (!hasPulledUp && !isMenuPulledUp && isSelecting && selectedButtonIndex >= 0 && browserPullDownToolbar.alpha > 0.5f) {
                            // æ‰§è¡Œé€‰ä¸­å›¾æ ‡çš„æ“ä½œ
                            executeSelectedButtonAction(selectedButtonIndex)
                        }
                        val shouldHide = when {
                            // å¿«é€Ÿä¸Šæ»‘ï¼ˆé€Ÿåº¦>1000px/sï¼‰ä¸”å‘ä¸Šç§»åŠ¨ï¼Œç«‹å³éšè—
                            finalVelocity < -velocityThreshold && currentTranslationY < -menuHeight * 0.3f -> true
                            // èœå•å·²ç»æ»‘å‡ºå±å¹•å¤§éƒ¨åˆ†ï¼ˆè¶…è¿‡70%ï¼‰ï¼Œéšè—
                            currentTranslationY < -menuHeight * 0.7f -> true
                            // èœå•alphaå¾ˆä½ï¼ˆ<0.3ï¼‰ï¼Œéšè—
                            browserPullDownToolbar.alpha < 0.3f -> true
                            // å…¶ä»–æƒ…å†µï¼šå¹³æ»‘éšè—
                            else -> true
                        }
                        
                        if (shouldHide) {
                            // ğŸ”§ ä¼˜åŒ–ï¼šä½¿ç”¨å¹³æ»‘çš„é€€å‡ºåŠ¨ç”»ï¼Œå‚è€ƒChromeç§»åŠ¨ç«¯
                            pullDownAnimation?.cancel()
                            
                            // æ ¹æ®å½“å‰ä½ç½®å’Œé€Ÿåº¦è®¡ç®—ç›®æ ‡ä½ç½®
                            val targetTranslationY = -menuHeight * 1.2f // å®Œå…¨æ»‘å‡ºå±å¹•
                            
                            // ä½¿ç”¨å¹³æ»‘çš„åŠ¨ç”»éšè—èœå•
                            pullDownAnimation = android.animation.ValueAnimator.ofFloat(currentTranslationY, targetTranslationY).apply {
                                // ğŸ”§ ä¼˜åŒ–ï¼šæ ¹æ®é€Ÿåº¦åŠ¨æ€è°ƒæ•´åŠ¨ç”»æ—¶é•¿ï¼Œå¿«é€Ÿæ»‘åŠ¨æ—¶æ›´å¿«
                                val baseDuration = 250L // ç¨å¾®å¢åŠ æ—¶é•¿ï¼Œä½¿åŠ¨ç”»æ›´å¹³æ»‘
                                val velocityFactor = if (absFinalVelocity > velocityThreshold) 0.7f else 1f
                                duration = (baseDuration * velocityFactor).toLong()
                                // ğŸ”§ ä½¿ç”¨DecelerateInterpolatoré¿å…å¼¹è·³ï¼Œç¡®ä¿å¹³æ»‘ç»“æŸ
                                interpolator = android.view.animation.DecelerateInterpolator(1.5f) // ä½¿ç”¨1.5çš„å› å­ï¼Œæ›´å¹³æ»‘
                                addUpdateListener { animator ->
                                    val translationY = animator.animatedValue as Float
                                    browserPullDownToolbar.translationY = translationY
                                    // æ ¹æ®ä½ç½®è®¡ç®—alphaï¼Œå¹³æ»‘æ¶ˆå¤±
                                    val progress = ((translationY - currentTranslationY) / (targetTranslationY - currentTranslationY)).coerceIn(0f, 1f)
                                    val alpha = browserPullDownToolbar.alpha * (1f - progress)
                                    browserPullDownToolbar.alpha = alpha
                                    pullDownIndicator.alpha = alpha
                                    
                                    // ğŸ”§ ä¿®å¤ï¼šå½“alphaå¾ˆä½æ—¶ï¼Œä½¿ç”¨INVISIBLEè€Œä¸æ˜¯ç«‹å³è®¾ç½®ä¸ºGONEï¼Œé¿å…é—ªç°
                                    if (alpha <= 0.05f) {
                                        browserPullDownToolbar.alpha = 0f
                                        pullDownIndicator.alpha = 0f
                                        pullDownIndicator.visibility = View.GONE
                                        // åªæœ‰åœ¨å®Œå…¨æ»‘å‡ºå±å¹•æ—¶æ‰è®¾ç½®ä¸ºINVISIBLE
                                        if (translationY <= -menuHeight * 0.9f) {
                                            browserPullDownToolbar.visibility = View.INVISIBLE
                                        }
                                    }
                                }
                                addListener(object : android.animation.AnimatorListenerAdapter() {
                                    override fun onAnimationEnd(animation: android.animation.Animator) {
                                        // ğŸ”§ ä¿®å¤ï¼šå…ˆé‡ç½®ä½ç½®å’Œé€æ˜åº¦ï¼Œç„¶åå†è®¾ç½®visibilityï¼Œé¿å…é—ªç°
                                        browserPullDownToolbar.translationY = 0f
                                        browserPullDownToolbar.alpha = 0f
                                        pullDownIndicator.alpha = 0f
                                        pullDownIndicator.visibility = View.GONE
                                        // ä½¿ç”¨INVISIBLEè€Œä¸æ˜¯GONEï¼Œé¿å…å¸ƒå±€é‡æ–°è®¡ç®—å¯¼è‡´çš„é—ªç°
                                        browserPullDownToolbar.visibility = View.INVISIBLE
                                        isPullDownToolbarVisible = false
                                    }
                                })
                                start()
                            }
                        }
                        menuInitialY = 0f
                    }
                    
                    // å›æ”¶é€Ÿåº¦è·Ÿè¸ªå™¨
                    velocityTracker?.recycle()
                    velocityTracker = null
                    
                    isDragging = false
                    isSelecting = false
                    hasPulledUp = false
                    selectedButtonIndex = -1
                    maxPullDownY = 0f
                    menuShowY = 0f
                }
            }
            false // ä¸æ‹¦æˆªäº‹ä»¶ï¼Œè®©å…¶ä»–ç»„ä»¶æ­£å¸¸å¤„ç†
        }
        
    }
    
    /**
     * æ ¹æ®æ‰‹æŒ‡åœ¨å±å¹•ä¸Šçš„Xåæ ‡ï¼ˆæ°´å¹³ä½ç½®ï¼‰é€‰æ‹©å¯¹åº”çš„æŒ‰é’®
     * ç”¨æˆ·æ‰‹åœ¨å±å¹•çš„å“ªä¸ªä½ç½®ä¸‹æ»‘ï¼Œå‚ç›´å¯¹åº”ä¸Šæ–¹çš„é€‰ä¸­èœå•æŒ‰é’®å°±æ˜¯å“ªä¸ª
     */
    private fun updateIndicatorPositionByX(fingerX: Float) {
        if (!isPullDownToolbarVisible || pullDownButtons == null) return
        
        // è·å–å±å¹•å®½åº¦å’Œå·¥å…·æ ä½ç½®
        val screenWidth = resources.displayMetrics.widthPixels.toFloat()
        val buttons = pullDownButtons!!
        
        // ğŸ”§ ä¿®å¤ï¼šæ”¯æŒä¸»é¡µæ—¶åªæœ‰ä¸€ä¸ªæŒ‰é’®çš„æƒ…å†µï¼Œä¹Ÿæ”¯æŒå¤šä¸ªæŒ‰é’®çš„æƒ…å†µ
        // å°†å±å¹•å®½åº¦åˆ†æˆbuttons.sizeç­‰ä»½ï¼Œæ¯ä¸ªæŒ‰é’®å¯¹åº”ä¸€ä¸ªåŒºåŸŸ
        // æ‰‹æŒ‡åœ¨å±å¹•çš„å“ªä¸ªä½ç½®ï¼Œå°±é€‰ä¸­å¯¹åº”åŒºåŸŸçš„æŒ‰é’®
        var newSelectedIndex = -1
        
        if (buttons.size == 1) {
            // ä¸»é¡µæ—¶åªæœ‰ä¸€ä¸ªæŒ‰é’®ï¼ˆæ’¤å›ï¼‰ï¼Œæ•´ä¸ªå±å¹•éƒ½å¯ä»¥é€‰ä¸­å®ƒ
            newSelectedIndex = 0
        } else {
            // å¤šä¸ªæŒ‰é’®æ—¶ï¼Œå°†å±å¹•åˆ†æˆç­‰ä»½
            val buttonWidth = screenWidth / buttons.size
            for (i in buttons.indices) {
                val buttonLeft = i * buttonWidth
                val buttonRight = (i + 1) * buttonWidth
                
                // å¦‚æœæ‰‹æŒ‡åœ¨è¿™ä¸ªæŒ‰é’®å¯¹åº”çš„å±å¹•åŒºåŸŸå†…
                if (fingerX >= buttonLeft && fingerX < buttonRight) {
                    newSelectedIndex = i
                    break
                }
            }
        }
        
        // å¦‚æœæ‰¾åˆ°äº†é€‰ä¸­çš„æŒ‰é’®ï¼Œæ›´æ–°æŒ‡ç¤ºå™¨ä½ç½®
        if (newSelectedIndex >= 0 && newSelectedIndex != selectedButtonIndex) {
            // ğŸ”§ æ–°å¢ï¼šå½“å…‰æ ‡èƒ½å¤Ÿæ¿€æ´»å¯¹åº”é€‰é¡¹æ—¶ï¼Œè½»éœ‡åŠ¨æé†’
            performHapticFeedbackForButtonSelection()
            selectedButtonIndex = newSelectedIndex
            val selectedButton = buttons[newSelectedIndex]
            val buttonLocation = IntArray(2)
            selectedButton.getLocationOnScreen(buttonLocation)
            val toolbarLocation = IntArray(2)
            browserPullDownToolbar.getLocationOnScreen(toolbarLocation)
            
            // ğŸ”§ ä¿®å¤ï¼šæŒ‡ç¤ºå™¨åº”è¯¥å±…ä¸­åœ¨å›¾æ ‡ä¸Šï¼Œè€Œä¸æ˜¯æ•´ä¸ªæŒ‰é’®
            // è·å–å›¾æ ‡çš„ä½ç½®ï¼ˆæŒ‰é’®å†…çš„ç¬¬ä¸€ä¸ªImageButtonï¼‰
            val iconView = selectedButton.getChildAt(0) as? ImageButton
            val iconLocation = if (iconView != null) {
                val loc = IntArray(2)
                iconView.getLocationOnScreen(loc)
                loc
            } else {
                buttonLocation
            }
            
            // è®¡ç®—æŒ‡ç¤ºå™¨ç›¸å¯¹äºå·¥å…·æ çš„ä½ç½®ï¼ˆå±…ä¸­åœ¨å›¾æ ‡ä¸Šï¼‰
            val indicatorX = iconLocation[0] - toolbarLocation[0]
            val indicatorY = iconLocation[1] - toolbarLocation[1]
            
            // è·å–å½“å‰æŒ‡ç¤ºå™¨ä½ç½®ï¼ˆè€ƒè™‘translationï¼‰
            val currentLayoutParams = pullDownIndicator.layoutParams as FrameLayout.LayoutParams
            val currentX = currentLayoutParams.leftMargin + pullDownIndicator.translationX
            val currentY = currentLayoutParams.topMargin + pullDownIndicator.translationY
            
            // å¦‚æœæŒ‡ç¤ºå™¨è¿˜æœªæ˜¾ç¤ºï¼Œç›´æ¥è®¾ç½®ä½ç½®å¹¶æ˜¾ç¤º
            if (pullDownIndicator.visibility != View.VISIBLE) {
                currentLayoutParams.leftMargin = indicatorX
                currentLayoutParams.topMargin = indicatorY
                pullDownIndicator.layoutParams = currentLayoutParams
                pullDownIndicator.translationX = 0f
                pullDownIndicator.translationY = 0f
                pullDownIndicator.visibility = View.VISIBLE
                pullDownIndicator.alpha = 0f
                pullDownIndicator.animate()
                    .alpha(1f)
                    .setDuration(150)
                    .start()
            } else {
                // æŒ‡ç¤ºå™¨å·²ç»æ˜¾ç¤ºï¼Œä½¿ç”¨translationå®ç°å¹³æ»‘ç§»åŠ¨
                val deltaX = indicatorX - currentX
                val deltaY = indicatorY - currentY
                
                // å…ˆæ›´æ–°layoutParamsåˆ°æ–°ä½ç½®
                currentLayoutParams.leftMargin = indicatorX
                currentLayoutParams.topMargin = indicatorY
                pullDownIndicator.layoutParams = currentLayoutParams
                
                // ä½¿ç”¨translationä»å½“å‰ä½ç½®å¹³æ»‘ç§»åŠ¨åˆ°æ–°ä½ç½®
                pullDownIndicator.translationX = -deltaX
                pullDownIndicator.translationY = -deltaY
                pullDownIndicator.animate()
                    .translationX(0f)
                    .translationY(0f)
                    .setDuration(150)
                    .setInterpolator(android.view.animation.DecelerateInterpolator())
                    .start()
            }
        }
    }
    
    /**
     * æ›´æ–°æŒ‡ç¤ºå™¨ä½ç½®ï¼Œæ ¹æ®æ‰‹æŒ‡Xåæ ‡è®¡ç®—é€‰ä¸­çš„æŒ‰é’®ï¼ˆä¿ç•™ç”¨äºæ¨ªå‘é€‰æ‹©ï¼‰
     */
    private fun updateIndicatorPosition(fingerX: Float) {
        if (!isPullDownToolbarVisible || pullDownButtons == null) return
        
        // è·å–å·¥å…·æ æŒ‰é’®å®¹å™¨çš„ä½ç½®
        val location = IntArray(2)
        pullDownToolbarButtons.getLocationOnScreen(location)
        val toolbarX = location[0]
        val toolbarWidth = pullDownToolbarButtons.width
        
        // è®¡ç®—ç›¸å¯¹äºå·¥å…·æ çš„Xåæ ‡
        val relativeX = fingerX - toolbarX
        
        // å¦‚æœæ‰‹æŒ‡åœ¨å·¥å…·æ èŒƒå›´å†…
        if (relativeX >= 0 && relativeX <= toolbarWidth) {
            // è®¡ç®—æ¯ä¸ªæŒ‰é’®çš„ä½ç½®
            val buttons = pullDownButtons!!
            var newSelectedIndex = -1
            
            for (i in buttons.indices) {
                val button = buttons[i]
                val buttonLocation = IntArray(2)
                button.getLocationOnScreen(buttonLocation)
                val buttonX = buttonLocation[0] - toolbarX
                val buttonWidth = button.width
                
                // å¦‚æœæ‰‹æŒ‡åœ¨æŒ‰é’®èŒƒå›´å†…ï¼ˆå…è®¸ä¸€å®šçš„å®¹å·®ï¼‰
                if (relativeX >= buttonX - buttonWidth / 4 && relativeX <= buttonX + buttonWidth + buttonWidth / 4) {
                    newSelectedIndex = i
                    break
                }
            }
            
            // å¦‚æœæ‰¾åˆ°äº†é€‰ä¸­çš„æŒ‰é’®ï¼Œæ›´æ–°æŒ‡ç¤ºå™¨ä½ç½®
            if (newSelectedIndex >= 0 && newSelectedIndex < buttons.size && newSelectedIndex != selectedButtonIndex) {
                // ğŸ”§ æ–°å¢ï¼šå½“å…‰æ ‡èƒ½å¤Ÿæ¿€æ´»å¯¹åº”é€‰é¡¹æ—¶ï¼Œè½»éœ‡åŠ¨æé†’
                performHapticFeedbackForButtonSelection()
                selectedButtonIndex = newSelectedIndex
                val selectedButton = buttons[newSelectedIndex]
                val buttonLocation = IntArray(2)
                selectedButton.getLocationOnScreen(buttonLocation)
                val toolbarLocation = IntArray(2)
                browserPullDownToolbar.getLocationOnScreen(toolbarLocation)
                
                // ğŸ”§ ä¿®å¤ï¼šæŒ‡ç¤ºå™¨åº”è¯¥å±…ä¸­åœ¨å›¾æ ‡ä¸Šï¼Œè€Œä¸æ˜¯æ•´ä¸ªæŒ‰é’®
                // è·å–å›¾æ ‡çš„ä½ç½®ï¼ˆæŒ‰é’®å†…çš„ç¬¬ä¸€ä¸ªImageButtonï¼‰
                val iconView = selectedButton.getChildAt(0) as? ImageButton
                val iconLocation = if (iconView != null) {
                    val loc = IntArray(2)
                    iconView.getLocationOnScreen(loc)
                    loc
                } else {
                    buttonLocation
                }
                
                // è®¡ç®—æŒ‡ç¤ºå™¨ç›¸å¯¹äºå·¥å…·æ çš„ä½ç½®ï¼ˆå±…ä¸­åœ¨å›¾æ ‡ä¸Šï¼‰
                val indicatorX = iconLocation[0] - toolbarLocation[0]
                val indicatorY = iconLocation[1] - toolbarLocation[1]
                
                // è·å–å½“å‰æŒ‡ç¤ºå™¨ä½ç½®ï¼ˆè€ƒè™‘translationï¼‰
                val currentLayoutParams = pullDownIndicator.layoutParams as FrameLayout.LayoutParams
                val currentX = currentLayoutParams.leftMargin + pullDownIndicator.translationX
                val currentY = currentLayoutParams.topMargin + pullDownIndicator.translationY
                
                // å¦‚æœæŒ‡ç¤ºå™¨è¿˜æœªæ˜¾ç¤ºï¼Œç›´æ¥è®¾ç½®ä½ç½®å¹¶æ˜¾ç¤º
                if (pullDownIndicator.visibility != View.VISIBLE) {
                    currentLayoutParams.leftMargin = indicatorX
                    currentLayoutParams.topMargin = indicatorY
                    pullDownIndicator.layoutParams = currentLayoutParams
                    pullDownIndicator.translationX = 0f
                    pullDownIndicator.translationY = 0f
                    pullDownIndicator.visibility = View.VISIBLE
                    pullDownIndicator.alpha = 0f
                    pullDownIndicator.animate()
                        .alpha(1f)
                        .setDuration(150)
                        .start()
                } else {
                    // æŒ‡ç¤ºå™¨å·²ç»æ˜¾ç¤ºï¼Œä½¿ç”¨translationå®ç°å¹³æ»‘ç§»åŠ¨
                    val deltaX = indicatorX - currentX
                    val deltaY = indicatorY - currentY
                    
                    // å…ˆæ›´æ–°layoutParamsåˆ°æ–°ä½ç½®
                    currentLayoutParams.leftMargin = indicatorX
                    currentLayoutParams.topMargin = indicatorY
                    pullDownIndicator.layoutParams = currentLayoutParams
                    
                    // ä½¿ç”¨translationä»å½“å‰ä½ç½®å¹³æ»‘ç§»åŠ¨åˆ°æ–°ä½ç½®
                    pullDownIndicator.translationX = -deltaX
                    pullDownIndicator.translationY = -deltaY
                    pullDownIndicator.animate()
                        .translationX(0f)
                        .translationY(0f)
                        .setDuration(150)
                        .setInterpolator(android.view.animation.DecelerateInterpolator())
                        .start()
                }
            }
        }
    }
    
    /**
     * æ‰§è¡Œé€‰ä¸­æŒ‰é’®çš„æ“ä½œ
     */
    private fun executeSelectedButtonAction(index: Int) {
        // ğŸ”§ ä¿®å¤ï¼šæ ¹æ®å®é™…çš„æŒ‰é’®æ•°ç»„æ¥åˆ¤æ–­æ‰§è¡Œä»€ä¹ˆæ“ä½œï¼Œè€Œä¸æ˜¯ç¡¬ç¼–ç ç´¢å¼•
        val buttons = pullDownButtons ?: return
        if (index < 0 || index >= buttons.size) {
            Log.w(TAG, "æŒ‰é’®ç´¢å¼•è¶…å‡ºèŒƒå›´: $index, æŒ‰é’®æ•°é‡: ${buttons.size}")
            return
        }
        
        val selectedButton = buttons[index]
        
        // æ ¹æ®æŒ‰é’®IDåˆ¤æ–­æ‰§è¡Œä»€ä¹ˆæ“ä½œ
        when (selectedButton.id) {
            R.id.pull_down_btn_back -> {
                // æ’¤å›ï¼šä¼˜å…ˆé‡æ–°æ‰“å¼€æœ€è¿‘å…³é—­çš„æ ‡ç­¾é¡µï¼Œå¦‚æœæ²¡æœ‰åˆ™å°è¯•WebViewåé€€
                try {
                    // å…ˆå°è¯•æ¢å¤æœ€è¿‘å…³é—­çš„æ ‡ç­¾é¡µ
                    if (closedTabsHistory.isNotEmpty()) {
                        // ğŸ”§ ä¿®å¤ï¼šç›´æ¥è°ƒç”¨æ¢å¤é€»è¾‘ï¼Œç¡®ä¿æ ‡ç­¾é¡µè¢«æ­£ç¡®æ¢å¤å’ŒåŠ è½½
                        val lastClosedTab = closedTabsHistory.removeAt(closedTabsHistory.size - 1)
                        
                        // æ¢å¤æ ‡ç­¾é¡µ
                        paperStackWebViewManager?.let { manager ->
                            // åˆ›å»ºæ–°æ ‡ç­¾é¡µå¹¶åŠ è½½URL
                            val restoredTab = manager.addTab(lastClosedTab.url, lastClosedTab.title)
                            
                            // æ‰¾åˆ°æ–°æ ‡ç­¾é¡µçš„ç´¢å¼•å¹¶åˆ‡æ¢
                            val tabIndex = manager.getTabCount() - 1 // addTabä¼šåœ¨æœ«å°¾æ·»åŠ ï¼Œæ‰€ä»¥ç´¢å¼•æ˜¯æœ€åä¸€ä¸ª
                            manager.switchToTab(tabIndex)
                            
                            // âš¡ ç«‹å³æ›´æ–°é¡µé¢æ•°é‡æ˜¾ç¤º
                            handler.post {
                                updatePageCountDisplay()
                            }
                            
                            Log.d(TAG, "ä¸‹æ‹‰å·¥å…·æ ï¼šæ’¤å›å…³é—­çš„æ ‡ç­¾é¡µ - ${lastClosedTab.title}, URL: ${lastClosedTab.url}")
                        } ?: run {
                            // å¦‚æœç®¡ç†å™¨ä¸å¯ç”¨ï¼Œé‡æ–°æ·»åŠ åˆ°å†å²è®°å½•
                            closedTabsHistory.add(lastClosedTab)
                            showMaterialToast("æ ‡ç­¾é¡µç®¡ç†å™¨ä¸å¯ç”¨")
                        }
                    } else {
                        // å¦‚æœæ²¡æœ‰å…³é—­çš„æ ‡ç­¾é¡µï¼Œå°è¯•WebViewåé€€
                        val handled = unifiedWebViewManager.goBack()
                        if (!handled) {
                            // å¦‚æœç»Ÿä¸€ç®¡ç†å™¨æ²¡æœ‰å¤„ç†ï¼Œå°è¯•ç›´æ¥æ“ä½œWebView
                            val currentWebView = getCurrentWebViewForScrollCheck()
                            if (currentWebView?.canGoBack() == true) {
                                currentWebView.goBack()
                            } else {
                                showMaterialToast("æ— æ³•æ’¤å›")
                            }
                        }
                        Log.d(TAG, "ä¸‹æ‹‰å·¥å…·æ ï¼šæ’¤å›ï¼ˆWebViewåé€€ï¼‰")
                    }
                } catch (e: Exception) {
                    Log.e(TAG, "æ’¤å›å¤±è´¥", e)
                    showMaterialToast("æ’¤å›å¤±è´¥: ${e.message}")
                }
            }
            R.id.pull_down_btn_close -> {
                // å…³é—­
                closeCurrentTab()
                Log.d(TAG, "ä¸‹æ‹‰å·¥å…·æ ï¼šå…³é—­")
            }
            R.id.pull_down_btn_refresh -> {
                // åˆ·æ–°
                refreshCurrentWebPage()
                Log.d(TAG, "ä¸‹æ‹‰å·¥å…·æ ï¼šåˆ·æ–°")
            }
            R.id.pull_down_btn_home -> {
                // ä¸»é¡µ
                goToHomePage()
                Log.d(TAG, "ä¸‹æ‹‰å·¥å…·æ ï¼šä¸»é¡µ")
            }
            R.id.pull_down_btn_secret -> {
                // æš—é“
                showSecretModeDialog()
                Log.d(TAG, "ä¸‹æ‹‰å·¥å…·æ ï¼šæš—é“")
            }
            else -> {
                Log.w(TAG, "æœªçŸ¥çš„æŒ‰é’®ID: ${selectedButton.id}")
            }
        }
    }
    
    /**
     * æ˜¾ç¤ºä¸‹æ‹‰å·¥å…·æ ï¼ˆä¸Šæ»‘åŠ¨ç”»ï¼Œè·Ÿéšæ‰‹æŒ‡ï¼‰
     */
    private fun showPullDownToolbar(initialPullDistance: Float = 0f, followCoefficient: Float = 0.9f) {
        if (isPullDownToolbarVisible) return
        
        isPullDownToolbarVisible = true
        
        // ğŸ”§ æ–°åŠŸèƒ½ï¼šæ ¹æ®å½“å‰é¡µé¢çŠ¶æ€åŠ¨æ€æ˜¾ç¤º/éšè—æŒ‰é’®
        // åœ¨ä¸»é¡µæ—¶åªæ˜¾ç¤ºæ’¤å›æŒ‰é’®ï¼Œå…¶ä»–æŒ‰é’®å±è”½
        updatePullDownToolbarButtonsVisibility()
        
        // å–æ¶ˆä¹‹å‰çš„åŠ¨ç”»
        pullDownAnimation?.cancel()
        
        // ğŸ”§ ä¿®æ”¹ï¼šèœå•ä»é¡¶éƒ¨å‘ä¸‹æ»‘åŠ¨ç§»è¿›
        // ç¡®ä¿èœå•å·²ç»æµ‹é‡
        if (browserPullDownToolbar.height == 0) {
            browserPullDownToolbar.measure(
                View.MeasureSpec.makeMeasureSpec(resources.displayMetrics.widthPixels, View.MeasureSpec.EXACTLY),
                View.MeasureSpec.makeMeasureSpec(0, View.MeasureSpec.UNSPECIFIED)
            )
        }
        val menuHeight = browserPullDownToolbar.height.toFloat().coerceAtLeast(100f)
        
        // åˆå§‹ä½ç½®ï¼šä»å±å¹•é¡¶éƒ¨å¼€å§‹ï¼ˆåœ¨å±å¹•ä¸Šæ–¹ï¼‰
        val initialTranslationY = if (initialPullDistance > 0) {
            // å¦‚æœå·²ç»æœ‰ä¸‹æ‹‰è·ç¦»ï¼Œèœå•ä»é¡¶éƒ¨å‘ä¸‹ç§»åŠ¨ç›¸åº”è·ç¦»ï¼Œç›´æ¥è·Ÿéšæ‰‹åŠ¿
            // ğŸ”§ ä¿®å¤ï¼šæ ¹æ®ä¸‹æ‹‰è·ç¦»è®¡ç®—ä½ç½®ï¼Œè®©èœå•è·Ÿéšæ‰‹åŠ¿æ¸è¿›æ˜¾ç¤º
            (-menuHeight + initialPullDistance * followCoefficient).coerceIn(-menuHeight, 0f)
        } else {
            -menuHeight // ä»å±å¹•é¡¶éƒ¨å¼€å§‹ï¼ˆå®Œå…¨åœ¨å±å¹•å¤–ï¼‰
        }
        
        // ğŸ”§ å…³é”®ä¿®å¤ï¼šå…ˆè®¾ç½®ä½ç½®å’Œé€æ˜åº¦ï¼Œç„¶åå†è®¾ç½®visibilityï¼Œé¿å…é—ªç°
        // å…ˆè®¾ç½®åˆå§‹ä½ç½®å’Œé€æ˜åº¦ï¼ˆæ­¤æ—¶èœå•è¿˜ä¸å¯è§ï¼‰
        browserPullDownToolbar.translationY = initialTranslationY
        
        // ğŸ”§ å…³é”®ä¿®å¤ï¼šæ ¹æ®åˆå§‹ä½ç½®è®¡ç®—alphaï¼Œè®©èœå•æ¸è¿›æ˜¾ç¤ºï¼Œè€Œä¸æ˜¯ç¬é—´å¼¹å‡º
        // å¦‚æœå·²ç»æœ‰ä¸‹æ‹‰è·ç¦»ï¼Œæ ¹æ®ä½ç½®è®¡ç®—alphaï¼Œè®©èœå•è·Ÿéšæ‰‹åŠ¿æ˜¾ç¤º
        val initialAlpha = if (initialPullDistance > 0) {
            // æ ¹æ®ä¸‹æ‹‰è·ç¦»è®¡ç®—alphaï¼Œè®©èœå•æ¸è¿›æ˜¾ç¤º
            val progress = ((initialTranslationY + menuHeight) / menuHeight).coerceIn(0f, 1f)
            progress * 0.8f // åˆå§‹é˜¶æ®µåªæ˜¾ç¤º80%é€æ˜åº¦ï¼Œéœ€è¦ç»§ç»­ä¸‹æ‹‰æ‰å®Œå…¨æ˜¾ç¤º
        } else {
            0f
        }
        browserPullDownToolbar.alpha = initialAlpha
        
        // ğŸ”§ å…³é”®ä¿®å¤ï¼šåœ¨è®¾ç½®å®Œä½ç½®å’Œé€æ˜åº¦åå†è®¾ç½®visibilityï¼Œé¿å…é—ªç°
        // å¦‚æœåˆå§‹alphaä¸º0ä¸”ä½ç½®åœ¨å±å¹•å¤–ï¼Œä½¿ç”¨INVISIBLEè€Œä¸æ˜¯VISIBLEï¼Œé¿å…é—ªç°
        if (initialAlpha <= 0.01f && initialTranslationY <= -menuHeight * 0.9f) {
            browserPullDownToolbar.visibility = View.INVISIBLE
        } else {
            browserPullDownToolbar.visibility = View.VISIBLE
            // ğŸ”§ ä¿®å¤ï¼šç¡®ä¿ä¸‹æ‹‰å·¥å…·æ åœ¨æœ€ä¸Šå±‚ï¼Œä¸è¢«webviewé®æŒ¡
            browserPullDownToolbar.bringToFront()
        }
        
        // ğŸ”§ å…³é”®ä¿®å¤ï¼šåªæœ‰åœ¨æ²¡æœ‰ä¸‹æ‹‰è·ç¦»æ—¶æ‰æ‰§è¡ŒåŠ¨ç”»ï¼Œå¦‚æœæœ‰ä¸‹æ‹‰è·ç¦»åˆ™ç›´æ¥è·Ÿéšæ‰‹åŠ¿
        if (initialPullDistance <= 0) {
            // æ²¡æœ‰ä¸‹æ‹‰è·ç¦»ï¼Œæ‰§è¡ŒåŠ¨ç”»ä»é¡¶éƒ¨æ»‘å…¥
            // ğŸ”§ ä¿®å¤ï¼šç¡®ä¿åœ¨åŠ¨ç”»å¼€å§‹æ—¶èœå•å¯è§æ€§æ­£ç¡®
            if (browserPullDownToolbar.visibility != View.VISIBLE) {
                browserPullDownToolbar.visibility = View.VISIBLE
                // ğŸ”§ ä¿®å¤ï¼šç¡®ä¿ä¸‹æ‹‰å·¥å…·æ åœ¨æœ€ä¸Šå±‚ï¼Œä¸è¢«webviewé®æŒ¡
                browserPullDownToolbar.bringToFront()
            }
            
            pullDownAnimation = android.animation.ValueAnimator.ofFloat(initialTranslationY, 0f).apply {
                duration = 250L // ç¨å¾®å¢åŠ æ—¶é•¿ï¼Œä½¿åŠ¨ç”»æ›´å¹³æ»‘
                // ğŸ”§ ä½¿ç”¨DecelerateInterpolatoré¿å…å¼¹è·³ï¼Œç¡®ä¿å¹³æ»‘ç»“æŸ
                interpolator = android.view.animation.DecelerateInterpolator(1.5f) // ä½¿ç”¨1.5çš„å› å­ï¼Œæ›´å¹³æ»‘
                addUpdateListener { animator ->
                    val translationY = animator.animatedValue as Float
                    browserPullDownToolbar.translationY = translationY
                    // æ ¹æ®ä½ç½®è®¡ç®—alphaï¼ˆä»é¡¶éƒ¨å‘ä¸‹æ»‘å…¥æ—¶é€æ¸æ˜¾ç¤ºï¼‰
                    val progress = 1f - ((translationY - initialTranslationY) / -initialTranslationY).coerceIn(0f, 1f)
                    browserPullDownToolbar.alpha = progress
                    // ğŸ”§ ä¿®å¤ï¼šç¡®ä¿åœ¨åŠ¨ç”»è¿‡ç¨‹ä¸­èœå•å¯è§æ€§æ­£ç¡®
                    if (browserPullDownToolbar.visibility != View.VISIBLE && progress > 0.01f) {
                        browserPullDownToolbar.visibility = View.VISIBLE
                        // ğŸ”§ ä¿®å¤ï¼šç¡®ä¿ä¸‹æ‹‰å·¥å…·æ åœ¨æœ€ä¸Šå±‚ï¼Œä¸è¢«webviewé®æŒ¡
                        browserPullDownToolbar.bringToFront()
                    }
                }
                addListener(object : android.animation.AnimatorListenerAdapter() {
                    override fun onAnimationEnd(animation: android.animation.Animator) {
                        // ğŸ”§ æ·»åŠ ç¡®è®¤åŠ¨ç”»ï¼šèœå•æ¿€æ´»åçš„è½»å¾®åé¦ˆ
                        // ä½¿ç”¨è½»å¾®çš„ç¼©æ”¾åŠ¨ç”»ç¡®è®¤ç”¨æˆ·æ“ä½œ
                        browserPullDownToolbar.animate()
                            .scaleX(1.02f)
                            .scaleY(1.02f)
                            .setDuration(100L)
                            .withEndAction {
                                browserPullDownToolbar.animate()
                                    .scaleX(1f)
                                    .scaleY(1f)
                                    .setDuration(100L)
                                    .start()
                            }
                            .start()
                    }
                })
                start()
            }
        } else {
            // ğŸ”§ å…³é”®ä¿®å¤ï¼šå¦‚æœæœ‰ä¸‹æ‹‰è·ç¦»ï¼Œèœå•å·²ç»è·Ÿéšæ‰‹åŠ¿æ˜¾ç¤ºï¼Œä¸æ‰§è¡ŒåŠ¨ç”»
            // èœå•ä¼šç»§ç»­è·Ÿéšç”¨æˆ·çš„æ‰‹åŠ¿ç§»åŠ¨ï¼Œä¸ä¼šç¬é—´å¼¹å‡º
            pullDownAnimation = null
        }
        
        Log.d(TAG, "æ˜¾ç¤ºä¸‹æ‹‰å·¥å…·æ ï¼ˆä¸Šæ»‘åŠ¨ç”»ï¼‰")
    }
    
    /**
     * æ ¹æ®å½“å‰é¡µé¢çŠ¶æ€æ›´æ–°ä¸‹æ‹‰å·¥å…·æ æŒ‰é’®çš„å¯è§æ€§
     * åœ¨ä¸»é¡µæ—¶åªæ˜¾ç¤ºæ’¤å›æŒ‰é’®ï¼Œå…¶ä»–æŒ‰é’®å±è”½
     */
    private fun updatePullDownToolbarButtonsVisibility() {
        try {
            val currentTab = paperStackWebViewManager?.getCurrentTab()
            val isHomePage = currentTab?.url == "home://functional" || 
                           currentTab?.url == "file:///android_asset/functional_home.html" ||
                           currentTab == null
            
            if (isHomePage) {
                // ä¸»é¡µï¼šæ˜¾ç¤ºæ’¤å›å’Œæš—é“æŒ‰é’®
                pullDownBtnBack.visibility = View.VISIBLE
                pullDownBtnClose.visibility = View.GONE
                pullDownBtnRefresh.visibility = View.GONE
                pullDownBtnHome.visibility = View.GONE
                pullDownBtnSecret.visibility = View.VISIBLE
                // æ›´æ–°æŒ‰é’®æ•°ç»„ï¼ŒåŒ…å«æ’¤å›å’Œæš—é“æŒ‰é’®
                pullDownButtons = arrayOf(pullDownBtnBack, pullDownBtnSecret)
            } else {
                // éä¸»é¡µï¼šæ˜¾ç¤ºæ‰€æœ‰æŒ‰é’®ï¼ˆä¸åŒ…æ‹¬æš—é“ï¼‰
                pullDownBtnBack.visibility = View.VISIBLE
                pullDownBtnClose.visibility = View.VISIBLE
                pullDownBtnRefresh.visibility = View.VISIBLE
                pullDownBtnHome.visibility = View.VISIBLE
                pullDownBtnSecret.visibility = View.GONE
                // æ›´æ–°æŒ‰é’®æ•°ç»„ï¼ŒåŒ…å«æ‰€æœ‰æŒ‰é’®
                pullDownButtons = arrayOf(pullDownBtnBack, pullDownBtnClose, pullDownBtnRefresh, pullDownBtnHome)
            }
            
            Log.d(TAG, "æ›´æ–°ä¸‹æ‹‰å·¥å…·æ æŒ‰é’®å¯è§æ€§: ä¸»é¡µ=$isHomePage")
        } catch (e: Exception) {
            Log.e(TAG, "æ›´æ–°ä¸‹æ‹‰å·¥å…·æ æŒ‰é’®å¯è§æ€§å¤±è´¥", e)
            // å‡ºé”™æ—¶æ˜¾ç¤ºæ‰€æœ‰æŒ‰é’®
            pullDownButtons = arrayOf(pullDownBtnBack, pullDownBtnClose, pullDownBtnRefresh, pullDownBtnHome)
        }
    }
    
    /**
     * éšè—ä¸‹æ‹‰å·¥å…·æ ï¼ˆä¸Šæ»‘åŠ¨ç”»ï¼Œè·Ÿéšæ‰‹æŒ‡ï¼‰
     */
    private fun hidePullDownToolbar() {
        if (!isPullDownToolbarVisible) return
        
        // éšè—æŒ‡ç¤ºå™¨å¹¶é‡ç½®çŠ¶æ€
        pullDownIndicator.visibility = View.GONE
        pullDownIndicator.translationX = 0f
        pullDownIndicator.translationY = 0f
        selectedButtonIndex = -1
        
        // å–æ¶ˆä¹‹å‰çš„åŠ¨ç”»
        pullDownAnimation?.cancel()
        
        // ğŸ”§ ä¿®å¤1ï¼šæ”¹ä¸ºä¸Šæ»‘åŠ¨ç”»ï¼Œèœå•å½»åº•å‘ä¸Šæ»‘å‡ºå±å¹•
        // ç¡®ä¿èœå•å·²ç»æµ‹é‡
        val menuHeight = if (browserPullDownToolbar.height > 0) {
            browserPullDownToolbar.height.toFloat()
        } else {
            browserPullDownToolbar.measuredHeight.toFloat().coerceAtLeast(100f)
        }
        val screenHeight = resources.displayMetrics.heightPixels.toFloat()
        val currentTranslationY = browserPullDownToolbar.translationY
        val targetTranslationY = -screenHeight // ğŸ”§ ä¿®å¤1ï¼šå½»åº•æ»‘å‡ºå±å¹•å¤–ï¼ˆä½¿ç”¨å±å¹•é«˜åº¦ï¼‰
        
        pullDownAnimation = android.animation.ValueAnimator.ofFloat(currentTranslationY, targetTranslationY).apply {
            duration = 200
            interpolator = android.view.animation.AccelerateInterpolator()
            addUpdateListener { animator ->
                val translationY = animator.animatedValue as Float
                browserPullDownToolbar.translationY = translationY
                // æ ¹æ®ä½ç½®è®¡ç®—alphaï¼ˆå‘ä¸Šæ»‘å‡ºæ—¶é€æ¸éšè—ï¼‰
                val progress = 1f - ((currentTranslationY - translationY) / (currentTranslationY - targetTranslationY)).coerceIn(0f, 1f)
                browserPullDownToolbar.alpha = progress
            }
            addListener(object : android.animation.Animator.AnimatorListener {
                override fun onAnimationStart(animation: android.animation.Animator) {}
                override fun onAnimationEnd(animation: android.animation.Animator) {
                    browserPullDownToolbar.translationY = 0f
                    browserPullDownToolbar.visibility = View.GONE
                    isPullDownToolbarVisible = false
                }
                override fun onAnimationCancel(animation: android.animation.Animator) {
                    browserPullDownToolbar.translationY = 0f
                    browserPullDownToolbar.visibility = View.GONE
                    isPullDownToolbarVisible = false
                }
                override fun onAnimationRepeat(animation: android.animation.Animator) {}
            })
            start()
        }
        
        Log.d(TAG, "éšè—ä¸‹æ‹‰å·¥å…·æ ï¼ˆä¸Šæ»‘åŠ¨ç”»ï¼‰")
    }
    
    /**
     * è®¾ç½®ä¸‹æ‹‰å·¥å…·æ æŒ‰é’®ç‚¹å‡»äº‹ä»¶
     */
    private fun setupPullDownToolbarButtons() {
        // æ’¤å›æŒ‰é’®
        pullDownBtnBack.setOnClickListener {
            hidePullDownToolbar()
            unifiedWebViewManager.goBack()
            Log.d(TAG, "ä¸‹æ‹‰å·¥å…·æ ï¼šæ’¤å›")
        }
        
        // å…³é—­æŒ‰é’®
        pullDownBtnClose.setOnClickListener {
            hidePullDownToolbar()
            closeCurrentTab()
            Log.d(TAG, "ä¸‹æ‹‰å·¥å…·æ ï¼šå…³é—­")
        }
        
        // åˆ·æ–°æŒ‰é’®
        pullDownBtnRefresh.setOnClickListener {
            hidePullDownToolbar()
            refreshCurrentWebPage()
            Log.d(TAG, "ä¸‹æ‹‰å·¥å…·æ ï¼šåˆ·æ–°")
        }
        
        // ä¸»é¡µæŒ‰é’®
        pullDownBtnHome.setOnClickListener {
            hidePullDownToolbar()
            goToHomePage()
            Log.d(TAG, "ä¸‹æ‹‰å·¥å…·æ ï¼šä¸»é¡µ")
        }
        
        // æš—é“æŒ‰é’®
        pullDownBtnSecret.setOnClickListener {
            hidePullDownToolbar()
            showSecretModeDialog()
            Log.d(TAG, "ä¸‹æ‹‰å·¥å…·æ ï¼šæš—é“")
        }
    }
    
    /**
     * æ˜¾ç¤ºæš—é“å¯†ç éªŒè¯å¯¹è¯æ¡†
     */
    private fun showSecretModeDialog() {
        val groupManager = TabGroupManager.getInstance(this)
        
        // å¦‚æœå·²ç»åœ¨æš—é“æ¨¡å¼ï¼Œæ˜¾ç¤ºé€€å‡ºé€‰é¡¹
        if (groupManager.isSecretModeActive()) {
            android.app.AlertDialog.Builder(this)
                .setTitle("é€€å‡ºæš—é“")
                .setMessage("ç¡®å®šè¦é€€å‡ºæš—é“æ¨¡å¼å—ï¼Ÿé€€å‡ºåå°†æ— æ³•æŸ¥çœ‹éšè—çš„æ ‡ç­¾ç»„ã€‚")
                .setPositiveButton("é€€å‡º") { _, _ ->
                    groupManager.deactivateSecretMode()
                    Toast.makeText(this, "å·²é€€å‡ºæš—é“æ¨¡å¼", Toast.LENGTH_SHORT).show()
                    // åˆ·æ–°ç»„åˆ—è¡¨ï¼ˆdeactivateSecretModeå·²ç»è§¦å‘äº†notifyGroupChangedï¼Œè¿™é‡Œç¡®ä¿UIåˆ·æ–°ï¼‰
                    refreshGroupTabsForSecretMode()
                }
                .setNegativeButton("å–æ¶ˆ", null)
                .show()
            return
        }
        
        // ğŸ”§ æ–°åŠŸèƒ½ï¼šæ£€æŸ¥æ˜¯å¦å·²è®¾ç½®æš—é“å¯†ç 
        val hiddenGroups = groupManager.getAllGroupsIncludingHidden().filter { it.isHidden }
        val hasSecretModePassword = groupManager.hasSecretModePassword()
        
        if (!hasSecretModePassword && hiddenGroups.isEmpty()) {
            // ç¬¬ä¸€æ¬¡è¿›å…¥ä¸”æ²¡æœ‰éšè—ç»„ï¼Œæç¤ºç”¨æˆ·è®¾ç½®å¯†ç 
            android.app.AlertDialog.Builder(this)
                .setTitle("è®¾ç½®æš—é“å¯†ç ")
                .setMessage("è¿™æ˜¯æ‚¨ç¬¬ä¸€æ¬¡ä½¿ç”¨æš—é“åŠŸèƒ½ã€‚è¯·è®¾ç½®ä¸€ä¸ªå¯†ç ï¼Œç”¨äºæŸ¥çœ‹éšè—çš„æ ‡ç­¾ç»„ã€‚")
                .setPositiveButton("è®¾ç½®å¯†ç ") { _, _ ->
                    showSetSecretModePasswordDialog()
                }
                .setNegativeButton("å–æ¶ˆ", null)
                .show()
            return
        }
        
        // æ˜¾ç¤ºå¯†ç è¾“å…¥å¯¹è¯æ¡†
        val passwordInput = android.widget.EditText(this).apply {
            inputType = android.text.InputType.TYPE_CLASS_TEXT or android.text.InputType.TYPE_TEXT_VARIATION_PASSWORD
            hint = "è¯·è¾“å…¥æš—é“å¯†ç "
        }
        
        android.app.AlertDialog.Builder(this)
            .setTitle("è¿›å…¥æš—é“")
            .setMessage("è¾“å…¥å¯†ç ä»¥æŸ¥çœ‹æ‰€æœ‰æ ‡ç­¾ç»„ï¼ˆåŒ…æ‹¬éšè—çš„ç»„ï¼‰")
            .setView(passwordInput)
            .setPositiveButton("ç¡®å®š") { _, _ ->
                val password = passwordInput.text.toString()
                if (password.isEmpty()) {
                    Toast.makeText(this, "å¯†ç ä¸èƒ½ä¸ºç©º", Toast.LENGTH_SHORT).show()
                    return@setPositiveButton
                }
                
                // éªŒè¯å¯†ç 
                if (groupManager.verifySecretModePassword(password)) {
                    groupManager.activateSecretMode()
                    Toast.makeText(this, "å·²è¿›å…¥æš—é“æ¨¡å¼", Toast.LENGTH_SHORT).show()
                    // åˆ·æ–°ç»„åˆ—è¡¨ï¼ˆactivateSecretModeå·²ç»è§¦å‘äº†notifyGroupChangedï¼Œè¿™é‡Œç¡®ä¿UIåˆ·æ–°ï¼‰
                    refreshGroupTabsForSecretMode()
                } else {
                    Toast.makeText(this, "å¯†ç é”™è¯¯", Toast.LENGTH_SHORT).show()
                }
            }
            .setNegativeButton("å–æ¶ˆ", null)
            .show()
    }
    
    /**
     * æ˜¾ç¤ºè®¾ç½®æš—é“å¯†ç å¯¹è¯æ¡†
     */
    private fun showSetSecretModePasswordDialog() {
        val passwordInput = android.widget.EditText(this).apply {
            inputType = android.text.InputType.TYPE_CLASS_TEXT or android.text.InputType.TYPE_TEXT_VARIATION_PASSWORD
            hint = "è¯·è¾“å…¥å¯†ç "
        }
        
        val confirmPasswordInput = android.widget.EditText(this).apply {
            inputType = android.text.InputType.TYPE_CLASS_TEXT or android.text.InputType.TYPE_TEXT_VARIATION_PASSWORD
            hint = "è¯·å†æ¬¡è¾“å…¥å¯†ç "
        }
        
        val container = android.widget.LinearLayout(this).apply {
            orientation = android.widget.LinearLayout.VERTICAL
            setPadding(50, 20, 50, 20)
            addView(passwordInput)
            addView(confirmPasswordInput)
        }
        
        android.app.AlertDialog.Builder(this)
            .setTitle("è®¾ç½®æš—é“å¯†ç ")
            .setMessage("è¯·è®¾ç½®ä¸€ä¸ªå¯†ç ï¼Œç”¨äºè¿›å…¥æš—é“æ¨¡å¼æŸ¥çœ‹éšè—çš„æ ‡ç­¾ç»„ã€‚")
            .setView(container)
            .setPositiveButton("ç¡®å®š") { _, _ ->
                val password = passwordInput.text.toString()
                val confirmPassword = confirmPasswordInput.text.toString()
                
                if (password.isEmpty()) {
                    Toast.makeText(this, "å¯†ç ä¸èƒ½ä¸ºç©º", Toast.LENGTH_SHORT).show()
                    return@setPositiveButton
                }
                
                if (password != confirmPassword) {
                    Toast.makeText(this, "ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´", Toast.LENGTH_SHORT).show()
                    return@setPositiveButton
                }
                
                val groupManager = TabGroupManager.getInstance(this)
                groupManager.setSecretModePassword(password)
                Toast.makeText(this, "æš—é“å¯†ç è®¾ç½®æˆåŠŸ", Toast.LENGTH_SHORT).show()
                
                // è®¾ç½®å¯†ç åè‡ªåŠ¨æ¿€æ´»æš—é“æ¨¡å¼
                groupManager.activateSecretMode()
                refreshGroupTabsForSecretMode()
            }
            .setNegativeButton("å–æ¶ˆ", null)
            .show()
    }
    
    /**
     * åˆ·æ–°ç»„æ ‡ç­¾æ˜¾ç¤ºï¼ˆç”¨äºæš—é“æ¨¡å¼ï¼‰
     * æ³¨æ„ï¼šå®é™…çš„refreshGroupTabså®ç°åœ¨32575è¡Œï¼Œè¿™é‡Œåªæ˜¯è§¦å‘åˆ·æ–°
     */
    private fun refreshGroupTabsForSecretMode() {
        try {
            // ç”±äºactivateSecretMode/deactivateSecretModeå·²ç»è°ƒç”¨äº†notifyGroupChanged
            // æ‰€ä»¥Fragmentä¼šè‡ªåŠ¨åˆ·æ–°ï¼Œè¿™é‡Œåªéœ€è¦ç¡®ä¿ç»„æ ‡ç­¾æ ä¹Ÿåˆ·æ–°
            handler.post {
                // è°ƒç”¨å®é™…çš„refreshGroupTabsæ–¹æ³•ï¼ˆåœ¨32575è¡Œï¼‰
                refreshGroupTabs()
            }
        } catch (e: Exception) {
            Log.e(TAG, "åˆ·æ–°ç»„æ ‡ç­¾å¤±è´¥", e)
        }
    }
    
    /**
     * å…³é—­å½“å‰æ ‡ç­¾é¡µ
     */
    private fun closeCurrentTab() {
        try {
            // ä¼˜å…ˆä½¿ç”¨PaperStackWebViewManager
            paperStackWebViewManager?.let { manager ->
                val currentTab = manager.getCurrentTab()
                currentTab?.let { tab ->
                    if (tab.url != "home://functional") {
                        // ğŸ”§ ä¿®å¤ï¼šåœ¨å…³é—­æ ‡ç­¾é¡µä¹‹å‰ï¼Œå…ˆä¿å­˜å…³é—­çš„æ ‡ç­¾é¡µä¿¡æ¯ï¼Œä»¥ä¾¿æ’¤å›åŠŸèƒ½ä½¿ç”¨
                        saveClosedTab(tab)
                        manager.closeTabByUrl(tab.url)
                        // âš¡ ç«‹å³æ›´æ–°é¡µé¢æ•°é‡æ˜¾ç¤º
                        handler.post {
                            updatePageCountDisplay()
                        }
                    } else {
                        showMaterialToast("åŠŸèƒ½ä¸»é¡µä¸èƒ½å…³é—­")
                    }
                }
                return
            }
            
            // ä½¿ç”¨MultiPageWebViewManager
            multiPageWebViewManager?.let { manager ->
                val currentPage = manager.getCurrentPage()
                val allPages = manager.getAllPages()
                if (allPages.size > 1 && currentPage != null) {
                    val currentIndex = allPages.indexOf(currentPage)
                    if (currentIndex >= 0) {
                        manager.closePage(currentIndex)
                    } else {
                        showMaterialToast("è‡³å°‘ä¿ç•™ä¸€ä¸ªæ ‡ç­¾é¡µ")
                    }
                } else {
                    showMaterialToast("è‡³å°‘ä¿ç•™ä¸€ä¸ªæ ‡ç­¾é¡µ")
                }
                return
            }
            
            showMaterialToast("æ— æ³•å…³é—­æ ‡ç­¾é¡µ")
        } catch (e: Exception) {
            Log.e(TAG, "å…³é—­æ ‡ç­¾é¡µå¤±è´¥", e)
            showMaterialToast("å…³é—­æ ‡ç­¾é¡µå¤±è´¥")
        }
    }
    
    /**
     * å›åˆ°ä¸»é¡µ
     */
    private fun goToHomePage() {
        try {
            // ä¼˜å…ˆä½¿ç”¨PaperStackWebViewManager
            paperStackWebViewManager?.let { manager ->
                // æŸ¥æ‰¾åŠŸèƒ½ä¸»é¡µæ ‡ç­¾
                val homeTab = manager.getAllTabs().find { it.url == "home://functional" }
                if (homeTab != null) {
                    val index = manager.getAllTabs().indexOf(homeTab)
                    manager.switchToTab(index)
                } else {
                    // å¦‚æœæ²¡æœ‰åŠŸèƒ½ä¸»é¡µï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„
                    manager.addTab("home://functional")
                }
                return
            }
            
            // ä½¿ç”¨MultiPageWebViewManager
            multiPageWebViewManager?.let { manager ->
                // æŸ¥æ‰¾ä¸»é¡µ
                val allPages = manager.getAllPages()
                val homePage = allPages.find { it.url == "home://functional" }
                if (homePage != null) {
                    val index = allPages.indexOf(homePage)
                    manager.switchToPage(index)
                } else {
                    // å¦‚æœæ²¡æœ‰ä¸»é¡µï¼ŒåŠ è½½ä¸»é¡µ
                    manager.loadUrl("home://functional")
                }
                return
            }
            
            // ä½¿ç”¨å½“å‰WebViewåŠ è½½ä¸»é¡µ
            val currentWebView = getCurrentWebViewForScrollCheck()
            currentWebView?.loadUrl("home://functional")
        } catch (e: Exception) {
            Log.e(TAG, "å›åˆ°ä¸»é¡µå¤±è´¥", e)
            showMaterialToast("å›åˆ°ä¸»é¡µå¤±è´¥")
        }
    }

    /**
     * è·å–å½“å‰WebViewç”¨äºæ»šåŠ¨æ£€æŸ¥
     */
    private fun getCurrentWebViewForScrollCheck(): android.webkit.WebView? {
        return try {
            // ä¼˜å…ˆä½¿ç”¨PaperStackWebViewManagerï¼ˆæœç´¢tabä¸»è¦ä½¿ç”¨è¿™ä¸ªï¼‰
            paperStackWebViewManager?.getCurrentTab()?.webView
                ?: multiPageWebViewManager?.getCurrentPage()?.webView
                ?: mobileCardManager?.getCurrentCard()?.webView
                ?: gestureCardWebViewManager?.getCurrentCard()?.webView
        } catch (e: Exception) {
            Log.e(TAG, "è·å–å½“å‰WebViewå¤±è´¥", e)
            null
        }
    }

    /**
     * è®¾ç½®å·¥å…·æ è‡ªåŠ¨éšè—åŠŸèƒ½
     */
    private fun setupToolbarAutoHide() {
        try {
            // ä¸ºWebViewå®¹å™¨ä¸­çš„æ‰€æœ‰WebViewæ·»åŠ æ»šåŠ¨ç›‘å¬
            setupWebViewScrollListener()

            // çº¸å †æ¨¡å¼è¡¥å……ï¼šå¯¹å·²æœ‰ä¸åç»­æ ‡ç­¾é™„åŠ æ»šåŠ¨ç›‘å¬ï¼Œç¡®ä¿é¡¶éƒ¨æ è”åŠ¨
            try {
                paperStackWebViewManager?.getAllTabs()?.forEach { tab ->
                    addScrollListenerToWebView(tab.webView)
                }
                paperStackWebViewManager?.setOnTabCreatedListener { tab ->
                    addScrollListenerToWebView(tab.webView)
                }
                paperStackWebViewManager?.setOnTabSwitchedListener { tab, _ ->
                    addScrollListenerToWebView(tab.webView)
                }
            } catch (_: Exception) {}

            Log.d(TAG, "å·¥å…·æ è‡ªåŠ¨éšè—åŠŸèƒ½è®¾ç½®å®Œæˆ")

        } catch (e: Exception) {
            Log.e(TAG, "è®¾ç½®å·¥å…·æ è‡ªåŠ¨éšè—åŠŸèƒ½å¤±è´¥", e)
        }
    }

    /**
     * è®¾ç½®WebViewæ»šåŠ¨ç›‘å¬å™¨
     */
    private fun setupWebViewScrollListener() {
        try {
            // ä¸ºç°æœ‰çš„WebViewç®¡ç†å™¨è®¾ç½®å›è°ƒï¼Œåœ¨WebViewåˆ›å»ºæ—¶æ·»åŠ æ»šåŠ¨ç›‘å¬
            gestureCardWebViewManager?.setOnWebViewCreatedListener { webView ->
                addScrollListenerToWebView(webView)
            }

            mobileCardManager?.setOnWebViewCreatedListener { webView ->
                addScrollListenerToWebView(webView)
            }

            // ä¸ºå½“å‰å·²å­˜åœ¨çš„WebViewæ·»åŠ æ»šåŠ¨ç›‘å¬å™¨
            addScrollListenerToExistingWebViews()

            Log.d(TAG, "WebViewæ»šåŠ¨ç›‘å¬å™¨è®¾ç½®å®Œæˆ")

        } catch (e: Exception) {
            Log.e(TAG, "è®¾ç½®WebViewæ»šåŠ¨ç›‘å¬å™¨å¤±è´¥", e)
        }
    }

    /**
     * ä¸ºç°æœ‰çš„WebViewæ·»åŠ æ»šåŠ¨ç›‘å¬å™¨
     */
    private fun addScrollListenerToExistingWebViews() {
        try {
            // ä¸ºGestureCardWebViewManagerä¸­çš„ç°æœ‰WebViewæ·»åŠ ç›‘å¬å™¨
            gestureCardWebViewManager?.getAllCards()?.forEach { card ->
                card.webView?.let { webView ->
                    addScrollListenerToWebView(webView)
                }
            }

            // ä¸ºMobileCardManagerä¸­çš„ç°æœ‰WebViewæ·»åŠ ç›‘å¬å™¨
            mobileCardManager?.getAllCards()?.forEach { card ->
                card.webView?.let { webView ->
                    addScrollListenerToWebView(webView)
                }
            }

            Log.d(TAG, "ä¸ºç°æœ‰WebViewæ·»åŠ æ»šåŠ¨ç›‘å¬å™¨å®Œæˆ")

        } catch (e: Exception) {
            Log.e(TAG, "ä¸ºç°æœ‰WebViewæ·»åŠ æ»šåŠ¨ç›‘å¬å™¨å¤±è´¥", e)
        }
    }

    /**
     * ä¸ºWebViewæ·»åŠ æ»šåŠ¨ç›‘å¬å™¨
     * ğŸ”§ ä¿®å¤2ï¼šç¡®ä¿åœ¨æœç´¢tabä¸­ä¸Šæ»‘æ—¶èƒ½è‡ªåŠ¨éšè—æ ‡é¢˜æ å’Œåº•éƒ¨æ ï¼Œæµ®ç°æ‚¬æµ®å·¥å…·æ 
     */
    private fun addScrollListenerToWebView(webView: android.webkit.WebView) {
        try {
            webView.setOnScrollChangeListener { _, _, scrollY, _, oldScrollY ->
                val deltaY = scrollY - oldScrollY

                // ğŸ”§ ä¼˜åŒ–ï¼šç¡®ä¿åœ¨æœç´¢tabä¸­ä¹Ÿèƒ½æ­£å¸¸å·¥ä½œï¼Œæ’é™¤æ‚¬æµ®å¡ç‰‡é¢„è§ˆçŠ¶æ€å’Œé®ç½©å±‚æ¿€æ´»çŠ¶æ€
                val isStackedPreviewVisible = stackedCardPreview?.visibility == View.VISIBLE
                // ğŸ”§ ä¼˜åŒ–ï¼šå¢åŠ é˜ˆå€¼å’Œç´¯è®¡æ£€æŸ¥ï¼Œé¿å…å°å¹…æ³¢åŠ¨è§¦å‘åŠ¨ç”»
                if (Math.abs(deltaY) > 3 && !isSearchTabGestureOverlayActive && !isStackedPreviewVisible) {
                    handleWebViewScroll(deltaY, scrollY)
                }
            }

            Log.d(TAG, "ä¸ºWebViewæ·»åŠ æ»šåŠ¨ç›‘å¬å™¨æˆåŠŸ")

        } catch (e: Exception) {
            Log.e(TAG, "ä¸ºWebViewæ·»åŠ æ»šåŠ¨ç›‘å¬å™¨å¤±è´¥", e)
        }
    }

    // ğŸ”§ ä¼˜åŒ–ï¼šæ·»åŠ é˜²æŠ–æœºåˆ¶ï¼Œé¿å…é¢‘ç¹è§¦å‘åŠ¨ç”»
    private var lastScrollTime = 0L
    private val scrollDebounceDelay = 200L // 200msé˜²æŠ–å»¶è¿Ÿï¼Œé¿å…é¢‘ç¹è§¦å‘å¯¼è‡´æŠ–åŠ¨
    private var accumulatedScrollY = 0 // ç´¯è®¡æ»šåŠ¨è·ç¦»ï¼Œç”¨äºåˆ¤æ–­æ˜¯å¦è¾¾åˆ°é˜ˆå€¼
    private val scrollAccumulateThreshold = 50 // ç´¯è®¡æ»šåŠ¨é˜ˆå€¼ï¼Œå¢åŠ åˆ°50pxé¿å…å°å¹…æ³¢åŠ¨è§¦å‘åŠ¨ç”»
    private var isScrollAnimationRunning = false // æ ‡è®°æ»šåŠ¨åŠ¨ç”»æ˜¯å¦æ­£åœ¨è¿è¡Œï¼Œé¿å…é‡å¤è§¦å‘
    private var isUIPermanentlyHidden = false // æ ‡å¿—ï¼šæœç´¢tabä¸­UIæ˜¯å¦å·²è¢«å‘ä¸‹æ»šåŠ¨æ°¸ä¹…éšè—
    private var lastHideUITime = 0L // è®°å½•ä¸Šæ¬¡éšè—UIçš„æ—¶é—´ï¼Œç”¨äºé˜²æ­¢ç«‹å³é‡æ–°æ˜¾ç¤º
    private val hideUIProtectionPeriod = 500L // UIéšè—åçš„ä¿æŠ¤æœŸï¼ˆæ¯«ç§’ï¼‰ï¼Œåœ¨æ­¤æœŸé—´å¿½ç•¥å‘ä¸Šæ»šåŠ¨æ˜¾ç¤ºUIçš„é€»è¾‘
    
    /**
     * å¤„ç†WebViewæ»šåŠ¨äº‹ä»¶
     * ğŸ”§ ä¼˜åŒ–ï¼šç¡®ä¿åŠ¨ç”»æµç•…è‡ªç„¶ï¼Œæ·»åŠ é˜²æŠ–æœºåˆ¶ï¼Œä¼˜åŒ–è§¦å‘æ—¶æœº
     */
    private fun handleWebViewScroll(deltaY: Int, scrollY: Int) {
        try {
            val currentTime = System.currentTimeMillis()
            
            // ğŸ”§ ä¼˜åŒ–ï¼šå¦‚æœåŠ¨ç”»æ­£åœ¨è¿è¡Œï¼Œè·³è¿‡å¤„ç†ï¼Œé¿å…æŠ–åŠ¨
            if (isScrollAnimationRunning) {
                return
            }
            
            // ğŸ”§ ä¼˜åŒ–ï¼šæ·»åŠ é˜²æŠ–æœºåˆ¶ï¼Œé¿å…é¢‘ç¹è§¦å‘
            if (currentTime - lastScrollTime < scrollDebounceDelay) {
                // åœ¨é˜²æŠ–æœŸé—´ï¼Œç»§ç»­ç´¯è®¡æ»šåŠ¨è·ç¦»
                if ((deltaY > 0 && accumulatedScrollY >= 0) || (deltaY < 0 && accumulatedScrollY <= 0)) {
                    accumulatedScrollY += deltaY
                } else {
                    accumulatedScrollY = deltaY
                }
                return
            }
            lastScrollTime = currentTime
            
            // ğŸ”§ ä¼˜åŒ–ï¼šä½¿ç”¨ç´¯è®¡æ»šåŠ¨è·ç¦»ï¼Œé¿å…å°å¹…æ³¢åŠ¨è§¦å‘åŠ¨ç”»
            // ç´¯è®¡æ»šåŠ¨è·ç¦»ï¼ŒåŒæ–¹å‘ç´¯åŠ ï¼Œåæ–¹å‘é‡ç½®
            if ((deltaY > 0 && accumulatedScrollY >= 0) || (deltaY < 0 && accumulatedScrollY <= 0)) {
                accumulatedScrollY += deltaY
            } else {
                // æ–¹å‘æ”¹å˜ï¼Œé‡ç½®ç´¯è®¡å€¼
                accumulatedScrollY = deltaY
            }
            
            // ğŸ”§ è·å–å½“å‰WebViewï¼Œæ£€æŸ¥æ˜¯å¦åœ¨é˜…è¯»æ¨¡å¼
            val currentWebView = paperStackWebViewManager?.getCurrentTab()?.webView
            val isReaderMode = currentWebView?.let { webView ->
                globalReaderModeManager?.isReaderModeActive() == true
            } ?: false
            
            // ğŸ”§ æ£€æŸ¥æ˜¯å¦æ»šåŠ¨åˆ°åº•éƒ¨ï¼ˆç”¨äºé˜…è¯»æ¨¡å¼ï¼‰
            val isAtBottom = currentWebView?.let { webView ->
                val contentHeight = webView.contentHeight
                val scrollHeight = webView.height
                // ä½¿ç”¨ä¼ å…¥çš„scrollYå‚æ•°ï¼Œè€Œä¸æ˜¯webView.scrollY
                // å¦‚æœæ»šåŠ¨ä½ç½®æ¥è¿‘åº•éƒ¨ï¼ˆè·ç¦»åº•éƒ¨å°äº50pxï¼‰ï¼Œè®¤ä¸ºåœ¨åº•éƒ¨
                (contentHeight - scrollHeight - scrollY) < 50
            } ?: false
            
            // ğŸ”§ æ£€æŸ¥æ˜¯å¦åœ¨é¡µé¢é¡¶éƒ¨ï¼ˆç”¨äºéé˜…è¯»æ¨¡å¼ï¼‰
            val isAtTop = scrollY <= 10 // å…è®¸10pxçš„è¯¯å·®
            
            // ==================== é˜…è¯»æ¨¡å¼ä¸‹çš„æ»šåŠ¨æ§åˆ¶é€»è¾‘ ====================
            // ç›®æ ‡ï¼šä¸‹æ»‘æ—¶æœ€å¤§åŒ–é˜…è¯»ç©ºé—´ï¼Œä¸Šæ»‘æˆ–åˆ°åº•éƒ¨æ—¶æ˜¾ç¤ºæ“ä½œæ§ä»¶
            //
            // éœ€è¦æ§åˆ¶çš„ç»„ä»¶ï¼š
            // 1. é¡¶éƒ¨headerï¼ˆHTMLä¸­çš„reader-headerï¼‰ï¼šæ ‡é¢˜å’ŒæŒ‰é’®ï¼ˆç›®å½•ã€ä¸Šä¸€ç« ã€ä¸‹ä¸€ç« ã€é€€å‡ºï¼‰- ç”±HTML JavaScriptæ§åˆ¶
            // 2. åº•éƒ¨åœ°å€è¾“å…¥æ ï¼ˆbrowserToolbarï¼‰ï¼šæœç´¢è¾“å…¥æ¡†å’Œåœ°å€æ 
            // 3. åº•éƒ¨tabæ ï¼ˆbottom_navigationï¼‰ï¼šå¯¹è¯ã€æœç´¢ã€AIåŠ©æ‰‹ç­‰tab - é˜…è¯»æ¨¡å¼ä¸‹å¿…é¡»å®Œå…¨éšè—
            // 4. æ‚¬æµ®å·¥å…·æ ï¼ˆbrowserQuickActionsBarï¼‰ï¼šç¼©æ”¾ç­‰å¿«æ·æ“ä½œ
            //
            // ä¸‹æ»‘æ—¶ï¼ˆå‘ä¸‹æ»šåŠ¨ï¼‰ï¼šéšè—æ‰€æœ‰UIå…ƒç´ ï¼Œæœ€å¤§åŒ–é˜…è¯»ç©ºé—´
            // ä¸Šæ»‘æ—¶ï¼ˆå‘ä¸Šæ»šåŠ¨ï¼‰æˆ–æ»šåŠ¨åˆ°åº•éƒ¨ï¼šæ˜¾ç¤ºæ“ä½œæ§ä»¶ï¼Œæ–¹ä¾¿ç”¨æˆ·æ“ä½œ
            
            if (isReaderMode && currentState == UIState.BROWSER) {
                // ========== é˜…è¯»æ¨¡å¼ä¸“ç”¨é€»è¾‘ ==========
                
                // ğŸ”§ å¼ºåˆ¶ç¡®ä¿åº•éƒ¨tabæ å§‹ç»ˆéšè—ï¼ˆé˜…è¯»æ¨¡å¼ä¸‹å¿…é¡»å®Œå…¨å±è”½ï¼‰
                val bottomNav = findViewById<LinearLayout>(R.id.bottom_navigation)
                if (bottomNav != null && bottomNav.visibility != View.GONE) {
                    bottomNav.visibility = View.GONE
                    bottomNav.alpha = 0f
                    isBottomNavVisible = false
                }
                
                // ä¸‹æ»‘æ—¶ï¼šéšè—æ‰€æœ‰UIå…ƒç´ ï¼Œæœ€å¤§åŒ–é˜…è¯»ç©ºé—´
                if (accumulatedScrollY > scrollAccumulateThreshold) {
                    val scrollValue = accumulatedScrollY
                    accumulatedScrollY = 0 // é‡ç½®ç´¯è®¡å€¼
                    
                    // éšè—åº•éƒ¨åœ°å€è¾“å…¥æ 
                    if (isToolbarVisible) {
                        hideToolbarOnly()
                    }
                    
                    // éšè—æ‚¬æµ®å·¥å…·æ 
                    if (isQuickActionsBarVisible) {
                        showBottomNavigationAndHideQuickActions()
                    }
                    
                    // é¡¶éƒ¨headerç”±HTMLä¸­çš„JavaScriptæ§åˆ¶ï¼Œä¼šè‡ªåŠ¨éšè—
                    
                    Log.d(TAG, "ğŸ“– é˜…è¯»æ¨¡å¼-ä¸‹æ»‘ï¼šéšè—æ‰€æœ‰UIå…ƒç´ ï¼Œæœ€å¤§åŒ–é˜…è¯»ç©ºé—´ï¼Œç´¯è®¡deltaY=$scrollValue")
                    return
                }
                
                // ä¸Šæ»‘æ—¶æˆ–æ»šåŠ¨åˆ°åº•éƒ¨ï¼šæ˜¾ç¤ºæ“ä½œæ§ä»¶
                if (accumulatedScrollY < -scrollAccumulateThreshold || isAtBottom) {
                    val scrollValue = accumulatedScrollY
                    accumulatedScrollY = 0 // é‡ç½®ç´¯è®¡å€¼
                    
                    // æ˜¾ç¤ºåº•éƒ¨åœ°å€è¾“å…¥æ 
                    if (!isToolbarVisible) {
                        showToolbar()
                    }
                    
                    // æ˜¾ç¤ºæ‚¬æµ®å·¥å…·æ 
                    if (!isQuickActionsBarVisible) {
                        hideBottomNavigationAndShowQuickActions()
                    }
                    
                    // é¡¶éƒ¨headerç”±HTMLä¸­çš„JavaScriptæ§åˆ¶ï¼Œä¼šè‡ªåŠ¨æ˜¾ç¤º
                    
                    Log.d(TAG, "ğŸ“– é˜…è¯»æ¨¡å¼-ä¸Šæ»‘æˆ–åˆ°åº•éƒ¨ï¼šæ˜¾ç¤ºæ“ä½œæ§ä»¶ï¼Œç´¯è®¡deltaY=$scrollValue, åˆ°åº•éƒ¨=$isAtBottom")
                    return
                }
                
                // å¦‚æœæ»šåŠ¨è·ç¦»ä¸å¤Ÿï¼Œä¸å¤„ç†
                return
            }
            
            // ==================== éé˜…è¯»æ¨¡å¼çš„æ»šåŠ¨æ§åˆ¶é€»è¾‘ ====================
            // ğŸ”§ ä¼˜åŒ–ï¼šæœç´¢tabä¸­ï¼Œä¸‹æ»‘æ—¶éšè—tabæ å’Œåœ°å€æ ï¼Œæ˜¾ç¤ºæ‚¬æµ®å·¥å…·æ ï¼›ä¸Šæ»‘æ—¶ä¸æ˜¾ç¤ºtabæ å’Œåœ°å€æ ï¼Œåªæœ‰æ»šåŠ¨åˆ°é¡¶éƒ¨æ‰æ˜¾ç¤º
            // ğŸ”§ ä¼˜åŒ–ï¼šåœ¨é¡µé¢é¡¶éƒ¨æ—¶ï¼Œå¼ºåˆ¶æ˜¾ç¤ºtabæ å’Œåœ°å€æ ï¼Œå¹¶æ¸…é™¤æ°¸ä¹…éšè—æ ‡å¿—
            // ğŸ”§ ä¼˜åŒ–ï¼šç¡®ä¿ç»„ä»¶æœ‰åºæ˜¾ç¤º/éšè—ï¼Œé¿å…æŠ–åŠ¨
            if (isAtTop && currentState == UIState.BROWSER) {
                // åœ¨é¡µé¢é¡¶éƒ¨æ—¶ï¼Œæ¸…é™¤æ°¸ä¹…éšè—æ ‡å¿—å’Œä¿æŠ¤æœŸï¼Œç¡®ä¿æ˜¾ç¤ºtabæ å’Œåœ°å€æ ï¼Œéšè—æ‚¬æµ®å·¥å…·æ 
                isUIPermanentlyHidden = false // æ¸…é™¤æ°¸ä¹…éšè—æ ‡å¿—
                lastHideUITime = 0L // æ¸…é™¤ä¿æŠ¤æœŸæ—¶é—´æˆ³
                if (!isToolbarVisible || !isBottomNavVisible || isQuickActionsBarVisible) {
                    isScrollAnimationRunning = true
                    // å…ˆæ˜¾ç¤ºåœ°å€æ 
                    if (!isToolbarVisible) {
                        showToolbar()
                    }
                    // å†æ˜¾ç¤ºtabæ ï¼Œéšè—æ‚¬æµ®å·¥å…·æ 
                    if (!isBottomNavVisible) {
                        showBottomNavigationAndHideQuickActions()
                    } else if (isQuickActionsBarVisible) {
                        hideQuickActionsBar()
                    }
                    // åŠ¨ç”»å®Œæˆåé‡ç½®æ ‡å¿—
                    Handler(Looper.getMainLooper()).postDelayed({
                        isScrollAnimationRunning = false
                    }, 300)
                }
                accumulatedScrollY = 0 // é‡ç½®ç´¯è®¡å€¼
                Log.d(TAG, "ğŸ”§ éé˜…è¯»æ¨¡å¼-é¡µé¢é¡¶éƒ¨ï¼šå¼ºåˆ¶æ˜¾ç¤ºåœ°å€æ å’Œtabæ ï¼Œéšè—æ‚¬æµ®å·¥å…·æ ")
                return
            }
            
            // å‘ä¸‹æ»šåŠ¨ï¼šæ°¸ä¹…éšè—UIï¼Œéšè—åœ°å€æ å’Œtabæ 
            // ğŸ”§ ä¿®å¤ï¼šå‘ä¸‹æ»šåŠ¨æ—¶è®¾ç½®æ°¸ä¹…éšè—æ ‡å¿—å¹¶éšè—UI
            if (accumulatedScrollY > scrollAccumulateThreshold && currentState == UIState.BROWSER) {
                // å¦‚æœæ­£åœ¨å‘ä¸‹æ»šåŠ¨ï¼ˆç´¯è®¡å€¼ä¸ºæ­£ï¼‰ï¼Œä¸”UIè¿˜æœªéšè—ï¼Œç«‹å³éšè—
                if (isToolbarVisible || isBottomNavVisible) {
                    val scrollValue = accumulatedScrollY
                    accumulatedScrollY = 0 // é‡ç½®ç´¯è®¡å€¼
                    
                    // éé˜…è¯»æ¨¡å¼-ä¸‹æ»‘ï¼šéšè—åœ°å€æ å’Œtabæ ï¼Œæ˜¾ç¤ºæ‚¬æµ®å·¥å…·æ ï¼Œå¹¶è®¾ç½®æ°¸ä¹…éšè—æ ‡å¿—
                    // ğŸ”§ ä¼˜åŒ–ï¼šç¡®ä¿æœ‰åºéšè—ï¼Œå…ˆéšè—åœ°å€æ ï¼Œå†éšè—tabæ å¹¶æ˜¾ç¤ºæ‚¬æµ®å·¥å…·æ 
                    isScrollAnimationRunning = true
                    
                    // å…ˆéšè—åœ°å€æ 
                    if (isToolbarVisible) {
                        hideToolbarOnly()
                    }
                    // å†éšè—tabæ å¹¶æ˜¾ç¤ºæ‚¬æµ®å·¥å…·æ 
                    if (isBottomNavVisible) {
                        hideBottomNavigationAndShowQuickActions()
                    } else if (!isQuickActionsBarVisible) {
                        // å¦‚æœtabæ å·²éšè—ä½†æ‚¬æµ®å·¥å…·æ æœªæ˜¾ç¤ºï¼Œç›´æ¥æ˜¾ç¤ºæ‚¬æµ®å·¥å…·æ 
                        showQuickActionsBar()
                        Handler(Looper.getMainLooper()).postDelayed({
                            isScrollAnimationRunning = false
                        }, 300)
                    } else {
                        // å¦‚æœéƒ½å·²ç»éšè—/æ˜¾ç¤ºï¼Œç›´æ¥é‡ç½®æ ‡å¿—
                        Handler(Looper.getMainLooper()).postDelayed({
                            isScrollAnimationRunning = false
                        }, 100)
                    }
                    
                    // è®¾ç½®æ°¸ä¹…éšè—æ ‡å¿—ï¼Œé˜²æ­¢ä¸Šæ»‘æ—¶é‡æ–°æ˜¾ç¤º
                    isUIPermanentlyHidden = true
                    // è®°å½•éšè—UIçš„æ—¶é—´ï¼Œç”¨äºä¿æŠ¤æœŸåˆ¤æ–­
                    lastHideUITime = System.currentTimeMillis()
                    
                    Log.d(TAG, "ğŸ”§ éé˜…è¯»æ¨¡å¼-ä¸‹æ»‘ï¼šæ°¸ä¹…éšè—UIï¼Œéšè—åœ°å€æ å’Œtabæ ï¼Œæ˜¾ç¤ºæ‚¬æµ®å·¥å…·æ ï¼Œç´¯è®¡deltaY=$scrollValue")
                    return
                }
            }
            
            // å‘ä¸Šæ»šåŠ¨ï¼šå–æ¶ˆéšè—UIï¼Œæ˜¾ç¤ºåœ°å€æ å’Œtabæ 
            // ğŸ”§ ä¿®å¤ï¼šå‘ä¸Šæ»šåŠ¨æ—¶æ¸…é™¤æ°¸ä¹…éšè—æ ‡å¿—å¹¶æ˜¾ç¤ºUI
            if ((accumulatedScrollY < -scrollAccumulateThreshold || isAtBottom) && currentState == UIState.BROWSER) {
                val scrollValue = accumulatedScrollY
                accumulatedScrollY = 0 // é‡ç½®ç´¯è®¡å€¼
                
                // æ¸…é™¤æ°¸ä¹…éšè—æ ‡å¿—ï¼Œå–æ¶ˆéšè—UIï¼ˆç”¨æˆ·å‘ä¸Šæ»šåŠ¨ï¼Œè¡¨ç¤ºæƒ³è¦æ“ä½œï¼‰
                isUIPermanentlyHidden = false
                
                // éé˜…è¯»æ¨¡å¼-ä¸Šæ»‘ï¼šæ˜¾ç¤ºåœ°å€æ å’Œtabæ ï¼Œéšè—æ‚¬æµ®å·¥å…·æ 
                // ğŸ”§ ä¼˜åŒ–ï¼šç¡®ä¿æœ‰åºæ˜¾ç¤ºï¼Œå…ˆæ˜¾ç¤ºåœ°å€æ ï¼Œå†æ˜¾ç¤ºtabæ å¹¶éšè—æ‚¬æµ®å·¥å…·æ 
                isScrollAnimationRunning = true
                
                // å…ˆæ˜¾ç¤ºåœ°å€æ 
                if (!isToolbarVisible) {
                    showToolbar()
                } else {
                    // å¦‚æœå·¥å…·æ å·²æ˜¾ç¤ºï¼Œç¡®ä¿ç»„æ ‡ç­¾æ ä¹Ÿæ˜¾ç¤º
                    groupTabsContainer?.let { container ->
                        if (container.visibility != View.VISIBLE) {
                            container.visibility = View.VISIBLE
                            container.alpha = 1f
                            container.translationY = 0f
                            Log.d(TAG, "ğŸ”§ ä¸Šæ»‘æ—¶æ¢å¤ç»„æ ‡ç­¾æ æ˜¾ç¤º")
                        }
                    }
                }
                // å†æ˜¾ç¤ºtabæ å¹¶éšè—æ‚¬æµ®å·¥å…·æ 
                if (!isBottomNavVisible) {
                    showBottomNavigationAndHideQuickActions()
                } else if (isQuickActionsBarVisible) {
                    // å¦‚æœtabæ å·²æ˜¾ç¤ºä½†æ‚¬æµ®å·¥å…·æ æœªéšè—ï¼Œç›´æ¥éšè—æ‚¬æµ®å·¥å…·æ 
                    hideQuickActionsBar()
                    Handler(Looper.getMainLooper()).postDelayed({
                        isScrollAnimationRunning = false
                    }, 300)
                } else {
                    // å¦‚æœéƒ½å·²ç»æ˜¾ç¤º/éšè—ï¼Œç›´æ¥é‡ç½®æ ‡å¿—
                    Handler(Looper.getMainLooper()).postDelayed({
                        isScrollAnimationRunning = false
                    }, 100)
                }
                
                Log.d(TAG, "ğŸ”§ éé˜…è¯»æ¨¡å¼-ä¸Šæ»‘ï¼šå–æ¶ˆéšè—UIï¼Œæ˜¾ç¤ºåœ°å€æ å’Œtabæ ï¼Œéšè—æ‚¬æµ®å·¥å…·æ ï¼Œç´¯è®¡deltaY=$scrollValue, åˆ°åº•éƒ¨=$isAtBottom")
                return
            }

        } catch (e: Exception) {
            Log.e(TAG, "å¤„ç†WebViewæ»šåŠ¨äº‹ä»¶å¤±è´¥", e)
        }
    }
    
    /**
     * åŒæ­¥éšè—åº•éƒ¨å¯¼èˆªæ å¹¶æ˜¾ç¤ºå¿«æ·æ“ä½œæ 
     */
    private fun hideBottomNavigationAndShowQuickActions() {
        try {
            val bottomNav = findViewById<LinearLayout>(R.id.bottom_navigation)
            if (bottomNav == null || !isBottomNavVisible) {
                // å¦‚æœåº•éƒ¨å¯¼èˆªæ ä¸å­˜åœ¨æˆ–å·²éšè—ï¼Œç›´æ¥æ˜¾ç¤ºå¿«æ·æ“ä½œæ 
                showQuickActionsBar()
                return
            }
            
            isBottomNavVisible = false
            isQuickActionsBarVisible = true
            
            // å–æ¶ˆä¹‹å‰çš„åŠ¨ç”»
            bottomNavAnimator?.cancel()
            quickActionsBarAnimator?.cancel()
            
            val navHeight = bottomNav.height.toFloat()
            if (navHeight <= 0f) {
                bottomNav.visibility = View.GONE
                showQuickActionsBar()
                return
            }
            
            // ğŸ”§ ä¿®å¤ï¼šç›´æ¥è®¾ç½®åˆå§‹ä½ç½®åœ¨åº•éƒ¨ä¸‹æ–¹ï¼Œé¿å…ä»tabåŒºåŸŸä¸Šæ–¹ä¸‹æ»‘çš„åŠ¨ç”»
            // 1. å…ˆè®¾ç½®ä¸ºVISIBLEä½†alphaä¸º0ï¼Œè®©ç³»ç»Ÿå®Œæˆå¸ƒå±€ï¼ˆlayout_gravity="bottom"ä¼šç”Ÿæ•ˆï¼‰
            // 2. ç«‹å³è®¾ç½®translationYä¸ºåº•éƒ¨ä¸‹æ–¹ï¼Œé¿å…å…ˆå‡ºç°åœ¨é”™è¯¯ä½ç½®
            // 3. ç„¶åå¼€å§‹ä»åº•éƒ¨å¾€ä¸Šæµ®çš„åŠ¨ç”»
            if (browserQuickActionsBar.visibility == View.GONE) {
                // å…ˆè®¾ç½®ä¸ºVISIBLEä½†å®Œå…¨é€æ˜ï¼Œè®©ç³»ç»Ÿå®Œæˆå¸ƒå±€
                browserQuickActionsBar.alpha = 0f
                browserQuickActionsBar.visibility = View.VISIBLE
            }
            
            // ç­‰å¾…å¸ƒå±€å®Œæˆåå†è®¾ç½®åˆå§‹ä½ç½®å’ŒåŠ¨ç”»
            browserQuickActionsBar.post {
                // å†ç­‰å¾…ä¸€å¸§ï¼Œç¡®ä¿å¸ƒå±€å®Œå…¨å®Œæˆ
                browserQuickActionsBar.post {
                    // å¼ºåˆ¶æµ‹é‡å¸ƒå±€ï¼Œç¡®ä¿é«˜åº¦å‡†ç¡®
                    browserQuickActionsBar.measure(
                        View.MeasureSpec.makeMeasureSpec(browserQuickActionsBar.width, View.MeasureSpec.EXACTLY),
                        View.MeasureSpec.makeMeasureSpec(0, View.MeasureSpec.UNSPECIFIED)
                    )
                    
                    val quickBarHeight = browserQuickActionsBar.measuredHeight.toFloat()
                    if (quickBarHeight <= 0f) {
                        Log.w(TAG, "å¿«æ·æ“ä½œæ é«˜åº¦ä¸º0ï¼Œä½¿ç”¨é»˜è®¤å€¼")
                        showQuickActionsBar() // å›é€€åˆ°å•ç‹¬æ˜¾ç¤º
                        return@post
                    }
                    
                    // ğŸ”§ å…³é”®ä¿®å¤ï¼šç«‹å³è®¾ç½®translationYä¸ºåº•éƒ¨ä¸‹æ–¹ï¼Œé¿å…å…ˆå‡ºç°åœ¨tabåŒºåŸŸä¸Šæ–¹
                    // è¿™æ ·æ“ä½œå·¥å…·æ ä¼šç›´æ¥ä»åº•éƒ¨ä¸‹æ–¹å¾€ä¸Šæµ®ï¼Œä¸ä¼šæœ‰ä¸‹æ»‘çš„åŠ¨ç”»
                    val startY = quickBarHeight // ä»å±å¹•åº•éƒ¨ä¸‹æ–¹å¼€å§‹
                    browserQuickActionsBar.translationY = startY
                    browserQuickActionsBar.alpha = 0f
                    
                    // åˆ›å»ºåŒæ­¥åŠ¨ç”»
                    val animatorSet = android.animation.AnimatorSet()
                    
                    // ğŸ”§ ä¼˜åŒ–ï¼šä½¿ç”¨iOSé£æ ¼çš„æµç•…åŠ¨ç”»
                    // åº•éƒ¨å¯¼èˆªæ å‘ä¸‹ç§»åŠ¨å¹¶æ·¡å‡º
                    val navAnimator = android.animation.ValueAnimator.ofFloat(0f, 1f).apply {
                        duration = 280L // ğŸ”§ ä¼˜åŒ–ï¼šç»Ÿä¸€åŠ¨ç”»æ—¶é•¿ä¸º280ms
                        // ğŸ”§ ä¼˜åŒ–ï¼šä½¿ç”¨iOSé£æ ¼çš„ç¼“åŠ¨æ›²çº¿
                        interpolator = android.view.animation.PathInterpolator(0.25f, 0.1f, 0.25f, 1.0f)
                        addUpdateListener { anim ->
                            val progress = anim.animatedValue as Float
                            // ğŸ”§ ä¼˜åŒ–ï¼šä½¿ç”¨å¹³æ»‘çš„ç¼“åŠ¨å‡½æ•°
                            val easedProgress = progress * progress * (3f - 2f * progress)
                            bottomNav.translationY = navHeight * easedProgress
                            bottomNav.alpha = 1f - easedProgress // å®Œå…¨æ·¡å‡ºï¼Œé¿å…æ— æ•ˆå›¾å½¢
                        }
                        addListener(object : android.animation.AnimatorListenerAdapter() {
                            override fun onAnimationEnd(animation: android.animation.Animator) {
                                bottomNav.translationY = navHeight
                                bottomNav.alpha = 0f
                                bottomNav.visibility = View.GONE
                                // ğŸ”§ ä¼˜åŒ–ï¼šåŠ¨ç”»å®Œæˆåé‡ç½®æ»šåŠ¨åŠ¨ç”»æ ‡å¿—
                                isScrollAnimationRunning = false
                            }
                        })
                    }
                    
                    // ğŸ”§ ä¼˜åŒ–ï¼šå¿«æ·æ“ä½œæ ä»åº•éƒ¨å¾€ä¸Šæµ®ç°ï¼ˆè€Œä¸æ˜¯ä»é«˜å¤„è½ä¸‹ï¼‰
                    // åˆå§‹ä½ç½®å·²ç»åœ¨ä¸Šé¢è®¾ç½®å¥½äº†ï¼ˆå±å¹•åº•éƒ¨ä¸‹æ–¹ï¼‰ï¼Œè¿™é‡Œç›´æ¥å¼€å§‹åŠ¨ç”»
                    
                    val quickBarAnimator = android.animation.ValueAnimator.ofFloat(0f, 1f).apply {
                        duration = 280L // ğŸ”§ ä¼˜åŒ–ï¼šç»Ÿä¸€åŠ¨ç”»æ—¶é•¿ä¸º280ms
                        // ğŸ”§ ä¼˜åŒ–ï¼šä½¿ç”¨iOSé£æ ¼çš„ç¼“åŠ¨æ›²çº¿
                        interpolator = android.view.animation.PathInterpolator(0.25f, 0.1f, 0.25f, 1.0f)
                        addUpdateListener { anim ->
                            val progress = anim.animatedValue as Float
                            // ğŸ”§ ä¼˜åŒ–ï¼šä½¿ç”¨å¹³æ»‘çš„ç¼“åŠ¨å‡½æ•°
                            val easedProgress = progress * progress * (3f - 2f * progress)
                            browserQuickActionsBar.alpha = easedProgress
                            // ğŸ”§ ä¼˜åŒ–ï¼šä»åº•éƒ¨ä¸‹æ–¹ï¼ˆstartYï¼‰å¾€ä¸Šæµ®ç°åˆ°å±å¹•åº•éƒ¨ï¼ˆ0ï¼‰
                            browserQuickActionsBar.translationY = startY * (1f - easedProgress)
                        }
                        addListener(object : android.animation.AnimatorListenerAdapter() {
                            override fun onAnimationEnd(animation: android.animation.Animator) {
                                // ç¡®ä¿æœ€ç»ˆä½ç½®ç²¾ç¡®ä¸º0ï¼Œé¿å…åå·®
                                browserQuickActionsBar.translationY = 0f
                                browserQuickActionsBar.alpha = 1f
                                // ğŸ”§ ä¼˜åŒ–ï¼šåŠ¨ç”»å®Œæˆåé‡ç½®æ»šåŠ¨åŠ¨ç”»æ ‡å¿—ï¼ˆå¦‚æœå¦ä¸€ä¸ªåŠ¨ç”»å·²ç»å®Œæˆï¼‰
                                if (bottomNav.visibility == View.GONE) {
                                    isScrollAnimationRunning = false
                                }
                            }
                        })
                    }
                    
                    // åŒæ­¥æ‰§è¡Œä¸¤ä¸ªåŠ¨ç”»
                    animatorSet.playTogether(navAnimator, quickBarAnimator)
                    animatorSet.start()
                    
                    bottomNavAnimator = navAnimator
                    quickActionsBarAnimator = quickBarAnimator
                    
                    Log.d(TAG, "åŒæ­¥åŠ¨ç”»å¼€å§‹ï¼šnavHeight=$navHeight, quickBarHeight=$quickBarHeight, startY=$startY")
                }
            }
        } catch (e: Exception) {
            Log.e(TAG, "åŒæ­¥éšè—åº•éƒ¨å¯¼èˆªæ å¹¶æ˜¾ç¤ºå¿«æ·æ“ä½œæ å¤±è´¥", e)
        }
    }
    
    /**
     * åŒæ­¥æ˜¾ç¤ºåº•éƒ¨å¯¼èˆªæ å¹¶éšè—å¿«æ·æ“ä½œæ 
     */
    private fun showBottomNavigationAndHideQuickActions() {
        try {
            val bottomNav = findViewById<LinearLayout>(R.id.bottom_navigation)
            if (bottomNav == null || isBottomNavVisible) {
                // å¦‚æœåº•éƒ¨å¯¼èˆªæ ä¸å­˜åœ¨æˆ–å·²æ˜¾ç¤ºï¼Œç›´æ¥éšè—å¿«æ·æ“ä½œæ 
                hideQuickActionsBar()
                return
            }
            
            if (!isQuickActionsBarVisible) {
                // å¦‚æœå¿«æ·æ“ä½œæ æœªæ˜¾ç¤ºï¼Œç›´æ¥æ˜¾ç¤ºåº•éƒ¨å¯¼èˆªæ 
                showBottomNavigation()
                return
            }
            
            isBottomNavVisible = true
            isQuickActionsBarVisible = false
            
            // å–æ¶ˆä¹‹å‰çš„åŠ¨ç”»
            bottomNavAnimator?.cancel()
            quickActionsBarAnimator?.cancel()
            
            // é‡æ–°å‚ä¸å¸ƒå±€
            bottomNav.visibility = View.VISIBLE
            
            bottomNav.post {
                // å¼ºåˆ¶æµ‹é‡å¸ƒå±€
                bottomNav.measure(
                    View.MeasureSpec.makeMeasureSpec(bottomNav.width, View.MeasureSpec.EXACTLY),
                    View.MeasureSpec.makeMeasureSpec(0, View.MeasureSpec.UNSPECIFIED)
                )
                
                val navHeight = bottomNav.measuredHeight.toFloat()
                if (navHeight <= 0f) {
                    Log.w(TAG, "åº•éƒ¨å¯¼èˆªæ é«˜åº¦ä¸º0")
                    hideQuickActionsBar()
                    return@post
                }
                
                // å¼ºåˆ¶æµ‹é‡å¿«æ·æ“ä½œæ 
                browserQuickActionsBar.measure(
                    View.MeasureSpec.makeMeasureSpec(browserQuickActionsBar.width, View.MeasureSpec.EXACTLY),
                    View.MeasureSpec.makeMeasureSpec(0, View.MeasureSpec.UNSPECIFIED)
                )
                
                // è·å–å½“å‰ä½ç½®ï¼ˆç¡®ä¿å‡†ç¡®ï¼‰
                val quickBarStartY = browserQuickActionsBar.translationY.coerceAtLeast(0f)
                val quickBarHeight = browserQuickActionsBar.measuredHeight.toFloat()
                val navStartY = navHeight // æ€»æ˜¯ä»å®Œå…¨éšè—ä½ç½®å¼€å§‹
                
                // è®¾ç½®åˆå§‹çŠ¶æ€
                bottomNav.translationY = navStartY
                bottomNav.alpha = 0f // åˆå§‹å®Œå…¨é€æ˜ï¼Œé¿å…æ— æ•ˆå›¾å½¢
                
                // åˆ›å»ºåŒæ­¥åŠ¨ç”»
                val animatorSet = android.animation.AnimatorSet()
                
                // ğŸ”§ ä¼˜åŒ–ï¼šä½¿ç”¨iOSé£æ ¼çš„æµç•…åŠ¨ç”»
                // åº•éƒ¨å¯¼èˆªæ ä»ä¸‹æ–¹ä¸Šæµ®
                val navAnimator = android.animation.ValueAnimator.ofFloat(0f, 1f).apply {
                    duration = 280L // ğŸ”§ ä¼˜åŒ–ï¼šç»Ÿä¸€åŠ¨ç”»æ—¶é•¿ä¸º280ms
                    // ğŸ”§ ä¼˜åŒ–ï¼šä½¿ç”¨iOSé£æ ¼çš„ç¼“åŠ¨æ›²çº¿
                    interpolator = android.view.animation.PathInterpolator(0.25f, 0.1f, 0.25f, 1.0f)
                    addUpdateListener { anim ->
                        val progress = anim.animatedValue as Float
                        // ğŸ”§ ä¼˜åŒ–ï¼šä½¿ç”¨å¹³æ»‘çš„ç¼“åŠ¨å‡½æ•°
                        val easedProgress = progress * progress * (3f - 2f * progress)
                        bottomNav.translationY = navStartY * (1f - easedProgress)
                        bottomNav.alpha = easedProgress // å®Œå…¨æ·¡å…¥ï¼Œé¿å…æ— æ•ˆå›¾å½¢
                    }
                    addListener(object : android.animation.AnimatorListenerAdapter() {
                        override fun onAnimationEnd(animation: android.animation.Animator) {
                            // ç¡®ä¿æœ€ç»ˆä½ç½®ç²¾ç¡®ä¸º0
                            bottomNav.translationY = 0f
                            bottomNav.alpha = 1f
                            // ğŸ”§ ä¼˜åŒ–ï¼šåŠ¨ç”»å®Œæˆåé‡ç½®æ»šåŠ¨åŠ¨ç”»æ ‡å¿—ï¼ˆå¦‚æœå¦ä¸€ä¸ªåŠ¨ç”»å·²ç»å®Œæˆï¼‰
                            if (browserQuickActionsBar.visibility == View.GONE) {
                                isScrollAnimationRunning = false
                            }
                        }
                    })
                }
                
                // ğŸ”§ ä¼˜åŒ–ï¼šä½¿ç”¨iOSé£æ ¼çš„æµç•…åŠ¨ç”»
                // å¿«æ·æ“ä½œæ å‘ä¸‹ç§»åŠ¨å¹¶æ·¡å‡º
                val endY = navHeight + quickBarHeight
                val quickBarAnimator = android.animation.ValueAnimator.ofFloat(0f, 1f).apply {
                    duration = 280L // ğŸ”§ ä¼˜åŒ–ï¼šç»Ÿä¸€åŠ¨ç”»æ—¶é•¿ä¸º280ms
                    // ğŸ”§ ä¼˜åŒ–ï¼šä½¿ç”¨iOSé£æ ¼çš„ç¼“åŠ¨æ›²çº¿
                    interpolator = android.view.animation.PathInterpolator(0.25f, 0.1f, 0.25f, 1.0f)
                    addUpdateListener { anim ->
                        val progress = anim.animatedValue as Float
                        // ğŸ”§ ä¼˜åŒ–ï¼šä½¿ç”¨å¹³æ»‘çš„ç¼“åŠ¨å‡½æ•°
                        val easedProgress = progress * progress * (3f - 2f * progress)
                        browserQuickActionsBar.alpha = 1f - easedProgress // å®Œå…¨æ·¡å‡ºï¼Œé¿å…æ— æ•ˆå›¾å½¢
                        browserQuickActionsBar.translationY = quickBarStartY + (endY - quickBarStartY) * easedProgress
                    }
                    addListener(object : android.animation.AnimatorListenerAdapter() {
                        override fun onAnimationEnd(animation: android.animation.Animator) {
                            // ç¡®ä¿æœ€ç»ˆä½ç½®æ­£ç¡®ï¼Œå¹¶éšè—
                            browserQuickActionsBar.translationY = endY
                            browserQuickActionsBar.alpha = 0f
                            browserQuickActionsBar.visibility = View.GONE
                            // ğŸ”§ ä¼˜åŒ–ï¼šåŠ¨ç”»å®Œæˆåé‡ç½®æ»šåŠ¨åŠ¨ç”»æ ‡å¿—
                            isScrollAnimationRunning = false
                        }
                    })
                }
                
                // åŒæ­¥æ‰§è¡Œä¸¤ä¸ªåŠ¨ç”»
                animatorSet.playTogether(navAnimator, quickBarAnimator)
                animatorSet.start()
                
                bottomNavAnimator = navAnimator
                quickActionsBarAnimator = quickBarAnimator
                
                Log.d(TAG, "åŒæ­¥åŠ¨ç”»å¼€å§‹ï¼šnavHeight=$navHeight, quickBarHeight=$quickBarHeight, quickBarStartY=$quickBarStartY, endY=$endY")
            }
        } catch (e: Exception) {
            Log.e(TAG, "åŒæ­¥æ˜¾ç¤ºåº•éƒ¨å¯¼èˆªæ å¹¶éšè—å¿«æ·æ“ä½œæ å¤±è´¥", e)
        }
    }

    /**
     * åªéšè—æ ‡é¢˜æ ï¼Œä¸éšè—tabæ ï¼ˆç”¨äºä¸‹æ»‘æ—¶åªéšè—æ ‡é¢˜æ ï¼Œtabæ ä¿æŒæ˜¾ç¤ºï¼‰
     * ğŸ”§ ä¿®å¤ï¼šåŒæ—¶éšè—ç»„æ ‡ç­¾æ 
     */
    private fun hideToolbarOnly() {
        if (!isToolbarVisible) return
        
        // ğŸ”§ ä¿®å¤ï¼šå¦‚æœæ˜¯åŠŸèƒ½ä¸»é¡µï¼Œä¸éšè—å·¥å…·æ å’Œç»„æ ‡ç­¾æ 
        val currentTab = paperStackWebViewManager?.getCurrentTab()
        if (currentTab?.url == "home://functional") {
            Log.d(TAG, "åŠŸèƒ½ä¸»é¡µï¼Œä¸éšè—å·¥å…·æ å’Œç»„æ ‡ç­¾æ ")
            return
        }

        try {
            isToolbarVisible = false

            // ğŸ”§ ä¿®å¤ï¼šå…¨å±æµè§ˆæ—¶éšè—æ–‡æœ¬å·¥å…·æ 
            searchInputToolbarContainer?.visibility = View.GONE

            // å–æ¶ˆä¹‹å‰çš„åŠ¨ç”»
            toolbarAnimator?.cancel()
            groupTabsAnimator?.cancel()

            // è·å–å·¥å…·æ é«˜åº¦
            val toolbarHeight = browserToolbar.height.toFloat()
            if (toolbarHeight <= 0) {
                Log.w(TAG, "å·¥å…·æ é«˜åº¦ä¸º0ï¼Œæ— æ³•æ‰§è¡Œéšè—åŠ¨ç”»")
                browserToolbar.visibility = View.GONE
                // ğŸ”§ ä¿®å¤ï¼šåŒæ—¶éšè—ç»„æ ‡ç­¾æ 
                groupTabsContainer?.visibility = View.GONE
                return
            }

            // ğŸ”§ ä¿®å¤ï¼šè·å–ç»„æ ‡ç­¾æ é«˜åº¦
            val groupTabsContainerRef = groupTabsContainer
            // ğŸ”§ å…³é”®ä¿®å¤ï¼šåªæœ‰å½“ç»„æ ‡ç­¾æ å½“å‰æ˜¯VISIBLEæ—¶æ‰å¤„ç†ï¼ˆè¯´æ˜æœ‰ç»„éœ€è¦æ˜¾ç¤ºï¼‰
            // å¦‚æœç»„æ ‡ç­¾æ æ˜¯GONEï¼Œå¯èƒ½æ˜¯å› ä¸ºæ²¡æœ‰ç”¨æˆ·åˆ›å»ºçš„ç»„ï¼Œä¸éœ€è¦å¤„ç†
            val groupTabsContainerHeight = if (groupTabsContainerRef?.visibility == View.VISIBLE) {
                groupTabsContainerRef.height.toFloat()
            } else {
                0f
            }

            // åªéšè—æ ‡é¢˜æ å’Œç»„æ ‡ç­¾æ ï¼Œä¸å¤„ç†tabæ 
            val originalToolbarHeight = toolbarHeight.toInt()
            val originalGroupTabsHeight = groupTabsContainerHeight.toInt()
            val indentDistance = dpToPx(16f)

            // åˆ›å»ºéšè—åŠ¨ç”»ï¼ˆé’ˆå¯¹æ ‡é¢˜æ å’Œç»„æ ‡ç­¾æ ï¼‰
            toolbarAnimator = android.animation.ValueAnimator.ofFloat(0f, 1f).apply {
                duration = 280L
                interpolator = android.view.animation.PathInterpolator(0.25f, 0.1f, 0.25f, 1.0f)
                addUpdateListener { animator ->
                    val progress = animator.animatedValue as Float
                    val easedProgress = progress * progress * (3f - 2f * progress)
                    
                    // è®¡ç®—æ€»é«˜åº¦ï¼ˆæ ‡é¢˜æ +ç»„æ ‡ç­¾æ ï¼‰
                    val totalHeight = toolbarHeight + groupTabsContainerHeight
                    
                    // æ ‡é¢˜æ å‘ä¸‹ç§»åŠ¨å¹¶æ·¡å‡º
                    val toolbarTranslationY = totalHeight * easedProgress
                    browserToolbar.translationY = toolbarTranslationY
                    browserToolbar.alpha = 1f - 0.95f * easedProgress
                    
                    // ğŸ”§ ä¿®å¤ï¼šç»„æ ‡ç­¾æ åŒæ­¥å‘ä¸‹ç§»åŠ¨å¹¶æ·¡å‡º
                    groupTabsContainerRef?.let { container ->
                        if (container.visibility == View.VISIBLE) {
                            container.translationY = toolbarTranslationY
                            container.alpha = 1f - 0.95f * easedProgress
                            
                            // åŠ¨æ€è°ƒæ•´ç»„æ ‡ç­¾æ é«˜åº¦
                            val currentGroupTabsHeight = (originalGroupTabsHeight * (1f - easedProgress)).toInt()
                            val groupTabsLayoutParams = container.layoutParams
                            groupTabsLayoutParams.height = currentGroupTabsHeight
                            container.layoutParams = groupTabsLayoutParams
                        }
                    }
                    
                    // è°ƒæ•´æ ‡é¢˜æ é«˜åº¦
                    val toolbarLayoutParams = browserToolbar.layoutParams
                    toolbarLayoutParams.height = (originalToolbarHeight * (1f - easedProgress)).toInt()
                    browserToolbar.layoutParams = toolbarLayoutParams
                }
                addListener(object : android.animation.AnimatorListenerAdapter() {
                    override fun onAnimationEnd(animation: android.animation.Animator) {
                        browserToolbar.visibility = View.GONE
                        browserToolbar.translationY = 0f
                        browserToolbar.alpha = 1f
                        val toolbarLayoutParams = browserToolbar.layoutParams
                        toolbarLayoutParams.height = originalToolbarHeight
                        browserToolbar.layoutParams = toolbarLayoutParams
                        
                        // ğŸ”§ ä¿®å¤ï¼šéšè—ç»„æ ‡ç­¾æ 
                        groupTabsContainerRef?.let { container ->
                            container.visibility = View.GONE
                            container.translationY = 0f
                            container.alpha = 1f
                            val groupTabsLayoutParams = container.layoutParams
                            groupTabsLayoutParams.height = originalGroupTabsHeight
                            container.layoutParams = groupTabsLayoutParams
                        }
                    }
                })
            }
            toolbarAnimator?.start()
        } catch (e: Exception) {
            Log.e(TAG, "éšè—æ ‡é¢˜æ å¤±è´¥", e)
        }
    }
    
    /**
     * éšè—å·¥å…·æ ï¼ˆåŒæ­¥åŠ¨ç”»ï¼šæ ‡é¢˜æ ã€tabæ ã€ç½‘é¡µå®¹å™¨ï¼‰
     * ğŸ”§ é‡æ–°è®¾è®¡ï¼šé€šè¿‡åŠ¨æ€è°ƒæ•´é«˜åº¦é¿å…ç©ºç™½åŒºåŸŸ
     */
    private fun hideToolbar() {
        if (!isToolbarVisible) return
        
        // æœç´¢tabé¦–é¡µä¸éšè—æ ‡é¢˜æ å’Œtabæ 
        if (browserHomeContent.visibility == View.VISIBLE) {
            Log.d(TAG, "æœç´¢tabé¦–é¡µï¼Œä¸éšè—æ ‡é¢˜æ å’Œtabæ ")
            return
        }

        try {
            isToolbarVisible = false

            // å–æ¶ˆä¹‹å‰çš„åŠ¨ç”»
            toolbarAnimator?.cancel()

            // è·å–å·¥å…·æ é«˜åº¦
            val toolbarHeight = browserToolbar.height.toFloat()
            if (toolbarHeight <= 0) {
                Log.w(TAG, "å·¥å…·æ é«˜åº¦ä¸º0ï¼Œæ— æ³•æ‰§è¡Œéšè—åŠ¨ç”»")
                browserToolbar.visibility = View.GONE
                return
            }

            // è·å–tabæ é«˜åº¦ï¼ˆå¦‚æœå¯è§ï¼‰
            val tabContainerHeight = if (browserTabContainer.visibility == View.VISIBLE) {
                browserTabContainer.height.toFloat()
            } else {
                0f
            }
            
            // ğŸ”§ ä¿®å¤3ï¼šè·å–ç»„æ ‡ç­¾æ é«˜åº¦ï¼ˆå¦‚æœå¯è§ï¼‰
            val groupTabsContainerRef = groupTabsContainer
            val groupTabsContainerHeight = if (groupTabsContainerRef?.visibility == View.VISIBLE) {
                groupTabsContainerRef.height.toFloat()
            } else {
                0f
            }

            // ç¼©è¿›è·ç¦»ï¼ˆå·¦å³å„ç¼©è¿›ï¼‰
            val indentDistance = dpToPx(16f)

            // ä¿å­˜åŸå§‹é«˜åº¦
            val originalToolbarHeight = toolbarHeight.toInt()
            val originalTabHeight = tabContainerHeight.toInt()
            val originalGroupTabsHeight = groupTabsContainerHeight.toInt()

            // ğŸ”§ é‡æ–°è®¾è®¡ï¼šä½¿ç”¨iOSé£æ ¼çš„æµç•…åŠ¨ç”»ï¼Œç»Ÿä¸€æ—¶é•¿å’Œæ’å€¼å™¨
            // åˆ›å»ºåŒæ­¥éšè—åŠ¨ç”» - æ ‡é¢˜æ ã€tabæ ã€ç½‘é¡µå®¹å™¨åŒæ­¥ç§»åŠ¨å’Œç¼©è¿›
            toolbarAnimator = android.animation.ValueAnimator.ofFloat(0f, 1f).apply {
                duration = 280L // ğŸ”§ ä¼˜åŒ–ï¼šç»Ÿä¸€åŠ¨ç”»æ—¶é•¿ä¸º280msï¼Œæ›´æµç•…
                // ğŸ”§ ä¼˜åŒ–ï¼šä½¿ç”¨iOSé£æ ¼çš„ç¼“åŠ¨æ›²çº¿ï¼Œæ›´è‡ªç„¶æµç•…
                interpolator = android.view.animation.PathInterpolator(0.25f, 0.1f, 0.25f, 1.0f)

                addUpdateListener { animator ->
                    val progress = animator.animatedValue as Float
                    
                    // ğŸ”§ ä¼˜åŒ–ï¼šä½¿ç”¨æ›´å¹³æ»‘çš„ç¼“åŠ¨å‡½æ•°ï¼Œè®©åŠ¨ç”»æ›´è‡ªç„¶
                    val easedProgress = progress * progress * (3f - 2f * progress) // Smoothstepå‡½æ•°
                    
                    // ğŸ”§ å…³é”®ä¿®å¤ï¼šæ ‡é¢˜æ ã€tabæ å’Œç»„æ ‡ç­¾æ ä½œä¸ºä¸€ä½“ï¼Œå‘ä¸‹æ»‘åŠ¨é€€å‡º
                    // è®¡ç®—æ€»é«˜åº¦ï¼ˆå·¥å…·æ +tabæ +ç»„æ ‡ç­¾æ ï¼‰
                    val totalHeight = toolbarHeight + tabContainerHeight + groupTabsContainerHeight
                    
                    // æ ‡é¢˜æ å’Œtabæ ï¼šå‘ä¸‹ç§»åŠ¨å¹¶æ·¡å‡ºï¼ˆä½œä¸ºä¸€ä½“ï¼‰
                    val toolbarTranslationY = totalHeight * easedProgress
                    browserToolbar.translationY = toolbarTranslationY
                    browserToolbar.alpha = 1f - 0.95f * easedProgress
                    
                    // Tabæ ï¼šåŒæ­¥å‘ä¸‹ç§»åŠ¨å¹¶æ·¡å‡º
                    if (browserTabContainer.visibility == View.VISIBLE) {
                        browserTabContainer.translationY = toolbarTranslationY
                        browserTabContainer.alpha = 1f - 0.95f * easedProgress
                    }
                    
                    // ğŸ”§ ä¿®å¤3ï¼šç»„æ ‡ç­¾æ ï¼šåŒæ­¥å‘ä¸‹ç§»åŠ¨å¹¶æ·¡å‡º
                    groupTabsContainer?.let { container ->
                        if (container.visibility == View.VISIBLE) {
                            container.translationY = toolbarTranslationY
                            container.alpha = 1f - 0.95f * easedProgress
                        }
                    }
                    
                    // ğŸ”§ å…³é”®ä¿®å¤ï¼šåŠ¨æ€è°ƒæ•´å·¥å…·æ é«˜åº¦ï¼Œä»å®é™…é«˜åº¦é€æ¸å‡å°‘åˆ°0
                    // è¿™æ ·å·¥å…·æ åœ¨å¸ƒå±€ä¸­å æ®çš„ç©ºé—´ä¼šåŒæ­¥å‡å°‘ï¼Œä¸ä¼šå‡ºç°ç©ºç™½åŒºåŸŸ
                    val currentToolbarHeight = (originalToolbarHeight * (1f - easedProgress)).toInt()
                    val toolbarLayoutParams = browserToolbar.layoutParams
                    toolbarLayoutParams.height = currentToolbarHeight
                    browserToolbar.layoutParams = toolbarLayoutParams
                    
                    // Tabæ é«˜åº¦åŒæ­¥å‡å°‘
                    if (browserTabContainer.visibility == View.VISIBLE) {
                        val currentTabHeight = (originalTabHeight * (1f - easedProgress)).toInt()
                        val tabLayoutParams = browserTabContainer.layoutParams
                        tabLayoutParams.height = currentTabHeight
                        browserTabContainer.layoutParams = tabLayoutParams
                    }
                    
                    // ğŸ”§ ä¿®å¤3ï¼šç»„æ ‡ç­¾æ é«˜åº¦åŒæ­¥å‡å°‘
                    groupTabsContainer?.let { container ->
                        if (container.visibility == View.VISIBLE) {
                            val currentGroupTabsHeight = (originalGroupTabsHeight * (1f - easedProgress)).toInt()
                            val groupTabsLayoutParams = container.layoutParams
                            groupTabsLayoutParams.height = currentGroupTabsHeight
                            container.layoutParams = groupTabsLayoutParams
                        }
                    }
                    
                    // ç½‘é¡µå®¹å™¨ï¼šåŒæ­¥ç¼©è¿›/å»¶ä¼¸åŠ¨ç”»
                    val webViewContainer = findViewById<FrameLayout>(R.id.browser_webview_container)
                    if (webViewContainer != null) {
                        val margin = (indentDistance * (1f - easedProgress)).toInt() // ğŸ”§ ä¼˜åŒ–ï¼šä½¿ç”¨easedProgress
                        val layoutParams = webViewContainer.layoutParams as? ViewGroup.MarginLayoutParams
                        layoutParams?.let {
                            it.leftMargin = margin
                            it.rightMargin = margin
                            webViewContainer.layoutParams = it
                        }
                        // ğŸ”§ ä¿®å¤ç™½è‰²èƒŒæ™¯ï¼šç¡®ä¿WebViewå®¹å™¨èƒŒæ™¯å§‹ç»ˆé€æ˜
                        webViewContainer.setBackgroundColor(Color.TRANSPARENT)
                    }
                    
                    // ğŸ”§ ä¿®å¤ç™½è‰²èƒŒæ™¯ï¼šç¡®ä¿SwipeRefreshLayoutèƒŒæ™¯ä¹Ÿé€æ˜
                    val swipeRefreshLayout = findViewById<androidx.swiperefreshlayout.widget.SwipeRefreshLayout>(R.id.browser_swipe_refresh)
                    swipeRefreshLayout?.setBackgroundColor(Color.TRANSPARENT)
                    
                    // æ ‡é¢˜æ å’Œtabæ åŒæ­¥ç¼©è¿›
                    val toolbarMargin = (indentDistance * (1f - easedProgress)).toInt() // ğŸ”§ ä¼˜åŒ–ï¼šä½¿ç”¨easedProgress
                    val toolbarMarginParams = browserToolbar.layoutParams as? ViewGroup.MarginLayoutParams
                    toolbarMarginParams?.let {
                        it.leftMargin = toolbarMargin
                        it.rightMargin = toolbarMargin
                        browserToolbar.layoutParams = it
                    }
                    
                    val tabMarginParams = browserTabContainer.layoutParams as? ViewGroup.MarginLayoutParams
                    tabMarginParams?.let {
                        it.leftMargin = toolbarMargin
                        it.rightMargin = toolbarMargin
                        browserTabContainer.layoutParams = it
                    }
                    
                    // ğŸ”§ ä¿®å¤3ï¼šç»„æ ‡ç­¾æ åŒæ­¥ç¼©è¿›
                    groupTabsContainer?.let { container ->
                        val groupTabsMarginParams = container.layoutParams as? ViewGroup.MarginLayoutParams
                        groupTabsMarginParams?.let {
                            it.leftMargin = toolbarMargin
                            it.rightMargin = toolbarMargin
                            container.layoutParams = it
                        }
                    }
                }

                addListener(object : android.animation.AnimatorListenerAdapter() {
                    override fun onAnimationEnd(animation: android.animation.Animator) {
                        Log.d(TAG, "å·¥å…·æ éšè—åŠ¨ç”»å®Œæˆ")
                        // å®Œå…¨éšè—åä»å¸ƒå±€ç§»é™¤ï¼Œé‡Šæ”¾é«˜åº¦ç»™å†…å®¹åŒºåŸŸ
                        browserToolbar.visibility = View.GONE
                        browserToolbar.translationY = 0f
                        browserToolbar.alpha = 1f
                        // æ¢å¤åŸå§‹é«˜åº¦ï¼Œä»¥ä¾¿ä¸‹æ¬¡æ˜¾ç¤ºæ—¶ä½¿ç”¨
                        val toolbarLayoutParams = browserToolbar.layoutParams
                        toolbarLayoutParams.height = originalToolbarHeight
                        browserToolbar.layoutParams = toolbarLayoutParams
                        // ğŸ”§ ä¿®å¤ï¼šé‡ç½®tabæ çŠ¶æ€
                        if (browserTabContainer.visibility == View.VISIBLE) {
                            browserTabContainer.translationY = 0f
                            browserTabContainer.alpha = 1f
                            val tabLayoutParams = browserTabContainer.layoutParams
                            tabLayoutParams.height = originalTabHeight
                            browserTabContainer.layoutParams = tabLayoutParams
                        }
                        
                        // ğŸ”§ ä¿®å¤3ï¼šé‡ç½®ç»„æ ‡ç­¾æ çŠ¶æ€å¹¶éšè—
                        groupTabsContainer?.let { container ->
                            container.translationY = 0f
                            container.alpha = 1f
                            val groupTabsLayoutParams = container.layoutParams
                            groupTabsLayoutParams.height = originalGroupTabsHeight
                            container.layoutParams = groupTabsLayoutParams
                            // ğŸ”§ å…³é”®ä¿®å¤ï¼šéšè—ç»„æ ‡ç­¾æ 
                            container.visibility = View.GONE
                        }
                        // ğŸ”§ ä¿®å¤ç™½è‰²èƒŒæ™¯ï¼šåŠ¨ç”»ç»“æŸåå†æ¬¡ç¡®è®¤èƒŒæ™¯é€æ˜
                        val webViewContainer = findViewById<FrameLayout>(R.id.browser_webview_container)
                        webViewContainer?.setBackgroundColor(Color.TRANSPARENT)
                        val swipeRefreshLayout = findViewById<androidx.swiperefreshlayout.widget.SwipeRefreshLayout>(R.id.browser_swipe_refresh)
                        swipeRefreshLayout?.setBackgroundColor(Color.TRANSPARENT)
                    }
                })

                start()
            }

            Log.d(TAG, "å¼€å§‹éšè—å·¥å…·æ ï¼Œé«˜åº¦: $toolbarHeight")

        } catch (e: Exception) {
            Log.e(TAG, "éšè—å·¥å…·æ å¤±è´¥", e)
        }
    }
    
    /**
     * å°†dpè½¬æ¢ä¸ºpx
     */
    private fun dpToPx(dp: Float): Float {
        return dp * resources.displayMetrics.density
    }

    /**
     * æ˜¾ç¤ºå·¥å…·æ ï¼ˆåŒæ­¥åŠ¨ç”»ï¼šæ ‡é¢˜æ ã€tabæ ã€ç½‘é¡µå®¹å™¨ï¼‰
     * ğŸ”§ é‡æ–°è®¾è®¡ï¼šé€šè¿‡åŠ¨æ€è°ƒæ•´é«˜åº¦é¿å…ç©ºç™½åŒºåŸŸ
     */
    private fun showToolbar() {
        if (isToolbarVisible) return

        try {
            isToolbarVisible = true

            // ğŸ”§ ä¿®å¤ï¼šæ˜¾ç¤ºå·¥å…·æ åï¼Œæ ¹æ®è¾“å…¥æ¡†ç„¦ç‚¹å’Œè¾“å…¥æ³•çŠ¶æ€æ›´æ–°æ–‡æœ¬å·¥å…·æ å¯è§æ€§
            updateSearchInputToolbarVisibility()

            // å–æ¶ˆä¹‹å‰çš„åŠ¨ç”»
            toolbarAnimator?.cancel()

            // ğŸ”§ é‡æ–°è®¾è®¡ï¼šå…ˆè®¾ç½®å·¥å…·æ ä¸ºå¯è§ï¼Œä½†é«˜åº¦ä¸º0ï¼Œç„¶ååŠ¨æ€å¢åŠ é«˜åº¦
            // è·å–ç›®æ ‡é«˜åº¦ï¼ˆå¦‚æœå½“å‰é«˜åº¦ä¸º0ï¼Œä½¿ç”¨é»˜è®¤å€¼56dpï¼‰
            val targetToolbarHeight = if (browserToolbar.height > 0) {
                browserToolbar.height.toFloat()
            } else {
                dpToPx(56f)
            }
            
            // ğŸ”§ ä¿®å¤ï¼šæ˜¾ç¤ºå·¥å…·æ æ—¶ï¼Œç¡®ä¿ç»„æ ‡ç­¾æ ï¼ˆtabæ ï¼‰ä¹Ÿå¯è§ï¼ˆåœ¨æœç´¢tabä¸­ï¼‰
            if (currentState == UIState.BROWSER) {
                groupTabsContainer?.let { container ->
                    container.visibility = View.VISIBLE
                    container.alpha = 1f
                    container.translationY = 0f
                    Log.d(TAG, "ğŸ”§ æ˜¾ç¤ºå·¥å…·æ æ—¶ï¼Œæ¢å¤ç»„æ ‡ç­¾æ ï¼ˆtabæ ï¼‰")
                }
            }
            
            // è·å–tabæ ç›®æ ‡é«˜åº¦
            val targetTabHeight = if (browserTabContainer.visibility == View.VISIBLE && browserTabContainer.height > 0) {
                browserTabContainer.height.toFloat()
            } else if (browserTabContainer.visibility == View.VISIBLE) {
                dpToPx(48f)
            } else {
                0f
            }
            
            // ğŸ”§ ä¿®å¤3ï¼šè·å–ç»„æ ‡ç­¾æ ç›®æ ‡é«˜åº¦
            val groupTabsContainerRef = groupTabsContainer
            val targetGroupTabsHeight = if (groupTabsContainerRef?.visibility == View.VISIBLE && groupTabsContainerRef.height > 0) {
                groupTabsContainerRef.height.toFloat()
            } else if (groupTabsContainerRef?.visibility == View.VISIBLE) {
                dpToPx(48f)
            } else {
                0f
            }

            // è®©å·¥å…·æ å‚ä¸å¸ƒå±€ï¼Œä½†åˆå§‹é«˜åº¦ä¸º0
            if (browserToolbar.visibility != View.VISIBLE) {
                browserToolbar.visibility = View.VISIBLE
                // ğŸ”§ å…³é”®ä¿®å¤ï¼šåˆå§‹é«˜åº¦è®¾ä¸º0ï¼Œé¿å…ç«‹å³å æ®å¸ƒå±€ç©ºé—´
                val toolbarLayoutParams = browserToolbar.layoutParams
                toolbarLayoutParams.height = 0
                browserToolbar.layoutParams = toolbarLayoutParams
                
                // ğŸ”§ å…³é”®ä¿®å¤ï¼šå·¥å…·æ ç›´æ¥ä»åº•éƒ¨å‡ºç°ï¼ˆæ­£çš„translationYï¼‰
                // è®¡ç®—æ€»é«˜åº¦ï¼ˆå·¥å…·æ +tabæ +ç»„æ ‡ç­¾æ ï¼‰ï¼Œä»åº•éƒ¨å‘ä¸Šç§»åŠ¨åˆ°æ­£å¸¸ä½ç½®
                val totalHeight = targetToolbarHeight + targetTabHeight.toInt() + targetGroupTabsHeight.toInt()
                browserToolbar.translationY = totalHeight.toFloat()
                browserToolbar.alpha = 0.1f
                
                // åŒæ ·å¤„ç†tabæ ï¼Œä»åº•éƒ¨åŒæ­¥å‡ºç°
                if (browserTabContainer.visibility == View.VISIBLE && targetTabHeight > 0) {
                    val tabLayoutParams = browserTabContainer.layoutParams
                    tabLayoutParams.height = 0
                    browserTabContainer.layoutParams = tabLayoutParams
                    browserTabContainer.translationY = totalHeight.toFloat()
                    browserTabContainer.alpha = 0.1f
                }
                
                // ğŸ”§ ä¿®å¤3ï¼šåŒæ ·å¤„ç†ç»„æ ‡ç­¾æ ï¼Œä»åº•éƒ¨åŒæ­¥å‡ºç°
                groupTabsContainer?.let { container ->
                    if (container.visibility == View.VISIBLE && targetGroupTabsHeight > 0) {
                        val groupTabsLayoutParams = container.layoutParams
                        groupTabsLayoutParams.height = 0
                        container.layoutParams = groupTabsLayoutParams
                        container.translationY = totalHeight.toFloat()
                        container.alpha = 0.1f
                    }
                }
            }

            // ğŸ”§ ä¿®å¤ç™½è‰²èƒŒæ™¯ï¼šåœ¨åŠ¨ç”»å¼€å§‹å‰è®¾ç½®WebViewå®¹å™¨å’ŒSwipeRefreshLayoutçš„èƒŒæ™¯
            val webViewContainer = findViewById<FrameLayout>(R.id.browser_webview_container)
            val swipeRefreshLayout = findViewById<androidx.swiperefreshlayout.widget.SwipeRefreshLayout>(R.id.browser_swipe_refresh)
            
            // è®¾ç½®WebViewå®¹å™¨èƒŒæ™¯ä¸ºé€æ˜ï¼Œé¿å…æ˜¾ç¤ºç™½è‰²èƒŒæ™¯
            webViewContainer?.setBackgroundColor(Color.TRANSPARENT)
            
            // è®¾ç½®SwipeRefreshLayoutèƒŒæ™¯ä¸ºé€æ˜æˆ–ä¸ä¸»é¢˜ä¸€è‡´
            swipeRefreshLayout?.setBackgroundColor(Color.TRANSPARENT)
            
            // ç­‰å¾…å¸ƒå±€å®Œæˆåå†å¼€å§‹åŠ¨ç”»ï¼Œç¡®ä¿é«˜åº¦ä¸º0çš„è®¾ç½®ç”Ÿæ•ˆ
            browserToolbar.post {
                // å†æ¬¡ç¡®è®¤é«˜åº¦ä¸º0ï¼Œé¿å…å¸ƒå±€æµ‹é‡åé«˜åº¦è¢«é‡ç½®
                val toolbarLayoutParams = browserToolbar.layoutParams
                if (toolbarLayoutParams.height != 0) {
                    toolbarLayoutParams.height = 0
                    browserToolbar.layoutParams = toolbarLayoutParams
                }
                startToolbarShowAnimation(targetToolbarHeight.toInt(), targetTabHeight.toInt(), targetGroupTabsHeight.toInt())
            }

        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºå·¥å…·æ å¤±è´¥", e)
        }
    }
    
    /**
     * å¼€å§‹å·¥å…·æ æ˜¾ç¤ºåŠ¨ç”»
     * ğŸ”§ é‡æ–°è®¾è®¡ï¼šé€šè¿‡åŠ¨æ€è°ƒæ•´é«˜åº¦é¿å…ç©ºç™½åŒºåŸŸ
     */
    private fun startToolbarShowAnimation(targetToolbarHeight: Int, targetTabHeight: Int, targetGroupTabsHeight: Int) {
        try {
            if (targetToolbarHeight <= 0) {
                Log.w(TAG, "å·¥å…·æ ç›®æ ‡é«˜åº¦ä¸º0ï¼Œæ— æ³•æ‰§è¡Œæ˜¾ç¤ºåŠ¨ç”»")
                return
            }

            // ç¼©è¿›è·ç¦»ï¼ˆå·¦å³å„ç¼©è¿›ï¼‰
            val indentDistance = dpToPx(16f)

            // è·å–èµ·å§‹ä½ç½®
            val startTranslationY = browserToolbar.translationY

            // ğŸ”§ é‡æ–°è®¾è®¡ï¼šä½¿ç”¨iOSé£æ ¼çš„æµç•…åŠ¨ç”»ï¼Œç»Ÿä¸€æ—¶é•¿å’Œæ’å€¼å™¨
            // åˆ›å»ºåŒæ­¥æ˜¾ç¤ºåŠ¨ç”» - æ ‡é¢˜æ ã€tabæ ã€ç½‘é¡µå®¹å™¨åŒæ­¥ç§»åŠ¨å’Œç¼©è¿›
            toolbarAnimator = android.animation.ValueAnimator.ofFloat(0f, 1f).apply {
                duration = 280L // ğŸ”§ ä¼˜åŒ–ï¼šç»Ÿä¸€åŠ¨ç”»æ—¶é•¿ä¸º280msï¼Œä¸éšè—åŠ¨ç”»ä¸€è‡´
                // ğŸ”§ ä¼˜åŒ–ï¼šä½¿ç”¨iOSé£æ ¼çš„ç¼“åŠ¨æ›²çº¿ï¼Œæ›´è‡ªç„¶æµç•…
                interpolator = android.view.animation.PathInterpolator(0.25f, 0.1f, 0.25f, 1.0f)

                addUpdateListener { animator ->
                    val progress = animator.animatedValue as Float
                    
                    // ğŸ”§ ä¼˜åŒ–ï¼šä½¿ç”¨æ›´å¹³æ»‘çš„ç¼“åŠ¨å‡½æ•°ï¼Œè®©åŠ¨ç”»æ›´è‡ªç„¶
                    val easedProgress = progress * progress * (3f - 2f * progress) // Smoothstepå‡½æ•°
                    
                    // ğŸ”§ å…³é”®ä¿®å¤ï¼šå·¥å…·æ ç›´æ¥ä»åº•éƒ¨å‡ºç°ï¼Œå‘ä¸Šç§»åŠ¨åˆ°æ­£å¸¸ä½ç½®
                    // è®¡ç®—æ€»é«˜åº¦ï¼ˆå·¥å…·æ +tabæ +ç»„æ ‡ç­¾æ ï¼‰ï¼Œä»åº•éƒ¨ï¼ˆæ­£çš„translationYï¼‰å‘ä¸Šç§»åŠ¨åˆ°0
                    val totalHeight = targetToolbarHeight + targetTabHeight + targetGroupTabsHeight
                    val toolbarTranslationY = startTranslationY + (-startTranslationY) * easedProgress
                    browserToolbar.translationY = toolbarTranslationY
                    val toolbarAlpha = 0.1f + 0.9f * easedProgress
                    browserToolbar.alpha = toolbarAlpha
                    
                    // Tabæ ï¼šåŒæ­¥ä»åº•éƒ¨å‘ä¸Šç§»åŠ¨å’Œæ·¡å…¥
                    if (browserTabContainer.visibility == View.VISIBLE && targetTabHeight > 0) {
                        browserTabContainer.translationY = toolbarTranslationY
                        browserTabContainer.alpha = toolbarAlpha
                    }
                    
                    // ğŸ”§ ä¿®å¤3ï¼šç»„æ ‡ç­¾æ ï¼šåŒæ­¥ä»åº•éƒ¨å‘ä¸Šç§»åŠ¨å’Œæ·¡å…¥
                    groupTabsContainer?.let { container ->
                        if (container.visibility == View.VISIBLE && targetGroupTabsHeight > 0) {
                            container.translationY = toolbarTranslationY
                            container.alpha = toolbarAlpha
                        }
                    }
                    
                    // ğŸ”§ å…³é”®ä¿®å¤ï¼šåŠ¨æ€è°ƒæ•´å·¥å…·æ é«˜åº¦ï¼Œä»0é€æ¸å¢åŠ åˆ°ç›®æ ‡é«˜åº¦
                    // è¿™æ ·å·¥å…·æ åœ¨å¸ƒå±€ä¸­å æ®çš„ç©ºé—´ä¼šåŒæ­¥å¢åŠ ï¼Œä¸ä¼šå‡ºç°ç©ºç™½åŒºåŸŸ
                    val currentToolbarHeight = (targetToolbarHeight * easedProgress).toInt()
                    val toolbarLayoutParams = browserToolbar.layoutParams
                    toolbarLayoutParams.height = currentToolbarHeight
                    browserToolbar.layoutParams = toolbarLayoutParams
                    
                    // Tabæ é«˜åº¦åŒæ­¥å¢åŠ 
                    if (browserTabContainer.visibility == View.VISIBLE && targetTabHeight > 0) {
                        val currentTabHeight = (targetTabHeight * easedProgress).toInt()
                        val tabLayoutParams = browserTabContainer.layoutParams
                        tabLayoutParams.height = currentTabHeight
                        browserTabContainer.layoutParams = tabLayoutParams
                    }
                    
                    // ğŸ”§ ä¿®å¤3ï¼šç»„æ ‡ç­¾æ é«˜åº¦åŒæ­¥å¢åŠ 
                    groupTabsContainer?.let { container ->
                        if (container.visibility == View.VISIBLE && targetGroupTabsHeight > 0) {
                            val currentGroupTabsHeight = (targetGroupTabsHeight * easedProgress).toInt()
                            val groupTabsLayoutParams = container.layoutParams
                            groupTabsLayoutParams.height = currentGroupTabsHeight
                            container.layoutParams = groupTabsLayoutParams
                        }
                    }
                    
                    // ç½‘é¡µå®¹å™¨ï¼šåŒæ­¥ç¼©è¿›/å»¶ä¼¸åŠ¨ç”»
                    val webViewContainer = findViewById<FrameLayout>(R.id.browser_webview_container)
                    if (webViewContainer != null) {
                        val margin = (indentDistance * (1f - easedProgress)).toInt() // ğŸ”§ ä¼˜åŒ–ï¼šä½¿ç”¨easedProgress
                        val layoutParams = webViewContainer.layoutParams as? ViewGroup.MarginLayoutParams
                        layoutParams?.let {
                            it.leftMargin = margin
                            it.rightMargin = margin
                            webViewContainer.layoutParams = it
                        }
                        // ğŸ”§ ä¿®å¤ç™½è‰²èƒŒæ™¯ï¼šç¡®ä¿WebViewå®¹å™¨èƒŒæ™¯å§‹ç»ˆé€æ˜
                        webViewContainer.setBackgroundColor(Color.TRANSPARENT)
                    }
                    
                    // ğŸ”§ ä¿®å¤ç™½è‰²èƒŒæ™¯ï¼šç¡®ä¿SwipeRefreshLayoutèƒŒæ™¯ä¹Ÿé€æ˜
                    val swipeRefreshLayout = findViewById<androidx.swiperefreshlayout.widget.SwipeRefreshLayout>(R.id.browser_swipe_refresh)
                    swipeRefreshLayout?.setBackgroundColor(Color.TRANSPARENT)
                    
                    // æ ‡é¢˜æ å’Œtabæ åŒæ­¥ç¼©è¿›
                    val toolbarMargin = (indentDistance * (1f - easedProgress)).toInt() // ğŸ”§ ä¼˜åŒ–ï¼šä½¿ç”¨easedProgress
                    val toolbarMarginParams = browserToolbar.layoutParams as? ViewGroup.MarginLayoutParams
                    toolbarMarginParams?.let {
                        it.leftMargin = toolbarMargin
                        it.rightMargin = toolbarMargin
                        browserToolbar.layoutParams = it
                    }
                    
                    val tabMarginParams = browserTabContainer.layoutParams as? ViewGroup.MarginLayoutParams
                    tabMarginParams?.let {
                        it.leftMargin = toolbarMargin
                        it.rightMargin = toolbarMargin
                        browserTabContainer.layoutParams = it
                    }
                    
                    // ğŸ”§ ä¿®å¤3ï¼šç»„æ ‡ç­¾æ åŒæ­¥ç¼©è¿›
                    groupTabsContainer?.let { container ->
                        val groupTabsMarginParams = container.layoutParams as? ViewGroup.MarginLayoutParams
                        groupTabsMarginParams?.let {
                            it.leftMargin = toolbarMargin
                            it.rightMargin = toolbarMargin
                            container.layoutParams = it
                        }
                    }
                }

                addListener(object : android.animation.AnimatorListenerAdapter() {
                    override fun onAnimationEnd(animation: android.animation.Animator) {
                        Log.d(TAG, "å·¥å…·æ æ˜¾ç¤ºåŠ¨ç”»å®Œæˆ")
                        // ğŸ”§ ä¿®å¤ï¼šç¡®ä¿åŠ¨ç”»ç»“æŸåtranslationYä¸º0ï¼Œé¿å…æ®‹ç•™åç§»
                        browserToolbar.translationY = 0f
                        browserToolbar.alpha = 1f
                        if (browserTabContainer.visibility == View.VISIBLE) {
                            browserTabContainer.translationY = 0f
                            browserTabContainer.alpha = 1f
                        }
                        // ğŸ”§ ä¿®å¤ï¼šç¡®ä¿ç»„æ ‡ç­¾æ åœ¨å·¥å…·æ æ˜¾ç¤ºåä¹Ÿæ­£ç¡®æ˜¾ç¤º
                        groupTabsContainer?.let { container ->
                            container.translationY = 0f
                            container.alpha = 1f
                            // ğŸ”§ å…³é”®ä¿®å¤ï¼šç¡®ä¿ç»„æ ‡ç­¾æ å¯è§
                            if (isToolbarVisible && currentState == UIState.BROWSER) {
                                container.visibility = View.VISIBLE
                                // åˆ·æ–°ç»„æ ‡ç­¾æ ï¼Œç¡®ä¿å†…å®¹æ­£ç¡®
                                refreshGroupTabs()
                            }
                        }
                        // ğŸ”§ ä¿®å¤ç™½è‰²èƒŒæ™¯ï¼šåŠ¨ç”»ç»“æŸåå†æ¬¡ç¡®è®¤èƒŒæ™¯é€æ˜
                        val webViewContainer = findViewById<FrameLayout>(R.id.browser_webview_container)
                        webViewContainer?.setBackgroundColor(Color.TRANSPARENT)
                        val swipeRefreshLayout = findViewById<androidx.swiperefreshlayout.widget.SwipeRefreshLayout>(R.id.browser_swipe_refresh)
                        swipeRefreshLayout?.setBackgroundColor(Color.TRANSPARENT)
                    }
                })

                start()
            }

            Log.d(TAG, "å¼€å§‹æ˜¾ç¤ºå·¥å…·æ ï¼Œç›®æ ‡é«˜åº¦: $targetToolbarHeight")

        } catch (e: Exception) {
            Log.e(TAG, "å¼€å§‹å·¥å…·æ æ˜¾ç¤ºåŠ¨ç”»å¤±è´¥", e)
        }
    }

    /**
     * éšè—é¡¶éƒ¨ç»„æ ‡ç­¾æ 
     * ğŸ”§ æ–°å¢ï¼šåœ¨é¡µé¢ä¸‹æ»‘æ—¶åŠ¨æ€éšè—ç»„æ ‡ç­¾æ 
     */
    private fun hideGroupTabsContainer() {
        try {
            val container = groupTabsContainer ?: return
            
            // å¦‚æœå·²ç»éšè—æˆ–ä¸å¯è§ï¼Œç›´æ¥è¿”å›
            if (container.visibility != View.VISIBLE) {
                return
            }
            
            // å–æ¶ˆä¹‹å‰çš„åŠ¨ç”»
            groupTabsAnimator?.cancel()
            
            val containerHeight = if (container.height > 0) {
                container.height.toFloat()
            } else {
                dpToPx(48f)
            }
            
            // åˆ›å»ºéšè—åŠ¨ç”»
            groupTabsAnimator = android.animation.ValueAnimator.ofFloat(0f, 1f).apply {
                duration = 280L
                interpolator = android.view.animation.PathInterpolator(0.25f, 0.1f, 0.25f, 1.0f)
                
                addUpdateListener { animator ->
                    val progress = animator.animatedValue as Float
                    val easedProgress = progress * progress // ç¼“åŠ¨æ•ˆæœ
                    
                    // å‘ä¸‹ç§»åŠ¨å¹¶æ·¡å‡º
                    container.translationY = containerHeight * easedProgress
                    container.alpha = 1f - 0.95f * easedProgress
                    
                    // åŠ¨æ€è°ƒæ•´é«˜åº¦
                    val currentHeight = (containerHeight * (1f - easedProgress)).toInt()
                    val layoutParams = container.layoutParams
                    layoutParams.height = currentHeight
                    container.layoutParams = layoutParams
                }
                
                addListener(object : android.animation.AnimatorListenerAdapter() {
                    override fun onAnimationEnd(animation: android.animation.Animator) {
                        container.visibility = View.GONE
                        container.translationY = 0f
                        container.alpha = 1f
                        val layoutParams = container.layoutParams
                        layoutParams.height = containerHeight.toInt()
                        container.layoutParams = layoutParams
                    }
                })
                
                start()
            }
            
            Log.d(TAG, "éšè—ç»„æ ‡ç­¾æ åŠ¨ç”»å¼€å§‹")
            
        } catch (e: Exception) {
            Log.e(TAG, "éšè—ç»„æ ‡ç­¾æ å¤±è´¥", e)
        }
    }
    
    /**
     * æ˜¾ç¤ºé¡¶éƒ¨ç»„æ ‡ç­¾æ 
     * ğŸ”§ æ–°å¢ï¼šåœ¨é¡µé¢ä¸Šæ»‘æ—¶åŠ¨æ€æ˜¾ç¤ºç»„æ ‡ç­¾æ 
     */
    private fun showGroupTabsContainer() {
        try {
            val container = groupTabsContainer ?: return
            
            // å¦‚æœå·²ç»å¯è§ï¼Œç›´æ¥è¿”å›
            if (container.visibility == View.VISIBLE && container.alpha >= 1f) {
                return
            }
            
            // å–æ¶ˆä¹‹å‰çš„åŠ¨ç”»
            groupTabsAnimator?.cancel()
            
            val targetHeight = if (container.height > 0) {
                container.height.toFloat()
            } else {
                dpToPx(48f)
            }
            
            // è®¾ç½®ä¸ºå¯è§ï¼Œä½†åˆå§‹é«˜åº¦ä¸º0
            if (container.visibility != View.VISIBLE) {
                container.visibility = View.VISIBLE
                val layoutParams = container.layoutParams
                layoutParams.height = 0
                container.layoutParams = layoutParams
                container.translationY = targetHeight
                container.alpha = 0.1f
            }
            
            // åˆ›å»ºæ˜¾ç¤ºåŠ¨ç”»
            groupTabsAnimator = android.animation.ValueAnimator.ofFloat(0f, 1f).apply {
                duration = 280L
                interpolator = android.view.animation.PathInterpolator(0.25f, 0.1f, 0.25f, 1.0f)
                
                addUpdateListener { animator ->
                    val progress = animator.animatedValue as Float
                    val easedProgress = progress * progress // ç¼“åŠ¨æ•ˆæœ
                    
                    // å‘ä¸Šç§»åŠ¨å¹¶æ·¡å…¥
                    container.translationY = targetHeight * (1f - easedProgress)
                    container.alpha = 0.1f + 0.9f * easedProgress
                    
                    // åŠ¨æ€è°ƒæ•´é«˜åº¦
                    val currentHeight = (targetHeight * easedProgress).toInt()
                    val layoutParams = container.layoutParams
                    layoutParams.height = currentHeight
                    container.layoutParams = layoutParams
                }
                
                addListener(object : android.animation.AnimatorListenerAdapter() {
                    override fun onAnimationEnd(animation: android.animation.Animator) {
                        container.translationY = 0f
                        container.alpha = 1f
                        val layoutParams = container.layoutParams
                        layoutParams.height = targetHeight.toInt()
                        container.layoutParams = layoutParams
                    }
                })
                
                start()
            }
            
            Log.d(TAG, "æ˜¾ç¤ºç»„æ ‡ç­¾æ åŠ¨ç”»å¼€å§‹")
            
        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºç»„æ ‡ç­¾æ å¤±è´¥", e)
        }
    }
    
    // ç»„æ ‡ç­¾æ åŠ¨ç”»å™¨
    private var groupTabsAnimator: android.animation.ValueAnimator? = null
    
    /**
     * è®¾ç½®åº•éƒ¨å¿«æ·æ“ä½œæ 
     */
    private fun setupQuickActionsBar() {
        try {
            // è®¾ç½®æŒ‰é’®ç‚¹å‡»ç›‘å¬å™¨
            findViewById<ImageButton>(R.id.quick_action_back)?.setOnClickListener {
                handleQuickActionBack()
            }
            
            findViewById<ImageButton>(R.id.quick_action_forward)?.setOnClickListener {
                handleQuickActionForward()
            }
            
            findViewById<ImageButton>(R.id.quick_action_refresh)?.setOnClickListener {
                handleQuickActionRefresh()
            }
            
            findViewById<ImageButton>(R.id.quick_action_close)?.setOnClickListener {
                handleQuickActionClose()
            }
            
            findViewById<ImageButton>(R.id.quick_action_undo_close)?.setOnClickListener {
                handleQuickActionUndoClose()
            }
            
            findViewById<ImageButton>(R.id.quick_action_find)?.setOnClickListener {
                handleQuickActionFind()
            }
            
            findViewById<ImageButton>(R.id.quick_action_bookmark)?.setOnClickListener {
                handleQuickActionBookmark()
            }
            
            findViewById<ImageButton>(R.id.quick_action_share)?.setOnClickListener {
                handleQuickActionShare()
            }
            
            // æ ¹æ®ä¸»é¢˜è®¾ç½®èƒŒæ™¯
            updateQuickActionsBarTheme()
            
            // ğŸ”§ ä¿®å¤ï¼šåˆå§‹åŒ–æ—¶ç¡®ä¿å¿«æ·æ“ä½œæ å¤„äºæ­£ç¡®çš„åˆå§‹çŠ¶æ€ï¼ˆå®Œå…¨éšè—åœ¨åº•éƒ¨ä¸‹æ–¹ï¼‰
            browserQuickActionsBar.post {
                // ç¡®ä¿å¸ƒå±€å·²æµ‹é‡
                browserQuickActionsBar.measure(
                    View.MeasureSpec.makeMeasureSpec(browserQuickActionsBar.width, View.MeasureSpec.EXACTLY),
                    View.MeasureSpec.makeMeasureSpec(0, View.MeasureSpec.UNSPECIFIED)
                )
                
                val initialHeight = browserQuickActionsBar.measuredHeight.toFloat()
                if (initialHeight > 0f) {
                    // è®¾ç½®åˆå§‹çŠ¶æ€ï¼šå®Œå…¨éšè—åœ¨åº•éƒ¨ä¸‹æ–¹ï¼Œé€æ˜
                    browserQuickActionsBar.translationY = initialHeight
                    browserQuickActionsBar.alpha = 0f
                    browserQuickActionsBar.visibility = View.GONE
                } else {
                    // å¦‚æœé«˜åº¦è¿˜æœªæµ‹é‡ï¼Œä½¿ç”¨é»˜è®¤å€¼
                    val defaultHeight = dpToPx(72f)
                    browserQuickActionsBar.translationY = defaultHeight
                    browserQuickActionsBar.alpha = 0f
                    browserQuickActionsBar.visibility = View.GONE
                }
            }
            
            Log.d(TAG, "å¿«æ·æ“ä½œæ åˆå§‹åŒ–å®Œæˆ")
        } catch (e: Exception) {
            Log.e(TAG, "è®¾ç½®å¿«æ·æ“ä½œæ å¤±è´¥", e)
        }
    }
    
    /**
     * æ›´æ–°å¿«æ·æ“ä½œæ ä¸»é¢˜ï¼ˆæš—è‰²/äº®è‰²ï¼‰
     */
    private fun updateQuickActionsBarTheme() {
        try {
            val isDarkMode = (resources.configuration.uiMode and android.content.res.Configuration.UI_MODE_NIGHT_MASK) == 
                            android.content.res.Configuration.UI_MODE_NIGHT_YES
            
            // åˆ›å»ºåŠé€æ˜èƒŒæ™¯
            val backgroundColor = if (isDarkMode) {
                0xE0333333.toInt() // æš—è‰²æ¨¡å¼ï¼šæ·±ç°åŠé€æ˜
            } else {
                0xE0F5F5F5.toInt() // äº®è‰²æ¨¡å¼ï¼šæµ…ç°åŠé€æ˜
            }
            
            val backgroundDrawable = android.graphics.drawable.GradientDrawable().apply {
                setColor(backgroundColor)
                cornerRadius = dpToPx(16f) // åœ†è§’
            }
            
            browserQuickActionsBar.background = backgroundDrawable
            
            // æ›´æ–°æŒ‰é’®é¢œè‰²
            val tintColor = if (isDarkMode) {
                android.graphics.Color.WHITE
            } else {
                android.graphics.Color.BLACK
            }
            
            for (i in 0 until browserQuickActionsBar.childCount) {
                val child = browserQuickActionsBar.getChildAt(i)
                if (child is ImageButton) {
                    child.imageTintList = android.content.res.ColorStateList.valueOf(tintColor)
                }
            }
            
            Log.d(TAG, "å¿«æ·æ“ä½œæ ä¸»é¢˜å·²æ›´æ–°ï¼š${if (isDarkMode) "æš—è‰²" else "äº®è‰²"}")
        } catch (e: Exception) {
            Log.e(TAG, "æ›´æ–°å¿«æ·æ“ä½œæ ä¸»é¢˜å¤±è´¥", e)
        }
    }
    
    /**
     * æ˜¾ç¤ºå¿«æ·æ“ä½œæ ï¼ˆç‹¬ç«‹æ˜¾ç¤ºï¼Œä¸ä¾èµ–åº•éƒ¨å¯¼èˆªæ ï¼‰
     */
    private fun showQuickActionsBar() {
        if (isQuickActionsBarVisible) return
        
        try {
            isQuickActionsBarVisible = true
            quickActionsBarAnimator?.cancel()
            
            // ğŸ”§ é‡æ–°è®¾è®¡ï¼šç¡®ä¿æ“ä½œå·¥å…·æ ç›´æ¥ä»åº•éƒ¨å¾€ä¸Šæµ®ï¼Œé¿å…ä»tabåŒºåŸŸä¸Šæ–¹ä¸‹æ»‘
            // 1. å…ˆè®¾ç½®ä¸ºVISIBLEä½†alphaä¸º0ï¼Œè®©ç³»ç»Ÿå®Œæˆå¸ƒå±€ï¼ˆlayout_gravity="bottom"ä¼šç”Ÿæ•ˆï¼‰
            // 2. ç«‹å³è®¾ç½®translationYä¸ºåº•éƒ¨ä¸‹æ–¹ï¼Œé¿å…å…ˆå‡ºç°åœ¨é”™è¯¯ä½ç½®
            // 3. ç„¶åå¼€å§‹ä»åº•éƒ¨å¾€ä¸Šæµ®çš„åŠ¨ç”»
            if (browserQuickActionsBar.visibility == View.GONE) {
                // å…ˆè®¾ç½®ä¸ºVISIBLEä½†å®Œå…¨é€æ˜ï¼Œè®©ç³»ç»Ÿå®Œæˆå¸ƒå±€
                browserQuickActionsBar.alpha = 0f
                browserQuickActionsBar.visibility = View.VISIBLE
            }
            
            // ç­‰å¾…å¸ƒå±€å®Œæˆ
            browserQuickActionsBar.post {
                browserQuickActionsBar.post {
                    // å¼ºåˆ¶æµ‹é‡å¸ƒå±€ï¼Œç¡®ä¿é«˜åº¦å‡†ç¡®
                    browserQuickActionsBar.measure(
                        View.MeasureSpec.makeMeasureSpec(browserQuickActionsBar.width, View.MeasureSpec.EXACTLY),
                        View.MeasureSpec.makeMeasureSpec(0, View.MeasureSpec.UNSPECIFIED)
                    )
                    
                    val actualHeight = browserQuickActionsBar.measuredHeight.toFloat()
                    val defaultHeight = if (actualHeight <= 0f) {
                        Log.w(TAG, "å¿«æ·æ“ä½œæ é«˜åº¦ä¸º0ï¼Œä½¿ç”¨é»˜è®¤å€¼")
                        dpToPx(72f) // é»˜è®¤é«˜åº¦72dp
                    } else {
                        actualHeight
                    }
                    
                    // ğŸ”§ å…³é”®ä¿®å¤ï¼šç«‹å³è®¾ç½®translationYä¸ºåº•éƒ¨ä¸‹æ–¹ï¼Œé¿å…å…ˆå‡ºç°åœ¨tabåŒºåŸŸä¸Šæ–¹
                    // è¿™æ ·æ“ä½œå·¥å…·æ ä¼šç›´æ¥ä»åº•éƒ¨ä¸‹æ–¹å¾€ä¸Šæµ®ï¼Œä¸ä¼šæœ‰ä¸‹æ»‘çš„åŠ¨ç”»
                    browserQuickActionsBar.translationY = defaultHeight
                    browserQuickActionsBar.alpha = 0f
                    
                    // ğŸ”§ ä¿®å¤ç™½è‰²èƒŒæ™¯ï¼šç¡®ä¿WebViewå®¹å™¨èƒŒæ™¯é€æ˜ï¼Œé¿å…æ˜¾ç¤ºç™½è‰²èƒŒæ™¯
                    val webViewContainer = findViewById<FrameLayout>(R.id.browser_webview_container)
                    webViewContainer?.setBackgroundColor(Color.TRANSPARENT)
                    
                    // å¼€å§‹ä»åº•éƒ¨æ»‘å…¥çš„åŠ¨ç”»
                    quickActionsBarAnimator = android.animation.ValueAnimator.ofFloat(0f, 1f).apply {
                        duration = 280L // ğŸ”§ ä¼˜åŒ–ï¼šç»Ÿä¸€åŠ¨ç”»æ—¶é•¿ä¸º280ms
                        // ğŸ”§ ä¼˜åŒ–ï¼šä½¿ç”¨iOSé£æ ¼çš„ç¼“åŠ¨æ›²çº¿
                        interpolator = android.view.animation.PathInterpolator(0.25f, 0.1f, 0.25f, 1.0f)
                        
                        addUpdateListener { animator ->
                            val progress = animator.animatedValue as Float
                            // ğŸ”§ ä¼˜åŒ–ï¼šä½¿ç”¨å¹³æ»‘çš„ç¼“åŠ¨å‡½æ•°
                            val easedProgress = progress * progress * (3f - 2f * progress)
                            
                            // ğŸ”§ å…³é”®ä¿®å¤ï¼šä»åº•éƒ¨ä¸‹æ–¹ï¼ˆtranslationY=defaultHeightï¼‰æ»‘å…¥åˆ°å±å¹•åº•éƒ¨ï¼ˆtranslationY=0ï¼‰
                            // translationYä»æ­£æ•°é€æ¸å˜ä¸º0ï¼Œå®ç°ä»åº•éƒ¨æ»‘å‡ºçš„æ•ˆæœ
                            browserQuickActionsBar.translationY = defaultHeight * (1f - easedProgress)
                            browserQuickActionsBar.alpha = easedProgress
                        }
                        
                        addListener(object : android.animation.AnimatorListenerAdapter() {
                            override fun onAnimationEnd(animation: android.animation.Animator) {
                                // ç¡®ä¿æœ€ç»ˆä½ç½®ç²¾ç¡®ä¸º0ï¼Œé¿å…åå·®
                                browserQuickActionsBar.translationY = 0f
                                browserQuickActionsBar.alpha = 1f
                                Log.d(TAG, "å¿«æ·æ“ä½œæ æ˜¾ç¤ºåŠ¨ç”»å®Œæˆï¼Œå·²ä»åº•éƒ¨æ»‘å‡º")
                            }
                        })
                        
                        start()
                    }
                    
                    Log.d(TAG, "å¿«æ·æ“ä½œæ æ˜¾ç¤ºåŠ¨ç”»å¼€å§‹ï¼Œé«˜åº¦: $defaultHeightï¼Œä»åº•éƒ¨æ»‘å‡º")
                }
            }
        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºå¿«æ·æ“ä½œæ å¤±è´¥", e)
        }
    }
    
    /**
     * æ˜¾ç¤ºåŠ è½½é®ç½©å±‚ï¼ˆå¸¦åŠ¨ç”»ï¼‰
     * ğŸ”§ æ–°å¢ï¼šåœ¨é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºï¼Œé®æŒ¡åŠŸèƒ½ä¸»é¡µæŒ‰é’®
     */
    private fun showLoadingOverlay() {
        browserLoadingOverlay?.let { overlay ->
            try {
                // å¦‚æœå·²ç»å¯è§ï¼Œä¸éœ€è¦é‡å¤æ˜¾ç¤º
                if (overlay.visibility == View.VISIBLE) {
                    return
                }
                
                // å–æ¶ˆä¹‹å‰çš„åŠ¨ç”»
                overlay.animate()?.cancel()
                
                // è®¾ç½®åˆå§‹çŠ¶æ€ï¼šå®Œå…¨é€æ˜
                overlay.alpha = 0f
                overlay.visibility = View.VISIBLE
                
                // æ·¡å…¥åŠ¨ç”»
                overlay.animate()
                    .alpha(1f)
                    .setDuration(200L)
                    .setInterpolator(android.view.animation.DecelerateInterpolator())
                    .setListener(null)
                    .start()
                
                Log.d(TAG, "æ˜¾ç¤ºåŠ è½½é®ç½©å±‚")
            } catch (e: Exception) {
                Log.e(TAG, "æ˜¾ç¤ºåŠ è½½é®ç½©å±‚å¤±è´¥", e)
            }
        }
    }
    
    /**
     * éšè—åŠ è½½é®ç½©å±‚ï¼ˆå¸¦åŠ¨ç”»ï¼‰
     * ğŸ”§ æ–°å¢ï¼šåœ¨é¡µé¢åŠ è½½å®Œæˆæ—¶éšè—
     */
    private fun hideLoadingOverlay() {
        browserLoadingOverlay?.let { overlay ->
            try {
                // å¦‚æœå·²ç»éšè—ï¼Œä¸éœ€è¦é‡å¤éšè—
                if (overlay.visibility != View.VISIBLE) {
                    return
                }
                
                // å–æ¶ˆä¹‹å‰çš„åŠ¨ç”»
                overlay.animate()?.cancel()
                
                // æ·¡å‡ºåŠ¨ç”»
                overlay.animate()
                    .alpha(0f)
                    .setDuration(200L)
                    .setInterpolator(android.view.animation.AccelerateInterpolator())
                    .setListener(object : android.animation.AnimatorListenerAdapter() {
                        override fun onAnimationEnd(animation: android.animation.Animator) {
                            overlay.visibility = View.GONE
                            overlay.alpha = 1f
                            Log.d(TAG, "éšè—åŠ è½½é®ç½©å±‚å®Œæˆ")
                        }
                    })
                    .start()
                
                Log.d(TAG, "å¼€å§‹éšè—åŠ è½½é®ç½©å±‚")
            } catch (e: Exception) {
                Log.e(TAG, "éšè—åŠ è½½é®ç½©å±‚å¤±è´¥", e)
                // å¦‚æœåŠ¨ç”»å¤±è´¥ï¼Œç›´æ¥éšè—
                overlay.visibility = View.GONE
            }
        }
    }
    
    /**
     * éšè—å¿«æ·æ“ä½œæ 
     */
    private fun hideQuickActionsBar() {
        if (!isQuickActionsBarVisible) return
        
        try {
            isQuickActionsBarVisible = false
            quickActionsBarAnimator?.cancel()
            
            // è·å–å½“å‰ä½ç½®å’Œé«˜åº¦ï¼ˆä½¿ç”¨postç¡®ä¿å¸ƒå±€å·²æµ‹é‡ï¼‰
            browserQuickActionsBar.post {
                // å¼ºåˆ¶æµ‹é‡å¸ƒå±€
                browserQuickActionsBar.measure(
                    View.MeasureSpec.makeMeasureSpec(browserQuickActionsBar.width, View.MeasureSpec.EXACTLY),
                    View.MeasureSpec.makeMeasureSpec(0, View.MeasureSpec.UNSPECIFIED)
                )
                
                val startY = browserQuickActionsBar.translationY.coerceAtLeast(0f)
                val barHeight = browserQuickActionsBar.measuredHeight.toFloat()
                
                // å¦‚æœé«˜åº¦ä¸º0ï¼Œä½¿ç”¨é»˜è®¤å€¼
                val actualBarHeight = if (barHeight <= 0f) {
                    dpToPx(72f)
                } else {
                    barHeight
                }
                
                // è·å–åº•éƒ¨å¯¼èˆªæ é«˜åº¦ï¼ˆå¦‚æœå³å°†æ˜¾ç¤ºï¼‰
                val bottomNav = findViewById<LinearLayout>(R.id.bottom_navigation)
                val bottomNavHeight = if (bottomNav?.visibility == View.VISIBLE && bottomNav.height > 0) {
                    bottomNav.height.toFloat()
                } else {
                    0f
                }
                
                // ç›®æ ‡ä½ç½®ï¼šå®Œå…¨éšè—åœ¨å±å¹•ä¸‹æ–¹ï¼ˆè€ƒè™‘åº•éƒ¨å¯¼èˆªæ ï¼‰
                val endY = actualBarHeight + bottomNavHeight
                
                quickActionsBarAnimator = android.animation.ValueAnimator.ofFloat(0f, 1f).apply {
                    duration = 200
                    interpolator = android.view.animation.AccelerateInterpolator()
                    
                    addUpdateListener { animator ->
                        val progress = animator.animatedValue as Float
                        browserQuickActionsBar.alpha = 1f - progress
                        // ä»å½“å‰ä½ç½®åŠ¨ç”»åˆ°å®Œå…¨éšè—ä½ç½®
                        browserQuickActionsBar.translationY = startY + (endY - startY) * progress
                    }
                    
                    addListener(object : android.animation.AnimatorListenerAdapter() {
                        override fun onAnimationEnd(animation: android.animation.Animator) {
                            // ç¡®ä¿æœ€ç»ˆä½ç½®æ­£ç¡®ï¼Œå¹¶éšè—
                            browserQuickActionsBar.translationY = endY
                            browserQuickActionsBar.alpha = 0f
                            browserQuickActionsBar.visibility = View.GONE
                        }
                    })
                    
                    start()
                }
                
                Log.d(TAG, "å¿«æ·æ“ä½œæ éšè—åŠ¨ç”»å¼€å§‹ï¼Œä» $startY åˆ° $endY")
            }
        } catch (e: Exception) {
            Log.e(TAG, "éšè—å¿«æ·æ“ä½œæ å¤±è´¥", e)
        }
    }
    
    /**
     * å¿«æ·æ“ä½œï¼šåé€€
     */
    private fun handleQuickActionBack() {
        try {
            val currentWebView = paperStackWebViewManager?.getCurrentTab()?.webView
            if (currentWebView?.canGoBack() == true) {
                currentWebView.goBack()
            } else {
                Toast.makeText(this, "æ— æ³•åé€€", Toast.LENGTH_SHORT).show()
            }
        } catch (e: Exception) {
            Log.e(TAG, "åé€€æ“ä½œå¤±è´¥", e)
        }
    }
    
    /**
     * å¿«æ·æ“ä½œï¼šå‰è¿›
     */
    private fun handleQuickActionForward() {
        try {
            val currentWebView = paperStackWebViewManager?.getCurrentTab()?.webView
            if (currentWebView?.canGoForward() == true) {
                currentWebView.goForward()
            } else {
                Toast.makeText(this, "æ— æ³•å‰è¿›", Toast.LENGTH_SHORT).show()
            }
        } catch (e: Exception) {
            Log.e(TAG, "å‰è¿›æ“ä½œå¤±è´¥", e)
        }
    }
    
    /**
     * å¿«æ·æ“ä½œï¼šåˆ·æ–°
     */
    private fun handleQuickActionRefresh() {
        try {
            paperStackWebViewManager?.getCurrentTab()?.webView?.reload()
        } catch (e: Exception) {
            Log.e(TAG, "åˆ·æ–°æ“ä½œå¤±è´¥", e)
        }
    }
    
    // æ’¤é”€å…³é—­åŠŸèƒ½ç›¸å…³å˜é‡
    private data class ClosedTabInfo(
        val id: String,
        val title: String,
        val url: String,
        val closeTime: Long = System.currentTimeMillis()
    )
    private val closedTabsHistory = mutableListOf<ClosedTabInfo>()
    private val MAX_CLOSED_TABS_HISTORY = 10 // æœ€å¤šä¿å­˜10ä¸ªå…³é—­çš„æ ‡ç­¾é¡µ
    
    /**
     * å¿«æ·æ“ä½œï¼šå…³é—­
     */
    private fun handleQuickActionClose() {
        try {
            // å…³é—­å½“å‰æ ‡ç­¾é¡µ
            val currentTab = paperStackWebViewManager?.getCurrentTab()
            if (currentTab != null) {
                // ä¿å­˜å…³é—­çš„æ ‡ç­¾é¡µä¿¡æ¯
                saveClosedTab(currentTab)
                
                // å…³é—­æ ‡ç­¾é¡µ
                paperStackWebViewManager?.removeTab(currentTab.id)
                // âš¡ ç«‹å³æ›´æ–°é¡µé¢æ•°é‡æ˜¾ç¤º
                handler.post {
                    updatePageCountDisplay()
                }
            } else {
                Toast.makeText(this, "æ²¡æœ‰å¯å…³é—­çš„æ ‡ç­¾é¡µ", Toast.LENGTH_SHORT).show()
            }
        } catch (e: Exception) {
            Log.e(TAG, "å…³é—­æ“ä½œå¤±è´¥", e)
        }
    }
    
    /**
     * ä¿å­˜å…³é—­çš„æ ‡ç­¾é¡µä¿¡æ¯
     */
    private fun saveClosedTab(tab: com.example.aifloatingball.webview.PaperStackWebViewManager.WebViewTab) {
        try {
            val closedTabInfo = ClosedTabInfo(
                id = tab.id,
                title = tab.title,
                url = tab.url
            )
            
            // æ·»åŠ åˆ°å†å²åˆ—è¡¨æœ«å°¾ï¼ˆLIFOï¼‰
            closedTabsHistory.add(closedTabInfo)
            
            // é™åˆ¶å†å²è®°å½•æ•°é‡
            if (closedTabsHistory.size > MAX_CLOSED_TABS_HISTORY) {
                closedTabsHistory.removeAt(0) // ç§»é™¤æœ€æ—§çš„
            }
            
            Log.d(TAG, "ä¿å­˜å…³é—­çš„æ ‡ç­¾é¡µ: ${tab.title}, å½“å‰å†å²æ•°é‡: ${closedTabsHistory.size}")
        } catch (e: Exception) {
            Log.e(TAG, "ä¿å­˜å…³é—­æ ‡ç­¾é¡µå¤±è´¥", e)
        }
    }
    
    /**
     * å¿«æ·æ“ä½œï¼šæ’¤å›å…³é—­
     */
    private fun handleQuickActionUndoClose() {
        try {
            if (closedTabsHistory.isEmpty()) {
                Toast.makeText(this, "æ²¡æœ‰å¯æ¢å¤çš„æ ‡ç­¾é¡µ", Toast.LENGTH_SHORT).show()
                return
            }
            
            // è·å–æœ€è¿‘å…³é—­çš„æ ‡ç­¾é¡µï¼ˆLIFOï¼‰
            val lastClosedTab = closedTabsHistory.removeAt(closedTabsHistory.size - 1)
            
            // æ¢å¤æ ‡ç­¾é¡µ
            paperStackWebViewManager?.let { manager ->
                // åˆ›å»ºæ–°æ ‡ç­¾é¡µå¹¶åŠ è½½URL
                val restoredTab = manager.addTab(lastClosedTab.url, lastClosedTab.title)
                
                // æ‰¾åˆ°æ–°æ ‡ç­¾é¡µçš„ç´¢å¼•å¹¶åˆ‡æ¢
                val tabIndex = manager.getTabCount() - 1 // addTabä¼šåœ¨æœ«å°¾æ·»åŠ ï¼Œæ‰€ä»¥ç´¢å¼•æ˜¯æœ€åä¸€ä¸ª
                manager.switchToTab(tabIndex)
                
                // âš¡ ç«‹å³æ›´æ–°é¡µé¢æ•°é‡æ˜¾ç¤º
                handler.post {
                    updatePageCountDisplay()
                }
                
                Toast.makeText(this, "å·²æ¢å¤æ ‡ç­¾é¡µ: ${lastClosedTab.title}", Toast.LENGTH_SHORT).show()
                Log.d(TAG, "æ¢å¤æ ‡ç­¾é¡µ: ${lastClosedTab.title}, URL: ${lastClosedTab.url}")
            } ?: run {
                Toast.makeText(this, "æ ‡ç­¾é¡µç®¡ç†å™¨ä¸å¯ç”¨", Toast.LENGTH_SHORT).show()
            }
        } catch (e: Exception) {
            Log.e(TAG, "æ’¤å›å…³é—­æ“ä½œå¤±è´¥", e)
            Toast.makeText(this, "æ¢å¤å¤±è´¥: ${e.message}", Toast.LENGTH_SHORT).show()
        }
    }
    
    // æŸ¥æ‰¾åŠŸèƒ½ç›¸å…³å˜é‡
    private var findDialog: android.app.AlertDialog? = null
    private var findEditText: android.widget.EditText? = null
    private var findResultCount = 0
    private var findCurrentIndex = 0
    
    /**
     * å¿«æ·æ“ä½œï¼šæŸ¥æ‰¾
     */
    private fun handleQuickActionFind() {
        try {
            val currentTab = paperStackWebViewManager?.getCurrentTab()
            val webView = currentTab?.webView
            if (webView == null) {
                Toast.makeText(this, "å½“å‰æ— æ´»åŠ¨é¡µé¢", Toast.LENGTH_SHORT).show()
                return
            }
            
            // æ˜¾ç¤ºæŸ¥æ‰¾å¯¹è¯æ¡†
            showFindDialog(webView)
        } catch (e: Exception) {
            Log.e(TAG, "æŸ¥æ‰¾æ“ä½œå¤±è´¥", e)
            Toast.makeText(this, "æŸ¥æ‰¾åŠŸèƒ½å¤±è´¥: ${e.message}", Toast.LENGTH_SHORT).show()
        }
    }
    
    /**
     * æ˜¾ç¤ºæŸ¥æ‰¾å¯¹è¯æ¡†
     */
    private fun showFindDialog(webView: android.webkit.WebView) {
        try {
            // å¦‚æœå·²æœ‰å¯¹è¯æ¡†ï¼Œå…ˆå…³é—­
            findDialog?.dismiss()
            
            // åˆ›å»ºæŸ¥æ‰¾è¾“å…¥æ¡†
            findEditText = android.widget.EditText(this).apply {
                hint = "è¾“å…¥è¦æŸ¥æ‰¾çš„å†…å®¹"
                setSingleLine(true)
            }
            
            // åˆ›å»ºå¯¹è¯æ¡†
            findDialog = android.app.AlertDialog.Builder(this)
                .setTitle("æŸ¥æ‰¾")
                .setView(findEditText)
                .setPositiveButton("æŸ¥æ‰¾ä¸‹ä¸€ä¸ª") { _, _ ->
                    val query = findEditText?.text?.toString() ?: ""
                    if (query.isNotEmpty()) {
                        findInPage(webView, query, true)
                    }
                }
                .setNeutralButton("æŸ¥æ‰¾ä¸Šä¸€ä¸ª") { _, _ ->
                    val query = findEditText?.text?.toString() ?: ""
                    if (query.isNotEmpty()) {
                        findInPage(webView, query, false)
                    }
                }
                .setNegativeButton("å…³é—­") { dialog, _ ->
                    clearFindResults(webView)
                    dialog.dismiss()
                }
                .setOnDismissListener {
                    clearFindResults(webView)
                    findDialog = null
                    findEditText = null
                }
                .create()
            
            findDialog?.show()
            
            // ç›‘å¬è¾“å…¥å˜åŒ–ï¼Œå®æ—¶æŸ¥æ‰¾
            findEditText?.addTextChangedListener(object : android.text.TextWatcher {
                override fun beforeTextChanged(s: CharSequence?, start: Int, count: Int, after: Int) {}
                override fun onTextChanged(s: CharSequence?, start: Int, before: Int, count: Int) {
                    val query = s?.toString() ?: ""
                    if (query.isNotEmpty()) {
                        findInPage(webView, query, true)
                    } else {
                        clearFindResults(webView)
                    }
                }
                override fun afterTextChanged(s: android.text.Editable?) {}
            })
            
        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºæŸ¥æ‰¾å¯¹è¯æ¡†å¤±è´¥", e)
        }
    }
    
    /**
     * åœ¨é¡µé¢ä¸­æŸ¥æ‰¾æ–‡æœ¬
     */
    private fun findInPage(webView: android.webkit.WebView, query: String, forward: Boolean) {
        try {
            if (android.os.Build.VERSION.SDK_INT >= android.os.Build.VERSION_CODES.O) {
                // Android 8.0+ ä½¿ç”¨æ–°çš„API
                webView.findAllAsync(query)
                
                // ç­‰å¾…æŸ¥æ‰¾å®Œæˆ
                webView.postDelayed({
                    if (android.os.Build.VERSION.SDK_INT >= android.os.Build.VERSION_CODES.O) {
                        val resultCount = webView.copyBackForwardList().size // è¿™æ˜¯ä¸€ä¸ªè¿‘ä¼¼å€¼
                        
                        if (forward) {
                            webView.findNext(true)
                        } else {
                            webView.findNext(false)
                        }
                        
                        // æ›´æ–°å¯¹è¯æ¡†æŒ‰é’®æ–‡æœ¬
                        findDialog?.getButton(android.app.AlertDialog.BUTTON_POSITIVE)?.text = "ä¸‹ä¸€ä¸ª"
                        findDialog?.getButton(android.app.AlertDialog.BUTTON_NEUTRAL)?.text = "ä¸Šä¸€ä¸ª"
                    }
                }, 100)
            } else {
                // Android 7.1åŠä»¥ä¸‹ä½¿ç”¨æ—§API
                @Suppress("DEPRECATION")
                val count = webView.findAll(query)
                
                if (count > 0) {
                    if (forward) {
                        @Suppress("DEPRECATION")
                        webView.findNext(true)
                    } else {
                        @Suppress("DEPRECATION")
                        webView.findNext(false)
                    }
                    findResultCount = count
                    findCurrentIndex = if (forward) {
                        (findCurrentIndex + 1) % count
                    } else {
                        (findCurrentIndex - 1 + count) % count
                    }
                } else {
                    findResultCount = 0
                    findCurrentIndex = 0
                }
            }
        } catch (e: Exception) {
            Log.e(TAG, "æŸ¥æ‰¾æ–‡æœ¬å¤±è´¥", e)
        }
    }
    
    /**
     * æ¸…é™¤æŸ¥æ‰¾ç»“æœ
     */
    private fun clearFindResults(webView: android.webkit.WebView) {
        try {
            if (android.os.Build.VERSION.SDK_INT >= android.os.Build.VERSION_CODES.O) {
                webView.clearMatches()
            } else {
                @Suppress("DEPRECATION")
                webView.findAll("")
            }
            findResultCount = 0
            findCurrentIndex = 0
        } catch (e: Exception) {
            Log.e(TAG, "æ¸…é™¤æŸ¥æ‰¾ç»“æœå¤±è´¥", e)
        }
    }
    
    /**
     * æ”¶è—é˜…è¯»æ¨¡å¼åˆ°AIåŠ©æ‰‹çš„ç”µå­ä¹¦æ”¶è—
     */
    private fun addReaderModeToEbookCollection() {
        try {
            val currentTab = paperStackWebViewManager?.getCurrentTab()
            val url = currentTab?.webView?.url ?: currentTab?.url
            val title = currentTab?.title ?: url ?: "é˜…è¯»æ¨¡å¼"
            
            if (url.isNullOrBlank()) {
                return
            }
            
            val collectionManager = com.example.aifloatingball.manager.UnifiedCollectionManager.getInstance(this)
            
            // æ£€æŸ¥æ˜¯å¦å·²æ”¶è—
            val existingCollection = collectionManager.getAllCollections()
                .find { 
                    it.collectionType == com.example.aifloatingball.model.CollectionType.EBOOK_BOOKMARK && 
                    it.extraData?.get("url") == url 
                }
            
            // æ„å»ºæ ‡ç­¾åˆ—è¡¨
            val tags = mutableListOf<String>().apply {
                add("é˜…è¯»æ¨¡å¼")
                add("æœç´¢Tab")
                // å°è¯•ä»URLæå–åŸŸåä½œä¸ºæ ‡ç­¾
                try {
                    val uri = android.net.Uri.parse(url)
                    uri.host?.let { host ->
                        val domain = host.split(".").takeLast(2).joinToString(".")
                        if (domain.isNotEmpty()) {
                            add(domain)
                        }
                    }
                } catch (e: Exception) {
                    // å¿½ç•¥è§£æé”™è¯¯
                }
            }
            
            // åˆ›å»ºç»Ÿä¸€æ”¶è—é¡¹
            val collectionItem = com.example.aifloatingball.model.UnifiedCollectionItem(
                id = url.hashCode().toString(), // ä½¿ç”¨URLçš„hashä½œä¸ºID
                title = title,
                content = url,
                preview = "é˜…è¯»æ¨¡å¼: $title",
                collectionType = com.example.aifloatingball.model.CollectionType.EBOOK_BOOKMARK,
                sourceLocation = "æœç´¢Tab",
                sourceDetail = "é˜…è¯»æ¨¡å¼",
                collectedTime = System.currentTimeMillis(),
                customTags = tags.distinct(),
                extraData = mapOf(
                    "url" to url,
                    "title" to title,
                    "isReaderMode" to "true",
                    "originalUrl" to url // ä½¿ç”¨å½“å‰URLä½œä¸ºåŸå§‹URL
                )
            )
            
            if (existingCollection != null) {
                // æ›´æ–°ç°æœ‰æ”¶è—
                collectionManager.updateCollection(collectionItem)
                Log.d(TAG, "æ›´æ–°é˜…è¯»æ¨¡å¼æ”¶è—: $title")
            } else {
                // æ·»åŠ æ–°æ”¶è—
                collectionManager.addCollection(collectionItem)
                Log.d(TAG, "æ·»åŠ é˜…è¯»æ¨¡å¼æ”¶è—: $title")
            }
        } catch (e: Exception) {
            Log.e(TAG, "æ”¶è—é˜…è¯»æ¨¡å¼åˆ°ç”µå­ä¹¦æ”¶è—å¤±è´¥", e)
        }
    }
    
    /**
     * å¿«æ·æ“ä½œï¼šæ”¶è—
     */
    private fun handleQuickActionBookmark() {
        try {
            val currentTab = paperStackWebViewManager?.getCurrentTab()
            val url = currentTab?.webView?.url
            val title = currentTab?.title ?: url ?: ""
            
            if (url.isNullOrBlank()) {
                Toast.makeText(this, "å½“å‰é¡µé¢æ— æ³•æ”¶è—", Toast.LENGTH_SHORT).show()
                return
            }
            
            // ä½¿ç”¨BookmarkManagerç»Ÿä¸€ç®¡ç†
            val bookmarkManager = com.example.aifloatingball.manager.BookmarkManager.getInstance(this)
            
            // æ£€æŸ¥æ˜¯å¦å·²æ”¶è—
            if (bookmarkManager.isBookmarkExist(url)) {
                Toast.makeText(this, "è¯¥ç½‘å€å·²åœ¨æ”¶è—ä¸­", Toast.LENGTH_SHORT).show()
                return
            }
            
            // åˆ›å»ºæ–°çš„ä¹¦ç­¾
            val bookmark = com.example.aifloatingball.model.Bookmark(
                title = title,
                url = url,
                folder = "é»˜è®¤",
                addTime = System.currentTimeMillis()
            )
            
            // å°è¯•è·å–favicon
            try {
                val favicon = currentTab?.webView?.favicon
                bookmarkManager.addBookmark(bookmark, favicon)
            } catch (e: Exception) {
                // å¦‚æœè·å–faviconå¤±è´¥ï¼Œä»ç„¶ä¿å­˜ä¹¦ç­¾
                bookmarkManager.addBookmark(bookmark, null)
            }
            
            Toast.makeText(this, "å·²æ·»åŠ åˆ°æ”¶è—", Toast.LENGTH_SHORT).show()
            Log.d(TAG, "æ·»åŠ æ”¶è—: title=$title, url=$url")
        } catch (e: Exception) {
            Log.e(TAG, "æ”¶è—æ“ä½œå¤±è´¥", e)
            Toast.makeText(this, "æ”¶è—å¤±è´¥: ${e.message}", Toast.LENGTH_SHORT).show()
        }
    }
    
    /**
     * å¿«æ·æ“ä½œï¼šåˆ†äº«
     */
    private fun handleQuickActionShare() {
        try {
            val currentTab = paperStackWebViewManager?.getCurrentTab()
            val url = currentTab?.webView?.url
            
            if (!url.isNullOrBlank()) {
                val shareIntent = Intent(Intent.ACTION_SEND).apply {
                    type = "text/plain"
                    putExtra(Intent.EXTRA_TEXT, url)
                    putExtra(Intent.EXTRA_SUBJECT, currentTab?.title ?: "")
                }
                startActivity(Intent.createChooser(shareIntent, "åˆ†äº«ç½‘é¡µ"))
            } else {
                Toast.makeText(this, "å½“å‰é¡µé¢æ— æ³•åˆ†äº«", Toast.LENGTH_SHORT).show()
            }
        } catch (e: Exception) {
            Log.e(TAG, "åˆ†äº«æ“ä½œå¤±è´¥", e)
        }
    }
    
    /**
     * éšè—åº•éƒ¨å¯¼èˆªæ ï¼ˆæœç´¢/å¯¹è¯/AI/è½¯ä»¶/è®¾ç½®ï¼‰
     */
    private fun hideBottomNavigation() {
        if (!isBottomNavVisible) return
        val bottomNav = findViewById<LinearLayout>(R.id.bottom_navigation) ?: return

        try {
            isBottomNavVisible = false
            bottomNavAnimator?.cancel()
            val navHeight = bottomNav.height.toFloat()
            if (navHeight <= 0f) {
                // å¦‚æœé«˜åº¦ä¸º0ï¼Œç›´æ¥éšè—
                bottomNav.visibility = View.GONE
                return
            }

            // åŒæ­¥éšè—åº•éƒ¨å¯¼èˆªæ å’Œæ˜¾ç¤ºå¿«æ·æ“ä½œæ 
            bottomNavAnimator = android.animation.ValueAnimator.ofFloat(0f, 1f).apply {
                duration = 250
                interpolator = android.view.animation.DecelerateInterpolator()
                addUpdateListener { anim ->
                    val progress = anim.animatedValue as Float
                    // åº•éƒ¨å¯¼èˆªæ å‘ä¸‹ç§»åŠ¨å¹¶æ·¡å‡º
                    bottomNav.translationY = navHeight * progress
                    bottomNav.alpha = 1f - 0.9f * progress
                }
                addListener(object : android.animation.AnimatorListenerAdapter() {
                    override fun onAnimationEnd(animation: android.animation.Animator) {
                        // ç¡®ä¿æœ€ç»ˆçŠ¶æ€æ­£ç¡®
                        bottomNav.translationY = navHeight
                        bottomNav.alpha = 0f
                        bottomNav.visibility = View.GONE
                    }
                })
                start()
            }
        } catch (e: Exception) {
            Log.e(TAG, "éšè—åº•éƒ¨å¯¼èˆªæ å¤±è´¥", e)
        }
    }

    /**
     * æ˜¾ç¤ºåº•éƒ¨å¯¼èˆªæ 
     */
    private fun showBottomNavigation() {
        if (isBottomNavVisible) return
        val bottomNav = findViewById<LinearLayout>(R.id.bottom_navigation) ?: return

        try {
            isBottomNavVisible = true
            bottomNavAnimator?.cancel()
            
            // é‡æ–°å‚ä¸å¸ƒå±€
            bottomNav.visibility = View.VISIBLE
            
            // ç¡®ä¿å¸ƒå±€å·²æµ‹é‡
            bottomNav.post {
                val navHeight = bottomNav.height.toFloat()
                if (navHeight <= 0f) {
                    Log.w(TAG, "åº•éƒ¨å¯¼èˆªæ é«˜åº¦ä¸º0ï¼Œæ— æ³•æ˜¾ç¤º")
                    return@post
                }
                
                // è·å–å½“å‰ä½ç½®ï¼ˆå¯èƒ½åœ¨éšè—çŠ¶æ€ï¼‰
                val currentTy = if (bottomNav.translationY > 0) bottomNav.translationY else navHeight
                
                // è®¾ç½®åˆå§‹çŠ¶æ€
                bottomNav.translationY = currentTy
                bottomNav.alpha = if (currentTy > 0) 0.1f else 1f
                
                bottomNavAnimator = android.animation.ValueAnimator.ofFloat(0f, 1f).apply {
                    duration = 250
                    interpolator = android.view.animation.DecelerateInterpolator()
                    addUpdateListener { anim ->
                        val progress = anim.animatedValue as Float
                        // ä»å½“å‰ä½ç½®åŠ¨ç”»åˆ°0ï¼ˆå±å¹•åº•éƒ¨ï¼‰
                        bottomNav.translationY = currentTy * (1f - progress)
                        val alphaProgress = 1f - (currentTy / navHeight) * (1f - progress)
                        bottomNav.alpha = 0.1f + 0.9f * alphaProgress
                    }
                    addListener(object : android.animation.AnimatorListenerAdapter() {
                        override fun onAnimationEnd(animation: android.animation.Animator) {
                            // ç¡®ä¿æœ€ç»ˆçŠ¶æ€æ­£ç¡®
                            bottomNav.translationY = 0f
                            bottomNav.alpha = 1f
                        }
                    })
                    start()
                }
            }
        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºåº•éƒ¨å¯¼èˆªæ å¤±è´¥", e)
        }
    }

    /**
     * è®¾ç½®æœç´¢æ¡†æŒ‰é’®åŠŸèƒ½
     */
    private fun setupSearchInputButtons() {
        try {
            // æ¸…ç©ºæŒ‰é’®åŠŸèƒ½å·²åœ¨ä¹‹å‰å®ç°
            // AIæŒ‰é’®åŠŸèƒ½å·²åœ¨ä¹‹å‰å®ç°

            // ç‚¹å‡»æˆ–è·å–ç„¦ç‚¹æ—¶ï¼šåˆ‡æ¢ä¸ºçœŸå®URLå¹¶å…¨é€‰
            browserSearchInput.setOnClickListener {
                try {
                    // ç¡®ä¿è¾“å…¥æ¡†å¯ä»¥è·å–ç„¦ç‚¹
                    browserSearchInput.isFocusable = true
                    browserSearchInput.isFocusableInTouchMode = true
                    browserSearchInput.requestFocus()
                    
                    // ç¼–è¾‘åœ°å€æ æ—¶éšè—ç«™ç‚¹å›¾æ ‡ï¼Œè…¾å‡ºç©ºé—´
                    browserBtnSite.visibility = View.GONE
                    updateAddressBarToCurrentUrlAndSelectAll()
                    
                    // å»¶è¿Ÿæ˜¾ç¤ºè¾“å…¥æ³•ï¼Œç¡®ä¿ç„¦ç‚¹å·²è®¾ç½®
                    handler.postDelayed({
                        val imm = getSystemService(Context.INPUT_METHOD_SERVICE) as? InputMethodManager
                        imm?.showSoftInput(browserSearchInput, InputMethodManager.SHOW_IMPLICIT)
                    }, 100)
                } catch (e: Exception) {
                    Log.e(TAG, "æœç´¢æ¡†ç‚¹å‡»å¤„ç†å¤±è´¥", e)
                }
            }
            browserSearchInput.setOnFocusChangeListener { _, hasFocus ->
                if (hasFocus) {
                    try {
                        browserBtnSite.visibility = View.GONE
                        updateAddressBarToCurrentUrlAndSelectAll()
                        // ğŸ”§ ä¿®å¤ï¼šå½“è¾“å…¥æ¡†è·å¾—ç„¦ç‚¹æ—¶ï¼Œæ˜¾ç¤ºæ–‡æœ¬å·¥å…·æ 
                        updateSearchInputToolbarVisibility()
                    } catch (_: Exception) {}
                } else {
                    // å¤±ç„¦åæ ¹æ®å½“å‰URLæ¢å¤faviconæŒ‰é’®
                    try {
                        val url = gestureCardWebViewManager?.getCurrentCard()?.url
                            ?: paperStackWebViewManager?.getCurrentTab()?.url
                            ?: unifiedWebViewManager.getCurrentActiveWebView()?.url
                        updateBrowserFaviconButtonForUrl(url)
                        // ğŸ”§ ä¿®å¤ï¼šå½“è¾“å…¥æ¡†å¤±å»ç„¦ç‚¹æ—¶ï¼Œéšè—æ–‡æœ¬å·¥å…·æ 
                        updateSearchInputToolbarVisibility()
                    } catch (_: Exception) {}
                }
            }

            // ç›‘å¬æœç´¢æ¡†æ–‡æœ¬å˜åŒ–ï¼Œæ§åˆ¶æ¸…ç©ºæŒ‰é’®æ˜¾ç¤º
            browserSearchInput.addTextChangedListener(object : android.text.TextWatcher {
                override fun beforeTextChanged(s: CharSequence?, start: Int, count: Int, after: Int) {}
                override fun onTextChanged(s: CharSequence?, start: Int, before: Int, count: Int) {}
                override fun afterTextChanged(s: android.text.Editable?) {
                    // æœ‰æ–‡æœ¬æ—¶æ˜¾ç¤ºæ¸…ç©ºæŒ‰é’®ï¼Œæ— æ–‡æœ¬æ—¶éšè—
                    browserBtnClear.visibility = if (s?.isNotEmpty() == true) View.VISIBLE else View.GONE

                    // ç¼–è¾‘æ€ï¼šä¿æŒéšè—faviconï¼Œé¿å…ç¼–è¾‘æ—¶å ä½
                    if (browserSearchInput.hasFocus()) {
                        browserBtnSite.visibility = View.GONE
                        return
                    }

                    // éç¼–è¾‘æ€ï¼šæ ¹æ®æ–‡æœ¬æ¢å¤favicon
                    val text = s?.toString()?.trim() ?: ""
                    val looksLikeUrl = text.startsWith("http://") || text.startsWith("https://") ||
                            (text.contains('.') && !text.contains(' '))
                    if (looksLikeUrl) {
                        updateBrowserFaviconButtonForUrl(text)
                    } else if (text.isEmpty()) {
                        browserBtnSite.visibility = View.GONE
                    }
                }
            })

            Log.d(TAG, "æœç´¢æ¡†æŒ‰é’®åŠŸèƒ½è®¾ç½®å®Œæˆ")

        } catch (e: Exception) {
            Log.e(TAG, "è®¾ç½®æœç´¢æ¡†æŒ‰é’®åŠŸèƒ½å¤±è´¥", e)
        }
    }

    /**
     * å°†åœ°å€æ ç«‹å³åˆ‡æ¢ä¸ºçœŸå®URLå¹¶å…¨é€‰ï¼Œæ˜¾ç¤ºè¾“å…¥æ³•
     */
    private fun updateAddressBarToCurrentUrlAndSelectAll() {
        val currentUrl = try {
            gestureCardWebViewManager?.getCurrentCard()?.url
                ?: paperStackWebViewManager?.getCurrentTab()?.url
                ?: unifiedWebViewManager.getCurrentActiveWebView()?.url
        } catch (_: Exception) { null }

        val finalUrl = if (!currentUrl.isNullOrBlank() && currentUrl != "about:blank") currentUrl else browserSearchInput.text?.toString() ?: ""
        browserSearchInput.setText(finalUrl)
        browserSearchInput.requestFocus()
        try {
            browserSearchInput.selectAll()
        } catch (_: Exception) {
            browserSearchInput.setSelection(0, browserSearchInput.text.length)
        }

        // æ˜¾ç¤ºè½¯é”®ç›˜
        val imm = getSystemService(Context.INPUT_METHOD_SERVICE) as? InputMethodManager
        imm?.showSoftInput(browserSearchInput, InputMethodManager.SHOW_IMPLICIT)
    }

    /**
     * è®¾ç½®å››åˆ†ä¹‹ä¸€åœ†å¼§æ“ä½œæ 
     */
    private fun setupQuarterArcOperationBar() {
        Log.d(TAG, "å¼€å§‹è®¾ç½®å››åˆ†ä¹‹ä¸€åœ†å¼§æ“ä½œæ ")

        quarterArcOperationBar = QuarterArcOperationBar(this).apply {
            // è®¾ç½®å¸ƒå±€å‚æ•° - ä½¿ç”¨è¶³å¤Ÿå¤§çš„å°ºå¯¸ç¡®ä¿ä¸è¢«æˆªæ–­
            val size = (300 * resources.displayMetrics.density).toInt()
            layoutParams = FrameLayout.LayoutParams(size, size).apply {
                // æ ¹æ®å·¦æ‰‹æ¨¡å¼è®¾ç½®ä½ç½®
                val isLeftHanded = settingsManager.isLeftHandedModeEnabled()
                gravity = if (isLeftHanded) {
                    android.view.Gravity.BOTTOM or android.view.Gravity.START
                } else {
                    android.view.Gravity.BOTTOM or android.view.Gravity.END
                }

                val margin = (16 * resources.displayMetrics.density).toInt()
                if (isLeftHanded) {
                    leftMargin = margin
                } else {
                    rightMargin = margin
                }
                bottomMargin = margin
            }

            // è®¾ç½®å·¦æ‰‹æ¨¡å¼
            setLeftHandedMode(settingsManager.isLeftHandedModeEnabled())

            // è®¾ç½®é«˜å±‚çº§
            elevation = 25f
            isClickable = true
            isFocusable = true

            // è®¾ç½®æ“ä½œç›‘å¬å™¨
            setOnOperationListener(object : QuarterArcOperationBar.OnOperationListener {
                override fun onRefresh() {
                    // åˆ·æ–°å½“å‰é¡µé¢
                    var refreshed = false

                    // ä¼˜å…ˆæ£€æŸ¥MobileCardManager
                    val mobileCurrentCard = mobileCardManager?.getCurrentCard()
                    if (mobileCurrentCard?.webView != null) {
                        mobileCurrentCard.webView.reload()
                        refreshed = true
                        Log.d(TAG, "å››åˆ†ä¹‹ä¸€åœ†å¼§æ“ä½œæ : æ‰‹æœºå¡ç‰‡é¡µé¢å·²åˆ·æ–°")
                    }

                    // å¦‚æœæ²¡æœ‰æ‰‹æœºå¡ç‰‡ï¼Œæ£€æŸ¥æ‰‹åŠ¿å¡ç‰‡
                    if (!refreshed) {
                        val gestureCurrentCard = gestureCardWebViewManager?.getCurrentCard()
                        if (gestureCurrentCard?.webView != null) {
                            gestureCurrentCard.webView.reload()
                            refreshed = true
                            Log.d(TAG, "å››åˆ†ä¹‹ä¸€åœ†å¼§æ“ä½œæ : æ‰‹åŠ¿å¡ç‰‡é¡µé¢å·²åˆ·æ–°")
                        }
                    }

                    if (refreshed) {
                        Toast.makeText(this@SimpleModeActivity, "é¡µé¢å·²åˆ·æ–°", Toast.LENGTH_SHORT).show()
                    } else {
                        Toast.makeText(this@SimpleModeActivity, "æ²¡æœ‰å¯åˆ·æ–°çš„é¡µé¢", Toast.LENGTH_SHORT).show()
                    }
                }

                override fun onNextTab() {
                    // åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªæ ‡ç­¾
                    var switched = false

                    // ä¼˜å…ˆæ£€æŸ¥MobileCardManager
                    val mobileCards = mobileCardManager?.getAllCards()
                    if (!mobileCards.isNullOrEmpty() && mobileCards.size > 1) {
                        mobileCardManager?.switchToNextCard()
                        val currentCard = mobileCardManager?.getCurrentCard()
                        Toast.makeText(this@SimpleModeActivity, "å·²åˆ‡æ¢åˆ°: ${currentCard?.title ?: "ä¸‹ä¸€ä¸ªæ ‡ç­¾"}", Toast.LENGTH_SHORT).show()
                        switched = true
                        Log.d(TAG, "å››åˆ†ä¹‹ä¸€åœ†å¼§æ“ä½œæ : æ‰‹æœºå¡ç‰‡åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªæ ‡ç­¾")
                    }

                    // å¦‚æœæ²¡æœ‰æ‰‹æœºå¡ç‰‡æˆ–åªæœ‰ä¸€ä¸ªï¼Œæ£€æŸ¥æ‰‹åŠ¿å¡ç‰‡
                    if (!switched) {
                        val gestureCards = gestureCardWebViewManager?.getAllCards()
                        if (!gestureCards.isNullOrEmpty() && gestureCards.size > 1) {
                            gestureCardWebViewManager?.switchToNextCard()
                            val currentCard = gestureCardWebViewManager?.getCurrentCard()
                            Toast.makeText(this@SimpleModeActivity, "å·²åˆ‡æ¢åˆ°: ${currentCard?.title ?: "ä¸‹ä¸€ä¸ªæ ‡ç­¾"}", Toast.LENGTH_SHORT).show()
                            switched = true
                            Log.d(TAG, "å››åˆ†ä¹‹ä¸€åœ†å¼§æ“ä½œæ : æ‰‹åŠ¿å¡ç‰‡åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªæ ‡ç­¾")
                        }
                    }

                    if (!switched) {
                        Toast.makeText(this@SimpleModeActivity, "æ²¡æœ‰å…¶ä»–æ ‡ç­¾å¯åˆ‡æ¢", Toast.LENGTH_SHORT).show()
                        Log.d(TAG, "å››åˆ†ä¹‹ä¸€åœ†å¼§æ“ä½œæ : æ²¡æœ‰å¯åˆ‡æ¢çš„æ ‡ç­¾")
                    }
                }

                override fun onBack() {
                    // ä½¿ç”¨ç»Ÿä¸€çš„è¿”å›é€»è¾‘
                    performUnifiedWebViewBack("åœ†å¼§æ“ä½œæ ")
                    Log.d(TAG, "å››åˆ†ä¹‹ä¸€åœ†å¼§æ“ä½œæ : æ‰§è¡Œè¿”å›æ“ä½œ")
                }

                override fun onUndoClose() {
                    // æ’¤å›å…³é—­ï¼šåˆ›å»ºæ–°æ ‡ç­¾é¡µä½œä¸ºä¸´æ—¶å®ç°
                    var created = false

                    // ä¼˜å…ˆåœ¨MobileCardManagerä¸­åˆ›å»ºæ–°æ ‡ç­¾
                    if (mobileCardManager != null) {
                        val newCard = mobileCardManager?.addNewCard("about:blank")
                        if (newCard != null) {
                            Toast.makeText(this@SimpleModeActivity, "å·²åˆ›å»ºæ–°æ ‡ç­¾é¡µ", Toast.LENGTH_SHORT).show()
                            created = true
                            Log.d(TAG, "å››åˆ†ä¹‹ä¸€åœ†å¼§æ“ä½œæ : æ‰‹æœºå¡ç‰‡åˆ›å»ºæ–°æ ‡ç­¾")
                        }
                    }

                    // å¦‚æœæ‰‹æœºå¡ç‰‡ç®¡ç†å™¨ä¸å¯ç”¨ï¼Œåœ¨æ‰‹åŠ¿å¡ç‰‡ä¸­åˆ›å»º
                    if (!created && gestureCardWebViewManager != null) {
                        val newCard = gestureCardWebViewManager?.addNewCard("about:blank")
                        if (newCard != null) {
                            Toast.makeText(this@SimpleModeActivity, "å·²åˆ›å»ºæ–°æ ‡ç­¾é¡µ", Toast.LENGTH_SHORT).show()
                            created = true
                            Log.d(TAG, "å››åˆ†ä¹‹ä¸€åœ†å¼§æ“ä½œæ : æ‰‹åŠ¿å¡ç‰‡åˆ›å»ºæ–°æ ‡ç­¾")
                        }
                    }

                    if (!created) {
                        Toast.makeText(this@SimpleModeActivity, "æ— æ³•åˆ›å»ºæ–°æ ‡ç­¾", Toast.LENGTH_SHORT).show()
                        Log.d(TAG, "å››åˆ†ä¹‹ä¸€åœ†å¼§æ“ä½œæ : åˆ›å»ºæ–°æ ‡ç­¾å¤±è´¥")
                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  }
            })

            // è®¾ç½®é…ç½®ç›‘å¬å™¨
            setOnConfigListener(object : QuarterArcOperationBar.OnConfigListener {
                override fun onShowConfig() {
                    // æ˜¾ç¤ºé…ç½®å¯¹è¯æ¡†
                    quarterArcOperationBar?.showConfigDialog(supportFragmentManager, settingsManager)
                }
            })

            // è®¾ç½®ä½ç½®å˜åŒ–ç›‘å¬å™¨
            setOnPositionChangeListener(object : QuarterArcOperationBar.OnPositionChangeListener {
                override fun onPositionChanged(x: Float, y: Float) {
                    // ä¿å­˜æ–°ä½ç½®åˆ°è®¾ç½®
                    // è¿™é‡Œå¯ä»¥æ·»åŠ ä½ç½®ä¿å­˜é€»è¾‘
                    Log.d(TAG, "åœ†å¼§æ“ä½œæ ä½ç½®å·²æ›´æ–°: ($x, $y)")
                }
            })

            // è®¾ç½®å¯è§æ€§å˜åŒ–ç›‘å¬å™¨
            setOnVisibilityChangeListener(object : QuarterArcOperationBar.OnVisibilityChangeListener {
                override fun onVisibilityChanged(isMinimized: Boolean) {
                    val statusText = if (isMinimized) "åœ†å¼§æ“ä½œæ å·²æœ€å°åŒ–" else "åœ†å¼§æ“ä½œæ å·²æ¢å¤"
                    Toast.makeText(this@SimpleModeActivity, statusText, Toast.LENGTH_SHORT).show()
                    Log.d(TAG, "åœ†å¼§æ“ä½œæ å¯è§æ€§å·²æ›´æ–°: æœ€å°åŒ–=$isMinimized")
                }
            })
        }

        // æ·»åŠ åˆ°WebViewå®¹å™¨ä¸­
        browserWebViewContainer.addView(quarterArcOperationBar)

        Log.d(TAG, "å››åˆ†ä¹‹ä¸€åœ†å¼§æ“ä½œæ åˆ›å»ºå®Œæˆ")
    }



    /**
     * è®¾ç½®æµè§ˆå™¨æ‰‹åŠ¿æ£€æµ‹
     */
    private fun setupBrowserGestureDetector() {
        browserGestureDetector = GestureDetectorCompat(this, object : android.view.GestureDetector.SimpleOnGestureListener() {
            override fun onDoubleTap(e: MotionEvent): Boolean {
                // åŒå‡»æ˜¾ç¤ºæ‰‹åŠ¿æç¤º
                showBrowserGestureHint("åŒå‡»æ£€æµ‹")
                return true
            }

            override fun onLongPress(e: MotionEvent) {
                // é•¿æŒ‰æ˜¾ç¤ºèœå•
                showBrowserGestureHint("é•¿æŒ‰æ£€æµ‹")
            }

            override fun onFling(e1: MotionEvent?, e2: MotionEvent, velocityX: Float, velocityY: Float): Boolean {
                // æ‰‹åŠ¿æ»‘åŠ¨æ£€æµ‹
                if (Math.abs(velocityX) > Math.abs(velocityY)) {
                    if (velocityX > 0) {
                        showBrowserGestureHint("å‘å³æ»‘åŠ¨")
                    } else {
                        showBrowserGestureHint("å‘å·¦æ»‘åŠ¨")
                    }
                }
                return true
            }
        })

        // ä¸ºWebViewå®¹å™¨è®¾ç½®æ‰‹åŠ¿ç›‘å¬
        browserWebViewContainer.setOnTouchListener { _, event ->
            // å¦‚æœæŠ½å±‰å·²ç»æ‰“å¼€ï¼Œä¸å¤„ç†æ‰‹åŠ¿ï¼Œè®©æŠ½å±‰ä¼˜å…ˆå¤„ç†è§¦æ‘¸äº‹ä»¶
            if (browserLayout.isDrawerOpen(GravityCompat.START) || browserLayout.isDrawerOpen(GravityCompat.END)) {
                false
            } else {
                // æ£€æŸ¥æ˜¯å¦æœ‰å±‚å å¡ç‰‡é¢„è§ˆæ­£åœ¨æ˜¾ç¤º
                val isStackedPreviewVisible = stackedCardPreview?.visibility == View.VISIBLE

                if (isStackedPreviewVisible) {
                    // å±‚å å¡ç‰‡é¢„è§ˆæ¨¡å¼ä¸‹ï¼Œä¸å¤„ç†è§¦æ‘¸äº‹ä»¶ï¼Œè®©StackedCardPreviewè‡ªå·±å¤„ç†
                    Log.d(TAG, "å±‚å å¡ç‰‡é¢„è§ˆå¯è§ï¼Œä¸æ‹¦æˆªè§¦æ‘¸äº‹ä»¶ï¼Œè®©StackedCardPreviewå¤„ç†")
                    false
                } else {
                    // æ­£å¸¸æ¨¡å¼ä¸‹ï¼Œå¤„ç†è¾¹ç¼˜ä¾§æ»‘å’ŒåŸæœ‰æ‰‹åŠ¿
                    val edgeHandled = handleEdgeSwipeGesture(event)
                    if (edgeHandled) {
                        // è¾¹ç¼˜ä¾§æ»‘å·²å¤„ç†ï¼Œç›´æ¥è¿”å›
                        true
                    } else {
                        // å¤„ç†å…¶ä»–æ‰‹åŠ¿
                        val gestureHandled = browserGestureDetector.onTouchEvent(event)
                        
                        // å¦‚æœè¾¹ç¼˜ä¾§æ»‘æˆ–æ‰‹åŠ¿æ£€æµ‹å¤„ç†äº†äº‹ä»¶ï¼Œå°±æ¶ˆè´¹æ‰
                        edgeHandled || gestureHandled
                    }
                }
            }
        }

        // è®¾ç½®å…¨å±€è§¦æ‘¸ç›‘å¬
        setupGlobalTouchListener()
    }

    /**
     * å¤„ç†è¾¹ç¼˜ä¾§æ»‘æ‰‹åŠ¿
     */
    private fun handleEdgeSwipeGesture(event: MotionEvent): Boolean {
        // æ£€æŸ¥æ˜¯å¦åœ¨è¾¹ç¼˜åŒºåŸŸ
        val screenWidth = resources.displayMetrics.widthPixels
        val edgeThreshold = 50 // è¾¹ç¼˜æ£€æµ‹é˜ˆå€¼ï¼Œ50dp
        
        when (event.action) {
            MotionEvent.ACTION_DOWN -> {
                edgeSwipeStartX = event.x
                edgeSwipeStartY = event.y
                edgeSwipeStartTime = System.currentTimeMillis()
                return false
            }
            MotionEvent.ACTION_MOVE -> {
                val isInLeftEdge = edgeSwipeStartX < edgeThreshold
                val isInRightEdge = edgeSwipeStartX > screenWidth - edgeThreshold
                
                if (isInLeftEdge || isInRightEdge) {
                    val deltaX = event.x - edgeSwipeStartX
                    val deltaY = event.y - edgeSwipeStartY
                    
                    // æ£€æŸ¥æ˜¯å¦ä¸ºæ°´å¹³æ»‘åŠ¨ä¸”é€Ÿåº¦è¶³å¤Ÿ
                    if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 30) {
                        // å·¦è¾¹ç¼˜å‘å³æ»‘åŠ¨æˆ–å³è¾¹ç¼˜å‘å·¦æ»‘åŠ¨
                        val isSwipeBack = (isInLeftEdge && deltaX > 0) || (isInRightEdge && deltaX < 0)
                        
                        if (isSwipeBack) {
                            // åœ¨æœç´¢tabä¸­æ‰§è¡Œç½‘é¡µåé€€ï¼Œå…¶ä»–tabä¸­æ¶ˆè´¹äº‹ä»¶é˜²æ­¢ç³»ç»Ÿå¤„ç†
                            if (currentState == UIState.BROWSER) {
                                showBrowserGestureHint("è¾¹ç¼˜æ»‘åŠ¨æ£€æµ‹")
                            }
                            return true
                        }
                    }
                }
                return false
            }
            MotionEvent.ACTION_UP -> {
                val currentTime = System.currentTimeMillis()
                val deltaTime = currentTime - edgeSwipeStartTime
                val deltaX = event.x - edgeSwipeStartX
                val deltaY = event.y - edgeSwipeStartY
                
                // æ£€æŸ¥æ˜¯å¦ä¸ºæœ‰æ•ˆçš„è¾¹ç¼˜ä¾§æ»‘
                if (deltaTime < 500 && Math.abs(deltaX) > 100 && Math.abs(deltaX) > Math.abs(deltaY)) {
                    val isInLeftEdge = edgeSwipeStartX < edgeThreshold
                    val isInRightEdge = edgeSwipeStartX > screenWidth - edgeThreshold
                    
                    val isSwipeBack = (isInLeftEdge && deltaX > 0) || (isInRightEdge && deltaX < 0)
                    
                    if (isSwipeBack) {
                        if (currentState == UIState.BROWSER) {
                            // åœ¨æœç´¢tabä¸­æ‰§è¡Œç½‘é¡µåé€€
                            performWebViewBack()
                        } else {
                            // åœ¨å…¶ä»–tabä¸­æ¶ˆè´¹äº‹ä»¶ï¼Œé˜²æ­¢ç³»ç»Ÿå¤„ç†å¯¼è‡´åº”ç”¨é€€å‡º
                            Log.d(TAG, "è¾¹ç¼˜ä¾§æ»‘åœ¨å…¶ä»–tabä¸­ï¼Œæ¶ˆè´¹äº‹ä»¶é˜²æ­¢ç³»ç»Ÿå¤„ç†")
                        }
                        return true
                    }
                }
                return false
            }
        }
        return false
    }
    
    // è¾¹ç¼˜ä¾§æ»‘ç›¸å…³å˜é‡
    private var edgeSwipeStartX = 0f
    private var edgeSwipeStartY = 0f
    private var edgeSwipeStartTime = 0L
    
    /**
     * ç»Ÿä¸€çš„WebViewåé€€å¤„ç†æ–¹æ³•
     * è¢«ç³»ç»Ÿè¿”å›é”®ã€åœ†å¼§æ“ä½œæ ã€è¾¹ç¼˜ä¾§æ»‘ç­‰æ‰€æœ‰è¿”å›æ“ä½œè°ƒç”¨
     */
    private fun performUnifiedWebViewBack(source: String) {
        Log.d(TAG, "æ‰§è¡Œç»Ÿä¸€WebViewåé€€æ“ä½œï¼Œæ¥æº: $source")
        
        // ä¼˜å…ˆæ£€æŸ¥ PaperStackWebViewManager
        val paperStackHandled = paperStackWebViewManager?.canGoBack() == true
        if (paperStackHandled) {
            paperStackWebViewManager?.goBack()
            if (source == "è¾¹ç¼˜ä¾§æ»‘") {
                showBrowserGestureHint("ç½‘é¡µåé€€")
            }
            Log.d(TAG, "$sourceï¼šPaperStackWebViewManager æˆåŠŸè¿”å›ä¸Šä¸€é¡µ")
            return
        }
        
        // ä½¿ç”¨ç»Ÿä¸€WebViewç®¡ç†å™¨å¤„ç†è¿”å›é€»è¾‘
        val handled = unifiedWebViewManager.goBack()
        
        if (handled) {
            if (source == "è¾¹ç¼˜ä¾§æ»‘") {
                showBrowserGestureHint("ç½‘é¡µåé€€")
            }
            Log.d(TAG, "$sourceï¼šæˆåŠŸè¿”å›ä¸Šä¸€é¡µ")
        } else {
            // å¦‚æœæ²¡æœ‰å¯è¿”å›çš„é¡µé¢ï¼Œè¿”å›æœç´¢tabé¦–é¡µ
            showBrowserHome()
            if (source == "è¾¹ç¼˜ä¾§æ»‘") {
                showBrowserGestureHint("è¿”å›æœç´¢é¦–é¡µ")
            }
            Log.d(TAG, "$sourceï¼šæ— å¯è¿”å›é¡µé¢ï¼Œæ˜¾ç¤ºæœç´¢tabé¦–é¡µ")
        }
    }

    /**
     * æ‰§è¡ŒWebViewåé€€æ“ä½œï¼ˆè¾¹ç¼˜ä¾§æ»‘ä¸“ç”¨ï¼‰
     */
    private fun performWebViewBack() {
        performUnifiedWebViewBack("è¾¹ç¼˜ä¾§æ»‘")
    }

    /**
     * è®¾ç½®å…¨å±€è§¦æ‘¸ç›‘å¬ï¼Œç¡®ä¿æ‚¬æµ®å¡ç‰‡åœ¨ä»»ä½•åœ°æ–¹éƒ½èƒ½å“åº”è§¦æ‘¸
     */
    private fun setupGlobalTouchListener() {
        val mainLayout = findViewById<LinearLayout>(R.id.simple_mode_main_layout)
        mainLayout?.setOnTouchListener { view, event ->
            // æ£€æŸ¥æ˜¯å¦æœ‰å±‚å å¡ç‰‡é¢„è§ˆæ­£åœ¨æ˜¾ç¤º
            val isStackedPreviewVisible = stackedCardPreview?.visibility == View.VISIBLE

            if (isStackedPreviewVisible) {
                // å±‚å å¡ç‰‡é¢„è§ˆæ¨¡å¼ä¸‹ï¼Œä¸å¤„ç†è§¦æ‘¸äº‹ä»¶ï¼Œè®©StackedCardPreviewè‡ªå·±å¤„ç†
                Log.d(TAG, "å…¨å±€è§¦æ‘¸ï¼Œå±‚å å¡ç‰‡é¢„è§ˆå¯è§ï¼Œä¸æ‹¦æˆªè§¦æ‘¸äº‹ä»¶")
                false
            } else {
                // æ²¡æœ‰å±‚å å¡ç‰‡æ—¶ï¼Œä¸æ¶ˆè´¹äº‹ä»¶ï¼Œè®©å…¶ä»–ç»„ä»¶æ­£å¸¸å¤„ç†
                false
            }
        }
    }

    /**
     * æ˜¾ç¤ºæµè§ˆå™¨æ‰‹åŠ¿æç¤º
     */
    private fun showBrowserGestureHint(text: String) {
        browserGestureHint.text = text
        browserGestureHint.visibility = View.VISIBLE

        // 2ç§’åéšè—æç¤º
        handler.postDelayed({
            if (!isFinishing && !isDestroyed) {
                browserGestureHint.visibility = View.GONE
            }
        }, 2000)
    }

    /**
     * å¤„ç†æµè§ˆå™¨è¿”å›æŒ‰é’®ç‚¹å‡»
     * @param isLongPress æ˜¯å¦ä¸ºé•¿æŒ‰
     */
    private fun handleBrowserBackButtonClick(isLongPress: Boolean) {
        Log.d(TAG, "æµè§ˆå™¨è¿”å›æŒ‰é’®${if (isLongPress) "é•¿æŒ‰" else "çŸ­æŒ‰"}")

        if (isLongPress) {
            // é•¿æŒ‰ï¼šè¿”å›æœç´¢tabé¦–é¡µï¼ˆä¸è·³è½¬åˆ°å…¨å±€é¦–é¡µï¼‰
            showBrowserHome()
            Log.d(TAG, "é•¿æŒ‰è¿”å›æœç´¢tabé¦–é¡µ")
        } else {
            // çŸ­æŒ‰ï¼šè¿”å›ä¸Šä¸€é¡µ
            var handled = false

            // ä¼˜å…ˆæ£€æŸ¥ PaperStackWebViewManager
            if (paperStackWebViewManager?.canGoBack() == true) {
                paperStackWebViewManager?.goBack()
                handled = true
                Log.d(TAG, "çŸ­æŒ‰ï¼šPaperStackWebViewManager è¿”å›ä¸Šä¸€é¡µ")
            }

            // å¦‚æœ PaperStackWebViewManager æ²¡æœ‰å¤„ç†ï¼Œæ£€æŸ¥ MobileCardManager
            if (!handled) {
                val mobileCurrentCard = mobileCardManager?.getCurrentCard()
                if (mobileCurrentCard?.webView?.canGoBack() == true) {
                    mobileCurrentCard.webView.goBack()
                    handled = true
                    Log.d(TAG, "çŸ­æŒ‰ï¼šæ‰‹æœºå¡ç‰‡è¿”å›ä¸Šä¸€é¡µ")
                }
            }

            // å¦‚æœ MobileCardManager æ²¡æœ‰å¤„ç†ï¼Œæ£€æŸ¥ GestureCardWebViewManager
            if (!handled) {
                val gestureCurrentCard = gestureCardWebViewManager?.getCurrentCard()
                if (gestureCurrentCard?.webView?.canGoBack() == true) {
                    gestureCurrentCard.webView.goBack()
                    handled = true
                    Log.d(TAG, "çŸ­æŒ‰ï¼šæ‰‹åŠ¿å¡ç‰‡è¿”å›ä¸Šä¸€é¡µ")
                }
            }

            // å¦‚æœéƒ½æ²¡æœ‰å¤„ç†ï¼Œæ£€æŸ¥MultiPageWebViewManager
            if (!handled) {
                if (multiPageWebViewManager?.canGoBack() == true) {
                    multiPageWebViewManager?.goBack()
                    handled = true
                    Log.d(TAG, "çŸ­æŒ‰ï¼šå¤šé¡µé¢ç®¡ç†å™¨è¿”å›ä¸Šä¸€é¡µ")
                }
            }

            // å¦‚æœæ²¡æœ‰å¯è¿”å›çš„é¡µé¢ï¼Œè¿”å›æœç´¢tabé¦–é¡µ
            if (!handled) {
                showBrowserHome()
                Log.d(TAG, "çŸ­æŒ‰ï¼šæ— å¯è¿”å›é¡µé¢ï¼Œæ˜¾ç¤ºæœç´¢tabé¦–é¡µ")
            }
        }
    }

    /**
     * è®¾ç½®æµè§ˆå™¨æŒ‰é’®ç›‘å¬å™¨
     */
    private fun setupBrowserButtons() {
		// å¡ç‰‡é¢„è§ˆæŒ‰é’®ï¼ˆå·¦ä¸Šè§’ä¹å®«æ ¼ï¼‰- æ¿€æ´»æœç´¢tabçš„æ‚¬æµ®å¡ç‰‡ç³»ç»Ÿ
		browserBtnClose.setOnClickListener {
			Log.d(TAG, "å·¦ä¸Šè§’ä¹å®«æ ¼è¢«ç‚¹å‡»ï¼Œæ¿€æ´»æœç´¢tabçš„æ‚¬æµ®å¡ç‰‡ç³»ç»Ÿ")
			// è°ƒç”¨æœç´¢tabçš„å±‚å å¡ç‰‡é¢„è§ˆæ¿€æ´»æ–¹æ³•
			activateStackedCardPreview()
		}

        // è®¾ç½®é•¿æŒ‰ç›‘å¬å™¨ - ä¿ç•™è¿”å›åŠŸèƒ½
        browserBtnClose.setOnLongClickListener {
            handleBrowserBackButtonClick(true) // é•¿æŒ‰è¿”å›
            true
        }

        // èœå•æŒ‰é’® - æ‰“å¼€æœç´¢å¼•æ“ä¾§è¾¹æ 
        browserBtnMenu.setOnClickListener {
            Log.d(TAG, "èœå•æŒ‰é’®è¢«ç‚¹å‡»")
            
            // æ£€æŸ¥æ˜¯å¦åœ¨çº¸å †æ¨¡å¼ä¸‹
            val paperStackLayout = findViewById<View>(R.id.paper_stack_layout)
            if (paperStackLayout?.visibility == View.VISIBLE) {
                // åœ¨çº¸å †æ¨¡å¼ä¸‹ï¼Œæ˜¾ç¤ºEnhancedTabManagerèœå•
                showEnhancedTabManagerMenu()
            } else {
                // åœ¨æ™®é€šæ¨¡å¼ä¸‹ï¼Œæ‰“å¼€æŠ½å±‰
                if (browserLayout.isDrawerOpen(GravityCompat.START)) {
                    Log.d(TAG, "å…³é—­æŠ½å±‰")
                    browserLayout.closeDrawer(GravityCompat.START)
                } else {
                    Log.d(TAG, "æ‰“å¼€æŠ½å±‰")
                    browserLayout.openDrawer(GravityCompat.START)
                }
            }
        }
        
        // æœç´¢tabçš„é¡µé¢æ•°é‡æŒ‰é’®ï¼ˆæ˜¾ç¤ºé¡µé¢æ•°å­—ï¼‰- ä¼˜å…ˆä½¿ç”¨æ ‡é¢˜æ å·¦ä¾§çš„æŒ‰é’®
        var searchTabMenuButton = findViewById<com.google.android.material.button.MaterialButton>(R.id.btn_menu)
        if (searchTabMenuButton == null) {
            searchTabMenuButton = findViewById<com.google.android.material.button.MaterialButton>(R.id.btn_menu_bottom)
        }
        searchTabMenuButton?.setOnClickListener {
            Log.d(TAG, "æœç´¢tabé¡µé¢æ•°é‡æŒ‰é’®è¢«ç‚¹å‡»ï¼Œæ¿€æ´»æœç´¢tabçš„æ‚¬æµ®å¡ç‰‡ç³»ç»Ÿ")
            activateStackedCardPreview()
        }
        
        // åˆå§‹åŒ–é¡µé¢æ•°å­—æ˜¾ç¤º
        updatePageCountDisplay()
        
        // éšè—é¡¶éƒ¨æŒ‰é’®ï¼Œåªæ˜¾ç¤ºåº•éƒ¨æŒ‰é’®æ 
        val rightButtons = findViewById<LinearLayout>(R.id.right_buttons)
        rightButtons?.visibility = View.GONE
        
        val leftButtons = findViewById<LinearLayout>(R.id.left_buttons)
        leftButtons?.visibility = View.GONE
        
        // åŒæ­¥åº•éƒ¨æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
        val btnFaviconBottom = findViewById<ImageButton>(R.id.btn_favicon_bottom)
        btnFaviconBottom?.setOnClickListener {
            val btnFavicon = findViewById<ImageButton>(R.id.btn_favicon)
            btnFavicon?.performClick()
        }
        
        val btnSearchEngineBottom = findViewById<ImageButton>(R.id.btn_search_engine_bottom)
        btnSearchEngineBottom?.setOnClickListener {
            val btnSearchEngine = findViewById<ImageButton>(R.id.btn_search_engine)
            btnSearchEngine?.performClick()
        }
        
        val btnCloseBottom = findViewById<ImageButton>(R.id.btn_close_bottom)
        btnCloseBottom?.setOnClickListener {
            val btnClose = findViewById<ImageButton>(R.id.btn_close)
            btnClose?.performClick()
        }
        
        val btnDownloadIndicatorBottom = findViewById<ImageButton>(R.id.btn_download_indicator_bottom)
        btnDownloadIndicatorBottom?.setOnClickListener {
            val btnDownloadIndicator = findViewById<ImageButton>(R.id.btn_download_indicator)
            btnDownloadIndicator?.performClick()
        }

        // åˆå§‹åŒ–å¯æ‹–åŠ¨æŒ‰é’®ç½‘æ ¼
        val draggableButtonGrid = findViewById<com.example.aifloatingball.views.DraggableButtonGrid>(R.id.draggable_button_grid)
        draggableButtonGrid?.setOnButtonClickListener { buttonType ->
            when (buttonType) {
                com.example.aifloatingball.views.DraggableButtonGrid.ButtonType.NEW_TAB -> {
                    performCreateNewCard()
                }
                com.example.aifloatingball.views.DraggableButtonGrid.ButtonType.NEW_GROUP -> {
                    try {
                        showGroupManagerDialog()
                        Log.d(TAG, "æˆåŠŸæ‰“å¼€ç»„ç®¡ç†ç•Œé¢")
                    } catch (e: Exception) {
                        Log.e(TAG, "æ–°å»ºæ ‡ç­¾ç»„æŒ‰é’®ç‚¹å‡»å¤„ç†å¤±è´¥", e)
                        showMaterialToast("æ‰“å¼€ç»„ç®¡ç†å¤±è´¥")
                    }
                }
                com.example.aifloatingball.views.DraggableButtonGrid.ButtonType.GESTURE -> {
                    try {
                        if (!::browserGestureOverlay.isInitialized) {
                            showMaterialToast("æ‰‹åŠ¿æŒ‡å—åŠŸèƒ½æš‚æ—¶ä¸å¯ç”¨")
                            return@setOnButtonClickListener
                        }
                        showGestureInstructions()
                    } catch (e: Exception) {
                        Log.e(TAG, "æ‰‹åŠ¿æŒ‡å—æŒ‰é’®ç‚¹å‡»å¤„ç†å¤±è´¥", e)
                        showMaterialToast("âŒ æ‰‹åŠ¿æŒ‡å—åŠŸèƒ½å‡ºç°é”™è¯¯")
                    }
                }
                com.example.aifloatingball.views.DraggableButtonGrid.ButtonType.DOWNLOAD -> {
                    try {
                        val intent = android.content.Intent(this, com.example.aifloatingball.download.DownloadManagerActivity::class.java)
                        intent.addFlags(android.content.Intent.FLAG_ACTIVITY_NEW_TASK)
                        startActivity(intent)
                        showMaterialToast("æ‰“å¼€ä¸‹è½½ç®¡ç†")
                    } catch (e: Exception) {
                        Log.e(TAG, "ä¸‹è½½ç®¡ç†æŒ‰é’®ç‚¹å‡»å¤„ç†å¤±è´¥", e)
                        showMaterialToast("æ‰“å¼€ä¸‹è½½ç®¡ç†å¤±è´¥")
                    }
                }
                com.example.aifloatingball.views.DraggableButtonGrid.ButtonType.FILE_READER -> {
                    try {
                        Log.d(TAG, "ç”¨æˆ·ç‚¹å‡»æ–‡ä»¶é˜…è¯»æŒ‰é’®")
                        // æ‰“å¼€æ–‡ä»¶é€‰æ‹©å™¨
                        openFilePicker()
                        showMaterialToast("é€‰æ‹©æ–‡ä»¶")
                    } catch (e: Exception) {
                        Log.e(TAG, "æ–‡ä»¶é˜…è¯»æŒ‰é’®ç‚¹å‡»å¤„ç†å¤±è´¥", e)
                        showMaterialToast("æ‰“å¼€æ–‡ä»¶é€‰æ‹©å™¨å¤±è´¥")
                    }
                }
                com.example.aifloatingball.views.DraggableButtonGrid.ButtonType.HISTORY -> {
                    // TODO: æ‰“å¼€å†å²è®°å½•
                    showMaterialToast("å†å²è®°å½•åŠŸèƒ½å¼€å‘ä¸­")
                }
                com.example.aifloatingball.views.DraggableButtonGrid.ButtonType.BOOKMARKS -> {
                    // TODO: æ‰“å¼€æ”¶è—å¤¹
                    showMaterialToast("æ”¶è—å¤¹åŠŸèƒ½å¼€å‘ä¸­")
                }
                com.example.aifloatingball.views.DraggableButtonGrid.ButtonType.SETTINGS -> {
                    // TODO: æ‰“å¼€è®¾ç½®
                    showMaterialToast("è®¾ç½®åŠŸèƒ½å¼€å‘ä¸­")
                }
                com.example.aifloatingball.views.DraggableButtonGrid.ButtonType.SHARE -> {
                    // TODO: åˆ†äº«åŠŸèƒ½
                    showMaterialToast("åˆ†äº«åŠŸèƒ½å¼€å‘ä¸­")
                }
                com.example.aifloatingball.views.DraggableButtonGrid.ButtonType.SCAN -> {
                    // TODO: æ‰«ç åŠŸèƒ½
                    showMaterialToast("æ‰«ç åŠŸèƒ½å¼€å‘ä¸­")
                }
            }
        }
    }
    
    // æ ‡é¢˜æ ä¸Šæ»‘æ‰‹åŠ¿æ£€æµ‹çš„å…±äº«çŠ¶æ€å˜é‡
    private var toolbarSwipeStartY = 0f
    private var toolbarSwipeStartX = 0f
    private var toolbarSwipeStartTime = 0L
    private var isToolbarSwipeUpDetected = false
    
    /**
     * ğŸ”§ ä¿®å¤3ï¼šè®¾ç½®æ ‡é¢˜æ ä¸Šæ»‘æ‰‹åŠ¿æ£€æµ‹
     * ä»æœç´¢tabçš„æ ‡é¢˜æ ä¸ºèµ·ç‚¹å¾€ä¸Šæ–¹å‚ç›´æ»‘åŠ¨æ—¶ï¼Œæ¿€æ´»æ‚¬æµ®å¡ç‰‡ç³»ç»Ÿ
     * æ”¯æŒæ•´ä¸ªæ ‡é¢˜æ åŒºåŸŸï¼ŒåŒ…æ‹¬è¾“å…¥æ¡†å’Œå…¶ä»–å­è§†å›¾
     */
    private fun setupToolbarSwipeUpGesture() {
        try {
            val swipeThreshold = 100f // ä¸Šæ»‘è·ç¦»é˜ˆå€¼ï¼ˆåƒç´ ï¼‰
            val swipeVelocityThreshold = 500f // ä¸Šæ»‘é€Ÿåº¦é˜ˆå€¼ï¼ˆpx/sï¼‰
            val verticalSwipeRatio = 1.5f // å‚ç›´æ»‘åŠ¨æ¯”ä¾‹é˜ˆå€¼ï¼Œç¡®ä¿æ˜¯å‚ç›´æ»‘åŠ¨
            
            // ğŸ”§ ä¿®æ”¹ï¼šç›‘å¬æ•´ä¸ªæ ‡é¢˜æ ï¼Œæ”¯æŒä»æ ‡é¢˜æ ä»»æ„ä½ç½®å‚ç›´ä¸Šæ»‘æ¿€æ´»æ‚¬æµ®å¡ç‰‡
            browserToolbar.setOnTouchListener { view, event ->
                handleToolbarSwipeUpGesture(view, event, swipeThreshold, swipeVelocityThreshold, verticalSwipeRatio)
            }
            
            // ğŸ”§ å…³é”®ä¿®å¤ï¼šåŒæ—¶ä¸ºè¾“å…¥æ¡†è®¾ç½®è§¦æ‘¸ç›‘å¬å™¨ï¼Œæ£€æµ‹ä¸Šæ»‘æ‰‹åŠ¿
            // è¿™æ ·å³ä½¿è§¦æ‘¸ç‚¹åœ¨è¾“å…¥æ¡†ä¸Šï¼Œä¹Ÿèƒ½æ£€æµ‹åˆ°ä¸Šæ»‘æ‰‹åŠ¿å¹¶æ¿€æ´»æ‚¬æµ®å¡ç‰‡
            browserSearchInput.setOnTouchListener { view, event ->
                when (event.action) {
                    MotionEvent.ACTION_DOWN -> {
                        toolbarSwipeStartY = event.y
                        toolbarSwipeStartX = event.x
                        toolbarSwipeStartTime = System.currentTimeMillis()
                        isToolbarSwipeUpDetected = false
                        // å»¶è¿Ÿæ˜¾ç¤ºæ–‡æœ¬å·¥å…·æ 
                        handler.postDelayed({
                            if (!isToolbarSwipeUpDetected) {
                                updateSearchInputToolbarVisibility()
                            }
                        }, 100)
                        false // ä¸æ‹¦æˆªï¼Œè®©è¾“å…¥æ¡†å¯ä»¥è·å–ç„¦ç‚¹
                    }
                    MotionEvent.ACTION_MOVE -> {
                        // æ£€æµ‹æ˜¯å¦ä¸ºä¸Šæ»‘æ‰‹åŠ¿
                        val deltaY = toolbarSwipeStartY - event.y
                        val deltaX = event.x - toolbarSwipeStartX
                        val absDeltaX = kotlin.math.abs(deltaX)
                        val absDeltaY = kotlin.math.abs(deltaY)
                        val currentTime = System.currentTimeMillis()
                        val timeDelta = currentTime - toolbarSwipeStartTime
                        
                        // ğŸ”§ ä¿®å¤3ï¼šæ£€æŸ¥æ˜¯å¦åœ¨ä¸»é¡µï¼Œå¦‚æœæ˜¯ä¸»é¡µåˆ™ä¸æ¿€æ´»ä¸Šæ»‘éšè—æ ‡é¢˜æ åŠŸèƒ½
                        val currentTab = paperStackWebViewManager?.getCurrentTab()
                        val isHomePage = currentTab?.url == "home://functional" || 
                                       currentTab?.url == "file:///android_asset/functional_home.html" ||
                                       currentTab == null
                        
                        // å¦‚æœåœ¨ä¸»é¡µï¼Œä¸å¤„ç†ä¸Šæ»‘æ‰‹åŠ¿
                        if (!isHomePage) {
                            // å¦‚æœæ˜¯æ˜æ˜¾çš„å‚ç›´ä¸Šæ»‘æ‰‹åŠ¿ï¼Œæ¿€æ´»æ‚¬æµ®å¡ç‰‡ç³»ç»Ÿ
                            if (deltaY > swipeThreshold && !isToolbarSwipeUpDetected && timeDelta < 500 && 
                                absDeltaY > absDeltaX * verticalSwipeRatio) {
                                val velocity = if (timeDelta > 0) {
                                    (deltaY / timeDelta) * 1000f
                                } else {
                                    0f
                                }
                                
                                if (deltaY > swipeThreshold || velocity > swipeVelocityThreshold) {
                                    isToolbarSwipeUpDetected = true
                                    Log.d(TAG, "ğŸ”§ ä»è¾“å…¥æ¡†æ£€æµ‹åˆ°å‚ç›´ä¸Šæ»‘æ‰‹åŠ¿ï¼Œæ¿€æ´»æ‚¬æµ®å¡ç‰‡ç³»ç»Ÿï¼Œè·ç¦»: $deltaY, é€Ÿåº¦: $velocity")
                                    
                                    // éšè—é”®ç›˜
                                    val imm = getSystemService(Context.INPUT_METHOD_SERVICE) as InputMethodManager
                                    imm.hideSoftInputFromWindow(browserSearchInput.windowToken, 0)
                                    
                                    // æ¿€æ´»æ‚¬æµ®å¡ç‰‡ç³»ç»Ÿ
                                    activateStackedCardPreview()
                                    
                                    // æä¾›è§¦è§‰åé¦ˆ
                                    vibrator?.vibrate(50)
                                    
                                    return@setOnTouchListener true // æ¶ˆè´¹äº‹ä»¶ï¼Œé˜»æ­¢è¾“å…¥æ¡†å¤„ç†
                                }
                            }
                        }
                        false // ä¸æ˜¯ä¸Šæ»‘æ‰‹åŠ¿ï¼Œè®©è¾“å…¥æ¡†æ­£å¸¸å¤„ç†
                    }
                    MotionEvent.ACTION_UP, MotionEvent.ACTION_CANCEL -> {
                        isToolbarSwipeUpDetected = false
                        false
                    }
                    else -> false
                }
            }
            
            Log.d(TAG, "æ ‡é¢˜æ ä¸Šæ»‘æ‰‹åŠ¿æ£€æµ‹è®¾ç½®å®Œæˆï¼ˆåŒ…æ‹¬è¾“å…¥æ¡†ï¼‰")
        } catch (e: Exception) {
            Log.e(TAG, "è®¾ç½®æ ‡é¢˜æ ä¸Šæ»‘æ‰‹åŠ¿æ£€æµ‹å¤±è´¥", e)
        }
    }
    
    /**
     * å¤„ç†æ ‡é¢˜æ ä¸Šæ»‘æ‰‹åŠ¿çš„é€šç”¨æ–¹æ³•
     */
    private fun handleToolbarSwipeUpGesture(
        view: View, 
        event: MotionEvent, 
        swipeThreshold: Float,
        swipeVelocityThreshold: Float,
        verticalSwipeRatio: Float
    ): Boolean {
        return when (event.action) {
            MotionEvent.ACTION_DOWN -> {
                toolbarSwipeStartY = event.y
                toolbarSwipeStartX = event.x
                toolbarSwipeStartTime = System.currentTimeMillis()
                isToolbarSwipeUpDetected = false
                false // ä¸æ‹¦æˆªï¼Œè®©å…¶ä»–ç‚¹å‡»äº‹ä»¶æ­£å¸¸å¤„ç†
            }
            MotionEvent.ACTION_MOVE -> {
                val deltaY = toolbarSwipeStartY - event.y // å‘ä¸Šæ»‘åŠ¨æ—¶deltaYä¸ºæ­£
                val deltaX = event.x - toolbarSwipeStartX
                val absDeltaX = kotlin.math.abs(deltaX)
                val absDeltaY = kotlin.math.abs(deltaY)
                val currentTime = System.currentTimeMillis()
                val timeDelta = currentTime - toolbarSwipeStartTime
                
                // ğŸ”§ ä¿®å¤3ï¼šæ£€æŸ¥æ˜¯å¦åœ¨ä¸»é¡µï¼Œå¦‚æœæ˜¯ä¸»é¡µåˆ™ä¸æ¿€æ´»ä¸Šæ»‘éšè—æ ‡é¢˜æ åŠŸèƒ½
                val currentTab = paperStackWebViewManager?.getCurrentTab()
                val isHomePage = currentTab?.url == "home://functional" || 
                               currentTab?.url == "file:///android_asset/functional_home.html" ||
                               currentTab == null
                
                // å¦‚æœåœ¨ä¸»é¡µï¼Œä¸å¤„ç†ä¸Šæ»‘æ‰‹åŠ¿ï¼Œè®©å…¶ä»–æ‰‹åŠ¿æ­£å¸¸å¤„ç†
                if (isHomePage) {
                    return false
                }
                
                // æ£€æµ‹å‚ç›´ä¸Šæ»‘æ‰‹åŠ¿ï¼šå‘ä¸Šæ»‘åŠ¨ä¸”è·ç¦»è¶³å¤Ÿï¼Œä¸”ä¸»è¦æ˜¯å‚ç›´æ–¹å‘
                if (deltaY > swipeThreshold && !isToolbarSwipeUpDetected && timeDelta < 500 && 
                    absDeltaY > absDeltaX * verticalSwipeRatio) {
                            // è®¡ç®—æ»‘åŠ¨é€Ÿåº¦
                            val velocity = if (timeDelta > 0) {
                                (deltaY / timeDelta) * 1000f // px/s
                            } else {
                                0f
                            }
                            
                            // å¦‚æœæ»‘åŠ¨è·ç¦»è¶³å¤Ÿæˆ–é€Ÿåº¦è¶³å¤Ÿï¼Œæ¿€æ´»æ‚¬æµ®å¡ç‰‡ç³»ç»Ÿ
                            if (deltaY > swipeThreshold || velocity > swipeVelocityThreshold) {
                        isToolbarSwipeUpDetected = true
                        Log.d(TAG, "ğŸ”§ æ£€æµ‹åˆ°æ ‡é¢˜æ å‚ç›´ä¸Šæ»‘æ‰‹åŠ¿ï¼Œæ¿€æ´»æ‚¬æµ®å¡ç‰‡ç³»ç»Ÿï¼Œè·ç¦»: $deltaY, é€Ÿåº¦: $velocity, å‚ç›´/æ°´å¹³æ¯”ä¾‹: ${if (absDeltaX > 0) absDeltaY / absDeltaX else 0f}")
                                
                                // éšè—é”®ç›˜ï¼ˆå¦‚æœæ˜¾ç¤ºï¼‰
                                val imm = getSystemService(Context.INPUT_METHOD_SERVICE) as InputMethodManager
                                imm.hideSoftInputFromWindow(browserSearchInput.windowToken, 0)
                                
                                // æ¿€æ´»æ‚¬æµ®å¡ç‰‡ç³»ç»Ÿ
                                activateStackedCardPreview()
                                
                                // æä¾›è§¦è§‰åé¦ˆ
                                vibrator?.vibrate(50)
                                
                        true // æ¶ˆè´¹äº‹ä»¶
                    } else {
                        false // ä¸æ‹¦æˆªï¼Œè®©å…¶ä»–æ‰‹åŠ¿æ­£å¸¸å¤„ç†
                            }
                } else {
                        false // ä¸æ‹¦æˆªï¼Œè®©å…¶ä»–æ‰‹åŠ¿æ­£å¸¸å¤„ç†
                }
                    }
                    MotionEvent.ACTION_UP, MotionEvent.ACTION_CANCEL -> {
                isToolbarSwipeUpDetected = false
                        false
                    }
                    else -> false
                }
            }
            
    /**
     * æ›´æ–°æœç´¢è¾“å…¥æ¡†æ–‡å­—å·¥å…·æ çš„å¯è§æ€§
     * è§„åˆ™ï¼š
     * 1. åªåœ¨æœç´¢tabä¸­æ˜¾ç¤ºï¼ˆcurrentState == UIState.BROWSERï¼‰
     * 2. å½“è¾“å…¥æ¡†è·å¾—ç„¦ç‚¹æ—¶ç«‹å³æ˜¾ç¤º
     * 3. å½“è¾“å…¥æ³•æ˜¾ç¤ºæ—¶ä¹Ÿæ˜¾ç¤ºï¼ˆå³ä½¿è¾“å…¥æ¡†æ²¡æœ‰ç„¦ç‚¹ï¼Œæ¯”å¦‚åœ¨WebViewä¸­è¾“å…¥ï¼‰
     * 4. å½“è¾“å…¥æ¡†å¤±å»ç„¦ç‚¹ä¸”è¾“å…¥æ³•éšè—æ—¶éšè—
     * 5. å…¨å±æµè§ˆæ—¶éšè—å·¥å…·æ 
     */
    private fun updateSearchInputToolbarVisibility() {
        val container = searchInputToolbarContainer
        val layout = searchInputToolbarLayout
        
        if (container == null || layout == null) {
            return
        }
        
        // ğŸ”§ ä¿®å¤ï¼šåªåœ¨æœç´¢tabä¸­å¤„ç†
        if (currentState != UIState.BROWSER) {
            if (container.visibility != View.GONE) {
                container.visibility = View.GONE
                Log.d(TAG, "ä¸åœ¨æœç´¢tabä¸­ï¼Œéšè—æ–‡æœ¬å·¥å…·æ ")
            }
            return
        }
        
        // ğŸ”§ ä¿®å¤ï¼šæ£€æŸ¥è¾“å…¥æ¡†ç„¦ç‚¹å’Œè¾“å…¥æ³•çŠ¶æ€
        val rootView = window.decorView.rootView
        val rect = android.graphics.Rect()
        rootView.getWindowVisibleDisplayFrame(rect)
        val screenHeight = rootView.height
        val keypadHeight = screenHeight - rect.bottom
        // ğŸ”§ ä¼˜åŒ–ï¼šé™ä½é˜ˆå€¼ï¼Œç¡®ä¿è¾“å…¥æ³•æ¿€æ´»æ—¶ä¸€å®šèƒ½æ£€æµ‹åˆ°ï¼ˆä»15%é™åˆ°10%ï¼‰
        val isInputMethodVisible = keypadHeight > screenHeight * 0.10
        
        // ğŸ”§ ä¿®å¤ï¼šè¾“å…¥æ³•æ¿€æ´»æ—¶ä¸€å®šè¦æ˜¾ç¤ºå·¥å…·æ ï¼Œä¸å—isToolbarVisibleå½±å“
        // æ˜¾ç¤ºæ¡ä»¶ï¼šè¾“å…¥æ¡†æœ‰ç„¦ç‚¹ æˆ– è¾“å…¥æ³•æ˜¾ç¤ºï¼ˆå³ä½¿å·¥å…·æ è¢«éšè—ä¹Ÿè¦æ˜¾ç¤ºï¼‰
        val shouldShow = browserSearchInput.isFocused || isInputMethodVisible
        
        // ğŸ”§ ä¿®å¤ï¼šå¦‚æœè¾“å…¥æ³•æ¿€æ´»ï¼Œå³ä½¿å·¥å…·æ è¢«éšè—ä¹Ÿè¦æ˜¾ç¤ºæ–‡æœ¬å·¥å…·æ 
        if (!isToolbarVisible && !shouldShow) {
            // å·¥å…·æ è¢«éšè—ä¸”è¾“å…¥æ³•æœªæ¿€æ´»ï¼Œéšè—æ–‡æœ¬å·¥å…·æ 
            if (container.visibility != View.GONE) {
                container.visibility = View.GONE
                Log.d(TAG, "å…¨å±æµè§ˆä¸­ä¸”è¾“å…¥æ³•æœªæ¿€æ´»ï¼Œéšè—æ–‡æœ¬å·¥å…·æ ")
            }
            return
        }
        
        if (shouldShow) {
            if (container.visibility != View.VISIBLE) {
                container.visibility = View.VISIBLE
                loadCustomToolbarItems(layout)
            }
            
            // ğŸ”§ ä¿®å¤ï¼šç¡®ä¿å·¥å…·æ ä¸ä¼šæ‹¦æˆªè§¦æ‘¸äº‹ä»¶
            container.setOnTouchListener { _, event ->
                false // ä¸æ‹¦æˆªè§¦æ‘¸äº‹ä»¶ï¼Œè®©äº‹ä»¶ç©¿é€åˆ°ä¸‹å±‚
            }
            Log.d(TAG, "æ˜¾ç¤ºæ–‡æœ¬å·¥å…·æ ï¼Œè¾“å…¥æ¡†ç„¦ç‚¹: ${browserSearchInput.isFocused}, è¾“å…¥æ³•å¯è§: $isInputMethodVisible (é”®ç›˜é«˜åº¦: $keypadHeight, å±å¹•é«˜åº¦: $screenHeight), å·¥å…·æ å¯è§: $isToolbarVisible")
        } else {
            if (container.visibility != View.GONE) {
                container.visibility = View.GONE
                Log.d(TAG, "éšè—æ–‡æœ¬å·¥å…·æ ï¼Œè¾“å…¥æ¡†ç„¦ç‚¹: ${browserSearchInput.isFocused}, è¾“å…¥æ³•å¯è§: $isInputMethodVisible (é”®ç›˜é«˜åº¦: $keypadHeight, å±å¹•é«˜åº¦: $screenHeight)")
            }
        }
    }
    
    /**
     * æ›´æ–°å·¥å…·æ ä½ç½®ï¼Œä½¿å…¶æ˜¾ç¤ºåœ¨è¾“å…¥æ¡†å’ŒtabåŒºä¹‹é—´
     */
    private fun updateToolbarPositionBetweenInputAndTab(container: View) {
        try {
            val layoutParams = container.layoutParams
            if (layoutParams !is android.widget.FrameLayout.LayoutParams) {
                val parent = container.parent
                if (parent is android.widget.FrameLayout) {
                    val newParams = android.widget.FrameLayout.LayoutParams(
                        android.widget.FrameLayout.LayoutParams.MATCH_PARENT,
                        android.widget.FrameLayout.LayoutParams.WRAP_CONTENT
                    )
                    newParams.gravity = android.view.Gravity.BOTTOM or android.view.Gravity.START
                    container.layoutParams = newParams
                } else {
                    Log.w(TAG, "å·¥å…·æ çˆ¶å®¹å™¨ä¸æ˜¯FrameLayoutï¼Œæ— æ³•è®¾ç½®ä½ç½®")
                    return
                }
            }
            
            val frameParams = container.layoutParams as android.widget.FrameLayout.LayoutParams
            
            // è·å–è¾“å…¥æ¡†çš„ä½ç½®ï¼ˆç›¸å¯¹äºçˆ¶è§†å›¾ï¼‰
            val inputRect = android.graphics.Rect()
            browserSearchInput.getGlobalVisibleRect(inputRect)
            
            // è·å–å·¥å…·æ çˆ¶è§†å›¾çš„ä½ç½®
            val parentView = container.parent as? View
            val parentRect = android.graphics.Rect()
            parentView?.getGlobalVisibleRect(parentRect)
            
            // è®¡ç®—è¾“å…¥æ¡†åº•éƒ¨ç›¸å¯¹äºçˆ¶è§†å›¾çš„ä½ç½®
            val inputBottomInParent = inputRect.bottom - parentRect.top
            
            // è·å–tabåŒºçš„ä½ç½®ï¼ˆå¦‚æœå¯è§ï¼‰
            var tabTopInParent = Int.MAX_VALUE
            if (browserTabContainer.visibility == View.VISIBLE) {
                val tabRect = android.graphics.Rect()
                browserTabContainer.getGlobalVisibleRect(tabRect)
                tabTopInParent = tabRect.top - parentRect.top
            }
            
            // å·¥å…·æ åº”è¯¥æ˜¾ç¤ºåœ¨è¾“å…¥æ¡†ä¸‹æ–¹ï¼ŒtabåŒºä¸Šæ–¹
            // è®¡ç®—åˆé€‚çš„bottomMargin
            val toolbarHeightPx = (48 * resources.displayMetrics.density).toInt() // ä¼°ç®—å·¥å…·æ é«˜åº¦
            val spacingPx = (8 * resources.displayMetrics.density).toInt() // é—´è·8dp
            
            val finalBottomMargin = if (tabTopInParent != Int.MAX_VALUE) {
                // tabåŒºå¯è§ï¼šå·¥å…·æ æ˜¾ç¤ºåœ¨è¾“å…¥æ¡†å’ŒtabåŒºä¹‹é—´
                val availableSpace = tabTopInParent - inputBottomInParent
                if (availableSpace > toolbarHeightPx + spacingPx) {
                    // æœ‰è¶³å¤Ÿç©ºé—´ï¼Œå·¥å…·æ æ˜¾ç¤ºåœ¨ä¸­é—´ä½ç½®
                    parentRect.height() - inputBottomInParent - spacingPx - toolbarHeightPx
                } else {
                    // ç©ºé—´ä¸è¶³ï¼Œå·¥å…·æ ç´§è´´è¾“å…¥æ¡†ä¸‹æ–¹
                    parentRect.height() - inputBottomInParent - spacingPx
                }
            } else {
                // tabåŒºä¸å¯è§ï¼šå·¥å…·æ æ˜¾ç¤ºåœ¨è¾“å…¥æ¡†ä¸‹æ–¹ï¼Œè·ç¦»åº•éƒ¨ä¸€å®šè·ç¦»
                val estimatedTabHeight = (48 * resources.displayMetrics.density).toInt()
                parentRect.height() - inputBottomInParent - spacingPx
            }
            
            // ç¡®ä¿bottomMarginè‡³å°‘ä¸º0
            val finalMargin = maxOf(finalBottomMargin, 0)
            
            if (frameParams.bottomMargin != finalMargin) {
                frameParams.bottomMargin = finalMargin
                frameParams.gravity = android.view.Gravity.BOTTOM or android.view.Gravity.START
                container.layoutParams = frameParams
                Log.d(TAG, "è®¾ç½®å·¥å…·æ ä½ç½®ï¼ˆè¾“å…¥æ¡†å’ŒtabåŒºä¹‹é—´ï¼‰: bottomMargin=${finalMargin}px, è¾“å…¥æ¡†åº•éƒ¨: $inputBottomInParent, tabé¡¶éƒ¨: ${if (tabTopInParent != Int.MAX_VALUE) tabTopInParent else "ä¸å¯è§"}")
            }
        } catch (e: Exception) {
            Log.e(TAG, "æ›´æ–°å·¥å…·æ ä½ç½®å¤±è´¥", e)
            // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨å›ºå®šä½ç½®
            val layoutParams = container.layoutParams
            if (layoutParams is android.widget.FrameLayout.LayoutParams) {
                val estimatedTabHeight = (48 * resources.displayMetrics.density).toInt()
                val inputHeight = (40 * resources.displayMetrics.density).toInt()
                layoutParams.bottomMargin = estimatedTabHeight + inputHeight + (8 * resources.displayMetrics.density).toInt()
                layoutParams.gravity = android.view.Gravity.BOTTOM or android.view.Gravity.START
                container.layoutParams = layoutParams
            }
        }
    }
    
    /**
     * ğŸ”§ ä¿®å¤4ï¼šè®¾ç½®æœç´¢è¾“å…¥æ¡†æ–‡å­—å·¥å…·æ 
     * å½“è¾“å…¥æ¡†è·å¾—ç„¦ç‚¹æ—¶æ˜¾ç¤ºå·¥å…·æ ï¼ŒåŒ…å«å¿«æ·è¾“å…¥æŒ‰é’®
     */
    private fun setupSearchInputToolbar() {
        try {
            // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨å¤šç§æ–¹å¼æŸ¥æ‰¾å·¥å…·æ å®¹å™¨ï¼Œç¡®ä¿èƒ½æ‰¾åˆ°
            var toolbarContainer = searchInputToolbarContainer
            if (toolbarContainer == null) {
                // å°è¯•é€šè¿‡includeçš„IDæŸ¥æ‰¾
                toolbarContainer = findViewById(R.id.search_input_toolbar_container)
            }
            if (toolbarContainer == null) {
                // å°è¯•é€šè¿‡è¢«åŒ…å«å¸ƒå±€çš„æ ¹è§†å›¾IDæŸ¥æ‰¾
                toolbarContainer = findViewById(R.id.search_input_toolbar_scroll)
            }
            
            var toolbarLayout = searchInputToolbarLayout
            if (toolbarLayout == null) {
                toolbarLayout = findViewById(R.id.search_input_toolbar_layout)
            }
            
            if (toolbarContainer == null || toolbarLayout == null) {
                Log.w(TAG, "æœç´¢è¾“å…¥æ¡†æ–‡å­—å·¥å…·æ æœªæ‰¾åˆ°ï¼Œè·³è¿‡è®¾ç½®")
                Log.w(TAG, "toolbarContainer: $toolbarContainer, toolbarLayout: $toolbarLayout")
                return
            }
            
            // ä¿å­˜å¼•ç”¨
            searchInputToolbarContainer = toolbarContainer
            searchInputToolbarLayout = toolbarLayout
            
            // é»˜è®¤éšè—å·¥å…·æ 
            toolbarContainer.visibility = View.GONE
            
            // ä¿å­˜å·¥å…·æ å®¹å™¨å’Œå¸ƒå±€çš„å¼•ç”¨ï¼Œä¾›å…¶ä»–æ–¹æ³•ä½¿ç”¨
            // è¿™äº›å¼•ç”¨å·²ç»åœ¨ç±»æˆå‘˜å˜é‡ä¸­ä¿å­˜ï¼Œè¿™é‡Œç¡®ä¿å®ƒä»¬è¢«æ­£ç¡®åˆå§‹åŒ–
            
            // ğŸ”§ ä¿®å¤ï¼šç›‘å¬è½¯é”®ç›˜çŠ¶æ€ï¼Œè¾“å…¥æ³•æ¿€æ´»æ—¶ç«‹å³æ˜¾ç¤ºå·¥å…·æ 
            val rootView = window.decorView.rootView
            rootView.viewTreeObserver.addOnGlobalLayoutListener {
                val rect = android.graphics.Rect()
                rootView.getWindowVisibleDisplayFrame(rect)
                val screenHeight = rootView.height
                val keypadHeight = screenHeight - rect.bottom
                
                // ğŸ”§ ä¼˜åŒ–ï¼šé™ä½é˜ˆå€¼ï¼Œç¡®ä¿è¾“å…¥æ³•æ¿€æ´»æ—¶ä¸€å®šèƒ½æ£€æµ‹åˆ°ï¼ˆä»15%é™åˆ°10%ï¼‰
                val keyboardVisible = keypadHeight > screenHeight * 0.10
                
                if (keyboardVisible != isKeyboardVisible) {
                    isKeyboardVisible = keyboardVisible
                    Log.d(TAG, "è½¯é”®ç›˜çŠ¶æ€å˜åŒ–: visible=$isKeyboardVisible, keypadHeight=$keypadHeight, screenHeight=$screenHeight")
                    
                    // ğŸ”§ å¦‚æœè¾“å…¥æ³•æ¿€æ´»ä¸”è¾“å…¥æ¡†æœ‰ç„¦ç‚¹ï¼Œç«‹å³æ˜¾ç¤ºå·¥å…·æ 
                    if (keyboardVisible && browserSearchInput.isFocused) {
                        updateSearchInputToolbarVisibility()
                    }
                }
            }
            
            // è®¾ç½®è¾“å…¥æ¡†ç„¦ç‚¹ç›‘å¬
            browserSearchInput.setOnFocusChangeListener { _, hasFocus ->
                Log.d(TAG, "æœç´¢è¾“å…¥æ¡†ç„¦ç‚¹å˜åŒ–: hasFocus=$hasFocus, isKeyboardVisible=$isKeyboardVisible")
                // æ ¹æ®ç„¦ç‚¹çŠ¶æ€æ›´æ–°å·¥å…·æ æ˜¾ç¤º
                updateSearchInputToolbarVisibility()
            }
            
            // ğŸ”§ ä¿®å¤ï¼šåŒæ—¶ç›‘å¬ç‚¹å‡»äº‹ä»¶ï¼Œç¡®ä¿ç‚¹å‡»æ—¶ä¹Ÿèƒ½æ˜¾ç¤ºå·¥å…·æ 
            browserSearchInput.setOnClickListener { view ->
                Log.d(TAG, "æœç´¢è¾“å…¥æ¡†è¢«ç‚¹å‡»")
                // ç«‹å³æ˜¾ç¤ºå·¥å…·æ ï¼Œä¸å»¶è¿Ÿ
                updateSearchInputToolbarVisibility()
            }
            
            // ğŸ”§ ä¿®å¤ï¼šç›‘å¬è§¦æ‘¸äº‹ä»¶ï¼ŒåŒæ—¶æ£€æµ‹ä¸Šæ»‘æ‰‹åŠ¿å’Œæ˜¾ç¤ºå·¥å…·æ 
            // æ³¨æ„ï¼šå¦‚æœ setupToolbarSwipeUpGesture å·²ç»è®¾ç½®äº†è§¦æ‘¸ç›‘å¬å™¨ï¼Œè¿™é‡Œä¼šè¦†ç›–å®ƒ
            // æ‰€ä»¥éœ€è¦åœ¨è¿™é‡Œä¹Ÿæ£€æµ‹ä¸Šæ»‘æ‰‹åŠ¿
            browserSearchInput.setOnTouchListener { view, event ->
                when (event.action) {
                    MotionEvent.ACTION_DOWN -> {
                        // è®°å½•è§¦æ‘¸èµ·å§‹ä½ç½®ï¼Œç”¨äºæ£€æµ‹ä¸Šæ»‘æ‰‹åŠ¿
                        toolbarSwipeStartY = event.y
                        toolbarSwipeStartX = event.x
                        toolbarSwipeStartTime = System.currentTimeMillis()
                        isToolbarSwipeUpDetected = false
                    Log.d(TAG, "æœç´¢è¾“å…¥æ¡†è¢«è§¦æ‘¸")
                        // ç«‹å³æ˜¾ç¤ºå·¥å…·æ ï¼Œç¡®ä¿è¾“å…¥æ³•æ¿€æ´»æ—¶é©¬ä¸Šå‡ºç°
                        if (!isToolbarSwipeUpDetected) {
                            updateSearchInputToolbarVisibility()
                }
                false // ä¸æ‹¦æˆªäº‹ä»¶ï¼Œè®©ç³»ç»Ÿæ­£å¸¸å¤„ç†
                    }
                    MotionEvent.ACTION_MOVE -> {
                        // æ£€æµ‹æ˜¯å¦ä¸ºä¸Šæ»‘æ‰‹åŠ¿
                        val deltaY = toolbarSwipeStartY - event.y
                        val deltaX = event.x - toolbarSwipeStartX
                        val absDeltaX = kotlin.math.abs(deltaX)
                        val absDeltaY = kotlin.math.abs(deltaY)
                        val currentTime = System.currentTimeMillis()
                        val timeDelta = currentTime - toolbarSwipeStartTime
                        val swipeThreshold = 100f
                        val swipeVelocityThreshold = 500f
                        val verticalSwipeRatio = 1.5f
                        
                        // å¦‚æœæ˜¯æ˜æ˜¾çš„å‚ç›´ä¸Šæ»‘æ‰‹åŠ¿ï¼Œæ¿€æ´»æ‚¬æµ®å¡ç‰‡ç³»ç»Ÿ
                        if (deltaY > swipeThreshold && !isToolbarSwipeUpDetected && timeDelta < 500 && 
                            absDeltaY > absDeltaX * verticalSwipeRatio) {
                            val velocity = if (timeDelta > 0) {
                                (deltaY / timeDelta) * 1000f
                            } else {
                                0f
                            }
                            
                            if (deltaY > swipeThreshold || velocity > swipeVelocityThreshold) {
                                isToolbarSwipeUpDetected = true
                                Log.d(TAG, "ğŸ”§ ä»è¾“å…¥æ¡†æ£€æµ‹åˆ°å‚ç›´ä¸Šæ»‘æ‰‹åŠ¿ï¼ˆåœ¨setupSearchInputToolbarä¸­ï¼‰ï¼Œæ¿€æ´»æ‚¬æµ®å¡ç‰‡ç³»ç»Ÿï¼Œè·ç¦»: $deltaY, é€Ÿåº¦: $velocity")
                                
                                // éšè—é”®ç›˜
                                val imm = getSystemService(Context.INPUT_METHOD_SERVICE) as InputMethodManager
                                imm.hideSoftInputFromWindow(browserSearchInput.windowToken, 0)
                                
                                // æ¿€æ´»æ‚¬æµ®å¡ç‰‡ç³»ç»Ÿ
                                activateStackedCardPreview()
                                
                                // æä¾›è§¦è§‰åé¦ˆ
                                vibrator?.vibrate(50)
                                
                                return@setOnTouchListener true // æ¶ˆè´¹äº‹ä»¶ï¼Œé˜»æ­¢è¾“å…¥æ¡†å¤„ç†
                            }
                        }
                        false // ä¸æ˜¯ä¸Šæ»‘æ‰‹åŠ¿ï¼Œè®©è¾“å…¥æ¡†æ­£å¸¸å¤„ç†
                    }
                    MotionEvent.ACTION_UP, MotionEvent.ACTION_CANCEL -> {
                        isToolbarSwipeUpDetected = false
                        false
                    }
                    else -> false
                }
            }
            
            // è®¾ç½®å‰ªè´´æ¿æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            findViewById<com.google.android.material.chip.Chip>(R.id.toolbar_clipboard)?.apply {
                setOnClickListener {
                    pasteFromClipboard()
                }
                setOnLongClickListener {
                    // é•¿æŒ‰å¯ä»¥æ˜¾ç¤ºå‰ªè´´æ¿å†å²ï¼ˆå¯é€‰åŠŸèƒ½ï¼‰
                    Toast.makeText(this@SimpleModeActivity, "å‰ªè´´æ¿ï¼šç‚¹å‡»ç²˜è´´ï¼Œé•¿æŒ‰æŸ¥çœ‹å†å²", Toast.LENGTH_SHORT).show()
                    true
                }
            }
            
            // è®¾ç½®é»˜è®¤å¿«æ·æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            findViewById<com.google.android.material.chip.Chip>(R.id.toolbar_http)?.apply {
                setOnClickListener {
                    insertTextToSearchInput("http://")
                }
                setOnLongClickListener {
                    showEditPresetTextDialog("http://", R.id.toolbar_http)
                    true
                }
            }
            findViewById<com.google.android.material.chip.Chip>(R.id.toolbar_https)?.apply {
                setOnClickListener {
                    insertTextToSearchInput("https://")
                }
                setOnLongClickListener {
                    showEditPresetTextDialog("https://", R.id.toolbar_https)
                    true
                }
            }
            findViewById<com.google.android.material.chip.Chip>(R.id.toolbar_m)?.apply {
                setOnClickListener {
                    insertTextToSearchInput("m.")
                }
                setOnLongClickListener {
                    showEditPresetTextDialog("m.", R.id.toolbar_m)
                    true
                }
            }
            findViewById<com.google.android.material.chip.Chip>(R.id.toolbar_www)?.apply {
                setOnClickListener {
                    insertTextToSearchInput("www.")
                }
                setOnLongClickListener {
                    showEditPresetTextDialog("www.", R.id.toolbar_www)
                    true
                }
            }
            findViewById<com.google.android.material.chip.Chip>(R.id.toolbar_com)?.apply {
                setOnClickListener {
                    insertTextToSearchInput(".com")
                }
                setOnLongClickListener {
                    showEditPresetTextDialog(".com", R.id.toolbar_com)
                    true
                }
            }
            findViewById<com.google.android.material.chip.Chip>(R.id.toolbar_at)?.apply {
                setOnClickListener {
                    insertTextToSearchInput("@")
                }
                setOnLongClickListener {
                    showEditPresetTextDialog("@", R.id.toolbar_at)
                    true
                }
            }
            findViewById<com.google.android.material.chip.Chip>(R.id.toolbar_cn)?.apply {
                setOnClickListener {
                    insertTextToSearchInput(".cn")
                }
                setOnLongClickListener {
                    showEditPresetTextDialog(".cn", R.id.toolbar_cn)
                    true
                }
            }
            // æ–°å¢æ¨¡æ¿æŒ‰é’®
            findViewById<com.google.android.material.chip.Chip>(R.id.toolbar_org)?.apply {
                setOnClickListener {
                    insertTextToSearchInput(".org")
                }
                setOnLongClickListener {
                    showEditPresetTextDialog(".org", R.id.toolbar_org)
                    true
                }
            }
            findViewById<com.google.android.material.chip.Chip>(R.id.toolbar_net)?.apply {
                setOnClickListener {
                    insertTextToSearchInput(".net")
                }
                setOnLongClickListener {
                    showEditPresetTextDialog(".net", R.id.toolbar_net)
                    true
                }
            }
            findViewById<com.google.android.material.chip.Chip>(R.id.toolbar_io)?.apply {
                setOnClickListener {
                    insertTextToSearchInput(".io")
                }
                setOnLongClickListener {
                    showEditPresetTextDialog(".io", R.id.toolbar_io)
                    true
                }
            }
            findViewById<com.google.android.material.chip.Chip>(R.id.toolbar_edu)?.apply {
                setOnClickListener {
                    insertTextToSearchInput(".edu")
                }
                setOnLongClickListener {
                    showEditPresetTextDialog(".edu", R.id.toolbar_edu)
                    true
                }
            }
            findViewById<com.google.android.material.chip.Chip>(R.id.toolbar_gov)?.apply {
                setOnClickListener {
                    insertTextToSearchInput(".gov")
                }
                setOnLongClickListener {
                    showEditPresetTextDialog(".gov", R.id.toolbar_gov)
                    true
                }
            }
            findViewById<com.google.android.material.chip.Chip>(R.id.toolbar_co)?.apply {
                setOnClickListener {
                    insertTextToSearchInput(".co")
                }
                setOnLongClickListener {
                    showEditPresetTextDialog(".co", R.id.toolbar_co)
                    true
                }
            }
            findViewById<com.google.android.material.chip.Chip>(R.id.toolbar_me)?.apply {
                setOnClickListener {
                    insertTextToSearchInput(".me")
                }
                setOnLongClickListener {
                    showEditPresetTextDialog(".me", R.id.toolbar_me)
                    true
                }
            }
            findViewById<com.google.android.material.chip.Chip>(R.id.toolbar_tv)?.apply {
                setOnClickListener {
                    insertTextToSearchInput(".tv")
                }
                setOnLongClickListener {
                    showEditPresetTextDialog(".tv", R.id.toolbar_tv)
                    true
                }
            }
            findViewById<com.google.android.material.chip.Chip>(R.id.toolbar_info)?.apply {
                setOnClickListener {
                    insertTextToSearchInput(".info")
                }
                setOnLongClickListener {
                    showEditPresetTextDialog(".info", R.id.toolbar_info)
                    true
                }
            }
            findViewById<com.google.android.material.chip.Chip>(R.id.toolbar_comma)?.apply {
                setOnClickListener {
                    insertTextToSearchInput(",")
                }
                setOnLongClickListener {
                    showEditPresetTextDialog(",", R.id.toolbar_comma)
                    true
                }
            }
            // ç¼–è¾‘æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            findViewById<com.google.android.material.chip.Chip>(R.id.toolbar_edit)?.setOnClickListener {
                showManagePresetTextsDialog()
            }
            
            // åŠ è½½ä¿å­˜çš„é¢„è®¾æ–‡æœ¬é…ç½®
            loadPresetTextsConfig()
            
            // é‡æ–°åŠ è½½è‡ªå®šä¹‰æ¨¡æ¿ï¼Œç¡®ä¿æ˜¾ç¤ºåœ¨æ­£ç¡®ä½ç½®
            loadCustomToolbarItems(toolbarLayout)
            
            // ğŸ”§ è®¾ç½®æ‹–æ‹½æ’åºåŠŸèƒ½ï¼ˆåœ¨åŠ è½½å®Œæ‰€æœ‰æ¨¡æ¿åè®¾ç½®ï¼‰
            setupToolbarDragAndDrop(toolbarLayout)
            
            Log.d(TAG, "æœç´¢è¾“å…¥æ¡†æ–‡å­—å·¥å…·æ è®¾ç½®å®Œæˆ")
        } catch (e: Exception) {
            Log.e(TAG, "è®¾ç½®æœç´¢è¾“å…¥æ¡†æ–‡å­—å·¥å…·æ å¤±è´¥", e)
        }
    }
    
    /**
     * ğŸ”§ ä¿®å¤4ï¼šå°†æ–‡å­—æ’å…¥åˆ°æœç´¢è¾“å…¥æ¡†
     */
    /**
     * ä»å‰ªè´´æ¿ç²˜è´´å†…å®¹åˆ°æœç´¢è¾“å…¥æ¡†
     */
    private fun pasteFromClipboard() {
        try {
            val clipboard = getSystemService(Context.CLIPBOARD_SERVICE) as ClipboardManager
            if (clipboard.hasPrimaryClip()) {
                val clipData = clipboard.primaryClip
                if (clipData != null && clipData.itemCount > 0) {
                    val text = clipData.getItemAt(0).text?.toString()?.trim() ?: ""
                    if (text.isNotEmpty()) {
                        insertTextToSearchInput(text)
                        Toast.makeText(this, "å·²ç²˜è´´", Toast.LENGTH_SHORT).show()
                    } else {
                        Toast.makeText(this, "å‰ªè´´æ¿ä¸ºç©º", Toast.LENGTH_SHORT).show()
                    }
                } else {
                    Toast.makeText(this, "å‰ªè´´æ¿ä¸ºç©º", Toast.LENGTH_SHORT).show()
                }
            } else {
                Toast.makeText(this, "å‰ªè´´æ¿ä¸ºç©º", Toast.LENGTH_SHORT).show()
            }
        } catch (e: Exception) {
            Log.e(TAG, "ç²˜è´´å‰ªè´´æ¿å†…å®¹å¤±è´¥", e)
            Toast.makeText(this, "ç²˜è´´å¤±è´¥: ${e.message}", Toast.LENGTH_SHORT).show()
        }
    }
    
    private fun insertTextToSearchInput(text: String) {
        try {
            val currentText = browserSearchInput.text.toString()
            val selectionStart = browserSearchInput.selectionStart
            val selectionEnd = browserSearchInput.selectionEnd
            
            val newText = StringBuilder(currentText)
                .insert(selectionStart, text)
                .toString()
            
            browserSearchInput.setText(newText)
            browserSearchInput.setSelection(selectionStart + text.length)
            
            // æ˜¾ç¤ºæ¸…ç©ºæŒ‰é’®
            findViewById<ImageButton>(R.id.browser_btn_clear)?.visibility = View.VISIBLE
        } catch (e: Exception) {
            Log.e(TAG, "æ’å…¥æ–‡å­—åˆ°æœç´¢è¾“å…¥æ¡†å¤±è´¥", e)
        }
    }
    
    /**
     * åŠ è½½è‡ªå®šä¹‰å·¥å…·æ è¯ç»„ï¼ˆå·²ç§»é™¤â•æŒ‰é’®åŠŸèƒ½ï¼Œä¸å†åŠ è½½è‡ªå®šä¹‰æ¨¡æ¿ï¼‰
     */
    private fun loadCustomToolbarItems(toolbarLayout: LinearLayout) {
        try {
            // ç§»é™¤ä¹‹å‰æ·»åŠ çš„è‡ªå®šä¹‰è¯ç»„ï¼ˆä¿ç•™é»˜è®¤çš„ï¼‰
            val childCount = toolbarLayout.childCount
            for (i in childCount - 1 downTo 0) {
                val child = toolbarLayout.getChildAt(i)
                if (child.tag == "custom_item") {
                    toolbarLayout.removeViewAt(i)
                }
            }
            
            Log.d(TAG, "å·¥å…·æ å·²æ¸…ç†è‡ªå®šä¹‰æ¨¡æ¿")
        } catch (e: Exception) {
            Log.e(TAG, "æ¸…ç†è‡ªå®šä¹‰å·¥å…·æ è¯ç»„å¤±è´¥", e)
        }
    }
    
    /**
     * æ˜¾ç¤ºç¼–è¾‘æˆ–åˆ é™¤è‡ªå®šä¹‰æ¨¡æ¿å¯¹è¯æ¡†
     */
    private fun showEditOrDeleteCustomTemplateDialog(text: String, index: Int) {
        try {
            val options = arrayOf("ç¼–è¾‘", "åˆ é™¤")
            androidx.appcompat.app.AlertDialog.Builder(this)
                .setTitle("æ¨¡æ¿ï¼š$text")
                .setItems(options) { _, which ->
                    when (which) {
                        0 -> {
                            // ç¼–è¾‘
                            showEditCustomPresetTextDialog(text, index)
                        }
                        1 -> {
                            // åˆ é™¤
                            deleteCustomPresetText(index)
                            searchInputToolbarLayout?.let {
                                loadCustomToolbarItems(it)
                            }
                        }
                    }
                }
                .setNegativeButton("å–æ¶ˆ", null)
                .show()
        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºç¼–è¾‘æˆ–åˆ é™¤æ¨¡æ¿å¯¹è¯æ¡†å¤±è´¥", e)
        }
    }
    
    /**
     * è®¾ç½®å·¥å…·æ æ‹–æ‹½æ’åºåŠŸèƒ½
     * å…è®¸é•¿æŒ‰å¹¶æ‹–åŠ¨æ¨¡æ¿æ¥è°ƒæ•´ä½ç½®ï¼ˆä¸åŒ…æ‹¬å‰ªè´´æ¿ã€ç¼–è¾‘æŒ‰é’®ï¼‰
     */
    private fun setupToolbarDragAndDrop(toolbarLayout: LinearLayout) {
        try {
            // ä½¿ç”¨ç±»æˆå‘˜å˜é‡æ¥è·Ÿè¸ªæ‹–æ‹½çŠ¶æ€ï¼Œé¿å…åœ¨æ¯æ¬¡è°ƒç”¨æ—¶é‡æ–°è®¾ç½®
            var draggedView: View? = null
            var dragStartX = 0f
            var dragStartY = 0f
            var originalIndex = -1
            var isDragging = false
            
            // ä¸ºæ‰€æœ‰å¯æ‹–åŠ¨çš„Chipè®¾ç½®è§¦æ‘¸ç›‘å¬å™¨
            // æ³¨æ„ï¼šéœ€è¦åœ¨æ¯æ¬¡åŠ è½½è‡ªå®šä¹‰æ¨¡æ¿åé‡æ–°è®¾ç½®ï¼Œæ‰€ä»¥è¿™é‡Œä½¿ç”¨ä¸€ä¸ªè¾…åŠ©æ–¹æ³•
            fun setupDragListener(view: View) {
                // å‰ªè´´æ¿ã€ç¼–è¾‘æŒ‰é’®ä¸å¯æ‹–åŠ¨
                if (view.id == R.id.toolbar_clipboard || 
                    view.id == R.id.toolbar_edit) {
                    return
                }
                
                view.setOnTouchListener { v, event ->
                    when (event.action) {
                        MotionEvent.ACTION_DOWN -> {
                            dragStartX = event.x
                            dragStartY = event.y
                            originalIndex = toolbarLayout.indexOfChild(v)
                            isDragging = false
                            false // ä¸æ‹¦æˆªï¼Œè®©ç‚¹å‡»äº‹ä»¶æ­£å¸¸å¤„ç†
                        }
                        MotionEvent.ACTION_MOVE -> {
                            if (isDragging) {
                                // æ­£åœ¨æ‹–æ‹½ï¼Œè®¡ç®—æ–°ä½ç½®
                                val currentX = event.rawX
                                var targetIndex = originalIndex
                                
                                // æ‰¾åˆ°å›ºå®šæŒ‰é’®çš„ç´¢å¼•
                                var clipboardIndex = -1
                                var editIndex = -1
                                for (j in 0 until toolbarLayout.childCount) {
                                    val child = toolbarLayout.getChildAt(j)
                                    when (child.id) {
                                        R.id.toolbar_clipboard -> clipboardIndex = j
                                        R.id.toolbar_edit -> editIndex = j
                                    }
                                }
                                
                                // è®¡ç®—ç›®æ ‡ä½ç½®ï¼ˆåªèƒ½åœ¨æ¨¡æ¿åŒºåŸŸç§»åŠ¨ï¼Œä¸èƒ½ç§»åŠ¨åˆ°å›ºå®šæŒ‰é’®ä½ç½®ï¼‰
                                for (j in 0 until toolbarLayout.childCount) {
                                    val otherChild = toolbarLayout.getChildAt(j)
                                    if (otherChild != v && 
                                        otherChild.id != R.id.toolbar_clipboard && 
                                        otherChild.id != R.id.toolbar_edit) {
                                        val otherRect = android.graphics.Rect()
                                        otherChild.getGlobalVisibleRect(otherRect)
                                        
                                        if (currentX < otherRect.centerX() && j < originalIndex) {
                                            targetIndex = j
                                            break
                                        } else if (currentX > otherRect.centerX() && j > originalIndex) {
                                            targetIndex = j + 1
                                        }
                                    }
                                }
                                
                                // ç¡®ä¿ä¸ç§»åŠ¨åˆ°å›ºå®šæŒ‰é’®ä½ç½®
                                if (targetIndex != clipboardIndex && 
                                    targetIndex != editIndex &&
                                    targetIndex != originalIndex) {
                                    toolbarLayout.removeView(v)
                                    toolbarLayout.addView(v, targetIndex)
                                    originalIndex = targetIndex
                                }
                                
                                return@setOnTouchListener true
                            } else {
                                // æ£€æŸ¥æ˜¯å¦å¼€å§‹æ‹–æ‹½
                                val deltaX = kotlin.math.abs(event.x - dragStartX)
                                val deltaY = kotlin.math.abs(event.y - dragStartY)
                                
                                if (deltaX > 20 || deltaY > 20) {
                                    isDragging = true
                                    draggedView = v
                                    v.alpha = 0.5f
                                    v.elevation = 8f
                                    // æä¾›è§¦è§‰åé¦ˆ
                                    vibrator?.vibrate(50)
                                    return@setOnTouchListener true
                                }
                            }
                            false
                        }
                        MotionEvent.ACTION_UP, MotionEvent.ACTION_CANCEL -> {
                            if (isDragging && draggedView == v) {
                                v.alpha = 1f
                                v.elevation = 0f
                                draggedView = null
                                isDragging = false
                                
                                // ä¿å­˜æ–°çš„é¡ºåº
                                saveToolbarItemOrder(toolbarLayout)
                                return@setOnTouchListener true
                            }
                            false
                        }
                        else -> false
                    }
                }
            }
            
            // ä¸ºç°æœ‰çš„æ‰€æœ‰å­è§†å›¾è®¾ç½®æ‹–æ‹½ç›‘å¬å™¨
            for (i in 0 until toolbarLayout.childCount) {
                setupDragListener(toolbarLayout.getChildAt(i))
            }
            
            Log.d(TAG, "å·¥å…·æ æ‹–æ‹½æ’åºåŠŸèƒ½å·²è®¾ç½®")
        } catch (e: Exception) {
            Log.e(TAG, "è®¾ç½®å·¥å…·æ æ‹–æ‹½æ’åºåŠŸèƒ½å¤±è´¥", e)
        }
    }
    
    /**
     * ä¿å­˜å·¥å…·æ é¡¹ç›®é¡ºåº
     */
    private fun saveToolbarItemOrder(toolbarLayout: LinearLayout) {
        try {
            // è¿™é‡Œå¯ä»¥ä¿å­˜é¡ºåºï¼Œä½†ç”±äºé»˜è®¤æ¨¡æ¿æœ‰å›ºå®šIDï¼Œä¸»è¦ä¿å­˜è‡ªå®šä¹‰æ¨¡æ¿çš„é¡ºåº
            // ç›®å‰å…ˆè®°å½•æ—¥å¿—ï¼Œåç»­å¯ä»¥æ ¹æ®éœ€è¦å®ç°å®Œæ•´çš„é¡ºåºä¿å­˜
            Log.d(TAG, "å·¥å…·æ é¡¹ç›®é¡ºåºå·²æ›´æ–°")
        } catch (e: Exception) {
            Log.e(TAG, "ä¿å­˜å·¥å…·æ é¡¹ç›®é¡ºåºå¤±è´¥", e)
        }
    }
    
    /**
     * æ˜¾ç¤ºç¼–è¾‘é¢„è®¾æ–‡æœ¬å¯¹è¯æ¡†
     * @param currentText å½“å‰é¢„è®¾æ–‡æœ¬
     * @param chipId é¢„è®¾æ–‡æœ¬æŒ‰é’®çš„ID
     */
    private fun showEditPresetTextDialog(currentText: String, chipId: Int) {
        try {
            val input = android.widget.EditText(this).apply {
                setText(currentText)
                hint = "è¾“å…¥æ–°çš„é¢„è®¾æ–‡æœ¬"
                selectAll()
            }
            
            androidx.appcompat.app.AlertDialog.Builder(this)
                .setTitle("ç¼–è¾‘é¢„è®¾æ–‡æœ¬")
                .setView(input)
                .setPositiveButton("ç¡®å®š") { _, _ ->
                    val newText = input.text.toString().trim()
                    if (newText.isNotEmpty()) {
                        updatePresetText(chipId, newText)
                    }
                }
                .setNegativeButton("å–æ¶ˆ", null)
                .show()
        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºç¼–è¾‘é¢„è®¾æ–‡æœ¬å¯¹è¯æ¡†å¤±è´¥", e)
        }
    }
    
    /**
     * æ›´æ–°é¢„è®¾æ–‡æœ¬
     * @param chipId é¢„è®¾æ–‡æœ¬æŒ‰é’®çš„ID
     * @param newText æ–°çš„é¢„è®¾æ–‡æœ¬
     */
    private fun updatePresetText(chipId: Int, newText: String) {
        try {
            findViewById<com.google.android.material.chip.Chip>(chipId)?.apply {
                text = newText
                setOnClickListener {
                    insertTextToSearchInput(newText)
                }
                setOnLongClickListener {
                    showEditPresetTextDialog(newText, chipId)
                    true
                }
            }
            
            // ä¿å­˜é¢„è®¾æ–‡æœ¬é…ç½®
            savePresetTextsConfig()
            
            Log.d(TAG, "é¢„è®¾æ–‡æœ¬å·²æ›´æ–°: chipId=$chipId, newText=$newText")
        } catch (e: Exception) {
            Log.e(TAG, "æ›´æ–°é¢„è®¾æ–‡æœ¬å¤±è´¥", e)
        }
    }
    
    /**
     * æ˜¾ç¤ºç®¡ç†é¢„è®¾æ–‡æœ¬å¯¹è¯æ¡†
     */
    private fun showManagePresetTextsDialog() {
        try {
            // è·å–æ‰€æœ‰é¢„è®¾æ–‡æœ¬
            val presetTexts = mutableListOf<Pair<Int, String>>()
            presetTexts.add(Pair(R.id.toolbar_http, findViewById<com.google.android.material.chip.Chip>(R.id.toolbar_http)?.text?.toString() ?: "http://"))
            presetTexts.add(Pair(R.id.toolbar_https, findViewById<com.google.android.material.chip.Chip>(R.id.toolbar_https)?.text?.toString() ?: "https://"))
            presetTexts.add(Pair(R.id.toolbar_m, findViewById<com.google.android.material.chip.Chip>(R.id.toolbar_m)?.text?.toString() ?: "m."))
            presetTexts.add(Pair(R.id.toolbar_www, findViewById<com.google.android.material.chip.Chip>(R.id.toolbar_www)?.text?.toString() ?: "www."))
            presetTexts.add(Pair(R.id.toolbar_com, findViewById<com.google.android.material.chip.Chip>(R.id.toolbar_com)?.text?.toString() ?: ".com"))
            presetTexts.add(Pair(R.id.toolbar_at, findViewById<com.google.android.material.chip.Chip>(R.id.toolbar_at)?.text?.toString() ?: "@"))
            presetTexts.add(Pair(R.id.toolbar_cn, findViewById<com.google.android.material.chip.Chip>(R.id.toolbar_cn)?.text?.toString() ?: ".cn"))
            presetTexts.add(Pair(R.id.toolbar_org, findViewById<com.google.android.material.chip.Chip>(R.id.toolbar_org)?.text?.toString() ?: ".org"))
            presetTexts.add(Pair(R.id.toolbar_net, findViewById<com.google.android.material.chip.Chip>(R.id.toolbar_net)?.text?.toString() ?: ".net"))
            presetTexts.add(Pair(R.id.toolbar_io, findViewById<com.google.android.material.chip.Chip>(R.id.toolbar_io)?.text?.toString() ?: ".io"))
            presetTexts.add(Pair(R.id.toolbar_edu, findViewById<com.google.android.material.chip.Chip>(R.id.toolbar_edu)?.text?.toString() ?: ".edu"))
            presetTexts.add(Pair(R.id.toolbar_gov, findViewById<com.google.android.material.chip.Chip>(R.id.toolbar_gov)?.text?.toString() ?: ".gov"))
            presetTexts.add(Pair(R.id.toolbar_co, findViewById<com.google.android.material.chip.Chip>(R.id.toolbar_co)?.text?.toString() ?: ".co"))
            presetTexts.add(Pair(R.id.toolbar_me, findViewById<com.google.android.material.chip.Chip>(R.id.toolbar_me)?.text?.toString() ?: ".me"))
            presetTexts.add(Pair(R.id.toolbar_tv, findViewById<com.google.android.material.chip.Chip>(R.id.toolbar_tv)?.text?.toString() ?: ".tv"))
            presetTexts.add(Pair(R.id.toolbar_info, findViewById<com.google.android.material.chip.Chip>(R.id.toolbar_info)?.text?.toString() ?: ".info"))
            presetTexts.add(Pair(R.id.toolbar_comma, findViewById<com.google.android.material.chip.Chip>(R.id.toolbar_comma)?.text?.toString() ?: ","))
            
            // è·å–è‡ªå®šä¹‰é¢„è®¾æ–‡æœ¬
            val customItemsJson = settingsManager.getString("search_toolbar_custom_items", "[]")
            val gson = com.google.gson.Gson()
            val type = object : com.google.gson.reflect.TypeToken<List<String>>() {}.type
            val customItems: List<String> = gson.fromJson(customItemsJson, type) ?: emptyList()
            
            val items = arrayOfNulls<CharSequence>(presetTexts.size + customItems.size + 1)
            presetTexts.forEachIndexed { index, pair ->
                items[index] = pair.second
            }
            customItems.forEachIndexed { index, text ->
                items[presetTexts.size + index] = text
            }
            items[items.size - 1] = "æ·»åŠ æ–°çš„é¢„è®¾æ–‡æœ¬"
            
            androidx.appcompat.app.AlertDialog.Builder(this)
                .setTitle("ç®¡ç†é¢„è®¾æ–‡æœ¬")
                .setItems(items) { dialog, which ->
                    if (which < presetTexts.size) {
                        // ç¼–è¾‘é»˜è®¤é¢„è®¾æ–‡æœ¬
                        val pair = presetTexts[which]
                        showEditPresetTextDialog(pair.second, pair.first)
                    } else if (which < presetTexts.size + customItems.size) {
                        // ç¼–è¾‘è‡ªå®šä¹‰é¢„è®¾æ–‡æœ¬
                        val customText = customItems[which - presetTexts.size]
                        showEditCustomPresetTextDialog(customText, which - presetTexts.size)
                    }
                }
                .setNegativeButton("å…³é—­", null)
                .show()
        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºç®¡ç†é¢„è®¾æ–‡æœ¬å¯¹è¯æ¡†å¤±è´¥", e)
        }
    }
    
    
    /**
     * æ˜¾ç¤ºç¼–è¾‘è‡ªå®šä¹‰é¢„è®¾æ–‡æœ¬å¯¹è¯æ¡†
     */
    private fun showEditCustomPresetTextDialog(currentText: String, index: Int) {
        try {
            val input = android.widget.EditText(this).apply {
                setText(currentText)
                hint = "è¾“å…¥æ–°çš„é¢„è®¾æ–‡æœ¬"
                selectAll()
            }
            
            androidx.appcompat.app.AlertDialog.Builder(this)
                .setTitle("ç¼–è¾‘é¢„è®¾æ–‡æœ¬")
                .setView(input)
                .setPositiveButton("ä¿å­˜") { _, _ ->
                    val newText = input.text.toString().trim()
                    if (newText.isNotEmpty()) {
                        updateCustomPresetText(index, newText)
                    }
                }
                .setNeutralButton("åˆ é™¤") { _, _ ->
                    deleteCustomPresetText(index)
                }
                .setNegativeButton("å–æ¶ˆ", null)
                .show()
        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºç¼–è¾‘è‡ªå®šä¹‰é¢„è®¾æ–‡æœ¬å¯¹è¯æ¡†å¤±è´¥", e)
        }
    }
    
    /**
     * æ·»åŠ è‡ªå®šä¹‰é¢„è®¾æ–‡æœ¬
     */
    private fun addCustomPresetText(text: String) {
        try {
            val customItemsJson = settingsManager.getString("search_toolbar_custom_items", "[]")
            val gson = com.google.gson.Gson()
            val type = object : com.google.gson.reflect.TypeToken<MutableList<String>>() {}.type
            val customItems: MutableList<String> = gson.fromJson(customItemsJson, type) ?: mutableListOf()
            
            customItems.add(text)
            
            val newJson = gson.toJson(customItems)
            settingsManager.putString("search_toolbar_custom_items", newJson)
            
            // åˆ·æ–°å·¥å…·æ 
            searchInputToolbarLayout?.let {
                loadCustomToolbarItems(it)
            }
            
            Log.d(TAG, "å·²æ·»åŠ è‡ªå®šä¹‰é¢„è®¾æ–‡æœ¬: $text")
        } catch (e: Exception) {
            Log.e(TAG, "æ·»åŠ è‡ªå®šä¹‰é¢„è®¾æ–‡æœ¬å¤±è´¥", e)
        }
    }
    
    /**
     * æ›´æ–°è‡ªå®šä¹‰é¢„è®¾æ–‡æœ¬
     */
    private fun updateCustomPresetText(index: Int, newText: String) {
        try {
            val customItemsJson = settingsManager.getString("search_toolbar_custom_items", "[]")
            val gson = com.google.gson.Gson()
            val type = object : com.google.gson.reflect.TypeToken<MutableList<String>>() {}.type
            val customItems: MutableList<String> = gson.fromJson(customItemsJson, type) ?: mutableListOf()
            
            if (index < customItems.size) {
                customItems[index] = newText
                
                val newJson = gson.toJson(customItems)
                settingsManager.putString("search_toolbar_custom_items", newJson)
                
                // åˆ·æ–°å·¥å…·æ 
                searchInputToolbarLayout?.let {
                    loadCustomToolbarItems(it)
                }
                
                Log.d(TAG, "å·²æ›´æ–°è‡ªå®šä¹‰é¢„è®¾æ–‡æœ¬: index=$index, newText=$newText")
            }
        } catch (e: Exception) {
            Log.e(TAG, "æ›´æ–°è‡ªå®šä¹‰é¢„è®¾æ–‡æœ¬å¤±è´¥", e)
        }
    }
    
    /**
     * åˆ é™¤è‡ªå®šä¹‰é¢„è®¾æ–‡æœ¬
     */
    private fun deleteCustomPresetText(index: Int) {
        try {
            val customItemsJson = settingsManager.getString("search_toolbar_custom_items", "[]")
            val gson = com.google.gson.Gson()
            val type = object : com.google.gson.reflect.TypeToken<MutableList<String>>() {}.type
            val customItems: MutableList<String> = gson.fromJson(customItemsJson, type) ?: mutableListOf()
            
            if (index < customItems.size) {
                customItems.removeAt(index)
                
                val newJson = gson.toJson(customItems)
                settingsManager.putString("search_toolbar_custom_items", newJson)
                
                // åˆ·æ–°å·¥å…·æ 
                searchInputToolbarLayout?.let {
                    loadCustomToolbarItems(it)
                }
                
                Log.d(TAG, "å·²åˆ é™¤è‡ªå®šä¹‰é¢„è®¾æ–‡æœ¬: index=$index")
            }
        } catch (e: Exception) {
            Log.e(TAG, "åˆ é™¤è‡ªå®šä¹‰é¢„è®¾æ–‡æœ¬å¤±è´¥", e)
        }
    }
    
    /**
     * ä¿å­˜é¢„è®¾æ–‡æœ¬é…ç½®
     */
    private fun savePresetTextsConfig() {
        try {
            val config = mutableMapOf<Int, String>()
            config[R.id.toolbar_http] = findViewById<com.google.android.material.chip.Chip>(R.id.toolbar_http)?.text?.toString() ?: "http://"
            config[R.id.toolbar_https] = findViewById<com.google.android.material.chip.Chip>(R.id.toolbar_https)?.text?.toString() ?: "https://"
            config[R.id.toolbar_m] = findViewById<com.google.android.material.chip.Chip>(R.id.toolbar_m)?.text?.toString() ?: "m."
            config[R.id.toolbar_www] = findViewById<com.google.android.material.chip.Chip>(R.id.toolbar_www)?.text?.toString() ?: "www."
            config[R.id.toolbar_com] = findViewById<com.google.android.material.chip.Chip>(R.id.toolbar_com)?.text?.toString() ?: ".com"
            config[R.id.toolbar_at] = findViewById<com.google.android.material.chip.Chip>(R.id.toolbar_at)?.text?.toString() ?: "@"
            config[R.id.toolbar_cn] = findViewById<com.google.android.material.chip.Chip>(R.id.toolbar_cn)?.text?.toString() ?: ".cn"
            config[R.id.toolbar_org] = findViewById<com.google.android.material.chip.Chip>(R.id.toolbar_org)?.text?.toString() ?: ".org"
            config[R.id.toolbar_net] = findViewById<com.google.android.material.chip.Chip>(R.id.toolbar_net)?.text?.toString() ?: ".net"
            config[R.id.toolbar_io] = findViewById<com.google.android.material.chip.Chip>(R.id.toolbar_io)?.text?.toString() ?: ".io"
            config[R.id.toolbar_edu] = findViewById<com.google.android.material.chip.Chip>(R.id.toolbar_edu)?.text?.toString() ?: ".edu"
            config[R.id.toolbar_gov] = findViewById<com.google.android.material.chip.Chip>(R.id.toolbar_gov)?.text?.toString() ?: ".gov"
            config[R.id.toolbar_co] = findViewById<com.google.android.material.chip.Chip>(R.id.toolbar_co)?.text?.toString() ?: ".co"
            config[R.id.toolbar_me] = findViewById<com.google.android.material.chip.Chip>(R.id.toolbar_me)?.text?.toString() ?: ".me"
            config[R.id.toolbar_tv] = findViewById<com.google.android.material.chip.Chip>(R.id.toolbar_tv)?.text?.toString() ?: ".tv"
            config[R.id.toolbar_info] = findViewById<com.google.android.material.chip.Chip>(R.id.toolbar_info)?.text?.toString() ?: ".info"
            config[R.id.toolbar_comma] = findViewById<com.google.android.material.chip.Chip>(R.id.toolbar_comma)?.text?.toString() ?: ","
            
            val gson = com.google.gson.Gson()
            val configJson = gson.toJson(config)
            settingsManager.putString("search_toolbar_preset_config", configJson)
            
            Log.d(TAG, "é¢„è®¾æ–‡æœ¬é…ç½®å·²ä¿å­˜")
        } catch (e: Exception) {
            Log.e(TAG, "ä¿å­˜é¢„è®¾æ–‡æœ¬é…ç½®å¤±è´¥", e)
        }
    }
    
    /**
     * åŠ è½½é¢„è®¾æ–‡æœ¬é…ç½®
     */
    private fun loadPresetTextsConfig() {
        try {
            val configJson = settingsManager.getString("search_toolbar_preset_config", null)
            if (configJson != null) {
                val gson = com.google.gson.Gson()
                val type = object : com.google.gson.reflect.TypeToken<Map<Int, String>>() {}.type
                val config: Map<Int, String> = gson.fromJson(configJson, type) ?: emptyMap()
                
                config.forEach { (chipId, text) ->
                    updatePresetText(chipId, text)
                }
                
                Log.d(TAG, "é¢„è®¾æ–‡æœ¬é…ç½®å·²åŠ è½½")
            }
        } catch (e: Exception) {
            Log.e(TAG, "åŠ è½½é¢„è®¾æ–‡æœ¬é…ç½®å¤±è´¥", e)
        }
    }

    /**
     * å¼€å§‹æµè§ˆæŒ‰é’®å¤„ç†
     */
    private fun setupStartBrowsingButton() {
        // å¼€å§‹æµè§ˆæŒ‰é’® - åˆ›å»ºæ–°å¡ç‰‡ï¼ˆä¿ç•™å…¼å®¹æ€§ï¼Œä½†ä¸»è¦ä½¿ç”¨DraggableButtonGridï¼‰
        findViewById<com.google.android.material.button.MaterialButton>(R.id.browser_start_browsing_button)?.setOnClickListener { button ->
            // æ·»åŠ ç‚¹å‡»åŠ¨ç”»
            button.animate()
                .scaleX(0.95f)
                .scaleY(0.95f)
                .setDuration(100)
                .withEndAction {
                    button.animate()
                        .scaleX(1f)
                        .scaleY(1f)
                        .setDuration(100)
                        .withEndAction {
                            // åŠ¨ç”»å®Œæˆåæ‰§è¡Œæ“ä½œ
                            performCreateNewCard()
                        }
                        .start()
                }
                .start()

            Log.d(TAG, "ç”¨æˆ·ç‚¹å‡»å¼€å§‹æµè§ˆæŒ‰é’®")
        }

        // æ‰‹åŠ¿æŒ‡å—æŒ‰é’®
        findViewById<com.google.android.material.button.MaterialButton>(R.id.browser_gesture_guide_button)?.setOnClickListener {
            try {
                Log.d(TAG, "ç”¨æˆ·ç‚¹å‡»æ‰‹åŠ¿æŒ‡å—æŒ‰é’®")

                // æ£€æŸ¥ActivityçŠ¶æ€
                if (isFinishing || isDestroyed) {
                    Log.w(TAG, "Activityæ­£åœ¨ç»“æŸæˆ–å·²é”€æ¯ï¼Œè·³è¿‡æ‰‹åŠ¿æŒ‡å—æ“ä½œ")
                    return@setOnClickListener
                }

                // æ£€æŸ¥ç»„ä»¶æ˜¯å¦å·²åˆå§‹åŒ–
                if (!::browserGestureOverlay.isInitialized) {
                    Log.e(TAG, "browserGestureOverlayæœªåˆå§‹åŒ–ï¼Œæ— æ³•æ“ä½œæ‰‹åŠ¿æŒ‡å—")
                    showMaterialToast("æ‰‹åŠ¿æŒ‡å—åŠŸèƒ½æš‚æ—¶ä¸å¯ç”¨")
                    return@setOnClickListener
                }

                // æ˜¾ç¤ºæ‰‹åŠ¿æ“ä½œæŒ‡å—å¯¹è¯æ¡†
                showGestureInstructions()
            } catch (e: Exception) {
                Log.e(TAG, "æ‰‹åŠ¿æŒ‡å—æŒ‰é’®ç‚¹å‡»å¤„ç†å¤±è´¥", e)
                showMaterialToast("âŒ æ‰‹åŠ¿æŒ‡å—åŠŸèƒ½å‡ºç°é”™è¯¯")
            }
        }

        // ä¸‹è½½ç®¡ç†æŒ‰é’®
        findViewById<com.google.android.material.button.MaterialButton>(R.id.browser_download_manager_button)?.setOnClickListener {
            try {
                Log.d(TAG, "ç”¨æˆ·ç‚¹å‡»ä¸‹è½½ç®¡ç†æŒ‰é’®")

                // æ£€æŸ¥ActivityçŠ¶æ€
                if (isFinishing || isDestroyed) {
                    Log.w(TAG, "Activityæ­£åœ¨ç»“æŸæˆ–å·²é”€æ¯ï¼Œè·³è¿‡ä¸‹è½½ç®¡ç†æ“ä½œ")
                    return@setOnClickListener
                }

                // æ‰“å¼€ä¸‹è½½ç®¡ç†ç•Œé¢
                val intent = android.content.Intent(this, com.example.aifloatingball.download.DownloadManagerActivity::class.java)
                intent.addFlags(android.content.Intent.FLAG_ACTIVITY_NEW_TASK)
                startActivity(intent)
                
                Log.d(TAG, "æˆåŠŸæ‰“å¼€ä¸‹è½½ç®¡ç†ç•Œé¢")
                showMaterialToast("æ‰“å¼€ä¸‹è½½ç®¡ç†")
            } catch (e: Exception) {
                Log.e(TAG, "ä¸‹è½½ç®¡ç†æŒ‰é’®ç‚¹å‡»å¤„ç†å¤±è´¥", e)
                showMaterialToast("æ‰“å¼€ä¸‹è½½ç®¡ç†å¤±è´¥")
            }
        }

        // æ–‡ä»¶é˜…è¯»æŒ‰é’®
        findViewById<com.google.android.material.button.MaterialButton>(R.id.browser_file_reader_button)?.setOnClickListener {
            try {
                Log.d(TAG, "ç”¨æˆ·ç‚¹å‡»æ–‡ä»¶é˜…è¯»æŒ‰é’®")

                // æ£€æŸ¥ActivityçŠ¶æ€
                if (isFinishing || isDestroyed) {
                    Log.w(TAG, "Activityæ­£åœ¨ç»“æŸæˆ–å·²é”€æ¯ï¼Œè·³è¿‡æ–‡ä»¶é€‰æ‹©æ“ä½œ")
                    return@setOnClickListener
                }

                // æ‰“å¼€æ–‡ä»¶é€‰æ‹©å™¨
                openFilePicker()
                
                Log.d(TAG, "æˆåŠŸæ‰“å¼€æ–‡ä»¶é€‰æ‹©å™¨")
            } catch (e: Exception) {
                Log.e(TAG, "æ–‡ä»¶é˜…è¯»æŒ‰é’®ç‚¹å‡»å¤„ç†å¤±è´¥", e)
                showMaterialToast("æ‰“å¼€æ–‡ä»¶é€‰æ‹©å™¨å¤±è´¥")
            }
        }

        // è®¾ç½®æ‰‹åŠ¿å¡ç‰‡ç®¡ç†å™¨ç›‘å¬å™¨
        gestureCardWebViewManager?.setOnPageChangeListener(object : GestureCardWebViewManager.OnPageChangeListener {
            override fun onCardAdded(cardData: GestureCardWebViewManager.WebViewCardData, position: Int) {
                Log.d(TAG, "å¡ç‰‡å·²æ·»åŠ : ${cardData.title}")
            }

            override fun onCardRemoved(cardData: GestureCardWebViewManager.WebViewCardData, position: Int) {
                Log.d(TAG, "å¡ç‰‡å·²ç§»é™¤: ${cardData.title}")
            }

            override fun onCardSwitched(cardData: GestureCardWebViewManager.WebViewCardData, position: Int) {
                Log.d(TAG, "åˆ‡æ¢åˆ°å¡ç‰‡: ${cardData.title}")
            }

            override fun onPreviewModeChanged(isPreview: Boolean) {
                Log.d(TAG, "é¢„è§ˆæ¨¡å¼å˜åŒ–: $isPreview")
            }

            override fun onPageTitleChanged(cardData: GestureCardWebViewManager.WebViewCardData, title: String) {
                Log.d(TAG, "é¡µé¢æ ‡é¢˜å˜åŒ–: $title")
            }

            override fun onPageLoadingStateChanged(cardData: GestureCardWebViewManager.WebViewCardData, isLoading: Boolean) {
                Log.d(TAG, "é¡µé¢åŠ è½½çŠ¶æ€å˜åŒ–: $isLoading")
            }

            override fun onGoHome() {
                // è¿”å›æµè§ˆå™¨é¦–é¡µ
                showBrowserHome()
                Log.d(TAG, "è¿”å›æµè§ˆå™¨é¦–é¡µ")
            }

            override fun onPageRefresh() {
                // é¡µé¢åˆ·æ–°
                Log.d(TAG, "é¡µé¢åˆ·æ–°")
            }

            override fun onSwipePreviewStarted(cards: List<GestureCardWebViewManager.WebViewCardData>, currentIndex: Int) {
                // æ˜¾ç¤ºæ¨ªæ»‘é¢„è§ˆæŒ‡ç¤ºå™¨
                showSwipePreviewIndicator(cards, currentIndex)
                Log.d(TAG, "å¼€å§‹æ¨ªæ»‘é¢„è§ˆï¼Œå½“å‰ç´¢å¼•: $currentIndexï¼Œæ€»å¡ç‰‡æ•°: ${cards.size}")
            }

            override fun onSwipePreviewUpdated(position: Int, positionOffset: Float) {
                // æ›´æ–°æ¨ªæ»‘é¢„è§ˆæŒ‡ç¤ºå™¨ä½ç½®
                updateSwipePreviewIndicator(position, positionOffset)
            }

            override fun onSwipePreviewEnded() {
                // éšè—æ¨ªæ»‘é¢„è§ˆæŒ‡ç¤ºå™¨
                hideSwipePreviewIndicator()
                Log.d(TAG, "ç»“æŸæ¨ªæ»‘é¢„è§ˆ")
            }
            
            // æ»šåŠ¨é˜ˆå€¼
            private val SCROLL_THRESHOLD = 20
            // è®°å½•å½“å‰UIå¯è§æ€§çŠ¶æ€
            private var isUiVisible = true
            
            override fun onScroll(dy: Int) {
                // åªæœ‰åœ¨æµè§ˆç½‘é¡µæ—¶æ‰å¤„ç†æ»šåŠ¨éšè—é€»è¾‘ï¼ˆéé¦–é¡µï¼‰
                if (browserHomeContent?.visibility == View.VISIBLE) return
                
                if (dy > SCROLL_THRESHOLD && isUiVisible) {
                    // å‘ä¸‹æ»šåŠ¨ï¼Œéšè—UI
                    hideBrowserUI()
                    isUiVisible = false
                } else if (dy < -SCROLL_THRESHOLD && !isUiVisible) {
                    // å‘ä¸Šæ»šåŠ¨ï¼Œæ˜¾ç¤ºUI
                    showBrowserUI()
                    isUiVisible = true
                }
            }
            
            private fun hideBrowserUI() {
                if (!::browserLayout.isInitialized) return

                // ä½¿ç”¨TransitionManageræ¥å¹³æ»‘å¤„ç†å¸ƒå±€å˜åŒ–
                val transition = androidx.transition.AutoTransition()
                transition.duration = 300
                
                // å¯¹æµè§ˆå™¨å¸ƒå±€åº”ç”¨è¿‡æ¸¡åŠ¨ç”»
                androidx.transition.TransitionManager.beginDelayedTransition(browserLayout, transition)
                
                // éšè—é¡¶éƒ¨åœ°å€æ 
                if (::browserToolbar.isInitialized) {
                    browserToolbar.visibility = View.GONE
                }
                
                // éšè—é¡¶éƒ¨æ ‡ç­¾ç»„
                if (::browserTabContainer.isInitialized) {
                    browserTabContainer.visibility = View.GONE
                }
                
                // éšè—åº•éƒ¨å¿«æ·æ“ä½œæ 
                if (::browserQuickActionsBar.isInitialized) {
                    browserQuickActionsBar.visibility = View.GONE
                }
                
                // å¤„ç†åº•éƒ¨å¯¼èˆªæ 
                val bottomNav = findViewById<LinearLayout>(R.id.bottom_navigation)
                bottomNav?.let { nav ->
                    (nav.parent as? ViewGroup)?.let { parent ->
                        androidx.transition.TransitionManager.beginDelayedTransition(parent, transition)
                    }
                    nav.visibility = View.GONE
                }
                
                // æ˜¾ç¤ºæ‚¬æµ®å·¥å…·æ 
                browserFloatingToolbar?.apply {
                    visibility = View.VISIBLE
                    alpha = 0f
                    translationY = 100f
                    animate()
                        .alpha(1f)
                        .translationY(0f)
                        .setDuration(300)
                        .start()
                }
            }
            
            private fun showBrowserUI() {
                if (!::browserLayout.isInitialized) return

                // ä½¿ç”¨TransitionManageræ¥å¹³æ»‘å¤„ç†å¸ƒå±€å˜åŒ–
                val transition = androidx.transition.AutoTransition()
                transition.duration = 300
                
                // å¯¹æµè§ˆå™¨å¸ƒå±€åº”ç”¨è¿‡æ¸¡åŠ¨ç”»
                androidx.transition.TransitionManager.beginDelayedTransition(browserLayout, transition)
                
                // æ˜¾ç¤ºé¡¶éƒ¨åœ°å€æ 
                if (::browserToolbar.isInitialized) {
                    browserToolbar.visibility = View.VISIBLE
                }
                
                // æ˜¾ç¤ºé¡¶éƒ¨æ ‡ç­¾ç»„
                if (::browserTabContainer.isInitialized) {
                    browserTabContainer.visibility = View.VISIBLE
                }
                
                // æ˜¾ç¤ºåº•éƒ¨å¿«æ·æ“ä½œæ 
                if (::browserQuickActionsBar.isInitialized) {
                    browserQuickActionsBar.visibility = View.VISIBLE
                }
                
                // æ˜¾ç¤ºåº•éƒ¨å¯¼èˆªæ 
                val bottomNav = findViewById<LinearLayout>(R.id.bottom_navigation)
                bottomNav?.let { nav ->
                    (nav.parent as? ViewGroup)?.let { parent ->
                        androidx.transition.TransitionManager.beginDelayedTransition(parent, transition)
                    }
                    nav.visibility = View.VISIBLE
                }
                
                // éšè—æ‚¬æµ®å·¥å…·æ 
                browserFloatingToolbar?.animate()
                    ?.alpha(0f)
                    ?.translationY(100f)
                    ?.setDuration(300)
                    ?.withEndAction { 
                        browserFloatingToolbar?.visibility = View.GONE 
                    }
                    ?.start()
            }

            override fun onAllCardsRemoved() {
                // æ‰€æœ‰å¡ç‰‡éƒ½è¢«å…³é—­ï¼Œæ˜¾ç¤ºæµè§ˆå™¨é¦–é¡µ
                Log.d(TAG, "æ‰€æœ‰å¡ç‰‡å·²å…³é—­ï¼Œæ˜¾ç¤ºæµè§ˆå™¨é¦–é¡µ")
                showBrowserHome()

                // éšè—æ‚¬æµ®å¡ç‰‡é¢„è§ˆ
                stackedCardPreview?.visibility = View.GONE

                // æ›´æ–°æœç´¢tabå¾½æ ‡
                updateSearchTabBadge()
                // æ›´æ–°é¡µé¢æ•°å­—
                updatePageCountDisplay()

                // æ˜¾ç¤ºæç¤ºä¿¡æ¯
                Toast.makeText(this@SimpleModeActivity, "æ‰€æœ‰æ ‡ç­¾é¡µå·²å…³é—­", Toast.LENGTH_SHORT).show()
            }
        })
        
        // è®¾ç½®æœç´¢æ åŒºåŸŸçš„ä¸Šæ»‘æ‰‹åŠ¿
        setupBrowserSearchBarSwipeUpGesture()
        
        // åˆå§‹åŒ–æ‚¬æµ®å·¥å…·æ æŒ‰é’®äº‹ä»¶
        setupFloatingToolbarEvents()
    }
    
    // æ‚¬æµ®å·¥å…·æ å¼•ç”¨
    private var browserFloatingToolbar: androidx.cardview.widget.CardView? = null
    
    /**
     * åˆå§‹åŒ–æ‚¬æµ®å·¥å…·æ æŒ‰é’®äº‹ä»¶
     */
    private fun setupFloatingToolbarEvents() {
        browserFloatingToolbar = findViewById(R.id.browser_floating_toolbar)
        
        findViewById<ImageButton>(R.id.floating_btn_back)?.setOnClickListener {
            gestureCardWebViewManager?.getCurrentCard()?.webView?.let { webView ->
                if (webView.canGoBack()) {
                    webView.goBack()
                } else {
                    Toast.makeText(this, "æ²¡æœ‰æ›´å¤šå†å²è®°å½•", Toast.LENGTH_SHORT).show()
                }
            }
        }
        
        findViewById<ImageButton>(R.id.floating_btn_forward)?.setOnClickListener {
            gestureCardWebViewManager?.getCurrentCard()?.webView?.let { webView ->
                if (webView.canGoForward()) {
                    webView.goForward()
                } else {
                    Toast.makeText(this, "æ²¡æœ‰æ›´å¤šå‰è¿›è®°å½•", Toast.LENGTH_SHORT).show()
                }
            }
        }
        
        findViewById<ImageButton>(R.id.floating_btn_home)?.setOnClickListener {
            showBrowserHome()
        }
        
        findViewById<ImageButton>(R.id.floating_btn_menu)?.setOnClickListener {
            // æ˜¾ç¤ºèœå•
            gestureCardWebViewManager?.getCurrentCard()?.webView?.let { webView ->
                val enhancedMenuManager = com.example.aifloatingball.webview.EnhancedMenuManager(this, windowManager)
                enhancedMenuManager.setOnNewTabListener { url, inBackground ->
                    gestureCardWebViewManager?.addNewCard(url)
                }
                // åœ¨å±å¹•åº•éƒ¨ä¸­é—´æ˜¾ç¤ºèœå•
                val displayMetrics = resources.displayMetrics
                enhancedMenuManager.showEnhancedRefreshMenu(webView, displayMetrics.widthPixels / 2, displayMetrics.heightPixels - 200)
            }
        }
    }
    
    /**
     * è®¾ç½®æœç´¢æ åŒºåŸŸçš„ä¸Šæ»‘æ‰‹åŠ¿ï¼Œæ¿€æ´»æ‚¬æµ®å¡ç‰‡æ¨¡å¼
     * å‚è€ƒiOS Safariçš„æ‰‹åŠ¿äº¤äº’ï¼Œä»æœç´¢æ å‘ä¸Šæ»‘åŠ¨æ¿€æ´»æ‚¬æµ®å¡ç‰‡æ¨¡å¼
     */
    private fun setupBrowserSearchBarSwipeUpGesture() {
        try {
            // ä¸ºæœç´¢è¾“å…¥æ¡†æ·»åŠ ä¸Šæ»‘æ‰‹åŠ¿æ£€æµ‹
            browserSearchInput.setOnTouchListener { view, event ->
                // å¦‚æœæ˜¯ç‚¹å‡»äº‹ä»¶ï¼ˆACTION_DOWNåå¾ˆå¿«ACTION_UPï¼‰ï¼Œä¸å¤„ç†æ‰‹åŠ¿ï¼Œè®©è¾“å…¥æ¡†æ­£å¸¸å¤„ç†
                when (event.action) {
                    MotionEvent.ACTION_DOWN -> {
                        // è®°å½•æŒ‰ä¸‹æ—¶é—´å’Œä½ç½®ï¼Œç”¨äºåˆ¤æ–­æ˜¯å¦ä¸ºç‚¹å‡»
                        val clickStartTime = System.currentTimeMillis()
                        val clickStartX = event.x
                        val clickStartY = event.y
                        view.tag = android.util.Pair(clickStartTime, android.util.Pair(clickStartX, clickStartY))
                        // å…ˆè®©è¾“å…¥æ¡†å¤„ç†DOWNäº‹ä»¶ï¼ŒåŒæ—¶è®°å½•èµ·å§‹ä½ç½®ç”¨äºæ‰‹åŠ¿æ£€æµ‹
                        // ä¸æ¶ˆè´¹äº‹ä»¶ï¼Œè®©è¾“å…¥æ¡†å¯ä»¥æ­£å¸¸è·å–ç„¦ç‚¹
                        handleBrowserSwipeUpGesture(view, event)
                        return@setOnTouchListener false // ä¸æ¶ˆè´¹ï¼Œè®©è¾“å…¥æ¡†å¤„ç†
                    }
                    MotionEvent.ACTION_UP -> {
                        val tagData = view.tag as? android.util.Pair<*, *>
                        val clickStartTime = tagData?.first as? Long ?: 0L
                        val clickStartPos = tagData?.second as? android.util.Pair<*, *>
                        val clickStartX = (clickStartPos?.first as? Float) ?: 0f
                        val clickStartY = (clickStartPos?.second as? Float) ?: 0f
                        val clickDuration = System.currentTimeMillis() - clickStartTime
                        val moveDistance = kotlin.math.sqrt(
                            (event.x - clickStartX) * (event.x - clickStartX) + 
                            (event.y - clickStartY) * (event.y - clickStartY)
                        )
                        // å¦‚æœç‚¹å‡»æ—¶é—´å¾ˆçŸ­ä¸”ç§»åŠ¨è·ç¦»å¾ˆå°ï¼Œè®¤ä¸ºæ˜¯ç‚¹å‡»ï¼Œä¸å¤„ç†æ‰‹åŠ¿
                        if (clickDuration < 300 && moveDistance < 20) {
                            // ç¡®ä¿è¾“å…¥æ¡†å¯ä»¥è·å–ç„¦ç‚¹å¹¶æ˜¾ç¤ºè¾“å…¥æ³•
                            view.isFocusable = true
                            view.isFocusableInTouchMode = true
                            view.requestFocus()
                            handler.postDelayed({
                                val imm = getSystemService(Context.INPUT_METHOD_SERVICE) as? InputMethodManager
                                imm?.showSoftInput(view, InputMethodManager.SHOW_IMPLICIT)
                            }, 100)
                            return@setOnTouchListener false // è®©è¾“å…¥æ¡†æ­£å¸¸å¤„ç†ç‚¹å‡»
                        }
                        // å¦åˆ™å¤„ç†æ‰‹åŠ¿
                        val handled = handleBrowserSwipeUpGesture(view, event)
                        return@setOnTouchListener handled
                    }
                    MotionEvent.ACTION_MOVE -> {
                        // MOVEäº‹ä»¶ä¼ é€’ç»™æ‰‹åŠ¿å¤„ç†ï¼Œä½†ä¸æ¶ˆè´¹äº‹ä»¶
                        handleBrowserSwipeUpGesture(view, event)
                        return@setOnTouchListener false // ä¸æ¶ˆè´¹ï¼Œè®©è¾“å…¥æ¡†å¯ä»¥æ­£å¸¸å¤„ç†
                    }
                    else -> {
                        val handled = handleBrowserSwipeUpGesture(view, event)
                        return@setOnTouchListener handled
                    }
                }
            }
            
            // ä¸ºæœç´¢è¾“å…¥æ¡†çš„çˆ¶å®¹å™¨ï¼ˆæœç´¢æ å®¹å™¨ï¼‰ä¹Ÿæ·»åŠ ä¸Šæ»‘æ‰‹åŠ¿
            val searchBarContainer = browserSearchInput.parent as? ViewGroup
            searchBarContainer?.setOnTouchListener { view, event ->
                // æ£€æŸ¥è§¦æ‘¸ç‚¹æ˜¯å¦åœ¨è¾“å…¥æ¡†å†…
                val inputRect = android.graphics.Rect()
                browserSearchInput.getHitRect(inputRect)
                val x = event.x.toInt()
                val y = event.y.toInt()
                
                if (inputRect.contains(x, y)) {
                    // è§¦æ‘¸ç‚¹åœ¨è¾“å…¥æ¡†å†…ï¼Œä¸å¤„ç†ï¼ˆç”±è¾“å…¥æ¡†è‡ªå·±å¤„ç†ï¼‰
                    false
                } else {
                    // è§¦æ‘¸ç‚¹åœ¨è¾“å…¥æ¡†å¤–ï¼Œå¤„ç†ä¸Šæ»‘æ‰‹åŠ¿
                    val handled = handleBrowserSwipeUpGesture(view, event)
                    Log.d(TAG, "æœç´¢æ å®¹å™¨è§¦æ‘¸äº‹ä»¶: action=${event.action}, handled=$handled")
                    handled
                }
            }
            
            Log.d(TAG, "æœç´¢æ åŒºåŸŸä¸Šæ»‘æ‰‹åŠ¿å·²è®¾ç½®")
        } catch (e: Exception) {
            Log.e(TAG, "è®¾ç½®æœç´¢æ åŒºåŸŸä¸Šæ»‘æ‰‹åŠ¿å¤±è´¥", e)
        }
    }
    
    /**
     * å¤„ç†æœç´¢æ åŒºåŸŸçš„ä¸Šæ»‘æ‰‹åŠ¿
     * @return trueè¡¨ç¤ºå·²å¤„ç†ï¼Œfalseè¡¨ç¤ºæœªå¤„ç†ï¼ˆç»§ç»­ä¼ é€’ç»™å…¶ä»–ç›‘å¬å™¨ï¼‰
     */
    private fun handleBrowserSwipeUpGesture(view: View, event: MotionEvent): Boolean {
        // å¦‚æœè¾“å…¥æ¡†æœ‰ç„¦ç‚¹ä¸”æ­£åœ¨ç¼–è¾‘ï¼Œä¸å¤„ç†ä¸Šæ»‘ï¼ˆé¿å…ä¸è¾“å…¥å†²çªï¼‰
        // ä½†å…è®¸åœ¨ACTION_UPæ—¶æ£€æŸ¥ï¼Œä»¥ä¾¿åœ¨æ¾å¼€æ—¶ä¹Ÿèƒ½æ¿€æ´»
        if (browserSearchInput.hasFocus() && event.action == MotionEvent.ACTION_DOWN) {
            Log.d(TAG, "æœç´¢è¾“å…¥æ¡†æœ‰ç„¦ç‚¹ï¼Œè·³è¿‡DOWNäº‹ä»¶")
            return false
        }
        
        when (event.action) {
            MotionEvent.ACTION_DOWN -> {
                // è®°å½•èµ·å§‹ä½ç½®å’Œæ—¶é—´
                swipeUpStartY = event.rawY
                swipeUpStartX = event.rawX
                swipeUpStartTime = System.currentTimeMillis()
                isSwipeUpActivating = false
                swipeUpProgress = 0f
                Log.d(TAG, "æœç´¢æ ä¸Šæ»‘æ‰‹åŠ¿å¼€å§‹: startY=$swipeUpStartY, startX=$swipeUpStartX")
                return true // è¿”å›trueä»¥æ¥æ”¶åç»­äº‹ä»¶
            }
            
            MotionEvent.ACTION_MOVE -> {
                // å¦‚æœè¾“å…¥æ¡†æœ‰ç„¦ç‚¹ï¼Œä¸å¤„ç†ç§»åŠ¨ï¼ˆé¿å…ä¸è¾“å…¥å†²çªï¼‰
                if (browserSearchInput.hasFocus()) {
                    return false
                }
                
                // è®¡ç®—æ»‘åŠ¨è·ç¦»
                val currentY = event.rawY
                val currentX = event.rawX
                val deltaY = swipeUpStartY - currentY // å‘ä¸Šæ»‘åŠ¨ï¼ŒdeltaYä¸ºæ­£
                val deltaX = kotlin.math.abs(currentX - swipeUpStartX)
                val time = System.currentTimeMillis() - swipeUpStartTime
                val velocity = if (time > 0) (deltaY / time) * 1000 else 0f
                
                // åˆ¤æ–­æ˜¯å¦ä¸ºå‚ç›´æ»‘åŠ¨ï¼ˆå‚ç›´è·ç¦»å¤§äºæ°´å¹³è·ç¦»ï¼‰
                val isVerticalSwipe = deltaY > deltaX && deltaY > 20f
                
                // åªå¤„ç†å‘ä¸Šæ»‘åŠ¨ï¼ˆdeltaY > 0ï¼‰ä¸”æ˜¯å‚ç›´æ»‘åŠ¨
                if (deltaY <= 0 || !isVerticalSwipe) {
                    return false
                }
                
                // è½¬æ¢ä¸ºåƒç´ 
                val density = resources.displayMetrics.density
                val thresholdPx = SWIPE_UP_THRESHOLD * density
                
                // è®¡ç®—ä¸Šæ»‘è¿›åº¦ï¼ˆ0-1ï¼‰
                swipeUpProgress = (deltaY / (thresholdPx * 1.5f)).coerceIn(0f, 1f)
                
                Log.d(TAG, "æœç´¢æ ä¸Šæ»‘ç§»åŠ¨: deltaY=$deltaY, velocity=$velocity, progress=$swipeUpProgress, threshold=$thresholdPx")
                
                // æ£€æŸ¥æ˜¯å¦æ»¡è¶³ä¸Šæ»‘æ¡ä»¶
                if (deltaY > thresholdPx * 0.3f && !isSwipeUpActivating) {
                    // æ˜¾ç¤ºè§†è§‰åé¦ˆ
                    if (swipeUpProgress > 0.4f) {
                        showMaterialToast("ç»§ç»­ä¸Šæ»‘æŸ¥çœ‹æ‰€æœ‰æ ‡ç­¾é¡µ")
                    }
                }
                
                // å¦‚æœä¸Šæ»‘è·ç¦»è¶³å¤Ÿä¸”é€Ÿåº¦è¶³å¤Ÿï¼Œæ¿€æ´»æ‚¬æµ®å¡ç‰‡
                if (deltaY > thresholdPx && velocity > SWIPE_UP_VELOCITY_THRESHOLD && !isSwipeUpActivating) {
                    Log.d(TAG, "å¿«é€Ÿä¸Šæ»‘æ¿€æ´»æ‚¬æµ®å¡ç‰‡: deltaY=$deltaY, velocity=$velocity")
                    isSwipeUpActivating = true
                    activateStackedCardPreview()
                    return true
                }
                
                return true // è¿”å›trueä»¥ç»§ç»­æ¥æ”¶äº‹ä»¶
            }
            
            MotionEvent.ACTION_UP, MotionEvent.ACTION_CANCEL -> {
                // å¦‚æœå·²ç»æ¿€æ´»ï¼Œä¸å¤„ç†
                if (isSwipeUpActivating) {
                    isSwipeUpActivating = false
                    return true
                }
                
                // æ£€æŸ¥æ˜¯å¦æ»¡è¶³æ¿€æ´»æ¡ä»¶ï¼ˆå³ä½¿é€Ÿåº¦ä¸å¤Ÿï¼Œä½†è·ç¦»è¶³å¤Ÿï¼‰
                val currentY = event.rawY
                val deltaY = swipeUpStartY - currentY
                
                // åªå¤„ç†å‘ä¸Šæ»‘åŠ¨
                if (deltaY <= 0) {
                    Log.d(TAG, "æœç´¢æ ä¸Šæ»‘æ‰‹åŠ¿å–æ¶ˆ: ä¸æ˜¯å‘ä¸Šæ»‘åŠ¨")
                    isSwipeUpActivating = false
                    swipeUpProgress = 0f
                    return false
                }
                
                val density = resources.displayMetrics.density
                val thresholdPx = SWIPE_UP_THRESHOLD * density
                
                Log.d(TAG, "æœç´¢æ ä¸Šæ»‘æ‰‹åŠ¿ç»“æŸ: deltaY=$deltaY, threshold=$thresholdPx, progress=$swipeUpProgress")
                
                // é™ä½æ¿€æ´»é˜ˆå€¼ï¼Œæ›´å®¹æ˜“è§¦å‘ï¼ˆè·ç¦»è¶…è¿‡60%é˜ˆå€¼å³å¯ï¼‰
                if (deltaY > thresholdPx * 0.6f) {
                    Log.d(TAG, "æ…¢é€Ÿä¸Šæ»‘æ¿€æ´»æ‚¬æµ®å¡ç‰‡: deltaY=$deltaY")
                    activateStackedCardPreview()
                    return true
                }
                
                // é‡ç½®çŠ¶æ€
                isSwipeUpActivating = false
                swipeUpProgress = 0f
                return false
            }
            
            else -> return false
        }
    }

    /**
     * è®¾ç½®æµè§ˆå™¨æŠ½å±‰ - å®Œæ•´åŠŸèƒ½ç‰ˆæœ¬
     */
    private fun setupBrowserDrawer() {
        // è®¾ç½®æŠ½å±‰ç›‘å¬å™¨
        browserLayout.addDrawerListener(object : DrawerLayout.DrawerListener {
            override fun onDrawerSlide(drawerView: View, slideOffset: Float) {
                // æ›´æ–°é€æ˜åº¦å’ŒåŠ¨ç”»
                drawerView.alpha = 0.3f + (0.7f * slideOffset)
                Log.d(TAG, "æŠ½å±‰æ»‘åŠ¨ï¼Œåç§»é‡: $slideOffset")
            }

            override fun onDrawerOpened(drawerView: View) {
                drawerView.alpha = 1.0f
                Log.d(TAG, "æŠ½å±‰å·²æ‰“å¼€")
                // æ‰“å¼€æŠ½å±‰æ—¶æ›´æ–°æœç´¢å¼•æ“åˆ—è¡¨
                updateBrowserEngineList('#')
            }

            override fun onDrawerClosed(drawerView: View) {
                Log.d(TAG, "æŠ½å±‰å·²å…³é—­")
            }

            override fun onDrawerStateChanged(newState: Int) {
                Log.d(TAG, "æŠ½å±‰çŠ¶æ€æ”¹å˜: $newState")
            }
        })

        // è®¾ç½®é€€å‡ºæŒ‰é’®ç‚¹å‡»ç›‘å¬å™¨
        browserExitButton.setOnClickListener {
            browserLayout.closeDrawer(GravityCompat.START)
        }

        // ç¡®ä¿æŠ½å±‰å¯ä»¥è¢«è§¦æ‘¸å’Œæ»‘åŠ¨
        browserLayout.setDrawerLockMode(DrawerLayout.LOCK_MODE_UNLOCKED)

        // å¯ç”¨æŠ½å±‰è¾¹ç¼˜æ»‘åŠ¨æ‰‹åŠ¿
        browserLayout.setScrimColor(0x99000000.toInt()) // è®¾ç½®åŠé€æ˜é®ç½©

        Log.d(TAG, "æµè§ˆå™¨æŠ½å±‰è®¾ç½®å®Œæˆï¼Œé”å®šæ¨¡å¼: ${browserLayout.getDrawerLockMode(GravityCompat.START)}")

        // è®¾ç½®å­—æ¯ç´¢å¼•æ 
        setupBrowserLetterIndexBar()
    }

    /**
     * è®¾ç½®æµè§ˆå™¨å¿«æ·æ–¹å¼
     */
    private fun setupBrowserShortcuts() {
        browserShortcutsGrid.layoutManager = GridLayoutManager(this, 4)

        // å®Œå…¨ç§»é™¤ç½‘ç«™å¿«æ·æ–¹å¼ï¼Œä¸æ˜¾ç¤ºä»»ä½•ç½‘ç«™å›¾æ ‡
        val shortcuts = emptyList<BrowserShortcut>()

        // è®¾ç½®é€‚é…å™¨
        val adapter = BrowserShortcutAdapter(shortcuts) { shortcut ->
            loadBrowserContent(shortcut.url)
        }
        browserShortcutsGrid.adapter = adapter
    }

    /**
     * æµè§ˆå™¨å¿«æ·æ–¹å¼æ•°æ®ç±»
     */
    data class BrowserShortcut(
        val name: String,
        val url: String,
        val iconResId: Int
    )

    /**
     * æµè§ˆå™¨å¿«æ·æ–¹å¼é€‚é…å™¨
     */
    inner class BrowserShortcutAdapter(
        private val shortcuts: List<BrowserShortcut>,
        private val onShortcutClick: (BrowserShortcut) -> Unit
    ) : androidx.recyclerview.widget.RecyclerView.Adapter<BrowserShortcutAdapter.ViewHolder>() {

        inner class ViewHolder(view: View) : androidx.recyclerview.widget.RecyclerView.ViewHolder(view) {
            val icon: ImageView = view.findViewById(R.id.shortcut_icon)
            val name: TextView = view.findViewById(R.id.shortcut_name)
        }

        override fun onCreateViewHolder(parent: ViewGroup, viewType: Int): ViewHolder {
            val view = LayoutInflater.from(parent.context)
                .inflate(R.layout.item_browser_shortcut, parent, false)
            return ViewHolder(view)
        }

        override fun onBindViewHolder(holder: ViewHolder, position: Int) {
            val shortcut = shortcuts[position]
            holder.name.text = shortcut.name

            // ä½¿ç”¨FaviconLoaderåŠ è½½å¿«æ·æ–¹å¼å›¾æ ‡
            com.example.aifloatingball.utils.FaviconLoader.loadIcon(
                holder.icon,
                shortcut.url,
                shortcut.iconResId
            )

            holder.itemView.setOnClickListener {
                onShortcutClick(shortcut)
            }
        }

        override fun getItemCount() = shortcuts.size
    }

    /**
     * åˆå§‹åŒ–æµè§ˆå™¨æœç´¢å¼•æ“
     */
    private fun initializeBrowserSearchEngine() {
        // è·å–é»˜è®¤æœç´¢å¼•æ“
        val defaultEngines = com.example.aifloatingball.model.SearchEngine.DEFAULT_ENGINES
        currentSearchEngine = if (defaultEngines.isNotEmpty()) {
            defaultEngines[0] // ä½¿ç”¨ç¬¬ä¸€ä¸ªä½œä¸ºé»˜è®¤æœç´¢å¼•æ“
        } else {
            // å¦‚æœæ²¡æœ‰é»˜è®¤å¼•æ“ï¼Œåˆ›å»ºä¸€ä¸ªGoogleæœç´¢å¼•æ“
            com.example.aifloatingball.model.SearchEngine(
                name = "Google",
                displayName = "Google",
                url = "https://www.google.com/search?q={query}",
                iconResId = R.drawable.ic_google,
                description = "Googleæœç´¢"
            )
        }

        Log.d(TAG, "åˆå§‹åŒ–é»˜è®¤æœç´¢å¼•æ“: ${currentSearchEngine?.name}")

        // æ›´æ–°æœç´¢tabå›¾æ ‡
        updateSearchTabIcon()
    }

    /**
     * è®¾ç½®æµè§ˆå™¨æœç´¢å¼•æ“é€‰æ‹©å™¨
     * å·²ä»å¸ƒå±€ä¸­åˆ é™¤ï¼Œæ­¤æ–¹æ³•ä¸å†ä½¿ç”¨
     */
    private fun setupBrowserSearchEngineSelector() {
        // æœç´¢å¼•æ“é€‰æ‹©å™¨å·²ä»å¸ƒå±€ä¸­åˆ é™¤ï¼Œæ­¤æ–¹æ³•ä¸å†éœ€è¦
        Log.d(TAG, "æœç´¢å¼•æ“é€‰æ‹©å™¨å·²ä»å¸ƒå±€ä¸­åˆ é™¤ï¼Œè·³è¿‡è®¾ç½®")
    }

    /**
     * è®¾ç½®å¡ç‰‡é¢„è§ˆåŠŸèƒ½
     */
    private fun setupCardPreviewFeature() {
        // åˆ›å»ºå¡ç‰‡é¢„è§ˆè¦†ç›–å±‚
        cardPreviewOverlay = CardPreviewOverlay(this)
        cardPreviewOverlay.layoutParams = FrameLayout.LayoutParams(
            FrameLayout.LayoutParams.MATCH_PARENT,
            FrameLayout.LayoutParams.MATCH_PARENT
        ).apply {
            topMargin = 150 // æ·»åŠ é¡¶éƒ¨è¾¹è·ï¼Œé¿å…è¦†ç›–æœç´¢tabåŒºåŸŸ
        }
        cardPreviewOverlay.visibility = View.GONE

        // å…³é”®ä¿®å¤ï¼šå°†è¦†ç›–å±‚æ·»åŠ åˆ°æ ¹å¸ƒå±€è€Œä¸æ˜¯WebViewå®¹å™¨
        // è¿™æ ·å¯ä»¥é¿å…ä¸æœç´¢å¼•æ“ç•Œé¢æ··åˆ
        browserLayout.addView(cardPreviewOverlay)

        Log.d(TAG, "å¡ç‰‡é¢„è§ˆè¦†ç›–å±‚å·²æ·»åŠ åˆ°æ ¹å¸ƒå±€")


        // è®¾ç½®å¡ç‰‡é¢„è§ˆè¦†ç›–å±‚ç›‘å¬å™¨
        cardPreviewOverlay.setOnCardClickListener(object : CardPreviewOverlay.OnCardClickListener {
            override fun onCardClick(cardData: GestureCardWebViewManager.WebViewCardData, position: Int) {
                // éšè—å¡ç‰‡é¢„è§ˆ
                cardPreviewOverlay.hide()

                // åˆ‡æ¢åˆ°æŒ‡å®šå¡ç‰‡
                gestureCardWebViewManager?.switchToCard(position)

                // ç¡®ä¿UIçŠ¶æ€æ­£ç¡®
                browserLayout.postDelayed({
                    forceRefreshUIState()
                }, 300) // ç­‰å¾…éšè—åŠ¨ç”»å®Œæˆ

                Log.d(TAG, "åˆ‡æ¢åˆ°å¡ç‰‡: ${cardData.title}")
            }

            override fun onCardClose(cardData: GestureCardWebViewManager.WebViewCardData, position: Int) {
                // å…³é—­æŒ‡å®šå¡ç‰‡
                gestureCardWebViewManager?.removeCard(position)

                // å¦‚æœè¿˜æœ‰å¡ç‰‡ï¼Œæ›´æ–°é¢„è§ˆ
                val remainingCards = gestureCardWebViewManager?.getAllCards() ?: emptyList()
                if (remainingCards.isNotEmpty()) {
                    cardPreviewOverlay.show(remainingCards)
                } else {
                    // æ²¡æœ‰å¡ç‰‡äº†ï¼Œéšè—é¢„è§ˆå¹¶è¿”å›æœç´¢tab
                    cardPreviewOverlay.hide()
                    
                    // åˆ‡æ¢åˆ°æœç´¢tab
                    browserLayout.postDelayed({
                        switchToSearchTab()
                        Log.d(TAG, "æœ€åä¸€ä¸ªå¡ç‰‡å·²å…³é—­ï¼Œè¿”å›æœç´¢tab")
                    }, 300) // ç­‰å¾…éšè—åŠ¨ç”»å®Œæˆ
                }

                Log.d(TAG, "å…³é—­å¡ç‰‡: ${cardData.title}")
            }
        })

        cardPreviewOverlay.setOnCloseListener(object : CardPreviewOverlay.OnCloseListener {
            override fun onClose() {
                Log.d(TAG, "å…³é—­å¡ç‰‡é¢„è§ˆ")

                // ç¡®ä¿è¿”å›åˆ°æ­£ç¡®çš„çŠ¶æ€
                browserLayout.postDelayed({
                    forceRefreshUIState()
                }, 100)
            }
        })

        cardPreviewOverlay.setOnAddCardListener(object : CardPreviewOverlay.OnAddCardListener {
            override fun onAddCard() {
                // éšè—é¢„è§ˆç•Œé¢
                cardPreviewOverlay.hide()

                // åˆ›å»ºæ–°å¡ç‰‡
                browserLayout.postDelayed({
                    performCreateNewCard()
                }, 300) // ç­‰å¾…éšè—åŠ¨ç”»å®Œæˆ

                Log.d(TAG, "ä»å¡ç‰‡é¢„è§ˆåˆ›å»ºæ–°å¡ç‰‡")
            }
        })

        Log.d(TAG, "å¡ç‰‡é¢„è§ˆåŠŸèƒ½è®¾ç½®å®Œæˆ")
    }

    /**
     * è®¾ç½®æ‰‹åŠ¿æç¤ºåŠŸèƒ½
     */
    private fun setupGestureHintFeature() {
        // è®¾ç½®æ‰‹åŠ¿æç¤ºå…³é—­æŒ‰é’®
        browserGestureHintClose.setOnClickListener {
            hideGestureHint()
        }

        // ç‚¹å‡»è¦†ç›–å±‚èƒŒæ™¯åŒºåŸŸå…³é—­æç¤ºï¼ˆä½†ä¸åŒ…æ‹¬å¡ç‰‡å†…å®¹ï¼‰
        browserGestureOverlay.setOnClickListener { view ->
            // åªæœ‰ç‚¹å‡»çš„æ˜¯è¦†ç›–å±‚æœ¬èº«ï¼ˆä¸æ˜¯å¡ç‰‡å†…å®¹ï¼‰æ‰å…³é—­
            if (view == browserGestureOverlay) {
                hideGestureHint()
            }
        }

        // æ³¨æ„ï¼šç‚¹å‡»å¡ç‰‡å†…å®¹ä¸ä¼šå…³é—­å¼¹çª—ï¼Œåªæœ‰ç‚¹å‡»èƒŒæ™¯åŒºåŸŸæˆ–å…³é—­æŒ‰é’®æ‰ä¼šå…³é—­

        // é¦–æ¬¡ä½¿ç”¨æ—¶æ˜¾ç¤ºæ‰‹åŠ¿æç¤º
        val sharedPrefs = getSharedPreferences("gesture_hints", MODE_PRIVATE)
        val hasShownHint = sharedPrefs.getBoolean("has_shown_gesture_hint", false)

        if (!hasShownHint) {
            // å»¶è¿Ÿ3ç§’æ˜¾ç¤ºæ‰‹åŠ¿æç¤º
            handler.postDelayed({
                if (!isFinishing && !isDestroyed) {
                    showGestureHint()
                    sharedPrefs.edit().putBoolean("has_shown_gesture_hint", true).apply()
                }
            }, 3000)
        }

        Log.d(TAG, "æ‰‹åŠ¿æç¤ºåŠŸèƒ½è®¾ç½®å®Œæˆ")
    }

    /**
     * æ˜¾ç¤ºå¡ç‰‡é¢„è§ˆ
     */
    private fun showCardPreview() {
        Log.d(TAG, "=== å·¦ä¸Šè§’å¡ç‰‡é¢„è§ˆå¼€å§‹ ===")

        // æ£€æŸ¥ç®¡ç†å™¨çŠ¶æ€
        val gestureManager = gestureCardWebViewManager
        val mobileManager = mobileCardManager

        Log.d(TAG, "ç®¡ç†å™¨çŠ¶æ€ - æ‰‹åŠ¿ç®¡ç†å™¨: ${gestureManager != null}, æ‰‹æœºç®¡ç†å™¨: ${mobileManager != null}")

        if (gestureManager != null) {
            val gestureCards = gestureManager.getAllCards()
            Log.d(TAG, "æ‰‹åŠ¿ç®¡ç†å™¨å¡ç‰‡æ•°: ${gestureCards.size}")
            gestureCards.forEachIndexed { index, card ->
                Log.d(TAG, "  æ‰‹åŠ¿å¡ç‰‡[$index]: ${card.title} - ${card.url}")
            }
        }

        if (mobileManager != null) {
            val mobileCards = mobileManager.getAllCards()
            Log.d(TAG, "æ‰‹æœºç®¡ç†å™¨å¡ç‰‡æ•°: ${mobileCards.size}")
            mobileCards.forEachIndexed { index, card ->
                Log.d(TAG, "  æ‰‹æœºå¡ç‰‡[$index]: ${card.title} - ${card.url}")
            }
        }

        // ä½¿ç”¨ç»Ÿä¸€çš„å¡ç‰‡æ•°æ®è·å–æ–¹æ³•
        val allCards = getAllUnifiedCards()

        Log.d(TAG, "å·¦ä¸Šè§’å¡ç‰‡é¢„è§ˆ - ç»Ÿä¸€åæ€»è®¡: ${allCards.size}")

        if (allCards.isNotEmpty()) {
            // ç¡®ä¿å¡ç‰‡é¢„è§ˆè¦†ç›–å±‚åœ¨æœ€å‰é¢
            cardPreviewOverlay.bringToFront()
            cardPreviewOverlay.show(allCards)
            Log.d(TAG, "âœ… æ˜¾ç¤ºå·¦ä¸Šè§’å¡ç‰‡é¢„è§ˆï¼Œå¡ç‰‡æ•°: ${allCards.size}")
        } else {
            Log.w(TAG, "âš ï¸ æ²¡æœ‰æ‰¾åˆ°ä»»ä½•å¡ç‰‡ï¼Œæ˜¾ç¤ºæç¤º")
            Toast.makeText(this, "æ²¡æœ‰æ‰“å¼€çš„é¡µé¢", Toast.LENGTH_SHORT).show()
        }

        Log.d(TAG, "=== å·¦ä¸Šè§’å¡ç‰‡é¢„è§ˆç»“æŸ ===")
    }

    /**
     * æ˜¾ç¤ºæ–°å»ºå¡ç‰‡é¢„è§ˆï¼ˆé›†æˆåˆ°é¢„è§ˆå¡ç‰‡ç³»ç»Ÿï¼‰
     */
    private fun showNewCardPreview() {
        try {
            Log.d(TAG, "æ˜¾ç¤ºæ–°å»ºå¡ç‰‡é¢„è§ˆ")

            // åˆå¹¶æ‰€æœ‰ç®¡ç†å™¨çš„å¡ç‰‡
            val gestureCards = gestureCardWebViewManager?.getAllCards() ?: emptyList()
            val mobileCards = mobileCardManager?.getAllCards() ?: emptyList()
            val allCards = mutableListOf<GestureCardWebViewManager.WebViewCardData>()

            allCards.addAll(gestureCards)
            allCards.addAll(mobileCards)

            Log.d(TAG, "æ–°å»ºå¡ç‰‡é¢„è§ˆ - æ‰‹åŠ¿å¡ç‰‡: ${gestureCards.size}, æ‰‹æœºå¡ç‰‡: ${mobileCards.size}, æ€»è®¡: ${allCards.size}")

            if (allCards.isNotEmpty()) {
                // ä½¿ç”¨å±‚å å¡ç‰‡é¢„è§ˆç³»ç»Ÿæ˜¾ç¤ºæ–°å»ºçš„å¡ç‰‡
                stackedCardPreview?.apply {
                    // è½¬æ¢ä¸ºStackedCardPreviewçš„æ•°æ®æ ¼å¼
                    val stackedCards = allCards.map { card ->
                        com.example.aifloatingball.views.StackedCardPreview.WebViewCardData(
                            title = card.title,
                            url = card.url,
                            favicon = card.favicon,
                            screenshot = card.webView?.let { webView ->
                                // å°è¯•è·å–WebViewæˆªå›¾
                                try {
                                    val bitmap = Bitmap.createBitmap(
                                        webView.width,
                                        webView.height,
                                        Bitmap.Config.ARGB_8888
                                    )
                                    val canvas = Canvas(bitmap)
                                    webView.draw(canvas)
                                    bitmap
                                } catch (e: Exception) {
                                    Log.w(TAG, "è·å–WebViewæˆªå›¾å¤±è´¥", e)
                                    null
                                }
                            }
                        )
                    }

                    // è®¾ç½®å¡ç‰‡æ•°æ®
                    setWebViewCards(stackedCards)

                    // é‡ç½®ä¸ºå±‚å æ¨¡å¼
                    resetToStackedMode()

                    // å¯ç”¨äº¤äº’
                    enableStackedInteraction()

                    // æ˜¾ç¤ºé¢„è§ˆï¼Œä½¿ç”¨æ·¡å…¥åŠ¨ç”»
                    alpha = 0f
                    visibility = View.VISIBLE
                    animate()
                        .alpha(1f)
                        .setDuration(300)
                        .start()

                    Log.d(TAG, "å±‚å å¡ç‰‡é¢„è§ˆå·²æ˜¾ç¤ºï¼ŒåŒ…å« ${stackedCards.size} å¼ å¡ç‰‡")
                }

                // ç»™ç”¨æˆ·æ“ä½œæç¤ºï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼Œé¿å…è¿‡é•¿ï¼‰
                val message = "æ–°å¡ç‰‡å·²åˆ›å»ºï¼å·¦å³æ»‘åŠ¨æŸ¥çœ‹ï¼Œä¸Šæ»‘å…³é—­ï¼Œç‚¹å‡»æ‰“å¼€"
                Toast.makeText(this, message, Toast.LENGTH_SHORT).show()

            } else {
                Log.w(TAG, "æ²¡æœ‰å¡ç‰‡å¯ä»¥é¢„è§ˆ")
                Toast.makeText(this, "æ²¡æœ‰å¡ç‰‡å¯ä»¥é¢„è§ˆ", Toast.LENGTH_SHORT).show()
            }

        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºæ–°å»ºå¡ç‰‡é¢„è§ˆå¤±è´¥", e)
            Toast.makeText(this, "æ˜¾ç¤ºå¡ç‰‡é¢„è§ˆå¤±è´¥: ${e.message}", Toast.LENGTH_SHORT).show()
        }
    }

    /**
     * æ˜¾ç¤ºæ‰‹åŠ¿æç¤º
     */
    private fun showGestureHint() {
        try {
            // å®‰å…¨æ£€æŸ¥ï¼šç¡®ä¿ç»„ä»¶å·²åˆå§‹åŒ–
            if (!::browserGestureOverlay.isInitialized) {
                Log.e(TAG, "browserGestureOverlayæœªåˆå§‹åŒ–ï¼Œæ— æ³•æ˜¾ç¤ºæ‰‹åŠ¿æç¤º")
                return
            }

            // æ£€æŸ¥ActivityçŠ¶æ€
            if (isFinishing || isDestroyed) {
                Log.w(TAG, "Activityæ­£åœ¨ç»“æŸæˆ–å·²é”€æ¯ï¼Œè·³è¿‡æ˜¾ç¤ºæ‰‹åŠ¿æç¤º")
                return
            }

            // åœæ­¢ä»»ä½•æ­£åœ¨è¿›è¡Œçš„åŠ¨ç”»
            browserGestureOverlay.clearAnimation()

            // ç¡®ä¿æ‰‹åŠ¿æç¤ºè¦†ç›–å±‚åœ¨æœ€å‰é¢
            browserGestureOverlay.bringToFront()
            browserGestureOverlay.visibility = View.VISIBLE
            browserGestureOverlay.alpha = 0f

            // ä½¿ç”¨æ›´ç¨³å®šçš„åŠ¨ç”»æ–¹å¼
            browserGestureOverlay.animate()
                .alpha(1f)
                .setDuration(500)  // å¢åŠ åŠ¨ç”»æ—¶é—´ï¼Œè®©ç”¨æˆ·æœ‰è¶³å¤Ÿæ—¶é—´çœ‹åˆ°
                .setListener(object : android.animation.AnimatorListenerAdapter() {
                    override fun onAnimationStart(animation: android.animation.Animator) {
                        Log.d(TAG, "å¼€å§‹æ˜¾ç¤ºæ‰‹åŠ¿æç¤ºåŠ¨ç”»")
                    }

                    override fun onAnimationEnd(animation: android.animation.Animator) {
                        Log.d(TAG, "æ‰‹åŠ¿æç¤ºåŠ¨ç”»å®Œæˆï¼Œå¼¹çª—å·²ç¨³å®šæ˜¾ç¤º")
                        // ç¡®ä¿æœ€ç»ˆçŠ¶æ€æ­£ç¡®
                        browserGestureOverlay.alpha = 1f
                        browserGestureOverlay.visibility = View.VISIBLE
                    }

                    override fun onAnimationCancel(animation: android.animation.Animator) {
                        Log.d(TAG, "æ‰‹åŠ¿æç¤ºåŠ¨ç”»è¢«å–æ¶ˆ")
                    }
                })
                .start()

            Log.d(TAG, "æ˜¾ç¤ºæ‰‹åŠ¿æç¤º")

        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºæ‰‹åŠ¿æç¤ºæ—¶å‘ç”Ÿé”™è¯¯", e)
        }
    }

    /**
     * éšè—æ‰‹åŠ¿æç¤º
     */
    private fun hideGestureHint() {
        try {
            // å®‰å…¨æ£€æŸ¥ï¼šç¡®ä¿ç»„ä»¶å·²åˆå§‹åŒ–
            if (!::browserGestureOverlay.isInitialized) {
                Log.e(TAG, "browserGestureOverlayæœªåˆå§‹åŒ–ï¼Œæ— æ³•éšè—æ‰‹åŠ¿æç¤º")
                return
            }

            // æ£€æŸ¥ActivityçŠ¶æ€
            if (isFinishing || isDestroyed) {
                Log.w(TAG, "Activityæ­£åœ¨ç»“æŸæˆ–å·²é”€æ¯ï¼Œè·³è¿‡éšè—æ‰‹åŠ¿æç¤º")
                return
            }

            // æ£€æŸ¥å½“å‰æ˜¯å¦çœŸçš„åœ¨æ˜¾ç¤º
            if (browserGestureOverlay.visibility != View.VISIBLE) {
                Log.d(TAG, "æ‰‹åŠ¿æç¤ºå·²ç»éšè—ï¼Œæ— éœ€é‡å¤æ“ä½œ")
                return
            }

            // åœæ­¢ä»»ä½•æ­£åœ¨è¿›è¡Œçš„åŠ¨ç”»
            browserGestureOverlay.clearAnimation()

            browserGestureOverlay.animate()
                .alpha(0f)
                .setDuration(300)  // ç¨å¾®å¢åŠ éšè—åŠ¨ç”»æ—¶é—´
                .setListener(object : android.animation.AnimatorListenerAdapter() {
                    override fun onAnimationStart(animation: android.animation.Animator) {
                        Log.d(TAG, "å¼€å§‹éšè—æ‰‹åŠ¿æç¤ºåŠ¨ç”»")
                    }

                    override fun onAnimationEnd(animation: android.animation.Animator) {
                        if (!isFinishing && !isDestroyed) {
                            browserGestureOverlay.visibility = View.GONE
                            browserGestureOverlay.alpha = 0f
                            Log.d(TAG, "æ‰‹åŠ¿æç¤ºåŠ¨ç”»å®Œæˆå¹¶éšè—")
                        }
                    }

                    override fun onAnimationCancel(animation: android.animation.Animator) {
                        Log.d(TAG, "éšè—æ‰‹åŠ¿æç¤ºåŠ¨ç”»è¢«å–æ¶ˆ")
                    }
                })
                .start()

            Log.d(TAG, "éšè—æ‰‹åŠ¿æç¤º")

        } catch (e: Exception) {
            Log.e(TAG, "éšè—æ‰‹åŠ¿æç¤ºæ—¶å‘ç”Ÿé”™è¯¯", e)
        }
    }

    /**
     * è·å–æ‰€æœ‰ç»Ÿä¸€çš„å¡ç‰‡æ•°æ®
     * ç¡®ä¿ä¸¤ä¸ªå¡ç‰‡ç³»ç»Ÿä½¿ç”¨ç›¸åŒçš„æ•°æ®æº
     * æ™ºèƒ½å¤„ç†baidué¦–é¡µï¼šåªæœ‰åœ¨æœ‰å…¶ä»–çœŸå®å†…å®¹æ—¶æ‰æ’é™¤baidué¦–é¡µ
     */
    private fun getAllUnifiedCards(): List<GestureCardWebViewManager.WebViewCardData> {
        try {
            val gestureCards = gestureCardWebViewManager?.getAllCards() ?: emptyList()
            val mobileCards = mobileCardManager?.getAllCards() ?: emptyList()
            val paperStackTabs = paperStackWebViewManager?.getAllTabs() ?: emptyList()
            val allCards = mutableListOf<GestureCardWebViewManager.WebViewCardData>()

            Log.d(TAG, "=== ç»Ÿä¸€å¡ç‰‡æ•°æ®è·å–å¼€å§‹ ===")
            Log.d(TAG, "æ‰‹åŠ¿ç®¡ç†å™¨çŠ¶æ€: ${gestureCardWebViewManager != null}")
            Log.d(TAG, "æ‰‹æœºç®¡ç†å™¨çŠ¶æ€: ${mobileCardManager != null}")
            Log.d(TAG, "çº¸å †ç®¡ç†å™¨çŠ¶æ€: ${paperStackWebViewManager != null}")
            Log.d(TAG, "æ‰‹åŠ¿å¡ç‰‡æ•°é‡: ${gestureCards.size}")
            Log.d(TAG, "æ‰‹æœºå¡ç‰‡æ•°é‡: ${mobileCards.size}")
            Log.d(TAG, "çº¸å †æ ‡ç­¾é¡µæ•°é‡: ${paperStackTabs.size}")

            // ğŸ”§ ä¿®å¤ï¼šå…ˆå¤„ç†åŠŸèƒ½ä¸»é¡µï¼Œç¡®ä¿åªä¿ç•™ä¸€ä¸ª
            // ä¼˜å…ˆä»çº¸å †ç³»ç»Ÿä¸­è·å–åŠŸèƒ½ä¸»é¡µï¼ˆå› ä¸ºçº¸å †ç³»ç»Ÿæ˜¯ä¸»è¦ç³»ç»Ÿï¼‰
            var hasFunctionalHome = false
            var functionalHomeTab: com.example.aifloatingball.webview.PaperStackWebViewManager.WebViewTab? = null
            
            paperStackTabs.forEach { tab ->
                val isFunctionalHome = tab.url == "home://functional" || 
                                      tab.url == "file:///android_asset/functional_home.html"
                if (isFunctionalHome && !hasFunctionalHome) {
                    functionalHomeTab = tab
                    hasFunctionalHome = true
                    Log.d(TAG, "ğŸ”§ æ‰¾åˆ°çº¸å †ç³»ç»Ÿçš„åŠŸèƒ½ä¸»é¡µ: ${tab.title} - ${tab.url}")
                }
            }

            // ğŸ”§ ä¿®å¤ï¼šåœ¨lambdaå¤–éƒ¨ä¿å­˜functionalHomeTabçš„å€¼ï¼Œé¿å…æ™ºèƒ½è½¬æ¢é—®é¢˜
            val savedFunctionalHomeTab = functionalHomeTab

            // å…ˆæ·»åŠ æ‰‹åŠ¿å¡ç‰‡ï¼ˆæ’é™¤åŠŸèƒ½ä¸»é¡µï¼‰
            gestureCards.forEach { card ->
                val isFunctionalHome = card.url == "home://functional" || 
                                      card.url == "file:///android_asset/functional_home.html"
                if (!isFunctionalHome) {
                    allCards.add(card)
                    Log.d(TAG, "æ·»åŠ æ‰‹åŠ¿å¡ç‰‡: ${card.title} - ${card.url}")
                } else {
                    Log.d(TAG, "ğŸ”§ è·³è¿‡æ‚¬æµ®å¡ç‰‡ç³»ç»Ÿçš„åŠŸèƒ½ä¸»é¡µï¼ˆä¼˜å…ˆä½¿ç”¨çº¸å †ç³»ç»Ÿçš„ï¼‰: ${card.title} - ${card.url}")
                }
            }
            Log.d(TAG, "æ·»åŠ æ‰‹åŠ¿å¡ç‰‡åæ€»æ•°: ${allCards.size}")

            // å†æ·»åŠ æ‰‹æœºå¡ç‰‡ï¼Œé¿å…é‡å¤ï¼ˆæ’é™¤åŠŸèƒ½ä¸»é¡µï¼‰
            var duplicateCount = 0
            mobileCards.forEach { mobileCard ->
                val isFunctionalHome = mobileCard.url == "home://functional" || 
                                      mobileCard.url == "file:///android_asset/functional_home.html"
                if (isFunctionalHome) {
                    Log.d(TAG, "ğŸ”§ è·³è¿‡æ‰‹æœºå¡ç‰‡ç³»ç»Ÿçš„åŠŸèƒ½ä¸»é¡µï¼ˆä¼˜å…ˆä½¿ç”¨çº¸å †ç³»ç»Ÿçš„ï¼‰: ${mobileCard.title} - ${mobileCard.url}")
                    duplicateCount++
                    return@forEach
                }
                
                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒçš„å¡ç‰‡ï¼ˆé€šè¿‡URLæˆ–IDåˆ¤æ–­ï¼‰
                val isDuplicate = allCards.any { existingCard ->
                    existingCard.id == mobileCard.id ||
                    (existingCard.url == mobileCard.url && existingCard.url?.isNotEmpty() == true)
                }
                if (!isDuplicate) {
                    allCards.add(mobileCard)
                    Log.d(TAG, "æ·»åŠ æ‰‹æœºå¡ç‰‡: ${mobileCard.title} - ${mobileCard.url}")
                } else {
                    duplicateCount++
                    Log.d(TAG, "è·³è¿‡é‡å¤å¡ç‰‡: ${mobileCard.title} - ${mobileCard.url}")
                }
            }

            // ğŸ”§ ä¿®å¤ï¼šä¼˜å…ˆæ·»åŠ çº¸å †ç³»ç»Ÿçš„åŠŸèƒ½ä¸»é¡µï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            savedFunctionalHomeTab?.let { tab ->
                val paperStackCard = GestureCardWebViewManager.WebViewCardData(
                    id = tab.id,
                    title = tab.title,
                    url = tab.url,
                    webView = tab.webView,
                    screenshot = tab.screenshot
                )
                allCards.add(0, paperStackCard) // æ·»åŠ åˆ°ç¬¬ä¸€ä¸ªä½ç½®
                Log.d(TAG, "ğŸ”§ æ·»åŠ çº¸å †ç³»ç»Ÿçš„åŠŸèƒ½ä¸»é¡µï¼ˆä¼˜å…ˆï¼‰: ${tab.title} - ${tab.url}")
            }

            // æ™ºèƒ½å¤„ç†çº¸å †æ ‡ç­¾é¡µæ•°æ®ï¼ˆæ’é™¤åŠŸèƒ½ä¸»é¡µï¼Œå› ä¸ºå·²ç»å¤„ç†è¿‡äº†ï¼‰
            val hasRealContent = gestureCards.isNotEmpty() || mobileCards.isNotEmpty() || 
                                paperStackTabs.any { tab -> 
                                    val isFunctionalHome = tab.url == "home://functional" || 
                                                          tab.url == "file:///android_asset/functional_home.html"
                                    !isFunctionalHome && (tab.url != "https://www.baidu.com" || tab.title != "ç™¾åº¦")
                                }
            
            paperStackTabs.forEach { tab ->
                // æ£€æŸ¥æ˜¯å¦æ˜¯åŠŸèƒ½ä¸»é¡µï¼ˆå·²ç»å¤„ç†è¿‡äº†ï¼Œè·³è¿‡ï¼‰
                val isFunctionalHome = tab.url == "home://functional" || 
                                      tab.url == "file:///android_asset/functional_home.html"
                if (isFunctionalHome) {
                    // åŠŸèƒ½ä¸»é¡µå·²ç»æ·»åŠ è¿‡äº†ï¼Œè·³è¿‡
                    return@forEach
                }
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯baidué¦–é¡µ
                val isBaiduHome = tab.url == "https://www.baidu.com" && tab.title == "ç™¾åº¦"
                
                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒçš„å¡ç‰‡
                val isDuplicate = allCards.any { existingCard ->
                    existingCard.url == tab.url && existingCard.url?.isNotEmpty() == true
                }
                
                // æ™ºèƒ½å†³ç­–ï¼šå¦‚æœæœ‰å…¶ä»–çœŸå®å†…å®¹ï¼Œåˆ™æ’é™¤baidué¦–é¡µï¼›å¦åˆ™åŒ…å«baidué¦–é¡µ
                val shouldInclude = if (isBaiduHome) {
                    !hasRealContent // åªæœ‰åœ¨æ²¡æœ‰å…¶ä»–å†…å®¹æ—¶æ‰åŒ…å«baidué¦–é¡µ
                } else {
                    !isDuplicate // ébaidué¦–é¡µæŒ‰æ­£å¸¸é€»è¾‘å¤„ç†
                }
                
                if (shouldInclude) {
                    val paperStackCard = GestureCardWebViewManager.WebViewCardData(
                        id = tab.id,
                        title = tab.title,
                        url = tab.url,
                        webView = tab.webView,
                        screenshot = tab.screenshot // ğŸ”§ ä¿®å¤4ï¼šä¼ é€’ä¿å­˜çš„æˆªå›¾
                    )
                    allCards.add(paperStackCard)
                    Log.d(TAG, "æ·»åŠ çº¸å †æ ‡ç­¾é¡µ: ${tab.title} - ${tab.url}, æˆªå›¾: ${if (tab.screenshot != null) "æœ‰" else "æ— "}")
                } else {
                    duplicateCount++
                    if (isBaiduHome) {
                        Log.d(TAG, "æ™ºèƒ½æ’é™¤baidué¦–é¡µï¼ˆæœ‰å…¶ä»–å†…å®¹ï¼‰: ${tab.title} - ${tab.url}")
                    } else {
                        Log.d(TAG, "è·³è¿‡é‡å¤çº¸å †æ ‡ç­¾é¡µ: ${tab.title} - ${tab.url}")
                    }
                }
            }

            Log.d(TAG, "ç»Ÿä¸€å¡ç‰‡æ•°æ® - æ‰‹åŠ¿å¡ç‰‡: ${gestureCards.size}, æ‰‹æœºå¡ç‰‡: ${mobileCards.size}, çº¸å †æ ‡ç­¾é¡µ: ${paperStackTabs.size}, é‡å¤: $duplicateCount, å»é‡åæ€»è®¡: ${allCards.size}")
            Log.d(TAG, "ğŸ”§ åŠŸèƒ½ä¸»é¡µå¤„ç†: çº¸å †ç³»ç»Ÿ=${if (savedFunctionalHomeTab != null) "æœ‰" else "æ— "}, æœ€ç»ˆç»“æœ=${if (allCards.any { it.url == "home://functional" || it.url == "file:///android_asset/functional_home.html" }) "æœ‰ä¸”å”¯ä¸€" else "æ— "}")
            Log.d(TAG, "=== ç»Ÿä¸€å¡ç‰‡æ•°æ®è·å–ç»“æŸ ===")

            return allCards
        } catch (e: Exception) {
            Log.e(TAG, "è·å–ç»Ÿä¸€å¡ç‰‡æ•°æ®å¼‚å¸¸", e)
            return emptyList()
        }
    }

    /**
     * è·å–StackedCardPreviewä¸“ç”¨çš„å¡ç‰‡æ•°æ®
     * æ™ºèƒ½å¤„ç†baidué¦–é¡µï¼šä¼˜å…ˆæ˜¾ç¤ºç”¨æˆ·ä¸»åŠ¨åˆ›å»ºçš„å†…å®¹
     */
    private fun getStackedCardPreviewCards(): List<GestureCardWebViewManager.WebViewCardData> {
        try {
            // è·å–å½“å‰ç»„çš„æ ‡ç­¾é¡µï¼ˆåªæ˜¾ç¤ºå½“å‰ç»„çš„æ ‡ç­¾é¡µï¼Œä¸æ··æ·†å…¶ä»–ç»„ï¼‰
            val paperStackTabs = paperStackWebViewManager?.getAllTabs() ?: emptyList()
            val gestureCards = gestureCardWebViewManager?.getAllCards() ?: emptyList()
            val mobileCards = mobileCardManager?.getAllCards() ?: emptyList()
            val allCards = mutableListOf<GestureCardWebViewManager.WebViewCardData>()
            
            // è·å–å½“å‰ç»„IDï¼Œç”¨äºæ—¥å¿—
            val currentGroupId = paperStackWebViewManager?.getCurrentGroupId()
            Log.d(TAG, "=== StackedCardPreviewè·å–å¡ç‰‡æ•°æ® - å½“å‰ç»„ID: $currentGroupId ===")

            Log.d(TAG, "=== StackedCardPreviewä¸“ç”¨å¡ç‰‡æ•°æ®è·å–å¼€å§‹ ===")

            // å…ˆæ·»åŠ æ‰‹åŠ¿å¡ç‰‡ï¼ˆç”¨æˆ·ä¸»åŠ¨åˆ›å»ºçš„ï¼‰
            allCards.addAll(gestureCards)
            Log.d(TAG, "æ·»åŠ æ‰‹åŠ¿å¡ç‰‡åæ€»æ•°: ${allCards.size}")

            // å†æ·»åŠ æ‰‹æœºå¡ç‰‡ï¼Œé¿å…é‡å¤
            var duplicateCount = 0
            mobileCards.forEach { mobileCard ->
                val isDuplicate = allCards.any { existingCard ->
                    existingCard.id == mobileCard.id ||
                    (existingCard.url == mobileCard.url && existingCard.url?.isNotEmpty() == true)
                }
                if (!isDuplicate) {
                    allCards.add(mobileCard)
                    Log.d(TAG, "æ·»åŠ æ‰‹æœºå¡ç‰‡: ${mobileCard.title} - ${mobileCard.url}")
                } else {
                    duplicateCount++
                    Log.d(TAG, "è·³è¿‡é‡å¤å¡ç‰‡: ${mobileCard.title} - ${mobileCard.url}")
                }
            }

            // æ™ºèƒ½å¤„ç†çº¸å †æ ‡ç­¾é¡µæ•°æ®
            val hasUserContent = gestureCards.isNotEmpty() || mobileCards.isNotEmpty()
            val hasNonBaiduTabs = paperStackTabs.any { tab -> 
                tab.url != "https://www.baidu.com" || tab.title != "ç™¾åº¦"
            }
            
            paperStackTabs.forEach { tab ->
                // æ£€æŸ¥æ˜¯å¦æ˜¯baidué¦–é¡µ
                val isBaiduHome = tab.url == "https://www.baidu.com" && tab.title == "ç™¾åº¦"
                
                // ğŸ”§ ä¿®å¤ï¼šæ£€æŸ¥æ˜¯å¦æ˜¯åŠŸèƒ½ä¸»é¡µï¼ˆé»˜è®¤ä¸»é¡µï¼‰ï¼ŒåŠŸèƒ½ä¸»é¡µå¿…é¡»æ˜¾ç¤º
                val isFunctionalHome = tab.url == "home://functional" || 
                                      tab.url == "file:///android_asset/functional_home.html" ||
                                      (tab.url?.startsWith("home://") == true)
                
                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒçš„å¡ç‰‡
                val isDuplicate = allCards.any { existingCard ->
                    existingCard.url == tab.url && existingCard.url?.isNotEmpty() == true
                }
                
                // StackedCardPreviewçš„æ™ºèƒ½å†³ç­–ï¼š
                // 1. åŠŸèƒ½ä¸»é¡µï¼ˆé»˜è®¤ä¸»é¡µï¼‰å¿…é¡»æ˜¾ç¤ºï¼Œä¸å—å…¶ä»–æ¡ä»¶å½±å“
                // 2. å¦‚æœæœ‰ç”¨æˆ·ä¸»åŠ¨åˆ›å»ºçš„å†…å®¹ï¼Œä¼˜å…ˆæ˜¾ç¤ºç”¨æˆ·å†…å®¹
                // 3. å¦‚æœæœ‰ébaiduçš„æ ‡ç­¾é¡µï¼Œä¼˜å…ˆæ˜¾ç¤ºébaiduå†…å®¹
                // 4. åªæœ‰åœ¨æ²¡æœ‰ä»»ä½•å…¶ä»–å†…å®¹æ—¶æ‰æ˜¾ç¤ºbaidué¦–é¡µ
                val shouldInclude = when {
                    isFunctionalHome -> true // ğŸ”§ ä¿®å¤ï¼šåŠŸèƒ½ä¸»é¡µå¿…é¡»æ˜¾ç¤º
                    isBaiduHome -> !hasUserContent && !hasNonBaiduTabs
                    else -> !isDuplicate
                }
                
                if (shouldInclude) {
                    val paperStackCard = GestureCardWebViewManager.WebViewCardData(
                        id = tab.id,
                        title = tab.title,
                        url = tab.url,
                        webView = tab.webView,
                        screenshot = tab.screenshot // ğŸ”§ ä¿®å¤4ï¼šä¼ é€’ä¿å­˜çš„æˆªå›¾
                    )
                    allCards.add(paperStackCard)
                    Log.d(TAG, "æ·»åŠ çº¸å †æ ‡ç­¾é¡µ: ${tab.title} - ${tab.url}, æˆªå›¾: ${if (tab.screenshot != null) "æœ‰" else "æ— "}")
                } else {
                    duplicateCount++
                    if (isBaiduHome) {
                        Log.d(TAG, "StackedCardPreviewæ’é™¤baidué¦–é¡µï¼ˆä¼˜å…ˆæ˜¾ç¤ºç”¨æˆ·å†…å®¹ï¼‰: ${tab.title} - ${tab.url}")
                    } else {
                        Log.d(TAG, "è·³è¿‡é‡å¤çº¸å †æ ‡ç­¾é¡µ: ${tab.title} - ${tab.url}")
                    }
                }
            }

            Log.d(TAG, "StackedCardPreviewä¸“ç”¨å¡ç‰‡æ•°æ® - æ‰‹åŠ¿å¡ç‰‡: ${gestureCards.size}, æ‰‹æœºå¡ç‰‡: ${mobileCards.size}, çº¸å †æ ‡ç­¾é¡µ: ${paperStackTabs.size}, é‡å¤: $duplicateCount, å»é‡åæ€»è®¡: ${allCards.size}")
            
            // ğŸ”§ ä¿®å¤4ï¼šç¡®ä¿é»˜è®¤é¦–é¡µï¼ˆåŠŸèƒ½ä¸»é¡µï¼‰åœ¨æœ€å·¦è¾¹ï¼ˆç¬¬ä¸€ä¸ªä½ç½®ï¼‰
            val functionalHomeUrl = "home://functional"
            val functionalHomeIndex = allCards.indexOfFirst { it.url == functionalHomeUrl }
            
            if (functionalHomeIndex > 0) {
                // å¦‚æœåŠŸèƒ½ä¸»é¡µä¸åœ¨ç¬¬ä¸€ä¸ªä½ç½®ï¼Œå°†å…¶ç§»åˆ°æœ€å‰é¢
                val functionalHomeCard = allCards.removeAt(functionalHomeIndex)
                allCards.add(0, functionalHomeCard)
                Log.d(TAG, "ğŸ”§ ä¿®å¤4ï¼šå·²å°†é»˜è®¤é¦–é¡µç§»åˆ°æœ€å·¦è¾¹ï¼ˆä½ç½®0ï¼‰")
            } else if (functionalHomeIndex == -1) {
                // å¦‚æœæ²¡æœ‰åŠŸèƒ½ä¸»é¡µï¼Œæ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–é¦–é¡µç±»å‹çš„å¡ç‰‡
                val homeCardIndex = allCards.indexOfFirst { 
                    it.url == "home://functional" || 
                    it.url?.contains("home://") == true ||
                    (it.url == "https://www.baidu.com" && it.title == "ç™¾åº¦")
                }
                
                if (homeCardIndex > 0) {
                    val homeCard = allCards.removeAt(homeCardIndex)
                    allCards.add(0, homeCard)
                    Log.d(TAG, "ğŸ”§ ä¿®å¤4ï¼šå·²å°†é¦–é¡µç±»å‹å¡ç‰‡ç§»åˆ°æœ€å·¦è¾¹ï¼ˆä½ç½®0ï¼‰")
                }
            }
            
            Log.d(TAG, "=== StackedCardPreviewä¸“ç”¨å¡ç‰‡æ•°æ®è·å–ç»“æŸ ===")

            return allCards
        } catch (e: Exception) {
            Log.e(TAG, "è·å–StackedCardPreviewä¸“ç”¨å¡ç‰‡æ•°æ®å¼‚å¸¸", e)
            return emptyList()
        }
    }

    /**
     * æ˜¾ç¤ºEnhancedTabManagerèœå•
     */
    private fun showEnhancedTabManagerMenu() {
        try {
            Log.d(TAG, "æ˜¾ç¤ºEnhancedTabManagerèœå•")
            
            // åˆ›å»ºèœå•é€‰é¡¹
            val menuItems = mutableListOf<String>()
            val menuActions = mutableListOf<() -> Unit>()
            
            // æ·»åŠ æ ‡ç­¾é¡µç®¡ç†é€‰é¡¹
            val tabCount = paperStackWebViewManager?.getTabCount() ?: 0
            val currentTab = paperStackWebViewManager?.getCurrentTab()
            
            if (tabCount > 0) {
                // å…³é—­å½“å‰æ ‡ç­¾é¡µ
                menuItems.add("å…³é—­å½“å‰æ ‡ç­¾é¡µ")
                menuActions.add {
                    currentTab?.let { tab ->
                        paperStackWebViewManager?.removeTab(tab.id)
                        // âš¡ ç«‹å³æ›´æ–°é¡µé¢æ•°é‡æ˜¾ç¤º
                        handler.post {
                            updatePageCountDisplay()
                        }
                        Toast.makeText(this, "å·²å…³é—­æ ‡ç­¾é¡µ: ${tab.title}", Toast.LENGTH_SHORT).show()
                    }
                }
                
                // å…³é—­æ‰€æœ‰æ ‡ç­¾é¡µ
                menuItems.add("å…³é—­æ‰€æœ‰æ ‡ç­¾é¡µ")
                menuActions.add {
                    paperStackWebViewManager?.cleanup()
                    Toast.makeText(this, "å·²å…³é—­æ‰€æœ‰æ ‡ç­¾é¡µ", Toast.LENGTH_SHORT).show()
                }
                
                // æŸ¥çœ‹æ‰€æœ‰æ ‡ç­¾é¡µé¢„è§ˆ
                menuItems.add("æŸ¥çœ‹æ‰€æœ‰æ ‡ç­¾é¡µ")
                menuActions.add {
                    activateStackedCardPreview()
                }
                
                // æ ‡ç­¾é¡µç®¡ç†
                menuItems.add("æ ‡ç­¾é¡µç®¡ç†")
                menuActions.add {
                    showTabManagementDialog()
                }
            }
            
            // æ·»åŠ æ–°å»ºæ ‡ç­¾é¡µé€‰é¡¹
            menuItems.add("æ–°å»ºæ ‡ç­¾é¡µ")
            menuActions.add {
                val defaultUrl = "about:blank"
                val defaultTitle = "ä¸»é¡µ"
                paperStackWebViewManager?.addTab(defaultUrl, defaultTitle)
                // âš¡ ç«‹å³æ›´æ–°é¡µé¢æ•°é‡æ˜¾ç¤º
                handler.post {
                    updatePageCountDisplay()
                }
                Toast.makeText(this, "å·²åˆ›å»ºæ–°æ ‡ç­¾é¡µ", Toast.LENGTH_SHORT).show()
            }
            
            // æ·»åŠ æœç´¢é€‰é¡¹
            menuItems.add("æœç´¢")
            menuActions.add {
                browserSearchInput.requestFocus()
                // æ˜¾ç¤ºè½¯é”®ç›˜
                val imm = getSystemService(Context.INPUT_METHOD_SERVICE) as android.view.inputmethod.InputMethodManager
                imm.showSoftInput(browserSearchInput, android.view.inputmethod.InputMethodManager.SHOW_IMPLICIT)
            }
            
            // æ·»åŠ ä¸‹è½½ç®¡ç†é€‰é¡¹
            menuItems.add("ä¸‹è½½ç®¡ç†")
            menuActions.add {
                try {
                    val intent = Intent(this, DownloadManagerActivity::class.java)
                    startActivity(intent)
                } catch (e: Exception) {
                    Log.e(TAG, "æ‰“å¼€ä¸‹è½½ç®¡ç†å¤±è´¥", e)
                    Toast.makeText(this, "æ‰“å¼€ä¸‹è½½ç®¡ç†å¤±è´¥", Toast.LENGTH_SHORT).show()
                }
            }
            
            // æ·»åŠ è®¾ç½®é€‰é¡¹
            menuItems.add("è®¾ç½®")
            menuActions.add {
                val intent = Intent(this, SettingsActivity::class.java)
                startActivity(intent)
            }
            
            // æ·»åŠ å¸®åŠ©é€‰é¡¹
            menuItems.add("å¸®åŠ©")
            menuActions.add {
                showPaperStackHelpDialog()
            }
            
            // æ˜¾ç¤ºèœå•
            val builder = AlertDialog.Builder(this)
            builder.setTitle("çº¸å †æ¨¡å¼ - EnhancedTabManager")
            builder.setItems(menuItems.toTypedArray()) { _, which ->
                if (which < menuActions.size) {
                    menuActions[which]()
                }
            }
            builder.setNegativeButton("å–æ¶ˆ", null)
            builder.show()
            
        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºEnhancedTabManagerèœå•å¤±è´¥", e)
            Toast.makeText(this, "èœå•æ˜¾ç¤ºå¤±è´¥: ${e.message}", Toast.LENGTH_SHORT).show()
        }
    }
    
    /**
     * æ˜¾ç¤ºæ ‡ç­¾é¡µç®¡ç†å¯¹è¯æ¡†
     */
    private fun showTabManagementDialog() {
        try {
            val tabs = paperStackWebViewManager?.getAllTabs() ?: emptyList()
            if (tabs.isEmpty()) {
                Toast.makeText(this, "æ²¡æœ‰æ ‡ç­¾é¡µå¯ä»¥ç®¡ç†", Toast.LENGTH_SHORT).show()
                return
            }
            
            val tabTitles = tabs.mapIndexed { index, tab ->
                "${index + 1}. ${tab.title}"
            }.toTypedArray()
            
            val builder = AlertDialog.Builder(this)
            builder.setTitle("æ ‡ç­¾é¡µç®¡ç† (${tabs.size}ä¸ª)")
            builder.setItems(tabTitles) { _, which ->
                if (which < tabs.size) {
                    val selectedTab = tabs[which]
                    showTabActionDialog(selectedTab)
                }
            }
            builder.setNegativeButton("å–æ¶ˆ", null)
            builder.show()
            
        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºæ ‡ç­¾é¡µç®¡ç†å¯¹è¯æ¡†å¤±è´¥", e)
            Toast.makeText(this, "æ ‡ç­¾é¡µç®¡ç†å¤±è´¥", Toast.LENGTH_SHORT).show()
        }
    }
    
    /**
     * æ˜¾ç¤ºæ ‡ç­¾é¡µæ“ä½œå¯¹è¯æ¡†
     */
    private fun showTabActionDialog(tab: com.example.aifloatingball.webview.PaperStackWebViewManager.WebViewTab) {
        try {
            val actions = arrayOf("åˆ‡æ¢åˆ°è¯¥æ ‡ç­¾é¡µ", "å…³é—­è¯¥æ ‡ç­¾é¡µ", "å¤åˆ¶é“¾æ¥", "åˆ†äº«é¡µé¢")
            
            val builder = AlertDialog.Builder(this)
            builder.setTitle("æ“ä½œ: ${tab.title}")
            builder.setItems(actions) { _, which ->
                when (which) {
                    0 -> {
                        // åˆ‡æ¢åˆ°è¯¥æ ‡ç­¾é¡µ
                        val tabIndex = paperStackWebViewManager?.getAllTabs()?.indexOf(tab) ?: -1
                        if (tabIndex >= 0) {
                            paperStackWebViewManager?.switchToTab(tabIndex)
                            Toast.makeText(this, "å·²åˆ‡æ¢åˆ°: ${tab.title}", Toast.LENGTH_SHORT).show()
                        }
                    }
                    1 -> {
                        // å…³é—­è¯¥æ ‡ç­¾é¡µ
                        paperStackWebViewManager?.removeTab(tab.id)
                        // âš¡ ç«‹å³æ›´æ–°é¡µé¢æ•°é‡æ˜¾ç¤º
                        handler.post {
                            updatePageCountDisplay()
                        }
                        Toast.makeText(this, "å·²å…³é—­: ${tab.title}", Toast.LENGTH_SHORT).show()
                    }
                    2 -> {
                        // å¤åˆ¶é“¾æ¥
                        val clipboard = getSystemService(Context.CLIPBOARD_SERVICE) as android.content.ClipboardManager
                        val clip = android.content.ClipData.newPlainText("é“¾æ¥", tab.url)
                        clipboard.setPrimaryClip(clip)
                        Toast.makeText(this, "é“¾æ¥å·²å¤åˆ¶", Toast.LENGTH_SHORT).show()
                    }
                    3 -> {
                        // åˆ†äº«é¡µé¢
                        val shareIntent = Intent(Intent.ACTION_SEND).apply {
                            type = "text/plain"
                            putExtra(Intent.EXTRA_SUBJECT, tab.title)
                            putExtra(Intent.EXTRA_TEXT, "${tab.title}\n${tab.url}")
                        }
                        val chooser = Intent.createChooser(shareIntent, "åˆ†äº«é¡µé¢")
                        startActivity(chooser)
                    }
                }
            }
            builder.setNegativeButton("å–æ¶ˆ", null)
            builder.show()
            
        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºæ ‡ç­¾é¡µæ“ä½œå¯¹è¯æ¡†å¤±è´¥", e)
            Toast.makeText(this, "æ“ä½œå¤±è´¥", Toast.LENGTH_SHORT).show()
        }
    }
    
    /**
     * æ˜¾ç¤ºçº¸å †æ¨¡å¼å¸®åŠ©å¯¹è¯æ¡†
     */
    private fun showPaperStackHelpDialog() {
        try {
            val helpText = """
                çº¸å †æ¨¡å¼ä½¿ç”¨è¯´æ˜ï¼š
                
                â€¢ å·¦å³æ»‘åŠ¨ï¼šåˆ‡æ¢æ ‡ç­¾é¡µ
                â€¢ ä¸Šä¸‹æ»‘åŠ¨ï¼šæ»šåŠ¨é¡µé¢å†…å®¹
                â€¢ ç‚¹å‡»èœå•ï¼šæ‰“å¼€EnhancedTabManager
                â€¢ é•¿æŒ‰èœå•ï¼šæ›´å¤šé€‰é¡¹
                
                åŠŸèƒ½ç‰¹ç‚¹ï¼š
                â€¢ å¤šæ ‡ç­¾é¡µåŒæ—¶æµè§ˆ
                â€¢ æ ‡ç­¾é¡µé¢„è§ˆå’Œç®¡ç†
                â€¢ å¿«é€Ÿæœç´¢å’Œå¯¼èˆª
                â€¢ æ™ºèƒ½æ ‡ç­¾é¡µåˆ‡æ¢
                
                æç¤ºï¼šåœ¨çº¸å †æ¨¡å¼ä¸‹ï¼Œæ‚¨å¯ä»¥åŒæ—¶æŸ¥çœ‹å¤šä¸ªç½‘é¡µï¼Œå°±åƒç¿»ä¹¦ä¸€æ ·åˆ‡æ¢é¡µé¢ã€‚
            """.trimIndent()
            
            val builder = AlertDialog.Builder(this)
            builder.setTitle("çº¸å †æ¨¡å¼å¸®åŠ©")
            builder.setMessage(helpText)
            builder.setPositiveButton("çŸ¥é“äº†", null)
            builder.show()
            
        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºå¸®åŠ©å¯¹è¯æ¡†å¤±è´¥", e)
            Toast.makeText(this, "å¸®åŠ©æ˜¾ç¤ºå¤±è´¥", Toast.LENGTH_SHORT).show()
        }
    }

    /**
     * é‡ç½®æ¢å¤å¯¹è¯æ¡†æ£€æŸ¥çŠ¶æ€
     * å½“ç”¨æˆ·åˆ‡æ¢åˆ°å…¶ä»–tabæ—¶è°ƒç”¨ï¼Œå…è®¸ä¸‹æ¬¡è¿›å…¥æœç´¢tabæ—¶é‡æ–°æ£€æŸ¥æ¢å¤å¯¹è¯æ¡†
     */
    private fun resetRestoreDialogState() {
        Log.d(TAG, "é‡ç½®æ¢å¤å¯¹è¯æ¡†æ£€æŸ¥çŠ¶æ€")
        // é‡ç½®æ—¶é—´æˆ³ï¼Œå…è®¸ä¸‹æ¬¡æ£€æŸ¥
        lastRestoreCheckTime = 0L
        // æ³¨æ„ï¼šä¸é‡ç½®hasShownRestoreDialogï¼Œé¿å…åŒä¸€ä¼šè¯ä¸­é‡å¤å¼¹å‡ºç›¸åŒçš„æ¢å¤å¯¹è¯æ¡†
    }

    /**
     * åŒæ­¥æ›´æ–°æ‰€æœ‰å¡ç‰‡ç³»ç»Ÿçš„æ•°æ®
     */
    private fun syncAllCardSystems() {
        try {
            // æ›´æ–°å¡ç‰‡é¢„è§ˆå™¨æ•°æ®
            updateWaveTrackerCards()

            // å¦‚æœå¡ç‰‡é¢„è§ˆè¦†ç›–å±‚æ­£åœ¨æ˜¾ç¤ºï¼Œä¹Ÿæ›´æ–°å®ƒ
            if (::cardPreviewOverlay.isInitialized && cardPreviewOverlay.visibility == View.VISIBLE) {
                val allCards = getAllUnifiedCards()
                if (allCards.isNotEmpty()) {
                    cardPreviewOverlay.show(allCards)
                } else {
                    cardPreviewOverlay.hide()
                }
            }

            Log.d(TAG, "æ‰€æœ‰å¡ç‰‡ç³»ç»Ÿæ•°æ®å·²åŒæ­¥")
        } catch (e: Exception) {
            Log.e(TAG, "åŒæ­¥å¡ç‰‡ç³»ç»Ÿæ•°æ®å¤±è´¥", e)
        }
    }

    /**
     * åˆå§‹åŒ–éœ‡åŠ¨ç®¡ç†å™¨
     */
    private fun initializeVibrator() {
        try {
            vibrator = if (android.os.Build.VERSION.SDK_INT >= android.os.Build.VERSION_CODES.S) {
                val vibratorManager = getSystemService(Context.VIBRATOR_MANAGER_SERVICE) as android.os.VibratorManager
                vibratorManager.defaultVibrator
            } else {
                @Suppress("DEPRECATION")
                getSystemService(Context.VIBRATOR_SERVICE) as android.os.Vibrator
            }
            Log.d(TAG, "éœ‡åŠ¨ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ")
        } catch (e: Exception) {
            Log.e(TAG, "åˆå§‹åŒ–éœ‡åŠ¨ç®¡ç†å™¨å¤±è´¥", e)
            vibrator = null
        }
    }

    /**
     * æ‰§è¡Œæ‰‹åŠ¿éœ‡åŠ¨åé¦ˆ
     * @param type éœ‡åŠ¨ç±»å‹ï¼šlight(è½»å¾®), medium(ä¸­ç­‰), heavy(é‡)
     */
    private fun performGestureVibration(type: String) {
        try {
            vibrator?.let { vib ->
                if (android.os.Build.VERSION.SDK_INT >= android.os.Build.VERSION_CODES.O) {
                    val effect = when (type) {
                        "light" -> android.os.VibrationEffect.createOneShot(50, android.os.VibrationEffect.DEFAULT_AMPLITUDE)
                        "medium" -> android.os.VibrationEffect.createOneShot(100, 128)
                        "heavy" -> android.os.VibrationEffect.createOneShot(150, 255)
                        "double" -> android.os.VibrationEffect.createWaveform(longArrayOf(0, 80, 50, 80), -1)
                        "swipe" -> android.os.VibrationEffect.createWaveform(longArrayOf(0, 30, 20, 30, 20, 30), -1)
                        else -> android.os.VibrationEffect.createOneShot(50, android.os.VibrationEffect.DEFAULT_AMPLITUDE)
                    }
                    vib.vibrate(effect)
                } else {
                    @Suppress("DEPRECATION")
                    when (type) {
                        "light" -> vib.vibrate(50)
                        "medium" -> vib.vibrate(100)
                        "heavy" -> vib.vibrate(150)
                        "double" -> vib.vibrate(longArrayOf(0, 80, 50, 80), -1)
                        "swipe" -> vib.vibrate(longArrayOf(0, 30, 20, 30, 20, 30), -1)
                        else -> vib.vibrate(50)
                    }
                }
                Log.d(TAG, "æ‰§è¡Œ${type}éœ‡åŠ¨åé¦ˆ")
            }
        } catch (e: Exception) {
            Log.e(TAG, "æ‰§è¡Œéœ‡åŠ¨åé¦ˆå¤±è´¥", e)
        }
    }
    
    /**
     * æ‰§è¡ŒæŒ‰é’®é€‰æ‹©çš„è½»éœ‡åŠ¨åé¦ˆ
     * å½“ç”¨æˆ·ä¸‹æ‹‰æ‰‹åŠ¿çš„å…‰æ ‡èƒ½å¤Ÿæ¿€æ´»å¯¹åº”é€‰é¡¹æ—¶ï¼Œè½»éœ‡åŠ¨æé†’
     */
    private fun performHapticFeedbackForButtonSelection() {
        try {
            // ä½¿ç”¨è½»éœ‡åŠ¨åé¦ˆï¼ŒæŒç»­æ—¶é—´çŸ­ï¼Œå¼ºåº¦é€‚ä¸­
            performGestureVibration("light")
            Log.d(TAG, "æŒ‰é’®é€‰æ‹©éœ‡åŠ¨åé¦ˆå·²è§¦å‘")
        } catch (e: Exception) {
            Log.e(TAG, "æ‰§è¡ŒæŒ‰é’®é€‰æ‹©éœ‡åŠ¨åé¦ˆå¤±è´¥", e)
        }
    }

    /**
     * æ£€æŸ¥æ˜¯å¦ä¸ºå¹¿å‘Šæˆ–æ¶æ„URL - å¢å¼ºç‰ˆ
     */
    private fun isAdOrMaliciousUrl(url: String): Boolean {
        val adKeywords = listOf(
            // é€šç”¨å¹¿å‘Š
            "googleads", "googlesyndication", "doubleclick", "adsystem",
            "amazon-adsystem", "facebook.com/tr", "google-analytics",

            // ä¸­æ–‡å¹¿å‘Šå¹³å°
            "baidu.com/cpro", "pos.baidu.com", "cbjs.baidu.com",
            "union.360.cn", "tanx.com", "alimama.com", "taobao.com/go/act",
            "irs01.com", "irs03.com", "mediav.com", "adnxs.com",

            // ä¸‹è½½å’Œå®‰è£…ç›¸å…³
            "download", "install", "apk", "exe", "setup", "installer",

            // å¼¹çª—å’Œå¹¿å‘Š
            "popup", "alert", "confirm", "prompt", "modal", "overlay",
            "advertisement", "banner", "sponsor",

            // å€’è®¡æ—¶å¹¿å‘Š
            "countdown", "timer", "seconds", "è·³è¿‡å¹¿å‘Š", "å¹¿å‘Šå€’è®¡æ—¶",
            "skip-ad", "ad-skip", "ad-countdown", "ad-timer",

            // æ–°é—»ç½‘ç«™å¸¸è§å¹¿å‘Š
            "sohu.com/a/", "163.com/dy/", "sina.com.cn/zt/",
            "qq.com/rain/", "people.com.cn/GB/",

            // è§†é¢‘å¹¿å‘Š
            "video-ad", "pre-roll", "mid-roll", "post-roll",
            "youku.com/show_page/", "iqiyi.com/adv/",

            // åº”ç”¨å•†åº—è·³è½¬
            "itunes.apple.com", "play.google.com/store",
            "app-download", "app-install"
        )

        val lowerUrl = url.lowercase()
        return adKeywords.any { keyword -> lowerUrl.contains(keyword) }
    }

    /**
     * æ³¨å…¥å¹¿å‘Šæ‹¦æˆªJavaScript - å¢å¼ºç‰ˆ
     */
    private fun injectAdBlockingScript(webView: WebView?) {
        val adBlockScript = """
            javascript:(function() {
                // ç§»é™¤å¸¸è§å¹¿å‘Šå…ƒç´  - æ‰©å±•é€‰æ‹©å™¨
                var adSelectors = [
                    // é€šç”¨å¹¿å‘Šé€‰æ‹©å™¨
                    '[id*="ad"]', '[class*="ad"]', '[id*="banner"]', '[class*="banner"]',
                    '[id*="popup"]', '[class*="popup"]', '[id*="modal"]', '[class*="modal"]',
                    '.advertisement', '.ads', '.ad-container', '.banner-ad',
                    'iframe[src*="ads"]', 'iframe[src*="doubleclick"]',

                    // å€’è®¡æ—¶å¹¿å‘Šé€‰æ‹©å™¨
                    '[id*="countdown"]', '[class*="countdown"]', '[id*="timer"]', '[class*="timer"]',
                    '[id*="skip"]', '[class*="skip"]', '.ad-skip', '.skip-ad',
                    '.countdown-ad', '.ad-countdown', '.timer-ad', '.ad-timer',

                    // ä¸­æ–‡å¹¿å‘Šé€‰æ‹©å™¨
                    '[class*="å¹¿å‘Š"]', '[id*="å¹¿å‘Š"]', '[class*="æ¨å¹¿"]', '[id*="æ¨å¹¿"]',
                    '.ad-wrap', '.ad-box', '.ad-content', '.sponsor', '.promotion',

                    // æ–°é—»ç½‘ç«™ç‰¹å®šå¹¿å‘Š
                    '.sohu-ad', '.sina-ad', '.netease-ad', '.qq-ad', '.tencent-ad',
                    '.news-ad', '.article-ad', '.content-ad',

                    // è§†é¢‘å¹¿å‘Š
                    '.video-ad', '.player-ad', '.pre-roll', '.mid-roll', '.post-roll',

                    // ä¸‹è½½æç¤º
                    '.download-tip', '.app-download', '.install-app', '.download-app',

                    // å¼¹çª—é®ç½©
                    '.mask', '.overlay', '.dialog-mask', '.popup-mask'
                ];

                // ç§»é™¤å¹¿å‘Šå…ƒç´ 
                adSelectors.forEach(function(selector) {
                    try {
                        var elements = document.querySelectorAll(selector);
                        elements.forEach(function(el) {
                            if (el && el.parentNode) {
                                el.style.display = 'none';
                                el.parentNode.removeChild(el);
                            }
                        });
                    } catch(e) {}
                });

                // é˜»æ­¢å¼¹çª—å‡½æ•°
                window.alert = function() { return false; };
                window.confirm = function() { return false; };
                window.prompt = function() { return null; };

                // é˜»æ­¢é¡µé¢è·³è½¬åˆ°åº”ç”¨å•†åº—
                var originalOpen = window.open;
                window.open = function(url, name, specs) {
                    if (url && (url.includes('itunes.apple.com') ||
                               url.includes('play.google.com') ||
                               url.includes('app-download') ||
                               url.includes('download'))) {
                        return null;
                    }
                    return originalOpen.call(this, url, name, specs);
                };

                // ç§»é™¤åŒ…å«ç‰¹å®šæ–‡æœ¬çš„å…ƒç´ 
                var textPatterns = ['è·³è¿‡å¹¿å‘Š', 'å¹¿å‘Š', 'ä¸‹è½½APP', 'ç«‹å³ä¸‹è½½', 'å®‰è£…åº”ç”¨', 'Skip Ad'];
                textPatterns.forEach(function(pattern) {
                    var walker = document.createTreeWalker(
                        document.body,
                        NodeFilter.SHOW_TEXT,
                        null,
                        false
                    );
                    var textNodes = [];
                    var node;
                    while (node = walker.nextNode()) {
                        if (node.textContent.includes(pattern)) {
                            textNodes.push(node);
                        }
                    }
                    textNodes.forEach(function(textNode) {
                        var element = textNode.parentElement;
                        if (element && element.tagName !== 'SCRIPT') {
                            element.style.display = 'none';
                        }
                    });
                });

                // å®šæœŸæ¸…ç†åŠ¨æ€åŠ è½½çš„å¹¿å‘Š
                setInterval(function() {
                    adSelectors.forEach(function(selector) {
                        try {
                            var elements = document.querySelectorAll(selector);
                            elements.forEach(function(el) {
                                if (el && el.style.display !== 'none') {
                                    el.style.display = 'none';
                                }
                            });
                        } catch(e) {}
                    });
                }, 2000);

            })();
        """

        try {
            webView?.evaluateJavascript(adBlockScript, null)
            Log.d(TAG, "å¹¿å‘Šæ‹¦æˆªè„šæœ¬æ³¨å…¥æˆåŠŸ")
        } catch (e: Exception) {
            Log.w(TAG, "æ³¨å…¥å¹¿å‘Šæ‹¦æˆªè„šæœ¬å¤±è´¥: ${e.message}")
        }
    }

    /**
     * æ‰§è¡Œåˆ›å»ºæ–°å¡ç‰‡æ“ä½œ
     */
    private fun performCreateNewCard() {
        try {
            Log.d(TAG, "æ˜¾ç¤ºæ–°å»ºå¡ç‰‡é€‰æ‹©å¼¹çª—")

            // å…ˆéšè—æ‰€æœ‰è¦†ç›–å±‚
            hideAllOverlays()
            clearAllOverlays()

            // æ˜¾ç¤ºæ–°å»ºå¡ç‰‡é€‰æ‹©å¼¹çª—
            showNewCardSelectionDialog()

        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºæ–°å»ºå¡ç‰‡å¼¹çª—æ—¶å‘ç”Ÿé”™è¯¯", e)
            Toast.makeText(this, "æ˜¾ç¤ºæ–°å»ºå¡ç‰‡å¼¹çª—æ—¶å‘ç”Ÿé”™è¯¯: ${e.message}", Toast.LENGTH_SHORT).show()
        }
    }

    /**
     * è·å–é¦–é¡µæŒ‰é’®æ˜¾ç¤ºçŠ¶æ€
     */
    private fun getHomeButtonVisibility(): Map<String, Boolean> {
        val visibility = mutableMapOf<String, Boolean>()
        val buttonIds = listOf("new_tab", "new_group", "history", "bookmarks", "download")
        
        // æ£€æŸ¥æ˜¯å¦å·²ç»åˆå§‹åŒ–è¿‡æŒ‰é’®é…ç½®
        val isInitialized = settingsManager.getBoolean("home_buttons_initialized", false)
        
        buttonIds.forEach { buttonId ->
            val key = "home_button_${buttonId}_visible"
            // ä¼˜å…ˆä»SettingsManagerè¯»å–ï¼ˆè¿™æ˜¯DraggableButtonGridä¿å­˜çš„ï¼‰
            if (settingsManager.getSharedPreferences().contains(key)) {
                visibility[buttonId] = settingsManager.getBoolean(key, false)
            } else {
                // å¦‚æœSettingsManagerä¸­æ²¡æœ‰ï¼Œå°è¯•ä»DraggableButtonGridçš„SharedPreferencesè¯»å–
                val prefs = getSharedPreferences("draggable_button_grid", Context.MODE_PRIVATE)
                val visibleButtonsJson = prefs.getString("visible_buttons", null)
                if (visibleButtonsJson != null) {
                    try {
                        val visibleButtons = com.google.gson.Gson().fromJson<List<String>>(
                            visibleButtonsJson,
                            object : com.google.gson.reflect.TypeToken<List<String>>() {}.type
                        )
                        // æ£€æŸ¥æŒ‰é’®IDæ˜¯å¦åœ¨å¯è§åˆ—è¡¨ä¸­
                        val buttonIdInPrefs = when (buttonId) {
                            "new_tab" -> "new_tab"
                            "new_group" -> "new_group"
                            "history" -> "history"
                            "bookmarks" -> "bookmarks"
                            "download" -> "download"
                            else -> buttonId
                        }
                        visibility[buttonId] = visibleButtons.contains(buttonIdInPrefs)
                        // åŒæ­¥åˆ°SettingsManagerï¼Œç¡®ä¿ä¸‹æ¬¡ç›´æ¥è¯»å–
                        settingsManager.putBoolean(key, visibility[buttonId] ?: false)
                    } catch (e: Exception) {
                        Log.e(TAG, "è§£ææŒ‰é’®å¯è§æ€§å¤±è´¥", e)
                        // è§£æå¤±è´¥ï¼Œé»˜è®¤ä¸æ˜¾ç¤º
                        visibility[buttonId] = false
                    }
                } else {
                    // å¦‚æœDraggableButtonGridçš„é…ç½®ä¹Ÿä¸å­˜åœ¨ï¼Œæ ¹æ®æ˜¯å¦åˆå§‹åŒ–å†³å®šé»˜è®¤å€¼
                    if (isInitialized) {
                        // å·²åˆå§‹åŒ–ä½†é…ç½®ä¸å­˜åœ¨ï¼Œé»˜è®¤ä¸æ˜¾ç¤º
                        visibility[buttonId] = false
                    } else {
                        // é¦–æ¬¡ä½¿ç”¨ï¼Œé»˜è®¤æ˜¾ç¤ºæ‰€æœ‰ä¸»è¦æŒ‰é’®
                        visibility[buttonId] = true
                    }
                }
            }
        }
        
        return visibility
    }
    
    /**
     * ä¿å­˜é¦–é¡µæŒ‰é’®æ˜¾ç¤ºçŠ¶æ€
     */
    private fun saveHomeButtonVisibility(visibility: Map<String, Boolean>) {
        visibility.forEach { (buttonId, isVisible) ->
            val key = "home_button_${buttonId}_visible"
            settingsManager.putBoolean(key, isVisible)
        }
        
        // åˆ·æ–°é¦–é¡µæŒ‰é’®æ˜¾ç¤º
        refreshHomeButtonVisibility()
    }
    
    /**
     * åˆ·æ–°é¦–é¡µæŒ‰é’®æ˜¾ç¤ºçŠ¶æ€
     */
    private fun refreshHomeButtonVisibility() {
        try {
            // æ£€æŸ¥æ‰€æœ‰æ ‡ç­¾é¡µï¼Œæ‰¾åˆ°åŠŸèƒ½ä¸»é¡µå¹¶åˆ·æ–°
            val allTabs = paperStackWebViewManager?.getAllTabs() ?: emptyList()
            allTabs.forEach { tab ->
                if (tab.url == "home://functional") {
                    // å¦‚æœæ˜¯åŠŸèƒ½ä¸»é¡µï¼Œæ‰§è¡ŒJavaScriptåˆ·æ–°æŒ‰é’®æ˜¾ç¤ºå’Œé¡ºåº
                    tab.webView.post {
                        try {
                            tab.webView.evaluateJavascript("updateButtonVisibility();", null)
                            tab.webView.evaluateJavascript("loadButtonOrder();", null)
                            tab.webView.evaluateJavascript("updateButtonLayout();", null)
                            Log.d(TAG, "å·²åˆ·æ–°åŠŸèƒ½ä¸»é¡µæŒ‰é’®æ˜¾ç¤ºçŠ¶æ€")
                        } catch (e: Exception) {
                            Log.e(TAG, "æ‰§è¡ŒJavaScriptåˆ·æ–°å¤±è´¥", e)
                        }
                    }
                }
            }
            // å¦‚æœå½“å‰æ ‡ç­¾é¡µæ˜¯åŠŸèƒ½ä¸»é¡µï¼Œä¹Ÿåˆ·æ–°ä¸€æ¬¡ï¼ˆç¡®ä¿ç«‹å³ç”Ÿæ•ˆï¼‰
            val currentTab = paperStackWebViewManager?.getCurrentTab()
            if (currentTab?.url == "home://functional") {
                currentTab.webView.post {
                    try {
                        currentTab.webView.evaluateJavascript("updateButtonVisibility();", null)
                        currentTab.webView.evaluateJavascript("loadButtonOrder();", null)
                        currentTab.webView.evaluateJavascript("updateButtonLayout();", null)
                        Log.d(TAG, "å·²åˆ·æ–°å½“å‰åŠŸèƒ½ä¸»é¡µæŒ‰é’®æ˜¾ç¤ºçŠ¶æ€")
                    } catch (e: Exception) {
                        Log.e(TAG, "æ‰§è¡ŒJavaScriptåˆ·æ–°å¤±è´¥", e)
                    }
                }
            }
        } catch (e: Exception) {
            Log.e(TAG, "åˆ·æ–°é¦–é¡µæŒ‰é’®æ˜¾ç¤ºçŠ¶æ€å¤±è´¥", e)
        }
    }
    
    /**
     * æ˜¾ç¤ºæ¢å¤æŒ‰é’®å¯¹è¯æ¡†
     */
    private fun showRestoreButtonsDialog() {
        try {
            val visibility = getHomeButtonVisibility()
            
            // æŒ‰é’®é…ç½®
            val buttonConfigs = listOf(
                Pair("new_tab", "æ–°å»ºæ ‡ç­¾é¡µ"),
                Pair("new_group", "æ–°å»ºæ ‡ç­¾ç»„"),
                Pair("history", "å†å²è®°å½•"),
                Pair("bookmarks", "æ”¶è—å¤¹"),
                Pair("download", "ä¸‹è½½")
            )
            
            // ç­›é€‰å‡ºå·²éšè—çš„æŒ‰é’®
            val hiddenButtons = buttonConfigs.filter { (buttonId, _) ->
                !(visibility[buttonId] ?: true)
            }
            
            if (hiddenButtons.isEmpty()) {
                showMaterialToast("æ²¡æœ‰å·²éšè—çš„æŒ‰é’®")
                return
            }
            
            // åˆ›å»ºå¯¹è¯æ¡†è§†å›¾
            val dialogView = LayoutInflater.from(this).inflate(R.layout.dialog_restore_buttons, null)
            val container = dialogView.findViewById<LinearLayout>(R.id.button_list_container)
            
            // æ¸…ç©ºå®¹å™¨
            container?.removeAllViews()
            
            // åˆ›å»ºå¯¹è¯æ¡†
            val dialog = androidx.appcompat.app.AlertDialog.Builder(this)
                .setTitle("æ¢å¤æŒ‰é’®")
                .setView(dialogView)
                .setNegativeButton("å…³é—­", null)
                .create()
            
            // ä¸ºæ¯ä¸ªéšè—çš„æŒ‰é’®åˆ›å»ºæ¢å¤é¡¹
            hiddenButtons.forEach { (buttonId, buttonName) ->
                val itemView = LayoutInflater.from(this).inflate(R.layout.item_restore_button, container, false)
                val textView = itemView.findViewById<TextView>(R.id.text_button_name)
                val restoreButton = itemView.findViewById<MaterialButton>(R.id.btn_restore)
                
                textView?.text = buttonName
                restoreButton?.setOnClickListener {
                    // æ¢å¤æŒ‰é’®æ˜¾ç¤º
                    val key = "home_button_${buttonId}_visible"
                    settingsManager.putBoolean(key, true)
                    refreshHomeButtonVisibility()
                    showMaterialToast("å·²æ¢å¤æŒ‰é’®")
                    // å…³é—­å¯¹è¯æ¡†
                    dialog.dismiss()
                }
                
                container?.addView(itemView)
            }
            
            dialog.show()
        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºæ¢å¤æŒ‰é’®å¯¹è¯æ¡†å¤±è´¥", e)
            showMaterialToast("æ‰“å¼€æ¢å¤æŒ‰é’®å¤±è´¥")
        }
    }
    
    /**
     * æ˜¾ç¤ºå†å²è®°å½•å¯¹è¯æ¡†
     */
    private fun showHistoryDialog() {
        try {
            Log.d(TAG, "å¼€å§‹æ˜¾ç¤ºå†å²è®°å½•å¯¹è¯æ¡†")
            
            // æ£€æŸ¥ActivityçŠ¶æ€
            if (isFinishing || isDestroyed) {
                Log.w(TAG, "Activityæ­£åœ¨ç»“æŸæˆ–å·²é”€æ¯ï¼Œè·³è¿‡æ˜¾ç¤ºå†å²è®°å½•å¯¹è¯æ¡†")
                return
            }
            
            // æ£€æŸ¥FragmentManagerçŠ¶æ€
            if (supportFragmentManager.isStateSaved) {
                Log.w(TAG, "FragmentManagerçŠ¶æ€å·²ä¿å­˜ï¼Œè·³è¿‡æ˜¾ç¤ºå†å²è®°å½•å¯¹è¯æ¡†")
                return
            }
            
            // ä½¿ç”¨NewCardSelectionDialogæ˜¾ç¤ºå†å²è®°å½•ï¼ˆé»˜è®¤æ˜¾ç¤ºå†å²è®°å½•æ ‡ç­¾é¡µï¼‰
            try {
                val dialog = NewCardSelectionDialog(
                    context = this,
                    onHistoryItemSelected = { historyEntry ->
                        // ä»å†å²è®°å½•æ‰“å¼€é¡µé¢
                        createNewCardFromUrl(historyEntry.url, historyEntry.title)
                    },
                    onBookmarkItemSelected = { bookmarkEntry ->
                        // ä»æ”¶è—æ‰“å¼€é¡µé¢
                        createNewCardFromUrl(bookmarkEntry.url, bookmarkEntry.title)
                    },
                    onCreateBlankCard = {
                        // åˆ›å»ºç©ºç™½å¡ç‰‡
                        createNewBlankCard()
                    },
                    onDismiss = {
                        Log.d(TAG, "å†å²è®°å½•å¯¹è¯æ¡†å·²å…³é—­")
                    }
                )
                dialog.show()
                
                // å»¶è¿Ÿåˆ‡æ¢åˆ°å†å²è®°å½•æ ‡ç­¾é¡µ
                dialog.window?.decorView?.post {
                    try {
                        val tabLayout = dialog.findViewById<com.google.android.material.tabs.TabLayout>(R.id.tab_layout)
                        if (tabLayout != null && tabLayout.tabCount > 0) {
                            // åˆ‡æ¢åˆ°å†å²è®°å½•æ ‡ç­¾é¡µï¼ˆç¬¬ä¸€ä¸ªæ ‡ç­¾é¡µé€šå¸¸æ˜¯å†å²è®°å½•ï¼‰
                            tabLayout.getTabAt(0)?.select()
                            Log.d(TAG, "å·²åˆ‡æ¢åˆ°å†å²è®°å½•æ ‡ç­¾é¡µ")
                        }
                    } catch (e: Exception) {
                        Log.e(TAG, "åˆ‡æ¢åˆ°å†å²è®°å½•æ ‡ç­¾é¡µå¤±è´¥", e)
                    }
                }
            } catch (e: Exception) {
                Log.e(TAG, "æ˜¾ç¤ºå†å²è®°å½•å¯¹è¯æ¡†å¤±è´¥", e)
                showMaterialToast("æ‰“å¼€å†å²è®°å½•å¤±è´¥")
            }
        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºå†å²è®°å½•å¯¹è¯æ¡†å¼‚å¸¸", e)
            showMaterialToast("æ‰“å¼€å†å²è®°å½•å¤±è´¥")
        }
    }
    
    private fun showNewCardSelectionDialog() {
        try {
            Log.d(TAG, "å¼€å§‹æ˜¾ç¤ºæ–°å»ºå¡ç‰‡é€‰æ‹©å¼¹çª—")
            
            // æ£€æŸ¥ActivityçŠ¶æ€
            if (isFinishing || isDestroyed) {
                Log.w(TAG, "Activityæ­£åœ¨ç»“æŸæˆ–å·²é”€æ¯ï¼Œè·³è¿‡æ˜¾ç¤ºæ–°å»ºå¡ç‰‡å¼¹çª—ï¼Œç›´æ¥åˆ›å»ºç©ºç™½å¡ç‰‡")
                createNewBlankCard()
                return
            }
            
            // æ£€æŸ¥FragmentManagerçŠ¶æ€
            if (supportFragmentManager.isStateSaved) {
                Log.w(TAG, "FragmentManagerçŠ¶æ€å·²ä¿å­˜ï¼Œè·³è¿‡æ˜¾ç¤ºæ–°å»ºå¡ç‰‡å¼¹çª—ï¼Œç›´æ¥åˆ›å»ºç©ºç™½å¡ç‰‡")
                createNewBlankCard()
                return
            }
            
            // å°è¯•æ˜¾ç¤ºå¤æ‚çš„æ–°å»ºå¡ç‰‡å¼¹çª—
            try {
                NewCardSelectionDialog.show(
                    context = this,
                    fragmentManager = supportFragmentManager,
                    onHistoryItemSelected = { historyEntry ->
                        // ä»å†å²è®°å½•åˆ›å»ºæ–°å¡ç‰‡
                        createNewCardFromUrl(historyEntry.url, historyEntry.title)
                    },
                    onBookmarkItemSelected = { bookmarkEntry ->
                        // ä»æ”¶è—åˆ›å»ºæ–°å¡ç‰‡
                        createNewCardFromUrl(bookmarkEntry.url, bookmarkEntry.title)
                    },
                    onCreateBlankCard = {
                        // åˆ›å»ºç©ºç™½å¡ç‰‡
                        createNewBlankCard()
                    },
                    onDismiss = {
                        Log.d(TAG, "æ–°å»ºå¡ç‰‡å¼¹çª—å·²å…³é—­")
                    }
                )
                
                Log.d(TAG, "æ–°å»ºå¡ç‰‡é€‰æ‹©å¼¹çª—æ˜¾ç¤ºæˆåŠŸ")
            } catch (e: Exception) {
                Log.w(TAG, "å¤æ‚æ–°å»ºå¡ç‰‡å¼¹çª—å¤±è´¥ï¼Œä½¿ç”¨ç®€åŒ–ç‰ˆæœ¬", e)
                // å¦‚æœå¤æ‚å¼¹çª—å¤±è´¥ï¼Œä½¿ç”¨ç®€åŒ–çš„æ–°å»ºå¡ç‰‡å¼¹çª—
                showSimpleNewCardDialog()
            }
            
        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºæ–°å»ºå¡ç‰‡å¼¹çª—å¤±è´¥", e)
            Toast.makeText(this, "æ˜¾ç¤ºæ–°å»ºå¡ç‰‡å¼¹çª—å¤±è´¥: ${e.message}", Toast.LENGTH_SHORT).show()
        }
    }
    
    /**
     * æ˜¾ç¤ºç®€åŒ–çš„æ–°å»ºå¡ç‰‡å¼¹çª—
     */
    private fun showSimpleNewCardDialog() {
        try {
            Log.d(TAG, "æ˜¾ç¤ºç®€åŒ–çš„æ–°å»ºå¡ç‰‡å¼¹çª—")
            
            val options = arrayOf("æ–°å»ºç©ºç™½å¡ç‰‡", "è¾“å…¥ç½‘å€", "å–æ¶ˆ")
            
            val builder = android.app.AlertDialog.Builder(this)
                .setTitle("æ–°å»ºå¡ç‰‡")
                .setItems(options) { _, which ->
                    when (which) {
                        0 -> {
                            // æ–°å»ºç©ºç™½å¡ç‰‡
                            createNewBlankCard()
                        }
                        1 -> {
                            // è¾“å…¥ç½‘å€
                            showUrlInputDialog()
                        }
                        2 -> {
                            // å–æ¶ˆ
                            Log.d(TAG, "ç”¨æˆ·å–æ¶ˆæ–°å»ºå¡ç‰‡")
                        }
                    }
                }
                .setCancelable(true)
            
            builder.show()
            
        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºç®€åŒ–æ–°å»ºå¡ç‰‡å¼¹çª—å¤±è´¥", e)
            Toast.makeText(this, "æ˜¾ç¤ºæ–°å»ºå¡ç‰‡å¼¹çª—å¤±è´¥: ${e.message}", Toast.LENGTH_SHORT).show()
        }
    }
    
    /**
     * æ˜¾ç¤ºç½‘å€è¾“å…¥å¯¹è¯æ¡†
     */
    private fun showUrlInputDialog() {
        try {
            val input = android.widget.EditText(this).apply {
                hint = "è¾“å…¥ç½‘å€æˆ–æœç´¢å†…å®¹"
                setText("https://")
            }
            
            val builder = android.app.AlertDialog.Builder(this)
                .setTitle("è¾“å…¥ç½‘å€")
                .setView(input)
                .setPositiveButton("ç¡®å®š") { _, _ ->
                    val url = input.text.toString().trim()
                    if (url.isNotEmpty()) {
                        createNewCardFromUrl(url, "æ–°é¡µé¢")
                    }
                }
                .setNegativeButton("å–æ¶ˆ", null)
            
            builder.show()
            
        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºç½‘å€è¾“å…¥å¯¹è¯æ¡†å¤±è´¥", e)
            Toast.makeText(this, "è¾“å…¥ç½‘å€å¤±è´¥: ${e.message}", Toast.LENGTH_SHORT).show()
        }
    }

    /**
     * ä»URLåˆ›å»ºæ–°å¡ç‰‡
     */
    private fun createNewCardFromUrl(url: String, title: String) {
        try {
            Log.d(TAG, "ä»URLåˆ›å»ºæ–°å¡ç‰‡: $url, æ ‡é¢˜: $title")

            // å…ˆéšè—æ‰€æœ‰è¦†ç›–å±‚
            hideAllOverlays()
            clearAllOverlays()

            // å¦‚æœæ˜¯ç©ºç™½é¡µé¢ï¼Œæ˜¾ç¤ºä¸»é¡µè€Œä¸æ˜¯åˆ›å»ºWebView
            if (url == "about:blank" || url.isEmpty()) {
                Log.d(TAG, "æ£€æµ‹åˆ°ç©ºç™½URLï¼Œæ˜¾ç¤ºä¸»é¡µ")
                showBrowserHome()
                return
            }

            // ç¡®ä¿PaperStackWebViewManagerå·²åˆå§‹åŒ–
            if (paperStackWebViewManager == null) {
                setupBrowserWebView()
            }

            // ä½¿ç”¨PaperStackWebViewManagerç»Ÿä¸€åˆ›å»ºæ ‡ç­¾é¡µ
            val newTab = paperStackWebViewManager?.addTab(url, title)
            
            if (newTab != null) {
                Log.d(TAG, "æ–°æ ‡ç­¾é¡µåˆ›å»ºæˆåŠŸ: ${newTab.id}, æ ‡é¢˜: ${newTab.title}, URL: ${newTab.url}")

                // âš¡ ç«‹å³æ›´æ–°é¡µé¢æ•°é‡æ˜¾ç¤ºï¼ˆä½¿ç”¨postç¡®ä¿åœ¨ç›‘å¬å™¨ä¹‹åæ‰§è¡Œï¼‰
                handler.post {
                    updatePageCountDisplay()
                }

                // æ£€æŸ¥æ ‡ç­¾é¡µæ€»æ•°
                val tabCount = paperStackWebViewManager?.getTabCount() ?: 0
                Log.d(TAG, "å½“å‰æ ‡ç­¾é¡µæ•°é‡: $tabCount")

                // æ˜¾ç¤ºæˆåŠŸæç¤º
                Toast.makeText(this, "æ–°æ ‡ç­¾é¡µå·²åˆ›å»º: $title", Toast.LENGTH_SHORT).show()

                // éšè—ä¸»é¡µå†…å®¹ï¼Œæ˜¾ç¤ºçº¸å †ç•Œé¢
                browserHomeContent.visibility = View.GONE
                browserTabContainer.visibility = View.GONE

                // åŒæ­¥æ‰€æœ‰å¡ç‰‡ç³»ç»Ÿæ•°æ®
                syncAllCardSystems()

                // ç¡®ä¿UIçŠ¶æ€æ­£ç¡®åˆ‡æ¢
                browserLayout.post {
                    forceRefreshUIState()
                }
            } else {
                Log.e(TAG, "æ–°æ ‡ç­¾é¡µåˆ›å»ºå¤±è´¥")
                Toast.makeText(this, "åˆ›å»ºæ ‡ç­¾é¡µå¤±è´¥", Toast.LENGTH_SHORT).show()
            }

        } catch (e: Exception) {
            Log.e(TAG, "ä»URLåˆ›å»ºæ–°å¡ç‰‡æ—¶å‘ç”Ÿé”™è¯¯", e)
            Toast.makeText(this, "åˆ›å»ºæ ‡ç­¾é¡µæ—¶å‘ç”Ÿé”™è¯¯: ${e.message}", Toast.LENGTH_SHORT).show()
        }
    }

    /**
     * åˆ›å»ºç©ºç™½å¡ç‰‡
     */
    private fun createNewBlankCard() {
        try {
            Log.d(TAG, "åˆ›å»ºç©ºç™½å¡ç‰‡ - æ˜¾ç¤ºä¸»é¡µ")

            // å…ˆéšè—æ‰€æœ‰è¦†ç›–å±‚
            hideAllOverlays()
            clearAllOverlays()

            // æ˜¾ç¤ºä¸»é¡µå†…å®¹ï¼ˆå¸¦æŒ‰é’®çš„ä¸»é¡µï¼‰
            showBrowserHome()
            
            Log.d(TAG, "å·²æ˜¾ç¤ºä¸»é¡µå†…å®¹ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡ä¸»é¡µæŒ‰é’®è¿›è¡Œæ“ä½œ")

        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºä¸»é¡µæ—¶å‘ç”Ÿé”™è¯¯", e)
            Toast.makeText(this, "æ˜¾ç¤ºä¸»é¡µæ—¶å‘ç”Ÿé”™è¯¯: ${e.message}", Toast.LENGTH_SHORT).show()
        }
    }
    
    /**
     * åœ¨æ‚¬æµ®å¡ç‰‡åœºæ™¯ä¸­åˆ›å»ºæ–°çš„WebViewå¡ç‰‡ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
     */
    private fun createNewWebViewCardForFloatingCard() {
        try {
            Log.d(TAG, "åœ¨æ‚¬æµ®å¡ç‰‡ä¸­åˆ›å»ºæ–°çš„WebViewå¡ç‰‡")
            
            // ä¼˜å…ˆä½¿ç”¨ gestureCardWebViewManager
            val newCard = gestureCardWebViewManager?.addNewCard("about:blank")
            if (newCard != null) {
                Log.d(TAG, "é€šè¿‡ gestureCardWebViewManager åˆ›å»ºæ–°å¡ç‰‡æˆåŠŸ")
                Toast.makeText(this, "å·²åˆ›å»ºæ–°å¡ç‰‡", Toast.LENGTH_SHORT).show()
                return
            }
            
            // å¦‚æœ gestureCardWebViewManager ä¸å¯ç”¨ï¼Œå°è¯•ä½¿ç”¨ paperStackWebViewManager
            val newTab = paperStackWebViewManager?.addTab("about:blank", "æ–°æ ‡ç­¾é¡µ")
            if (newTab != null) {
                Log.d(TAG, "é€šè¿‡ paperStackWebViewManager åˆ›å»ºæ–°æ ‡ç­¾é¡µæˆåŠŸ")
                Toast.makeText(this, "å·²åˆ›å»ºæ–°æ ‡ç­¾é¡µ", Toast.LENGTH_SHORT).show()
                return
            }
            
            // å¦‚æœéƒ½ä¸å¯ç”¨ï¼Œæ˜¾ç¤ºä¸»é¡µ
            Log.w(TAG, "æ— æ³•åˆ›å»ºWebViewå¡ç‰‡ï¼Œæ˜¾ç¤ºä¸»é¡µä½œä¸ºå¤‡ç”¨")
            showBrowserHome()
            
        } catch (e: Exception) {
            Log.e(TAG, "åˆ›å»ºæ–°WebViewå¡ç‰‡æ—¶å‘ç”Ÿé”™è¯¯", e)
            Toast.makeText(this, "åˆ›å»ºå¡ç‰‡å¤±è´¥: ${e.message}", Toast.LENGTH_SHORT).show()
        }
    }
    
    /**
     * ä»å†å²è®°å½•æ¡ç›®æ·»åŠ åˆ°æ”¶è—
     */
    private fun addBookmarkFromHistoryEntry(entry: com.example.aifloatingball.model.HistoryEntry) {
        try {
            // ä½¿ç”¨BookmarkManagerç»Ÿä¸€ç®¡ç†
            val bookmarkManager = com.example.aifloatingball.manager.BookmarkManager.getInstance(this)
            
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒURLçš„æ”¶è—ï¼ˆå¿½ç•¥å¤§å°å†™ï¼‰
            if (bookmarkManager.isBookmarkExist(entry.url)) {
                Toast.makeText(this, "è¯¥ç½‘å€å·²åœ¨æ”¶è—ä¸­", Toast.LENGTH_SHORT).show()
                Log.d(TAG, "æ”¶è—å·²å­˜åœ¨: ${entry.url}")
                return
            }
            
            Log.d(TAG, "æ·»åŠ æ”¶è—: title=${entry.title}, url=${entry.url}")
            
            // åˆ›å»ºæ–°çš„ä¹¦ç­¾
            val bookmark = com.example.aifloatingball.model.Bookmark(
                title = entry.title,
                url = entry.url,
                folder = "ä»å†å²æ·»åŠ ",
                addTime = System.currentTimeMillis()
            )
            
            // æ·»åŠ åˆ°æ”¶è—
            bookmarkManager.addBookmark(bookmark, null)
            
            Toast.makeText(this, "å·²æ·»åŠ åˆ°æ”¶è—", Toast.LENGTH_SHORT).show()
            Log.d(TAG, "æ·»åŠ æ”¶è—æˆåŠŸ: title=${entry.title}, url=${entry.url}")
        } catch (e: Exception) {
            Log.e(TAG, "æ·»åŠ æ”¶è—å¤±è´¥", e)
            Toast.makeText(this, "æ·»åŠ å¤±è´¥: ${e.message}", Toast.LENGTH_SHORT).show()
        }
    }

    /**
     * è®¾ç½®æ–°çš„æ‰‹æœºå¡ç‰‡ç®¡ç†å™¨
     */
    private fun setupMobileCardManager() {
        try {
            Log.d(TAG, "å¼€å§‹è®¾ç½®æ‰‹æœºå¡ç‰‡ç®¡ç†å™¨")

            // æ£€æŸ¥å®¹å™¨æ˜¯å¦å·²åˆå§‹åŒ–
            if (!::browserWebViewContainer.isInitialized) {
                Log.e(TAG, "browserWebViewContaineræœªåˆå§‹åŒ–ï¼Œæ— æ³•è®¾ç½®æ‰‹æœºå¡ç‰‡ç®¡ç†å™¨")
                throw IllegalStateException("browserWebViewContaineræœªåˆå§‹åŒ–")
            }

            mobileCardManager = MobileCardManager(
                context = this,
                container = browserWebViewContainer
            )

        // è®¾ç½®å¡ç‰‡å˜åŒ–ç›‘å¬å™¨
        mobileCardManager?.setOnCardChangeListener(object : MobileCardManager.OnCardChangeListener {
            override fun onCardAdded(card: GestureCardWebViewManager.WebViewCardData, position: Int) {
                // éšè—ä¸»é¡µå†…å®¹ï¼Œæ˜¾ç¤ºå¡ç‰‡ç•Œé¢
                browserHomeContent.visibility = View.GONE
                browserTabContainer.visibility = View.GONE
                showViewPager2()

                // åŒæ­¥æ‰€æœ‰å¡ç‰‡ç³»ç»Ÿæ•°æ®
                syncAllCardSystems()

                Log.d(TAG, "æ‰‹æœºå¡ç‰‡å·²æ·»åŠ : ${card.title}ï¼Œæ•°æ®å·²åŒæ­¥")
            }

            override fun onCardRemoved(card: GestureCardWebViewManager.WebViewCardData, position: Int) {
                // å¦‚æœæ²¡æœ‰å¡ç‰‡äº†ï¼Œæ˜¾ç¤ºä¸»é¡µ
                if (mobileCardManager?.getAllCards()?.isEmpty() == true) {
                    showBrowserHome()
                }

                // åŒæ­¥æ‰€æœ‰å¡ç‰‡ç³»ç»Ÿæ•°æ®
                syncAllCardSystems()

                Log.d(TAG, "æ‰‹æœºå¡ç‰‡å·²ç§»é™¤: ${card.title}ï¼Œæ•°æ®å·²åŒæ­¥")
            }

            override fun onCardSwitched(card: GestureCardWebViewManager.WebViewCardData, position: Int) {
                // æ›´æ–°æœç´¢æ¡†URL
                browserSearchInput.setText(card.url)

                Log.d(TAG, "åˆ‡æ¢åˆ°æ‰‹æœºå¡ç‰‡: ${card.title}")
            }

            override fun onAllCardsRemoved() {
                // æ‰€æœ‰å¡ç‰‡éƒ½è¢«ç§»é™¤ï¼Œæ˜¾ç¤ºä¸»é¡µ
                showBrowserHome()
                
                // æ›´æ–°æœç´¢tabå¾½æ ‡
                updateSearchTabBadge()
                // æ›´æ–°é¡µé¢æ•°å­—
                updatePageCountDisplay()
                
                Log.d(TAG, "æ‰€æœ‰æ‰‹æœºå¡ç‰‡å·²ç§»é™¤")
            }
        })

        // æ³¨å†Œåˆ°ç»Ÿä¸€WebViewç®¡ç†å™¨
        mobileCardManager?.let { manager ->
            val adapter = WebViewManagerAdapter(manager, "MobileCardManager", unifiedWebViewManager)
            unifiedWebViewManager.registerManager(adapter)
            Log.d(TAG, "MobileCardManagerå·²æ³¨å†Œåˆ°ç»Ÿä¸€WebViewç®¡ç†å™¨")
            
            // è®¾ç½®å¢å¼ºç‰ˆèœå•ç®¡ç†å™¨
            val windowManager = getSystemService(Context.WINDOW_SERVICE) as WindowManager
            manager.setupEnhancedMenuManager(windowManager)
            Log.d(TAG, "MobileCardManagerå¢å¼ºç‰ˆèœå•ç®¡ç†å™¨è®¾ç½®å®Œæˆ")
        }

        Log.d(TAG, "æ‰‹æœºå¡ç‰‡ç®¡ç†å™¨è®¾ç½®å®Œæˆ")
        } catch (e: Exception) {
            Log.e(TAG, "è®¾ç½®æ‰‹æœºå¡ç‰‡ç®¡ç†å™¨å¤±è´¥", e)
            throw e
        }
    }

    /**
     * ç»Ÿä¸€ç®¡ç†æ‰€æœ‰è¦†ç›–å±‚çš„æ˜¾ç¤ºçŠ¶æ€
     */
    private fun hideAllOverlays(includeGestureHint: Boolean = true) {
        Log.d(TAG, "å¼€å§‹éšè—æ‰€æœ‰è¦†ç›–å±‚ï¼ŒåŒ…æ‹¬æ‰‹åŠ¿æç¤º: $includeGestureHint")

        // éšè—æ‰‹åŠ¿æç¤ºè¦†ç›–å±‚
        if (includeGestureHint && browserGestureOverlay.visibility == View.VISIBLE) {
            hideGestureHint()
            Log.d(TAG, "æ‰‹åŠ¿æç¤ºè¦†ç›–å±‚å·²éšè—")
        }

        // éšè—å¡ç‰‡é¢„è§ˆè¦†ç›–å±‚
        if (::cardPreviewOverlay.isInitialized && cardPreviewOverlay.visibility == View.VISIBLE) {
            cardPreviewOverlay.hide()
            Log.d(TAG, "å¡ç‰‡é¢„è§ˆè¦†ç›–å±‚å·²éšè—")
        }

        Log.d(TAG, "è¦†ç›–å±‚éšè—å®Œæˆ")
    }

    /**
     * æ¸…é™¤æ‰€æœ‰å¯èƒ½é˜»æŒ¡è§¦æ‘¸çš„è¦†ç›–å±‚
     */
    private fun clearAllOverlays() {
        Log.d(TAG, "å¼€å§‹æ¸…é™¤æ‰€æœ‰è¦†ç›–å±‚")

        // 1. ç¡®ä¿æ‰‹åŠ¿æç¤ºè¦†ç›–å±‚å®Œå…¨éšè—å’Œç¦ç”¨
        findViewById<FrameLayout>(R.id.browser_gesture_overlay)?.let { overlay ->
            overlay.visibility = View.GONE
            overlay.isClickable = false
            overlay.isFocusable = false
            overlay.isEnabled = false
            Log.d(TAG, "æ‰‹åŠ¿æç¤ºè¦†ç›–å±‚å·²å®Œå…¨ç¦ç”¨")
        }

        // 1.5. ç¡®ä¿å¡ç‰‡é¢„è§ˆè¦†ç›–å±‚éšè—
        if (::cardPreviewOverlay.isInitialized && cardPreviewOverlay.visibility == View.VISIBLE) {
            cardPreviewOverlay.hide()
            Log.d(TAG, "å¡ç‰‡é¢„è§ˆè¦†ç›–å±‚å·²éšè—")
        }

        // 2. æ£€æŸ¥WebViewå®¹å™¨ä¸­çš„æ‰€æœ‰å­è§†å›¾ï¼Œéšè—å¯èƒ½è¦†ç›–ä¸»é¡µçš„è§†å›¾
        val webViewContainer = findViewById<FrameLayout>(R.id.browser_webview_container)
        webViewContainer?.let { container ->
            Log.d(TAG, "WebViewå®¹å™¨å­è§†å›¾æ•°é‡: ${container.childCount}")

            for (i in 0 until container.childCount) {
                val child = container.getChildAt(i)
                Log.d(TAG, "å­è§†å›¾$i: ${child.javaClass.simpleName}, visibility: ${child.visibility}")

                // å¦‚æœæ˜¯ViewPager2ï¼Œåœ¨ä¸»é¡µæ¨¡å¼ä¸‹éšè—å®ƒ
                if (child.javaClass.simpleName.contains("ViewPager2")) {
                    Log.d(TAG, "å‘ç°ViewPager2ï¼Œåœ¨ä¸»é¡µæ¨¡å¼ä¸‹éšè—")
                    child.visibility = View.GONE
                }


            }
        }

        // 3. ç¡®ä¿ä¸»é¡µå†…å®¹å®¹å™¨æ²¡æœ‰è¢«å…¶ä»–è§†å›¾è¦†ç›–
        browserHomeContent.bringToFront()

        Log.d(TAG, "è¦†ç›–å±‚æ¸…é™¤å®Œæˆ")
    }

    /**
     * æ˜¾ç¤ºæµè§ˆå™¨ä¸»é¡µ
     */
    private fun showBrowserHome() {
        Log.d(TAG, "å¼€å§‹æ˜¾ç¤ºæµè§ˆå™¨ä¸»é¡µ")

        // å¼ºåˆ¶æ¸…é™¤æ‰€æœ‰å¯èƒ½çš„è¦†ç›–å±‚
        hideAllOverlays()
        clearAllOverlays()

        // éšè—çº¸å †å¸ƒå±€ï¼Œç¡®ä¿åŠŸèƒ½ä¸»é¡µæ˜¾ç¤ºåœ¨æœ€ä¸Šå±‚
        val paperStackLayout = findViewById<View>(R.id.paper_stack_layout)
        paperStackLayout?.visibility = View.GONE

        // æ˜¾ç¤ºä¸»é¡µå†…å®¹
        browserHomeContent.visibility = View.VISIBLE
        browserHomeContent.isEnabled = true
        browserHomeContent.isClickable = true
        browserSearchInput.setText("")

        // æœç´¢tabé¦–é¡µä¸éšè—æ ‡ç­¾æ å’Œæ ‡é¢˜æ 
        // browserTabContainer.visibility = View.GONE
        
        // ç¡®ä¿æ ‡é¢˜æ å’Œtabæ å¯è§
        if (!isToolbarVisible) {
            showToolbar()
        }

        // éšè—å››åˆ†ä¹‹ä¸€åœ†å¼§æ“ä½œæ ï¼ˆåœ¨ä¸»é¡µä¸éœ€è¦ï¼‰
        quarterArcOperationBar?.hide()

        // æœç´¢å¼•æ“é€‰æ‹©å™¨å·²ä»å¸ƒå±€ä¸­åˆ é™¤ï¼Œæ— éœ€è®¾ç½®

        // ç¡®ä¿åº•éƒ¨æŒ‰é’®ä¹Ÿå¯ç”¨
        findViewById<com.google.android.material.button.MaterialButton>(R.id.browser_start_browsing_button)?.let { newBtn ->
            newBtn.visibility = View.VISIBLE
            newBtn.isEnabled = true
            newBtn.isClickable = true
            newBtn.alpha = 1.0f
        }


        findViewById<com.google.android.material.button.MaterialButton>(R.id.browser_gesture_guide_button)?.let { gestureBtn ->
            gestureBtn.visibility = View.VISIBLE
            gestureBtn.isEnabled = true
            gestureBtn.isClickable = true
            gestureBtn.alpha = 1.0f
        }



        // æ¢å¤é»˜è®¤æœç´¢å¼•æ“å›¾æ ‡
        updateSearchTabIcon()

        Log.d(TAG, "æ˜¾ç¤ºæµè§ˆå™¨ä¸»é¡µ")

        // è°ƒè¯•ä¿¡æ¯ï¼šæ£€æŸ¥å„ç»„ä»¶çš„çŠ¶æ€
        Log.d(TAG, "ä¸»é¡µç»„ä»¶çŠ¶æ€æ£€æŸ¥:")
        Log.d(TAG, "- browserHomeContent.visibility: ${browserHomeContent.visibility}")
        Log.d(TAG, "- browserSearchEngineSelector: å·²ä»å¸ƒå±€ä¸­åˆ é™¤")

        // æ£€æŸ¥åº•éƒ¨æŒ‰é’®çŠ¶æ€
        findViewById<com.google.android.material.button.MaterialButton>(R.id.browser_start_browsing_button)?.let { btn ->
            Log.d(TAG, "- æ–°å»ºæŒ‰é’®çŠ¶æ€: visible=${btn.visibility}, enabled=${btn.isEnabled}, clickable=${btn.isClickable}")
        }
        
        // éšè—é˜…è¯»æ¨¡å¼æŒ‰é’®ï¼ˆè¿”å›ä¸»é¡µæ—¶ï¼‰
        hideReaderModeButtonForCatalog()
    }
    
    /**
     * åˆå§‹åŒ–é˜…è¯»æ¨¡å¼2ï¼ˆå¦‚æœéœ€è¦ï¼‰
     * ç¡®ä¿é˜…è¯»æ¨¡å¼2çš„UIå·²åˆ›å»ºå¹¶ç»‘å®šåˆ°WebViewå®¹å™¨
     */
    private fun initReaderMode2IfNeeded() {
        if (!isReaderMode2Initialized) {
            try {
                // ä½¿ç”¨ browserWebViewContainer ä½œä¸ºå®¹å™¨
                novelReaderUI2 = com.example.aifloatingball.reader.NovelReaderUI(this, browserWebViewContainer)
                novelReaderUI2?.hide() // é»˜è®¤éšè—
                
                // ğŸ”§ ç¦ç”¨ä¸‹æ‹‰å·¥å…·æ æ£€æµ‹ï¼ˆé˜…è¯»æ¨¡å¼2æ¿€æ´»æ—¶ï¼‰
                isPullDownToolbarDetectionEnabled = false
                // ç¦ç”¨SwipeRefreshLayout
                if (::browserSwipeRefresh.isInitialized) {
                    browserSwipeRefresh.isEnabled = false
                }
                
                // è®¾ç½®å·¥å…·æ æ§åˆ¶å™¨ï¼Œè®©é˜…è¯»æ¨¡å¼2å¯ä»¥æ§åˆ¶SimpleModeActivityçš„å·¥å…·æ 
                novelReaderUI2?.setToolbarController(object : com.example.aifloatingball.reader.ReaderMode2ToolbarController {
                    override fun showToolbar() {
                        // é˜²æ­¢é€’å½’è°ƒç”¨
                        if (isToolbarControllerCalling) return
                        isToolbarControllerCalling = true
                        try {
                            if (android.os.Looper.myLooper() == android.os.Looper.getMainLooper()) {
                                // å·²ç»åœ¨ä¸»çº¿ç¨‹ï¼Œç›´æ¥è°ƒç”¨
                                if (!isToolbarVisible) {
                                    showToolbar()
                                }
                            } else {
                                // ä¸åœ¨ä¸»çº¿ç¨‹ï¼Œä½¿ç”¨ runOnUiThread
                                runOnUiThread {
                                    if (!isToolbarVisible) {
                                        showToolbar()
                                    }
                                }
                            }
                        } finally {
                            // å»¶è¿Ÿé‡ç½®æ ‡å¿—ï¼Œé¿å…ç«‹å³å†æ¬¡è°ƒç”¨
                            android.os.Handler(android.os.Looper.getMainLooper()).postDelayed({
                                isToolbarControllerCalling = false
                            }, 100)
                        }
                    }
                    
                    override fun hideToolbar() {
                        // é˜²æ­¢é€’å½’è°ƒç”¨
                        if (isToolbarControllerCalling) return
                        isToolbarControllerCalling = true
                        try {
                            if (android.os.Looper.myLooper() == android.os.Looper.getMainLooper()) {
                                // å·²ç»åœ¨ä¸»çº¿ç¨‹ï¼Œç›´æ¥è°ƒç”¨
                                if (isToolbarVisible) {
                                    hideToolbarOnly()
                                }
                            } else {
                                // ä¸åœ¨ä¸»çº¿ç¨‹ï¼Œä½¿ç”¨ runOnUiThread
                                runOnUiThread {
                                    if (isToolbarVisible) {
                                        hideToolbarOnly()
                                    }
                                }
                            }
                        } finally {
                            // å»¶è¿Ÿé‡ç½®æ ‡å¿—ï¼Œé¿å…ç«‹å³å†æ¬¡è°ƒç”¨
                            android.os.Handler(android.os.Looper.getMainLooper()).postDelayed({
                                isToolbarControllerCalling = false
                            }, 100)
                        }
                    }
                    
                    override fun exitReaderMode2() {
                        // é€€å‡ºæ—¶ä¸éœ€è¦é˜²æ­¢é€’å½’ï¼Œå› ä¸ºè¿™æ˜¯æœ€ç»ˆæ“ä½œ
                        // é‡æ–°å¯ç”¨ä¸‹æ‹‰å·¥å…·æ æ£€æµ‹
                        isPullDownToolbarDetectionEnabled = true
                        // é‡æ–°å¯ç”¨SwipeRefreshLayout
                        if (::browserSwipeRefresh.isInitialized) {
                            browserSwipeRefresh.isEnabled = true
                        }
                        if (android.os.Looper.myLooper() == android.os.Looper.getMainLooper()) {
                            // å·²ç»åœ¨ä¸»çº¿ç¨‹ï¼Œç›´æ¥è°ƒç”¨
                            if (!isToolbarVisible) {
                                showToolbar()
                            }
                        } else {
                            // ä¸åœ¨ä¸»çº¿ç¨‹ï¼Œä½¿ç”¨ runOnUiThread
                            runOnUiThread {
                                if (!isToolbarVisible) {
                                    showToolbar()
                                }
                            }
                        }
                    }
                })
                
                // NovelReaderUI åœ¨åˆå§‹åŒ–æ—¶ä¼šè‡ªåŠ¨è®¾ç½®ç›‘å¬å™¨ï¼ˆé€šè¿‡ manager.setListener(this)ï¼‰
                // æ‰€ä»¥è¿™é‡Œä¸éœ€è¦å†è®¾ç½®ç›‘å¬å™¨
                
                isReaderMode2Initialized = true
                Log.d(TAG, "âœ… é˜…è¯»æ¨¡å¼2å·²åˆå§‹åŒ–")
            } catch (e: Exception) {
                Log.e(TAG, "åˆå§‹åŒ–é˜…è¯»æ¨¡å¼2å¤±è´¥", e)
            }
        }
    }
    
    /**
     * æ˜¾ç¤ºç›®å½•é¡µé˜…è¯»æ¨¡å¼æŒ‰é’®ï¼ˆè‡ªåŠ¨å¼¹å‡ºï¼‰
     * å‚è€ƒAlookæµè§ˆå™¨çš„å®ç°ï¼Œåœ¨æ£€æµ‹åˆ°ç›®å½•é¡µæ—¶è‡ªåŠ¨æ˜¾ç¤º
     */
    private fun showReaderModeButtonForCatalog(webView: WebView, url: String) {
        try {
            // å¦‚æœæŒ‰é’®å·²å­˜åœ¨ï¼Œå…ˆç§»é™¤
            hideReaderModeButtonForCatalog()
            
            // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨WindowManageræ·»åŠ æ‚¬æµ®æŒ‰é’®ï¼Œç¡®ä¿åœ¨æœ€ä¸Šå±‚
            // æˆ–è€…æ·»åŠ åˆ°Activityçš„æ ¹å¸ƒå±€ï¼Œè€Œä¸æ˜¯WebViewå®¹å™¨
            val rootView = window.decorView.rootView as? ViewGroup
            if (rootView == null) {
                Log.e(TAG, "æ— æ³•è·å–æ ¹å¸ƒå±€ï¼Œä½¿ç”¨WebViewå®¹å™¨")
                // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨WebViewå®¹å™¨ï¼Œä½†è®¾ç½®æ›´é«˜çš„å±‚çº§
                showReaderModeButtonInWebViewContainer(webView, url)
                return
            }
            
            // åˆ›å»ºæŒ‰é’®å®¹å™¨ï¼ˆä½¿ç”¨FrameLayoutä½œä¸ºæ‚¬æµ®å±‚ï¼‰
            val container = FrameLayout(this).apply {
                layoutParams = FrameLayout.LayoutParams(
                    FrameLayout.LayoutParams.WRAP_CONTENT,
                    FrameLayout.LayoutParams.WRAP_CONTENT
                ).apply {
                    gravity = Gravity.CENTER_HORIZONTAL or Gravity.TOP
                    topMargin = (120 * resources.displayMetrics.density).toInt() // è·ç¦»é¡¶éƒ¨120dp
                }
                setPadding(0, 0, 0, 0)
                // ğŸ”§ å…³é”®ï¼šè®¾ç½®èƒŒæ™¯é€æ˜ï¼Œç¡®ä¿ä¸é®æŒ¡å†…å®¹
                setBackgroundColor(Color.TRANSPARENT)
                // ğŸ”§ å…³é”®ï¼šè®¾ç½®ç‚¹å‡»ç©¿é€ï¼Œä½†æŒ‰é’®æœ¬èº«å¯ç‚¹å‡»
                isClickable = false
                isFocusable = false
            }
            
            // åˆ›å»ºé˜…è¯»æ¨¡å¼æŒ‰é’®
            val button = MaterialButton(this).apply {
                text = "è¿›å…¥é˜…è¯»æ¨¡å¼"
                setBackgroundColor(Color.parseColor("#007AFF"))
                setTextColor(Color.WHITE)
                cornerRadius = (12 * resources.displayMetrics.density).toInt()
                // ğŸ”§ å…³é”®ï¼šè®¾ç½®æ›´é«˜çš„elevationï¼Œç¡®ä¿åœ¨æœ€ä¸Šå±‚
                elevation = 16f
                // ğŸ”§ å…³é”®ï¼šç¡®ä¿æŒ‰é’®å¯ç‚¹å‡»
                isClickable = true
                isFocusable = true
                isEnabled = true
                setPadding(
                    (24 * resources.displayMetrics.density).toInt(),
                    (12 * resources.displayMetrics.density).toInt(),
                    (24 * resources.displayMetrics.density).toInt(),
                    (12 * resources.displayMetrics.density).toInt()
                )
                
                // ç‚¹å‡»è¿›å…¥é˜…è¯»æ¨¡å¼ï¼ˆä½¿ç”¨é˜…è¯»æ¨¡å¼2ï¼‰
                setOnClickListener {
                    Log.d(TAG, "ç›®å½•é¡µé˜…è¯»æ¨¡å¼æŒ‰é’®è¢«ç‚¹å‡»ï¼Œè¿›å…¥é˜…è¯»æ¨¡å¼2: $url")
                    try {
                        // ä½¿ç”¨é˜…è¯»æ¨¡å¼2ï¼ˆNovelReaderManager + NovelReaderUIï¼‰
                        // ç¡®ä¿é˜…è¯»æ¨¡å¼2å·²åˆå§‹åŒ–
                        initReaderMode2IfNeeded()
                        // è®¾ç½®WebViewå¼•ç”¨ï¼ˆç”¨äºæ— å›¾æ¨¡å¼ç­‰åŠŸèƒ½ï¼‰
                        novelReaderUI2?.setWebView(webView)
                        // è¿›å…¥é˜…è¯»æ¨¡å¼2
                        com.example.aifloatingball.reader.NovelReaderManager.getInstance(this@SimpleModeActivity).enterReaderMode(webView)
                        Toast.makeText(this@SimpleModeActivity, "æ­£åœ¨è¿›å…¥é˜…è¯»æ¨¡å¼...", Toast.LENGTH_SHORT).show()
                        // è¿›å…¥é˜…è¯»æ¨¡å¼åéšè—æŒ‰é’®
                        hideReaderModeButtonForCatalog()
                    } catch (e: Exception) {
                        Log.e(TAG, "è¿›å…¥é˜…è¯»æ¨¡å¼2å¤±è´¥", e)
                        Toast.makeText(this@SimpleModeActivity, "è¿›å…¥é˜…è¯»æ¨¡å¼å¤±è´¥: ${e.message}", Toast.LENGTH_SHORT).show()
                    }
                }
                
                // æ·»åŠ æ·¡å…¥åŠ¨ç”»
                alpha = 0f
                animate()
                    .alpha(1f)
                    .setDuration(300)
                    .setInterpolator(FastOutSlowInInterpolator())
                    .start()
            }
            
            container.addView(button)
            
            // ğŸ”§ å…³é”®ï¼šæ·»åŠ åˆ°æ ¹å¸ƒå±€ï¼Œç¡®ä¿åœ¨æœ€ä¸Šå±‚
            rootView.addView(container)
            // ğŸ”§ å…³é”®ï¼šç¡®ä¿æŒ‰é’®åœ¨æœ€ä¸Šå±‚
            container.bringToFront()
            container.elevation = 20f
            
            catalogReaderModeButton = button
            catalogReaderModeButtonContainer = container
            
            Log.d(TAG, "âœ… ç›®å½•é¡µé˜…è¯»æ¨¡å¼æŒ‰é’®å·²æ˜¾ç¤ºï¼ˆæ·»åŠ åˆ°æ ¹å¸ƒå±€ï¼‰")
        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºç›®å½•é¡µé˜…è¯»æ¨¡å¼æŒ‰é’®å¤±è´¥ï¼Œå°è¯•é™çº§æ–¹æ¡ˆ", e)
            // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨WebViewå®¹å™¨
            showReaderModeButtonInWebViewContainer(webView, url)
        }
    }
    
    /**
     * é™çº§æ–¹æ¡ˆï¼šåœ¨WebViewå®¹å™¨ä¸­æ˜¾ç¤ºæŒ‰é’®
     */
    private fun showReaderModeButtonInWebViewContainer(webView: WebView, url: String) {
        try {
            // åˆ›å»ºæŒ‰é’®å®¹å™¨
            val container = FrameLayout(this).apply {
                layoutParams = FrameLayout.LayoutParams(
                    FrameLayout.LayoutParams.WRAP_CONTENT,
                    FrameLayout.LayoutParams.WRAP_CONTENT
                ).apply {
                    gravity = Gravity.CENTER_HORIZONTAL or Gravity.TOP
                    topMargin = (120 * resources.displayMetrics.density).toInt()
                }
                setBackgroundColor(Color.TRANSPARENT)
                isClickable = false
                isFocusable = false
            }
            
            // åˆ›å»ºé˜…è¯»æ¨¡å¼æŒ‰é’®
            val button = MaterialButton(this).apply {
                text = "è¿›å…¥é˜…è¯»æ¨¡å¼"
                setBackgroundColor(Color.parseColor("#007AFF"))
                setTextColor(Color.WHITE)
                cornerRadius = (12 * resources.displayMetrics.density).toInt()
                elevation = 16f
                isClickable = true
                isFocusable = true
                isEnabled = true
                setPadding(
                    (24 * resources.displayMetrics.density).toInt(),
                    (12 * resources.displayMetrics.density).toInt(),
                    (24 * resources.displayMetrics.density).toInt(),
                    (12 * resources.displayMetrics.density).toInt()
                )
                
                setOnClickListener {
                    Log.d(TAG, "ç›®å½•é¡µé˜…è¯»æ¨¡å¼æŒ‰é’®è¢«ç‚¹å‡»ï¼Œè¿›å…¥é˜…è¯»æ¨¡å¼2: $url")
                    try {
                        // ä½¿ç”¨é˜…è¯»æ¨¡å¼2ï¼ˆNovelReaderManager + NovelReaderUIï¼‰
                        // ç¡®ä¿é˜…è¯»æ¨¡å¼2å·²åˆå§‹åŒ–
                        initReaderMode2IfNeeded()
                        // è®¾ç½®WebViewå¼•ç”¨ï¼ˆç”¨äºæ— å›¾æ¨¡å¼ç­‰åŠŸèƒ½ï¼‰
                        novelReaderUI2?.setWebView(webView)
                        // è¿›å…¥é˜…è¯»æ¨¡å¼2
                        com.example.aifloatingball.reader.NovelReaderManager.getInstance(this@SimpleModeActivity).enterReaderMode(webView)
                        Toast.makeText(this@SimpleModeActivity, "æ­£åœ¨è¿›å…¥é˜…è¯»æ¨¡å¼...", Toast.LENGTH_SHORT).show()
                        hideReaderModeButtonForCatalog()
                    } catch (e: Exception) {
                        Log.e(TAG, "è¿›å…¥é˜…è¯»æ¨¡å¼2å¤±è´¥", e)
                        Toast.makeText(this@SimpleModeActivity, "è¿›å…¥é˜…è¯»æ¨¡å¼å¤±è´¥: ${e.message}", Toast.LENGTH_SHORT).show()
                    }
                }
                
                alpha = 0f
                animate()
                    .alpha(1f)
                    .setDuration(300)
                    .setInterpolator(FastOutSlowInInterpolator())
                    .start()
            }
            
            container.addView(button)
            browserWebViewContainer.addView(container)
            // ğŸ”§ å…³é”®ï¼šç¡®ä¿æŒ‰é’®åœ¨æœ€ä¸Šå±‚
            container.bringToFront()
            container.elevation = 20f
            
            catalogReaderModeButton = button
            catalogReaderModeButtonContainer = container
            
            Log.d(TAG, "âœ… ç›®å½•é¡µé˜…è¯»æ¨¡å¼æŒ‰é’®å·²æ˜¾ç¤ºï¼ˆé™çº§æ–¹æ¡ˆï¼šWebViewå®¹å™¨ï¼‰")
        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºç›®å½•é¡µé˜…è¯»æ¨¡å¼æŒ‰é’®å¤±è´¥ï¼ˆé™çº§æ–¹æ¡ˆï¼‰", e)
        }
    }
    
    /**
     * éšè—ç›®å½•é¡µé˜…è¯»æ¨¡å¼æŒ‰é’®
     */
    private fun hideReaderModeButtonForCatalog() {
        try {
            catalogReaderModeButtonContainer?.let { container ->
                val parent = container.parent as? ViewGroup
                
                // æ·»åŠ æ·¡å‡ºåŠ¨ç”»
                container.animate()
                    .alpha(0f)
                    .setDuration(200)
                    .setInterpolator(FastOutSlowInInterpolator())
                    .withEndAction {
                        try {
                            // ğŸ”§ ä¿®å¤ï¼šä»æ­£ç¡®çš„çˆ¶å®¹å™¨ç§»é™¤ï¼ˆå¯èƒ½æ˜¯æ ¹å¸ƒå±€æˆ–WebViewå®¹å™¨ï¼‰
                            parent?.removeView(container)
                            Log.d(TAG, "ç›®å½•é¡µé˜…è¯»æ¨¡å¼æŒ‰é’®å·²ä»çˆ¶å®¹å™¨ç§»é™¤")
                        } catch (e: Exception) {
                            Log.e(TAG, "ä»çˆ¶å®¹å™¨ç§»é™¤æŒ‰é’®å¤±è´¥", e)
                        }
                    }
                    .start()
                
                catalogReaderModeButton = null
                catalogReaderModeButtonContainer = null
                
                Log.d(TAG, "ç›®å½•é¡µé˜…è¯»æ¨¡å¼æŒ‰é’®å·²éšè—")
            }
        } catch (e: Exception) {
            Log.e(TAG, "éšè—ç›®å½•é¡µé˜…è¯»æ¨¡å¼æŒ‰é’®å¤±è´¥", e)
            // å¦‚æœåŠ¨ç”»å¤±è´¥ï¼Œç›´æ¥ç§»é™¤
            try {
                catalogReaderModeButtonContainer?.let { container ->
                    val parent = container.parent as? ViewGroup
                    parent?.removeView(container)
                }
                catalogReaderModeButton = null
                catalogReaderModeButtonContainer = null
            } catch (e2: Exception) {
                Log.e(TAG, "å¼ºåˆ¶ç§»é™¤æŒ‰é’®å¤±è´¥", e2)
            }
        }



        // ç¡®ä¿æ‰‹åŠ¿æç¤ºè¦†ç›–å±‚ä¸ä¼šå¹²æ‰°
        findViewById<FrameLayout >(R.id.browser_gesture_overlay)?.let { overlay ->
            overlay.visibility = View.GONE
            Log.d(TAG, "- æ‰‹åŠ¿æç¤ºè¦†ç›–å±‚å·²éšè—")
        }

        // æ£€æŸ¥WebViewå®¹å™¨çš„å­è§†å›¾ï¼Œç¡®ä¿æ²¡æœ‰è¦†ç›–å±‚
        val webViewContainer = findViewById<FrameLayout>(R.id.browser_webview_container)
        webViewContainer?.let { container ->
            Log.d(TAG, "WebViewå®¹å™¨å­è§†å›¾æ•°é‡: ${container.childCount}")
            for (i in 0 until container.childCount) {
                val child = container.getChildAt(i)
                Log.d(TAG, "- å­è§†å›¾$i: ${child.javaClass.simpleName}, visibility=${child.visibility}, clickable=${child.isClickable}")


            }
        }

        // æœ€ç»ˆæµ‹è¯•ï¼šç¡®ä¿å…³é”®å…ƒç´ å¯ä»¥æ¥æ”¶è§¦æ‘¸äº‹ä»¶
        testTouchability()
    }

    /**
     * æ˜¾ç¤ºViewPager2ï¼ˆWebViewå¡ç‰‡å®¹å™¨ï¼‰
     */
    private fun showViewPager2() {
        Log.d(TAG, "å¼€å§‹æ˜¾ç¤ºViewPager2")

        val webViewContainer = findViewById<FrameLayout>(R.id.browser_webview_container)
        webViewContainer?.let { container ->
            Log.d(TAG, "WebViewå®¹å™¨å­è§†å›¾æ•°é‡: ${container.childCount}")

            for (i in 0 until container.childCount) {
                val child = container.getChildAt(i)
                Log.d(TAG, "å­è§†å›¾$i: ${child.javaClass.simpleName}, å½“å‰visibility: ${child.visibility}")

                if (child.javaClass.simpleName.contains("ViewPager2")) {
                    val oldVisibility = child.visibility
                    child.visibility = View.VISIBLE
                    Log.d(TAG, "ViewPager2å¯è§æ€§: $oldVisibility -> ${child.visibility}")

                    // ç¡®ä¿ViewPager2åœ¨æœ€å‰é¢
                    child.bringToFront()
                    Log.d(TAG, "ViewPager2å·²æ˜¾ç¤ºå¹¶ç½®äºæœ€å‰é¢")
                    return
                }
            }
            Log.w(TAG, "æœªæ‰¾åˆ°ViewPager2")
        } ?: run {
            Log.e(TAG, "WebViewå®¹å™¨ä¸ºnull")
        }
    }

    /**
     * æµ‹è¯•å…³é”®å…ƒç´ çš„è§¦æ‘¸èƒ½åŠ›
     */
    private fun testTouchability() {
        Log.d(TAG, "å¼€å§‹æµ‹è¯•è§¦æ‘¸èƒ½åŠ›")

        // æµ‹è¯•æœç´¢å¼•æ“é€‰æ‹©å™¨ï¼ˆå·²ä»å¸ƒå±€ä¸­åˆ é™¤ï¼‰
        Log.d(TAG, "æœç´¢å¼•æ“é€‰æ‹©å™¨çŠ¶æ€: å·²ä»å¸ƒå±€ä¸­åˆ é™¤")

        // æµ‹è¯•åº•éƒ¨æŒ‰é’®
        findViewById<com.google.android.material.button.MaterialButton>(R.id.browser_start_browsing_button)?.let { btn ->
            Log.d(TAG, "æ–°å»ºæŒ‰é’®çŠ¶æ€:")
            Log.d(TAG, "- visibility: ${btn.visibility}")
            Log.d(TAG, "- isEnabled: ${btn.isEnabled}")
            Log.d(TAG, "- isClickable: ${btn.isClickable}")
            Log.d(TAG, "- alpha: ${btn.alpha}")
        }

        // æµ‹è¯•ä¸»é¡µå†…å®¹å®¹å™¨
        Log.d(TAG, "ä¸»é¡µå†…å®¹å®¹å™¨çŠ¶æ€:")
        Log.d(TAG, "- visibility: ${browserHomeContent.visibility}")
        Log.d(TAG, "- isEnabled: ${browserHomeContent.isEnabled}")
        Log.d(TAG, "- isClickable: ${browserHomeContent.isClickable}")

        Log.d(TAG, "è§¦æ‘¸èƒ½åŠ›æµ‹è¯•å®Œæˆ")
    }





    /**
     * æ˜¾ç¤ºåœ°å€æ åˆ·æ–°åŠ¨ç”»
     */
    private fun showAddressBarRefreshAnimation() {
        // åœ°å€æ æ»šåŠ¨åŠ¨ç”»
        val currentText = browserSearchInput.text.toString()
        if (currentText.isNotEmpty()) {
            // åˆ›å»ºæ»šåŠ¨åŠ¨ç”»
            val scrollAnimator = android.animation.ObjectAnimator.ofInt(
                browserSearchInput, "scrollX", 0, browserSearchInput.width / 2, 0
            ).apply {
                duration = 800
                interpolator = android.view.animation.AccelerateDecelerateInterpolator()
            }

            // åˆ›å»ºé€æ˜åº¦åŠ¨ç”»
            val alphaAnimator = android.animation.ObjectAnimator.ofFloat(
                browserSearchInput, "alpha", 1f, 0.7f, 1f
            ).apply {
                duration = 800
                interpolator = android.view.animation.AccelerateDecelerateInterpolator()
            }

            // ç»„åˆåŠ¨ç”»
            android.animation.AnimatorSet().apply {
                playTogether(scrollAnimator, alphaAnimator)
                start()
            }
        }
    }

    // setupModeSwitchWidgetæ–¹æ³•å·²ç§»é™¤ï¼Œå› ä¸ºModeSwitchWidgetå·²è¢«ç¦ç”¨

    /**
     * æ‰§è¡Œæµè§ˆå™¨æœç´¢ - ä¿®å¤æœç´¢å…³é”®è¯æœºåˆ¶
     */
    private fun performBrowserSearch() {
        // éšè—è¾“å…¥æ³•
        val imm = getSystemService(android.content.Context.INPUT_METHOD_SERVICE) as android.view.inputmethod.InputMethodManager
        imm.hideSoftInputFromWindow(browserSearchInput.windowToken, 0)
        
        val query = browserSearchInput.text.toString().trim()
        if (query.isNotEmpty()) {
            try {
                val lower = query.lowercase()
                
                // æ£€æŸ¥æ˜¯å¦ä¸ºç‰¹æ®Š schemeï¼ˆéœ€è¦å¤–éƒ¨åº”ç”¨æ‰“å¼€ï¼‰ï¼Œè¿™äº›åº”è¯¥å½“ä½œæœç´¢è¯è€Œä¸æ˜¯URL
                val isSpecialScheme = when {
                    lower.startsWith("intent://") -> true
                    lower.startsWith("clash://") -> true
                    lower.startsWith("douban://") -> true
                    lower.startsWith("baidumap://") -> true
                    lower.startsWith("amap://") -> true
                    lower.startsWith("alipay://") -> true
                    lower.startsWith("wechat://") -> true
                    lower.startsWith("weixin://") -> true
                    lower.startsWith("qq://") -> true
                    // å…¶ä»–å·²çŸ¥çš„ç‰¹æ®Š scheme
                    lower.contains("://") && !lower.startsWith("http://") && 
                    !lower.startsWith("https://") && !lower.startsWith("file://") -> true
                    else -> false
                }
                
                // å¦‚æœæ˜¯ç‰¹æ®Š schemeï¼Œå½“ä½œæœç´¢è¯å¤„ç†ï¼ˆç±»ä¼¼ Chromeï¼‰
                if (isSpecialScheme) {
                    Log.d(TAG, "æ£€æµ‹åˆ°ç‰¹æ®Š scheme '$query'ï¼Œå½“ä½œæœç´¢è¯å¤„ç†")
                    val searchEngine = currentSearchEngine ?: com.example.aifloatingball.model.SearchEngine(
                        name = "Google",
                        displayName = "Google",
                        url = "https://www.google.com/search?q={query}",
                        iconResId = R.drawable.ic_google,
                        description = "Googleæœç´¢"
                    )
                    val searchUrl = searchEngine.getSearchUrl(query)
                    loadBrowserContent(searchUrl)
                    
                    // è®°å½•æœç´¢å†å²ï¼ˆç‰¹æ®Šschemeå½“ä½œæœç´¢è¯ï¼‰
                    com.example.aifloatingball.manager.SearchHistoryAutoRecorder.recordSearchHistory(
                        context = this,
                        query = query,
                        source = com.example.aifloatingball.manager.SearchHistoryAutoRecorder.SearchSource.SEARCH_TAB,
                        tags = emptyList(),
                        searchType = "ç½‘é¡µæœç´¢"
                    )
                    
                    Log.d(TAG, "æµè§ˆå™¨æœç´¢ - ç‰¹æ®Š scheme '$query' å·²è½¬æ¢ä¸ºæœç´¢: $searchUrl")
                    return
                }
                
                // å¢å¼ºçš„URLåˆ¤æ–­é€»è¾‘ï¼ˆæ’é™¤ç‰¹æ®Š schemeï¼‰
                val isUrl = when {
                    // 1. æ ‡å‡†URLæ ¼å¼åˆ¤æ–­
                    android.webkit.URLUtil.isValidUrl(query) -> true
                    // 2. åŒ…å«åŸŸåä½†æ²¡æœ‰åè®®çš„æƒ…å†µï¼ˆè‡³å°‘åŒ…å«ä¸€ä¸ªç‚¹ä¸”ä¸åŒ…å«ç©ºæ ¼ï¼‰
                    query.contains(".") && !query.contains(" ") && query.count { it == '.' } >= 1 -> true
                    // 3. æ˜ç¡®çš„åè®®å¼€å¤´
                    query.startsWith("http://") || query.startsWith("https://") -> true
                    // 4. æœ¬åœ°æ–‡ä»¶
                    query.startsWith("file://") -> true
                    // 5. IPåœ°å€æ ¼å¼
                    query.matches(Regex("^\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}(:\\d+)?(/.*)?$")) -> true
                    else -> false
                }

                val url = if (isUrl) {
                    // å¦‚æœæ˜¯URLï¼Œç¡®ä¿æœ‰http/httpså‰ç¼€
                    when {
                        query.startsWith("http://") || query.startsWith("https://") || query.startsWith("file://") -> query
                        query.matches(Regex("^\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}.*")) -> "http://$query" // IPåœ°å€ç”¨http
                        else -> "https://$query"
                    }
                } else {
                    // å¦‚æœä¸æ˜¯URLï¼Œä½¿ç”¨å½“å‰æœç´¢å¼•æ“æœç´¢
                    val searchEngine = currentSearchEngine ?: com.example.aifloatingball.model.SearchEngine(
                        name = "Google",
                        displayName = "Google",
                        url = "https://www.google.com/search?q={query}",
                        iconResId = R.drawable.ic_google,
                        description = "Googleæœç´¢"
                    )
                    searchEngine.getSearchUrl(query)
                }

                // è®°å½•æœç´¢å†å²ï¼ˆä»…åœ¨éURLæ—¶è®°å½•ï¼Œå‚è€ƒHomeActivityçš„é€»è¾‘ï¼‰
                if (!isUrl && !query.startsWith("http://") && !query.startsWith("https://")) {
                    com.example.aifloatingball.manager.SearchHistoryAutoRecorder.recordSearchHistory(
                        context = this,
                        query = query,
                        source = com.example.aifloatingball.manager.SearchHistoryAutoRecorder.SearchSource.SEARCH_TAB,
                        tags = emptyList(),
                        searchType = "ç½‘é¡µæœç´¢"
                    )
                }

                // åŠ è½½URLåˆ°å½“å‰é¡µé¢æˆ–æ–°é¡µé¢
                loadBrowserContent(url)

                Log.d(TAG, "æµè§ˆå™¨æœç´¢ - è¾“å…¥: '$query', æ˜¯å¦URL: $isUrl, æœç´¢å¼•æ“: ${currentSearchEngine?.name}, æœ€ç»ˆURL: $url")

            } catch (e: Exception) {
                Log.e(TAG, "æµè§ˆå™¨æœç´¢å¤±è´¥", e)
                Toast.makeText(this, "æœç´¢å¤±è´¥: ${e.message}", Toast.LENGTH_SHORT).show()
            }
        }
    }

    /**
     * åŠ è½½æµè§ˆå™¨å†…å®¹ - çº¸å †æ¨¡å¼ç‰ˆæœ¬
     */
    private fun loadBrowserContent(url: String) {
        try {
            Log.d(TAG, "å¼€å§‹åŠ è½½URL: $url")

            // åŒæ­¥æ›´æ–°åœ°å€æ å·¦ä¾§ç«™ç‚¹å›¾æ ‡
            updateBrowserFaviconButtonForUrl(url)

            // åˆå§‹ç”¨URLå¡«å……åœ°å€æ ï¼ˆåç»­æ”¶åˆ°æ ‡é¢˜å†è¦†ç›–ï¼‰
            try { browserSearchInput.setText(url) } catch (_: Exception) {}

            // ğŸ”§ ä¿®å¤ï¼šç¡®ä¿é¡µé¢åŠ è½½æ—¶ï¼Œæ‚¬æµ®å·¥å…·æ é»˜è®¤éšè—ï¼Œtabæ é»˜è®¤æ˜¾ç¤º
            if (isQuickActionsBarVisible) {
                hideQuickActionsBar()
            }
            // ç¡®ä¿tabæ æ˜¾ç¤ºï¼ˆå¦‚æœæœ‰æ ‡ç­¾é¡µï¼‰
            val hasTabs = paperStackWebViewManager?.getAllTabs()?.isNotEmpty() == true
            // ğŸ”§ ä¿®å¤ï¼šæ ‡ç­¾æ å®¹å™¨å·²æ°¸ä¹…éšè—
            // if (hasTabs && browserTabContainer.visibility != View.VISIBLE) {
            //     browserTabContainer.visibility = View.VISIBLE
            // }
            browserTabContainer.visibility = View.GONE
            // ç¡®ä¿æ ‡é¢˜æ æ˜¾ç¤º
            if (!isToolbarVisible) {
                showToolbar()
            }

            // åœ¨çº¸å †æ¨¡å¼ä¸‹æ·»åŠ æ–°æ ‡ç­¾é¡µ
            if (paperStackWebViewManager != null) {
                val title = extractTitleFromUrl(url)
                paperStackWebViewManager?.addTab(url, title)
                
                Log.d(TAG, "åœ¨çº¸å †æ¨¡å¼ä¸­æ·»åŠ æ–°æ ‡ç­¾é¡µ: $title")
            } else {
                // å…¼å®¹åŸæœ‰é€»è¾‘
                loadUrlInNewCard(url)
                
                // éšè—ä¸»é¡µå†…å®¹ï¼Œæ˜¾ç¤ºæ‰‹åŠ¿å¡ç‰‡å¼WebViewç•Œé¢
                browserHomeContent.visibility = View.GONE
                browserTabContainer.visibility = View.GONE
                
                // å…³é”®ä¿®å¤ï¼šç¡®ä¿ViewPager2å¯è§
                showViewPager2()
                
                // ä½¿ç”¨postç¡®ä¿UIçŠ¶æ€åœ¨ä¸‹ä¸€ä¸ªå¾ªç¯ä¸­åŒæ­¥
                browserLayout.post {
                    // å†æ¬¡ç¡®ä¿ViewPager2å¯è§ï¼ˆé˜²æ­¢æ—¶åºé—®é¢˜ï¼‰
                    showViewPager2()
                    Log.d(TAG, "UIçŠ¶æ€å·²åŒæ­¥ï¼ŒViewPager2ç¡®ä¿å¯è§")
                }
                
                Log.d(TAG, "å·²åˆ‡æ¢åˆ°WebViewæ¨¡å¼ï¼ŒViewPager2å·²æ˜¾ç¤º")
                Log.d(TAG, "æ˜¾ç¤ºæ‰‹åŠ¿å¡ç‰‡å¼WebViewç•Œé¢ï¼Œå½“å‰å¡ç‰‡æ•°: ${gestureCardWebViewManager?.getAllCards()?.size}")
            }

        } catch (e: Exception) {
            Log.e(TAG, "åŠ è½½å†…å®¹å¤±è´¥", e)
            Toast.makeText(this, "æ— æ³•åŠ è½½é¡µé¢: ${e.message}", Toast.LENGTH_SHORT).show()
        }
    }

    /**
     * ä»URLæå–æ ‡é¢˜
     */
    private fun extractTitleFromUrl(url: String): String {
        return try {
            val uri = java.net.URI(url)
            val host = uri.host ?: url
            when {
                host.contains("baidu.com") -> "ç™¾åº¦"
                host.contains("google.com") -> "è°·æ­Œ"
                host.contains("bing.com") -> "å¿…åº”"
                host.contains("sogou.com") -> "æœç‹—"
                host.contains("360.cn") -> "360æœç´¢"
                else -> host.replace("www.", "").replace(".com", "").replace(".cn", "")
            }
        } catch (e: Exception) {
            "ç½‘é¡µ"
        }
    }

    /**
     * è®¾ç½®æµè§ˆå™¨å­—æ¯ç´¢å¼•æ 
     */
    private fun setupBrowserLetterIndexBar() {
        // è·å–æ‰€æœ‰æœç´¢å¼•æ“
        val allEngines = mutableListOf<com.example.aifloatingball.model.SearchEngine>()

        // æ·»åŠ é»˜è®¤æœç´¢å¼•æ“
        val defaultEngines = com.example.aifloatingball.model.SearchEngine.DEFAULT_ENGINES
        allEngines.addAll(defaultEngines)

        // è®¾ç½®å­—æ¯ç´¢å¼•æ 
        browserLetterIndexBar.engines = allEngines
        browserLetterIndexBar.onLetterSelectedListener = object : com.example.aifloatingball.view.LetterIndexBar.OnLetterSelectedListener {
            override fun onLetterSelected(view: View, letter: Char) {
                Log.d(TAG, "å­—æ¯ç´¢å¼•æ è¢«ç‚¹å‡»ï¼Œé€‰æ‹©å­—æ¯: $letter")
                updateBrowserEngineList(letter)
            }
        }
    }

    /**
     * æ›´æ–°æµè§ˆå™¨æœç´¢å¼•æ“åˆ—è¡¨
     */
    private fun updateBrowserEngineList(letter: Char) {
        browserLetterTitle.text = if (letter == '#') "å…¨éƒ¨" else letter.toString()

        // è·å–æ‰€æœ‰æœç´¢å¼•æ“
        val allEngines = mutableListOf<com.example.aifloatingball.model.SearchEngine>()
        val defaultEngines = com.example.aifloatingball.model.SearchEngine.DEFAULT_ENGINES
        allEngines.addAll(defaultEngines)

        // æ·»åŠ AIæœç´¢å¼•æ“
        try {
            val aiEngines = com.example.aifloatingball.model.AISearchEngine.DEFAULT_AI_ENGINES.map { aiEngine ->
                com.example.aifloatingball.model.SearchEngine(
                    name = aiEngine.name,
                    displayName = aiEngine.name,
                    url = aiEngine.url,
                    iconResId = aiEngine.iconResId,
                    description = aiEngine.description,
                    searchUrl = aiEngine.searchUrl ?: aiEngine.url,
                    isAI = true
                )
            }
            allEngines.addAll(aiEngines)
        } catch (e: Exception) {
            Log.w(TAG, "æ— æ³•åŠ è½½AIæœç´¢å¼•æ“: ${e.message}")
        }

        // è¿‡æ»¤æœç´¢å¼•æ“
        val filteredEngines = if (letter == '#') {
            // æ˜¾ç¤ºæ‰€æœ‰æœç´¢å¼•æ“
            allEngines
        } else {
            // è¿‡æ»¤ä»¥æŒ‡å®šå­—æ¯å¼€å¤´çš„å¼•æ“
            allEngines.filter { engine ->
                engine.name.uppercase().startsWith(letter.uppercase())
            }
        }

        // åˆ†ç±»æ˜¾ç¤ºæœç´¢å¼•æ“
        val aiEngines = filteredEngines.filter { it.isAI }
        val normalEngines = filteredEngines.filter { !it.isAI }
        val customEngines = filteredEngines.filter { it.isCustom }

        // æ˜¯å¦æ˜¾ç¤ºåˆ†ç±»æ ‡é¢˜
        val showCategory = true // é»˜è®¤æ˜¾ç¤ºåˆ†ç±»

        // æ›´æ–°RecyclerViewé€‚é…å™¨ï¼ŒæŒ‰åˆ†ç±»æ˜¾ç¤º
        if (::draggableEngineAdapter.isInitialized) {
            val categorizedEngines = mutableListOf<com.example.aifloatingball.model.SearchEngine>()
            
            // æ·»åŠ AIæœç´¢å¼•æ“
            if (aiEngines.isNotEmpty()) {
                categorizedEngines.addAll(aiEngines)
            }
            
            // æ·»åŠ æ™®é€šæœç´¢å¼•æ“
            if (normalEngines.isNotEmpty()) {
                categorizedEngines.addAll(normalEngines)
            }
            
            // æ·»åŠ è‡ªå®šä¹‰æœç´¢å¼•æ“
            if (customEngines.isNotEmpty()) {
                categorizedEngines.addAll(customEngines)
            }
            
            draggableEngineAdapter.updateEngines(categorizedEngines)
        }

        Log.d(TAG, "æ›´æ–°æœç´¢å¼•æ“åˆ—è¡¨: å­—æ¯=$letter, æ€»æ•°=${allEngines.size}, è¿‡æ»¤å=${filteredEngines.size}, AI=${aiEngines.size}, æ™®é€š=${normalEngines.size}, è‡ªå®šä¹‰=${customEngines.size}")
    }

    /**
     * åˆ›å»ºæµè§ˆå™¨æœç´¢å¼•æ“è§†å›¾
     */
    private fun createBrowserEngineView(engine: com.example.aifloatingball.model.SearchEngine): View {
        val engineView = layoutInflater.inflate(R.layout.item_search_engine_preview, null)

        val engineIcon = engineView.findViewById<ImageView>(R.id.engine_icon)
        val engineName = engineView.findViewById<TextView>(R.id.engine_name)
        val engineDescription = engineView.findViewById<TextView>(R.id.engine_description)

        // è®¾ç½®å¼•æ“ä¿¡æ¯
        engineName.text = engine.displayName
        engineDescription.text = engine.description

        // ä½¿ç”¨FaviconLoaderåŠ è½½æœç´¢å¼•æ“å›¾æ ‡
        com.example.aifloatingball.utils.FaviconLoader.loadIcon(
            engineIcon,
            engine.url,
            engine.iconResId
        )

        // è®¾ç½®ç‚¹å‡»ç›‘å¬å™¨
        engineView.setOnClickListener {
            // åˆ‡æ¢å½“å‰æœç´¢å¼•æ“
            currentSearchEngine = engine

            val query = browserSearchInput.text.toString().trim()
            
            if (query.isEmpty()) {
                // æ²¡æœ‰æŸ¥è¯¢å†…å®¹ï¼Œè·³è½¬åˆ°æœç´¢å¼•æ“é¦–é¡µ
                val baseUrl = engine.url.split("?")[0].replace("{query}", "")
                    .replace("search", "").replace("/s", "").replace("/search", "")
                loadBrowserContent(if (baseUrl.endsWith("/")) baseUrl else "$baseUrl/")
                browserLayout.closeDrawer(GravityCompat.START)
                updateSearchTabIcon()
                return@setOnClickListener
            }
            
            val lower = query.lowercase()
            
            // æ£€æŸ¥æ˜¯å¦ä¸ºç‰¹æ®Š schemeï¼ˆéœ€è¦å¤–éƒ¨åº”ç”¨æ‰“å¼€ï¼‰ï¼Œè¿™äº›åº”è¯¥å½“ä½œæœç´¢è¯è€Œä¸æ˜¯URL
            val isSpecialScheme = when {
                lower.startsWith("intent://") -> true
                lower.startsWith("clash://") -> true
                lower.startsWith("douban://") -> true
                lower.startsWith("baidumap://") -> true
                lower.startsWith("amap://") -> true
                lower.startsWith("alipay://") -> true
                lower.startsWith("wechat://") -> true
                lower.startsWith("weixin://") -> true
                lower.startsWith("qq://") -> true
                // å…¶ä»–å·²çŸ¥çš„ç‰¹æ®Š scheme
                lower.contains("://") && !lower.startsWith("http://") && 
                !lower.startsWith("https://") && !lower.startsWith("file://") -> true
                else -> false
            }
            
            // å¦‚æœæ˜¯ç‰¹æ®Š schemeï¼Œå½“ä½œæœç´¢è¯å¤„ç†ï¼ˆç±»ä¼¼ Chromeï¼‰
            if (isSpecialScheme) {
                Log.d(TAG, "æ£€æµ‹åˆ°ç‰¹æ®Š scheme '$query'ï¼Œå½“ä½œæœç´¢è¯å¤„ç†")
                val searchUrl = engine.getSearchUrl(query)
                loadBrowserContent(searchUrl)
                browserLayout.closeDrawer(GravityCompat.START)
                updateSearchTabIcon()
                return@setOnClickListener
            }

            // æ£€æŸ¥è¾“å…¥æ˜¯å¦ä¸ºURLï¼ˆé¿å…å°†URLä½œä¸ºæœç´¢å…³é”®è¯ï¼‰
            val isUrl = query.isNotEmpty() && (
                query.startsWith("http://") ||
                query.startsWith("https://") ||
                query.startsWith("file://") ||
                (query.contains(".") && !query.contains(" "))
            )

            val url = if (!isUrl) {
                // æœ‰æŸ¥è¯¢å†…å®¹ä¸”ä¸æ˜¯URLï¼Œä½¿ç”¨æœç´¢å¼•æ“æœç´¢
                engine.getSearchUrl(query)
            } else {
                // è¾“å…¥çš„æ˜¯URLï¼Œç¡®ä¿æœ‰åè®®å‰ç¼€
                when {
                    query.startsWith("http://") || query.startsWith("https://") || query.startsWith("file://") -> query
                    else -> "https://$query"
                }
            }

            loadBrowserContent(url)
            browserLayout.closeDrawer(GravityCompat.START)

            // æ›´æ–°æœç´¢tabå›¾æ ‡
            updateSearchTabIcon()

            Log.d(TAG, "é€‰æ‹©æœç´¢å¼•æ“: ${engine.name}, æŸ¥è¯¢: '$query', æ˜¯å¦URL: $isUrl, æœ€ç»ˆURL: $url")
        }

        return engineView
    }

    /**
     * åœ¨æ–°å¡ç‰‡ä¸­åŠ è½½URL
     */
    private fun loadUrlInNewCard(url: String, inBackground: Boolean = false) {
        Log.d(TAG, "åœ¨æ–°å¡ç‰‡ä¸­åŠ è½½URL: $url, åå°æ¨¡å¼: $inBackground")

        try {
            var newCard: GestureCardWebViewManager.WebViewCardData? = null

            // ä¼˜å…ˆä½¿ç”¨MobileCardManager
            if (mobileCardManager != null) {
                newCard = mobileCardManager?.addNewCard(url)
                Log.d(TAG, "ä½¿ç”¨MobileCardManageråˆ›å»ºæ–°å¡ç‰‡")
            } else {
                // ç¡®ä¿GestureCardWebViewManagerå·²åˆå§‹åŒ–
                if (gestureCardWebViewManager == null) {
                    setupBrowserWebView()
                }
                newCard = gestureCardWebViewManager?.addNewCard(url)
                Log.d(TAG, "ä½¿ç”¨GestureCardWebViewManageråˆ›å»ºæ–°å¡ç‰‡")
            }

            if (newCard != null) {
                Log.d(TAG, "æ–°å¡ç‰‡åˆ›å»ºæˆåŠŸ: ${newCard.id}")

                if (!inBackground) {
                    // å‰å°æ¨¡å¼ï¼šç«‹å³åˆ‡æ¢åˆ°æ–°å¡ç‰‡
                    showWebViewMode()
                } else {
                    // åå°æ¨¡å¼ï¼šä¸åˆ‡æ¢ï¼Œä¿æŒå½“å‰çŠ¶æ€
                    Toast.makeText(this, "å·²åœ¨åå°æ‰“å¼€æ–°é¡µé¢", Toast.LENGTH_SHORT).show()
                }
            } else {
                Log.e(TAG, "åˆ›å»ºæ–°å¡ç‰‡å¤±è´¥")
                Toast.makeText(this, "æ— æ³•æ‰“å¼€æ–°é¡µé¢", Toast.LENGTH_SHORT).show()
            }

        } catch (e: Exception) {
            Log.e(TAG, "åœ¨æ–°å¡ç‰‡ä¸­åŠ è½½URLæ—¶å‘ç”Ÿé”™è¯¯", e)
            Toast.makeText(this, "æ‰“å¼€é¡µé¢å¤±è´¥: ${e.message}", Toast.LENGTH_SHORT).show()
        }
    }

    /**
     * åœ¨å½“å‰å¡ç‰‡ä¸­åŠ è½½URL
     */
    private fun loadUrlInCurrentCard(url: String) {
        Log.d(TAG, "åœ¨å½“å‰å¡ç‰‡ä¸­åŠ è½½URL: $url")

        try {
            var loaded = false

            // ä¼˜å…ˆä½¿ç”¨MobileCardManager
            if (mobileCardManager != null) {
                mobileCardManager?.loadUrl(url)
                loaded = true
                Log.d(TAG, "ä½¿ç”¨MobileCardManageråœ¨å½“å‰å¡ç‰‡ä¸­åŠ è½½URL")
            } else if (gestureCardWebViewManager != null) {
                gestureCardWebViewManager?.loadUrl(url)
                loaded = true
                Log.d(TAG, "ä½¿ç”¨GestureCardWebViewManageråœ¨å½“å‰å¡ç‰‡ä¸­åŠ è½½URL")
            }

            if (loaded) {
                showWebViewMode()
            } else {
                // å¦‚æœæ²¡æœ‰å½“å‰å¡ç‰‡ï¼Œåˆ›å»ºæ–°å¡ç‰‡
                loadUrlInNewCard(url)
            }

        } catch (e: Exception) {
            Log.e(TAG, "åœ¨å½“å‰å¡ç‰‡ä¸­åŠ è½½URLæ—¶å‘ç”Ÿé”™è¯¯", e)
            // å›é€€åˆ°æ–°å»ºå¡ç‰‡
            loadUrlInNewCard(url)
        }
    }

    /**
     * æ˜¾ç¤ºWebViewæ¨¡å¼
     */
    private fun showWebViewMode() {
        // éšè—ä¸»é¡µå†…å®¹ï¼Œæ˜¾ç¤ºæ‰‹åŠ¿å¡ç‰‡å¼WebViewç•Œé¢
        browserHomeContent.visibility = View.GONE
        browserTabContainer.visibility = View.GONE

        // æ˜¾ç¤ºViewPager2
        showViewPager2()

        // æ˜¾ç¤ºå››åˆ†ä¹‹ä¸€åœ†å¼§æ“ä½œæ ï¼ˆåœ¨WebViewæ¨¡å¼ä¸‹éœ€è¦ï¼‰
        quarterArcOperationBar?.show()

        Log.d(TAG, "å·²åˆ‡æ¢åˆ°WebViewæ¨¡å¼")
    }

    private fun ensureFloatingVideoManager() {
        if (!::systemOverlayVideoManager.isInitialized) {
            systemOverlayVideoManager = SystemOverlayVideoManager(this)
        }
        if (!::floatingVideoManager.isInitialized) {
            floatingVideoManager = FloatingVideoPlayerManager(this)
            floatingVideoManager.attachIfNeeded()
        }
    }

    private fun injectVideoHookToWebView(webView: android.webkit.WebView?) {
        if (webView == null) return
        ensureFloatingVideoManager()

        try {
            // ä»…æ³¨å…¥ä¸€æ¬¡
            val tag = webView.getTag(R.id.tag_video_bridge_injected)
            if (tag != true) {
                webView.addJavascriptInterface(
                    VideoDetectionBridge { url, x, y, width, height, pageTitle ->
                        runOnUiThread {
                            try {
                                // åœæ­¢é¡µé¢å†…æ’­æ”¾å¹¶éšè—åŸè§†é¢‘ï¼Œé¿å…åŒå£°é“
                                webView.evaluateJavascript("(function(){var v=document.querySelector('video'); if(v){try{v.pause();v.muted=true;v.style.opacity='0';v.style.pointerEvents='none';}catch(e){}}})()", null)
                            } catch (_: Exception) {}

                            // ä¼˜å…ˆä½¿ç”¨ç³»ç»Ÿçº§æ‚¬æµ®çª—æ’­æ”¾å™¨
                            if (systemOverlayVideoManager.canDrawOverlays()) {
                                systemOverlayVideoManager.show(url, x, y, width, height, pageTitle)
                            } else {
                                // æ— æƒé™åˆ™æç¤ºå¹¶ä½¿ç”¨Activityå†…æ‚¬æµ®çª—ä½œä¸ºé™çº§
                                systemOverlayVideoManager.requestOverlayPermission()
                                floatingVideoManager.show(url)
                            }
                        }
                    },
                    "FloatingVideoBridge"
                )
                webView.setTag(R.id.tag_video_bridge_injected, true)
            }

            val js = """
                (function(){
                  if(window.__fv_injected) return; window.__fv_injected=true;
                  function getVideoUrl(v){
                    try{
                      var u = v.currentSrc || v.src || '';
                      if(!u){
                        var s = v.querySelector('source');
                        if(s) u = s.src || '';
                      }
                      if(!u){
                        var meta = document.querySelector('meta[property="og:video"],meta[property="og:video:url"],meta[name="og:video"],meta[name="og:video:url"]');
                        if(meta) u = meta.getAttribute('content')||'';
                      }
                      return u;
                    }catch(e){return ''}
                  }
                  function hook(v){
                    if(!v || v.__fv_hooked) return; v.__fv_hooked=true;
                    v.addEventListener('play', function(){
                      try{ var u=getVideoUrl(v); FloatingVideoBridge.onVideoPlay(u); }catch(e){}
                      try{ v.pause(); v.muted=true; v.style.opacity='0'; v.style.pointerEvents='none'; }catch(e){}
                    }, {passive:true});
                    // æ‹¦æˆªç‚¹å‡»ä¸»åŠ¨è§¦å‘
                    v.addEventListener('click', function(e){
                      e.preventDefault(); e.stopPropagation();
                      try{ var u=getVideoUrl(v); FloatingVideoBridge.onVideoPlay(u); }catch(err){}
                    }, true);
                  }
                  var vids = document.querySelectorAll('video');
                  vids.forEach(hook);
                  var obs = new MutationObserver(function(){
                     try{ document.querySelectorAll('video').forEach(hook); }catch(e){}
                  });
                  obs.observe(document.documentElement, {subtree:true, childList:true});
                })();
            """.trimIndent()
            webView.evaluateJavascript(js, null)
        } catch (e: Exception) {
            Log.e(TAG, "æ³¨å…¥è§†é¢‘æ£€æµ‹è„šæœ¬å¤±è´¥", e)
        }
    }

    /**
     * å¼ºåˆ¶åˆ·æ–°UIçŠ¶æ€ï¼Œç¡®ä¿æ‰€æœ‰ç»„ä»¶éƒ½å¤„äºæ­£ç¡®çŠ¶æ€
     */
    private fun forceRefreshUIState() {
        // æ£€æŸ¥ä¸¤ç§å¡ç‰‡ç®¡ç†å™¨æ˜¯å¦æœ‰å¡ç‰‡
        val hasGestureCards = gestureCardWebViewManager?.getAllCards()?.isNotEmpty() == true
        val hasMobileCards = mobileCardManager?.getAllCards()?.isNotEmpty() == true
        val hasCards = hasGestureCards || hasMobileCards

        Log.d(TAG, "å¼ºåˆ¶åˆ·æ–°UIçŠ¶æ€ï¼Œæ‰‹åŠ¿å¡ç‰‡: $hasGestureCards, æ‰‹æœºå¡ç‰‡: $hasMobileCards, æ€»è®¡æœ‰å¡ç‰‡: $hasCards")

        if (hasCards) {
            // WebViewæ¨¡å¼ï¼šæ˜¾ç¤ºå¡ç‰‡ï¼Œéšè—ä¸»é¡µ
            browserHomeContent.visibility = View.GONE
            browserTabContainer.visibility = View.GONE

            // æ˜¾ç¤ºViewPager2
            showViewPager2()

            // æ˜¾ç¤ºå››åˆ†ä¹‹ä¸€åœ†å¼§æ“ä½œæ 
            quarterArcOperationBar?.show()

            Log.d(TAG, "åˆ‡æ¢åˆ°WebViewæ¨¡å¼")
        } else {
            // ä¸»é¡µæ¨¡å¼ï¼šéšè—å¡ç‰‡ï¼Œæ˜¾ç¤ºä¸»é¡µ
            showBrowserHome()
            Log.d(TAG, "åˆ‡æ¢åˆ°ä¸»é¡µæ¨¡å¼")
        }
    }

    /**
     * é‡å†™è§¦æ‘¸äº‹ä»¶åˆ†å‘ï¼Œç¡®ä¿æŠ½å±‰æ‰“å¼€æ—¶ä¼˜å…ˆå¤„ç†æŠ½å±‰çš„è§¦æ‘¸äº‹ä»¶
     */
    override fun dispatchTouchEvent(ev: MotionEvent?): Boolean {
        if (ev == null) return super.dispatchTouchEvent(ev)

        // å¦‚æœæµè§ˆå™¨æŠ½å±‰å·²ç»æ‰“å¼€ï¼Œä¼˜å…ˆè®©æŠ½å±‰å¤„ç†è§¦æ‘¸äº‹ä»¶
        if (::browserLayout.isInitialized &&
            (browserLayout.isDrawerOpen(GravityCompat.START) || browserLayout.isDrawerOpen(GravityCompat.END))) {
            Log.d(TAG, "æŠ½å±‰å·²æ‰“å¼€ï¼Œä¼ é€’è§¦æ‘¸äº‹ä»¶ç»™æŠ½å±‰å¤„ç†")
            return super.dispatchTouchEvent(ev)
        }

        // æœ€é«˜ä¼˜å…ˆçº§ï¼šå¦‚æœStackedCardPreviewæ­£åœ¨æ˜¾ç¤ºï¼Œè®©StackedCardPreviewå¤„ç†è§¦æ‘¸äº‹ä»¶
        if (stackedCardPreview?.visibility == View.VISIBLE) {
            Log.d(TAG, "ğŸ”’ StackedCardPreviewå¯è§ï¼Œè®©StackedCardPreviewå¤„ç†è§¦æ‘¸äº‹ä»¶")
            return super.dispatchTouchEvent(ev)
        }

        // å¦‚æœåœ¨çº¸å †æ¨¡å¼ä¸‹ï¼Œä¼˜å…ˆå¤„ç†çº¸å †çš„è§¦æ‘¸äº‹ä»¶ï¼ˆä½†StackedCardPreviewä¼˜å…ˆçº§æ›´é«˜ï¼‰
        if (currentState == UIState.BROWSER && paperStackWebViewManager != null) {
            val paperStackLayout = findViewById<View>(R.id.paper_stack_layout)
            if (paperStackLayout?.visibility == View.VISIBLE) {
                val handled = paperStackWebViewManager?.onTouchEvent(ev) ?: false
                if (handled) {
                    Log.d(TAG, "çº¸å †æ¨¡å¼è§¦æ‘¸äº‹ä»¶å·²å¤„ç†")
                    return true
                }
                
                // å¦‚æœçº¸å †ç³»ç»Ÿæ²¡æœ‰æ ‡ç­¾é¡µï¼Œä½†è§¦æ‘¸äº‹ä»¶æ²¡æœ‰è¢«å¤„ç†ï¼Œå¯èƒ½æ˜¯æ»‘åŠ¨åˆ›å»ºæ–°æ ‡ç­¾é¡µ
                val tabCount = paperStackWebViewManager?.getTabCount() ?: 0
                if (tabCount == 0) {
                    Log.d(TAG, "çº¸å †ç³»ç»Ÿæ²¡æœ‰æ ‡ç­¾é¡µï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦åˆ›å»ºæ–°æ ‡ç­¾é¡µ")
                    // è¿™é‡Œå¯ä»¥æ·»åŠ åˆ›å»ºæ–°æ ‡ç­¾é¡µçš„é€»è¾‘
                }
            }
        }

        return super.dispatchTouchEvent(ev)
    }



    /**
     * å¤„ç†æƒé™è¯·æ±‚ç»“æœ
     */
    override fun onRequestPermissionsResult(requestCode: Int, permissions: Array<out String>, grantResults: IntArray) {
        super.onRequestPermissionsResult(requestCode, permissions, grantResults)
        when (requestCode) {
            1001 -> {
                if (grantResults.isNotEmpty() && grantResults[0] == PackageManager.PERMISSION_GRANTED) {
                    // æƒé™æˆäºˆåé‡æ–°æ£€æµ‹è¯­éŸ³æ”¯æŒæƒ…å†µ
                    detectAndUpdateVoiceSupport()
                    // å¦‚æœå½“å‰åœ¨è¯­éŸ³èƒ¶å›Šæ¨¡å¼ï¼Œè‡ªåŠ¨å¼€å§‹å½•éŸ³
                    if (isVoiceCapsuleMode) {
                        startAutoRecording()
                    } else {
                        startVoiceRecognition()
                    }
                } else {
                    voiceStatusText.text = "éœ€è¦å½•éŸ³æƒé™æ‰èƒ½ä½¿ç”¨è¯­éŸ³è¯†åˆ«"
                    // æƒé™è¢«æ‹’ç»åä¹Ÿé‡æ–°æ£€æµ‹ï¼Œå¯èƒ½æœ‰å…¶ä»–ä¸éœ€è¦æƒé™çš„æ–¹æ¡ˆ
                    detectAndUpdateVoiceSupport()
                }
            }
        }
    }

    /**
     * dpè½¬pxçš„æ‰©å±•å‡½æ•°
     */
    private fun Int.dpToPx(): Int {
        return (this * resources.displayMetrics.density).toInt()
    }

    /**
     * è®¾ç½®å¯¹è¯åŠŸèƒ½
     */
    private fun setupChat() {
        try {
            // åˆå§‹åŒ–å¯¹è¯ç›¸å…³çš„UIç»„ä»¶
            val chatSearchInput = findViewById<EditText>(R.id.chat_search_input)
            val chatAddContactButton = findViewById<ImageButton>(R.id.chat_add_contact_button)
            val chatTTSButton = findViewById<ImageButton>(R.id.simple_mode_tts_toggle_button)
            val chatAIAssistantButton = findViewById<ImageButton>(R.id.chat_ai_assistant_button)
            val chatTabLayout = findViewById<com.google.android.material.tabs.TabLayout>(R.id.chat_tab_layout)
            val chatContactsRecyclerView = findViewById<RecyclerView>(R.id.chat_contacts_recycler_view)

            // åˆå§‹åŒ–è”ç³»äººé€‚é…å™¨
            val chatContactAdapter = ChatContactAdapter(
                onContactClick = { contact ->
                    // å¤„ç†è”ç³»äººç‚¹å‡»äº‹ä»¶
                    openChatWithContact(contact)
                },
                onContactLongClick = { contact ->
                    // å¤„ç†è”ç³»äººé•¿æŒ‰äº‹ä»¶
                    Log.d(TAG, "SimpleModeActivityæ”¶åˆ°é•¿æŒ‰äº‹ä»¶: ${contact.name}")
                    showContactOptionsDialog(contact)
                    true
                },
                onContactDoubleClick = { contact ->
                    // å¤„ç†è”ç³»äººåŒå‡»äº‹ä»¶ - æ·»åŠ åˆ°å½“å‰æ ‡ç­¾é¡µ
                    addContactToCurrentTab(contact)
                    true
                },
                onCategoryLongClick = { category ->
                    // åªæœ‰åœ¨ç”¨æˆ·æ˜ç¡®é•¿æŒ‰åˆ†ç»„æ ‡é¢˜æ—¶æ‰æ˜¾ç¤ºç®¡ç†é€‰é¡¹
                    // é¿å…æ„å¤–è§¦å‘ç®¡ç†èœå•
                    if (category.name != "å…¨éƒ¨" && category.name != "æç¤º") {
                        showCategoryManagementDialog(category)
                    } else {
                        Log.d(TAG, "è·³è¿‡ç³»ç»Ÿåˆ†ç»„çš„é•¿æŒ‰ç®¡ç†: ${category.name}")
                    }
                    true
                },
                getContactGroup = { contact ->
                    // è·å–è”ç³»äººæ‰€åœ¨çš„åˆ†ç»„åç§°
                    findContactGroup(contact)
                }
            )

            // è®¾ç½®RecyclerView
            chatContactsRecyclerView?.apply {
                layoutManager = LinearLayoutManager(this@SimpleModeActivity)
                adapter = chatContactAdapter
            }

            // ä¿å­˜é€‚é…å™¨å¼•ç”¨
            this.chatContactAdapter = chatContactAdapter

            // è®¾ç½®æœç´¢åŠŸèƒ½ - å§‹ç»ˆé’ˆå¯¹æ‰€æœ‰AIåŠ©æ‰‹æé—®
            chatSearchInput?.setOnEditorActionListener { _, actionId, _ ->
                if (actionId == android.view.inputmethod.EditorInfo.IME_ACTION_SEARCH) {
                    val query = chatSearchInput.text.toString().trim()
                    if (query.isNotEmpty()) {
                        // è®°å½•æœç´¢å†å²
                        com.example.aifloatingball.manager.SearchHistoryAutoRecorder.recordSearchHistory(
                            context = this@SimpleModeActivity,
                            query = query,
                            source = com.example.aifloatingball.manager.SearchHistoryAutoRecorder.SearchSource.CHAT_TAB,
                            tags = listOf("AIå¯¹è¯"),
                            searchType = "AIå¯¹è¯"
                        )
                        // ç›´æ¥å¯åŠ¨å…¨å±€AIæœç´¢ï¼Œå‘æ‰€æœ‰AIåŠ©æ‰‹æé—®
                        startGlobalAISearch(query)
                        // æ¸…ç©ºæœç´¢æ¡†
                        chatSearchInput.text.clear()
                        // éšè—è¾“å…¥æ³•
                        hideKeyboard(chatSearchInput)
                    }
                    true
                } else {
                    false
                }
            }

            // è®¾ç½®è¾“å…¥æ¡†ç‚¹å‡»ç›‘å¬ï¼Œåªåœ¨ç”¨æˆ·ä¸»åŠ¨ç‚¹å‡»æ—¶æ‰æ¿€æ´»
            chatSearchInput?.setOnClickListener { view ->
                // ç”¨æˆ·ä¸»åŠ¨ç‚¹å‡»æ—¶ï¼Œå¯ç”¨ç„¦ç‚¹å¹¶æ˜¾ç¤ºé”®ç›˜
                view.isFocusable = true
                view.isFocusableInTouchMode = true
                view.requestFocus()
                showKeyboard(view as EditText)
            }

            // è®¾ç½®è¾“å…¥æ¡†ç„¦ç‚¹ç›‘å¬
            chatSearchInput?.setOnFocusChangeListener { view, hasFocus ->
                if (!hasFocus) {
                    // å¤±å»ç„¦ç‚¹æ—¶éšè—è¾“å…¥æ³•å¹¶ç¦ç”¨ç„¦ç‚¹
                    hideKeyboard(view)
                    view.isFocusable = false
                    view.isFocusableInTouchMode = false
                }
            }

            // æ·»åŠ å›è½¦é”®ç›‘å¬
            chatSearchInput?.setOnKeyListener { view, keyCode, event ->
                if (keyCode == android.view.KeyEvent.KEYCODE_ENTER && event.action == android.view.KeyEvent.ACTION_DOWN) {
                    val query = chatSearchInput.text.toString().trim()
                    if (query.isNotEmpty()) {
                        // è®°å½•æœç´¢å†å²
                        com.example.aifloatingball.manager.SearchHistoryAutoRecorder.recordSearchHistory(
                            context = this@SimpleModeActivity,
                            query = query,
                            source = com.example.aifloatingball.manager.SearchHistoryAutoRecorder.SearchSource.CHAT_TAB,
                            tags = listOf("AIå¯¹è¯"),
                            searchType = "AIå¯¹è¯"
                        )
                        // ç›´æ¥å¯åŠ¨å…¨å±€AIæœç´¢ï¼Œå‘æ‰€æœ‰AIåŠ©æ‰‹æé—®
                        startGlobalAISearch(query)
                        // æ¸…ç©ºæœç´¢æ¡†
                        chatSearchInput.text.clear()
                        // éšè—è¾“å…¥æ³•å¹¶æ¸…é™¤ç„¦ç‚¹
                        hideKeyboard(view)
                        view.clearFocus()
                    }
                    true
                } else {
                    false
                }
            }

            // è®¾ç½®æ·»åŠ è”ç³»äººæŒ‰é’®ï¼ˆå³ä¸Šè§’+å·ï¼‰
            chatAddContactButton?.setOnClickListener {
                // æ‰“å¼€AIè”ç³»äººåˆ—è¡¨ç•Œé¢
                openAIContactListActivity()
            }

            // è®¾ç½®TTSæœ—è¯»å¼€å…³æŒ‰é’®
            chatTTSButton?.setOnClickListener {
                // æ˜¾ç¤ºTTSè®¾ç½®å¯¹è¯æ¡†
                showSimpleModeTTSSettingsDialog()
            }

            // è®¾ç½®AIåŠ©æ‰‹æŒ‰é’®
            chatAIAssistantButton?.setOnClickListener {
                // æ˜¾ç¤ºAIåŠ©æ‰‹ä¸­å¿ƒ
                showAIAssistantCenter()
            }

            // å…ˆåŠ è½½è”ç³»äººæ•°æ®
            loadInitialContacts()

            // è®¾ç½®TabLayout - é‡æ–°è®¾è®¡é€»è¾‘
            chatTabLayout?.apply {
                // åŠ è½½ä¿å­˜çš„æ ‡ç­¾é¡ºåºï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤é¡ºåº
                loadTabsInOrder()

                // æ·»åŠ "+"æŒ‰é’®ç”¨äºåˆ›å»ºæ–°åˆ†ç»„
                addTab(newTab().setText("+").setIcon(R.drawable.ic_add))

                addOnTabSelectedListener(object : com.google.android.material.tabs.TabLayout.OnTabSelectedListener {
                    override fun onTabSelected(tab: com.google.android.material.tabs.TabLayout.Tab?) {
                        val newPosition = tab?.position ?: return
                        val chatContactsRecyclerView = findViewById<RecyclerView>(R.id.chat_contacts_recycler_view)

                        // å½“åˆ‡æ¢tabæ—¶ï¼Œéšè—æ‚¬æµ®å¡ç‰‡
                        stackedCardPreview?.let {
                            if (it.visibility == View.VISIBLE) {
                                it.visibility = View.GONE
                            }
                        }

                        // æ£€æŸ¥å¿…è¦çš„ç»„ä»¶æ˜¯å¦å­˜åœ¨
                        if (chatContactsRecyclerView == null || chatTabLayout == null) {
                            // å¦‚æœç»„ä»¶ä¸å­˜åœ¨ï¼Œç›´æ¥æ‰§è¡Œå†…å®¹åˆ‡æ¢ï¼Œä¸ä½¿ç”¨åŠ¨ç”»
                            executeTabContentSwitch(newPosition, tab)
                            currentTabPosition = newPosition
                            return
                        }

                        // æ‰§è¡Œæ ‡ç­¾åˆ‡æ¢åŠ¨ç”»
                        tabSwitchAnimationManager.animateTabSwitch(
                            recyclerView = chatContactsRecyclerView,
                            tabLayout = chatTabLayout!!,
                            fromPosition = currentTabPosition,
                            toPosition = newPosition
                        ) {
                            // åœ¨åŠ¨ç”»å›è°ƒä¸­æ‰§è¡Œå®é™…çš„å†…å®¹åˆ‡æ¢
                            executeTabContentSwitch(newPosition, tab)
                        }

                        // æ›´æ–°å½“å‰æ ‡ç­¾ä½ç½®
                        currentTabPosition = newPosition
                    }

                    override fun onTabUnselected(tab: com.google.android.material.tabs.TabLayout.Tab?) {}
                    override fun onTabReselected(tab: com.google.android.material.tabs.TabLayout.Tab?) {
                        try {
                            // åªæœ‰åœ¨æ ‡ç­¾é¡µåˆå§‹åŒ–å®Œæˆä¸”ä¸æ˜¯æ‹–æ‹½çŠ¶æ€æ—¶æ‰å¤„ç†åŒå‡»ç®¡ç†
                            if (!isTabsInitialized || isDraggingTabs) {
                                Log.d(TAG, "æ ‡ç­¾é¡µæœªåˆå§‹åŒ–å®Œæˆæˆ–æ­£åœ¨æ‹–æ‹½ï¼Œè·³è¿‡åŒå‡»ç®¡ç†")
                                return
                            }

                            // åŒå‡»æ ‡ç­¾é¡µè¿›è¡Œç®¡ç†
                            val tabText = tab?.text?.toString() ?: return

                            when (tabText) {
                                "å…¨éƒ¨" -> {
                                    // "å…¨éƒ¨"æ ‡ç­¾ - æ˜¾ç¤ºèšåˆè§†å›¾çš„ç®¡ç†é€‰é¡¹
                                    showAllTabManagement()
                                }
                                "AIåŠ©æ‰‹" -> {
                                    // "AIåŠ©æ‰‹"æ ‡ç­¾ - å¯ä»¥é‡å‘½åå’Œåˆ é™¤
                                    showAIAssistantGroupManagement(tab)
                                }
                                "+" -> {
                                    // +å·æŒ‰é’® - ä¸åšä»»ä½•æ“ä½œ
                                    Log.d(TAG, "+å·æŒ‰é’®è¢«é‡æ–°é€‰æ‹©")
                                }
                                else -> {
                                    // è‡ªå®šä¹‰åˆ†ç»„ - å¯ä»¥é‡å‘½åã€åˆ é™¤
                                    showCustomGroupManagement(tab)
                                }
                            }
                        } catch (e: Exception) {
                            Log.e(TAG, "åŒå‡»æ ‡ç­¾é¡µç®¡ç†å¤±è´¥", e)
                        }
                    }
                })

                // è®¾ç½®æ ‡ç­¾é¡µæ‹–åŠ¨æ’åºåŠŸèƒ½
                setupTabDragAndDrop(chatTabLayout)

                // é»˜è®¤é€‰ä¸­"å…¨éƒ¨"æ ‡ç­¾é¡µå¹¶æ˜¾ç¤ºå†…å®¹
                val allTab = chatTabLayout?.getTabAt(0)
                allTab?.select()

                // å»¶è¿Ÿä¸€ç‚¹æ—¶é—´ç¡®ä¿æ•°æ®åŠ è½½å®Œæˆåå†æ˜¾ç¤º
                Handler(Looper.getMainLooper()).postDelayed({
                    showAllUserAIContacts()
                    // æ ‡è®°æ ‡ç­¾é¡µåˆå§‹åŒ–å®Œæˆ
                    isTabsInitialized = true
                    Log.d(TAG, "æ ‡ç­¾é¡µåˆå§‹åŒ–å®Œæˆ")
                }, 100)
            }

            Log.d(TAG, "å¯¹è¯åŠŸèƒ½åˆå§‹åŒ–å®Œæˆ")
        } catch (e: Exception) {
            Log.e(TAG, "è®¾ç½®å¯¹è¯åŠŸèƒ½å¤±è´¥", e)
        }
    }

    /**
     * è®¾ç½®APIå¯†é’¥åŒæ­¥å¹¿æ’­æ¥æ”¶å™¨
     */
    private fun setupApiKeySyncReceiver() {
        try {
            apiKeySyncReceiver = object : BroadcastReceiver() {
                override fun onReceive(context: Context?, intent: Intent?) {
                    try {
                        when (intent?.action) {
                            "com.example.aifloatingball.SETTINGS_API_KEY_UPDATED" -> {
                                val serviceName = intent.getStringExtra("service_name") ?: return
                                val apiKey = intent.getStringExtra("api_key") ?: return

                                Log.d(TAG, "æ”¶åˆ°è®¾ç½®åŒæ­¥å¹¿æ’­: $serviceName")

                                // æ›´æ–°è”ç³»äººåˆ—è¡¨ä¸­çš„APIå¯†é’¥
                                updateExistingContactApiKey(serviceName, apiKey)

                                // å¦‚æœè¯¥AIè¿˜ä¸å­˜åœ¨ï¼Œè‡ªåŠ¨æ·»åŠ å®ƒ
                                addAIIfNotExists(serviceName, apiKey)
                            }
                        }
                    } catch (e: Exception) {
                        Log.e(TAG, "å¤„ç†APIå¯†é’¥åŒæ­¥å¹¿æ’­å¤±è´¥", e)
                    }
                }
            }

            // æ³¨å†Œå¹¿æ’­æ¥æ”¶å™¨
            val filter = IntentFilter().apply {
                addAction("com.example.aifloatingball.SETTINGS_API_KEY_UPDATED")
            }
            if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.TIRAMISU) {
                registerReceiver(apiKeySyncReceiver, filter, Context.RECEIVER_NOT_EXPORTED)
            } else {
                registerReceiver(apiKeySyncReceiver, filter)
            }

            Log.d(TAG, "APIå¯†é’¥åŒæ­¥å¹¿æ’­æ¥æ”¶å™¨å·²æ³¨å†Œ")

        } catch (e: Exception) {
            Log.e(TAG, "è®¾ç½®APIå¯†é’¥åŒæ­¥å¹¿æ’­æ¥æ”¶å™¨å¤±è´¥", e)
        }
    }

    /**
     * å¦‚æœAIä¸å­˜åœ¨åˆ™è‡ªåŠ¨æ·»åŠ 
     */
    private fun addAIIfNotExists(serviceName: String, apiKey: String) {
        try {
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è¯¥AI
            var exists = false
            for (category in allContacts) {
                for (contact in category.contacts) {
                    if (contact.name.equals(serviceName, ignoreCase = true)) {
                        exists = true
                        break
                    }
                }
                if (exists) break
            }

            if (!exists && apiKey.isNotBlank()) {
                // è‡ªåŠ¨æ·»åŠ è¯¥AI
                val description = when (serviceName.lowercase()) {
                    "deepseek" -> "ğŸš€ DeepSeek - æ€§èƒ½å¼ºåŠ²ï¼Œæ”¯æŒä¸­æ–‡"
                    "æ™ºè°±ai" -> "ğŸ§  æ™ºè°±AI - GLM-4å¤§è¯­è¨€æ¨¡å‹"
                    "chatgpt" -> "ğŸ¤– ChatGPT - OpenAIçš„ç»å…¸æ¨¡å‹"
                    "claude" -> "ğŸ’¡ Claude - Anthropicçš„æ™ºèƒ½åŠ©æ‰‹"
                    "gemini" -> "ğŸŒŸ Gemini - Googleçš„AIåŠ©æ‰‹"
                    "kimi" -> "ğŸŒ™ Kimi - Moonshotçš„é•¿æ–‡æœ¬ä¸“å®¶"
                    "æ–‡å¿ƒä¸€è¨€" -> "ğŸ“š æ–‡å¿ƒä¸€è¨€ - ç™¾åº¦çš„å¤§è¯­è¨€æ¨¡å‹"
                    "é€šä¹‰åƒé—®" -> "ğŸ¯ é€šä¹‰åƒé—® - é˜¿é‡Œå·´å·´çš„AI"
                    "è®¯é£æ˜Ÿç«" -> "âš¡ è®¯é£æ˜Ÿç« - ç§‘å¤§è®¯é£çš„AI"
                    else -> "${serviceName}AIåŠ©æ‰‹"
                }

                addAIContactToCategory(serviceName, description, apiKey)

                runOnUiThread {
                    Toast.makeText(this, "${serviceName}å·²è‡ªåŠ¨æ·»åŠ åˆ°å¯¹è¯åˆ—è¡¨", Toast.LENGTH_SHORT).show()
                }

                Log.d(TAG, "ä»è®¾ç½®è‡ªåŠ¨æ·»åŠ AI: $serviceName")
            }

        } catch (e: Exception) {
            Log.e(TAG, "è‡ªåŠ¨æ·»åŠ AIå¤±è´¥", e)
        }
    }

    /**
     * æ‰§è¡Œå¯¹è¯æœç´¢
     */
    private fun performChatSearch(query: String) {
        try {
            if (query.trim().isEmpty()) {
                // å¦‚æœæœç´¢å†…å®¹ä¸ºç©ºï¼Œæ˜¾ç¤ºæ‰€æœ‰è”ç³»äººï¼ˆä¸è¿›è¡ŒAIæœç´¢ï¼‰
                chatContactAdapter?.searchContacts("")
                return
            }

            // å¯¹è¯tabçš„æœç´¢æ¡†å§‹ç»ˆé’ˆå¯¹æ‰€æœ‰AIåŠ©æ‰‹æé—®ï¼Œè€Œä¸æ˜¯è¿‡æ»¤AIåç§°
            // å¯åŠ¨å…¨å±€æœç´¢ï¼ˆå‘æ‰€æœ‰AIæé—®ï¼‰
            startGlobalAISearch(query)

            Log.d(TAG, "æ‰§è¡Œå¯¹è¯æœç´¢: $query")
        } catch (e: Exception) {
            Log.e(TAG, "æœç´¢å¤±è´¥", e)
        }
    }

    /**
     * å¯åŠ¨AIåˆ†ç»„æœç´¢ï¼ˆæ ¹æ®å½“å‰æ ‡ç­¾é¡µå‘å¯¹åº”AIæé—®ï¼‰
     */
    private fun startGlobalAISearch(query: String) {
        try {
            // è·å–å½“å‰é€‰ä¸­çš„æ ‡ç­¾é¡µ
            val chatTabLayout = findViewById<com.google.android.material.tabs.TabLayout>(R.id.chat_tab_layout)
            val currentTabPosition = chatTabLayout?.selectedTabPosition ?: 0
            val currentTabName = chatTabLayout?.getTabAt(currentTabPosition)?.text?.toString()

            // æ ¹æ®å½“å‰æ ‡ç­¾é¡µè·å–å¯¹åº”çš„AIåˆ—è¡¨
            val availableAIs = getAIsForCurrentTab(currentTabPosition, currentTabName)

            Log.d(TAG, "å½“å‰æ ‡ç­¾é¡µAIæœç´¢: æ ‡ç­¾é¡µ=$currentTabPosition, åç§°=$currentTabName, AIæ•°é‡=${availableAIs.size}")

            if (availableAIs.isEmpty()) {
                val message = when (currentTabPosition) {
                    0 -> "æ²¡æœ‰æ‰¾åˆ°å·²é…ç½®çš„AIåŠ©æ‰‹ï¼Œè¯·å…ˆæ·»åŠ å¹¶é…ç½®AIåŠ©æ‰‹"
                    1 -> "AIåŠ©æ‰‹åˆ†ç»„ä¸ºç©ºï¼Œè¯·å°†AIç§»åŠ¨åˆ°æ­¤åˆ†ç»„"
                    else -> {
                        if (currentTabName != null && currentTabName != "+") {
                            "åˆ†ç»„ \"$currentTabName\" ä¸­æ²¡æœ‰AIåŠ©æ‰‹ï¼Œè¯·æ·»åŠ AIåˆ°æ­¤åˆ†ç»„"
                        } else {
                            "è¯·å…ˆé…ç½®AIåŠ©æ‰‹çš„APIå¯†é’¥"
                        }
                    }
                }
                Toast.makeText(this, message, Toast.LENGTH_SHORT).show()
                return
            }

            // æ˜¾ç¤ºæœç´¢èŒƒå›´æç¤º
            val searchScope = when (currentTabPosition) {
                0 -> "æ‰€æœ‰AIåŠ©æ‰‹"
                1 -> "AIåŠ©æ‰‹åˆ†ç»„"
                else -> {
                    if (currentTabName != null && currentTabName != "+") {
                        "åˆ†ç»„ \"$currentTabName\""
                    } else {
                        "å½“å‰åˆ†ç»„"
                    }
                }
            }
            Toast.makeText(this, "æ­£åœ¨${searchScope}ä¸­æœç´¢ï¼š$query", Toast.LENGTH_SHORT).show()

            // åˆ›å»ºæˆ–æ‰“å¼€å…¨å±€æœç´¢å¯¹è¯
            openGlobalSearchChat(query, availableAIs)

        } catch (e: Exception) {
            Log.e(TAG, "å¯åŠ¨å…¨å±€AIæœç´¢å¤±è´¥", e)
            Toast.makeText(this, "æœç´¢å¤±è´¥ï¼Œè¯·é‡è¯•", Toast.LENGTH_SHORT).show()
        }
    }



    /**
     * è·å–ç½®é¡¶çš„å¯ç”¨çš„AIåŠ©æ‰‹
     */
    private fun getPinnedAvailableAIs(): List<ChatContact> {
        val availableAIs = mutableListOf<ChatContact>()
        Log.d(TAG, "getPinnedAvailableAIs: å¼€å§‹æŸ¥æ‰¾å¯ç”¨AIï¼Œæ€»åˆ†ç±»æ•°: ${allContacts.size}")
        
        allContacts.forEach { category ->
            Log.d(TAG, "getPinnedAvailableAIs: æ£€æŸ¥åˆ†ç±»: ${category.name}, è”ç³»äººæ•°: ${category.contacts.size}")
            if (category.name == "AIåŠ©æ‰‹") {
                Log.d(TAG, "getPinnedAvailableAIs: æ‰¾åˆ°AIåŠ©æ‰‹åˆ†ç±»ï¼Œè”ç³»äººæ•°: ${category.contacts.size}")
                category.contacts.forEach { contact ->
                    Log.d(TAG, "getPinnedAvailableAIs: æ£€æŸ¥AI: ${contact.name}, isPinned: ${contact.isPinned}")
                    val isPinned = isPinnedAIContact(contact)
                    val hasValidKey = hasValidApiKey(contact)
                    Log.d(TAG, "getPinnedAvailableAIs: AI ${contact.name} - isPinnedAIContact: $isPinned, hasValidApiKey: $hasValidKey")
                    
                    // æ£€æŸ¥æ˜¯å¦ä¸ºç½®é¡¶çš„AIè”ç³»äººï¼ˆé€šè¿‡åç§°æˆ–å…¶ä»–æ ‡è¯†ï¼‰
                    if (isPinned && hasValidKey) {
                        availableAIs.add(contact)
                        Log.d(TAG, "getPinnedAvailableAIs: æ·»åŠ å¯ç”¨AI: ${contact.name}")
                    } else {
                        Log.d(TAG, "getPinnedAvailableAIs: è·³è¿‡AI: ${contact.name} (isPinned: $isPinned, hasValidKey: $hasValidKey)")
                    }
                }
            }
        }
        
        Log.d(TAG, "getPinnedAvailableAIs: æœ€ç»ˆå¯ç”¨AIæ•°é‡: ${availableAIs.size}")
        availableAIs.forEach { ai ->
            Log.d(TAG, "getPinnedAvailableAIs: å¯ç”¨AI: ${ai.name}")
        }
        
        return availableAIs
    }

    /**
     * åˆ¤æ–­æ˜¯å¦ä¸ºç½®é¡¶çš„AIè”ç³»äºº
     */
    private fun isPinnedAIContact(contact: ChatContact): Boolean {
        // è¿™é‡Œå¯ä»¥æ ¹æ®å®é™…éœ€æ±‚æ¥åˆ¤æ–­å“ªäº›AIæ˜¯ç½®é¡¶çš„
        // æš‚æ—¶è¿”å›trueï¼Œè¡¨ç¤ºæ‰€æœ‰AIéƒ½æ˜¯å¯ç”¨çš„
        return true
    }

    /**
     * æ‰§è¡Œå…¨å±€æœç´¢ - ç›´æ¥å¼€å§‹æœç´¢ï¼Œä¸æ˜¾ç¤ºå¼¹çª—
     */
    private fun openGlobalSearchChat(query: String, availableAIs: List<ChatContact>) {
        try {
            if (availableAIs.isEmpty()) {
                Toast.makeText(this, "æ²¡æœ‰æ‰¾åˆ°å·²é…ç½®çš„AIåŠ©æ‰‹", Toast.LENGTH_SHORT).show()
                return
            }

            // ç›´æ¥å¼€å§‹å…¨å±€æœç´¢ï¼Œä¸æ˜¾ç¤ºå¼¹çª—
            startGlobalSearchDirectly(query, availableAIs)

        } catch (e: Exception) {
            Log.e(TAG, "æ‰§è¡Œå…¨å±€æœç´¢å¤±è´¥", e)
            Toast.makeText(this, "æœç´¢å¤±è´¥ï¼Œè¯·é‡è¯•", Toast.LENGTH_SHORT).show()
        }
    }

    /**
     * æ˜¾ç¤ºå…¨å±€æœç´¢è¿›åº¦å¯¹è¯æ¡†
     */
    private fun showGlobalSearchProgressDialog(query: String, availableAIs: List<ChatContact>) {
        try {
            // åˆ›å»ºè‡ªå®šä¹‰å¸ƒå±€
            val dialogLayout = LinearLayout(this).apply {
                orientation = LinearLayout.VERTICAL
                setPadding(40, 30, 40, 30)
            }

            // æ ‡é¢˜
            val titleText = TextView(this).apply {
                text = "ğŸ” å…¨å±€AIæœç´¢è¿›åº¦"
                textSize = 18f
                setTextColor(getColor(R.color.simple_mode_text_primary_light))
                setPadding(0, 0, 0, 20)
                gravity = android.view.Gravity.CENTER
            }
            dialogLayout.addView(titleText)

            // é—®é¢˜æ˜¾ç¤º
            val questionText = TextView(this).apply {
                text = "é—®é¢˜ï¼š\"$query\""
                textSize = 14f
                setTextColor(getColor(R.color.simple_mode_text_primary_light))
                setPadding(20, 10, 20, 10)
                background = getDrawable(R.drawable.search_box_background)
            }
            dialogLayout.addView(questionText)

            // é—´è·
            val spacer = View(this).apply {
                layoutParams = LinearLayout.LayoutParams(0, 20)
            }
            dialogLayout.addView(spacer)

            // AIè¿›åº¦åˆ—è¡¨å®¹å™¨
            val progressContainer = LinearLayout(this).apply {
                orientation = LinearLayout.VERTICAL
            }
            dialogLayout.addView(progressContainer)

            // ä¸ºæ¯ä¸ªAIåˆ›å»ºè¿›åº¦å¡ç‰‡
            val progressCards = mutableMapOf<String, LinearLayout>()
            availableAIs.forEach { aiContact ->
                val progressCard = createAIProgressCard(aiContact, progressContainer)
                progressCards[aiContact.id] = progressCard
            }

            // åˆ›å»ºå¯¹è¯æ¡†
            val dialog = AlertDialog.Builder(this)
                .setView(dialogLayout)
                .setNegativeButton("å…³é—­", null)
                .create()

            dialog.show()

            // å¼€å§‹å‘æ‰€æœ‰AIå‘é€æŸ¥è¯¢
            startGlobalSearch(query, availableAIs, progressCards, dialog)

        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºå…¨å±€æœç´¢è¿›åº¦å¯¹è¯æ¡†å¤±è´¥", e)
        }
    }

    /**
     * åˆ›å»ºAIè¿›åº¦å¡ç‰‡
     */
    private fun createAIProgressCard(aiContact: ChatContact, container: LinearLayout): LinearLayout {
        val cardLayout = LinearLayout(this).apply {
            orientation = LinearLayout.HORIZONTAL
            setPadding(15, 15, 15, 15)
            background = getDrawable(R.drawable.search_box_background)
            val layoutParams = LinearLayout.LayoutParams(
                LinearLayout.LayoutParams.MATCH_PARENT,
                LinearLayout.LayoutParams.WRAP_CONTENT
            )
            layoutParams.setMargins(0, 0, 0, 10)
            setLayoutParams(layoutParams)
        }

        // AIå¤´åƒå’Œåç§°
        val aiNameText = TextView(this).apply {
            text = aiContact.name
            textSize = 14f
            setTextColor(getColor(R.color.simple_mode_text_primary_light))
            layoutParams = LinearLayout.LayoutParams(0, LinearLayout.LayoutParams.WRAP_CONTENT, 1f)
        }
        cardLayout.addView(aiNameText)

        // çŠ¶æ€æŒ‡ç¤º
        val statusText = TextView(this).apply {
            text = "â³ å‡†å¤‡ä¸­..."
            textSize = 12f
            setTextColor(getColor(R.color.simple_mode_text_secondary_light))
            gravity = android.view.Gravity.END
        }
        cardLayout.addView(statusText)

        // ç‚¹å‡»æŸ¥çœ‹å¯¹è¯
        cardLayout.setOnClickListener {
            val intent = Intent(this@SimpleModeActivity, ChatActivity::class.java).apply {
                putExtra(ChatActivity.EXTRA_CONTACT, aiContact)
            }
            startActivity(intent)
        }

        container.addView(cardLayout)
        return cardLayout
    }

    /**
     * ç›´æ¥å¼€å§‹å…¨å±€æœç´¢ï¼Œä¸æ˜¾ç¤ºå¼¹çª—
     */
    private fun startGlobalSearchDirectly(query: String, availableAIs: List<ChatContact>) {
        try {
            availableAIs.forEach { aiContact ->
                lifecycleScope.launch {
                    try {
                        // åœ¨åå°å‘AIå‘é€æ¶ˆæ¯
                        sendMessageToAIInBackground(aiContact, query)
                    } catch (e: Exception) {
                        Log.e(TAG, "å‘AI ${aiContact.name} å‘é€æ¶ˆæ¯å¤±è´¥", e)
                    }
                }
            }

            // æ˜¾ç¤ºç®€å•çš„æç¤º
            Toast.makeText(this, "å·²å‘ ${availableAIs.size} ä¸ªAIåŠ©æ‰‹å‘é€é—®é¢˜ï¼Œè¯·æŸ¥çœ‹å„AIçš„å›å¤", Toast.LENGTH_LONG).show()

        } catch (e: Exception) {
            Log.e(TAG, "å¼€å§‹å…¨å±€æœç´¢å¤±è´¥", e)
        }
    }

    /**
     * å¼€å§‹å…¨å±€æœç´¢ï¼ˆå¸¦å¼¹çª—ç‰ˆæœ¬ï¼‰
     */
    private fun startGlobalSearch(query: String, availableAIs: List<ChatContact>,
                                 progressCards: Map<String, LinearLayout>, dialog: AlertDialog) {
        try {
            var completedCount = 0
            val totalCount = availableAIs.size

            availableAIs.forEach { aiContact ->
                lifecycleScope.launch {
                    try {
                        // æ›´æ–°çŠ¶æ€ï¼šå‘é€ä¸­
                        runOnUiThread {
                            updateProgressCard(progressCards[aiContact.id], "ğŸš€ å‘é€ä¸­...")
                        }

                        // å‘AIçš„å¯¹è¯ä¸­å‘é€æ¶ˆæ¯ï¼ˆåå°å¤„ç†ï¼‰
                        sendMessageToAIInBackground(aiContact, query)

                        // æ¨¡æ‹Ÿä¸€ä¸ªçŸ­æš‚å»¶è¿Ÿ
                        delay(1000)

                        // æ›´æ–°çŠ¶æ€ï¼šå·²å‘é€
                        runOnUiThread {
                            updateProgressCard(progressCards[aiContact.id], "âœ… å·²å‘é€ï¼Œç‚¹å‡»æŸ¥çœ‹å›å¤")
                        }

                    } catch (e: Exception) {
                        runOnUiThread {
                            updateProgressCard(progressCards[aiContact.id], "âŒ å‘é€å¤±è´¥")
                        }
                    }

                    completedCount++
                    if (completedCount >= totalCount) {
                        runOnUiThread {
                            // æ‰€æœ‰AIéƒ½å·²å‘é€å®Œæˆ
                            dialog.setTitle("ğŸ‰ æœç´¢å®Œæˆ - ç‚¹å‡»AIæŸ¥çœ‹å›å¤")
                        }
                    }
                }
            }

        } catch (e: Exception) {
            Log.e(TAG, "å¼€å§‹å…¨å±€æœç´¢å¤±è´¥", e)
        }
    }

    /**
     * æ›´æ–°è¿›åº¦å¡ç‰‡çŠ¶æ€
     */
    private fun updateProgressCard(cardLayout: LinearLayout?, status: String) {
        try {
            cardLayout?.let { card ->
                val statusText = card.getChildAt(1) as TextView
                statusText.text = status
            }
        } catch (e: Exception) {
            Log.e(TAG, "æ›´æ–°è¿›åº¦å¡ç‰‡å¤±è´¥", e)
        }
    }

    /**
     * åœ¨åå°å‘AIå‘é€æ¶ˆæ¯
     */
    private suspend fun sendMessageToAIInBackground(aiContact: ChatContact, query: String) {
        withContext(Dispatchers.IO) {
            try {
                // è·å–AIæœåŠ¡ç±»å‹
                val serviceType = getAIServiceType(aiContact)
                if (serviceType != null) {
                    // ä¸´æ—¶ä¸“çº¿ä¸éœ€è¦APIå¯†é’¥éªŒè¯
                    val isTempService = serviceType == AIServiceType.TEMP_SERVICE
                    val apiKey = if (isTempService) "" else getApiKeyForService(serviceType)
                    
                    if (isTempService || apiKey.isNotBlank()) {
                        // å‡†å¤‡å¯¹è¯å†å²ï¼ˆè¿™é‡Œå¯ä»¥åŠ è½½å·²æœ‰çš„èŠå¤©è®°å½•ï¼‰
                        val conversationHistory = listOf(
                            mapOf("role" to "user", "content" to query)
                        )

                        // è°ƒç”¨AI APIå‘é€æ¶ˆæ¯
                        val response = sendMessageToAI(serviceType, query, conversationHistory, apiKey)

                        // ä½¿ç”¨ç»Ÿä¸€çš„ChatDataManagerä¿å­˜èŠå¤©è®°å½•
                        val chatDataManager = com.example.aifloatingball.data.ChatDataManager.getInstance(this@SimpleModeActivity)

                        // è·å–æˆ–åˆ›å»ºä¼šè¯IDï¼ˆä½¿ç”¨AIè”ç³»äººIDä½œä¸ºä¼šè¯æ ‡è¯†ï¼‰
                        val sessionId = aiContact.id
                        chatDataManager.setCurrentSessionId(sessionId, serviceType)

                        // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯å’ŒAIå›å¤
                        chatDataManager.addMessage(sessionId, "user", query, serviceType)
                        chatDataManager.addMessage(sessionId, "assistant", response, serviceType)

                        // æ›´æ–°è”ç³»äººçš„æœ€åæ¶ˆæ¯
                        runOnUiThread {
                            val formattedResponse = formatAIResponseWithPlatformIcons(response, query)
                            updateContactLastMessage(aiContact, formattedResponse)
                            
                            // è‡ªåŠ¨æœ—è¯»AIå›å¤
                            speakAIResponse(response)
                        }
                    } else {
                        // æ²¡æœ‰APIå¯†é’¥ï¼Œä½¿ç”¨æ¨¡æ‹Ÿå›å¤
                        val mockResponse = generateMockResponse(aiContact.name, query)
                        runOnUiThread {
                            updateContactLastMessage(aiContact, mockResponse)
                            
                            // è‡ªåŠ¨æœ—è¯»AIå›å¤
                            speakAIResponse(mockResponse)
                        }
                    }
                } else {
                    // æ— æ³•è¯†åˆ«AIæœåŠ¡ç±»å‹ï¼Œä½¿ç”¨æ¨¡æ‹Ÿå›å¤
                    val mockResponse = generateMockResponse(aiContact.name, query)
                    runOnUiThread {
                        updateContactLastMessage(aiContact, mockResponse)
                        
                        // è‡ªåŠ¨æœ—è¯»AIå›å¤
                        speakAIResponse(mockResponse)
                    }
                }

            } catch (e: Exception) {
                Log.e(TAG, "åå°å‘é€æ¶ˆæ¯åˆ°${aiContact.name}å¤±è´¥", e)
                // å‘ç”Ÿé”™è¯¯æ—¶ï¼Œä½¿ç”¨æ¨¡æ‹Ÿå›å¤
                val mockResponse = "æŠ±æ­‰ï¼Œæˆ‘æš‚æ—¶æ— æ³•å›ç­”æ‚¨çš„é—®é¢˜ã€‚è¯·ç¨åå†è¯•æˆ–æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚"
                runOnUiThread {
                    updateContactLastMessage(aiContact, mockResponse)
                    
                    // è‡ªåŠ¨æœ—è¯»AIå›å¤
                    speakAIResponse(mockResponse)
                }
            }
        }
    }

    /**
     * ç”Ÿæˆæ¨¡æ‹Ÿå›å¤
     */
    private fun generateMockResponse(aiName: String, query: String): String {
        val responses = mapOf(
            "DeepSeek" to "åŸºäºæ·±åº¦å­¦ä¹ æŠ€æœ¯ï¼Œæˆ‘è®¤ä¸ºè¿™ä¸ªé—®é¢˜å¯ä»¥ä»ä»¥ä¸‹å‡ ä¸ªè§’åº¦æ¥åˆ†æï¼š1) æŠ€æœ¯å±‚é¢... 2) å®è·µå±‚é¢... 3) åº”ç”¨å±‚é¢...",
            "æ™ºè°±AI" to "ä½œä¸ºGLM-4æ¨¡å‹ï¼Œæˆ‘å»ºè®®ä»ç†è®ºå’Œå®è·µä¸¤ä¸ªå±‚é¢æ¥ç†è§£è¿™ä¸ªé—®é¢˜ã€‚é¦–å…ˆä»ç†è®ºåŸºç¡€è¯´èµ·...",
            "ChatGPT" to "æ ¹æ®æˆ‘çš„è®­ç»ƒæ•°æ®å’Œç†è§£ï¼Œè¿™ä¸ªé—®é¢˜çš„æ ¸å¿ƒåœ¨äº... è®©æˆ‘ä¸ºæ‚¨è¯¦ç»†åˆ†æä¸€ä¸‹ç›¸å…³è¦ç‚¹...",
            "Claude" to "æˆ‘å¾ˆä¹æ„å¸®åŠ©æ‚¨åˆ†æè¿™ä¸ªé—®é¢˜ã€‚è®©æˆ‘ä»ä¸åŒç»´åº¦æ¥çœ‹ï¼šå®‰å…¨æ€§ã€å®ç”¨æ€§ã€å¯è¡Œæ€§...",
            "Gemini" to "è¿™æ˜¯ä¸€ä¸ªå¾ˆæœ‰è¶£çš„é—®é¢˜ï¼è®©æˆ‘æ¥ä¸ºæ‚¨è¯¦ç»†åˆ†æä¸€ä¸‹å„ä¸ªæ–¹é¢çš„è€ƒé‡å› ç´ ...",
            "Kimi" to "åˆ©ç”¨æˆ‘çš„é•¿æ–‡æœ¬å¤„ç†èƒ½åŠ›ï¼Œæˆ‘å¯ä»¥ä¸ºæ‚¨æä¾›å…¨é¢çš„è§£ç­”ã€‚é¦–å…ˆæˆ‘ä»¬æ¥çœ‹é—®é¢˜çš„èƒŒæ™¯...",
            "æ–‡å¿ƒä¸€è¨€" to "ä»ä¸­æ–‡è¯­å¢ƒçš„è§’åº¦æ¥çœ‹ï¼Œè¿™ä¸ªé—®é¢˜æ¶‰åŠåˆ°å¤šä¸ªå±‚é¢çš„è€ƒè™‘ï¼ŒåŒ…æ‹¬æ–‡åŒ–ã€æŠ€æœ¯ã€å®è·µç­‰æ–¹é¢...",
            "é€šä¹‰åƒé—®" to "ç»¼åˆå¤šæ–¹é¢ä¿¡æ¯ï¼Œæˆ‘çš„åˆ†æå¦‚ä¸‹ï¼šè¿™ä¸ªé—®é¢˜éœ€è¦ä»ç³»ç»Ÿæ€§çš„è§’åº¦æ¥æ€è€ƒ...",
            "è®¯é£æ˜Ÿç«" to "ç»“åˆè¯­éŸ³å’Œæ–‡æœ¬ç†è§£æŠ€æœ¯ï¼Œæˆ‘è®¤ä¸ºè¿™ä¸ªé—®é¢˜çš„è§£å†³éœ€è¦ç»¼åˆè€ƒè™‘å¤šä¸ªå› ç´ ..."
        )

        return responses[aiName] ?: "æ„Ÿè°¢æ‚¨çš„æé—®ï¼é’ˆå¯¹\"$query\"è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘æ­£åœ¨ä¸ºæ‚¨å‡†å¤‡è¯¦ç»†çš„å›ç­”ã€‚åŸºäºæˆ‘çš„ç†è§£ï¼Œè¿™æ¶‰åŠå¤šä¸ªæ–¹é¢çš„è€ƒè™‘..."
    }

    /**
     * ä»èŠå¤©å†å²ä¸­è·å–æœ€åçš„æ¶ˆæ¯
     */
    private fun getLastChatMessageFromHistory(aiName: String): String {
        try {
            val chatDataManager = com.example.aifloatingball.data.ChatDataManager.getInstance(this)
            
            // ä½¿ç”¨ä¸çµåŠ¨å²›ç›¸åŒçš„IDç”Ÿæˆé€»è¾‘
            val processedName = if (aiName.contains(Regex("[\\u4e00-\\u9fff]"))) {
                // åŒ…å«ä¸­æ–‡å­—ç¬¦ï¼Œç›´æ¥ä½¿ç”¨åŸåç§°
                aiName
            } else {
                // è‹±æ–‡å­—ç¬¦ï¼Œè½¬æ¢ä¸ºå°å†™
                aiName.lowercase()
            }
            val contactId = "ai_${processedName.replace(" ", "_")}"
            
            Log.d(TAG, "ç®€æ˜“æ¨¡å¼è·å–å†å²æ¶ˆæ¯ - AIåç§°: $aiName, è”ç³»äººID: $contactId")
            
            // è·å–å¯¹åº”çš„AIæœåŠ¡ç±»å‹
            val serviceType = getAIServiceTypeFromName(aiName)
            if (serviceType != null) {
                Log.d(TAG, "ç®€æ˜“æ¨¡å¼è·å–å†å²æ¶ˆæ¯ - æœåŠ¡ç±»å‹: ${serviceType.name}")
                
                // å…ˆå°è¯•ä»å†…å­˜ä¸­è·å–
                var messages = chatDataManager.getMessages(contactId, serviceType)
                Log.d(TAG, "ç®€æ˜“æ¨¡å¼è·å–å†å²æ¶ˆæ¯ - ä»å†…å­˜è·å–åˆ° ${messages.size} æ¡æ¶ˆæ¯")
                
                // å¦‚æœå†…å­˜ä¸­æ²¡æœ‰æ•°æ®ï¼Œå°è¯•é‡æ–°åŠ è½½æ•°æ®
                if (messages.isEmpty()) {
                    Log.d(TAG, "ç®€æ˜“æ¨¡å¼è·å–å†å²æ¶ˆæ¯ - å†…å­˜ä¸­æ— æ•°æ®ï¼Œå°è¯•é‡æ–°åŠ è½½")
                    // è¿™é‡Œå¯ä»¥æ·»åŠ é‡æ–°åŠ è½½é€»è¾‘ï¼Œä½†ChatDataManageråº”è¯¥å·²ç»è‡ªåŠ¨åŠ è½½äº†
                }
                
                if (messages.isNotEmpty()) {
                    val lastMessage = messages.last()
                    val result = lastMessage.content.take(50) + if (lastMessage.content.length > 50) "..." else ""
                    Log.d(TAG, "ç®€æ˜“æ¨¡å¼è·å–å†å²æ¶ˆæ¯ - æœ€åæ¶ˆæ¯: ${result.take(20)}...")
                    return result
                } else {
                    Log.d(TAG, "ç®€æ˜“æ¨¡å¼è·å–å†å²æ¶ˆæ¯ - è¯¥AIæš‚æ— å†å²æ¶ˆæ¯")
                }
            } else {
                Log.w(TAG, "ç®€æ˜“æ¨¡å¼è·å–å†å²æ¶ˆæ¯ - æ— æ³•è¯†åˆ«AIæœåŠ¡ç±»å‹: $aiName")
            }
            
            return ""
        } catch (e: Exception) {
            Log.e(TAG, "è·å–æœ€åèŠå¤©æ¶ˆæ¯å¤±è´¥", e)
            return ""
        }
    }
    
    /**
     * ä»èŠå¤©å†å²ä¸­è·å–æœ€åçš„æ—¶é—´
     */
    private fun getLastChatTimeFromHistory(aiName: String): Long {
        try {
            val chatDataManager = com.example.aifloatingball.data.ChatDataManager.getInstance(this)
            
            // ä½¿ç”¨ä¸çµåŠ¨å²›ç›¸åŒçš„IDç”Ÿæˆé€»è¾‘
            val processedName = if (aiName.contains(Regex("[\\u4e00-\\u9fff]"))) {
                // åŒ…å«ä¸­æ–‡å­—ç¬¦ï¼Œç›´æ¥ä½¿ç”¨åŸåç§°
                aiName
            } else {
                // è‹±æ–‡å­—ç¬¦ï¼Œè½¬æ¢ä¸ºå°å†™
                aiName.lowercase()
            }
            val contactId = "ai_${processedName.replace(" ", "_")}"
            
            // è·å–å¯¹åº”çš„AIæœåŠ¡ç±»å‹
            val serviceType = getAIServiceTypeFromName(aiName)
            if (serviceType != null) {
                val messages = chatDataManager.getMessages(contactId, serviceType)
                if (messages.isNotEmpty()) {
                    return messages.last().timestamp
                }
            }
            
            return 0
        } catch (e: Exception) {
            Log.e(TAG, "è·å–æœ€åèŠå¤©æ—¶é—´å¤±è´¥", e)
            return 0
        }
    }
    
    /**
     * æ ¹æ®AIåç§°è·å–å¯¹åº”çš„AIServiceType
     */
    private fun getAIServiceTypeFromName(aiName: String): AIServiceType? {
        return when (aiName) {
            "ä¸´æ—¶ä¸“çº¿" -> AIServiceType.TEMP_SERVICE
            "DeepSeek" -> AIServiceType.DEEPSEEK
            "ChatGPT" -> AIServiceType.CHATGPT
            "Claude" -> AIServiceType.CLAUDE
            "Gemini" -> AIServiceType.GEMINI
            "æ™ºè°±AI" -> AIServiceType.ZHIPU_AI
            "æ–‡å¿ƒä¸€è¨€" -> AIServiceType.WENXIN
            "é€šä¹‰åƒé—®" -> AIServiceType.QIANWEN
            "è®¯é£æ˜Ÿç«" -> AIServiceType.XINGHUO
            "Kimi" -> AIServiceType.KIMI
            else -> null
        }
    }
    
    /**
     * è°ƒè¯•æ–¹æ³•ï¼šæ£€æŸ¥æ‰€æœ‰AIçš„æ•°æ®çŠ¶æ€
     */
    private fun debugAllAIData() {
        try {
            val chatDataManager = com.example.aifloatingball.data.ChatDataManager.getInstance(this)
            val aiNames = listOf("DeepSeek", "Kimi", "æ™ºè°±AI", "ChatGPT", "Claude", "Gemini")
            
            Log.d(TAG, "=== è°ƒè¯•æ‰€æœ‰AIæ•°æ®çŠ¶æ€ ===")
            
            aiNames.forEach { aiName ->
                val serviceType = getAIServiceTypeFromName(aiName)
                if (serviceType != null) {
                    val processedName = if (aiName.contains(Regex("[\\u4e00-\\u9fff]"))) {
                        aiName
                    } else {
                        aiName.lowercase()
                    }
                    val contactId = "ai_${processedName.replace(" ", "_")}"
                    
                    val messages = chatDataManager.getMessages(contactId, serviceType)
                    Log.d(TAG, "AI: $aiName, ID: $contactId, æœåŠ¡ç±»å‹: ${serviceType.name}, æ¶ˆæ¯æ•°: ${messages.size}")
                    
                    if (messages.isNotEmpty()) {
                        val lastMessage = messages.last()
                        Log.d(TAG, "  æœ€åæ¶ˆæ¯: ${lastMessage.content.take(30)}... (${lastMessage.role})")
                        
                        // æ˜¾ç¤ºæ‰€æœ‰æ¶ˆæ¯çš„è¯¦ç»†ä¿¡æ¯
                        messages.forEachIndexed { index, message ->
                            Log.d(TAG, "    æ¶ˆæ¯${index + 1}: [${message.role}] ${message.content.take(50)}...")
                        }
                    }
                } else {
                    Log.w(TAG, "AI: $aiName - æ— æ³•è¯†åˆ«æœåŠ¡ç±»å‹")
                }
            }
            
            Log.d(TAG, "=== è°ƒè¯•å®Œæˆ ===")
        } catch (e: Exception) {
            Log.e(TAG, "è°ƒè¯•AIæ•°æ®çŠ¶æ€å¤±è´¥", e)
        }
    }
    
    /**
     * å¼ºåˆ¶åˆ·æ–°AIæ•°æ®
     */
    private fun forceRefreshAIData() {
        try {
            val chatDataManager = com.example.aifloatingball.data.ChatDataManager.getInstance(this)
            
            // å¼ºåˆ¶é‡æ–°åŠ è½½æ‰€æœ‰æ•°æ®
            Log.d(TAG, "å¼ºåˆ¶åˆ·æ–°AIæ•°æ® - é‡æ–°åŠ è½½æ‰€æœ‰æ•°æ®")
            chatDataManager.forceReloadAllData()
            
            // è°ƒè¯•æ•°æ®çŠ¶æ€
            chatDataManager.debugAllData()
            
            // åˆ·æ–°è”ç³»äººåˆ—è¡¨
            runOnUiThread {
                chatContactAdapter?.notifyDataSetChanged()
                Log.d(TAG, "å¼ºåˆ¶åˆ·æ–°AIæ•°æ® - UIå·²åˆ·æ–°")
            }
            
        } catch (e: Exception) {
            Log.e(TAG, "å¼ºåˆ¶åˆ·æ–°AIæ•°æ®å¤±è´¥", e)
        }
    }
    
    /**
     * AIå¯¹è¯æ›´æ–°å¹¿æ’­æ¥æ”¶å™¨
     */
    private val aiChatUpdateReceiver = object : BroadcastReceiver() {
        override fun onReceive(context: Context?, intent: Intent?) {
            if (intent?.action == "com.example.aifloatingball.AI_CHAT_UPDATED") {
                val serviceTypeName = intent.getStringExtra("ai_service_type")
                val sessionId = intent.getStringExtra("session_id")
                val messageCount = intent.getIntExtra("message_count", 0)
                val lastMessage = intent.getStringExtra("last_message")
                val timestamp = intent.getLongExtra("timestamp", 0)
                
                Log.d(TAG, "æ”¶åˆ°AIå¯¹è¯æ›´æ–°å¹¿æ’­:")
                Log.d(TAG, "  æœåŠ¡ç±»å‹: $serviceTypeName")
                Log.d(TAG, "  ä¼šè¯ID: $sessionId")
                Log.d(TAG, "  æ¶ˆæ¯æ•°: $messageCount")
                Log.d(TAG, "  æœ€åæ¶ˆæ¯: ${lastMessage?.take(30)}...")
                Log.d(TAG, "  æ—¶é—´æˆ³: $timestamp")
                
                // å¼ºåˆ¶åˆ·æ–°AIå¯¹è¯æ•°æ®
                refreshAIContactData()
            }
        }
    }
    
    /**
     * è®¾ç½®AIå¯¹è¯æ›´æ–°å¹¿æ’­æ¥æ”¶å™¨
     */
    private fun setupAIChatUpdateReceiver() {
        try {
            val filter = IntentFilter("com.example.aifloatingball.AI_CHAT_UPDATED")
            if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.TIRAMISU) {
                registerReceiver(aiChatUpdateReceiver, filter, Context.RECEIVER_NOT_EXPORTED)
            } else {
                registerReceiver(aiChatUpdateReceiver, filter)
            }
            Log.d(TAG, "AIå¯¹è¯æ›´æ–°å¹¿æ’­æ¥æ”¶å™¨å·²æ³¨å†Œ")
        } catch (e: Exception) {
            Log.e(TAG, "æ³¨å†ŒAIå¯¹è¯æ›´æ–°å¹¿æ’­æ¥æ”¶å™¨å¤±è´¥", e)
        }
    }
    
    /**
     * åˆ·æ–°AIå¯¹è¯æ•°æ®
     */
    private fun refreshAIContactData() {
        try {
            // é‡æ–°åŠ è½½ChatDataManageræ•°æ®
            val chatDataManager = com.example.aifloatingball.data.ChatDataManager.getInstance(this)
            chatDataManager.forceReloadAllData()
            
            // åˆ·æ–°UI
            runOnUiThread {
                try {
                    // åˆ·æ–°è”ç³»äººé€‚é…å™¨
                    chatContactAdapter?.notifyDataSetChanged()
                    
                    // å¦‚æœå½“å‰æ˜¾ç¤ºçš„æ˜¯å¯¹è¯tabï¼Œå¼ºåˆ¶åˆ·æ–°è”ç³»äººåˆ—è¡¨
                    val currentTab = findViewById<com.google.android.material.tabs.TabLayout>(R.id.chat_tab_layout)?.selectedTabPosition
                    if (currentTab == 0) { // å¯¹è¯tab
                        // é‡æ–°ç”Ÿæˆè”ç³»äººæ•°æ®
                        refreshContactListData()
                    }
                    
                    // å‘é€å¹¿æ’­é€šçŸ¥æ‰€æœ‰ChatActivityæ›´æ–°
                    val intent = Intent("com.example.aifloatingball.AI_CHAT_UPDATED")
                    intent.putExtra("action", "refresh_all")
                    sendBroadcast(intent)
                } catch (e: Exception) {
                    Log.e(TAG, "åˆ·æ–°UIå¤±è´¥", e)
                }
            }
            
        } catch (e: Exception) {
            Log.e(TAG, "åˆ·æ–°AIå¯¹è¯æ•°æ®å¤±è´¥", e)
        }
    }
    
    /**
     * åˆ·æ–°è”ç³»äººåˆ—è¡¨æ•°æ®
     */
    private fun refreshContactListData() {
        try {
            // é‡æ–°åŠ è½½å’Œæ›´æ–°è”ç³»äººæ•°æ®
            val aiNames = listOf("DeepSeek", "Kimi", "æ™ºè°±AI", "ChatGPT", "Claude", "Gemini")
            val chatDataManager = com.example.aifloatingball.data.ChatDataManager.getInstance(this)
            
            aiNames.forEach { aiName ->
                val serviceType = getAIServiceTypeFromName(aiName)
                if (serviceType != null) {
                    val processedName = if (aiName.contains(Regex("[\\u4e00-\\u9fff]"))) {
                        aiName
                    } else {
                        aiName.lowercase()
                    }
                    val contactId = "ai_${processedName.replace(" ", "_")}"
                    
                    // ä½¿ç”¨ä¸getLastChatMessageFromHistoryç›¸åŒçš„é€»è¾‘ï¼šè·å–æ‰€æœ‰ä¼šè¯ä¸­çš„æœ€æ–°æ¶ˆæ¯
                    val allSessions = chatDataManager.getAllSessions(serviceType)
                    val latestSession = allSessions.maxByOrNull { it.updatedAt }
                    
                    if (latestSession != null && latestSession.messages.isNotEmpty()) {
                        val lastMessage = latestSession.messages.last()
                        // æ›´æ–°å¯¹åº”è”ç³»äººçš„æœ€åæ¶ˆæ¯
                        updateContactLastMessageData(aiName, contactId, lastMessage)
                        Log.d(TAG, "åˆ·æ–°è”ç³»äººåˆ—è¡¨ - $aiName æœ€æ–°æ¶ˆæ¯: ${lastMessage.content.take(30)}...")
                    } else {
                        Log.d(TAG, "åˆ·æ–°è”ç³»äººåˆ—è¡¨ - $aiName æš‚æ— å†å²æ¶ˆæ¯")
                    }
                }
            }
            
        } catch (e: Exception) {
            Log.e(TAG, "åˆ·æ–°è”ç³»äººåˆ—è¡¨æ•°æ®å¤±è´¥", e)
        }
    }
    
    /**
     * æ›´æ–°è”ç³»äººçš„æœ€åæ¶ˆæ¯æ•°æ®
     */
    private fun updateContactLastMessageData(aiName: String, contactId: String, lastMessage: com.example.aifloatingball.data.ChatDataManager.ChatMessage) {
        try {
            // åœ¨allContactsä¸­æ‰¾åˆ°å¯¹åº”çš„è”ç³»äººå¹¶æ›´æ–°
            for (i in allContacts.indices) {
                val category = allContacts[i]
                val contactIndex = category.contacts.indexOfFirst { it.id == contactId }
                if (contactIndex != -1) {
                    val mutableContacts = category.contacts.toMutableList()
                    val updatedContact = mutableContacts[contactIndex].copy(
                        lastMessage = lastMessage.content.take(50) + if (lastMessage.content.length > 50) "..." else "",
                        lastMessageTime = lastMessage.timestamp
                    )
                    mutableContacts[contactIndex] = updatedContact
                    allContacts[i] = category.copy(contacts = mutableContacts)
                    
                    Log.d(TAG, "å·²æ›´æ–°è”ç³»äºº $aiName çš„æœ€åæ¶ˆæ¯: ${lastMessage.content.take(30)}...")
                    break
                }
            }
        } catch (e: Exception) {
            Log.e(TAG, "æ›´æ–°è”ç³»äººæœ€åæ¶ˆæ¯æ•°æ®å¤±è´¥", e)
        }
    }
    
    /**
     * æ–‡ä»¶åŒæ­¥ç›‘æ§
     */
    private var fileSyncHandler: Handler? = null
    private var fileSyncRunnable: Runnable? = null
    private val fileSyncInterval = 5000L // 5ç§’æ£€æŸ¥ä¸€æ¬¡
    
    /**
     * å¯åŠ¨æ–‡ä»¶ç›‘å¬åŒæ­¥æœºåˆ¶
     */
    private fun startFileSyncMonitoring() {
        try {
            Log.d(TAG, "å¯åŠ¨æ–‡ä»¶ç›‘å¬åŒæ­¥æœºåˆ¶")
            
            fileSyncHandler = Handler(Looper.getMainLooper())
            fileSyncRunnable = object : Runnable {
                override fun run() {
                    checkSyncFiles()
                    fileSyncHandler?.postDelayed(this, fileSyncInterval)
                }
            }
            
            fileSyncHandler?.post(fileSyncRunnable!!)
            Log.d(TAG, "æ–‡ä»¶ç›‘å¬åŒæ­¥æœºåˆ¶å·²å¯åŠ¨")
            
        } catch (e: Exception) {
            Log.e(TAG, "å¯åŠ¨æ–‡ä»¶ç›‘å¬åŒæ­¥æœºåˆ¶å¤±è´¥", e)
        }
    }
    
    /**
     * æ£€æŸ¥åŒæ­¥æ–‡ä»¶
     */
    private fun checkSyncFiles() {
        try {
            val aiServices = listOf("deepseek", "kimi", "zhipu_ai", "chatgpt", "claude", "gemini")
            val filesDir = filesDir
            
            aiServices.forEach { serviceName ->
                val syncFile = File(filesDir, "ai_sync_$serviceName.json")
                if (syncFile.exists()) {
                    val lastModified = syncFile.lastModified()
                    val currentTime = System.currentTimeMillis()
                    
                    // å¦‚æœæ–‡ä»¶åœ¨æœ€è¿‘10ç§’å†…è¢«ä¿®æ”¹ï¼Œè¯´æ˜æœ‰æ–°çš„åŒæ­¥æ•°æ®
                    if (currentTime - lastModified < 10000L) {
                        Log.d(TAG, "æ£€æµ‹åˆ°åŒæ­¥æ–‡ä»¶æ›´æ–°: $serviceName")
                        processSyncFile(syncFile, serviceName)
                    }
                }
            }
            
        } catch (e: Exception) {
            Log.e(TAG, "æ£€æŸ¥åŒæ­¥æ–‡ä»¶å¤±è´¥", e)
        }
    }
    
    /**
     * å¤„ç†åŒæ­¥æ–‡ä»¶
     */
    private fun processSyncFile(syncFile: File, serviceName: String) {
        try {
            val jsonString = syncFile.readText()
            val syncData = JSONObject(jsonString)
            
            val serviceTypeName = syncData.getString("service_type")
            val sessionId = syncData.getString("session_id")
            val messageCount = syncData.getInt("message_count")
            val timestamp = syncData.getLong("timestamp")
            
            Log.d(TAG, "å¤„ç†åŒæ­¥æ–‡ä»¶:")
            Log.d(TAG, "  æœåŠ¡ç±»å‹: $serviceTypeName")
            Log.d(TAG, "  ä¼šè¯ID: $sessionId")
            Log.d(TAG, "  æ¶ˆæ¯æ•°: $messageCount")
            Log.d(TAG, "  æ—¶é—´æˆ³: $timestamp")
            
            // å¼ºåˆ¶åˆ·æ–°æ•°æ®
            refreshAIContactData()
            
            // åˆ é™¤å·²å¤„ç†çš„åŒæ­¥æ–‡ä»¶
            syncFile.delete()
            Log.d(TAG, "åŒæ­¥æ–‡ä»¶å·²å¤„ç†å¹¶åˆ é™¤")
            
        } catch (e: Exception) {
            Log.e(TAG, "å¤„ç†åŒæ­¥æ–‡ä»¶å¤±è´¥", e)
        }
    }
    
    /**
     * åœæ­¢æ–‡ä»¶ç›‘å¬åŒæ­¥æœºåˆ¶
     */
    private fun stopFileSyncMonitoring() {
        try {
            fileSyncRunnable?.let { runnable ->
                fileSyncHandler?.removeCallbacks(runnable)
            }
            fileSyncHandler = null
            fileSyncRunnable = null
            Log.d(TAG, "æ–‡ä»¶ç›‘å¬åŒæ­¥æœºåˆ¶å·²åœæ­¢")
        } catch (e: Exception) {
            Log.e(TAG, "åœæ­¢æ–‡ä»¶ç›‘å¬åŒæ­¥æœºåˆ¶å¤±è´¥", e)
        }
    }
    
    /**
     * å®šæ—¶å¼ºåˆ¶åŒæ­¥æœºåˆ¶
     */
    private var periodicSyncHandler: Handler? = null
    private var periodicSyncRunnable: Runnable? = null
    private val periodicSyncInterval = 10000L // 10ç§’åŒæ­¥ä¸€æ¬¡
    
    /**
     * å¯åŠ¨å®šæ—¶å¼ºåˆ¶åŒæ­¥
     */
    private fun startPeriodicSync() {
        try {
            Log.d(TAG, "å¯åŠ¨å®šæ—¶å¼ºåˆ¶åŒæ­¥æœºåˆ¶")
            
            periodicSyncHandler = Handler(Looper.getMainLooper())
            periodicSyncRunnable = object : Runnable {
                override fun run() {
                    Log.d(TAG, "æ‰§è¡Œå®šæ—¶å¼ºåˆ¶åŒæ­¥...")
                    forceRefreshAIData()
                    periodicSyncHandler?.postDelayed(this, periodicSyncInterval)
                }
            }
            
            periodicSyncHandler?.post(periodicSyncRunnable!!)
            Log.d(TAG, "å®šæ—¶å¼ºåˆ¶åŒæ­¥æœºåˆ¶å·²å¯åŠ¨")
            
        } catch (e: Exception) {
            Log.e(TAG, "å¯åŠ¨å®šæ—¶å¼ºåˆ¶åŒæ­¥æœºåˆ¶å¤±è´¥", e)
        }
    }
    
    /**
     * å¹¿æ’­æ¥æ”¶å™¨ï¼Œç”¨äºæ¥æ”¶AIæ¶ˆæ¯æ›´æ–°é€šçŸ¥
     */
    private val aiMessageUpdateReceiver = object : BroadcastReceiver() {
        override fun onReceive(context: Context?, intent: Intent?) {
            try {
                Log.d(TAG, "æ”¶åˆ°å¹¿æ’­: action=${intent?.action}")
                if (intent?.action == "com.example.aifloatingball.AI_MESSAGE_UPDATED") {
                    val contactId = intent.getStringExtra("contact_id") ?: return
                    val contactName = intent.getStringExtra("contact_name") ?: return
                    val lastMessage = intent.getStringExtra("last_message") ?: return
                    val lastMessageTime = intent.getLongExtra("last_message_time", System.currentTimeMillis())
                    
                    Log.d(TAG, "æ”¶åˆ°AIæ¶ˆæ¯æ›´æ–°å¹¿æ’­: $contactName ($contactId) - ${lastMessage.take(50)}...")
                    
                    // æ›´æ–°è”ç³»äººæ•°æ®
                    updateContactFromBroadcast(contactId, contactName, lastMessage, lastMessageTime)
                }
            } catch (e: Exception) {
                Log.e(TAG, "å¤„ç†AIæ¶ˆæ¯æ›´æ–°å¹¿æ’­å¤±è´¥", e)
            }
        }
    }
    
    /**
     * ä»å¹¿æ’­æ›´æ–°è”ç³»äººæ•°æ®
     */
    private fun updateContactFromBroadcast(contactId: String, contactName: String, lastMessage: String, lastMessageTime: Long) {
        try {
            Log.d(TAG, "å¼€å§‹æ›´æ–°è”ç³»äººæ•°æ®: $contactName ($contactId) - ${lastMessage.take(50)}...")
            
            // æ‰“å°æ‰€æœ‰å¯ç”¨çš„è”ç³»äººIDç”¨äºè°ƒè¯•
            Log.d(TAG, "å½“å‰allContactsä¸­çš„è”ç³»äººID:")
            allContacts.forEach { category ->
                category.contacts.forEach { contact ->
                    Log.d(TAG, "  - ${contact.name} (${contact.id})")
                }
            }
            
            // åœ¨allContactsä¸­æ‰¾åˆ°å¯¹åº”çš„è”ç³»äººå¹¶æ›´æ–°
            var found = false
            for (i in allContacts.indices) {
                val category = allContacts[i]
                val contactIndex = category.contacts.indexOfFirst { it.id == contactId }
                if (contactIndex != -1) {
                    Log.d(TAG, "æ‰¾åˆ°åŒ¹é…çš„è”ç³»äºº: ${category.contacts[contactIndex].name} (${category.contacts[contactIndex].id}) -> $contactName ($contactId)")
                    found = true
                    
                    val mutableContacts = category.contacts.toMutableList()
                    val updatedContact = mutableContacts[contactIndex].copy(
                        lastMessage = lastMessage.take(50) + if (lastMessage.length > 50) "..." else "",
                        lastMessageTime = lastMessageTime
                    )
                    mutableContacts[contactIndex] = updatedContact
                    allContacts[i] = category.copy(contacts = mutableContacts)
                    
                    // é€šçŸ¥é€‚é…å™¨æ›´æ–°
                    chatContactAdapter?.notifyDataSetChanged()
                    
                    Log.d(TAG, "å·²ä»å¹¿æ’­æ›´æ–°è”ç³»äºº $contactName çš„æœ€åæ¶ˆæ¯: ${lastMessage.take(30)}...")
                    break
                }
            }
            
            if (!found) {
                Log.w(TAG, "æœªæ‰¾åˆ°åŒ¹é…çš„è”ç³»äºº: $contactName ($contactId)")
            }
        } catch (e: Exception) {
            Log.e(TAG, "ä»å¹¿æ’­æ›´æ–°è”ç³»äººæ•°æ®å¤±è´¥", e)
        }
    }
    
    /**
     * æ³¨å†Œå¹¿æ’­æ¥æ”¶å™¨
     */
    private fun registerBroadcastReceiver() {
        try {
            val filter = IntentFilter("com.example.aifloatingball.AI_MESSAGE_UPDATED")
            if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.TIRAMISU) {
                registerReceiver(aiMessageUpdateReceiver, filter, Context.RECEIVER_NOT_EXPORTED)
            } else {
                registerReceiver(aiMessageUpdateReceiver, filter)
            }
            Log.d(TAG, "å·²æ³¨å†ŒAIæ¶ˆæ¯æ›´æ–°å¹¿æ’­æ¥æ”¶å™¨")
        } catch (e: Exception) {
            Log.e(TAG, "æ³¨å†Œå¹¿æ’­æ¥æ”¶å™¨å¤±è´¥", e)
        }
        
        // æ³¨å†Œé¦–é¡µæŒ‰é’®åˆ·æ–°å¹¿æ’­æ¥æ”¶å™¨
        try {
            homeButtonRefreshReceiver = object : BroadcastReceiver() {
                override fun onReceive(context: Context?, intent: Intent?) {
                    if (intent?.action == "com.example.aifloatingball.ACTION_REFRESH_HOME_BUTTONS") {
                        Log.d(TAG, "æ”¶åˆ°åˆ·æ–°é¦–é¡µæŒ‰é’®çš„å¹¿æ’­")
                        refreshHomeButtonVisibility()
                    }
                }
            }
            val filter = IntentFilter("com.example.aifloatingball.ACTION_REFRESH_HOME_BUTTONS")
            if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.TIRAMISU) {
                registerReceiver(homeButtonRefreshReceiver, filter, Context.RECEIVER_NOT_EXPORTED)
            } else {
                registerReceiver(homeButtonRefreshReceiver, filter)
            }
            Log.d(TAG, "å·²æ³¨å†Œé¦–é¡µæŒ‰é’®åˆ·æ–°å¹¿æ’­æ¥æ”¶å™¨")
        } catch (e: Exception) {
            Log.e(TAG, "æ³¨å†Œé¦–é¡µæŒ‰é’®åˆ·æ–°å¹¿æ’­æ¥æ”¶å™¨å¤±è´¥", e)
        }
    }
    
    /**
     * æ³¨é”€å¹¿æ’­æ¥æ”¶å™¨
     */
    private fun unregisterBroadcastReceiver() {
        try {
            unregisterReceiver(aiMessageUpdateReceiver)
            Log.d(TAG, "å·²æ³¨é”€AIæ¶ˆæ¯æ›´æ–°å¹¿æ’­æ¥æ”¶å™¨")
        } catch (e: Exception) {
            Log.e(TAG, "æ³¨é”€å¹¿æ’­æ¥æ”¶å™¨å¤±è´¥", e)
        }
        
        // æ³¨é”€é¦–é¡µæŒ‰é’®åˆ·æ–°å¹¿æ’­æ¥æ”¶å™¨
        try {
            homeButtonRefreshReceiver?.let {
                unregisterReceiver(it)
                homeButtonRefreshReceiver = null
                Log.d(TAG, "å·²æ³¨é”€é¦–é¡µæŒ‰é’®åˆ·æ–°å¹¿æ’­æ¥æ”¶å™¨")
            }
        } catch (e: Exception) {
            Log.e(TAG, "æ³¨é”€é¦–é¡µæŒ‰é’®åˆ·æ–°å¹¿æ’­æ¥æ”¶å™¨å¤±è´¥", e)
        }
    }
    
    /**
     * å¼ºåˆ¶åŠ è½½AIè”ç³»äººåˆ—è¡¨æ•°æ®æ±‡æ€»
     */
    private fun forceLoadContactDataSummary() {
        try {
            Log.d(TAG, "å¼€å§‹å¼ºåˆ¶åŠ è½½AIè”ç³»äººåˆ—è¡¨æ•°æ®æ±‡æ€»")
            
            val chatDataManager = com.example.aifloatingball.data.ChatDataManager.getInstance(this)
            val aiNames = listOf("DeepSeek", "Kimi", "æ™ºè°±AI", "ChatGPT", "Claude", "Gemini")
            
            aiNames.forEach { aiName ->
                val serviceType = getAIServiceTypeFromName(aiName)
                if (serviceType != null) {
                    val processedName = if (aiName.contains(Regex("[\\u4e00-\\u9fff]"))) {
                        aiName
                    } else {
                        aiName.lowercase()
                    }
                    val contactId = "ai_${processedName.replace(" ", "_")}"
                    
                    // è·å–æ‰€æœ‰ä¼šè¯ï¼Œæ‰¾åˆ°æœ€æ–°çš„æœ‰æ¶ˆæ¯çš„ä¼šè¯
                    val allSessions = chatDataManager.getAllSessions(serviceType)
                    val latestSession = allSessions.maxByOrNull { it.updatedAt }
                    
                    if (latestSession != null && latestSession.messages.isNotEmpty()) {
                        val lastMessage = latestSession.messages.last()
                        
                        // æ›´æ–°è”ç³»äººæ•°æ®
                        updateContactFromBroadcast(contactId, aiName, lastMessage.content, lastMessage.timestamp)
                        
                        Log.d(TAG, "å¼ºåˆ¶åŠ è½½ - $aiName æœ€æ–°æ¶ˆæ¯: ${lastMessage.content.take(30)}...")
                    } else {
                        Log.d(TAG, "å¼ºåˆ¶åŠ è½½ - $aiName æš‚æ— å†å²æ¶ˆæ¯")
                    }
                }
            }
            
            Log.d(TAG, "å¼ºåˆ¶åŠ è½½AIè”ç³»äººåˆ—è¡¨æ•°æ®æ±‡æ€»å®Œæˆ")
        } catch (e: Exception) {
            Log.e(TAG, "å¼ºåˆ¶åŠ è½½AIè”ç³»äººåˆ—è¡¨æ•°æ®æ±‡æ€»å¤±è´¥", e)
        }
    }
    
    /**
     * åœæ­¢å®šæ—¶å¼ºåˆ¶åŒæ­¥
     */
    private fun stopPeriodicSync() {
        try {
            periodicSyncRunnable?.let { runnable ->
                periodicSyncHandler?.removeCallbacks(runnable)
            }
            periodicSyncHandler = null
            periodicSyncRunnable = null
            Log.d(TAG, "å®šæ—¶å¼ºåˆ¶åŒæ­¥æœºåˆ¶å·²åœæ­¢")
        } catch (e: Exception) {
            Log.e(TAG, "åœæ­¢å®šæ—¶å¼ºåˆ¶åŒæ­¥æœºåˆ¶å¤±è´¥", e)
        }
    }
    
    /**
     * æ·»åŠ æµ‹è¯•åˆ·æ–°æŒ‰é’®
     */
    private fun addTestRefreshButton() {
        try {
            // åœ¨å¯¹è¯tabä¸­æ·»åŠ ä¸€ä¸ªæµ‹è¯•æŒ‰é’®
            val chatTabLayout = findViewById<com.google.android.material.tabs.TabLayout>(R.id.chat_tab_layout)
            chatTabLayout?.let { tabLayout ->
                // æ·»åŠ ä¸€ä¸ªæµ‹è¯•æ ‡ç­¾é¡µ
                val testTab = tabLayout.newTab().setText("æµ‹è¯•")
                tabLayout.addTab(testTab)
                
                // è®¾ç½®ç‚¹å‡»ç›‘å¬å™¨
                tabLayout.addOnTabSelectedListener(object : com.google.android.material.tabs.TabLayout.OnTabSelectedListener {
                    override fun onTabSelected(tab: com.google.android.material.tabs.TabLayout.Tab?) {
                        if (tab?.text == "æµ‹è¯•") {
                            Log.d(TAG, "æµ‹è¯•æ ‡ç­¾é¡µè¢«é€‰ä¸­ - å¼€å§‹è°ƒè¯•æ•°æ®")
                            debugAllAIData()
                            forceRefreshAIData()
                            
                            // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
                            Toast.makeText(this@SimpleModeActivity, "æ•°æ®è°ƒè¯•å®Œæˆï¼Œè¯·æŸ¥çœ‹æ—¥å¿—", Toast.LENGTH_LONG).show()
                            
                            // åˆ‡æ¢å›å¯¹è¯æ ‡ç­¾é¡µ
                            tabLayout.getTabAt(0)?.select()
                        }
                    }
                    
                    override fun onTabUnselected(tab: com.google.android.material.tabs.TabLayout.Tab?) {}
                    override fun onTabReselected(tab: com.google.android.material.tabs.TabLayout.Tab?) {}
                })
            }
        } catch (e: Exception) {
            Log.e(TAG, "æ·»åŠ æµ‹è¯•åˆ·æ–°æŒ‰é’®å¤±è´¥", e)
        }
    }
    
    /**
     * æ ¼å¼åŒ–AIå›å¤å¹¶æ·»åŠ å¹³å°å›¾æ ‡æ ‡è®°
     */
    private fun formatAIResponseWithPlatformIcons(response: String, query: String): String {
        // æ¸…ç†å’Œæ ¼å¼åŒ–AIå›å¤
        val cleanedResponse = response
            .replace("```", "") // ç§»é™¤ä»£ç å—æ ‡è®°
            .replace("**", "") // ç§»é™¤ç²—ä½“æ ‡è®°
            .replace("*", "") // ç§»é™¤æ–œä½“æ ‡è®°
            .replace("#", "") // ç§»é™¤æ ‡é¢˜æ ‡è®°
            .replace("`", "") // ç§»é™¤è¡Œå†…ä»£ç æ ‡è®°
            .replace("---", "â€”") // æ›¿æ¢åˆ†éš”çº¿
            .replace("###", "â€¢") // æ›¿æ¢ä¸‰çº§æ ‡é¢˜ä¸ºé¡¹ç›®ç¬¦å·
            .replace("##", "â€¢") // æ›¿æ¢äºŒçº§æ ‡é¢˜ä¸ºé¡¹ç›®ç¬¦å·
            .replace("#", "â€¢") // æ›¿æ¢ä¸€çº§æ ‡é¢˜ä¸ºé¡¹ç›®ç¬¦å·
            .replace("\n\n\n", "\n\n") // å‡å°‘å¤šä½™ç©ºè¡Œ
            .replace("\\n", "\n") // å¤„ç†è½¬ä¹‰æ¢è¡Œç¬¦
            .trim()
        
        // æ·»åŠ å¹³å°å›¾æ ‡æ ‡è®°
        return "$cleanedResponse\n\n[PLATFORM_ICONS]"
    }

    /**
     * æ›´æ–°è”ç³»äººçš„æœ€åæ¶ˆæ¯
     */
    private fun updateContactLastMessage(aiContact: ChatContact, lastMessage: String) {
        try {
            var updated = false
            // æ‰¾åˆ°å¹¶æ›´æ–°è”ç³»äºº
            for (i in allContacts.indices) {
                val category = allContacts[i]
                val contactIndex = category.contacts.indexOfFirst { it.id == aiContact.id }
                if (contactIndex != -1) {
                    val mutableContacts = category.contacts.toMutableList()
                    mutableContacts[contactIndex] = mutableContacts[contactIndex].copy(
                        lastMessage = lastMessage.take(50) + if (lastMessage.length > 50) "..." else "",
                        lastMessageTime = System.currentTimeMillis()
                    )
                    allContacts[i] = category.copy(contacts = mutableContacts)
                    updated = true
                    break
                }
            }

            // åªæœ‰åœ¨æˆåŠŸæ›´æ–°è”ç³»äººæ•°æ®æ—¶æ‰åˆ·æ–°UIï¼Œé¿å…ä¸å¿…è¦çš„é‡æ–°åŠ è½½
            if (updated) {
                // ä½¿ç”¨æ›´è½»é‡çš„æ–¹å¼é€šçŸ¥é€‚é…å™¨æ•°æ®å˜åŒ–ï¼Œè€Œä¸æ˜¯å®Œå…¨é‡æ–°åŠ è½½
                chatContactAdapter?.notifyDataSetChanged()
                Log.d(TAG, "å·²æ›´æ–°è”ç³»äºº ${aiContact.name} çš„æœ€åæ¶ˆæ¯")
            }

        } catch (e: Exception) {
            Log.e(TAG, "æ›´æ–°è”ç³»äººæœ€åæ¶ˆæ¯å¤±è´¥", e)
        }
    }



    /**
     * æ£€æŸ¥è”ç³»äººæ˜¯å¦æœ‰æœ‰æ•ˆçš„APIå¯†é’¥
     */
    private fun hasValidApiKey(contact: ChatContact): Boolean {
        return try {
            // è·å–AIæœåŠ¡ç±»å‹
            val serviceType = getAIServiceType(contact)
            if (serviceType != null) {
                // ä¸´æ—¶ä¸“çº¿ä¸éœ€è¦APIå¯†é’¥éªŒè¯
                if (serviceType == AIServiceType.TEMP_SERVICE) {
                    return true
                }
                // ä»SettingsManagerè·å–APIå¯†é’¥
                val apiKey = getApiKeyForService(serviceType)
                apiKey.isNotBlank() && apiKey.length > 10
            } else {
                false
            }
        } catch (e: Exception) {
            Log.e(TAG, "æ£€æŸ¥APIå¯†é’¥å¤±è´¥: ${contact.name}", e)
            false
        }
    }

    /**
     * æ‰“å¼€ä¸è”ç³»äººçš„å¯¹è¯å¹¶å‘é€æ¶ˆæ¯
     */
    private fun openChatWithContactAndMessage(contact: ChatContact, message: String) {
        try {
            val intent = Intent(this, ChatActivity::class.java).apply {
                putExtra(ChatActivity.EXTRA_CONTACT, contact)
                putExtra("auto_send_message", message) // ä¼ é€’è¦è‡ªåŠ¨å‘é€çš„æ¶ˆæ¯
            }
            startActivity(intent)
            Log.d(TAG, "æ‰“å¼€å¯¹è¯å¹¶å‘é€æ¶ˆæ¯: ${contact.name} - $message")
        } catch (e: Exception) {
            Log.e(TAG, "æ‰“å¼€å¯¹è¯å¤±è´¥", e)
            Toast.makeText(this, "æ‰“å¼€å¯¹è¯å¤±è´¥", Toast.LENGTH_SHORT).show()
        }
    }

    /**
     * æ˜¾ç¤ºAIè”ç³»äºº
     */
    private fun showAIContacts() {
        try {
            // ä½¿ç”¨AIæ ‡ç­¾ç®¡ç†å™¨è·å–AIåŠ©æ‰‹æ ‡ç­¾ä¸‹çš„AIå¯¹è±¡
            val aiTagManager = AITagManager.getInstance(this)
            val aiContacts = aiTagManager.getAIsByTag("ai_assistant", allContacts)

            Log.d(TAG, "showAIContacts: å¼€å§‹æ˜¾ç¤ºAIè”ç³»äºº")
            Log.d(TAG, "showAIContacts: æ€»åˆ†ç±»æ•°: ${allContacts.size}")
            allContacts.forEach { category ->
                Log.d(TAG, "showAIContacts: åˆ†ç±»: ${category.name}, è”ç³»äººæ•°: ${category.contacts.size}")
                category.contacts.forEach { contact ->
                    Log.d(TAG, "showAIContacts: - ${contact.name} (ç±»å‹: ${contact.type})")
                }
            }

            // å°†List<ChatContact>åŒ…è£…æˆList<ContactCategory>
            val aiContactCategory = listOf(ContactCategory(
                name = "AIåŠ©æ‰‹",
                contacts = aiContacts.toMutableList(),
                isExpanded = true
            ))

            chatContactAdapter?.updateContacts(aiContactCategory)
            Log.d(TAG, "æ˜¾ç¤ºAIè”ç³»äººï¼ŒAIåŠ©æ‰‹æ ‡ç­¾ä¸‹AIæ•°é‡: ${aiContacts.size}")
            aiContacts.forEach { ai ->
                Log.d(TAG, "showAIContacts: AIåŠ©æ‰‹æ ‡ç­¾ä¸‹çš„AI: ${ai.name}")
            }
        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºAIè”ç³»äººå¤±è´¥", e)
        }
    }

    /**
     * åˆ¤æ–­æ˜¯å¦ä¸ºAIè”ç³»äºº
     */
    private fun isAIContact(contact: ChatContact): Boolean {
        return when (contact.name.lowercase()) {
            "ä¸´æ—¶ä¸“çº¿", "tempservice", "temp_service",
            "chatgpt", "gpt", "claude", "gemini", "æ–‡å¿ƒä¸€è¨€", "wenxin",
            "deepseek", "é€šä¹‰åƒé—®", "qianwen", "è®¯é£æ˜Ÿç«", "xinghuo",
            "kimi", "æ™ºè°±ai", "zhipuai" -> true
            else -> false
        }
    }



    /**
     * æ‰“å¼€AIè”ç³»äººåˆ—è¡¨ç•Œé¢
     */
    private fun openAIContactListActivity() {
        try {
            val intent = Intent(this, AIContactListActivity::class.java)
            startActivityForResult(intent, REQUEST_CODE_ADD_AI_CONTACT)
            Log.d(TAG, "æ‰“å¼€AIè”ç³»äººåˆ—è¡¨ç•Œé¢")
        } catch (e: Exception) {
            Log.e(TAG, "æ‰“å¼€AIè”ç³»äººåˆ—è¡¨ç•Œé¢å¤±è´¥", e)
            Toast.makeText(this, "æ‰“å¼€AIè”ç³»äººåˆ—è¡¨ç•Œé¢å¤±è´¥", Toast.LENGTH_SHORT).show()
        }
    }

    /**
     * æ˜¾ç¤ºæ‰€æœ‰ç”¨æˆ·æ·»åŠ çš„AIåŠ©æ‰‹ï¼ˆ"å…¨éƒ¨"æ ‡ç­¾ï¼‰
     * è¿™æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„èšåˆè§†å›¾ï¼Œæ˜¾ç¤ºæ‰€æœ‰åˆ†ç»„ä¸­çš„AIï¼Œä¸æ˜¾ç¤ºåˆ†ç»„æ ‡é¢˜
     */
    private fun showAllUserAIContacts() {
        try {
            // æ£€æŸ¥allContactsæ˜¯å¦å·²åˆå§‹åŒ–
            if (allContacts.isEmpty()) {
                Log.w(TAG, "allContactsä¸ºç©ºï¼Œæ— æ³•æ˜¾ç¤ºå…¨éƒ¨ç”¨æˆ·AIè”ç³»äºº")
                return
            }

            // æ”¶é›†æ‰€æœ‰AIè”ç³»äººå’Œç¾¤èŠ
            val aiContacts = mutableListOf<ChatContact>()
            val groupContacts = mutableListOf<ChatContact>()
            this.allContacts.forEach { category ->
                category.contacts.forEach { contact ->
                    when (contact.type) {
                        ContactType.AI -> {
                            // åŒ…å«æ‰€æœ‰åˆ†ç±»ä¸­çš„AIè”ç³»äººï¼ŒåŒ…æ‹¬"å…¨éƒ¨"åˆ†ç±»
                            if (!contact.id.contains("hint") &&
                                !contact.id.contains("empty") &&
                                contact.name != "æš‚æ— AIåŠ©æ‰‹" &&
                                contact.name != "AIåŠ©æ‰‹åˆ†ç»„ä¸ºç©º") {
                                aiContacts.add(contact)
                            }
                        }
                        ContactType.GROUP -> {
                            // æ”¶é›†ç¾¤èŠè”ç³»äºº
                            groupContacts.add(contact)
                        }
                        else -> {
                            // å…¶ä»–ç±»å‹æš‚æ—¶å¿½ç•¥
                        }
                    }
                }
            }
            
            // ä»UnifiedGroupChatManagerè·å–ç¾¤èŠæ•°æ®
            val groupChatContacts = mutableListOf<ChatContact>()
            try {
                if (::unifiedGroupChatManager.isInitialized) {
                    val groupChats = unifiedGroupChatManager.getAllGroupChats()
                    groupChats.forEach { groupChat ->
                    val groupChatContact = ChatContact(
                        id = groupChat.id,
                        name = groupChat.name,
                        avatar = groupChat.avatar,
                        type = ContactType.GROUP,
                        description = groupChat.description,
                        isOnline = true,
                        lastMessage = groupChat.lastMessage,
                        lastMessageTime = groupChat.lastMessageTime,
                        unreadCount = groupChat.unreadCount,
                        isPinned = groupChat.isPinned,
                        isMuted = groupChat.isMuted,
                        groupId = groupChat.id,
                        memberCount = groupChat.members.size,
                        aiMembers = groupChat.members.filter { member -> member.type == MemberType.AI }.map { member -> member.name }
                    )
                    groupChatContacts.add(groupChatContact)
                }
                } else {
                    Log.w(TAG, "unifiedGroupChatManageræœªåˆå§‹åŒ–ï¼Œè·³è¿‡ç¾¤èŠæ•°æ®æ”¶é›†")
                }
            } catch (e: Exception) {
                Log.e(TAG, "ä»ç»Ÿä¸€ç®¡ç†å™¨è·å–ç¾¤èŠæ•°æ®å¤±è´¥", e)
            }
            
            // åˆå¹¶AIå’Œç¾¤èŠè”ç³»äºº
            val allDisplayContacts = mutableListOf<ChatContact>()
            allDisplayContacts.addAll(aiContacts)
            allDisplayContacts.addAll(groupContacts)
            
            // å¦‚æœallContactsä¸­æ²¡æœ‰ç¾¤èŠï¼Œåˆ™ä»UnifiedGroupChatManagerè·å–
            if (groupContacts.isEmpty() && groupChatContacts.isNotEmpty()) {
                allDisplayContacts.addAll(groupChatContacts)
                Log.d(TAG, "ä»UnifiedGroupChatManagerè¡¥å……äº† ${groupChatContacts.size} ä¸ªç¾¤èŠ")
            }
            
            Log.d(TAG, "æ”¶é›†åˆ° ${allDisplayContacts.size} ä¸ªè”ç³»äººï¼ˆ${aiContacts.size} ä¸ªAIï¼Œ${groupContacts.size} ä¸ªç¾¤èŠï¼Œ${groupChatContacts.size} ä¸ªè¡¥å……ç¾¤èŠï¼‰")

            // æŒ‰ç½®é¡¶çŠ¶æ€å’Œæœ€åæ¶ˆæ¯æ—¶é—´æ’åº
            val sortedContacts = allDisplayContacts.distinctBy { it.id }.sortedWith(
                compareByDescending<ChatContact> { it.isPinned }
                    .thenByDescending { it.lastMessageTime }
            )

            Log.d(TAG, "å…¨éƒ¨æ ‡ç­¾é¡µæ˜¾ç¤º ${sortedContacts.size} ä¸ªè”ç³»äººï¼ˆAIå’Œç¾¤èŠï¼‰")

            val displayCategories = listOf(ContactCategory(
                name = "å…¨éƒ¨",
                contacts = sortedContacts.toMutableList(),
                isExpanded = true,
                isPinned = false
            ))

            // ç¡®ä¿æ‰€æœ‰æ˜¾ç¤ºçš„AIéƒ½åœ¨allContactsä¸­ï¼ˆç”¨äºé•¿æŒ‰èœå•åŠŸèƒ½ï¼‰
            ensureAIsInAllContacts(displayCategories)

            // åŒæ­¥AIè”ç³»äººçŠ¶æ€ï¼ˆç¡®ä¿æ˜¾ç¤ºçš„AIä¸å­˜å‚¨çš„AIçŠ¶æ€ä¸€è‡´ï¼‰
            syncAIContactStates(displayCategories)

            chatContactAdapter?.updateContacts(displayCategories)
            Log.d(TAG, "æ˜¾ç¤ºå…¨éƒ¨ç”¨æˆ·è”ç³»äººï¼Œå…±${sortedContacts.size}ä¸ªè”ç³»äººï¼ˆAIå’Œç¾¤èŠï¼‰")
        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºå…¨éƒ¨ç”¨æˆ·AIåŠ©æ‰‹å¤±è´¥", e)
        }
    }

    /**
     * æ˜¾ç¤ºAIåŠ©æ‰‹é¢„è®¾åˆ†ç»„ï¼ˆåªæ˜¾ç¤ºç”¨æˆ·ä¸»åŠ¨ç§»åŠ¨åˆ°æ­¤åˆ†ç»„çš„AIï¼‰
     */
    private fun showAIAssistantGroup() {
        try {
            // æ£€æŸ¥allContactsæ˜¯å¦å·²åˆå§‹åŒ–
            if (allContacts.isEmpty()) {
                Log.w(TAG, "allContactsä¸ºç©ºï¼Œæ— æ³•æ˜¾ç¤ºAIåŠ©æ‰‹åˆ†ç»„")
                return
            }

            // æŸ¥æ‰¾"AIåŠ©æ‰‹"åˆ†ç»„
            val aiAssistantCategory = allContacts.find { it.name == "AIåŠ©æ‰‹" }

            // è¿‡æ»¤å‡ºçœŸæ­£çš„AIè”ç³»äººï¼ˆæ’é™¤æç¤ºæ€§çš„è”ç³»äººï¼‰
            val realAIContacts = aiAssistantCategory?.contacts?.filter { contact ->
                contact.type == ContactType.AI &&
                !contact.id.contains("hint") &&
                !contact.id.contains("empty") &&
                contact.name != "æš‚æ— AIåŠ©æ‰‹"
            } ?: emptyList()

            val displayCategories = if (realAIContacts.isNotEmpty()) {
                // åªæ˜¾ç¤ºçœŸæ­£çš„AIè”ç³»äºº
                listOf(ContactCategory(
                    name = "AIåŠ©æ‰‹",
                    contacts = realAIContacts.toMutableList(),
                    isExpanded = true
                ))
            } else {
                // å¦‚æœAIåŠ©æ‰‹åˆ†ç»„ä¸ºç©ºï¼Œæ˜¾ç¤ºç©ºåˆ†ç»„ï¼ˆä¸æ·»åŠ è™šå‡è”ç³»äººï¼‰
                listOf(ContactCategory(
                    name = "AIåŠ©æ‰‹",
                    contacts = mutableListOf(),
                    isExpanded = true
                ))
            }

            chatContactAdapter?.updateContacts(displayCategories)
            Log.d(TAG, "æ˜¾ç¤ºAIåŠ©æ‰‹é¢„è®¾åˆ†ç»„ï¼ŒçœŸå®AIæ•°é‡: ${realAIContacts.size}")
        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºAIåŠ©æ‰‹é¢„è®¾åˆ†ç»„å¤±è´¥", e)
        }
    }

    /**
     * æ‰§è¡Œæ ‡ç­¾å†…å®¹åˆ‡æ¢ï¼ˆä¸ä½¿ç”¨åŠ¨ç”»ï¼‰
     * åŸºäºæ ‡ç­¾åç§°è€Œä¸æ˜¯ä½ç½®è¿›è¡Œåˆ‡æ¢
     */
    private fun executeTabContentSwitch(position: Int, tab: com.google.android.material.tabs.TabLayout.Tab?) {
        try {
            val tabText = tab?.text?.toString() ?: return

            when (tabText) {
                "å…¨éƒ¨" -> {
                    // "å…¨éƒ¨"æ ‡ç­¾ - æ˜¾ç¤ºæ‰€æœ‰åˆ†ç»„ä¸­çš„AIåŠ©æ‰‹èšåˆè§†å›¾
                    showAllUserAIContacts()
                    Log.d(TAG, "åˆ‡æ¢åˆ°å…¨éƒ¨æ ‡ç­¾é¡µ")
                }
                "AIåŠ©æ‰‹" -> {
                    // "AIåŠ©æ‰‹"æ ‡ç­¾ - æ˜¾ç¤ºé¢„è®¾åˆ†ç»„ä¸­çš„AI
                    showAIAssistantGroup()
                    Log.d(TAG, "åˆ‡æ¢åˆ°AIåŠ©æ‰‹æ ‡ç­¾é¡µ")
                }
                "+" -> {
                    // +å·æŒ‰é’® - åªæœ‰åœ¨ç”¨æˆ·ä¸»åŠ¨ç‚¹å‡»æ—¶æ‰åˆ›å»ºæ–°åˆ†ç»„
                    // å¦‚æœæ˜¯æ‹–æ‹½å¯¼è‡´çš„åˆ‡æ¢ï¼Œä¸æ‰§è¡Œä»»ä½•æ“ä½œ
                    if (!isDraggingTabs) {
                        showCreateCustomGroupDialog()
                        // é€‰æ‹©å›åˆ°ä¸Šä¸€ä¸ªæœ‰æ•ˆæ ‡ç­¾é¡µ
                        val chatTabLayout = findViewById<com.google.android.material.tabs.TabLayout>(R.id.chat_tab_layout)
                        val previousTab = if (currentTabPosition > 0) currentTabPosition - 1 else 0
                        chatTabLayout?.getTabAt(previousTab)?.select()
                    } else {
                        Log.d(TAG, "æ‹–æ‹½æ“ä½œä¸­ï¼Œè·³è¿‡+å·æŒ‰é’®å¤„ç†")
                    }
                    return
                }
                else -> {
                    // è‡ªå®šä¹‰åˆ†ç»„æ ‡ç­¾é¡µ
                    showCustomGroupContacts(tabText)
                    Log.d(TAG, "åˆ‡æ¢åˆ°è‡ªå®šä¹‰åˆ†ç»„æ ‡ç­¾é¡µ: $tabText")
                }
            }
        } catch (e: Exception) {
            Log.e(TAG, "æ‰§è¡Œæ ‡ç­¾å†…å®¹åˆ‡æ¢å¤±è´¥", e)
            // å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œå°è¯•æ˜¾ç¤ºé»˜è®¤çš„"å…¨éƒ¨"æ ‡ç­¾é¡µ
            try {
                showAllUserAIContacts()
                Log.d(TAG, "å¼‚å¸¸æ¢å¤ï¼šåˆ‡æ¢åˆ°å…¨éƒ¨æ ‡ç­¾é¡µ")
            } catch (recoveryException: Exception) {
                Log.e(TAG, "å¼‚å¸¸æ¢å¤å¤±è´¥", recoveryException)
            }
        }
    }

    /**
     * æ˜¾ç¤ºåˆ›å»ºè‡ªå®šä¹‰åˆ†ç»„å¯¹è¯æ¡†
     */
    private fun showCreateCustomGroupDialog() {
        try {
            val input = android.widget.EditText(this).apply {
                hint = "è¾“å…¥åˆ†ç»„åç§°"
                setPadding(50, 30, 50, 30)
            }

            AlertDialog.Builder(this, R.style.Theme_MaterialDialog)
                .setTitle("åˆ›å»ºæ–°åˆ†ç»„")
                .setMessage("ä¸ºAIåŠ©æ‰‹åˆ›å»ºæ–°çš„åˆ†ç»„")
                .setView(input)
                .setPositiveButton("åˆ›å»º") { _, _ ->
                    val groupName = input.text.toString().trim()
                    if (groupName.isNotEmpty()) {
                        createCustomGroup(groupName)
                        Toast.makeText(this, "å·²åˆ›å»ºåˆ†ç»„: $groupName", Toast.LENGTH_SHORT).show()
                    } else {
                        Toast.makeText(this, "åˆ†ç»„åç§°ä¸èƒ½ä¸ºç©º", Toast.LENGTH_SHORT).show()
                    }
                }
                .setNegativeButton("å–æ¶ˆ", null)
                .show()
        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºåˆ›å»ºè‡ªå®šä¹‰åˆ†ç»„å¯¹è¯æ¡†å¤±è´¥", e)
            Toast.makeText(this, "åˆ›å»ºåˆ†ç»„å¤±è´¥", Toast.LENGTH_SHORT).show()
        }
    }



    /**
     * AIé€‰æ‹©é¡¹æ•°æ®ç±»
     */
    private data class AISelectionItem(
        val name: String,
        val description: String,
        val iconRes: Int,
        val colorHex: String
    )

    /**
     * æ˜¾ç¤ºç®€åŒ–çš„AIé€‰æ‹©å¯¹è¯æ¡†
     */
    private fun showMaterialAISelectionDialog(aiList: List<AISelectionItem>) {
        try {
            // åˆ›å»ºå¯¹è¯æ¡†å¸ƒå±€
            val dialogView = layoutInflater.inflate(R.layout.dialog_ai_add_simple, null)
            val container = dialogView.findViewById<LinearLayout>(R.id.ai_selection_container)
            val btnCancel = dialogView.findViewById<com.google.android.material.button.MaterialButton>(R.id.btn_cancel)
            val btnConfirm = dialogView.findViewById<com.google.android.material.button.MaterialButton>(R.id.btn_confirm)

            // å­˜å‚¨é€‰ä¸­çš„AI
            val selectedAIs = mutableListOf<AISelectionItem>()

            // åŠ¨æ€åˆ›å»ºAIé€‰æ‹©é¡¹
            aiList.forEach { aiItem ->
                val itemView = layoutInflater.inflate(R.layout.item_ai_selection_simple, container, false)

                val aiIcon = itemView.findViewById<ImageView>(R.id.ai_icon)
                val aiName = itemView.findViewById<TextView>(R.id.ai_name)
                val aiSwitch = itemView.findViewById<com.google.android.material.materialswitch.MaterialSwitch>(R.id.ai_switch)
                val apiKeyInputLayout = itemView.findViewById<com.google.android.material.textfield.TextInputLayout>(R.id.api_key_input_layout)
                val apiKeyInput = itemView.findViewById<com.google.android.material.textfield.TextInputEditText>(R.id.api_key_input)
                val statusContainer = itemView.findViewById<LinearLayout>(R.id.status_container)
                val statusIcon = itemView.findViewById<ImageView>(R.id.status_icon)
                val statusText = itemView.findViewById<TextView>(R.id.status_text)

                // è®¾ç½®AIä¿¡æ¯
                aiName.text = aiItem.name

                // ä½¿ç”¨FaviconLoaderåŠ è½½AIå›¾æ ‡
                FaviconLoader.loadAIEngineIcon(aiIcon, aiItem.name, R.drawable.ic_smart_toy)

                // æ£€æŸ¥APIå¯†é’¥å’Œè”ç³»äººçŠ¶æ€
                val hasApiKey = getApiKeyForAI(aiItem.name).isNotBlank()
                val hasContact = hasAIContact(aiItem.name)

                if (hasContact && hasApiKey) {
                    // å·²æ·»åŠ çŠ¶æ€
                    statusContainer.visibility = android.view.View.VISIBLE
                    statusText.text = "å·²æ·»åŠ "
                    statusIcon.setImageResource(R.drawable.ic_check_circle)
                    aiSwitch.isEnabled = false
                    itemView.alpha = 0.6f
                } else {
                    // è®¾ç½®APIå¯†é’¥
                    if (hasApiKey) {
                        apiKeyInput.setText(getApiKeyForAI(aiItem.name))
                        aiSwitch.isChecked = true
                    }

                    // å¼€å…³çŠ¶æ€å˜åŒ–ç›‘å¬
                    aiSwitch.setOnCheckedChangeListener { _, isChecked ->
                        if (isChecked) {
                            apiKeyInputLayout.visibility = android.view.View.VISIBLE
                            if (!selectedAIs.contains(aiItem)) {
                                selectedAIs.add(aiItem)
                            }
                        } else {
                            apiKeyInputLayout.visibility = android.view.View.GONE
                            selectedAIs.remove(aiItem)
                        }
                        btnConfirm.isEnabled = selectedAIs.isNotEmpty()
                    }

                    // å¦‚æœå·²é€‰ä¸­ï¼Œæ˜¾ç¤ºAPIå¯†é’¥è¾“å…¥æ¡†
                    if (aiSwitch.isChecked) {
                        apiKeyInputLayout.visibility = android.view.View.VISIBLE
                        selectedAIs.add(aiItem)
                    }
                }

                container.addView(itemView)
            }

            // åˆ›å»ºå¯¹è¯æ¡†
            val dialog = androidx.appcompat.app.AlertDialog.Builder(this, R.style.Theme_MaterialDialog)
                .setView(dialogView)
                .setCancelable(true)
                .create()

            // è®¾ç½®æŒ‰é’®äº‹ä»¶
            btnCancel.setOnClickListener { dialog.dismiss() }

            btnConfirm.setOnClickListener {
                // å¤„ç†é€‰ä¸­çš„AI
                selectedAIs.forEach { aiItem ->
                    // æŸ¥æ‰¾å¯¹åº”çš„è¾“å…¥æ¡†å¹¶ä¿å­˜APIå¯†é’¥
                    for (i in 0 until container.childCount) {
                        val childView = container.getChildAt(i)
                        val nameView = childView.findViewById<TextView>(R.id.ai_name)
                        if (nameView.text.toString() == aiItem.name) {
                            val apiKeyInput = childView.findViewById<com.google.android.material.textfield.TextInputEditText>(R.id.api_key_input)
                            val apiKey = apiKeyInput.text.toString().trim()

                            if (apiKey.isNotEmpty()) {
                                // ä¿å­˜APIå¯†é’¥
                                saveApiKeyForAI(aiItem.name, apiKey)
                            }

                            // æ·»åŠ AIè”ç³»äºº
                            addAIContactToCategory(aiItem.name, "AIåŠ©æ‰‹", "")
                            break
                        }
                    }
                }

                chatContactAdapter?.updateContacts(allContacts)
                dialog.dismiss()

                if (selectedAIs.isNotEmpty()) {
                    Toast.makeText(this, "å·²æ·»åŠ  ${selectedAIs.size} ä¸ªAIåŠ©æ‰‹", Toast.LENGTH_SHORT).show()
                }
            }

            // åˆå§‹çŠ¶æ€
            btnConfirm.isEnabled = false

            dialog.show()

        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºMaterial AIé€‰æ‹©å¯¹è¯æ¡†å¤±è´¥", e)
        }
    }

    /**
     * æ˜¾ç¤ºç»Ÿä¸€çš„AIé€‰æ‹©å¯¹è¯æ¡†
     */
    private fun showUnifiedAISelectionDialog() {
        try {
            // åˆ›å»ºä¸»å¯¹è¯æ¡†
            val dialogBuilder = AlertDialog.Builder(this)
            dialogBuilder.setTitle("ğŸ“± æ·»åŠ AIåŠ©æ‰‹")
            dialogBuilder.setMessage("é€‰æ‹©æ‚¨è¦æ·»åŠ çš„AIåŠ©æ‰‹ç±»å‹ï¼š")

            // å®šä¹‰AIé€‰é¡¹
            val aiOptions = arrayOf(
                "ğŸ” æœç´¢AIåŠ©æ‰‹ - ä»é¢„è®¾åˆ—è¡¨ä¸­é€‰æ‹©",
                "âš™ï¸ è‡ªå®šä¹‰API - å¡«å†™è‡ªå®šä¹‰APIä¿¡æ¯"
            )

            dialogBuilder.setItems(aiOptions) { _, which ->
                when (which) {
                    0 -> showPresetAISelectionDialog() // æ˜¾ç¤ºé¢„è®¾AIåˆ—è¡¨
                    1 -> showCustomAPIDialog() // æ˜¾ç¤ºè‡ªå®šä¹‰APIå¯¹è¯æ¡†
                }
            }

            dialogBuilder.setNegativeButton("å–æ¶ˆ", null)
            dialogBuilder.show()

        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºç»Ÿä¸€AIé€‰æ‹©å¯¹è¯æ¡†å¤±è´¥", e)
        }
    }

    /**
     * æ˜¾ç¤ºé¢„è®¾AIé€‰æ‹©å¯¹è¯æ¡†ï¼ˆæ”¯æŒå‹¾é€‰ï¼‰
     */
    private fun showPresetAISelectionDialog() {
        try {
            // å®šä¹‰é¢„è®¾AIåˆ—è¡¨
            val presetAIs = listOf(
                "DeepSeek" to "ğŸš€ DeepSeek - æ€§èƒ½å¼ºåŠ²ï¼Œæ”¯æŒä¸­æ–‡",
                "æ™ºè°±AI" to "ğŸ§  æ™ºè°±AI - GLM-4å¤§è¯­è¨€æ¨¡å‹",
                "ChatGPT" to "ğŸ¤– ChatGPT - OpenAIçš„ç»å…¸æ¨¡å‹",
                "Claude" to "ğŸ’¡ Claude - Anthropicçš„æ™ºèƒ½åŠ©æ‰‹",
                "Gemini" to "ğŸŒŸ Gemini - Googleçš„AIåŠ©æ‰‹",
                "Kimi" to "ğŸŒ™ Kimi - Moonshotçš„é•¿æ–‡æœ¬ä¸“å®¶",
                "æ–‡å¿ƒä¸€è¨€" to "ğŸ“š æ–‡å¿ƒä¸€è¨€ - ç™¾åº¦çš„å¤§è¯­è¨€æ¨¡å‹",
                "é€šä¹‰åƒé—®" to "ğŸ¯ é€šä¹‰åƒé—® - é˜¿é‡Œå·´å·´çš„AI",
                "è®¯é£æ˜Ÿç«" to "âš¡ è®¯é£æ˜Ÿç« - ç§‘å¤§è®¯é£çš„AI"
            )

            // åˆ›å»ºè‡ªå®šä¹‰å¸ƒå±€
            val dialogLayout = LinearLayout(this).apply {
                orientation = LinearLayout.VERTICAL
                setPadding(40, 30, 40, 30)
            }

            // æ ‡é¢˜
            val titleText = TextView(this).apply {
                text = "ğŸ“± æ·»åŠ AIåŠ©æ‰‹"
                textSize = 18f
                setTextColor(getColor(R.color.simple_mode_text_primary_light))
                setPadding(0, 0, 0, 20)
                gravity = android.view.Gravity.CENTER
            }
            dialogLayout.addView(titleText)

            // è¯´æ˜æ–‡å­—
            val instructionText = TextView(this).apply {
                text = "å‹¾é€‰è¦æ·»åŠ çš„AIåŠ©æ‰‹ï¼Œç„¶åé…ç½®APIå¯†é’¥ï¼š"
                textSize = 14f
                setTextColor(getColor(R.color.simple_mode_text_secondary_light))
                setPadding(0, 0, 0, 15)
            }
            dialogLayout.addView(instructionText)

            // AIé€‰æ‹©åˆ—è¡¨
            val aiCheckBoxes = mutableListOf<CheckBox>()
            presetAIs.forEach { (aiName, description) ->
                val hasApiKey = getApiKeyForAI(aiName).isNotBlank()
                val hasContact = hasAIContact(aiName)

                val checkBox = CheckBox(this).apply {
                    text = when {
                        hasContact && hasApiKey -> "$description âœ…"
                        hasApiKey -> "$description âš ï¸ æœ‰å¯†é’¥"
                        else -> description
                    }
                    textSize = 14f
                    setPadding(0, 8, 0, 8)
                    isChecked = !hasContact && hasApiKey // æœ‰å¯†é’¥ä½†æ²¡è”ç³»äººçš„é»˜è®¤å‹¾é€‰
                }

                dialogLayout.addView(checkBox)
                aiCheckBoxes.add(checkBox)
            }

            // åˆ›å»ºå¯¹è¯æ¡†
            val dialog = AlertDialog.Builder(this)
                .setView(dialogLayout)
                .setPositiveButton("é…ç½®é€‰ä¸­çš„AI") { _, _ ->
                    val selectedAIs = mutableListOf<Pair<String, String>>()
                    aiCheckBoxes.forEachIndexed { index, checkBox ->
                        if (checkBox.isChecked) {
                            selectedAIs.add(presetAIs[index])
                        }
                    }

                    if (selectedAIs.isNotEmpty()) {
                        showBatchConfigurationDialog(selectedAIs)
                    } else {
                        Toast.makeText(this@SimpleModeActivity, "è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªAIåŠ©æ‰‹", Toast.LENGTH_SHORT).show()
                    }
                }
                .setNegativeButton("å–æ¶ˆ", null)
                .create()

            dialog.show()

        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºé¢„è®¾AIé€‰æ‹©å¯¹è¯æ¡†å¤±è´¥", e)
        }
    }

    /**
     * æ˜¾ç¤ºæ‰¹é‡é…ç½®å¯¹è¯æ¡†
     */
    private fun showBatchConfigurationDialog(selectedAIs: List<Pair<String, String>>) {
        try {
            // åˆ›å»ºæ‰¹é‡é…ç½®ç•Œé¢
            val dialogLayout = LinearLayout(this).apply {
                orientation = LinearLayout.VERTICAL
                setPadding(40, 30, 40, 30)
            }

            // æ ‡é¢˜
            val titleText = TextView(this).apply {
                text = "ğŸ”§ æ‰¹é‡é…ç½®AIåŠ©æ‰‹"
                textSize = 18f
                setTextColor(getColor(R.color.simple_mode_text_primary_light))
                setPadding(0, 0, 0, 20)
                gravity = android.view.Gravity.CENTER
            }
            dialogLayout.addView(titleText)

            // è¯´æ˜æ–‡å­—
            val instructionText = TextView(this).apply {
                text = "ä¸ºé€‰ä¸­çš„AIåŠ©æ‰‹é…ç½®APIå¯†é’¥ï¼š"
                textSize = 14f
                setTextColor(getColor(R.color.simple_mode_text_secondary_light))
                setPadding(0, 0, 0, 15)
            }
            dialogLayout.addView(instructionText)

            // æ»šåŠ¨å®¹å™¨
            val scrollView = ScrollView(this).apply {
                layoutParams = LinearLayout.LayoutParams(
                    LinearLayout.LayoutParams.MATCH_PARENT,
                    400 // é™åˆ¶é«˜åº¦
                )
            }

            val scrollContent = LinearLayout(this).apply {
                orientation = LinearLayout.VERTICAL
                setPadding(0, 0, 0, 0)
            }

            // ä¸ºæ¯ä¸ªAIåˆ›å»ºé…ç½®é¡¹
            val apiKeyInputs = mutableMapOf<String, EditText>()
            selectedAIs.forEach { (aiName, description) ->
                // AIåç§°
                val aiNameText = TextView(this).apply {
                    text = description
                    textSize = 14f
                    setTextColor(getColor(R.color.simple_mode_text_primary_light))
                    setTypeface(null, android.graphics.Typeface.BOLD)
                    setPadding(0, 15, 0, 8)
                }
                scrollContent.addView(aiNameText)

                // APIå¯†é’¥è¾“å…¥æ¡†
                val apiKeyInput = EditText(this).apply {
                    hint = "è¾“å…¥${aiName}çš„APIå¯†é’¥"
                    inputType = android.text.InputType.TYPE_CLASS_TEXT or android.text.InputType.TYPE_TEXT_VARIATION_PASSWORD
                    setPadding(20, 15, 20, 15)
                    background = getDrawable(R.drawable.edit_text_background)

                    // å¦‚æœå·²æœ‰APIå¯†é’¥ï¼Œé¢„å¡«å……
                    val existingApiKey = getApiKeyForAI(aiName)
                    if (existingApiKey.isNotBlank()) {
                        setText(existingApiKey)
                    }
                }
                scrollContent.addView(apiKeyInput)
                apiKeyInputs[aiName] = apiKeyInput

                // é—´è·
                val spacer = View(this).apply {
                    layoutParams = LinearLayout.LayoutParams(
                        LinearLayout.LayoutParams.MATCH_PARENT,
                        10
                    )
                }
                scrollContent.addView(spacer)
            }

            scrollView.addView(scrollContent)
            dialogLayout.addView(scrollView)

            // åˆ›å»ºå¯¹è¯æ¡†
            val dialog = AlertDialog.Builder(this)
                .setView(dialogLayout)
                .setPositiveButton("ä¿å­˜å¹¶æ·»åŠ ") { _, _ ->
                    var successCount = 0
                    var errorCount = 0

                    selectedAIs.forEach { (aiName, description) ->
                        try {
                            val apiKey = apiKeyInputs[aiName]?.text?.toString()?.trim() ?: ""
                            if (apiKey.isNotBlank() && isValidApiKey(apiKey, aiName)) {
                                // ä¿å­˜APIå¯†é’¥
                                saveApiKeyForAI(aiName, apiKey)

                                // å¦‚æœè¿˜æ²¡æœ‰è”ç³»äººï¼Œåˆ™æ·»åŠ 
                                if (!hasAIContact(aiName)) {
                                    addAIContactToCategory(aiName, description, apiKey)
                                }

                                successCount++
                            } else {
                                errorCount++
                            }
                        } catch (e: Exception) {
                            Log.e(TAG, "é…ç½®${aiName}å¤±è´¥", e)
                            errorCount++
                        }
                    }

                    // æ˜¾ç¤ºç»“æœ
                    val message = when {
                        successCount > 0 && errorCount == 0 -> "æˆåŠŸé…ç½®${successCount}ä¸ªAIåŠ©æ‰‹"
                        successCount > 0 && errorCount > 0 -> "æˆåŠŸé…ç½®${successCount}ä¸ªï¼Œå¤±è´¥${errorCount}ä¸ªAIåŠ©æ‰‹"
                        else -> "é…ç½®å¤±è´¥ï¼Œè¯·æ£€æŸ¥APIå¯†é’¥æ ¼å¼"
                    }
                    Toast.makeText(this@SimpleModeActivity, message, Toast.LENGTH_LONG).show()

                    // åˆ·æ–°UI
                    if (successCount > 0) {
                        chatContactAdapter?.updateContacts(allContacts)
                    }
                }
                .setNeutralButton("æµ‹è¯•è¿é€šæ€§") { _, _ ->
                    // æ‰¹é‡æµ‹è¯•APIè¿é€šæ€§
                    batchTestApiConnections(selectedAIs, apiKeyInputs)
                }
                .setNegativeButton("å–æ¶ˆ", null)
                .create()

            dialog.show()

        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºæ‰¹é‡é…ç½®å¯¹è¯æ¡†å¤±è´¥", e)
        }
    }

    /**
     * æ‰¹é‡æµ‹è¯•APIè¿é€šæ€§
     */
    private fun batchTestApiConnections(
        selectedAIs: List<Pair<String, String>>,
        apiKeyInputs: Map<String, EditText>
    ) {
        try {
            val testResults = mutableMapOf<String, String>()
            var completedTests = 0
            val totalTests = selectedAIs.size

            // æ˜¾ç¤ºæµ‹è¯•è¿›åº¦å¯¹è¯æ¡†
            val progressDialog = AlertDialog.Builder(this)
                .setTitle("ğŸ§ª æµ‹è¯•è¿é€šæ€§")
                .setMessage("æ­£åœ¨æµ‹è¯•APIè¿æ¥...")
                .setCancelable(false)
                .create()
            progressDialog.show()

            selectedAIs.forEach { (aiName, _) ->
                val apiKey = apiKeyInputs[aiName]?.text?.toString()?.trim() ?: ""

                if (apiKey.isNotBlank()) {
                    lifecycleScope.launch {
                        try {
                            val result = performAPITest(aiName, apiKey)
                            testResults[aiName] = if (result.success) "âœ… ${result.message}" else "âŒ ${result.message}"
                        } catch (e: Exception) {
                            testResults[aiName] = "âŒ æµ‹è¯•å¤±è´¥: ${e.message}"
                        }

                        completedTests++
                        if (completedTests >= totalTests) {
                            runOnUiThread {
                                progressDialog.dismiss()
                                showTestResults(testResults)
                            }
                        }
                    }
                } else {
                    testResults[aiName] = "âš ï¸ APIå¯†é’¥ä¸ºç©º"
                    completedTests++
                    if (completedTests >= totalTests) {
                        progressDialog.dismiss()
                        showTestResults(testResults)
                    }
                }
            }

        } catch (e: Exception) {
            Log.e(TAG, "æ‰¹é‡æµ‹è¯•APIè¿é€šæ€§å¤±è´¥", e)
        }
    }

    /**
     * æ˜¾ç¤ºæµ‹è¯•ç»“æœ
     */
    private fun showTestResults(testResults: Map<String, String>) {
        try {
            val resultText = testResults.entries.joinToString("\n\n") { (aiName, result) ->
                "$aiName:\n$result"
            }

            AlertDialog.Builder(this)
                .setTitle("ğŸ§ª è¿é€šæ€§æµ‹è¯•ç»“æœ")
                .setMessage(resultText)
                .setPositiveButton("ç¡®å®š", null)
                .show()

        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºæµ‹è¯•ç»“æœå¤±è´¥", e)
        }
    }

    /**
     * æ£€æŸ¥æ˜¯å¦å·²æœ‰è¯¥AIè”ç³»äºº
     */
    private fun hasAIContact(aiName: String): Boolean {
        return try {
            for (category in allContacts) {
                for (contact in category.contacts) {
                    if (contact.name.equals(aiName, ignoreCase = true)) {
                        return true
                    }
                }
            }
            false
        } catch (e: Exception) {
            false
        }
    }

    /**
     * æ˜¾ç¤ºé‡æ–°é…ç½®å¯¹è¯æ¡†
     */
    private fun showReconfigureDialog(aiName: String, description: String) {
        try {
            val dialogBuilder = AlertDialog.Builder(this)
            dialogBuilder.setTitle("ğŸ”„ é‡æ–°é…ç½®")
            dialogBuilder.setMessage("${aiName}å·²å­˜åœ¨ï¼Œæ‚¨è¦æ‰§è¡Œä»€ä¹ˆæ“ä½œï¼Ÿ")

            dialogBuilder.setPositiveButton("é‡æ–°é…ç½®API") { _, _ ->
                showAIApiKeyDialog(aiName, description)
            }

            dialogBuilder.setNeutralButton("æ‰“å¼€å¯¹è¯") { _, _ ->
                // æ‰¾åˆ°è¯¥AIè”ç³»äººå¹¶æ‰“å¼€å¯¹è¯
                for (category in allContacts) {
                    for (contact in category.contacts) {
                        if (contact.name.equals(aiName, ignoreCase = true)) {
                            openChatWithContact(contact)
                            return@setNeutralButton
                        }
                    }
                }
            }

            dialogBuilder.setNegativeButton("å–æ¶ˆ", null)
            dialogBuilder.show()

        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºé‡æ–°é…ç½®å¯¹è¯æ¡†å¤±è´¥", e)
        }
    }

    /**
     * æ˜¾ç¤ºAI APIå¯†é’¥è¾“å…¥å¯¹è¯æ¡†ï¼ˆå¸¦æµ‹è¯•åŠŸèƒ½ï¼‰
     */
    private fun showAIApiKeyDialog(aiName: String, aiDescription: String) {
        try {
            // åˆ›å»ºè‡ªå®šä¹‰å¸ƒå±€
            val dialogLayout = LinearLayout(this).apply {
                orientation = LinearLayout.VERTICAL
                setPadding(50, 30, 50, 30)
            }

            // AIä¿¡æ¯æ˜¾ç¤º
            val infoText = TextView(this).apply {
                text = "é…ç½® $aiDescription"
                textSize = 16f
                setTextColor(getColor(R.color.simple_mode_text_primary_light))
                setPadding(0, 0, 0, 20)
            }
            dialogLayout.addView(infoText)

            // APIå¯†é’¥è¾“å…¥æ¡†
            val apiKeyInput = EditText(this).apply {
                hint = "è¯·è¾“å…¥${aiName}çš„APIå¯†é’¥"
                inputType = android.text.InputType.TYPE_CLASS_TEXT or android.text.InputType.TYPE_TEXT_VARIATION_PASSWORD
                setPadding(20, 15, 20, 15)
                background = getDrawable(R.drawable.edit_text_background)
            }
            dialogLayout.addView(apiKeyInput)

            // æ·»åŠ é—´è·
            val spacer1 = View(this).apply {
                layoutParams = LinearLayout.LayoutParams(0, 20)
            }
            dialogLayout.addView(spacer1)

            // æµ‹è¯•ç»“æœæ˜¾ç¤º
            val testResultText = TextView(this).apply {
                text = "ğŸ’¡ è¾“å…¥APIå¯†é’¥åå¯æµ‹è¯•è¿é€šæ€§"
                textSize = 14f
                setTextColor(getColor(R.color.simple_mode_text_secondary_light))
                setPadding(20, 10, 20, 10)
                background = getDrawable(R.drawable.search_box_background)
            }
            dialogLayout.addView(testResultText)

            // æ·»åŠ é—´è·
            val spacer2 = View(this).apply {
                layoutParams = LinearLayout.LayoutParams(0, 15)
            }
            dialogLayout.addView(spacer2)

            // æŒ‰é’®å®¹å™¨
            val buttonLayout = LinearLayout(this).apply {
                orientation = LinearLayout.HORIZONTAL
                gravity = android.view.Gravity.CENTER
            }

            // æµ‹è¯•è¿é€šæ€§æŒ‰é’®
            val testButton = MaterialButton(this).apply {
                text = "ğŸ§ª æµ‹è¯•è¿é€šæ€§"
                setBackgroundColor(getColor(R.color.simple_mode_accent_light))
                setTextColor(getColor(android.R.color.white))
                isEnabled = false
                layoutParams = LinearLayout.LayoutParams(0, LinearLayout.LayoutParams.WRAP_CONTENT, 1f).apply {
                    marginEnd = 10
                }
            }
            buttonLayout.addView(testButton)

            // ä¿å­˜æŒ‰é’®
            val saveButton = MaterialButton(this).apply {
                text = "ğŸ’¾ ä¿å­˜é…ç½®"
                setBackgroundColor(getColor(R.color.simple_mode_primary_light))
                setTextColor(getColor(android.R.color.white))
                isEnabled = false
                layoutParams = LinearLayout.LayoutParams(0, LinearLayout.LayoutParams.WRAP_CONTENT, 1f).apply {
                    marginStart = 10
                }
            }
            buttonLayout.addView(saveButton)

            dialogLayout.addView(buttonLayout)

            // åˆ›å»ºå¯¹è¯æ¡†
            val dialog = AlertDialog.Builder(this)
                .setTitle("ğŸ”§ é…ç½®${aiName}")
                .setView(dialogLayout)
                .setNegativeButton("å–æ¶ˆ", null)
                .create()

            // ç›‘å¬APIå¯†é’¥è¾“å…¥
            apiKeyInput.addTextChangedListener(object : android.text.TextWatcher {
                override fun beforeTextChanged(s: CharSequence?, start: Int, count: Int, after: Int) {}
                override fun onTextChanged(s: CharSequence?, start: Int, before: Int, count: Int) {}
                override fun afterTextChanged(s: android.text.Editable?) {
                    val apiKey = s?.toString()?.trim() ?: ""
                    val isValid = isValidApiKey(apiKey, aiName)
                    testButton.isEnabled = isValid
                    saveButton.isEnabled = isValid

                    if (apiKey.isEmpty()) {
                        testResultText.text = "ğŸ’¡ è¾“å…¥APIå¯†é’¥åå¯æµ‹è¯•è¿é€šæ€§"
                        testResultText.setTextColor(getColor(R.color.simple_mode_text_secondary_light))
                    } else if (!isValid) {
                        testResultText.text = "âŒ APIå¯†é’¥æ ¼å¼ä¸æ­£ç¡®"
                        testResultText.setTextColor(getColor(android.R.color.holo_red_dark))
                    } else {
                        testResultText.text = "âœ… APIå¯†é’¥æ ¼å¼æ­£ç¡®ï¼Œå¯ä»¥æµ‹è¯•è¿é€šæ€§"
                        testResultText.setTextColor(getColor(android.R.color.holo_green_dark))
                    }
                }
            })

            // æµ‹è¯•æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            testButton.setOnClickListener {
                val apiKey = apiKeyInput.text.toString().trim()
                testAPIConnection(aiName, apiKey, testResultText)
            }

            // ä¿å­˜æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            saveButton.setOnClickListener {
                val apiKey = apiKeyInput.text.toString().trim()
                if (isValidApiKey(apiKey, aiName)) {
                    // ä¿å­˜APIå¯†é’¥
                    saveApiKeyForAI(aiName, apiKey)

                    // æ·»åŠ AIåŠ©æ‰‹åˆ°è”ç³»äººåˆ—è¡¨
                    addAIContactToCategory(aiName, aiDescription, apiKey)

                dialog.dismiss()
                    Toast.makeText(this, "${aiName}å·²æˆåŠŸæ·»åŠ ", Toast.LENGTH_SHORT).show()
                } else {
                    Toast.makeText(this, "APIå¯†é’¥æ ¼å¼ä¸æ­£ç¡®", Toast.LENGTH_SHORT).show()
                }
            }

            dialog.show()

        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºAI APIå¯†é’¥å¯¹è¯æ¡†å¤±è´¥", e)
            Toast.makeText(this, "æ˜¾ç¤ºå¯¹è¯æ¡†å¤±è´¥", Toast.LENGTH_SHORT).show()
        }
    }

    /**
     * æµ‹è¯•APIè¿æ¥
     */
    private fun testAPIConnection(aiName: String, apiKey: String, resultTextView: TextView) {
        try {
            resultTextView.text = "ğŸ”„ æ­£åœ¨æµ‹è¯•è¿æ¥..."
            resultTextView.setTextColor(getColor(R.color.simple_mode_accent_light))

            // ä½¿ç”¨åç¨‹è¿›è¡Œå¼‚æ­¥æµ‹è¯•
            lifecycleScope.launch {
                try {
                    val result = performAPITest(aiName, apiKey)
                    runOnUiThread {
                        if (result.success) {
                            resultTextView.text = "âœ… è¿æ¥æˆåŠŸï¼${result.message}"
                            resultTextView.setTextColor(getColor(android.R.color.holo_green_dark))
                        } else {
                            resultTextView.text = "âŒ è¿æ¥å¤±è´¥ï¼š${result.message}"
                            resultTextView.setTextColor(getColor(android.R.color.holo_red_dark))
                        }
                    }
                } catch (e: Exception) {
                    runOnUiThread {
                        resultTextView.text = "âŒ æµ‹è¯•å¤±è´¥ï¼š${e.message}"
                        resultTextView.setTextColor(getColor(android.R.color.holo_red_dark))
                    }
                }
            }

        } catch (e: Exception) {
            Log.e(TAG, "æµ‹è¯•APIè¿æ¥å¤±è´¥", e)
            resultTextView.text = "âŒ æµ‹è¯•å¤±è´¥ï¼š${e.message}"
            resultTextView.setTextColor(getColor(android.R.color.holo_red_dark))
        }
    }

    /**
     * æ‰§è¡ŒAPIæµ‹è¯•
     */
    private suspend fun performAPITest(aiName: String, apiKey: String): TestResult {
        return withContext(Dispatchers.IO) {
            try {
                val apiUrl = getDefaultApiUrl(aiName)
                val url = URL(apiUrl)
                val connection = url.openConnection() as HttpURLConnection

                connection.apply {
                    requestMethod = "POST"
                    setRequestProperty("Content-Type", "application/json")
                    setRequestProperty("Authorization", "Bearer $apiKey")
                    connectTimeout = 10000
                    readTimeout = 10000
                    doOutput = true
                }

                // æ„å»ºæµ‹è¯•è¯·æ±‚
                val testMessage = when (aiName.lowercase()) {
                    "æ™ºè°±ai" -> """{"model":"glm-4","messages":[{"role":"user","content":"hi"}]}"""
                    "deepseek" -> """{"model":"deepseek-chat","messages":[{"role":"user","content":"hi"}]}"""
                    "kimi" -> """{"model":"moonshot-v1-8k","messages":[{"role":"user","content":"hi"}]}"""
                    else -> """{"model":"gpt-3.5-turbo","messages":[{"role":"user","content":"hi"}]}"""
                }

                connection.outputStream.use { os ->
                    val input = testMessage.toByteArray(Charsets.UTF_8)
                    os.write(input, 0, input.size)
                }

                val responseCode = connection.responseCode
                when (responseCode) {
                    200 -> TestResult(true, "APIè¿æ¥æ­£å¸¸")
                    401 -> TestResult(false, "APIå¯†é’¥æ— æ•ˆ")
                    429 -> TestResult(false, "è¯·æ±‚é¢‘ç‡è¿‡é«˜")
                    500 -> TestResult(false, "æœåŠ¡å™¨å†…éƒ¨é”™è¯¯")
                    else -> TestResult(false, "HTTPé”™è¯¯ç : $responseCode")
                }

            } catch (e: Exception) {
                when {
                    e.message?.contains("timeout") == true -> TestResult(false, "è¿æ¥è¶…æ—¶")
                    e.message?.contains("UnknownHostException") == true -> TestResult(false, "æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨")
                    else -> TestResult(false, e.message ?: "æœªçŸ¥é”™è¯¯")
                }
            }
        }
    }

    /**
     * APIæµ‹è¯•ç»“æœæ•°æ®ç±»
     */
    data class TestResult(val success: Boolean, val message: String)

    /**
     * æ˜¾ç¤ºè‡ªå®šä¹‰APIå¯¹è¯æ¡†
     */
    private fun showCustomAPIDialog() {
        // å¤ç”¨åŸæ¥çš„openAddAPIContactDialogé€»è¾‘
        openAddAPIContactDialog()
    }

    /**
     * åŠ è½½åˆå§‹è”ç³»äººæ•°æ®
     */
    private fun loadInitialContacts() {
        try {
            // é¦–å…ˆå°è¯•ä»å­˜å‚¨ä¸­æ¢å¤è”ç³»äººæ•°æ®
            val savedContacts = loadSavedContacts()
            if (savedContacts.isNotEmpty()) {
                allContacts = savedContacts.toMutableList()
                
                // ç¡®ä¿ä¸´æ—¶ä¸“çº¿å§‹ç»ˆå­˜åœ¨äºè”ç³»äººåˆ—è¡¨ä¸­
                ensureTempServiceInContacts()
                
                // ä½¿ç”¨ç»Ÿä¸€ç¾¤èŠç®¡ç†å™¨åŒæ­¥ç¾¤èŠæ•°æ®
                try {
                    syncGroupChatsFromUnifiedManager()
                } catch (e: Exception) {
                    Log.e(TAG, "ä»ç»Ÿä¸€ç®¡ç†å™¨åŒæ­¥ç¾¤èŠæ•°æ®å¤±è´¥", e)
                }
                
                chatContactAdapter?.updateContacts(allContacts)
                Log.d(TAG, "ä»å­˜å‚¨ä¸­æ¢å¤äº† ${savedContacts.size} ä¸ªè”ç³»äººåˆ†ç±»")
                return
            }

            // å¦‚æœæ²¡æœ‰ä¿å­˜çš„æ•°æ®ï¼Œåˆ™ç”Ÿæˆé»˜è®¤è”ç³»äºº
            generateDefaultContacts()

        } catch (e: Exception) {
            Log.e(TAG, "åŠ è½½åˆå§‹è”ç³»äººæ•°æ®å¤±è´¥", e)
            // å‡ºé”™æ—¶ç”Ÿæˆé»˜è®¤è”ç³»äºº
            generateDefaultContacts()
        }
    }

    /**
     * ä»ç»Ÿä¸€ç¾¤èŠç®¡ç†å™¨åŒæ­¥ç¾¤èŠæ•°æ®åˆ°allContacts
     * ä½¿ç”¨æ–°çš„UnifiedGroupChatManagerä½œä¸ºå•ä¸€æ•°æ®æº
     */
    private fun syncGroupChatsFromUnifiedManager() {
        try {
            // æ£€æŸ¥unifiedGroupChatManageræ˜¯å¦å·²åˆå§‹åŒ–
            if (!::unifiedGroupChatManager.isInitialized) {
                Log.w(TAG, "unifiedGroupChatManageræœªåˆå§‹åŒ–ï¼Œè·³è¿‡ç¾¤èŠæ•°æ®åŒæ­¥")
                return
            }

            val groupChats = unifiedGroupChatManager.getAllGroupChats()
            if (groupChats.isEmpty()) {
                Log.d(TAG, "UnifiedGroupChatManagerä¸­æ²¡æœ‰ç¾¤èŠæ•°æ®")
                return
            }

            // æ”¶é›†allContactsä¸­å·²å­˜åœ¨çš„ç¾¤èŠID
            val existingGroupIds = mutableSetOf<String>()
            for (category in allContacts) {
                for (contact in category.contacts) {
                    if (contact.type == ContactType.GROUP && contact.groupId != null) {
                        existingGroupIds.add(contact.groupId!!)
                    }
                }
            }

            // æ‰¾å‡ºéœ€è¦æ·»åŠ çš„æ–°ç¾¤èŠ
            val newGroupChats = groupChats.filter { !existingGroupIds.contains(it.id) }
            if (newGroupChats.isNotEmpty()) {
                val groupChatContacts = newGroupChats.map { groupChat ->
                    ChatContact(
                        id = groupChat.id,
                        name = groupChat.name,
                        avatar = groupChat.avatar,
                        type = ContactType.GROUP,
                        description = groupChat.description,
                        isOnline = true,
                        lastMessage = groupChat.lastMessage,
                        lastMessageTime = groupChat.lastMessageTime,
                        unreadCount = groupChat.unreadCount,
                        isPinned = groupChat.isPinned,
                        isMuted = groupChat.isMuted,
                        groupId = groupChat.id,
                        memberCount = groupChat.members.size,
                        aiMembers = groupChat.members.filter { member -> member.type == MemberType.AI }.map { member -> member.name }
                    )
                }

                // æ·»åŠ åˆ°ç¬¬ä¸€ä¸ªåˆ†ç±»ä¸­ï¼ˆé€šå¸¸æ˜¯"å…¨éƒ¨è”ç³»äºº"ï¼‰
                if (allContacts.isNotEmpty()) {
                    allContacts[0].contacts.addAll(groupChatContacts)
                } else {
                    allContacts.add(ContactCategory("å…¨éƒ¨è”ç³»äºº", groupChatContacts.toMutableList()))
                }
                
                Log.d(TAG, "ä»ç»Ÿä¸€ç®¡ç†å™¨åŒæ­¥äº† ${newGroupChats.size} ä¸ªæ–°ç¾¤èŠåˆ°allContacts")
            } else {
                Log.d(TAG, "æ‰€æœ‰ç¾¤èŠå·²å­˜åœ¨äºallContactsä¸­ï¼Œæ— éœ€åŒæ­¥")
            }
        } catch (e: Exception) {
            Log.e(TAG, "ä»ç»Ÿä¸€ç®¡ç†å™¨åŒæ­¥ç¾¤èŠæ•°æ®å¤±è´¥", e)
        }
    }

    /**
     * ç”Ÿæˆé»˜è®¤è”ç³»äººæ•°æ®
     */
    private fun generateDefaultContacts() {
        try {
            val settingsManager = SettingsManager.getInstance(this)

            // å®šä¹‰æ‰€æœ‰å¯ç”¨çš„AIåŠ©æ‰‹
            val availableAIs = listOf(
                "ä¸´æ—¶ä¸“çº¿" to "å…è´¹AIæœåŠ¡ (æ— éœ€APIå¯†é’¥)",
                "DeepSeek" to "DeepSeekçš„AIåŠ©æ‰‹",
                "ChatGPT" to "OpenAIçš„AIåŠ©æ‰‹",
                "Claude" to "Anthropicçš„AIåŠ©æ‰‹",
                "Gemini" to "Googleçš„AIåŠ©æ‰‹",
                "æ™ºè°±AI" to "æ™ºè°±AIçš„GLM-4å¤§è¯­è¨€æ¨¡å‹",
                "æ–‡å¿ƒä¸€è¨€" to "ç™¾åº¦çš„å¤§è¯­è¨€æ¨¡å‹",
                "é€šä¹‰åƒé—®" to "é˜¿é‡Œå·´å·´çš„å¤§è¯­è¨€æ¨¡å‹",
                "è®¯é£æ˜Ÿç«" to "ç§‘å¤§è®¯é£çš„AIåŠ©æ‰‹",
                "Kimi" to "Moonshotçš„AIåŠ©æ‰‹"
            )

            val aiContacts = mutableListOf<ChatContact>()

            // æ£€æŸ¥æ¯ä¸ªAIæ˜¯å¦æœ‰æœ‰æ•ˆçš„APIå¯†é’¥é…ç½®ï¼Œåªæ·»åŠ æœ‰é…ç½®çš„AI
            // ä¸´æ—¶ä¸“çº¿ä½œä¸ºå›ºå®šå¸¸é©»AIï¼Œå§‹ç»ˆæ˜¾ç¤º
            availableAIs.forEach { (aiName, description) ->
                val isTempService = aiName == "ä¸´æ—¶ä¸“çº¿"
                val apiKey = if (isTempService) "" else getApiKeyForAI(aiName)
                // ä¸´æ—¶ä¸“çº¿å§‹ç»ˆæ˜¾ç¤ºï¼Œå…¶ä»–AIéœ€è¦æœ‰æ•ˆAPIå¯†é’¥
                if (isTempService || isValidApiKey(apiKey, aiName)) {
                    // æœ‰æœ‰æ•ˆAPIå¯†é’¥é…ç½®ï¼Œæ·»åŠ åˆ°è”ç³»äººåˆ—è¡¨
                    // è·å–çœŸå®çš„æœ€åèŠå¤©æ¶ˆæ¯
                    val lastChatMessage = getLastChatMessageFromHistory(aiName)
                    val lastChatTime = getLastChatTimeFromHistory(aiName)
                    
                    // ä½¿ç”¨ä¸çµåŠ¨å²›ç›¸åŒçš„IDç”Ÿæˆé€»è¾‘
                    val processedName = if (aiName.contains(Regex("[\\u4e00-\\u9fff]"))) {
                        // åŒ…å«ä¸­æ–‡å­—ç¬¦ï¼Œç›´æ¥ä½¿ç”¨åŸåç§°
                        aiName
                    } else {
                        // è‹±æ–‡å­—ç¬¦ï¼Œè½¬æ¢ä¸ºå°å†™
                        aiName.lowercase()
                    }
                    val contactId = "ai_${processedName.replace(" ", "_")}"
                    
                    Log.d(TAG, "ç”ŸæˆAIè”ç³»äºº - AIåç§°: $aiName, è”ç³»äººID: $contactId")
                    
                    val contact = ChatContact(
                        id = contactId,
                        name = aiName,
                        type = ContactType.AI,
                        description = description,
                        isOnline = true,
                        lastMessage = lastChatMessage.ifEmpty { "ä½ å¥½ï¼æˆ‘æ˜¯$aiNameï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ" },
                        lastMessageTime = if (lastChatTime > 0) lastChatTime else System.currentTimeMillis() - (Math.random() * 86400000).toLong(),
                        unreadCount = 0,
                        isPinned = true, // æœ‰APIé…ç½®çš„AIä¼˜å…ˆæ˜¾ç¤º
                        customData = mapOf(
                            "api_url" to getDefaultApiUrl(aiName),
                            "api_key" to apiKey,
                            "model" to getDefaultModel(aiName),
                            "is_temp_service" to isTempService.toString()
                        ),
                        aiMembers = emptyList()
                    )
                    aiContacts.add(contact)
                    Log.d(TAG, "æ·»åŠ AIåŠ©æ‰‹: $aiName (APIå¯†é’¥å·²é…ç½®)")
                } else {
                    Log.d(TAG, "è·³è¿‡AIåŠ©æ‰‹: $aiName (APIå¯†é’¥æœªé…ç½®æˆ–æ— æ•ˆ)")
                }
            }

            // å¦‚æœæ²¡æœ‰é…ç½®ä»»ä½•AIï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
            if (aiContacts.isEmpty()) {
                Log.d(TAG, "æ²¡æœ‰é…ç½®ä»»ä½•AIåŠ©æ‰‹ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€")
            }

            // ä»UnifiedGroupChatManageråŠ è½½ç¾¤èŠæ•°æ®ï¼ˆä»…åœ¨ç”Ÿæˆé»˜è®¤æ•°æ®æ—¶ï¼‰
            val groupChatContacts = mutableListOf<ChatContact>()
            try {
                val groupChats = unifiedGroupChatManager.getAllGroupChats()
                if (groupChats.isNotEmpty()) {
                    groupChats.forEach { groupChat ->
                        val groupChatContact = ChatContact(
                            id = groupChat.id,
                            name = groupChat.name,
                            avatar = groupChat.avatar,
                            type = ContactType.GROUP,
                            description = groupChat.description,
                            isOnline = true,
                            lastMessage = groupChat.lastMessage,
                            lastMessageTime = groupChat.lastMessageTime,
                            unreadCount = groupChat.unreadCount,
                            isPinned = groupChat.isPinned,
                            isMuted = groupChat.isMuted,
                            groupId = groupChat.id,
                            memberCount = groupChat.members.size,
                            aiMembers = groupChat.members.filter { it.type == MemberType.AI }.map { it.name }
                        )
                        groupChatContacts.add(groupChatContact)
                    }
                    Log.d(TAG, "ç”Ÿæˆé»˜è®¤æ•°æ®æ—¶ä»UnifiedGroupChatManageråŠ è½½äº† ${groupChats.size} ä¸ªç¾¤èŠ")
                }
            } catch (e: Exception) {
                Log.e(TAG, "ä»ç»Ÿä¸€ç®¡ç†å™¨åŠ è½½ç¾¤èŠæ•°æ®å¤±è´¥", e)
            }
            
            // åˆ›å»ºåˆ†ç±»ï¼ŒåŒ…å«AIåŠ©æ‰‹å’Œç¾¤èŠ
            val allChatContacts = mutableListOf<ChatContact>()
            allChatContacts.addAll(aiContacts)
            allChatContacts.addAll(groupChatContacts)
            
            allContacts = mutableListOf(
                ContactCategory("å…¨éƒ¨è”ç³»äºº", allChatContacts)
            )

            // ä¿å­˜ç”Ÿæˆçš„è”ç³»äººæ•°æ®
            saveContacts()

            // æ›´æ–°é€‚é…å™¨
            chatContactAdapter?.updateContacts(allContacts)
            Log.d(TAG, "åˆå§‹è”ç³»äººæ•°æ®ç”Ÿæˆå®Œæˆ")
        } catch (e: Exception) {
            Log.e(TAG, "ç”Ÿæˆé»˜è®¤è”ç³»äººæ•°æ®å¤±è´¥", e)
        }
    }

    /**
     * æ‰“å¼€ä¸è”ç³»äººçš„èŠå¤©
     */
    private fun openChatWithContact(contact: ChatContact) {
        try {
            // åœ¨è¿›å…¥AIå¯¹è¯å‰ï¼Œå¼ºåˆ¶åŠ è½½AIè”ç³»äººåˆ—è¡¨æ•°æ®æ±‡æ€»
            if (contact.type == ContactType.AI) {
                forceLoadContactDataSummary()
            }
            
            val intent = Intent(this, ChatActivity::class.java)
            intent.putExtra(ChatActivity.EXTRA_CONTACT, contact)
            startActivity(intent)
            Log.d(TAG, "æ‰“å¼€ä¸è”ç³»äººçš„èŠå¤©: ${contact.name}")
        } catch (e: Exception) {
            Log.e(TAG, "æ‰“å¼€èŠå¤©å¤±è´¥", e)
            Toast.makeText(this, "æ‰“å¼€èŠå¤©å¤±è´¥", Toast.LENGTH_SHORT).show()
        }
    }

    /**
     * æ˜¾ç¤ºè”ç³»äººé€‰é¡¹å¯¹è¯æ¡†ï¼ˆç›´æ¥æ˜¾ç¤ºåˆ†ç»„é€‰é¡¹ï¼‰
     */
    private fun showContactOptionsDialog(contact: ChatContact) {
        try {
            Log.d(TAG, "æ˜¾ç¤ºè”ç³»äººé€‰é¡¹å¯¹è¯æ¡†: ${contact.name}, ç±»å‹: ${contact.type}")

            val options = mutableListOf<String>()
            val currentGroup = findContactGroup(contact)

            // ä¸ºAIè”ç³»äººç›´æ¥æ·»åŠ æ‰€æœ‰å¯ç”¨åˆ†ç»„é€‰é¡¹
            if (contact.type == ContactType.AI) {
                // æ·»åŠ åˆ†ç»„è½¬ç§»é€‰é¡¹
                addGroupTransferOptions(options, contact, currentGroup)

                // æ·»åŠ åˆ†éš”çº¿
                options.add("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€")
            }

            // æ ¹æ®å½“å‰çŠ¶æ€åŠ¨æ€æ·»åŠ å…¶ä»–é€‰é¡¹
            if (contact.isPinned) {
                options.add("å–æ¶ˆç½®é¡¶")
            } else {
                options.add("ç½®é¡¶")
            }

            if (contact.isMuted) {
                options.add("å–æ¶ˆé™éŸ³")
            } else {
                options.add("é™éŸ³")
            }

            options.add("åˆ é™¤")

            Log.d(TAG, "èœå•é€‰é¡¹: ${options.joinToString(", ")}")

            // æ„å»ºå¯¹è¯æ¡†æ ‡é¢˜
            val title = if (currentGroup != null && currentGroup != "æœªåˆ†ç»„") {
                "${contact.name} (å½“å‰åˆ†ç»„: $currentGroup)"
            } else {
                "${contact.name} (å½“å‰åœ¨: å…¨éƒ¨)"
            }

            AlertDialog.Builder(this, R.style.Theme_MaterialDialog)
                .setTitle(title)
                .setItems(options.toTypedArray()) { _, which ->
                    handleContactOptionSelection(contact, options, which, currentGroup)
                }
                .setNegativeButton("å–æ¶ˆ") { _, _ ->
                    Log.d(TAG, "ç”¨æˆ·å–æ¶ˆäº†æ“ä½œ")
                }
                .show()

            Log.d(TAG, "è”ç³»äººé€‰é¡¹å¯¹è¯æ¡†å·²æ˜¾ç¤ºï¼Œå…± ${options.size} ä¸ªé€‰é¡¹")

        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºè”ç³»äººé€‰é¡¹å¯¹è¯æ¡†å¤±è´¥", e)
            Toast.makeText(this, "æ— æ³•æ˜¾ç¤ºèœå•", Toast.LENGTH_SHORT).show()
        }
    }

    /**
     * æ·»åŠ åˆ†ç»„è½¬ç§»é€‰é¡¹åˆ°èœå•ä¸­
     */
    private fun addGroupTransferOptions(options: MutableList<String>, contact: ChatContact, currentGroup: String?) {
        try {
            // å¦‚æœAIåœ¨æŸä¸ªåˆ†ç»„ä¸­ï¼Œæ·»åŠ "ç§»é™¤åˆ†ç»„"é€‰é¡¹
            if (currentGroup != null && currentGroup != "æœªåˆ†ç»„" && currentGroup != "å…¨éƒ¨") {
                options.add("ğŸ”„ ç§»é™¤åˆ†ç»„ï¼ˆå›åˆ°å…¨éƒ¨ï¼‰")
            }

            // ç¡®ä¿"AIåŠ©æ‰‹"åˆ†ç»„å­˜åœ¨
            ensureAIAssistantGroupExists()

            // æ·»åŠ "AIåŠ©æ‰‹"åˆ†ç»„ï¼ˆå¦‚æœå½“å‰ä¸åœ¨æ­¤åˆ†ç»„ï¼‰
            if (currentGroup != "AIåŠ©æ‰‹") {
                options.add("ğŸ“ ç§»åŠ¨åˆ°: AIåŠ©æ‰‹")
            }

            // æ·»åŠ æ‰€æœ‰ç°æœ‰çš„è‡ªå®šä¹‰åˆ†ç»„
            allContacts.forEach { category ->
                if (category.name != "AIåŠ©æ‰‹" &&
                    category.name != currentGroup &&
                    category.name != "æœªåˆ†ç»„") {
                    options.add("ğŸ“ ç§»åŠ¨åˆ°: ${category.name}")
                }
            }

            // ä»æ ‡ç­¾é¡µè·å–é¢å¤–çš„åˆ†ç»„
            val chatTabLayout = findViewById<com.google.android.material.tabs.TabLayout>(R.id.chat_tab_layout)
            for (i in 2 until (chatTabLayout?.tabCount ?: 0)) {
                val tab = chatTabLayout?.getTabAt(i)
                val tabText = tab?.text?.toString()
                if (tabText != null &&
                    tabText != "+" &&
                    tabText != currentGroup &&
                    !options.any { it.contains(tabText) }) {
                    options.add("ğŸ“ ç§»åŠ¨åˆ°: $tabText")
                }
            }

            // å¦‚æœåˆ†ç»„é€‰é¡¹å¤ªå°‘ï¼Œæ·»åŠ ä¸€äº›å¸¸ç”¨åˆ†ç»„
            val groupCount = options.count { it.startsWith("ğŸ“ ç§»åŠ¨åˆ°:") }
            if (groupCount < 3) {
                val defaultGroups = listOf("å·¥ä½œAI", "å­¦ä¹ AI", "ç”Ÿæ´»AI", "å¨±ä¹AI")
                defaultGroups.forEach { groupName ->
                    if (groupName != currentGroup && !options.any { it.contains(groupName) }) {
                        options.add("ğŸ“ ç§»åŠ¨åˆ°: $groupName")
                    }
                }
            }

            // æ€»æ˜¯æ·»åŠ "åˆ›å»ºæ–°åˆ†ç»„"é€‰é¡¹
            options.add("â• åˆ›å»ºæ–°åˆ†ç»„")

            Log.d(TAG, "æ·»åŠ äº† ${options.count { it.startsWith("ğŸ“") || it.startsWith("ğŸ”„") || it.startsWith("â•") }} ä¸ªåˆ†ç»„é€‰é¡¹")

        } catch (e: Exception) {
            Log.e(TAG, "æ·»åŠ åˆ†ç»„è½¬ç§»é€‰é¡¹å¤±è´¥", e)
        }
    }



    /**
     * å¤„ç†è”ç³»äººé€‰é¡¹é€‰æ‹©ï¼ˆæ”¯æŒç›´æ¥åˆ†ç»„è½¬ç§»ï¼‰
     */
    private fun handleContactOptionSelection(contact: ChatContact, options: List<String>, which: Int, currentGroup: String?) {
        try {
            if (which < 0 || which >= options.size) {
                Log.e(TAG, "é€‰æ‹©ç´¢å¼•è¶…å‡ºèŒƒå›´: $which")
                return
            }

            val selectedOption = options[which]
            Log.d(TAG, "ç”¨æˆ·é€‰æ‹©äº†é€‰é¡¹: $selectedOption")

            when {
                selectedOption == "ğŸ”„ ç§»é™¤åˆ†ç»„ï¼ˆå›åˆ°å…¨éƒ¨ï¼‰" -> {
                    Log.d(TAG, "æ‰§è¡Œç§»é™¤åˆ†ç»„æ“ä½œ")
                    confirmRemoveFromGroup(contact, currentGroup)
                }
                selectedOption.startsWith("ğŸ“ ç§»åŠ¨åˆ°: ") -> {
                    val targetGroup = selectedOption.removePrefix("ğŸ“ ç§»åŠ¨åˆ°: ")
                    Log.d(TAG, "æ‰§è¡Œç§»åŠ¨åˆ°åˆ†ç»„æ“ä½œ: $targetGroup")
                    confirmMoveToGroup(contact, targetGroup, currentGroup)
                }
                selectedOption == "â• åˆ›å»ºæ–°åˆ†ç»„" -> {
                    Log.d(TAG, "æ‰§è¡Œåˆ›å»ºæ–°åˆ†ç»„æ“ä½œ")
                    showCreateNewGroupForContactDialog(contact)
                }
                selectedOption == "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€" -> {
                    // åˆ†éš”çº¿ï¼Œå¿½ç•¥
                    return
                }
                selectedOption.contains("ç½®é¡¶") -> {
                    val isPinning = !selectedOption.contains("å–æ¶ˆ")
                    Log.d(TAG, "æ‰§è¡Œ${if (isPinning) "ç½®é¡¶" else "å–æ¶ˆç½®é¡¶"}")
                    toggleContactPin(contact, isPinning)
                }
                selectedOption.contains("é™éŸ³") -> {
                    val isMuting = !selectedOption.contains("å–æ¶ˆ")
                    Log.d(TAG, "æ‰§è¡Œ${if (isMuting) "é™éŸ³" else "å–æ¶ˆé™éŸ³"}")
                    toggleContactMute(contact, isMuting)
                }
                selectedOption == "åˆ é™¤" -> {
                    Log.d(TAG, "æ‰§è¡Œåˆ é™¤")
                    confirmDeleteContact(contact)
                }
                else -> {
                    Log.w(TAG, "æœªè¯†åˆ«çš„é€‰é¡¹: $selectedOption")
                    Toast.makeText(this, "æœªè¯†åˆ«çš„æ“ä½œ", Toast.LENGTH_SHORT).show()
                }
            }
        } catch (e: Exception) {
            Log.e(TAG, "æ‰§è¡Œèœå•é€‰é¡¹å¤±è´¥", e)
            Toast.makeText(this, "æ“ä½œå¤±è´¥: ${e.message}", Toast.LENGTH_SHORT).show()
        }
    }

    /**
     * ç¡®è®¤ç§»é™¤åˆ†ç»„
     */
    private fun confirmRemoveFromGroup(contact: ChatContact, currentGroup: String?) {
        val message = "ç¡®å®šè¦å°† ${contact.name} ä»åˆ†ç»„ \"$currentGroup\" ä¸­ç§»é™¤å—ï¼Ÿ\n\nç§»é™¤åAIå°†å›åˆ°\"å…¨éƒ¨\"æ ‡ç­¾é¡µä¸­ã€‚"

        AlertDialog.Builder(this, R.style.Theme_MaterialDialog)
            .setTitle("ç¡®è®¤ç§»é™¤åˆ†ç»„")
            .setMessage(message)
            .setPositiveButton("ç¡®å®šç§»é™¤") { _, _ ->
                removeContactFromGroup(contact)
            }
            .setNegativeButton("å–æ¶ˆ", null)
            .show()
    }

    /**
     * ç¡®è®¤ç§»åŠ¨åˆ°åˆ†ç»„
     */
    private fun confirmMoveToGroup(contact: ChatContact, targetGroup: String, currentGroup: String?) {
        val message = if (currentGroup != null && currentGroup != "æœªåˆ†ç»„") {
            "ç¡®å®šè¦å°† ${contact.name} ä» \"$currentGroup\" ç§»åŠ¨åˆ° \"$targetGroup\" å—ï¼Ÿ"
        } else {
            "ç¡®å®šè¦å°† ${contact.name} ç§»åŠ¨åˆ°åˆ†ç»„ \"$targetGroup\" å—ï¼Ÿ"
        }

        AlertDialog.Builder(this, R.style.Theme_MaterialDialog)
            .setTitle("ç¡®è®¤ç§»åŠ¨")
            .setMessage(message)
            .setPositiveButton("ç¡®å®šç§»åŠ¨") { _, _ ->
                moveContactToGroup(contact, targetGroup)
            }
            .setNegativeButton("å–æ¶ˆ", null)
            .show()
    }



    /**
     * ç¡®è®¤åˆ é™¤è”ç³»äºº
     */
    private fun confirmDeleteContact(contact: ChatContact) {
        when (contact.type) {
            ContactType.AI -> {
                AlertDialog.Builder(this, R.style.Theme_MaterialDialog)
                    .setTitle("ç§»é™¤AIåŠ©æ‰‹")
                    .setMessage("ç¡®å®šè¦ç§»é™¤ ${contact.name} å—ï¼Ÿ\n\nè¿™å°†æ¸…é™¤è¯¥AIçš„APIé…ç½®ï¼Œä½†å¯ä»¥é‡æ–°æ·»åŠ ã€‚")
                    .setPositiveButton("ç§»é™¤") { _, _ ->
                        removeAIConfiguration(contact)
                        Toast.makeText(this, "${contact.name} é…ç½®å·²ç§»é™¤", Toast.LENGTH_SHORT).show()
                        Log.d(TAG, "ç§»é™¤AIé…ç½®: ${contact.name}")
                    }
                    .setNegativeButton("å–æ¶ˆ", null)
                    .show()
            }
            ContactType.GROUP -> {
                AlertDialog.Builder(this, R.style.Theme_MaterialDialog)
                    .setTitle("åˆ é™¤ç¾¤èŠ")
                    .setMessage("ç¡®å®šè¦åˆ é™¤ç¾¤èŠ ${contact.name} å—ï¼Ÿ\n\nåˆ é™¤åå°†æ— æ³•æ¢å¤ï¼ŒåŒ…æ‹¬ç¾¤èŠä¸­çš„æ‰€æœ‰æ¶ˆæ¯ã€‚")
                    .setPositiveButton("åˆ é™¤") { _, _ ->
                        removeGroupChatConfiguration(contact)
                        Log.d(TAG, "åˆ é™¤ç¾¤èŠ: ${contact.name}")
                    }
                    .setNegativeButton("å–æ¶ˆ", null)
                    .show()
            }
            else -> {
                AlertDialog.Builder(this, R.style.Theme_MaterialDialog)
                    .setTitle("åˆ é™¤è”ç³»äºº")
                    .setMessage("ç¡®å®šè¦åˆ é™¤ ${contact.name} å—ï¼Ÿ\n\nåˆ é™¤åå°†æ— æ³•æ¢å¤ã€‚")
                    .setPositiveButton("åˆ é™¤") { _, _ ->
                        removeContactFromList(contact)
                        Toast.makeText(this, "${contact.name} å·²åˆ é™¤", Toast.LENGTH_SHORT).show()
                        Log.d(TAG, "åˆ é™¤è”ç³»äºº: ${contact.name}")
                    }
                    .setNegativeButton("å–æ¶ˆ", null)
                    .show()
            }
        }
    }

    /**
     * æµ‹è¯•ç¾¤èŠåˆ é™¤åŠŸèƒ½ï¼ˆè°ƒè¯•ç”¨ï¼‰
     */
    private fun testGroupChatDeleteFunction() {
        try {
            Log.d(TAG, "=== å¼€å§‹æµ‹è¯•ç¾¤èŠåˆ é™¤åŠŸèƒ½ ===")
            
            // æŸ¥æ‰¾ç¬¬ä¸€ä¸ªç¾¤èŠè”ç³»äºº
            val groupContact = allContacts.flatMap { it.contacts }
                .firstOrNull { it.type == ContactType.GROUP }
            
            if (groupContact != null) {
                Log.d(TAG, "æ‰¾åˆ°ç¾¤èŠè”ç³»äºº: ${groupContact.name} (ID: ${groupContact.id}, GroupID: ${groupContact.groupId})")
                
                // æµ‹è¯•åˆ é™¤ç¡®è®¤å¯¹è¯æ¡†
                confirmDeleteContact(groupContact)
                
                Log.d(TAG, "ç¾¤èŠåˆ é™¤æµ‹è¯•å¯¹è¯æ¡†å·²æ˜¾ç¤º")
            } else {
                Log.w(TAG, "æ²¡æœ‰æ‰¾åˆ°ç¾¤èŠè”ç³»äººè¿›è¡Œæµ‹è¯•")
                Toast.makeText(this, "æ²¡æœ‰æ‰¾åˆ°ç¾¤èŠè¿›è¡Œæµ‹è¯•", Toast.LENGTH_SHORT).show()
            }
            
            Log.d(TAG, "=== ç¾¤èŠåˆ é™¤åŠŸèƒ½æµ‹è¯•å®Œæˆ ===")
        } catch (e: Exception) {
            Log.e(TAG, "æµ‹è¯•ç¾¤èŠåˆ é™¤åŠŸèƒ½å¤±è´¥", e)
            Toast.makeText(this, "æµ‹è¯•å¤±è´¥: ${e.message}", Toast.LENGTH_SHORT).show()
        }
    }

    /**
     * æµ‹è¯•é•¿æŒ‰èœå•åŠŸèƒ½ï¼ˆè°ƒè¯•ç”¨ï¼‰
     */
    private fun testContactOptionsMenu() {
        try {
            Log.d(TAG, "=== å¼€å§‹æµ‹è¯•é•¿æŒ‰èœå•åŠŸèƒ½ ===")

            // æ‰¾ä¸€ä¸ªAIè”ç³»äººè¿›è¡Œæµ‹è¯•
            val testContact = allContacts.flatMap { it.contacts }
                .firstOrNull { it.type == ContactType.AI }

            if (testContact != null) {
                Log.d(TAG, "ä½¿ç”¨æµ‹è¯•è”ç³»äºº: ${testContact.name}")

                // æ¨¡æ‹Ÿæ„å»ºèœå•é€‰é¡¹
                val options = mutableListOf<String>()
                val currentGroup = findContactGroup(testContact)

                Log.d(TAG, "æµ‹è¯•è”ç³»äººå½“å‰åˆ†ç»„: $currentGroup")

                // æµ‹è¯•æ·»åŠ åˆ†ç»„é€‰é¡¹
                addGroupTransferOptions(options, testContact, currentGroup)

                Log.d(TAG, "ç”Ÿæˆçš„èœå•é€‰é¡¹:")
                options.forEachIndexed { index, option ->
                    Log.d(TAG, "  [$index] $option")
                }

                Log.d(TAG, "èœå•åŠŸèƒ½æµ‹è¯•å®Œæˆï¼Œå…± ${options.size} ä¸ªé€‰é¡¹")
            } else {
                Log.w(TAG, "æœªæ‰¾åˆ°AIè”ç³»äººè¿›è¡Œæµ‹è¯•")
            }

            Log.d(TAG, "=== é•¿æŒ‰èœå•åŠŸèƒ½æµ‹è¯•å®Œæˆ ===")

        } catch (e: Exception) {
            Log.e(TAG, "æµ‹è¯•é•¿æŒ‰èœå•åŠŸèƒ½å¤±è´¥", e)
        }
    }

    /**
     * éªŒè¯åˆ†ç»„è½¬ç§»åŠŸèƒ½çš„å®Œæ•´æ€§
     */
    private fun validateGroupTransferFunction(): Boolean {
        try {
            // æ£€æŸ¥å¿…è¦çš„UIç»„ä»¶
            val chatTabLayout = findViewById<com.google.android.material.tabs.TabLayout>(R.id.chat_tab_layout)
            if (chatTabLayout == null) {
                Log.e(TAG, "chatTabLayoutä¸ºnull")
                return false
            }

            // æ£€æŸ¥é€‚é…å™¨
            if (chatContactAdapter == null) {
                Log.e(TAG, "chatContactAdapterä¸ºnull")
                return false
            }

            // æ£€æŸ¥æ•°æ®ç»“æ„
            if (allContacts.isEmpty()) {
                Log.w(TAG, "allContactsä¸ºç©º")
                return false
            }

            Log.d(TAG, "åˆ†ç»„è½¬ç§»åŠŸèƒ½éªŒè¯é€šè¿‡")
            return true

        } catch (e: Exception) {
            Log.e(TAG, "éªŒè¯åˆ†ç»„è½¬ç§»åŠŸèƒ½å¤±è´¥", e)
            return false
        }
    }

    /**
     * æ˜¾ç¤ºAIåˆ†ç»„é€‰æ‹©å¯¹è¯æ¡†ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
     */
    private fun showAIGroupSelectionDialog(contact: ChatContact) {
        try {
            Log.d(TAG, "æ˜¾ç¤ºAIåˆ†ç»„é€‰æ‹©å¯¹è¯æ¡†: ${contact.name}")

            // è·å–å½“å‰AIæ‰€åœ¨çš„åˆ†ç»„
            val currentGroup = findContactGroup(contact)
            Log.d(TAG, "å½“å‰åˆ†ç»„: $currentGroup")

            // è·å–æ‰€æœ‰å¯ç”¨çš„åˆ†ç»„é€‰é¡¹
            val availableGroups = buildAvailableGroupsList(contact, currentGroup)

            if (availableGroups.isEmpty()) {
                Toast.makeText(this, "æ— å¯ç”¨åˆ†ç»„ï¼Œè¯·å…ˆåˆ›å»ºåˆ†ç»„", Toast.LENGTH_SHORT).show()
                showCreateNewGroupForContactDialog(contact)
                return
            }

            Log.d(TAG, "å¯ç”¨åˆ†ç»„: ${availableGroups.joinToString(", ")}")

            // æ„å»ºå¯¹è¯æ¡†æ ‡é¢˜å’Œæ¶ˆæ¯
            val title = "ç§»åŠ¨ ${contact.name}"
            val message = buildGroupSelectionMessage(currentGroup)

            // æ˜¾ç¤ºåˆ†ç»„é€‰æ‹©å¯¹è¯æ¡†
            showGroupSelectionDialog(contact, title, message, availableGroups, currentGroup)

        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºAIåˆ†ç»„é€‰æ‹©å¯¹è¯æ¡†å¤±è´¥", e)
            Toast.makeText(this, "æ— æ³•æ˜¾ç¤ºåˆ†ç»„é€‰æ‹©ï¼Œä½¿ç”¨ç®€åŒ–ç‰ˆæœ¬", Toast.LENGTH_SHORT).show()
            showSimpleGroupSelectionDialog(contact)
        }
    }

    /**
     * æ„å»ºå¯ç”¨åˆ†ç»„åˆ—è¡¨
     */
    private fun buildAvailableGroupsList(contact: ChatContact, currentGroup: String?): MutableList<String> {
        val availableGroups = mutableListOf<String>()

        // 1. å¦‚æœAIåœ¨æŸä¸ªåˆ†ç»„ä¸­ï¼Œæ·»åŠ "ç§»é™¤åˆ†ç»„"é€‰é¡¹
        if (currentGroup != null && currentGroup != "æœªåˆ†ç»„" && currentGroup != "å…¨éƒ¨") {
            availableGroups.add("ğŸ”„ ç§»é™¤åˆ†ç»„ï¼ˆå›åˆ°å…¨éƒ¨ï¼‰")
        }

        // 2. ç¡®ä¿"AIåŠ©æ‰‹"åˆ†ç»„å­˜åœ¨
        ensureAIAssistantGroupExists()

        // 3. æ·»åŠ "AIåŠ©æ‰‹"åˆ†ç»„ï¼ˆå¦‚æœå½“å‰ä¸åœ¨æ­¤åˆ†ç»„ï¼‰
        if (currentGroup != "AIåŠ©æ‰‹") {
            availableGroups.add("AIåŠ©æ‰‹")
        }

        // 4. åªæ·»åŠ å®é™…å­˜åœ¨ä¸”æœ‰æ•ˆçš„åˆ†ç»„ï¼ˆæ’é™¤å½“å‰åˆ†ç»„ï¼‰
        val validGroups = getValidExistingGroups()
        validGroups.forEach { groupName ->
            if (groupName != "AIåŠ©æ‰‹" &&
                groupName != currentGroup && // ç¡®ä¿ä¸æ·»åŠ å½“å‰åˆ†ç»„
                groupName != "æœªåˆ†ç»„" &&
                groupName != "å…¨éƒ¨" &&
                !availableGroups.contains(groupName)) {
                availableGroups.add(groupName)
                Log.d(TAG, "æ·»åŠ æœ‰æ•ˆåˆ†ç»„é€‰é¡¹: $groupName")
            }
        }

        // 5. å¦‚æœåˆ†ç»„å¤ªå°‘ï¼Œæ·»åŠ ä¸€äº›é¢„è®¾åˆ†ç»„ï¼ˆæ’é™¤å½“å‰åˆ†ç»„ï¼‰
        if (availableGroups.size <= 1) {
            addDefaultGroups(availableGroups, currentGroup)
            Log.d(TAG, "æ·»åŠ é»˜è®¤åˆ†ç»„åï¼Œå¯ç”¨é€‰é¡¹æ•°: ${availableGroups.size}")
        }

        // 6. æ€»æ˜¯æ·»åŠ "åˆ›å»ºæ–°åˆ†ç»„"é€‰é¡¹
        availableGroups.add("+ åˆ›å»ºæ–°åˆ†ç»„")

        return availableGroups
    }

    /**
     * è·å–å®é™…å­˜åœ¨çš„æœ‰æ•ˆåˆ†ç»„åˆ—è¡¨
     */
    private fun getValidExistingGroups(): List<String> {
        val validGroups = mutableListOf<String>()

        // ä»TabLayoutè·å–å½“å‰æ˜¾ç¤ºçš„æ ‡ç­¾é¡µï¼ˆè¿™äº›æ˜¯å®é™…å­˜åœ¨çš„åˆ†ç»„ï¼‰
        val chatTabLayout = findViewById<com.google.android.material.tabs.TabLayout>(R.id.chat_tab_layout)
        chatTabLayout?.let { tabLayout ->
            for (i in 0 until tabLayout.tabCount) {
                val tab = tabLayout.getTabAt(i)
                val tabText = tab?.text?.toString()
                if (tabText != null &&
                    tabText != "+" &&
                    tabText != "å…¨éƒ¨" &&
                    tabText != "æœªåˆ†ç»„" &&
                    !validGroups.contains(tabText)) {
                    validGroups.add(tabText)
                }
            }
        }

        // åŒæ—¶æ£€æŸ¥allContactsä¸­ç¡®å®å­˜åœ¨å¯¹åº”çš„åˆ†ç»„æ•°æ®
        val finalValidGroups = validGroups.filter { groupName ->
            allContacts.any { it.name == groupName }
        }

        Log.d(TAG, "æœ‰æ•ˆåˆ†ç»„åˆ—è¡¨: ${finalValidGroups.joinToString(", ")}")
        return finalValidGroups
    }

    /**
     * ç¡®ä¿AIåŠ©æ‰‹åˆ†ç»„å­˜åœ¨ï¼ˆä»…åœ¨ç”¨æˆ·æœªä¸»åŠ¨åˆ é™¤æ—¶ï¼‰
     */
    private fun ensureAIAssistantGroupExists() {
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ä¸»åŠ¨åˆ é™¤äº†AIåŠ©æ‰‹åˆ†ç»„
        val prefs = getSharedPreferences("custom_tabs", MODE_PRIVATE)
        val isAIAssistantGroupDeleted = prefs.getBoolean("ai_assistant_group_deleted", false)

        if (!isAIAssistantGroupDeleted) {
            val aiAssistantCategory = allContacts.find { it.name == "AIåŠ©æ‰‹" }
            if (aiAssistantCategory == null) {
                val newAIAssistantCategory = ContactCategory(
                    name = "AIåŠ©æ‰‹",
                    contacts = mutableListOf(),
                    isExpanded = true
                )
                allContacts.add(newAIAssistantCategory)
                saveContacts()
                Log.d(TAG, "åˆ›å»ºäº†ç¼ºå¤±çš„AIåŠ©æ‰‹åˆ†ç»„")
            }
        }
    }



    /**
     * æ·»åŠ é»˜è®¤åˆ†ç»„é€‰é¡¹ï¼ˆä»…åœ¨ç§»åŠ¨AIæ—¶ä½¿ç”¨ï¼Œä¸ä¼šåˆ›å»ºå®é™…çš„ç©ºåˆ†ç»„ï¼‰
     */
    private fun addDefaultGroups(availableGroups: MutableList<String>, currentGroup: String?) {
        // åªæœ‰åœ¨åˆ†ç»„é€‰é¡¹éå¸¸å°‘çš„æƒ…å†µä¸‹æ‰æ·»åŠ é»˜è®¤åˆ†ç»„å»ºè®®
        if (availableGroups.size <= 1) {
            // å›ºå®šçš„5ä¸ªé»˜è®¤åˆ†ç»„å»ºè®®
            val defaultGroups = listOf("å·¥ä½œAI", "å­¦ä¹ AI", "ç”Ÿæ´»AI", "å¨±ä¹AI", "åˆ›ä½œAI")
            defaultGroups.forEach { groupName ->
                if (groupName != currentGroup && !availableGroups.contains(groupName)) {
                    availableGroups.add(groupName)
                }
            }
            Log.d(TAG, "æ·»åŠ äº† ${defaultGroups.size} ä¸ªé»˜è®¤åˆ†ç»„é€‰é¡¹ä½œä¸ºå»ºè®®")
        }
    }

    /**
     * æ„å»ºåˆ†ç»„é€‰æ‹©æ¶ˆæ¯
     */
    private fun buildGroupSelectionMessage(currentGroup: String?): String {
        return when {
            currentGroup != null && currentGroup != "æœªåˆ†ç»„" && currentGroup != "å…¨éƒ¨" ->
                "ğŸ“ å½“å‰åˆ†ç»„ï¼š$currentGroup\n\nè¯·é€‰æ‹©è¦ç§»åŠ¨åˆ°çš„ç›®æ ‡åˆ†ç»„ï¼š"
            else ->
                "ğŸ“‹ å½“å‰åœ¨\"å…¨éƒ¨\"ä¸­\n\nè¯·é€‰æ‹©è¦ç§»åŠ¨åˆ°çš„åˆ†ç»„ï¼š"
        }
    }

    /**
     * æ˜¾ç¤ºåˆ†ç»„é€‰æ‹©å¯¹è¯æ¡†
     */
    private fun showGroupSelectionDialog(
        contact: ChatContact,
        title: String,
        message: String,
        availableGroups: List<String>,
        currentGroup: String?
    ) {
        val dialog = AlertDialog.Builder(this, R.style.Theme_MaterialDialog)
            .setTitle(title)
            .setMessage(message)
            .setItems(availableGroups.toTypedArray()) { _, which ->
                handleGroupSelection(contact, availableGroups, which, currentGroup)
            }
            .setNegativeButton("å–æ¶ˆ") { dialog, _ ->
                Log.d(TAG, "ç”¨æˆ·å–æ¶ˆäº†åˆ†ç»„é€‰æ‹©")
                dialog.dismiss()
            }
            .setNeutralButton("å¸®åŠ©") { _, _ ->
                showGroupSelectionHelp()
            }
            .create()

        dialog.show()
        Log.d(TAG, "åˆ†ç»„é€‰æ‹©å¯¹è¯æ¡†å·²æ˜¾ç¤ºï¼Œå…± ${availableGroups.size} ä¸ªé€‰é¡¹")
    }

    /**
     * å¤„ç†åˆ†ç»„é€‰æ‹©
     */
    private fun handleGroupSelection(
        contact: ChatContact,
        availableGroups: List<String>,
        which: Int,
        currentGroup: String?
    ) {
        try {
            if (which < 0 || which >= availableGroups.size) {
                Log.e(TAG, "é€‰æ‹©ç´¢å¼•è¶…å‡ºèŒƒå›´: $which, å¯ç”¨é€‰é¡¹æ•°: ${availableGroups.size}")
                Toast.makeText(this, "é€‰æ‹©æ— æ•ˆï¼Œè¯·é‡è¯•", Toast.LENGTH_SHORT).show()
                return
            }

            val selectedGroup = availableGroups[which]
            Log.d(TAG, "ç”¨æˆ·é€‰æ‹©çš„åˆ†ç»„: $selectedGroup (ç´¢å¼•: $which)")

            when {
                selectedGroup == "ğŸ”„ ç§»é™¤åˆ†ç»„ï¼ˆå›åˆ°å…¨éƒ¨ï¼‰" -> {
                    Log.d(TAG, "æ‰§è¡Œç§»é™¤åˆ†ç»„æ“ä½œ")
                    removeContactFromGroup(contact)
                }
                selectedGroup == "+ åˆ›å»ºæ–°åˆ†ç»„" -> {
                    Log.d(TAG, "æ‰§è¡Œåˆ›å»ºæ–°åˆ†ç»„æ“ä½œ")
                    showCreateNewGroupForContactDialog(contact)
                }
                selectedGroup == currentGroup -> {
                    Log.d(TAG, "AIå·²åœ¨ç›®æ ‡åˆ†ç»„ä¸­ï¼Œä¸åº”è¯¥å‡ºç°è¿™ç§æƒ…å†µ")
                    Toast.makeText(this, "${contact.name} å·²åœ¨åˆ†ç»„ \"$selectedGroup\" ä¸­", Toast.LENGTH_SHORT).show()
                }
                else -> {
                    Log.d(TAG, "æ‰§è¡Œç§»åŠ¨åˆ°åˆ†ç»„æ“ä½œ: $selectedGroup")
                    confirmAndMoveToGroup(contact, selectedGroup, currentGroup)
                }
            }
        } catch (e: Exception) {
            Log.e(TAG, "å¤„ç†åˆ†ç»„é€‰æ‹©å¤±è´¥", e)
            Toast.makeText(this, "æ“ä½œå¤±è´¥: ${e.message}", Toast.LENGTH_SHORT).show()
        }
    }

    /**
     * ç¡®è®¤å¹¶ç§»åŠ¨åˆ°åˆ†ç»„
     */
    private fun confirmAndMoveToGroup(contact: ChatContact, targetGroup: String, currentGroup: String?) {
        val message = if (currentGroup != null && currentGroup != "æœªåˆ†ç»„") {
            "ç¡®å®šè¦å°† ${contact.name} ä» \"$currentGroup\" ç§»åŠ¨åˆ° \"$targetGroup\" å—ï¼Ÿ"
        } else {
            "ç¡®å®šè¦å°† ${contact.name} ç§»åŠ¨åˆ°åˆ†ç»„ \"$targetGroup\" å—ï¼Ÿ"
        }

        AlertDialog.Builder(this, R.style.Theme_MaterialDialog)
            .setTitle("ç¡®è®¤ç§»åŠ¨")
            .setMessage(message)
            .setPositiveButton("ç¡®å®š") { _, _ ->
                moveContactToGroup(contact, targetGroup)
            }
            .setNegativeButton("å–æ¶ˆ", null)
            .show()
    }

    /**
     * æ˜¾ç¤ºåˆ†ç»„é€‰æ‹©å¸®åŠ©
     */
    private fun showGroupSelectionHelp() {
        val helpMessage = """
            ğŸ“– åˆ†ç»„åŠŸèƒ½è¯´æ˜ï¼š

            ğŸ”„ ç§»é™¤åˆ†ç»„ï¼šå°†AIä»å½“å‰åˆ†ç»„ç§»é™¤ï¼Œå›åˆ°"å…¨éƒ¨"æ ‡ç­¾é¡µ

            ğŸ“ ç°æœ‰åˆ†ç»„ï¼šé€‰æ‹©å·²åˆ›å»ºçš„åˆ†ç»„è¿›è¡Œç§»åŠ¨

            â• åˆ›å»ºæ–°åˆ†ç»„ï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„åˆ†ç»„å¹¶ç§»åŠ¨AIåˆ°è¯¥åˆ†ç»„

            ğŸ’¡ æç¤ºï¼š
            â€¢ ç§»åŠ¨åAIä¼šå‡ºç°åœ¨å¯¹åº”çš„æ ‡ç­¾é¡µä¸­
            â€¢ å¯ä»¥éšæ—¶é‡æ–°ç§»åŠ¨AIåˆ°å…¶ä»–åˆ†ç»„
            â€¢ åˆ é™¤åˆ†ç»„æ—¶ï¼Œå…¶ä¸­çš„AIä¼šè‡ªåŠ¨å›åˆ°"å…¨éƒ¨"ä¸­
        """.trimIndent()

        AlertDialog.Builder(this, R.style.Theme_MaterialDialog)
            .setTitle("åˆ†ç»„åŠŸèƒ½å¸®åŠ©")
            .setMessage(helpMessage)
            .setPositiveButton("çŸ¥é“äº†", null)
            .show()
    }

    /**
     * æ˜¾ç¤ºç®€å•çš„åˆ†ç»„é€‰æ‹©å¯¹è¯æ¡†ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
     */
    private fun showSimpleGroupSelectionDialog(contact: ChatContact) {
        try {
            Log.d(TAG, "æ˜¾ç¤ºç®€å•åˆ†ç»„é€‰æ‹©å¯¹è¯æ¡†ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰")

            // è·å–å½“å‰åˆ†ç»„
            val currentGroup = findContactGroup(contact)

            // æ„å»ºåŸºæœ¬é€‰é¡¹
            val basicOptions = mutableListOf<String>()

            // æ·»åŠ ç§»é™¤åˆ†ç»„é€‰é¡¹ï¼ˆå¦‚æœé€‚ç”¨ï¼‰
            if (currentGroup != null && currentGroup != "æœªåˆ†ç»„" && currentGroup != "å…¨éƒ¨") {
                basicOptions.add("ğŸ”„ ç§»é™¤åˆ†ç»„ï¼ˆå›åˆ°å…¨éƒ¨ï¼‰")
            }

            // æ·»åŠ åŸºæœ¬åˆ†ç»„é€‰é¡¹
            val defaultGroups = listOf("AIåŠ©æ‰‹", "å·¥ä½œAI", "å­¦ä¹ AI", "ç”Ÿæ´»AI", "å¨±ä¹AI")
            defaultGroups.forEach { groupName ->
                if (groupName != currentGroup) {
                    basicOptions.add(groupName)
                }
            }

            // æ·»åŠ ç°æœ‰è‡ªå®šä¹‰åˆ†ç»„
            allContacts.forEach { category ->
                if (!defaultGroups.contains(category.name) &&
                    category.name != currentGroup &&
                    category.name != "æœªåˆ†ç»„" &&
                    !basicOptions.contains(category.name)) {
                    basicOptions.add(category.name)
                }
            }

            // æ·»åŠ åˆ›å»ºæ–°åˆ†ç»„é€‰é¡¹
            basicOptions.add("+ åˆ›å»ºæ–°åˆ†ç»„")

            val message = if (currentGroup != null && currentGroup != "æœªåˆ†ç»„") {
                "å½“å‰åˆ†ç»„ï¼š$currentGroup\n\né€‰æ‹©è¦ç§»åŠ¨åˆ°çš„åˆ†ç»„ï¼š"
            } else {
                "å½“å‰åœ¨\"å…¨éƒ¨\"ä¸­\n\né€‰æ‹©è¦ç§»åŠ¨åˆ°çš„åˆ†ç»„ï¼š"
            }

            AlertDialog.Builder(this, R.style.Theme_MaterialDialog)
                .setTitle("ç§»åŠ¨ ${contact.name}")
                .setMessage(message)
                .setItems(basicOptions.toTypedArray()) { _, which ->
                    try {
                        val selectedOption = basicOptions[which]
                        Log.d(TAG, "ç®€å•å¯¹è¯æ¡†é€‰æ‹©: $selectedOption")

                        when (selectedOption) {
                            "ğŸ”„ ç§»é™¤åˆ†ç»„ï¼ˆå›åˆ°å…¨éƒ¨ï¼‰" -> {
                                removeContactFromGroup(contact)
                            }
                            "+ åˆ›å»ºæ–°åˆ†ç»„" -> {
                                showCreateNewGroupForContactDialog(contact)
                            }
                            else -> {
                                // ç¡®è®¤ç§»åŠ¨
                                AlertDialog.Builder(this@SimpleModeActivity, R.style.Theme_MaterialDialog)
                                    .setTitle("ç¡®è®¤ç§»åŠ¨")
                                    .setMessage("ç¡®å®šè¦å°† ${contact.name} ç§»åŠ¨åˆ° \"$selectedOption\" å—ï¼Ÿ")
                                    .setPositiveButton("ç¡®å®š") { _, _ ->
                                        moveContactToGroup(contact, selectedOption)
                                    }
                                    .setNegativeButton("å–æ¶ˆ", null)
                                    .show()
                            }
                        }
                    } catch (e: Exception) {
                        Log.e(TAG, "å¤„ç†ç®€å•å¯¹è¯æ¡†é€‰æ‹©å¤±è´¥", e)
                        Toast.makeText(this@SimpleModeActivity, "æ“ä½œå¤±è´¥", Toast.LENGTH_SHORT).show()
                    }
                }
                .setNegativeButton("å–æ¶ˆ", null)
                .show()

            Log.d(TAG, "ç®€å•åˆ†ç»„é€‰æ‹©å¯¹è¯æ¡†å·²æ˜¾ç¤ºï¼Œå…± ${basicOptions.size} ä¸ªé€‰é¡¹")

        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºç®€å•åˆ†ç»„é€‰æ‹©å¯¹è¯æ¡†å¤±è´¥", e)
            Toast.makeText(this, "æ— æ³•æ˜¾ç¤ºåˆ†ç»„é€‰æ‹©å¯¹è¯æ¡†", Toast.LENGTH_SHORT).show()
        }
    }

    /**
     * æ˜¾ç¤ºåˆ›å»ºæ–°åˆ†ç»„å¯¹è¯æ¡†
     */
    private fun showCreateNewGroupDialog(contact: ChatContact) {
        try {
            val input = android.widget.EditText(this).apply {
                hint = "è¾“å…¥æ–°åˆ†ç»„åç§°"
                setPadding(50, 30, 50, 30)
            }

            AlertDialog.Builder(this, R.style.Theme_MaterialDialog)
                .setTitle("åˆ›å»ºæ–°åˆ†ç»„")
                .setView(input)
                .setPositiveButton("åˆ›å»º") { _, _ ->
                    val groupName = input.text.toString().trim()
                    if (groupName.isNotEmpty()) {
                        moveContactToGroup(contact, groupName)
                    } else {
                        Toast.makeText(this, "åˆ†ç»„åç§°ä¸èƒ½ä¸ºç©º", Toast.LENGTH_SHORT).show()
                    }
                }
                .setNegativeButton("å–æ¶ˆ", null)
                .show()

        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºåˆ›å»ºæ–°åˆ†ç»„å¯¹è¯æ¡†å¤±è´¥", e)
        }
    }



    /**
     * åˆ‡æ¢è”ç³»äººç½®é¡¶çŠ¶æ€
     */
    private fun toggleContactPin(contact: ChatContact?, isPinned: Boolean) {
        try {
            // é¦–å…ˆæ£€æŸ¥contactæ˜¯å¦ä¸ºnull
            if (contact == null) {
                Log.e(TAG, "è”ç³»äººå¯¹è±¡ä¸ºnullï¼Œæ— æ³•æ‰§è¡Œç½®é¡¶æ“ä½œ")
                Toast.makeText(this, "ç½®é¡¶æ“ä½œå¤±è´¥ï¼šè”ç³»äººæ•°æ®ä¸ºç©º", Toast.LENGTH_SHORT).show()
                return
            }
            
            Log.d(TAG, "å¼€å§‹åˆ‡æ¢è”ç³»äººç½®é¡¶çŠ¶æ€: ${contact.name} -> $isPinned")
            Log.d(TAG, "è”ç³»äººID: ${contact.id}, å½“å‰ç½®é¡¶çŠ¶æ€: ${contact.isPinned}")
            Log.d(TAG, "å½“å‰allContactså¤§å°: ${allContacts.size}")
            
            // éªŒè¯è¾“å…¥å‚æ•°
            if (contact.id.isBlank()) {
                Log.e(TAG, "è”ç³»äººIDä¸ºç©ºï¼Œæ— æ³•æ‰§è¡Œç½®é¡¶æ“ä½œ")
                Toast.makeText(this, "ç½®é¡¶æ“ä½œå¤±è´¥ï¼šè”ç³»äººæ•°æ®å¼‚å¸¸", Toast.LENGTH_SHORT).show()
                return
            }
            
            // éªŒè¯è”ç³»äººçš„å…³é”®å±æ€§
            if (contact.name.isBlank()) {
                Log.e(TAG, "è”ç³»äººåç§°ä¸ºç©ºï¼Œæ— æ³•æ‰§è¡Œç½®é¡¶æ“ä½œ")
                Toast.makeText(this, "ç½®é¡¶æ“ä½œå¤±è´¥ï¼šè”ç³»äººåç§°å¼‚å¸¸", Toast.LENGTH_SHORT).show()
                return
            }
            
            // æ‰“å°å½“å‰æ‰€æœ‰åˆ†ç±»å’Œè”ç³»äººä¿¡æ¯
            allContacts.forEachIndexed { index, category ->
                Log.d(TAG, "åˆ†ç±»[$index]: ${category.name}, è”ç³»äººæ•°é‡: ${category.contacts.size}")
                category.contacts.forEach { c ->
                    Log.d(TAG, "  è”ç³»äºº: ${c.name} (id: ${c.id}, isPinned: ${c.isPinned})")
                }
            }

            // æ‰¾åˆ°è”ç³»äººæ‰€åœ¨çš„åˆ†ç±»å’Œä½ç½®
            var found = false
            for (categoryIndex in allContacts.indices) {
                val category = allContacts[categoryIndex]
                val contactIndex = category.contacts.indexOfFirst { it.id == contact.id }

                if (contactIndex != -1) {
                    Log.d(TAG, "åœ¨åˆ†ç±»[${category.name}]ä¸­æ‰¾åˆ°è”ç³»äºº: ${contact.name}")
                    val originalContact = category.contacts[contactIndex]
                    Log.d(TAG, "åŸå§‹è”ç³»äººçŠ¶æ€: isPinned=${originalContact.isPinned}, ç›®æ ‡çŠ¶æ€: isPinned=$isPinned")
                    
                    // æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°
                    if (originalContact.isPinned == isPinned) {
                        Log.w(TAG, "è”ç³»äºº${contact.name}å·²ç»æ˜¯${if (isPinned) "ç½®é¡¶" else "éç½®é¡¶"}çŠ¶æ€ï¼Œæ— éœ€æ›´æ–°")
                        val action = if (isPinned) "å·²ç½®é¡¶" else "å·²å–æ¶ˆç½®é¡¶"
                        Toast.makeText(this, "${contact.name} $action", Toast.LENGTH_SHORT).show()
                        return
                    }
                    
                    val updatedContacts = category.contacts.toMutableList()
                    
                    // å®‰å…¨åœ°åˆ›å»ºæ›´æ–°åçš„è”ç³»äººå¯¹è±¡
                    val updatedContact = try {
                        contact.copy(
                            id = contact.id ?: "",
                            name = contact.name ?: "æœªçŸ¥è”ç³»äºº",
                            type = contact.type,
                            isPinned = isPinned,
                            aiMembers = contact.aiMembers ?: emptyList(),
                            customData = contact.customData ?: emptyMap()
                        )
                    } catch (e: Exception) {
                        Log.e(TAG, "åˆ›å»ºæ›´æ–°è”ç³»äººå¯¹è±¡å¤±è´¥: ${e.message}")
                        Toast.makeText(this, "ç½®é¡¶æ“ä½œå¤±è´¥ï¼šæ•°æ®æ›´æ–°å¼‚å¸¸", Toast.LENGTH_SHORT).show()
                        return
                    }
                    
                    updatedContacts[contactIndex] = updatedContact
                    Log.d(TAG, "æ›´æ–°åçš„è”ç³»äºº: ${updatedContact.name}, isPinned=${updatedContact.isPinned}")

                    // é‡æ–°æ’åºï¼šç½®é¡¶çš„è”ç³»äººåœ¨å‰é¢
                    val sortedContacts = updatedContacts.sortedWith(
                        compareByDescending<ChatContact> { it.isPinned }
                            .thenByDescending { it.lastMessageTime }
                    ).toMutableList()
                    
                    Log.d(TAG, "æ’åºåè”ç³»äººåˆ—è¡¨:")
                    sortedContacts.forEachIndexed { idx, c ->
                        Log.d(TAG, "  [$idx] ${c.name} (isPinned: ${c.isPinned})")
                    }

                    allContacts[categoryIndex] = category.copy(contacts = sortedContacts)
                    found = true
                    break
                }
            }

            if (!found) {
                // å¦‚æœåœ¨allContactsä¸­æ²¡æ‰¾åˆ°ï¼Œæ ¹æ®è”ç³»äººç±»å‹æ·»åŠ åˆ°ç›¸åº”åˆ†ç±»
                val targetCategory = if (contact.type == ContactType.AI) "AIåŠ©æ‰‹" else "æœªåˆ†ç»„"
                Log.d(TAG, "åœ¨allContactsä¸­æœªæ‰¾åˆ°è”ç³»äººï¼Œå°è¯•æ·»åŠ åˆ°$targetCategory")
                
                // å®‰å…¨åœ°åˆ›å»ºæ›´æ–°åçš„è”ç³»äººå¯¹è±¡
                val updatedContact = try {
                    contact.copy(
                        id = contact.id ?: "",
                        name = contact.name ?: "æœªçŸ¥è”ç³»äºº",
                        type = contact.type,
                        isPinned = isPinned,
                        aiMembers = contact.aiMembers ?: emptyList(),
                        customData = contact.customData ?: emptyMap()
                    )
                } catch (e: Exception) {
                    Log.e(TAG, "åˆ›å»ºæ–°è”ç³»äººå¯¹è±¡å¤±è´¥: ${e.message}")
                    Toast.makeText(this, "ç½®é¡¶æ“ä½œå¤±è´¥ï¼šæ•°æ®åˆ›å»ºå¼‚å¸¸", Toast.LENGTH_SHORT).show()
                    return
                }

                // æŸ¥æ‰¾æˆ–åˆ›å»ºç›®æ ‡ç±»åˆ«
                val categoryIndex = allContacts.indexOfFirst { it.name == targetCategory }
                if (categoryIndex != -1) {
                    val category = allContacts[categoryIndex]
                    val updatedContacts = category.contacts.toMutableList()
                    updatedContacts.add(updatedContact)

                    val sortedContacts = updatedContacts.sortedWith(
                        compareByDescending<ChatContact> { it.isPinned }
                            .thenByDescending { it.lastMessageTime }
                    ).toMutableList()

                    allContacts[categoryIndex] = category.copy(contacts = sortedContacts)
                } else {
                    // åˆ›å»ºæ–°çš„ç±»åˆ«
                    val newCategory = ContactCategory(
                        name = targetCategory,
                        contacts = mutableListOf(updatedContact),
                        isExpanded = true
                    )
                    if (targetCategory == "AIåŠ©æ‰‹") {
                        allContacts.add(newCategory)
                    } else {
                        allContacts.add(0, newCategory)
                    }
                }
                found = true
            }

            if (found) {
                Log.d(TAG, "å¼€å§‹ä¿å­˜è”ç³»äººæ•°æ®...")
                // ä¿å­˜æ›´æ–°åçš„è”ç³»äººæ•°æ®
                saveContacts()
                Log.d(TAG, "è”ç³»äººæ•°æ®ä¿å­˜å®Œæˆ")

                Log.d(TAG, "å¼€å§‹åˆ·æ–°UIæ˜¾ç¤º...")
                // ç«‹å³åˆ·æ–°æ˜¾ç¤º
                refreshCurrentTabDisplay()
                Log.d(TAG, "UIæ˜¾ç¤ºåˆ·æ–°å®Œæˆ")

                // æ›´æ–°é€‚é…å™¨
                if (chatContactAdapter != null) {
                    Log.d(TAG, "æ›´æ–°èŠå¤©è”ç³»äººé€‚é…å™¨...")
                    chatContactAdapter?.updateContacts(allContacts)
                    Log.d(TAG, "èŠå¤©è”ç³»äººé€‚é…å™¨æ›´æ–°å®Œæˆ")
                } else {
                    Log.w(TAG, "èŠå¤©è”ç³»äººé€‚é…å™¨ä¸ºnullï¼Œè·³è¿‡æ›´æ–°")
                }

                val action = if (isPinned) "å·²ç½®é¡¶" else "å·²å–æ¶ˆç½®é¡¶"
                Toast.makeText(this, "${contact.name} $action", Toast.LENGTH_SHORT).show()
                Log.d(TAG, "åˆ‡æ¢è”ç³»äººç½®é¡¶çŠ¶æ€æˆåŠŸ: ${contact.name} -> $isPinned")
                
                // éªŒè¯æœ€ç»ˆçŠ¶æ€
                val finalContact = findContactById(contact.id)
                if (finalContact != null) {
                    Log.d(TAG, "æœ€ç»ˆéªŒè¯ - è”ç³»äºº${finalContact.name}çš„ç½®é¡¶çŠ¶æ€: ${finalContact.isPinned}")
                } else {
                    Log.w(TAG, "æœ€ç»ˆéªŒè¯å¤±è´¥ - æ— æ³•æ‰¾åˆ°è”ç³»äºº${contact.name}")
                }
            } else {
                Log.e(TAG, "æ— æ³•æ‰¾åˆ°è”ç³»äºº: ${contact.name}")
                Toast.makeText(this, "æ“ä½œå¤±è´¥ï¼šæ‰¾ä¸åˆ°è”ç³»äºº", Toast.LENGTH_SHORT).show()
            }

        } catch (e: Exception) {
            Log.e(TAG, "åˆ‡æ¢è”ç³»äººç½®é¡¶çŠ¶æ€å¤±è´¥", e)
            Log.e(TAG, "å¼‚å¸¸è¯¦æƒ…: ${e.message}")
            Log.e(TAG, "å¼‚å¸¸å †æ ˆ: ${e.stackTraceToString()}")
            Toast.makeText(this, "ç½®é¡¶æ“ä½œå¤±è´¥: ${e.message}", Toast.LENGTH_LONG).show()
        }
    }

    /**
     * æ ¹æ®IDæŸ¥æ‰¾è”ç³»äºº
     */
    private fun findContactById(contactId: String): ChatContact? {
        for (category in allContacts) {
            for (contact in category.contacts) {
                if (contact.id == contactId) {
                    return contact
                }
            }
        }
        return null
    }

    /**
     * åˆ‡æ¢è”ç³»äººé™éŸ³çŠ¶æ€
     */
    private fun toggleContactMute(contact: ChatContact?, isMuted: Boolean) {
        try {
            // é¦–å…ˆæ£€æŸ¥contactæ˜¯å¦ä¸ºnull
            if (contact == null) {
                Log.e(TAG, "è”ç³»äººå¯¹è±¡ä¸ºnullï¼Œæ— æ³•æ‰§è¡Œé™éŸ³æ“ä½œ")
                Toast.makeText(this, "é™éŸ³æ“ä½œå¤±è´¥ï¼šè”ç³»äººæ•°æ®ä¸ºç©º", Toast.LENGTH_SHORT).show()
                return
            }
            
            Log.d(TAG, "å¼€å§‹åˆ‡æ¢è”ç³»äººé™éŸ³çŠ¶æ€: ${contact.name} -> $isMuted")

            // æ‰¾åˆ°è”ç³»äººæ‰€åœ¨çš„åˆ†ç±»å’Œä½ç½®
            var found = false
            for (categoryIndex in allContacts.indices) {
                val category = allContacts[categoryIndex]
                val contactIndex = category.contacts.indexOfFirst { it.id == contact.id }

                if (contactIndex != -1) {
                    val updatedContacts = category.contacts.toMutableList()
                    
                    // å®‰å…¨åœ°åˆ›å»ºæ›´æ–°åçš„è”ç³»äººå¯¹è±¡
                    val updatedContact = try {
                        contact.copy(
                            id = contact.id ?: "",
                            name = contact.name ?: "æœªçŸ¥è”ç³»äºº",
                            type = contact.type,
                            isMuted = isMuted,
                            aiMembers = contact.aiMembers ?: emptyList(),
                            customData = contact.customData ?: emptyMap()
                        )
                    } catch (e: Exception) {
                        Log.e(TAG, "åˆ›å»ºæ›´æ–°è”ç³»äººå¯¹è±¡å¤±è´¥: ${e.message}")
                        Toast.makeText(this, "é™éŸ³æ“ä½œå¤±è´¥ï¼šæ•°æ®æ›´æ–°å¼‚å¸¸", Toast.LENGTH_SHORT).show()
                        return
                    }
                    
                    updatedContacts[contactIndex] = updatedContact

                    allContacts[categoryIndex] = category.copy(contacts = updatedContacts.toMutableList())
                    found = true
                    break
                }
            }

            if (!found) {
                // å¦‚æœåœ¨allContactsä¸­æ²¡æ‰¾åˆ°ï¼Œæ ¹æ®è”ç³»äººç±»å‹æ·»åŠ åˆ°ç›¸åº”åˆ†ç±»
                val targetCategory = if (contact.type == ContactType.AI) "AIåŠ©æ‰‹" else "æœªåˆ†ç»„"
                Log.d(TAG, "åœ¨allContactsä¸­æœªæ‰¾åˆ°è”ç³»äººï¼Œå°è¯•æ·»åŠ åˆ°$targetCategory")
                
                // å®‰å…¨åœ°åˆ›å»ºæ›´æ–°åçš„è”ç³»äººå¯¹è±¡
                val updatedContact = try {
                    contact.copy(
                        id = contact.id ?: "",
                        name = contact.name ?: "æœªçŸ¥è”ç³»äºº",
                        type = contact.type,
                        isMuted = isMuted,
                        aiMembers = contact.aiMembers ?: emptyList(),
                        customData = contact.customData ?: emptyMap()
                    )
                } catch (e: Exception) {
                    Log.e(TAG, "åˆ›å»ºæ–°è”ç³»äººå¯¹è±¡å¤±è´¥: ${e.message}")
                    Toast.makeText(this, "é™éŸ³æ“ä½œå¤±è´¥ï¼šæ•°æ®åˆ›å»ºå¼‚å¸¸", Toast.LENGTH_SHORT).show()
                    return
                }

                // æŸ¥æ‰¾æˆ–åˆ›å»ºç›®æ ‡ç±»åˆ«
                val categoryIndex = allContacts.indexOfFirst { it.name == targetCategory }
                if (categoryIndex != -1) {
                    val category = allContacts[categoryIndex]
                    val updatedContacts = category.contacts.toMutableList()
                    updatedContacts.add(updatedContact)
                    allContacts[categoryIndex] = category.copy(contacts = updatedContacts)
                } else {
                    // åˆ›å»ºæ–°çš„ç±»åˆ«
                    val newCategory = ContactCategory(
                        name = targetCategory,
                        contacts = mutableListOf(updatedContact),
                        isExpanded = true
                    )
                    if (targetCategory == "AIåŠ©æ‰‹") {
                        allContacts.add(newCategory)
                    } else {
                        allContacts.add(0, newCategory)
                    }
                }
                found = true
            }

            if (found) {
                // ä¿å­˜æ›´æ–°åçš„è”ç³»äººæ•°æ®
                saveContacts()

                // ç«‹å³åˆ·æ–°æ˜¾ç¤º
                refreshCurrentTabDisplay()

                // æ›´æ–°é€‚é…å™¨
                chatContactAdapter?.updateContacts(allContacts)

                val action = if (isMuted) "å·²é™éŸ³" else "å·²å–æ¶ˆé™éŸ³"
                Toast.makeText(this, "${contact.name} $action", Toast.LENGTH_SHORT).show()
                Log.d(TAG, "åˆ‡æ¢è”ç³»äººé™éŸ³çŠ¶æ€æˆåŠŸ: ${contact.name} -> $isMuted")
            } else {
                Log.e(TAG, "æ— æ³•æ‰¾åˆ°è”ç³»äºº: ${contact.name}")
                Toast.makeText(this, "æ“ä½œå¤±è´¥ï¼šæ‰¾ä¸åˆ°è”ç³»äºº", Toast.LENGTH_SHORT).show()
            }

        } catch (e: Exception) {
            Log.e(TAG, "åˆ‡æ¢è”ç³»äººé™éŸ³çŠ¶æ€å¤±è´¥", e)
            Toast.makeText(this, "é™éŸ³æ“ä½œå¤±è´¥", Toast.LENGTH_SHORT).show()
        }
    }

    /**
     * åˆ‡æ¢åˆ†ç±»å±•å¼€çŠ¶æ€
     */
    private fun toggleCategoryExpansion(category: ContactCategory) {
        try {
            val index = allContacts.indexOfFirst { it.name == category.name }
            if (index != -1) {
                allContacts[index] = category.copy(isExpanded = !category.isExpanded)

                // ä¿å­˜æ›´æ–°åçš„è”ç³»äººæ•°æ®
                saveContacts()

                chatContactAdapter?.updateContacts(allContacts)
            }
            Log.d(TAG, "åˆ‡æ¢åˆ†ç±»å±•å¼€çŠ¶æ€: ${category.name}")
        } catch (e: Exception) {
            Log.e(TAG, "åˆ‡æ¢åˆ†ç±»å±•å¼€çŠ¶æ€å¤±è´¥", e)
        }
    }

    /**
     * æ‰“å¼€æ·»åŠ AIè”ç³»äººå¯¹è¯æ¡†
     */
    private fun openAddAIContactDialog() {
        try {
            // åˆ›å»ºAIåŠ©æ‰‹é€‰æ‹©å¯¹è¯æ¡†
            val aiOptions = listOf(
                "DeepSeek" to "DeepSeekçš„AIåŠ©æ‰‹",
                "ChatGPT" to "OpenAIçš„AIåŠ©æ‰‹",
                "Claude" to "Anthropicçš„AIåŠ©æ‰‹",
                "Gemini" to "Googleçš„AIåŠ©æ‰‹",
                "æ–‡å¿ƒä¸€è¨€" to "ç™¾åº¦çš„å¤§è¯­è¨€æ¨¡å‹",
                "é€šä¹‰åƒé—®" to "é˜¿é‡Œå·´å·´çš„å¤§è¯­è¨€æ¨¡å‹",
                "è®¯é£æ˜Ÿç«" to "ç§‘å¤§è®¯é£çš„AIåŠ©æ‰‹",
                "Kimi" to "Moonshotçš„AIåŠ©æ‰‹"
            )

            val aiNames = aiOptions.map { it.first }.toTypedArray()

            AlertDialog.Builder(this)
                .setTitle("é€‰æ‹©AIåŠ©æ‰‹")
                .setItems(aiNames) { _, which ->
                    val selectedAI = aiOptions[which]
                    showApiKeyInputDialog(selectedAI.first, selectedAI.second)
                }
                .setNegativeButton("å–æ¶ˆ", null)
                .show()

            Log.d(TAG, "æ‰“å¼€AIåŠ©æ‰‹é€‰æ‹©å¯¹è¯æ¡†")
        } catch (e: Exception) {
            Log.e(TAG, "æ‰“å¼€AIåŠ©æ‰‹é€‰æ‹©å¯¹è¯æ¡†å¤±è´¥", e)
            Toast.makeText(this, "æ‰“å¼€AIåŠ©æ‰‹é€‰æ‹©å¯¹è¯æ¡†å¤±è´¥", Toast.LENGTH_SHORT).show()
        }
    }

    /**
     * æ˜¾ç¤ºAPIå¯†é’¥è¾“å…¥å¯¹è¯æ¡†
     */
    private fun showApiKeyInputDialog(aiName: String, description: String) {
        try {
            // åˆ›å»ºAPIå¯†é’¥è¾“å…¥å¯¹è¯æ¡†
            val input = EditText(this).apply {
                hint = "è¯·è¾“å…¥${aiName}çš„APIå¯†é’¥"
                inputType = android.text.InputType.TYPE_CLASS_TEXT or android.text.InputType.TYPE_TEXT_VARIATION_VISIBLE_PASSWORD
                setPadding(50, 30, 50, 30)
            }

            AlertDialog.Builder(this)
                .setTitle("é…ç½®${aiName}")
                .setMessage("è¯·å¡«å†™${aiName}çš„APIå¯†é’¥ä»¥æ¿€æ´»å¯¹è¯åŠŸèƒ½")
                .setView(input)
                .setPositiveButton("ç¡®å®š") { _, _ ->
                    val apiKey = input.text.toString().trim()
                    if (apiKey.isNotEmpty()) {
                        // éªŒè¯APIå¯†é’¥æ ¼å¼
                        if (isValidApiKey(apiKey, aiName)) {
                            // ä¿å­˜APIå¯†é’¥åˆ°è®¾ç½®
                            saveApiKeyForAI(aiName, apiKey)
                            // æ·»åŠ AIåŠ©æ‰‹åˆ°è”ç³»äººåˆ—è¡¨
                            addAIContactToCategory(aiName, description, apiKey)
                            Toast.makeText(this, "${aiName}å·²æ¿€æ´»ï¼ŒAPIå¯†é’¥å·²ä¿å­˜", Toast.LENGTH_SHORT).show()
                        } else {
                            // æ˜¾ç¤ºæ ¼å¼é”™è¯¯æç¤º
                            val errorMsg = when (aiName.lowercase()) {
                                "deepseek", "chatgpt" -> "APIå¯†é’¥åº”è¯¥ä»¥'sk-'å¼€å¤´ä¸”é•¿åº¦è‡³å°‘20ä¸ªå­—ç¬¦"
                                "claude" -> "APIå¯†é’¥åº”è¯¥ä»¥'sk-ant-'å¼€å¤´ä¸”é•¿åº¦è‡³å°‘20ä¸ªå­—ç¬¦"
                                else -> "APIå¯†é’¥æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·æ£€æŸ¥"
                            }
                            Toast.makeText(this, errorMsg, Toast.LENGTH_LONG).show()
                        }
                    } else {
                        Toast.makeText(this, "è¯·è¾“å…¥APIå¯†é’¥", Toast.LENGTH_SHORT).show()
                    }
                }
                .setNegativeButton("å–æ¶ˆ", null)
                .show()

            Log.d(TAG, "æ˜¾ç¤ºAPIå¯†é’¥è¾“å…¥å¯¹è¯æ¡†: $aiName")
        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºAPIå¯†é’¥è¾“å…¥å¯¹è¯æ¡†å¤±è´¥", e)
            Toast.makeText(this, "æ˜¾ç¤ºAPIå¯†é’¥è¾“å…¥å¯¹è¯æ¡†å¤±è´¥", Toast.LENGTH_SHORT).show()
        }
    }

    /**
     * éªŒè¯APIå¯†é’¥æ˜¯å¦æœ‰æ•ˆ
     */
    private fun isValidApiKey(apiKey: String, aiName: String): Boolean {
        // ä¸´æ—¶ä¸“çº¿ä¸éœ€è¦APIå¯†é’¥ï¼Œå§‹ç»ˆè¿”å›true
        if (aiName == "ä¸´æ—¶ä¸“çº¿") {
            return true
        }
        
        if (apiKey.isBlank()) {
            return false
        }

        // æ ¹æ®ä¸åŒçš„AIæœåŠ¡éªŒè¯APIå¯†é’¥æ ¼å¼
        return when (aiName.lowercase()) {
            "deepseek" -> apiKey.startsWith("sk-") && apiKey.length >= 20
            "chatgpt" -> apiKey.startsWith("sk-") && apiKey.length >= 20
            "claude" -> apiKey.startsWith("sk-ant-") && apiKey.length >= 20
            "gemini" -> apiKey.length >= 20 // Google APIå¯†é’¥æ²¡æœ‰å›ºå®šå‰ç¼€
            "æ™ºè°±ai", "æ™ºè°±AI" -> apiKey.contains(".") && apiKey.length >= 20 // æ™ºè°±AI APIå¯†é’¥æ ¼å¼ï¼šxxxxx.xxxxx
            "æ–‡å¿ƒä¸€è¨€" -> apiKey.length >= 10 // ç™¾åº¦APIå¯†é’¥
            "é€šä¹‰åƒé—®" -> apiKey.length >= 10 // é˜¿é‡Œäº‘APIå¯†é’¥
            "è®¯é£æ˜Ÿç«" -> apiKey.length >= 10 // è®¯é£APIå¯†é’¥
            "kimi" -> apiKey.length >= 10 // Kimi APIå¯†é’¥
            else -> apiKey.length >= 10
        }
    }

    /**
     * è·å–AIçš„APIå¯†é’¥
     */
    private fun getApiKeyForAI(aiName: String): String {
        try {
            val settingsManager = SettingsManager.getInstance(this)
            val keyName = when (aiName.lowercase()) {
                "ä¸´æ—¶ä¸“çº¿", "tempservice", "temp_service" -> "" // ä¸´æ—¶ä¸“çº¿ä¸éœ€è¦APIå¯†é’¥
                "deepseek" -> "deepseek_api_key"
                "chatgpt" -> "chatgpt_api_key"
                "claude" -> "claude_api_key"
                "gemini" -> "gemini_api_key"
                "æ™ºè°±ai", "æ™ºè°±AI" -> "zhipu_ai_api_key"
                "æ–‡å¿ƒä¸€è¨€" -> "wenxin_api_key"
                "é€šä¹‰åƒé—®" -> "qianwen_api_key"
                "è®¯é£æ˜Ÿç«" -> "xinghuo_api_key"
                "kimi" -> "kimi_api_key"
                else -> "${aiName.lowercase()}_api_key"
            }
            return if (keyName.isEmpty()) "" else settingsManager.getString(keyName, "") ?: ""
        } catch (e: Exception) {
            Log.e(TAG, "è·å–APIå¯†é’¥å¤±è´¥", e)
            return ""
        }
    }

    /**
     * ä¿å­˜AIçš„APIå¯†é’¥åˆ°è®¾ç½®
     */
    private fun saveApiKeyForAI(aiName: String, apiKey: String) {
        try {
            val settingsManager = SettingsManager.getInstance(this)
            val keyName = when (aiName.lowercase()) {
                "deepseek" -> "deepseek_api_key"
                "chatgpt" -> "chatgpt_api_key"
                "claude" -> "claude_api_key"
                "gemini" -> "gemini_api_key"
                "æ™ºè°±ai", "æ™ºè°±AI" -> "zhipu_ai_api_key"
                "æ–‡å¿ƒä¸€è¨€" -> "wenxin_api_key"
                "é€šä¹‰åƒé—®" -> "qianwen_api_key"
                "è®¯é£æ˜Ÿç«" -> "xinghuo_api_key"
                "kimi" -> "kimi_api_key"
                else -> "${aiName.lowercase()}_api_key"
            }

            // ä¿å­˜åˆ°SettingsManagerï¼ˆç³»ç»Ÿè®¾ç½®ï¼‰
            settingsManager.putString(keyName, apiKey)

            // åŒæ—¶ä¿å­˜API URLåˆ°è®¾ç½®ä¸­ï¼Œç¡®ä¿ç³»ç»Ÿè®¾ç½®å®Œæ•´
            val urlKeyName = keyName.replace("_api_key", "_api_url")
            val defaultUrl = getDefaultApiUrl(aiName)
            settingsManager.putString(urlKeyName, defaultUrl)

            Log.d(TAG, "ä¿å­˜APIå¯†é’¥åˆ°ç³»ç»Ÿè®¾ç½®: $keyName")
            Log.d(TAG, "åŒæ­¥API URLåˆ°ç³»ç»Ÿè®¾ç½®: $urlKeyName = $defaultUrl")

            // é€šçŸ¥å…¶ä»–ç»„ä»¶APIå¯†é’¥å·²æ›´æ–°
            notifyApiKeyUpdated(aiName, apiKey)

        } catch (e: Exception) {
            Log.e(TAG, "ä¿å­˜APIå¯†é’¥å¤±è´¥", e)
        }
    }

    /**
     * é€šçŸ¥APIå¯†é’¥å·²æ›´æ–°
     */
    private fun notifyApiKeyUpdated(aiName: String, apiKey: String) {
        try {
            // æ›´æ–°ç°æœ‰è”ç³»äººçš„APIå¯†é’¥
            updateExistingContactApiKey(aiName, apiKey)

            // å‘é€å¹¿æ’­é€šçŸ¥å…¶ä»–ç»„ä»¶ï¼ˆå¦‚æœéœ€è¦ï¼‰
            val intent = Intent("com.example.aifloatingball.API_KEY_UPDATED").apply {
                putExtra("ai_name", aiName)
                putExtra("api_key", apiKey)
            }
            sendBroadcast(intent)

        } catch (e: Exception) {
            Log.e(TAG, "é€šçŸ¥APIå¯†é’¥æ›´æ–°å¤±è´¥", e)
        }
    }

    /**
     * æ›´æ–°ç°æœ‰è”ç³»äººçš„APIå¯†é’¥
     */
    private fun updateExistingContactApiKey(aiName: String, newApiKey: String) {
        try {
            var updated = false

            for (category in allContacts) {
                for (contact in category.contacts) {
                    if (contact.name.equals(aiName, ignoreCase = true)) {
                        // æ›´æ–°è”ç³»äººçš„APIå¯†é’¥
                        val updatedCustomData = contact.customData.toMutableMap()
                        updatedCustomData["api_key"] = newApiKey
                        updatedCustomData["api_url"] = getDefaultApiUrl(aiName)

                        // åˆ›å»ºæ›´æ–°åçš„è”ç³»äººå¯¹è±¡ï¼ˆéœ€è¦ç”¨åå°„æˆ–é‡æ–°åˆ›å»ºï¼‰
                        val updatedContact = contact.copy(customData = updatedCustomData)

                        // åœ¨categoryä¸­æ›¿æ¢è”ç³»äºº
                        val contactIndex = category.contacts.indexOf(contact)
                        if (contactIndex >= 0) {
                            val updatedContacts = category.contacts.toMutableList()
                            updatedContacts[contactIndex] = updatedContact

                            val categoryIndex = allContacts.indexOf(category)
                            if (categoryIndex >= 0) {
                                val updatedCategory = category.copy(contacts = updatedContacts)
                                (allContacts as MutableList)[categoryIndex] = updatedCategory
                                updated = true
                            }
                        }
                        break
                    }
                }
                if (updated) break
            }

            if (updated) {
                // ä¿å­˜æ›´æ–°åçš„è”ç³»äººæ•°æ®
                saveContacts()

                // åˆ·æ–°UI
                chatContactAdapter?.updateContacts(allContacts)

                Log.d(TAG, "å·²æ›´æ–°ç°æœ‰è”ç³»äººçš„APIå¯†é’¥: $aiName")
            }

        } catch (e: Exception) {
            Log.e(TAG, "æ›´æ–°ç°æœ‰è”ç³»äººAPIå¯†é’¥å¤±è´¥", e)
        }
    }

    /**
     * æ·»åŠ AIåŠ©æ‰‹åˆ°åˆ†ç±»
     */
    private fun addAIContactToCategory(name: String, description: String, apiKey: String = "") {
        try {
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è¯¥AIåŠ©æ‰‹
            val existingContact = allContacts.flatMap { it.contacts }.find { it.name == name }
            if (existingContact != null) {
                Toast.makeText(this, "$name å·²å­˜åœ¨äºè”ç³»äººåˆ—è¡¨ä¸­", Toast.LENGTH_SHORT).show()
                return
            }

            // åˆ›å»ºæ–°çš„AIè”ç³»äºº
            val newContact = ChatContact(
                id = "ai_${name.lowercase().replace(" ", "_")}_${System.currentTimeMillis()}",
                name = name,
                type = ContactType.AI,
                description = description,
                isOnline = true,
                lastMessage = "ä½ å¥½ï¼æˆ‘æ˜¯$nameï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ",
                lastMessageTime = System.currentTimeMillis(),
                unreadCount = 0,
                isPinned = true, // æ–°æ·»åŠ çš„AIåŠ©æ‰‹ä¼˜å…ˆæ˜¾ç¤º
                customData = mapOf(
                    "api_url" to getDefaultApiUrl(name),
                    "api_key" to apiKey,
                    "model" to getDefaultModel(name)
                ),
                aiMembers = emptyList()
            )

            // æ·»åŠ åˆ°è”ç³»äººåˆ—è¡¨
            addContactToList(newContact)

            // æ ‡è®°AIä¸ºå·²é…ç½®
            markAIAsConfigured(name)

            Toast.makeText(this, "å·²æ·»åŠ  $name", Toast.LENGTH_SHORT).show()
            Log.d(TAG, "æ·»åŠ AIåŠ©æ‰‹åˆ°åˆ†ç±»: $name")
        } catch (e: Exception) {
            Log.e(TAG, "æ·»åŠ AIåŠ©æ‰‹åˆ°åˆ†ç±»å¤±è´¥", e)
            Toast.makeText(this, "æ·»åŠ AIåŠ©æ‰‹å¤±è´¥", Toast.LENGTH_SHORT).show()
        }
    }

    /**
     * è·å–é»˜è®¤APIåœ°å€
     */
    private fun getDefaultApiUrl(aiName: String): String {
        return when (aiName.lowercase()) {
            "ä¸´æ—¶ä¸“çº¿" -> "https://818233.xyz/"
            "deepseek" -> "https://api.deepseek.com/v1/chat/completions"
            "chatgpt" -> "https://api.openai.com/v1/chat/completions"
            "claude" -> "https://api.anthropic.com/v1/messages"
            "gemini" -> "https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent"
            "æ–‡å¿ƒä¸€è¨€" -> "https://aip.baidubce.com/rpc/2.0/ai_custom/v1/wenxinworkshop/chat/completions"
            "é€šä¹‰åƒé—®" -> "https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation"
            "è®¯é£æ˜Ÿç«" -> "https://spark-api.xf-yun.com/v3.1/chat"
            "kimi" -> "https://api.moonshot.cn/v1/chat/completions"
            "æ™ºè°±ai", "zhipu", "glm" -> "https://open.bigmodel.cn/api/paas/v4/chat/completions"
            else -> "https://api.openai.com/v1/chat/completions"
        }
    }

    /**
     * è·å–é»˜è®¤æ¨¡å‹åç§°
     */
    private fun getDefaultModel(aiName: String): String {
        return when (aiName.lowercase()) {
            "ä¸´æ—¶ä¸“çº¿" -> "gpt-oss-20b"
            "deepseek" -> "deepseek-chat"
            "chatgpt" -> "gpt-3.5-turbo"
            "claude" -> "claude-3-sonnet-20240229"
            "gemini" -> "gemini-pro"
            "æ–‡å¿ƒä¸€è¨€" -> "ernie-bot-4"
            "é€šä¹‰åƒé—®" -> "qwen-turbo"
            "è®¯é£æ˜Ÿç«" -> "spark-v3.1"
            "kimi" -> "moonshot-v1-8k"
            "æ™ºè°±ai", "zhipu", "glm" -> "glm-4"
            else -> "gpt-3.5-turbo"
        }
    }

    /**
     * æ‰“å¼€æ·»åŠ APIè”ç³»äººå¯¹è¯æ¡†
     */
    private fun openAddAPIContactDialog() {
        try {
            Log.d(TAG, "å¼€å§‹åˆ›å»ºæ·»åŠ APIè”ç³»äººå¯¹è¯æ¡†")
            showActualAPIDialog()
        } catch (e: Exception) {
            Log.e(TAG, "æ‰“å¼€æ·»åŠ APIè”ç³»äººå¯¹è¯æ¡†å¤±è´¥", e)
            Toast.makeText(this, "æ‰“å¼€æ·»åŠ APIè”ç³»äººå¯¹è¯æ¡†å¤±è´¥: ${e.message}", Toast.LENGTH_LONG).show()
        }
    }

    /**
     * æ˜¾ç¤ºå®é™…çš„APIé…ç½®å¯¹è¯æ¡†
     */
    private fun showActualAPIDialog() {
        try {
            Log.d(TAG, "å¼€å§‹åˆ›å»ºå®é™…çš„APIé…ç½®å¯¹è¯æ¡†")

            // æ£€æŸ¥å¸ƒå±€æ–‡ä»¶æ˜¯å¦å­˜åœ¨
            val layoutId = R.layout.dialog_add_api_contact
            Log.d(TAG, "å¸ƒå±€æ–‡ä»¶ID: $layoutId")

            val dialogView = LayoutInflater.from(this).inflate(layoutId, null)
            Log.d(TAG, "å¸ƒå±€æ–‡ä»¶åŠ è½½æˆåŠŸ")

            val dialog = AlertDialog.Builder(this)
                .setView(dialogView)
                .setCancelable(true)
                .create()

            // è·å–è§†å›¾ç»„ä»¶
            val aiModelSpinner = dialogView.findViewById<Spinner>(R.id.ai_model_spinner)
            val nameInput = dialogView.findViewById<EditText>(R.id.name_input)
            val apiUrlInput = dialogView.findViewById<EditText>(R.id.api_url_input)
            val modelInput = dialogView.findViewById<EditText>(R.id.model_input)
            val apiKeyInput = dialogView.findViewById<EditText>(R.id.api_key_input)
            val confirmButton = dialogView.findViewById<Button>(R.id.confirm_button)
            val cancelButton = dialogView.findViewById<Button>(R.id.cancel_button)

            // æ£€æŸ¥æ‰€æœ‰è§†å›¾æ˜¯å¦æˆåŠŸæ‰¾åˆ°
            if (aiModelSpinner == null || nameInput == null || apiUrlInput == null ||
                modelInput == null || apiKeyInput == null || confirmButton == null || cancelButton == null) {
                Log.e(TAG, "æŸäº›è§†å›¾æœªæ‰¾åˆ°")
                Toast.makeText(this, "å¯¹è¯æ¡†å¸ƒå±€åŠ è½½å¤±è´¥", Toast.LENGTH_SHORT).show()
                return
            }

            Log.d(TAG, "æ‰€æœ‰è§†å›¾åŠ è½½æˆåŠŸ")

            // å®šä¹‰AIæ¨¡å‹é€‰é¡¹
            val aiModels = listOf(
                "ä¸´æ—¶ä¸“çº¿" to "å…è´¹AIæœåŠ¡ (æ— éœ€APIå¯†é’¥)",
                "DeepSeek" to "DeepSeekçš„AIåŠ©æ‰‹",
                "ChatGPT" to "OpenAIçš„AIåŠ©æ‰‹",
                "Claude" to "Anthropicçš„AIåŠ©æ‰‹",
                "Gemini" to "Googleçš„AIåŠ©æ‰‹",
                "æ™ºè°±AI" to "æ™ºè°±AIçš„GLM-4å¤§è¯­è¨€æ¨¡å‹",
                "æ–‡å¿ƒä¸€è¨€" to "ç™¾åº¦çš„å¤§è¯­è¨€æ¨¡å‹",
                "é€šä¹‰åƒé—®" to "é˜¿é‡Œå·´å·´çš„å¤§è¯­è¨€æ¨¡å‹",
                "è®¯é£æ˜Ÿç«" to "ç§‘å¤§è®¯é£çš„AIåŠ©æ‰‹",
                "Kimi" to "Moonshotçš„AIåŠ©æ‰‹"
            )

            val modelNames = aiModels.map { it.first }.toTypedArray()

            // è®¾ç½®Spinneré€‚é…å™¨ - ä½¿ç”¨è‡ªå®šä¹‰å¸ƒå±€æ”¯æŒæš—è‰²æ¨¡å¼
            val spinnerAdapter = ArrayAdapter(this, R.layout.spinner_item, modelNames)
            spinnerAdapter.setDropDownViewResource(R.layout.dropdown_item)
            aiModelSpinner.adapter = spinnerAdapter

            // è®¾ç½®Spinneré€‰æ‹©ç›‘å¬å™¨
            aiModelSpinner.onItemSelectedListener = object : android.widget.AdapterView.OnItemSelectedListener {
                override fun onItemSelected(parent: android.widget.AdapterView<*>?, view: android.view.View?, position: Int, id: Long) {
                    val selectedModel = aiModels[position]
                    val modelName = selectedModel.first

                    // è‡ªåŠ¨å¡«å……å­—æ®µ
                    nameInput.setText(modelName)
                    apiUrlInput.setText(getDefaultApiUrl(modelName))
                    modelInput.setText(getDefaultModel(modelName))

                    // å¦‚æœæ˜¯ä¸´æ—¶ä¸“çº¿ï¼Œç¦ç”¨APIå¯†é’¥è¾“å…¥å¹¶æ¸…ç©º
                    if (modelName == "ä¸´æ—¶ä¸“çº¿") {
                        apiKeyInput.isEnabled = false
                        apiKeyInput.setText("")
                        apiKeyInput.hint = "ä¸´æ—¶ä¸“çº¿æ— éœ€APIå¯†é’¥"
                        apiKeyInput.setHintTextColor(getColor(R.color.dialog_hint_text_light))
                    } else {
                        apiKeyInput.isEnabled = true
                        apiKeyInput.hint = "è¯·è¾“å…¥APIå¯†é’¥"
                        apiKeyInput.setHintTextColor(getColor(R.color.dialog_hint_text_light))
                    }

                    Log.d(TAG, "é€‰æ‹©AIæ¨¡å‹: $modelName")
                }

                override fun onNothingSelected(parent: android.widget.AdapterView<*>?) {
                    // é»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ª
                    if (aiModels.isNotEmpty()) {
                        val defaultModel = aiModels[0]
                        nameInput.setText(defaultModel.first)
                        apiUrlInput.setText(getDefaultApiUrl(defaultModel.first))
                        modelInput.setText(getDefaultModel(defaultModel.first))
                        
                        // å¤„ç†ä¸´æ—¶ä¸“çº¿çš„ç‰¹æ®Šæƒ…å†µ
                        if (defaultModel.first == "ä¸´æ—¶ä¸“çº¿") {
                            apiKeyInput.isEnabled = false
                            apiKeyInput.setText("")
                            apiKeyInput.hint = "ä¸´æ—¶ä¸“çº¿æ— éœ€APIå¯†é’¥"
                            apiKeyInput.setHintTextColor(getColor(R.color.dialog_hint_text_light))
                        } else {
                            apiKeyInput.isEnabled = true
                            apiKeyInput.hint = "è¯·è¾“å…¥APIå¯†é’¥"
                            apiKeyInput.setHintTextColor(getColor(R.color.dialog_hint_text_light))
                        }
                    }
                }
            }

            // è®¾ç½®ç¡®è®¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            confirmButton.setOnClickListener {
                try {
                    val name = nameInput.text?.toString()?.trim() ?: ""
                    val apiUrl = apiUrlInput.text?.toString()?.trim() ?: ""
                    val model = modelInput.text?.toString()?.trim() ?: ""
                    val apiKey = apiKeyInput.text?.toString()?.trim() ?: ""

                    Log.d(TAG, "ç”¨æˆ·è¾“å…¥: name=$name, apiUrl=$apiUrl, model=$model, apiKey=${if (apiKey.isNotEmpty()) "å·²å¡«å†™" else "æœªå¡«å†™"}")

                    // ä¸´æ—¶ä¸“çº¿ä¸éœ€è¦APIå¯†é’¥éªŒè¯
                    val isTempService = name == "ä¸´æ—¶ä¸“çº¿"
                    val isValidInput = if (isTempService) {
                        name.isNotEmpty() && apiUrl.isNotEmpty()
                    } else {
                        name.isNotEmpty() && apiUrl.isNotEmpty() && apiKey.isNotEmpty()
                    }

                    if (isValidInput) {
                        if (!isTempService) {
                            // ä¿å­˜APIå¯†é’¥åˆ°SettingsManagerï¼ˆä¸´æ—¶ä¸“çº¿ä¸éœ€è¦ï¼‰
                            saveApiKeyForAI(name, apiKey)
                        }

                        // åˆ›å»ºæ–°çš„AIè”ç³»äºº
                        val newContact = ChatContact(
                            id = "custom_ai_${System.currentTimeMillis()}",
                            name = name,
                            type = ContactType.AI,
                            description = if (isTempService) "å…è´¹AIæœåŠ¡ (æ— éœ€APIå¯†é’¥)" else "è‡ªå®šä¹‰AIåŠ©æ‰‹",
                            isOnline = true,
                            lastMessage = "ä½ å¥½ï¼æˆ‘æ˜¯$nameï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ",
                            lastMessageTime = System.currentTimeMillis(),
                            unreadCount = 0,
                            isPinned = true, // è‡ªå®šä¹‰APIçš„AIä¼˜å…ˆæ˜¾ç¤º
                            customData = mapOf(
                                "api_url" to apiUrl,
                                "api_key" to if (isTempService) "" else apiKey,
                                "model" to model.ifEmpty { "default" },
                                "is_temp_service" to isTempService.toString()
                            ),
                            aiMembers = emptyList()
                        )

                        // æ·»åŠ åˆ°è”ç³»äººåˆ—è¡¨
                        addContactToList(newContact)
                        dialog.dismiss()
                        val successMsg = if (isTempService) {
                            "AIåŠ©æ‰‹ $name æ·»åŠ æˆåŠŸ (å…è´¹æœåŠ¡)"
                        } else {
                            "AIåŠ©æ‰‹ $name æ·»åŠ æˆåŠŸï¼ŒAPIå¯†é’¥å·²ä¿å­˜"
                        }
                        Toast.makeText(this, successMsg, Toast.LENGTH_SHORT).show()
                        Log.d(TAG, "æ·»åŠ è‡ªå®šä¹‰API AIè”ç³»äººæˆåŠŸ: $name")
                    } else {
                        val errorMsg = if (isTempService) {
                            "è¯·å¡«å†™AIåŠ©æ‰‹åç§°å’ŒAPIåœ°å€"
                        } else {
                            "è¯·å¡«å†™APIå¯†é’¥"
                        }
                        Toast.makeText(this, errorMsg, Toast.LENGTH_SHORT).show()
                        Log.d(TAG, "ç”¨æˆ·è¾“å…¥ä¸å®Œæ•´: $errorMsg")
                    }
                } catch (e: Exception) {
                    Log.e(TAG, "å¤„ç†ç¡®è®¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶å¤±è´¥", e)
                    Toast.makeText(this, "å¤„ç†å¤±è´¥: ${e.message}", Toast.LENGTH_SHORT).show()
                }
            }

            // è®¾ç½®å–æ¶ˆæŒ‰é’®ç‚¹å‡»äº‹ä»¶
            cancelButton.setOnClickListener {
                dialog.dismiss()
                Log.d(TAG, "ç”¨æˆ·å–æ¶ˆæ·»åŠ APIè”ç³»äºº")
            }

            // æ˜¾ç¤ºå¯¹è¯æ¡†
            dialog.show()
            Log.d(TAG, "æ·»åŠ APIè”ç³»äººå¯¹è¯æ¡†æ˜¾ç¤ºæˆåŠŸ")

        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºå®é™…APIé…ç½®å¯¹è¯æ¡†å¤±è´¥", e)
            Toast.makeText(this, "æ˜¾ç¤ºAPIé…ç½®å¯¹è¯æ¡†å¤±è´¥: ${e.message}", Toast.LENGTH_LONG).show()
        }
    }





    /**
     * åˆ é™¤è”ç³»äººï¼ˆå†…éƒ¨æ–¹æ³•ï¼Œä¸å†æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†ï¼‰
     */
    private fun deleteContact(contact: ChatContact) {
        try {
            when (contact.type) {
                ContactType.AI -> {
                    removeAIConfiguration(contact)
                }
                ContactType.GROUP -> {
                    removeGroupChatConfiguration(contact)
                }
                else -> {
                    removeContactFromList(contact)
                }
            }
        } catch (e: Exception) {
            Log.e(TAG, "åˆ é™¤è”ç³»äººå¤±è´¥", e)
            Toast.makeText(this, "åˆ é™¤æ“ä½œå¤±è´¥", Toast.LENGTH_SHORT).show()
        }
    }

    /**
     * ç§»é™¤AIé…ç½®
     */
    private fun removeAIConfiguration(contact: ChatContact) {
        try {
            // è·å–å½“å‰åˆ†ç»„
            val currentGroup = findContactGroup(contact)

            // æ¸…é™¤APIå¯†é’¥
            val prefs = getSharedPreferences("ai_api_keys", MODE_PRIVATE)
            prefs.edit().remove(contact.name).apply()

            // ä»æ‰€æœ‰åˆ†ç»„ä¸­ç§»é™¤è¯¥AI
            val groupsToCheck = mutableListOf<String>()
            for (categoryIndex in allContacts.indices) {
                val category = allContacts[categoryIndex]
                val updatedContacts = category.contacts.filter { it.id != contact.id }.toMutableList().toMutableList()
                if (updatedContacts.size != category.contacts.size) {
                    allContacts[categoryIndex] = category.copy(contacts = updatedContacts)

                    // æ£€æŸ¥æ˜¯å¦éœ€è¦ç§»é™¤ç©ºåˆ†ç»„æ ‡ç­¾é¡µ
                    if (updatedContacts.isEmpty() &&
                        category.name != "AIåŠ©æ‰‹" &&
                        category.name != "å…¨éƒ¨" &&
                        category.name != "æœªåˆ†ç»„") {
                        groupsToCheck.add(category.name)
                    }
                }
            }

            // ç§»é™¤ç©ºåˆ†ç»„çš„æ ‡ç­¾é¡µ
            groupsToCheck.forEach { groupName ->
                removeEmptyGroupTab(groupName)
            }

            // ä¿å­˜æ›´æ”¹
            saveContacts()

            // åˆ·æ–°æ˜¾ç¤ºï¼ˆä¸åˆ‡æ¢åˆ°"å…¨éƒ¨"æ ‡ç­¾é¡µï¼Œé¿å…å¼¹çª—ï¼‰
            refreshCurrentTabDisplay()

            // æ›´æ–°é€‚é…å™¨
            chatContactAdapter?.updateContacts(allContacts)

            Log.d(TAG, "ç§»é™¤AIé…ç½®æˆåŠŸ: ${contact.name}")

        } catch (e: Exception) {
            Log.e(TAG, "ç§»é™¤AIé…ç½®å¤±è´¥", e)
            Toast.makeText(this, "âŒ ç§»é™¤é…ç½®å¤±è´¥: ${e.message}", Toast.LENGTH_SHORT).show()
        }
    }

    /**
     * ç§»é™¤ç¾¤èŠé…ç½®
     */
    private fun removeGroupChatConfiguration(contact: ChatContact) {
        try {
            Log.d(TAG, "=== å¼€å§‹åˆ é™¤ç¾¤èŠ: ${contact.name} (ID: ${contact.id}, GroupID: ${contact.groupId}) ===")
            
            // ä»æ‰€æœ‰æ•°æ®æºåˆ é™¤ç¾¤èŠæ•°æ®
            if (contact.groupId != null) {
                // 1. ä»UnifiedGroupChatManageråˆ é™¤
                Log.d(TAG, "åˆ é™¤å‰UnifiedGroupChatManagerä¸­çš„ç¾¤èŠæ•°é‡: ${unifiedGroupChatManager.getAllGroupChats().size}")
                val deleted = unifiedGroupChatManager.deleteGroupChat(contact.groupId!!)
                Log.d(TAG, "ä»UnifiedGroupChatManageråˆ é™¤ç¾¤èŠ: ${contact.groupId}, ç»“æœ: $deleted")
                Log.d(TAG, "åˆ é™¤åUnifiedGroupChatManagerä¸­çš„ç¾¤èŠæ•°é‡: ${unifiedGroupChatManager.getAllGroupChats().size}")
                
                // 2. ä»GroupChatManageråˆ é™¤ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                try {
                    val groupChatManager = GroupChatManager.getInstance(this)
                    val groupChatManagerDeleted = groupChatManager.deleteGroupChat(contact.groupId!!)
                    Log.d(TAG, "ä»GroupChatManageråˆ é™¤ç¾¤èŠ: ${contact.groupId}, ç»“æœ: $groupChatManagerDeleted")
                } catch (e: Exception) {
                    Log.w(TAG, "ä»GroupChatManageråˆ é™¤ç¾¤èŠå¤±è´¥: ${e.message}")
                }
            } else {
                Log.w(TAG, "ç¾¤èŠè”ç³»äººç¼ºå°‘groupIdï¼Œæ— æ³•ä»ç®¡ç†å™¨åˆ é™¤")
            }

            // ä»æ‰€æœ‰åˆ†ç»„ä¸­ç§»é™¤è¯¥ç¾¤èŠè”ç³»äºº
            val groupsToCheck = mutableListOf<String>()
            for (categoryIndex in allContacts.indices) {
                val category = allContacts[categoryIndex]
                val updatedContacts = category.contacts.filter { it.id != contact.id }.toMutableList()
                if (updatedContacts.size != category.contacts.size) {
                    allContacts[categoryIndex] = category.copy(contacts = updatedContacts)

                    // æ£€æŸ¥æ˜¯å¦éœ€è¦ç§»é™¤ç©ºåˆ†ç»„æ ‡ç­¾é¡µ
                    if (updatedContacts.isEmpty() &&
                        category.name != "AIåŠ©æ‰‹" &&
                        category.name != "å…¨éƒ¨" &&
                        category.name != "æœªåˆ†ç»„") {
                        groupsToCheck.add(category.name)
                    }
                }
            }

            // ç§»é™¤ç©ºåˆ†ç»„çš„æ ‡ç­¾é¡µ
            groupsToCheck.forEach { groupName ->
                removeEmptyGroupTab(groupName)
            }

            // ä¿å­˜æ›´æ”¹
            saveContacts()

            // åˆ·æ–°æ˜¾ç¤ºï¼ˆä¸åˆ‡æ¢åˆ°"å…¨éƒ¨"æ ‡ç­¾é¡µï¼Œé¿å…å¼¹çª—ï¼‰
            refreshCurrentTabDisplay()

            // æ›´æ–°é€‚é…å™¨
            chatContactAdapter?.updateContacts(allContacts)

            Log.d(TAG, "ç§»é™¤ç¾¤èŠé…ç½®æˆåŠŸ: ${contact.name}")
            Log.d(TAG, "åˆ é™¤å®ŒæˆåUnifiedGroupChatManagerä¸­çš„ç¾¤èŠæ•°é‡: ${unifiedGroupChatManager.getAllGroupChats().size}")
            Log.d(TAG, "=== ç¾¤èŠåˆ é™¤å®Œæˆ ===")
            Toast.makeText(this, "âœ… ç¾¤èŠ ${contact.name} å·²åˆ é™¤", Toast.LENGTH_SHORT).show()

        } catch (e: Exception) {
            Log.e(TAG, "ç§»é™¤ç¾¤èŠé…ç½®å¤±è´¥", e)
            Toast.makeText(this, "âŒ åˆ é™¤ç¾¤èŠå¤±è´¥: ${e.message}", Toast.LENGTH_SHORT).show()
        }
    }

    /**
     * ä»è”ç³»äººåˆ—è¡¨ä¸­åˆ é™¤è”ç³»äºº
     */
    private fun removeContactFromList(contact: ChatContact) {
        try {
            // æ‰¾åˆ°è”ç³»äººæ‰€åœ¨çš„åˆ†ç±»
            val categoryIndex = allContacts.indexOfFirst { category ->
                category.contacts.any { it.id == contact.id }
            }

            if (categoryIndex != -1) {
                val category = allContacts[categoryIndex]
                val updatedContacts = category.contacts.filter { it.id != contact.id }

                if (updatedContacts.isEmpty()) {
                    // å¦‚æœåˆ†ç±»ä¸­æ²¡æœ‰è”ç³»äººäº†ï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦åˆ é™¤åˆ†ç»„æ ‡ç­¾é¡µ
                    if (category.name != "AIåŠ©æ‰‹" &&
                        category.name != "å…¨éƒ¨" &&
                        category.name != "æœªåˆ†ç»„") {
                        removeEmptyGroupTab(category.name)
                    }
                    // åˆ é™¤æ•´ä¸ªåˆ†ç±»
                    allContacts.removeAt(categoryIndex)
                } else {
                    // æ›´æ–°åˆ†ç±»ä¸­çš„è”ç³»äººåˆ—è¡¨
                    allContacts[categoryIndex] = category.copy(contacts = updatedContacts.toMutableList())
                }

                // ä¿å­˜æ›´æ–°åçš„è”ç³»äººæ•°æ®
                saveContacts()

                // åˆ·æ–°æ˜¾ç¤ºï¼ˆä¸åˆ‡æ¢åˆ°"å…¨éƒ¨"æ ‡ç­¾é¡µï¼Œé¿å…å¼¹çª—ï¼‰
                refreshCurrentTabDisplay()

                // æ›´æ–°é€‚é…å™¨
                chatContactAdapter?.updateContacts(allContacts)
            }
        } catch (e: Exception) {
            Log.e(TAG, "ä»åˆ—è¡¨ä¸­åˆ é™¤è”ç³»äººå¤±è´¥", e)
        }
    }

    /**
     * å¤„ç†Activityç»“æœ
     */
    override fun onActivityResult(requestCode: Int, resultCode: Int, data: Intent?) {
        super.onActivityResult(requestCode, resultCode, data)

        when (requestCode) {
            REQUEST_CODE_ADD_AI_CONTACT -> {
                // ä»AIè”ç³»äººåˆ—è¡¨ç•Œé¢è¿”å›
                if (resultCode == Activity.RESULT_OK && data != null) {
                    val aiContact = data.getParcelableExtra<ChatContact>("extra_ai_contact")
                    if (aiContact != null) {
                        // æ·»åŠ AIè”ç³»äººåˆ°å¯¹è¯åˆ—è¡¨
                        addAIContactToCategory(aiContact.name, aiContact.description ?: "AIåŠ©æ‰‹")
                        // åˆ·æ–°è”ç³»äººåˆ—è¡¨æ˜¾ç¤º
                        refreshChatContactsList()
                        Toast.makeText(this, "å·²æ·»åŠ  ${aiContact.name} åˆ°å¯¹è¯åˆ—è¡¨", Toast.LENGTH_SHORT).show()
                        Log.d(TAG, "æˆåŠŸæ·»åŠ AIè”ç³»äºº: ${aiContact.name}")
                    } else {
                        Toast.makeText(this, "AIè”ç³»äººæ•°æ®æ— æ•ˆ", Toast.LENGTH_SHORT).show()
                    }
                } else {
                    Log.d(TAG, "ç”¨æˆ·å–æ¶ˆäº†AIè”ç³»äººé€‰æ‹©")
                }
            }
            
            REQUEST_CODE_PICK_FILE -> {
                // æ–‡ä»¶é€‰æ‹©ç»“æœ
                if (resultCode == Activity.RESULT_OK && data != null) {
                    val uri = data.data
                    if (uri != null) {
                        try {
                            // è·å–æ–‡ä»¶å
                            val fileName = getFileNameFromUri(uri)
                            Log.d(TAG, "ç”¨æˆ·é€‰æ‹©æ–‡ä»¶: $fileName, URI: $uri")
                            
                            // å¯åŠ¨æ–‡ä»¶é˜…è¯»å™¨
                            com.example.aifloatingball.viewer.FileReaderActivity.start(this, uri, fileName)
                            
                            Toast.makeText(this, "æ­£åœ¨æ‰“å¼€æ–‡ä»¶: $fileName", Toast.LENGTH_SHORT).show()
                        } catch (e: Exception) {
                            Log.e(TAG, "æ‰“å¼€æ–‡ä»¶å¤±è´¥", e)
                            Toast.makeText(this, "æ‰“å¼€æ–‡ä»¶å¤±è´¥: ${e.message}", Toast.LENGTH_SHORT).show()
                        }
                    } else {
                        Log.w(TAG, "æ–‡ä»¶URIä¸ºç©º")
                        Toast.makeText(this, "æœªé€‰æ‹©æ–‡ä»¶", Toast.LENGTH_SHORT).show()
                    }
                } else {
                    Log.d(TAG, "ç”¨æˆ·å–æ¶ˆäº†æ–‡ä»¶é€‰æ‹©")
                }
            }
        }
    }

    /**
     * æ‰“å¼€æ–‡ä»¶é€‰æ‹©å™¨
     */
    private fun openFilePicker() {
        try {
            // æ”¯æŒçš„æ–‡ä»¶ç±»å‹ï¼štxtã€pdfã€epubã€mobiã€azwã€azw3ã€azw4ã€prcã€pdb
            val mimeTypes = arrayOf(
                "text/plain",           // txt
                "application/pdf",      // pdf
                "application/epub+zip",  // epub
                "application/x-mobipocket-ebook", // mobi
                "application/vnd.amazon.ebook",  // azw, azw3, azw4
                "application/x-palm-database",    // prc, pdb
                "*/*"  // å…è®¸é€‰æ‹©æ‰€æœ‰æ–‡ä»¶ç±»å‹
            )
            
            val intent = Intent(Intent.ACTION_GET_CONTENT).apply {
                type = "*/*"
                putExtra(Intent.EXTRA_MIME_TYPES, mimeTypes)
                addCategory(Intent.CATEGORY_OPENABLE)
                // å…è®¸é€‰æ‹©å¤šä¸ªæ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
                // putExtra(Intent.EXTRA_ALLOW_MULTIPLE, true)
            }
            
            // å¦‚æœç³»ç»Ÿæœ‰æ–‡ä»¶ç®¡ç†å™¨ï¼Œä½¿ç”¨æ–‡ä»¶ç®¡ç†å™¨
            val chooserIntent = Intent.createChooser(intent, "é€‰æ‹©æ–‡ä»¶")
            
            try {
                startActivityForResult(chooserIntent, REQUEST_CODE_PICK_FILE)
                Log.d(TAG, "æˆåŠŸæ‰“å¼€æ–‡ä»¶é€‰æ‹©å™¨")
            } catch (e: ActivityNotFoundException) {
                Log.e(TAG, "æœªæ‰¾åˆ°æ–‡ä»¶é€‰æ‹©å™¨åº”ç”¨", e)
                Toast.makeText(this, "æœªæ‰¾åˆ°æ–‡ä»¶é€‰æ‹©å™¨åº”ç”¨", Toast.LENGTH_SHORT).show()
            }
        } catch (e: Exception) {
            Log.e(TAG, "æ‰“å¼€æ–‡ä»¶é€‰æ‹©å™¨å¤±è´¥", e)
            Toast.makeText(this, "æ‰“å¼€æ–‡ä»¶é€‰æ‹©å™¨å¤±è´¥: ${e.message}", Toast.LENGTH_SHORT).show()
        }
    }
    
    /**
     * ä»URIè·å–æ–‡ä»¶å
     */
    private fun getFileNameFromUri(uri: Uri): String {
        var fileName = "æœªçŸ¥æ–‡ä»¶"
        
        try {
            when (uri.scheme) {
                "file" -> {
                    val path = uri.path ?: ""
                    fileName = File(path).name
                }
                "content" -> {
                    // ä»ContentResolverè·å–æ–‡ä»¶å
                    contentResolver.query(uri, null, null, null, null)?.use { cursor ->
                        val nameIndex = cursor.getColumnIndex(android.provider.OpenableColumns.DISPLAY_NAME)
                        if (cursor.moveToFirst() && nameIndex >= 0) {
                            fileName = cursor.getString(nameIndex)
                        } else {
                            // å¦‚æœæ— æ³•è·å–ï¼Œå°è¯•ä»URIè·¯å¾„è·å–
                            fileName = uri.lastPathSegment ?: "æœªçŸ¥æ–‡ä»¶"
                        }
                    } ?: run {
                        // å¦‚æœæŸ¥è¯¢å¤±è´¥ï¼Œå°è¯•ä»URIè·¯å¾„è·å–
                        fileName = uri.lastPathSegment ?: "æœªçŸ¥æ–‡ä»¶"
                    }
                }
                else -> {
                    fileName = uri.lastPathSegment ?: "æœªçŸ¥æ–‡ä»¶"
                }
            }
        } catch (e: Exception) {
            Log.e(TAG, "è·å–æ–‡ä»¶åå¤±è´¥", e)
            fileName = uri.lastPathSegment ?: "æœªçŸ¥æ–‡ä»¶"
        }
        
        return fileName
    }

    /**
     * åˆ·æ–°å¯¹è¯è”ç³»äººåˆ—è¡¨
     */
    private fun refreshChatContactsList() {
        try {
            // é‡æ–°ä»å­˜å‚¨ä¸­åŠ è½½æ‰€æœ‰è”ç³»äººæ•°æ®ï¼ˆåŒ…æ‹¬AIå’Œç¾¤èŠï¼‰
            val savedContacts = loadSavedContacts()
            if (savedContacts.isNotEmpty()) {
                allContacts = savedContacts.toMutableList()
                Log.d(TAG, "ä»å­˜å‚¨ä¸­é‡æ–°åŠ è½½äº† ${savedContacts.size} ä¸ªè”ç³»äººåˆ†ç±»")
            }
            
            // ç¡®ä¿ä¸´æ—¶ä¸“çº¿å§‹ç»ˆå­˜åœ¨äºè”ç³»äººåˆ—è¡¨ä¸­
            ensureTempServiceInContacts()
            
            // é‡æ–°åŠ è½½ç¾¤èŠæ•°æ®å¹¶æ·»åŠ åˆ°è”ç³»äººåˆ—è¡¨
            try {
                val groupChats = unifiedGroupChatManager.getAllGroupChats()
                if (groupChats.isNotEmpty()) {
                    // å°†GroupChatè½¬æ¢ä¸ºChatContact
                    val groupChatContacts = groupChats.map { groupChat ->
                        ChatContact(
                            id = groupChat.id,
                            name = groupChat.name,
                            avatar = groupChat.avatar,
                            type = ContactType.GROUP,
                            description = groupChat.description,
                            isOnline = true,
                            lastMessage = groupChat.lastMessage,
                            lastMessageTime = groupChat.lastMessageTime,
                            unreadCount = groupChat.unreadCount,
                            isPinned = groupChat.isPinned,
                            isMuted = groupChat.isMuted,
                            groupId = groupChat.id,
                            memberCount = groupChat.members.size,
                            aiMembers = groupChat.members.filter { it.type == MemberType.AI }.map { it.name }
                        )
                    }
                    
                    // æ¸…é™¤ç°æœ‰çš„ç¾¤èŠè”ç³»äººï¼Œé¿å…é‡å¤
                    for (i in allContacts.indices) {
                        val category = allContacts[i]
                        val updatedContacts = category.contacts.filter { it.type != ContactType.GROUP }.toMutableList()
                        allContacts[i] = category.copy(contacts = updatedContacts)
                    }
                    
                    // ç¡®ä¿æœ‰"å…¨éƒ¨"åˆ†ç±»æ¥å­˜æ”¾ç¾¤èŠ
                    val allCategoryIndex = allContacts.indexOfFirst { it.name == "å…¨éƒ¨" }
                    if (allCategoryIndex != -1) {
                        val allCategory = allContacts[allCategoryIndex]
                        val updatedContacts = allCategory.contacts.toMutableList()
                        updatedContacts.addAll(groupChatContacts)
                        
                        // é‡æ–°æ’åº
                        val sortedContacts = updatedContacts.sortedWith(
                            compareByDescending<ChatContact> { it.isPinned }
                                .thenByDescending { it.lastMessageTime }
                        ).toMutableList()
                        
                        allContacts[allCategoryIndex] = allCategory.copy(contacts = sortedContacts)
                    } else {
                        // å¦‚æœ"å…¨éƒ¨"åˆ†ç±»ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°åˆ†ç±»
                        allContacts.add(0, ContactCategory("å…¨éƒ¨", groupChatContacts.toMutableList()))
                    }
                    Log.d(TAG, "é‡æ–°åŠ è½½äº† ${groupChats.size} ä¸ªç¾¤èŠåˆ°'å…¨éƒ¨'åˆ†ç±»ä¸­")
                }
            } catch (e: Exception) {
                Log.e(TAG, "é‡æ–°åŠ è½½ç¾¤èŠæ•°æ®å¤±è´¥", e)
            }
            
            // æ˜¾ç¤ºæ‰€æœ‰è”ç³»äººï¼ˆAIå’Œç¾¤èŠï¼‰
            showAllUserAIContacts()
            
            // é€šçŸ¥é€‚é…å™¨æ•°æ®å·²æ›´æ”¹
            chatContactAdapter?.updateContacts(allContacts)
            
            Log.d(TAG, "å·²åˆ·æ–°å¯¹è¯è”ç³»äººåˆ—è¡¨")
        } catch (e: Exception) {
            Log.e(TAG, "åˆ·æ–°å¯¹è¯è”ç³»äººåˆ—è¡¨å¤±è´¥", e)
        }
    }

    /**
     * ä¿å­˜è”ç³»äººæ•°æ®åˆ°SharedPreferences
     */
    private fun saveContacts() {
        try {
            val prefs = getSharedPreferences(CONTACTS_PREFS_NAME, MODE_PRIVATE)
            val gson = Gson()
            val json = gson.toJson(allContacts)
            prefs.edit().putString(KEY_SAVED_CONTACTS, json).apply()
            Log.d(TAG, "è”ç³»äººæ•°æ®å·²ä¿å­˜")
        } catch (e: Exception) {
            Log.e(TAG, "ä¿å­˜è”ç³»äººæ•°æ®å¤±è´¥", e)
        }
    }

    /**
     * ä»SharedPreferencesåŠ è½½è”ç³»äººæ•°æ®
     */
    private fun loadSavedContacts(): List<ContactCategory> {
        return try {
            val prefs = getSharedPreferences(CONTACTS_PREFS_NAME, MODE_PRIVATE)
            val json = prefs.getString(KEY_SAVED_CONTACTS, null)
            if (json != null) {
                val gson = Gson()
                val type = object : TypeToken<List<ContactCategory>>() {}.type
                gson.fromJson(json, type) ?: emptyList()
            } else {
                emptyList()
            }
        } catch (e: Exception) {
            Log.e(TAG, "åŠ è½½ä¿å­˜çš„è”ç³»äººæ•°æ®å¤±è´¥", e)
            emptyList()
        }
    }

    /**
     * ç¡®ä¿ä¸´æ—¶ä¸“çº¿å§‹ç»ˆå­˜åœ¨äºè”ç³»äººåˆ—è¡¨ä¸­
     */
    private fun ensureTempServiceInContacts() {
        try {
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ä¸´æ—¶ä¸“çº¿
            val tempServiceExists = allContacts.any { category ->
                category.contacts.any { contact ->
                    contact.name == "ä¸´æ—¶ä¸“çº¿" && contact.type == ContactType.AI
                }
            }
            
            if (!tempServiceExists) {
                Log.d(TAG, "ä¸´æ—¶ä¸“çº¿ä¸å­˜åœ¨äºè”ç³»äººåˆ—è¡¨ä¸­ï¼Œæ­£åœ¨æ·»åŠ ...")
                
                // åˆ›å»ºä¸´æ—¶ä¸“çº¿è”ç³»äºº
                val tempServiceContact = ChatContact(
                    id = "ai_ä¸´æ—¶ä¸“çº¿",
                    name = "ä¸´æ—¶ä¸“çº¿",
                    type = ContactType.AI,
                    description = "å…è´¹AIæœåŠ¡ (æ— éœ€APIå¯†é’¥)",
                    isOnline = true,
                    lastMessage = "ä½ å¥½ï¼æˆ‘æ˜¯ä¸´æ—¶ä¸“çº¿ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ",
                    lastMessageTime = System.currentTimeMillis(),
                    unreadCount = 0,
                    isPinned = true, // ç½®é¡¶æ˜¾ç¤º
                    customData = mapOf(
                        "api_url" to getDefaultApiUrl("ä¸´æ—¶ä¸“çº¿"),
                        "api_key" to "",
                        "model" to getDefaultModel("ä¸´æ—¶ä¸“çº¿"),
                        "is_temp_service" to "true"
                    ),
                    aiMembers = emptyList()
                )
                
                // æ·»åŠ åˆ°"å…¨éƒ¨"åˆ†ç±»æˆ–åˆ›å»ºæ–°åˆ†ç±»
                val allCategoryIndex = allContacts.indexOfFirst { it.name == "å…¨éƒ¨" || it.name == "å…¨éƒ¨è”ç³»äºº" }
                if (allCategoryIndex != -1) {
                    // æ·»åŠ åˆ°ç°æœ‰åˆ†ç±»
                    val category = allContacts[allCategoryIndex]
                    val updatedContacts = category.contacts.toMutableList()
                    updatedContacts.add(0, tempServiceContact) // æ·»åŠ åˆ°é¡¶éƒ¨
                    allContacts[allCategoryIndex] = category.copy(contacts = updatedContacts)
                    Log.d(TAG, "ä¸´æ—¶ä¸“çº¿å·²æ·»åŠ åˆ°ç°æœ‰åˆ†ç±»")
                } else {
                    // åˆ›å»ºæ–°åˆ†ç±»
                    allContacts.add(0, ContactCategory("å…¨éƒ¨", mutableListOf(tempServiceContact)))
                    Log.d(TAG, "ä¸´æ—¶ä¸“çº¿å·²æ·»åŠ åˆ°æ–°åˆ›å»ºçš„åˆ†ç±»")
                }
                
                // ä¿å­˜æ›´æ–°åçš„è”ç³»äººæ•°æ®
                saveContacts()
            } else {
                Log.d(TAG, "ä¸´æ—¶ä¸“çº¿å·²å­˜åœ¨äºè”ç³»äººåˆ—è¡¨ä¸­")
            }
        } catch (e: Exception) {
            Log.e(TAG, "ç¡®ä¿ä¸´æ—¶ä¸“çº¿å­˜åœ¨äºè”ç³»äººåˆ—è¡¨ä¸­å¤±è´¥", e)
        }
    }

    /**
     * æ·»åŠ è”ç³»äººåˆ°åˆ—è¡¨
     */
    private fun addContactToList(contact: ChatContact) {
        try {
            val categoryName = when (contact.type) {
                ContactType.AI -> "AIåŠ©æ‰‹"
                ContactType.GROUP -> "å…¨éƒ¨"  // ç¾¤èŠè”ç³»äººæ·»åŠ åˆ°"å…¨éƒ¨"åˆ†ç»„
            }

            // æŸ¥æ‰¾æˆ–åˆ›å»ºå¯¹åº”çš„åˆ†ç±»
            val categoryIndex = allContacts.indexOfFirst { it.name == categoryName }

            if (categoryIndex != -1) {
                // åˆ†ç±»å·²å­˜åœ¨ï¼Œæ·»åŠ è”ç³»äººåˆ°ç°æœ‰åˆ†ç±»
                val category = allContacts[categoryIndex]
                val updatedContacts = category.contacts.toMutableList()

                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒIDçš„è”ç³»äºº
                val existingIndex = updatedContacts.indexOfFirst { it.id == contact.id }
                if (existingIndex != -1) {
                    // å¦‚æœå·²å­˜åœ¨ï¼Œæ›´æ–°è”ç³»äººä¿¡æ¯
                    updatedContacts[existingIndex] = contact
                } else {
                    // å¦‚æœä¸å­˜åœ¨ï¼Œæ·»åŠ æ–°è”ç³»äºº
                    updatedContacts.add(contact)
                }

                // é‡æ–°æ’åºï¼šç½®é¡¶çš„è”ç³»äººåœ¨å‰é¢ï¼Œç„¶åæŒ‰æœ€åæ¶ˆæ¯æ—¶é—´æ’åº
                val sortedContacts = updatedContacts.sortedWith(
                    compareByDescending<ChatContact> { it.isPinned }
                        .thenByDescending { it.lastMessageTime }
                ).toMutableList()

                allContacts[categoryIndex] = category.copy(contacts = sortedContacts)
            } else {
                // åˆ†ç±»ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°åˆ†ç±»
                val newCategory = ContactCategory(categoryName, mutableListOf(contact))
                allContacts.add(newCategory)
            }

            // ä¿å­˜æ›´æ–°åçš„è”ç³»äººæ•°æ®
            saveContacts()

            // æ›´æ–°é€‚é…å™¨
            chatContactAdapter?.updateContacts(allContacts)

            Toast.makeText(this, "å·²æ·»åŠ  ${contact.name}", Toast.LENGTH_SHORT).show()
            Log.d(TAG, "æ·»åŠ è”ç³»äººåˆ°åˆ—è¡¨: ${contact.name}")
        } catch (e: Exception) {
            Log.e(TAG, "æ·»åŠ è”ç³»äººåˆ°åˆ—è¡¨å¤±è´¥", e)
        }
    }

    /**
     * è®¾ç½®æ·»åŠ AIè”ç³»äººå¹¿æ’­æ¥æ”¶å™¨
     */
    private fun setupAddAIContactReceiver() {
        try {
            addAIContactReceiver = object : BroadcastReceiver() {
                override fun onReceive(context: Context?, intent: Intent?) {
                    try {
                        when (intent?.action) {
                            "com.example.aifloatingball.ADD_AI_CONTACT" -> {
                                val aiName = intent.getStringExtra("ai_name") ?: return
                                val aiDisplayName = intent.getStringExtra("ai_display_name") ?: aiName
                                val aiDescription = intent.getStringExtra("ai_description") ?: ""

                                // æ·»åŠ AIè”ç³»äººåˆ°åˆ—è¡¨
                                addAIContactToCategory(aiName, aiDisplayName, getApiKeyForAI(aiName))

                                // æ ‡è®°AIä¸ºå·²é…ç½®
                                markAIAsConfigured(aiName)

                                // åˆ·æ–°UI
                                chatContactAdapter?.updateContacts(allContacts)

                                Toast.makeText(context, "âœ… ${aiDisplayName} å·²æ·»åŠ åˆ°å¯¹è¯åˆ—è¡¨", Toast.LENGTH_SHORT).show()
                            }
                            "com.example.aifloatingball.OPEN_AI_CHAT" -> {
                                val aiName = intent.getStringExtra("ai_name") ?: return

                                // æ‰¾åˆ°å¯¹åº”çš„AIè”ç³»äººå¹¶æ‰“å¼€å¯¹è¯
                                val aiContact = findAIContactByName(aiName)
                                if (aiContact != null) {
                                    val chatIntent = Intent(this@SimpleModeActivity, ChatActivity::class.java).apply {
                                        putExtra(ChatActivity.EXTRA_CONTACT, aiContact)
                                    }
                                    startActivity(chatIntent)
                                }
                            }
                        }
                    } catch (e: Exception) {
                        Log.e(TAG, "å¤„ç†æ·»åŠ AIè”ç³»äººå¹¿æ’­å¤±è´¥", e)
                    }
                }
            }

            val filter = IntentFilter().apply {
                addAction("com.example.aifloatingball.ADD_AI_CONTACT")
                addAction("com.example.aifloatingball.OPEN_AI_CHAT")
            }
            if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.TIRAMISU) {
                registerReceiver(addAIContactReceiver, filter, Context.RECEIVER_NOT_EXPORTED)
            } else {
                registerReceiver(addAIContactReceiver, filter)
            }

        } catch (e: Exception) {
            Log.e(TAG, "è®¾ç½®æ·»åŠ AIè”ç³»äººæ¥æ”¶å™¨å¤±è´¥", e)
        }
    }

    /**
     * æ ¹æ®åç§°æŸ¥æ‰¾AIè”ç³»äºº
     */
    private fun findAIContactByName(aiName: String): ChatContact? {
        return try {
            allContacts.forEach { category ->
                category.contacts.forEach { contact ->
                    if (contact.name.equals(aiName, ignoreCase = true) ||
                        contact.name.contains(aiName, ignoreCase = true)) {
                        return contact
                    }
                }
            }
            null
        } catch (e: Exception) {
            Log.e(TAG, "æŸ¥æ‰¾AIè”ç³»äººå¤±è´¥", e)
            null
        }
    }

    /**
     * æ ‡è®°AIä¸ºå·²é…ç½®
     */
    private fun markAIAsConfigured(aiName: String) {
        try {
            val configuredAIs = settingsManager.getString("configured_ais", "") ?: ""
            val aiList = configuredAIs.split(",").toMutableSet()
            aiList.add(aiName)
            settingsManager.putString("configured_ais", aiList.filter { it.isNotBlank() }.joinToString(","))
        } catch (e: Exception) {
            Log.e(TAG, "æ ‡è®°AIä¸ºå·²é…ç½®å¤±è´¥", e)
        }
    }

    /**
     * ç§»é™¤AIé…ç½®æ ‡è®°
     */
    private fun unmarkAIAsConfigured(aiName: String) {
        try {
            val configuredAIs = settingsManager.getString("configured_ais", "") ?: ""
            val aiList = configuredAIs.split(",").toMutableSet()
            aiList.remove(aiName)
            settingsManager.putString("configured_ais", aiList.filter { it.isNotBlank() }.joinToString(","))
        } catch (e: Exception) {
            Log.e(TAG, "ç§»é™¤AIé…ç½®æ ‡è®°å¤±è´¥", e)
        }
    }

    /**
     * æ ¹æ®è”ç³»äººä¿¡æ¯è·å–AIæœåŠ¡ç±»å‹
     */
    private fun getAIServiceType(contact: ChatContact): AIServiceType? {
        return when (contact.name.lowercase()) {
            "ä¸´æ—¶ä¸“çº¿", "tempservice", "temp_service" -> AIServiceType.TEMP_SERVICE
            "chatgpt", "gpt" -> AIServiceType.CHATGPT
            "claude" -> AIServiceType.CLAUDE
            "gemini" -> AIServiceType.GEMINI
            "æ–‡å¿ƒä¸€è¨€", "wenxin" -> AIServiceType.WENXIN
            "deepseek" -> AIServiceType.DEEPSEEK
            "é€šä¹‰åƒé—®", "qianwen" -> AIServiceType.QIANWEN
            "è®¯é£æ˜Ÿç«", "xinghuo" -> AIServiceType.XINGHUO
            "kimi" -> AIServiceType.KIMI
            "æ™ºè°±ai", "æ™ºè°±æ¸…è¨€", "zhipu", "glm" -> AIServiceType.ZHIPU_AI
            else -> null
        }
    }

    /**
     * è·å–æŒ‡å®šæœåŠ¡çš„APIå¯†é’¥
     */
    private fun getApiKeyForService(serviceType: AIServiceType): String {
        val settingsManager = SettingsManager.getInstance(this)
        return when (serviceType) {
            AIServiceType.CHATGPT -> settingsManager.getString("chatgpt_api_key", "") ?: ""
            AIServiceType.CLAUDE -> settingsManager.getString("claude_api_key", "") ?: ""
            AIServiceType.GEMINI -> settingsManager.getGeminiApiKey()
            AIServiceType.WENXIN -> settingsManager.getWenxinApiKey()
            AIServiceType.DEEPSEEK -> settingsManager.getDeepSeekApiKey()
            AIServiceType.QIANWEN -> settingsManager.getQianwenApiKey()
            AIServiceType.XINGHUO -> settingsManager.getString("xinghuo_api_key", "") ?: ""
            AIServiceType.KIMI -> settingsManager.getKimiApiKey()
            AIServiceType.ZHIPU_AI -> settingsManager.getString("zhipu_ai_api_key", "") ?: ""
            AIServiceType.DOUBAO -> settingsManager.getDoubaoApiKey()
            AIServiceType.TEMP_SERVICE -> "" // ä¸´æ—¶ä¸“çº¿ä¸éœ€è¦APIå¯†é’¥
        }
    }

    /**
     * å‘é€æ¶ˆæ¯åˆ°AIæœåŠ¡ï¼ˆå¼‚æ­¥ç‰ˆæœ¬ï¼‰
     */
    private suspend fun sendMessageToAI(
        serviceType: AIServiceType,
        message: String,
        conversationHistory: List<Map<String, String>>,
        apiKey: String
    ): String {
        return withContext(Dispatchers.IO) {
            try {
                // åˆ›å»ºAI APIç®¡ç†å™¨
                val aiApiManager = AIApiManager(this@SimpleModeActivity)

                // ä½¿ç”¨åç¨‹å’ŒCompletableDeferredæ¥å¼‚æ­¥ç­‰å¾…ç»“æœ
                val deferred = CompletableDeferred<String>()

                aiApiManager.sendMessage(
                    serviceType = serviceType,
                    message = message,
                    conversationHistory = conversationHistory,
                    callback = object : AIApiManager.StreamingCallback {
                        override fun onChunkReceived(chunk: String) {
                            // æµå¼å“åº”å¤„ç†
                        }

                        override fun onComplete(fullResponse: String) {
                            deferred.complete(fullResponse)
                        }

                        override fun onError(error: String) {
                            deferred.complete("æŠ±æ­‰ï¼Œå‘ç”Ÿäº†é”™è¯¯ï¼š$error")
                        }
                    }
                )

                // ä½¿ç”¨withTimeoutæ¥è®¾ç½®è¶…æ—¶ï¼Œé¿å…æ— é™ç­‰å¾…
                try {
                    withTimeout(10000) { // 10ç§’è¶…æ—¶
                        deferred.await()
                    }
                } catch (e: TimeoutCancellationException) {
                    "æŠ±æ­‰ï¼Œè¯·æ±‚è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•"
                }

            } catch (e: Exception) {
                Log.e(TAG, "å‘é€æ¶ˆæ¯åˆ°AIå¤±è´¥", e)
                "æŠ±æ­‰ï¼Œå‘ç”Ÿäº†é”™è¯¯ï¼š${e.message}"
            }
        }
    }

    /**
     * æ˜¾ç¤ºMaterial Designé£æ ¼çš„è‡ªå®šä¹‰æ ‡ç­¾é¡µå¯¹è¯æ¡†
     */
    private fun showCustomTabDialog() {
        try {
            // åˆ›å»ºå¯¹è¯æ¡†å¸ƒå±€
            val dialogView = layoutInflater.inflate(R.layout.dialog_custom_tab_material, null)
            val inputLayout = dialogView.findViewById<com.google.android.material.textfield.TextInputLayout>(R.id.tab_name_input_layout)
            val input = dialogView.findViewById<com.google.android.material.textfield.TextInputEditText>(R.id.tab_name_input)
            val chipGroup = dialogView.findViewById<com.google.android.material.chip.ChipGroup>(R.id.suggested_tags_group)
            val btnCancel = dialogView.findViewById<com.google.android.material.button.MaterialButton>(R.id.btn_cancel)
            val btnCreate = dialogView.findViewById<com.google.android.material.button.MaterialButton>(R.id.btn_create)

            // è®¾ç½®é»˜è®¤å€¼
            input.setText("AIåˆ†ç»„")
            input.selectAll()

            // è®¾ç½®å»ºè®®æ ‡ç­¾ç‚¹å‡»äº‹ä»¶
            val chipWork = dialogView.findViewById<com.google.android.material.chip.Chip>(R.id.chip_work)
            val chipStudy = dialogView.findViewById<com.google.android.material.chip.Chip>(R.id.chip_study)
            val chipCreative = dialogView.findViewById<com.google.android.material.chip.Chip>(R.id.chip_creative)
            val chipLife = dialogView.findViewById<com.google.android.material.chip.Chip>(R.id.chip_life)

            chipWork.setOnClickListener { input.setText("å·¥ä½œåŠ©æ‰‹") }
            chipStudy.setOnClickListener { input.setText("å­¦ä¹ åŠ©æ‰‹") }
            chipCreative.setOnClickListener { input.setText("åˆ›ä½œåŠ©æ‰‹") }
            chipLife.setOnClickListener { input.setText("ç”Ÿæ´»åŠ©æ‰‹") }

            // è¾“å…¥éªŒè¯
            input.addTextChangedListener(object : android.text.TextWatcher {
                override fun beforeTextChanged(s: CharSequence?, start: Int, count: Int, after: Int) {}
                override fun onTextChanged(s: CharSequence?, start: Int, before: Int, count: Int) {}
                override fun afterTextChanged(s: android.text.Editable?) {
                    val text = s?.toString()?.trim() ?: ""
                    when {
                        text.isEmpty() -> {
                            inputLayout.error = "è¯·è¾“å…¥æ ‡ç­¾é¡µåç§°"
                            btnCreate.isEnabled = false
                        }
                        text.length > 10 -> {
                            inputLayout.error = "æ ‡ç­¾é¡µåç§°ä¸èƒ½è¶…è¿‡10ä¸ªå­—ç¬¦"
                            btnCreate.isEnabled = false
                        }
                        else -> {
                            inputLayout.error = null
                            btnCreate.isEnabled = true
                        }
                    }
                }
            })

            // åˆ›å»ºå¯¹è¯æ¡†
            val dialog = androidx.appcompat.app.AlertDialog.Builder(this, R.style.Theme_MaterialDialog)
                .setView(dialogView)
                .setCancelable(true)
                .create()

            // è®¾ç½®æŒ‰é’®äº‹ä»¶
            btnCancel.setOnClickListener { dialog.dismiss() }

            btnCreate.setOnClickListener {
                val tabName = input.text.toString().trim()
                if (tabName.isNotEmpty() && tabName.length <= 10) {
                    createCustomTab(tabName)
                    dialog.dismiss()
                }
            }

            dialog.show()

            // è‡ªåŠ¨å¼¹å‡ºé”®ç›˜
            input.requestFocus()
            val imm = getSystemService(android.content.Context.INPUT_METHOD_SERVICE) as android.view.inputmethod.InputMethodManager
            imm.showSoftInput(input, android.view.inputmethod.InputMethodManager.SHOW_IMPLICIT)

        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºè‡ªå®šä¹‰æ ‡ç­¾é¡µå¯¹è¯æ¡†å¤±è´¥", e)
        }
    }



    /**
     * æ˜¾ç¤ºç¼–è¾‘è‡ªå®šä¹‰æ ‡ç­¾é¡µå¯¹è¯æ¡†
     */
    private fun showEditCustomTabDialog(tab: com.google.android.material.tabs.TabLayout.Tab) {
        try {
            val currentName = tab.text.toString()
            val input = EditText(this).apply {
                hint = "è¾“å…¥æ–°çš„æ ‡ç­¾é¡µåç§°"
                setText(currentName)
            }

            AlertDialog.Builder(this)
                .setTitle("ç¼–è¾‘æ ‡ç­¾é¡µ")
                .setView(input)
                .setPositiveButton("ä¿å­˜") { _, _ ->
                    val newName = input.text.toString().trim()
                    if (newName.isNotEmpty() && newName != currentName) {
                        editCustomTab(tab, newName)
                    }
                }
                .setNegativeButton("åˆ é™¤") { _, _ ->
                    deleteCustomTab(tab)
                }
                .setNeutralButton("å–æ¶ˆ", null)
                .show()
        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºç¼–è¾‘è‡ªå®šä¹‰æ ‡ç­¾é¡µå¯¹è¯æ¡†å¤±è´¥", e)
        }
    }

    /**
     * ç¼–è¾‘è‡ªå®šä¹‰æ ‡ç­¾é¡µ
     */
    private fun editCustomTab(tab: com.google.android.material.tabs.TabLayout.Tab, newName: String) {
        try {
            tab.text = newName
            updateCustomTabName(tab.position, newName)
            Toast.makeText(this, "æ ‡ç­¾é¡µå·²é‡å‘½å", Toast.LENGTH_SHORT).show()
        } catch (e: Exception) {
            Log.e(TAG, "ç¼–è¾‘è‡ªå®šä¹‰æ ‡ç­¾é¡µå¤±è´¥", e)
        }
    }

    /**
     * åˆ é™¤è‡ªå®šä¹‰æ ‡ç­¾é¡µ
     */
    private fun deleteCustomTab(tab: com.google.android.material.tabs.TabLayout.Tab) {
        try {
            val chatTabLayout = findViewById<com.google.android.material.tabs.TabLayout>(R.id.chat_tab_layout)
            chatTabLayout?.removeTab(tab)
            removeCustomTab(tab.position)
            Toast.makeText(this, "æ ‡ç­¾é¡µå·²åˆ é™¤", Toast.LENGTH_SHORT).show()
        } catch (e: Exception) {
            Log.e(TAG, "åˆ é™¤è‡ªå®šä¹‰æ ‡ç­¾é¡µå¤±è´¥", e)
        }
    }

    /**
     * æ˜¾ç¤ºè‡ªå®šä¹‰æ ‡ç­¾é¡µä¸­çš„AIè”ç³»äºº
     */
    private fun showCustomAIContacts(tabName: String) {
        try {
            // è·å–è¯¥æ ‡ç­¾é¡µä¸­é…ç½®çš„AIè”ç³»äºº
            val customAIContacts = getCustomTabAIContacts(tabName)
            chatContactAdapter?.updateContacts(customAIContacts)
            Log.d(TAG, "æ˜¾ç¤ºè‡ªå®šä¹‰æ ‡ç­¾é¡µ $tabName ä¸­çš„AIè”ç³»äººï¼Œæ•°é‡: ${customAIContacts.size}")
        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºè‡ªå®šä¹‰æ ‡ç­¾é¡µAIè”ç³»äººå¤±è´¥", e)
        }
    }

    /**
     * ä¿å­˜è‡ªå®šä¹‰æ ‡ç­¾é¡µä¿¡æ¯
     */
    private fun saveCustomTab(tabName: String) {
        try {
            val settingsManager = SettingsManager.getInstance(this)
            val customTabs = settingsManager.getString("custom_ai_tabs", "") ?: ""
            val tabList = if (customTabs.isNotEmpty()) {
                customTabs.split(",").toMutableList()
            } else {
                mutableListOf()
            }

            if (!tabList.contains(tabName)) {
                tabList.add(tabName)
                settingsManager.putString("custom_ai_tabs", tabList.joinToString(","))
            }
        } catch (e: Exception) {
            Log.e(TAG, "ä¿å­˜è‡ªå®šä¹‰æ ‡ç­¾é¡µå¤±è´¥", e)
        }
    }

    /**
     * æ›´æ–°è‡ªå®šä¹‰æ ‡ç­¾é¡µåç§°
     */
    private fun updateCustomTabName(tabPosition: Int, newName: String) {
        try {
            val settingsManager = SettingsManager.getInstance(this)
            val customTabs = settingsManager.getString("custom_ai_tabs", "") ?: ""
            val tabList = if (customTabs.isNotEmpty()) {
                customTabs.split(",").toMutableList()
            } else {
                mutableListOf()
            }

            if (tabPosition - 3 < tabList.size) {
                tabList[tabPosition - 3] = newName
                settingsManager.putString("custom_ai_tabs", tabList.joinToString(","))
            }
        } catch (e: Exception) {
            Log.e(TAG, "æ›´æ–°è‡ªå®šä¹‰æ ‡ç­¾é¡µåç§°å¤±è´¥", e)
        }
    }

    /**
     * ç§»é™¤è‡ªå®šä¹‰æ ‡ç­¾é¡µ
     */
    private fun removeCustomTab(tabPosition: Int) {
        try {
            val settingsManager = SettingsManager.getInstance(this)
            val customTabs = settingsManager.getString("custom_ai_tabs", "") ?: ""
            val tabList = if (customTabs.isNotEmpty()) {
                customTabs.split(",").toMutableList()
            } else {
                mutableListOf()
            }

            if (tabPosition - 3 < tabList.size) {
                tabList.removeAt(tabPosition - 3)
                settingsManager.putString("custom_ai_tabs", tabList.joinToString(","))
            }
        } catch (e: Exception) {
            Log.e(TAG, "ç§»é™¤è‡ªå®šä¹‰æ ‡ç­¾é¡µå¤±è´¥", e)
        }
    }

    /**
     * è·å–è‡ªå®šä¹‰æ ‡ç­¾é¡µä¸­çš„AIè”ç³»äºº
     */
    private fun getCustomTabAIContacts(tabName: String): List<ContactCategory> {
        try {
            val settingsManager = SettingsManager.getInstance(this)
            val tabAIConfig = settingsManager.getString("custom_tab_ai_${tabName}", "") ?: ""

            if (tabAIConfig.isNotEmpty()) {
                val aiIds = tabAIConfig.split(",")
                val aiContacts = allContacts.flatMap { it.contacts }.filter { contact ->
                    aiIds.contains(contact.id) && isAIContact(contact)
                }.toMutableList()
                // åˆ›å»ºä¸€ä¸ªåŒ…å«AIè”ç³»äººçš„ContactCategory
                return listOf(ContactCategory(
                    name = tabName,
                    contacts = aiContacts,
                    isExpanded = true
                ))
            }
        } catch (e: Exception) {
            Log.e(TAG, "è·å–è‡ªå®šä¹‰æ ‡ç­¾é¡µAIè”ç³»äººå¤±è´¥", e)
        }

        return emptyList()
    }



    /**
     * å°†è”ç³»äººæ·»åŠ åˆ°å½“å‰æ ‡ç­¾é¡µ
     */
    private fun addContactToCurrentTab(contact: ChatContact) {
        try {
            val chatTabLayout = findViewById<com.google.android.material.tabs.TabLayout>(R.id.chat_tab_layout)
            val currentTabPosition = chatTabLayout?.selectedTabPosition ?: 0

            when (currentTabPosition) {
                0, 1 -> {
                    // "å…¨éƒ¨"å’Œ"AIåŠ©æ‰‹"æ ‡ç­¾é¡µä¸éœ€è¦æ·»åŠ 
                    Toast.makeText(this, "æ­¤æ ‡ç­¾é¡µä¸æ”¯æŒæ·»åŠ AIå¯¹è±¡", Toast.LENGTH_SHORT).show()
                }
                2 -> {
                    // "+"æ ‡ç­¾é¡µï¼Œæ˜¾ç¤ºé€‰æ‹©æ ‡ç­¾é¡µå¯¹è¯æ¡†
                    showSelectTabForContactDialog(contact)
                }
                else -> {
                    // è‡ªå®šä¹‰æ ‡ç­¾é¡µï¼Œç›´æ¥æ·»åŠ 
                    val customTabName = chatTabLayout?.getTabAt(currentTabPosition)?.text?.toString()
                    if (customTabName != null && customTabName != "+") {
                        addContactToCustomTab(contact, customTabName)
                    }
                }
            }
        } catch (e: Exception) {
            Log.e(TAG, "æ·»åŠ è”ç³»äººåˆ°å½“å‰æ ‡ç­¾é¡µå¤±è´¥", e)
        }
    }

    /**
     * æ˜¾ç¤ºé€‰æ‹©æ ‡ç­¾é¡µå¯¹è¯æ¡†
     */
    private fun showSelectTabForContactDialog(contact: ChatContact) {
        try {
            val settingsManager = SettingsManager.getInstance(this)
            val customTabs = settingsManager.getString("custom_ai_tabs", "") ?: ""

            if (customTabs.isEmpty()) {
                Toast.makeText(this, "è¯·å…ˆåˆ›å»ºè‡ªå®šä¹‰æ ‡ç­¾é¡µ", Toast.LENGTH_SHORT).show()
                return
            }

            val tabNames = customTabs.split(",")
            val items = tabNames.toTypedArray()

            AlertDialog.Builder(this)
                .setTitle("é€‰æ‹©è¦æ·»åŠ åˆ°çš„æ ‡ç­¾é¡µ")
                .setItems(items) { _, which ->
                    val selectedTabName = items[which]
                    addContactToCustomTab(contact, selectedTabName)
                }
                .setNegativeButton("å–æ¶ˆ", null)
                .show()
        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºé€‰æ‹©æ ‡ç­¾é¡µå¯¹è¯æ¡†å¤±è´¥", e)
        }
    }

    /**
     * å°†è”ç³»äººæ·»åŠ åˆ°è‡ªå®šä¹‰æ ‡ç­¾é¡µ
     */
    private fun addContactToCustomTab(contact: ChatContact, tabName: String) {
        try {
            if (!isAIContact(contact)) {
                Toast.makeText(this, "åªèƒ½æ·»åŠ AIåŠ©æ‰‹åˆ°è‡ªå®šä¹‰æ ‡ç­¾é¡µ", Toast.LENGTH_SHORT).show()
                return
            }

            val settingsManager = SettingsManager.getInstance(this)
            val tabAIConfig = settingsManager.getString("custom_tab_ai_${tabName}", "") ?: ""
            val aiIds = if (tabAIConfig.isNotEmpty()) {
                tabAIConfig.split(",").toMutableList()
            } else {
                mutableListOf()
            }

            if (!aiIds.contains(contact.id)) {
                aiIds.add(contact.id)
                settingsManager.putString("custom_tab_ai_${tabName}", aiIds.joinToString(","))
                Toast.makeText(this, "å·²å°† ${contact.name} æ·»åŠ åˆ°æ ‡ç­¾é¡µ \"$tabName\"", Toast.LENGTH_SHORT).show()
            } else {
                Toast.makeText(this, "${contact.name} å·²åœ¨æ ‡ç­¾é¡µ \"$tabName\" ä¸­", Toast.LENGTH_SHORT).show()
            }
        } catch (e: Exception) {
            Log.e(TAG, "æ·»åŠ è”ç³»äººåˆ°è‡ªå®šä¹‰æ ‡ç­¾é¡µå¤±è´¥", e)
        }
    }

    /**
     * ä»è‡ªå®šä¹‰æ ‡ç­¾é¡µç§»é™¤è”ç³»äºº
     */
    private fun removeContactFromCustomTab(contact: ChatContact, tabName: String) {
        try {
            val settingsManager = SettingsManager.getInstance(this)
            val tabAIConfig = settingsManager.getString("custom_tab_ai_${tabName}", "") ?: ""
            val aiIds = if (tabAIConfig.isNotEmpty()) {
                tabAIConfig.split(",").toMutableList()
            } else {
                mutableListOf()
            }

            if (aiIds.contains(contact.id)) {
                aiIds.remove(contact.id)
                settingsManager.putString("custom_tab_ai_${tabName}", aiIds.joinToString(","))
                Toast.makeText(this, "å·²ä»æ ‡ç­¾é¡µ \"$tabName\" ç§»é™¤ ${contact.name}", Toast.LENGTH_SHORT).show()

                // å¦‚æœå½“å‰æ­£åœ¨æ˜¾ç¤ºè¯¥æ ‡ç­¾é¡µï¼Œåˆ·æ–°æ˜¾ç¤º
                val chatTabLayout = findViewById<com.google.android.material.tabs.TabLayout>(R.id.chat_tab_layout)
                val currentTabPosition = chatTabLayout?.selectedTabPosition ?: 0
                if (currentTabPosition > 2) {
                    val currentTabName = chatTabLayout?.getTabAt(currentTabPosition)?.text?.toString()
                    if (currentTabName == tabName) {
                        showCustomAIContacts(tabName)
                    }
                }
            }
        } catch (e: Exception) {
            Log.e(TAG, "ä»è‡ªå®šä¹‰æ ‡ç­¾é¡µç§»é™¤è”ç³»äººå¤±è´¥", e)
        }
    }

    /**
     * åˆ›å»ºè‡ªå®šä¹‰æ ‡ç­¾é¡µ
     */
    private fun createCustomTab(tabName: String) {
        try {
            val prefs = getSharedPreferences("custom_tabs", MODE_PRIVATE)
            val existingTabs = prefs.getString("custom_ai_tabs", "") ?: ""

            val tabList = if (existingTabs.isNotEmpty()) {
                existingTabs.split(",").toMutableList()
            } else {
                mutableListOf()
            }

            if (!tabList.contains(tabName)) {
                tabList.add(tabName)
                prefs.edit().putString("custom_ai_tabs", tabList.joinToString(",")).apply()

                // æ ‡ç­¾é¡µå·²åˆ›å»º
                Log.d(TAG, "è‡ªå®šä¹‰æ ‡ç­¾é¡µå·²ä¿å­˜")

                Log.d(TAG, "åˆ›å»ºè‡ªå®šä¹‰æ ‡ç­¾é¡µ: $tabName")
            } else {
                Toast.makeText(this, "æ ‡ç­¾é¡µ \"$tabName\" å·²å­˜åœ¨", Toast.LENGTH_SHORT).show()
            }
        } catch (e: Exception) {
            Log.e(TAG, "åˆ›å»ºè‡ªå®šä¹‰æ ‡ç­¾é¡µå¤±è´¥", e)
            Toast.makeText(this, "åˆ›å»ºæ ‡ç­¾é¡µå¤±è´¥", Toast.LENGTH_SHORT).show()
        }
    }

    /**
     * åˆ›å»ºè‡ªå®šä¹‰åˆ†ç»„
     */
    private fun createCustomGroup(groupName: String) {
        try {
            // æ£€æŸ¥åˆ†ç»„æ˜¯å¦å·²å­˜åœ¨
            val existingCategory = allContacts.find { it.name == groupName }
            if (existingCategory != null) {
                Toast.makeText(this, "åˆ†ç»„ \"$groupName\" å·²å­˜åœ¨", Toast.LENGTH_SHORT).show()
                return
            }

            // å¦‚æœåˆ›å»ºçš„æ˜¯AIåŠ©æ‰‹åˆ†ç»„ï¼Œæ¸…é™¤åˆ é™¤æ ‡è®°
            if (groupName == "AIåŠ©æ‰‹") {
                val prefs = getSharedPreferences("custom_tabs", MODE_PRIVATE)
                prefs.edit().putBoolean("ai_assistant_group_deleted", false).apply()
                Log.d(TAG, "é‡æ–°åˆ›å»ºAIåŠ©æ‰‹åˆ†ç»„ï¼Œæ¸…é™¤åˆ é™¤æ ‡è®°")
            }

            // åˆ›å»ºæ–°çš„åˆ†ç»„
            val newCategory = ContactCategory(
                name = groupName,
                contacts = mutableListOf(),
                isExpanded = true
            )
            allContacts.add(newCategory)

            // ä¿å­˜åˆ°SharedPreferences
            saveContacts()

            // åœ¨TabLayoutä¸­æ·»åŠ æ–°æ ‡ç­¾
            val chatTabLayout = findViewById<com.google.android.material.tabs.TabLayout>(R.id.chat_tab_layout)
            val newTab = chatTabLayout?.newTab()?.setText(groupName)
            if (newTab != null) {
                // åœ¨+å·ä¹‹å‰æ’å…¥
                val insertPosition = (chatTabLayout?.tabCount ?: 1) - 1
                chatTabLayout?.addTab(newTab, insertPosition)

                // é€‰ä¸­æ–°åˆ›å»ºçš„æ ‡ç­¾
                newTab.select()

                // é‡æ–°è®¾ç½®æ‹–åŠ¨åŠŸèƒ½
                setupTabDragAndDrop(chatTabLayout)
            }

            // æ›´æ–°è‡ªå®šä¹‰æ ‡ç­¾é¡µçš„ä¿å­˜é¡ºåº
            updateCustomTabsOrder()

            // ä¿å­˜è‡ªå®šä¹‰æ ‡ç­¾é¡µé…ç½®
            saveCustomTabConfiguration(groupName)

            Log.d(TAG, "åˆ›å»ºè‡ªå®šä¹‰åˆ†ç»„: $groupName")
        } catch (e: Exception) {
            Log.e(TAG, "åˆ›å»ºè‡ªå®šä¹‰åˆ†ç»„å¤±è´¥", e)
            Toast.makeText(this, "åˆ›å»ºåˆ†ç»„å¤±è´¥", Toast.LENGTH_SHORT).show()
        }
    }

    /**
     * æ˜¾ç¤ºè‡ªå®šä¹‰åˆ†ç»„ä¸­çš„è”ç³»äºº
     */
    private fun showCustomGroupContacts(groupName: String) {
        try {
            val customCategory = allContacts.find { it.name == groupName }

            val displayCategories = if (customCategory != null && customCategory.contacts.isNotEmpty()) {
                listOf(customCategory.copy(isExpanded = true))
            } else {
                // å¦‚æœåˆ†ç»„ä¸ºç©ºï¼Œæ˜¾ç¤ºç©ºçš„åˆ†ç»„ï¼ˆä¸æ·»åŠ æç¤ºå¯¹è±¡ï¼‰
                listOf(ContactCategory(
                    name = groupName,
                    contacts = mutableListOf(),
                    isExpanded = true
                ))
            }

            chatContactAdapter?.updateContacts(displayCategories)
            Log.d(TAG, "æ˜¾ç¤ºè‡ªå®šä¹‰åˆ†ç»„: $groupNameï¼ŒåŒ…å«${customCategory?.contacts?.size ?: 0}ä¸ªAI")
        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºè‡ªå®šä¹‰åˆ†ç»„è”ç³»äººå¤±è´¥", e)
        }
    }

    /**
     * åŠ è½½è‡ªå®šä¹‰æ ‡ç­¾é¡µï¼ˆæŒ‰ä¿å­˜çš„é¡ºåºï¼‰
     */
    private fun loadCustomTabs() {
        try {
            val prefs = getSharedPreferences("custom_tabs", MODE_PRIVATE)
            val customTabs = prefs.getString("custom_ai_tabs", "") ?: ""

            if (customTabs.isNotEmpty()) {
                val chatTabLayout = findViewById<com.google.android.material.tabs.TabLayout>(R.id.chat_tab_layout)
                val tabNames = customTabs.split(",")

                Log.d(TAG, "åŠ è½½è‡ªå®šä¹‰æ ‡ç­¾é¡µ: ${tabNames.joinToString(", ")}")

                // æŒ‰ç…§ä¿å­˜çš„é¡ºåºä¾æ¬¡æ·»åŠ æ ‡ç­¾
                tabNames.forEach { tabName ->
                    if (tabName.isNotEmpty() && tabName != "AIåŠ©æ‰‹") {
                        // ç¡®ä¿allContactsä¸­å­˜åœ¨å¯¹åº”çš„åˆ†ç»„
                        val existingCategory = allContacts.find { it.name == tabName }
                        if (existingCategory == null) {
                            // å¦‚æœallContactsä¸­ä¸å­˜åœ¨ï¼Œåˆ›å»ºä¸€ä¸ªç©ºåˆ†ç»„
                            val newCategory = ContactCategory(
                                name = tabName,
                                contacts = mutableListOf(),
                                isExpanded = true
                            )
                            allContacts.add(newCategory)
                            Log.d(TAG, "ä¸ºæ ‡ç­¾é¡µåˆ›å»ºå¯¹åº”åˆ†ç»„: $tabName")
                        }

                        val newTab = chatTabLayout?.newTab()?.setText(tabName)
                        if (newTab != null) {
                            // åœ¨+å·ä¹‹å‰æ’å…¥
                            val insertPosition = (chatTabLayout?.tabCount ?: 1) - 1
                            chatTabLayout?.addTab(newTab, insertPosition)
                        }
                    }
                }

                // é‡æ–°è®¾ç½®æ‹–åŠ¨åŠŸèƒ½ï¼ˆå› ä¸ºæ·»åŠ äº†æ–°æ ‡ç­¾ï¼‰
                setupTabDragAndDrop(chatTabLayout)
            }
        } catch (e: Exception) {
            Log.e(TAG, "åŠ è½½è‡ªå®šä¹‰æ ‡ç­¾é¡µå¤±è´¥", e)
        }
    }

    /**
     * æŸ¥æ‰¾è”ç³»äººæ‰€åœ¨çš„åˆ†ç»„ï¼ˆå¢å¼ºç‰ˆï¼Œæ”¯æŒAIè”ç³»äººï¼‰
     */
    private fun findContactGroup(contact: ChatContact): String? {
        try {
            Log.d(TAG, "æŸ¥æ‰¾è”ç³»äººåˆ†ç»„: ${contact.name} (ID: ${contact.id})")

            // 1. é¦–å…ˆåœ¨allContactsä¸­æŸ¥æ‰¾
            allContacts.forEach { category ->
                if (category.contacts.any { it.id == contact.id }) {
                    Log.d(TAG, "åœ¨allContactsä¸­æ‰¾åˆ°è”ç³»äºº ${contact.name} åœ¨åˆ†ç»„: ${category.name}")
                    return category.name
                }
            }

            // 2. å¦‚æœæ˜¯AIè”ç³»äººä¸”æ²¡æ‰¾åˆ°ï¼Œæ£€æŸ¥å½“å‰æ˜¾ç¤ºçš„æ ‡ç­¾é¡µ
            if (contact.type == ContactType.AI) {
                val chatTabLayout = findViewById<com.google.android.material.tabs.TabLayout>(R.id.chat_tab_layout)
                val currentTabPosition = chatTabLayout?.selectedTabPosition ?: 0
                val currentTab = chatTabLayout?.getTabAt(currentTabPosition)
                val currentTabText = currentTab?.text?.toString()

                Log.d(TAG, "AIè”ç³»äººæœªåœ¨allContactsä¸­æ‰¾åˆ°ï¼Œå½“å‰æ ‡ç­¾é¡µ: $currentTabText")

                when (currentTabPosition) {
                    0 -> {
                        // åœ¨"å…¨éƒ¨"æ ‡ç­¾é¡µä¸­ï¼ŒAIè”ç³»äººåº”è¯¥å±äºAIåŠ©æ‰‹åˆ†ç»„
                        Log.d(TAG, "AIåœ¨å…¨éƒ¨æ ‡ç­¾é¡µä¸­ï¼Œå½’ç±»ä¸ºAIåŠ©æ‰‹")
                        return "AIåŠ©æ‰‹"
                    }
                    1 -> {
                        // åœ¨"AIåŠ©æ‰‹"æ ‡ç­¾é¡µä¸­
                        Log.d(TAG, "AIåœ¨AIåŠ©æ‰‹æ ‡ç­¾é¡µä¸­")
                        return "AIåŠ©æ‰‹"
                    }
                    else -> {
                        // åœ¨è‡ªå®šä¹‰æ ‡ç­¾é¡µä¸­
                        if (currentTabText != null && currentTabText != "+") {
                            Log.d(TAG, "AIåœ¨è‡ªå®šä¹‰æ ‡ç­¾é¡µä¸­: $currentTabText")
                            return currentTabText
                        } else {
                            // å¦‚æœæ˜¯æ— æ•ˆçš„è‡ªå®šä¹‰æ ‡ç­¾é¡µï¼Œé»˜è®¤å½’ç±»ä¸ºAIåŠ©æ‰‹
                            Log.d(TAG, "AIåœ¨æ— æ•ˆæ ‡ç­¾é¡µä¸­ï¼Œé»˜è®¤å½’ç±»ä¸ºAIåŠ©æ‰‹")
                            return "AIåŠ©æ‰‹"
                        }
                    }
                }
            }

            Log.d(TAG, "æœªæ‰¾åˆ°è”ç³»äºº ${contact.name} çš„åˆ†ç»„")
            return null

        } catch (e: Exception) {
            Log.e(TAG, "æŸ¥æ‰¾è”ç³»äººåˆ†ç»„å¤±è´¥", e)
            return null
        }
    }

    /**
     * æ˜¾ç¤ºä¸ºè”ç³»äººåˆ›å»ºæ–°åˆ†ç»„çš„å¯¹è¯æ¡†ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
     */
    private fun showCreateNewGroupForContactDialog(contact: ChatContact) {
        try {
            val input = android.widget.EditText(this).apply {
                hint = "ä¾‹å¦‚ï¼šå·¥ä½œAIã€å­¦ä¹ AIã€å¨±ä¹AI"
                setPadding(50, 30, 50, 30)
                // è®¾ç½®è¾“å…¥æç¤º
                setHint("è¾“å…¥æ–°åˆ†ç»„åç§°")
            }

            val message = """
                ä¸º ${contact.name} åˆ›å»ºæ–°çš„åˆ†ç»„

                ğŸ’¡ å»ºè®®åˆ†ç»„åç§°ï¼š
                â€¢ å·¥ä½œAI - ç”¨äºå·¥ä½œç›¸å…³çš„AIåŠ©æ‰‹
                â€¢ å­¦ä¹ AI - ç”¨äºå­¦ä¹ å’Œæ•™è‚²çš„AI
                â€¢ ç”Ÿæ´»AI - ç”¨äºæ—¥å¸¸ç”Ÿæ´»çš„AIåŠ©æ‰‹
                â€¢ å¨±ä¹AI - ç”¨äºå¨±ä¹å’Œä¼‘é—²çš„AI

                æˆ–è€…æ ¹æ®æ‚¨çš„éœ€è¦è‡ªå®šä¹‰åˆ†ç»„åç§°
            """.trimIndent()

            AlertDialog.Builder(this, R.style.Theme_MaterialDialog)
                .setTitle("åˆ›å»ºæ–°åˆ†ç»„")
                .setMessage(message)
                .setView(input)
                .setPositiveButton("åˆ›å»ºå¹¶ç§»åŠ¨") { _, _ ->
                    val groupName = input.text.toString().trim()
                    if (groupName.isNotEmpty()) {
                        if (isValidGroupName(groupName)) {
                            createCustomGroup(groupName)
                            moveContactToGroup(contact, groupName)
                            Toast.makeText(this, "âœ… å·²åˆ›å»ºåˆ†ç»„ \"$groupName\" å¹¶ç§»åŠ¨ ${contact.name}", Toast.LENGTH_LONG).show()
                        } else {
                            Toast.makeText(this, "åˆ†ç»„åç§°ä¸èƒ½åŒ…å«ç‰¹æ®Šå­—ç¬¦", Toast.LENGTH_SHORT).show()
                        }
                    } else {
                        Toast.makeText(this, "åˆ†ç»„åç§°ä¸èƒ½ä¸ºç©º", Toast.LENGTH_SHORT).show()
                    }
                }
                .setNegativeButton("å–æ¶ˆ", null)
                .setNeutralButton("å¿«é€Ÿé€‰æ‹©") { _, _ ->
                    showQuickGroupSelection(contact)
                }
                .show()
        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºåˆ›å»ºæ–°åˆ†ç»„å¯¹è¯æ¡†å¤±è´¥", e)
            Toast.makeText(this, "åˆ›å»ºåˆ†ç»„å¤±è´¥", Toast.LENGTH_SHORT).show()
        }
    }

    /**
     * éªŒè¯åˆ†ç»„åç§°æ˜¯å¦æœ‰æ•ˆ
     */
    private fun isValidGroupName(groupName: String): Boolean {
        // æ£€æŸ¥æ˜¯å¦åŒ…å«ç‰¹æ®Šå­—ç¬¦æˆ–ä¸ç°æœ‰åˆ†ç»„é‡å
        if (groupName.contains("+") || groupName.contains("å…¨éƒ¨") || groupName.contains("æœªåˆ†ç»„")) {
            return false
        }

        // æ£€æŸ¥æ˜¯å¦ä¸ç°æœ‰åˆ†ç»„é‡å
        val existingGroup = allContacts.find { it.name == groupName }
        if (existingGroup != null) {
            Toast.makeText(this, "åˆ†ç»„ \"$groupName\" å·²å­˜åœ¨", Toast.LENGTH_SHORT).show()
            return false
        }

        return true
    }

    /**
     * æ˜¾ç¤ºå¿«é€Ÿåˆ†ç»„é€‰æ‹©
     */
    private fun showQuickGroupSelection(contact: ChatContact) {
        val quickGroups = arrayOf(
            "å·¥ä½œAI",
            "å­¦ä¹ AI",
            "ç”Ÿæ´»AI",
            "å¨±ä¹AI",
            "ä¸“ä¸šAI",
            "åˆ›æ„AI"
        )

        AlertDialog.Builder(this, R.style.Theme_MaterialDialog)
            .setTitle("å¿«é€Ÿé€‰æ‹©åˆ†ç»„")
            .setMessage("é€‰æ‹©ä¸€ä¸ªé¢„è®¾åˆ†ç»„åç§°ï¼š")
            .setItems(quickGroups) { _, which ->
                val selectedGroup = quickGroups[which]
                if (isValidGroupName(selectedGroup)) {
                    createCustomGroup(selectedGroup)
                    moveContactToGroup(contact, selectedGroup)
                    Toast.makeText(this, "âœ… å·²åˆ›å»ºåˆ†ç»„ \"$selectedGroup\" å¹¶ç§»åŠ¨ ${contact.name}", Toast.LENGTH_LONG).show()
                }
            }
            .setNegativeButton("å–æ¶ˆ", null)
            .show()
    }

    /**
     * ç§»åŠ¨è”ç³»äººåˆ°æŒ‡å®šåˆ†ç»„ï¼ˆé‡æ–°å®ç°ï¼Œæ”¯æŒAIè”ç³»äººï¼‰
     */
    private fun moveContactToGroup(contact: ChatContact, targetGroupName: String) {
        try {
            Log.d(TAG, "å¼€å§‹ç§»åŠ¨è”ç³»äºº: ${contact.name} åˆ°åˆ†ç»„: $targetGroupName")

            // 1. è·å–å½“å‰åˆ†ç»„
            val currentGroup = findContactGroup(contact)
            Log.d(TAG, "å½“å‰åˆ†ç»„: $currentGroup")

            // 2. ä»å½“å‰åˆ†ç»„ä¸­ç§»é™¤ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if (currentGroup != null && currentGroup != "æœªåˆ†ç»„") {
                val currentCategory = allContacts.find { it.name == currentGroup }
                if (currentCategory != null) {
                    val updatedContacts = currentCategory.contacts.filter { it.id != contact.id }.toMutableList()
                    val updatedCategory = currentCategory.copy(contacts = updatedContacts)
                    val index = allContacts.indexOf(currentCategory)
                    allContacts[index] = updatedCategory
                    Log.d(TAG, "ä»åˆ†ç»„ $currentGroup ä¸­ç§»é™¤äº† ${contact.name}")

                    // å¦‚æœåˆ†ç»„å˜ç©ºä¸”ä¸æ˜¯é¢„è®¾åˆ†ç»„ï¼Œè€ƒè™‘åˆ é™¤åˆ†ç»„
                    if (updatedContacts.isEmpty() &&
                        currentGroup != "AIåŠ©æ‰‹" &&
                        currentGroup != "å…¨éƒ¨" &&
                        currentGroup != "æœªåˆ†ç»„") {
                        Log.d(TAG, "åˆ†ç»„ $currentGroup å·²ç©ºï¼Œä¿ç•™åˆ†ç»„ä½†ç§»é™¤å¯¹åº”æ ‡ç­¾é¡µ")
                        removeEmptyGroupTab(currentGroup)
                    }
                } else {
                    Log.w(TAG, "å½“å‰åˆ†ç»„ $currentGroup åœ¨allContactsä¸­ä¸å­˜åœ¨")
                }
            } else {
                Log.d(TAG, "è”ç³»äºº ${contact.name} å½“å‰ä¸åœ¨ä»»ä½•åˆ†ç»„ä¸­æˆ–åœ¨æœªåˆ†ç»„ä¸­")
            }

            // 3. æ·»åŠ åˆ°ç›®æ ‡åˆ†ç»„
            var targetCategory = allContacts.find { it.name == targetGroupName }
            if (targetCategory != null) {
                // ç›®æ ‡åˆ†ç»„å­˜åœ¨ï¼Œæ·»åŠ è”ç³»äºº
                val updatedContacts = targetCategory.contacts.toMutableList()
                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ï¼Œé¿å…é‡å¤æ·»åŠ 
                if (!updatedContacts.any { it.id == contact.id }) {
                    updatedContacts.add(contact)
                    val updatedCategory = targetCategory.copy(contacts = updatedContacts)
                    val index = allContacts.indexOf(targetCategory)
                    allContacts[index] = updatedCategory
                    Log.d(TAG, "å°† ${contact.name} æ·»åŠ åˆ°ç°æœ‰åˆ†ç»„ $targetGroupName")
                } else {
                    Log.d(TAG, "${contact.name} å·²åœ¨ç›®æ ‡åˆ†ç»„ $targetGroupName ä¸­")
                }
            } else {
                // ç›®æ ‡åˆ†ç»„ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°åˆ†ç»„
                val newCategory = ContactCategory(
                    name = targetGroupName,
                    contacts = mutableListOf(contact),
                    isExpanded = true
                )
                allContacts.add(newCategory)
                Log.d(TAG, "åˆ›å»ºæ–°åˆ†ç»„ $targetGroupName å¹¶æ·»åŠ  ${contact.name}")

                // å¦‚æœæ˜¯"AIåŠ©æ‰‹"åˆ†ç»„ï¼Œæ¸…é™¤åˆ é™¤æ ‡è®°å’Œæ—§æ•°æ®
                if (targetGroupName == "AIåŠ©æ‰‹") {
                    val prefs = getSharedPreferences("custom_tabs", MODE_PRIVATE)
                    prefs.edit()
                        .putBoolean("ai_assistant_group_deleted", false)
                        .remove("ai_assistant_group_contacts") // æ¸…ç†æ—§çš„è”ç³»äººæ•°æ®
                        .apply()
                    Log.d(TAG, "é‡æ–°åˆ›å»ºAIåŠ©æ‰‹åˆ†ç»„ï¼Œæ¸…é™¤åˆ é™¤æ ‡è®°å’Œæ—§æ•°æ®")

                    // ç¡®ä¿AIåŠ©æ‰‹æ ‡ç­¾é¡µå­˜åœ¨
                    ensureAIAssistantTabExists()
                }
            }

            // 4. ç¡®ä¿ç›®æ ‡åˆ†ç»„æœ‰å¯¹åº”çš„æ ‡ç­¾é¡µ
            ensureTabForGroup(targetGroupName)

            // 5. å¦‚æœæ˜¯"AIåŠ©æ‰‹"åˆ†ç»„ï¼Œç¡®ä¿æ ‡ç­¾é¡µå­˜åœ¨
            if (targetGroupName == "AIåŠ©æ‰‹") {
                ensureAIAssistantTabExists()
            }

            // 5. æ›´æ–°AIçš„åˆ†ç»„ä¿¡æ¯ï¼ˆå¦‚æœæ˜¯AIè”ç³»äººï¼‰
            if (contact.type == ContactType.AI) {
                updateAIGroupInfo(contact, targetGroupName)
            }

            // 6. ä¿å­˜æ›´æ”¹
            saveContacts()
            Log.d(TAG, "ä¿å­˜è”ç³»äººæ•°æ®å®Œæˆ")

            // 7. ä¿å­˜æ›´æ”¹
            saveContacts()

            // 8. ç¡®ä¿ç›®æ ‡åˆ†ç»„æœ‰å¯¹åº”çš„æ ‡ç­¾é¡µ
            ensureTabForGroup(targetGroupName)

            // 9. åˆ‡æ¢åˆ°ç›®æ ‡æ ‡ç­¾é¡µï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            switchToTabIfExists(targetGroupName)

            // 10. å»¶è¿Ÿåˆ·æ–°æ˜¾ç¤ºï¼Œç¡®ä¿æ ‡ç­¾é¡µåˆ‡æ¢å®Œæˆ
            Handler(Looper.getMainLooper()).postDelayed({
                refreshCurrentTabDisplay()
                Log.d(TAG, "åˆ‡æ¢åˆ°ç›®æ ‡åˆ†ç»„å¹¶åˆ·æ–°æ˜¾ç¤ºå®Œæˆ: $targetGroupName")
            }, 200)

            Log.d(TAG, "ç§»åŠ¨è”ç³»äººå®Œæˆ: ${contact.name} -> $targetGroupName")

            // 9. æ˜¾ç¤ºæˆåŠŸæç¤º
            val message = if (currentGroup != null && currentGroup != "æœªåˆ†ç»„") {
                "âœ… å·²å°† ${contact.name} ä» \"$currentGroup\" ç§»åŠ¨åˆ° \"$targetGroupName\""
            } else {
                "âœ… å·²å°† ${contact.name} ç§»åŠ¨åˆ°åˆ†ç»„ \"$targetGroupName\""
            }
            Toast.makeText(this, message, Toast.LENGTH_LONG).show()
            Log.d(TAG, "ç§»åŠ¨è”ç³»äººæˆåŠŸ: ${contact.name} ä» $currentGroup åˆ° $targetGroupName")

        } catch (e: Exception) {
            Log.e(TAG, "ç§»åŠ¨è”ç³»äººåˆ°åˆ†ç»„å¤±è´¥", e)
            Toast.makeText(this, "âŒ ç§»åŠ¨å¤±è´¥: ${e.message}", Toast.LENGTH_SHORT).show()
        }
    }

    /**
     * ç¡®ä¿åˆ†ç»„æœ‰å¯¹åº”çš„æ ‡ç­¾é¡µ
     */
    private fun ensureTabForGroup(groupName: String) {
        try {
            val chatTabLayout = findViewById<com.google.android.material.tabs.TabLayout>(R.id.chat_tab_layout)

            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è¯¥æ ‡ç­¾é¡µ
            var tabExists = false
            for (i in 0 until (chatTabLayout?.tabCount ?: 0)) {
                val tab = chatTabLayout?.getTabAt(i)
                if (tab?.text?.toString() == groupName) {
                    tabExists = true
                    break
                }
            }

            // å¦‚æœä¸å­˜åœ¨ä¸”ä¸æ˜¯é¢„è®¾åˆ†ç»„ï¼Œåˆ›å»ºæ–°æ ‡ç­¾é¡µ
            if (!tabExists && groupName != "å…¨éƒ¨" && groupName != "AIåŠ©æ‰‹" && groupName != "æœªåˆ†ç»„") {
                val tabCount = chatTabLayout?.tabCount ?: 0
                val insertPosition = if (tabCount > 0) tabCount - 1 else 0 // åœ¨+å·å‰æ’å…¥

                val newTab = chatTabLayout?.newTab()?.setText(groupName)
                if (newTab != null) {
                    chatTabLayout.addTab(newTab, insertPosition)

                    // é‡æ–°è®¾ç½®æ‹–æ‹½ç›‘å¬å™¨
                    setupTabDragListener(chatTabLayout)

                    // ä¿å­˜æ ‡ç­¾é¡µé¡ºåº
                    val currentTabOrderString = getCurrentTabOrder()
                    val currentTabOrder = if (currentTabOrderString.isNotEmpty()) {
                        currentTabOrderString.split(", ")
                    } else {
                        emptyList()
                    }
                    updateAllTabOrder(currentTabOrder)

                    Log.d(TAG, "ä¸ºåˆ†ç»„ $groupName åˆ›å»ºäº†æ–°æ ‡ç­¾é¡µ")
                }
            }

        } catch (e: Exception) {
            Log.e(TAG, "ç¡®ä¿åˆ†ç»„æ ‡ç­¾é¡µå¤±è´¥", e)
        }
    }

    /**
     * åˆ‡æ¢åˆ°æŒ‡å®šæ ‡ç­¾é¡µï¼ˆå¦‚æœå­˜åœ¨ï¼‰
     */
    private fun switchToTabIfExists(tabName: String) {
        try {
            val chatTabLayout = findViewById<com.google.android.material.tabs.TabLayout>(R.id.chat_tab_layout)

            // æŸ¥æ‰¾å¯¹åº”çš„æ ‡ç­¾é¡µ
            for (i in 0 until (chatTabLayout?.tabCount ?: 0)) {
                val tab = chatTabLayout?.getTabAt(i)
                if (tab?.text?.toString() == tabName) {
                    // æ‰¾åˆ°å¯¹åº”æ ‡ç­¾é¡µï¼Œåˆ‡æ¢åˆ°è¯¥æ ‡ç­¾é¡µ
                    chatTabLayout.selectTab(tab)
                    Log.d(TAG, "åˆ‡æ¢åˆ°æ ‡ç­¾é¡µ: $tabName")
                    return
                }
            }

            // å¦‚æœæ˜¯ç‰¹æ®Šåˆ†ç»„åç§°ï¼Œæ˜ å°„åˆ°å¯¹åº”æ ‡ç­¾é¡µ
            when (tabName) {
                "AIåŠ©æ‰‹" -> {
                    val aiTab = chatTabLayout?.getTabAt(1)
                    if (aiTab != null) {
                        chatTabLayout.selectTab(aiTab)
                        Log.d(TAG, "åˆ‡æ¢åˆ°AIåŠ©æ‰‹æ ‡ç­¾é¡µ")
                    }
                }
                "æœªåˆ†ç»„" -> {
                    val allTab = chatTabLayout?.getTabAt(0)
                    if (allTab != null) {
                        chatTabLayout.selectTab(allTab)
                        Log.d(TAG, "åˆ‡æ¢åˆ°å…¨éƒ¨æ ‡ç­¾é¡µ")
                    }
                }
            }

        } catch (e: Exception) {
            Log.e(TAG, "åˆ‡æ¢æ ‡ç­¾é¡µå¤±è´¥", e)
        }
    }



    /**
     * æ˜¾ç¤ºå…¨éƒ¨æ ‡ç­¾é¡µç®¡ç†é€‰é¡¹
     */
    private fun showAllTabManagement() {
        try {
            val allAICount = getAllAvailableAIs().size
            val groupCount = allContacts.count { it.name != "å…¨éƒ¨" && it.contacts.any { contact -> contact.type == ContactType.AI } }

            val options = arrayOf(
                "ğŸ“Š æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯ ($allAICount ä¸ªAIï¼Œ$groupCount ä¸ªåˆ†ç»„)",
                "ğŸ”„ åˆ·æ–°æ‰€æœ‰åˆ†ç»„",
                "ğŸ“‹ å¯¼å‡ºåˆ†ç»„é…ç½®",
                "ğŸ“¥ å¯¼å…¥åˆ†ç»„é…ç½®"
            )

            AlertDialog.Builder(this, R.style.Theme_MaterialDialog)
                .setTitle("å…¨éƒ¨ - èšåˆè§†å›¾ç®¡ç†")
                .setItems(options) { _, which ->
                    when (which) {
                        0 -> showAllAIStatistics()
                        1 -> {
                            refreshAllGroups()
                            Toast.makeText(this, "å·²åˆ·æ–°æ‰€æœ‰åˆ†ç»„", Toast.LENGTH_SHORT).show()
                        }
                        2 -> exportGroupConfiguration()
                        3 -> importGroupConfiguration()
                    }
                }
                .setNegativeButton("å–æ¶ˆ", null)
                .show()
        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºå…¨éƒ¨æ ‡ç­¾é¡µç®¡ç†å¤±è´¥", e)
        }
    }

    /**
     * æ˜¾ç¤ºæ‰€æœ‰AIç»Ÿè®¡ä¿¡æ¯
     */
    private fun showAllAIStatistics() {
        try {
            val allAIs = getAllAvailableAIs()
            val groupedAIs = allAIs.groupBy { findContactGroup(it) ?: "æœªåˆ†ç»„" }

            val statisticsText = buildString {
                appendLine("ğŸ“Š AIåŠ©æ‰‹ç»Ÿè®¡ä¿¡æ¯")
                appendLine("=".repeat(30))
                appendLine("æ€»è®¡: ${allAIs.size} ä¸ªAIåŠ©æ‰‹")
                appendLine("åˆ†ç»„æ•°é‡: ${groupedAIs.size} ä¸ª")
                appendLine()

                groupedAIs.forEach { (groupName, ais) ->
                    appendLine("ğŸ“ $groupName: ${ais.size} ä¸ªAI")
                    ais.forEach { ai ->
                        val status = if (ai.isOnline) "ğŸŸ¢" else "ğŸ”´"
                        val pinned = if (ai.isPinned) "ğŸ“Œ" else ""
                        val muted = if (ai.isMuted) "ğŸ”‡" else ""
                        appendLine("  $status $pinned$muted ${ai.name}")
                    }
                    appendLine()
                }
            }

            AlertDialog.Builder(this, R.style.Theme_MaterialDialog)
                .setTitle("AIåŠ©æ‰‹ç»Ÿè®¡")
                .setMessage(statisticsText)
                .setPositiveButton("ç¡®å®š", null)
                .show()
        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºAIç»Ÿè®¡ä¿¡æ¯å¤±è´¥", e)
        }
    }

    /**
     * åˆ·æ–°æ‰€æœ‰åˆ†ç»„
     */
    private fun refreshAllGroups() {
        try {
            loadInitialContacts()
            refreshCurrentTabDisplay()
            chatContactAdapter?.updateContacts(allContacts)
            Log.d(TAG, "åˆ·æ–°æ‰€æœ‰åˆ†ç»„å®Œæˆ")
        } catch (e: Exception) {
            Log.e(TAG, "åˆ·æ–°æ‰€æœ‰åˆ†ç»„å¤±è´¥", e)
        }
    }

    /**
     * å¯¼å‡ºåˆ†ç»„é…ç½®
     */
    private fun exportGroupConfiguration() {
        try {
            Toast.makeText(this, "å¯¼å‡ºåŠŸèƒ½å¼€å‘ä¸­...", Toast.LENGTH_SHORT).show()
        } catch (e: Exception) {
            Log.e(TAG, "å¯¼å‡ºåˆ†ç»„é…ç½®å¤±è´¥", e)
        }
    }

    /**
     * å¯¼å…¥åˆ†ç»„é…ç½®
     */
    private fun importGroupConfiguration() {
        try {
            Toast.makeText(this, "å¯¼å…¥åŠŸèƒ½å¼€å‘ä¸­...", Toast.LENGTH_SHORT).show()
        } catch (e: Exception) {
            Log.e(TAG, "å¯¼å…¥åˆ†ç»„é…ç½®å¤±è´¥", e)
        }
    }

    /**
     * æ›´æ–°AIçš„åˆ†ç»„ä¿¡æ¯
     */
    private fun updateAIGroupInfo(aiContact: ChatContact, groupName: String) {
        try {
            // æ›´æ–°AIè”ç³»äººçš„åˆ†ç»„æ ‡ç­¾ä¿¡æ¯
            // è¿™é‡Œå¯ä»¥æ‰©å±•ä¸ºæ›´æ–°AIçš„å…ƒæ•°æ®æˆ–å…¶ä»–ç›¸å…³ä¿¡æ¯
            Log.d(TAG, "æ›´æ–°AI ${aiContact.name} çš„åˆ†ç»„ä¿¡æ¯ä¸º: $groupName")

            // å¦‚æœéœ€è¦ï¼Œå¯ä»¥åœ¨è¿™é‡Œæ›´æ–°AIçš„å…¶ä»–å±æ€§
            // ä¾‹å¦‚ï¼šaiContact.groupTag = groupName

        } catch (e: Exception) {
            Log.e(TAG, "æ›´æ–°AIåˆ†ç»„ä¿¡æ¯å¤±è´¥", e)
        }
    }

    /**
     * åˆ·æ–°æ‰€æœ‰æ ‡ç­¾é¡µæ˜¾ç¤º
     */
    private fun refreshAllTabDisplay() {
        try {
            // åˆ·æ–°å½“å‰æ ‡ç­¾é¡µæ˜¾ç¤º
            refreshCurrentTabDisplay()
            // æ›´æ–°é€‚é…å™¨
            chatContactAdapter?.updateContacts(allContacts)
            Log.d(TAG, "åˆ·æ–°æ‰€æœ‰æ ‡ç­¾é¡µæ˜¾ç¤ºå®Œæˆ")
        } catch (e: Exception) {
            Log.e(TAG, "åˆ·æ–°æ‰€æœ‰æ ‡ç­¾é¡µæ˜¾ç¤ºå¤±è´¥", e)
        }
    }

    /**
     * åˆ·æ–°æ‰€æœ‰æ ‡ç­¾é¡µæ•°æ®ï¼ˆé‡æ–°åŠ è½½å’ŒåŒæ­¥æ•°æ®ï¼‰
     */
    private fun refreshAllTabsData() {
        try {
            // é‡æ–°åŠ è½½è”ç³»äººæ•°æ®
            loadInitialContacts()

            // ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
            ensureDataConsistency()

            Log.d(TAG, "åˆ·æ–°æ‰€æœ‰æ ‡ç­¾é¡µæ•°æ®å®Œæˆ")
        } catch (e: Exception) {
            Log.e(TAG, "åˆ·æ–°æ‰€æœ‰æ ‡ç­¾é¡µæ•°æ®å¤±è´¥", e)
        }
    }

    /**
     * ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
     */
    private fun ensureDataConsistency() {
        try {
            // æ¸…ç†æ— æ•ˆçš„AIè”ç³»äººå¼•ç”¨
            allContacts.forEach { category ->
                val validContacts = category.contacts.filter { contact ->
                    // ä¿ç•™æœ‰æ•ˆçš„AIè”ç³»äºº
                    contact.type == ContactType.AI &&
                    !contact.id.contains("hint") &&
                    !contact.id.contains("empty")
                }.toMutableList()

                if (validContacts.size != category.contacts.size) {
                    val updatedCategory = category.copy(contacts = validContacts)
                    val index = allContacts.indexOf(category)
                    allContacts[index] = updatedCategory
                    Log.d(TAG, "æ¸…ç†åˆ†ç»„ ${category.name} ä¸­çš„æ— æ•ˆè”ç³»äºº")
                }
            }

            // ç§»é™¤ç©ºçš„è‡ªå®šä¹‰åˆ†ç»„ï¼ˆä¿ç•™ç³»ç»Ÿåˆ†ç»„ï¼‰
            val categoriesToRemove = allContacts.filter { category ->
                category.contacts.isEmpty() &&
                category.name != "å…¨éƒ¨" &&
                category.name != "AIåŠ©æ‰‹" &&
                category.name != "æç¤º"
            }

            categoriesToRemove.forEach { category ->
                allContacts.remove(category)
                Log.d(TAG, "ç§»é™¤ç©ºåˆ†ç»„: ${category.name}")
            }

        } catch (e: Exception) {
            Log.e(TAG, "ç¡®ä¿æ•°æ®ä¸€è‡´æ€§å¤±è´¥", e)
        }
    }

    // å·²ç§»é™¤markAllAIsAsUnread()æ–¹æ³• - ä¸å†æä¾›æ‰¹é‡æ ‡è®°æœªè¯»åŠŸèƒ½

    /**
     * æ˜¾ç¤ºAIåŠ©æ‰‹åˆ†ç»„ç®¡ç†
     */
    private fun showAIAssistantGroupManagement(tab: com.google.android.material.tabs.TabLayout.Tab) {
        try {
            val aiAssistantCategory = allContacts.find { it.name == "AIåŠ©æ‰‹" }
            val aiCount = aiAssistantCategory?.contacts?.size ?: 0

            val options = arrayOf(
                "ğŸ“Š æŸ¥çœ‹åˆ†ç»„ä¿¡æ¯",
                "âœï¸ é‡å‘½ååˆ†ç»„",
                "ğŸ”” è®¾ä¸ºæœªè¯»",
                "ğŸ—‘ï¸ åˆ é™¤åˆ†ç»„"
            )

            AlertDialog.Builder(this, R.style.Theme_MaterialDialog)
                .setTitle("ç®¡ç†AIåŠ©æ‰‹åˆ†ç»„")
                .setItems(options) { _, which ->
                    when (which) {
                        0 -> showAIAssistantGroupInfo(aiCount)
                        1 -> showRenameGroupDialog(tab, "AIåŠ©æ‰‹")
                        2 -> markAIAssistantGroupAsUnread()
                        3 -> showDeleteAIAssistantGroupDialog(tab, aiCount)
                    }
                }
                .setNegativeButton("å–æ¶ˆ", null)
                .show()
        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºAIåŠ©æ‰‹åˆ†ç»„ç®¡ç†å¤±è´¥", e)
        }
    }

    /**
     * æ˜¾ç¤ºAIåŠ©æ‰‹åˆ†ç»„ä¿¡æ¯
     */
    private fun showAIAssistantGroupInfo(aiCount: Int) {
        try {
            val aiAssistantCategory = allContacts.find { it.name == "AIåŠ©æ‰‹" }
            val aiList = aiAssistantCategory?.contacts?.joinToString("\n") { "â€¢ ${it.name}" } ?: "æ— "

            val message = """
                ğŸ¤– AIåŠ©æ‰‹åˆ†ç»„ä¿¡æ¯

                è¿™æ˜¯æ‚¨çš„ä¸“å±AIåŠ©æ‰‹åˆ†ç»„
                å½“å‰åŒ…å«: $aiCount ä¸ªAIåŠ©æ‰‹

                åŒ…å«çš„AI:
                $aiList

                ğŸ’¡ æ‚¨å¯ä»¥ï¼š
                â€¢ é•¿æŒ‰å…¶ä»–åˆ†ç»„ä¸­çš„AIç§»åŠ¨åˆ°è¿™é‡Œ
                â€¢ é‡å‘½åæˆ–åˆ é™¤è¿™ä¸ªåˆ†ç»„
                â€¢ åœ¨æœç´¢æ—¶åªå‘æ­¤åˆ†ç»„ä¸­çš„AIæé—®
            """.trimIndent()

            AlertDialog.Builder(this, R.style.Theme_MaterialDialog)
                .setTitle("AIåŠ©æ‰‹åˆ†ç»„")
                .setMessage(message)
                .setPositiveButton("ç¡®å®š", null)
                .show()
        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºAIåŠ©æ‰‹åˆ†ç»„ä¿¡æ¯å¤±è´¥", e)
        }
    }

    /**
     * æ˜¾ç¤ºåˆ é™¤AIåŠ©æ‰‹åˆ†ç»„å¯¹è¯æ¡†
     */
    private fun showDeleteAIAssistantGroupDialog(tab: com.google.android.material.tabs.TabLayout.Tab, aiCount: Int) {
        try {
            val message = if (aiCount > 0) {
                "AIåŠ©æ‰‹åˆ†ç»„ä¸­è¿˜æœ‰ $aiCount ä¸ªAIåŠ©æ‰‹ã€‚\n\nåˆ é™¤åˆ†ç»„åï¼Œè¿™äº›AIå°†å›åˆ°\"å…¨éƒ¨\"æ ‡ç­¾ä¸­ã€‚\n\nç¡®å®šè¦åˆ é™¤AIåŠ©æ‰‹åˆ†ç»„å—ï¼Ÿ"
            } else {
                "ç¡®å®šè¦åˆ é™¤ç©ºçš„AIåŠ©æ‰‹åˆ†ç»„å—ï¼Ÿ\n\nåˆ é™¤åï¼Œæ‚¨å¯ä»¥é‡æ–°åˆ›å»ºæ–°çš„åˆ†ç»„ã€‚"
            }

            AlertDialog.Builder(this, R.style.Theme_MaterialDialog)
                .setTitle("åˆ é™¤AIåŠ©æ‰‹åˆ†ç»„")
                .setMessage(message)
                .setPositiveButton("åˆ é™¤") { _, _ ->
                    deleteAIAssistantGroup(tab)
                }
                .setNegativeButton("å–æ¶ˆ", null)
                .show()
        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºåˆ é™¤AIåŠ©æ‰‹åˆ†ç»„å¯¹è¯æ¡†å¤±è´¥", e)
        }
    }

    /**
     * åˆ é™¤AIåŠ©æ‰‹åˆ†ç»„
     */
    private fun deleteAIAssistantGroup(tab: com.google.android.material.tabs.TabLayout.Tab) {
        try {
            // æ‰¾åˆ°AIåŠ©æ‰‹åˆ†ç»„
            val aiAssistantCategory = allContacts.find { it.name == "AIåŠ©æ‰‹" }
            if (aiAssistantCategory != null) {
                // AIåŠ©æ‰‹åˆ†ç»„ä¸­çš„AIå°†ä¿ç•™åœ¨ç³»ç»Ÿä¸­ï¼Œä½†ä¸å†å±äºä»»ä½•ç‰¹å®šåˆ†ç»„
                // å®ƒä»¬å°†åœ¨"å…¨éƒ¨"æ ‡ç­¾ä¸­æ˜¾ç¤º
                Log.d(TAG, "AIåŠ©æ‰‹åˆ†ç»„ä¸­æœ‰ ${aiAssistantCategory.contacts.size} ä¸ªAIå°†ä¿ç•™åœ¨å…¨éƒ¨æ ‡ç­¾ä¸­")

                // ç§»é™¤AIåŠ©æ‰‹åˆ†ç»„
                allContacts.remove(aiAssistantCategory)

                // ä¿å­˜è”ç³»äººæ•°æ®
                saveContacts()
            }

            // è®°å½•ç”¨æˆ·ä¸»åŠ¨åˆ é™¤äº†AIåŠ©æ‰‹åˆ†ç»„ï¼Œå¹¶æ¸…ç†ç›¸å…³æ•°æ®
            val prefs = getSharedPreferences("custom_tabs", MODE_PRIVATE)
            prefs.edit()
                .putBoolean("ai_assistant_group_deleted", true)
                .remove("ai_assistant_group_contacts") // æ¸…ç†AIåŠ©æ‰‹åˆ†ç»„çš„è”ç³»äººæ•°æ®
                .apply()

            Log.d(TAG, "æ¸…ç†AIåŠ©æ‰‹åˆ†ç»„ç›¸å…³æ•°æ®")

            // ä»TabLayoutä¸­ç§»é™¤æ ‡ç­¾
            val chatTabLayout = findViewById<com.google.android.material.tabs.TabLayout>(R.id.chat_tab_layout)
            chatTabLayout?.removeTab(tab)

            // ä»SharedPreferencesä¸­ç§»é™¤AIåŠ©æ‰‹æ ‡ç­¾é¡µé…ç½®
            removeCustomTabFromPreferences("AIåŠ©æ‰‹")

            // åˆ‡æ¢åˆ°"å…¨éƒ¨"æ ‡ç­¾é¡µ
            chatTabLayout?.getTabAt(0)?.select()

            // å»¶è¿Ÿåˆ·æ–°æ˜¾ç¤ºï¼Œé¿å…ç«‹å³è§¦å‘å¼¹çª—
            Handler(Looper.getMainLooper()).postDelayed({
                showAllUserAIContacts() // ç›´æ¥æ˜¾ç¤ºå…¨éƒ¨AIï¼Œé¿å…è§¦å‘ç®¡ç†å¼¹çª—
                Log.d(TAG, "åˆ é™¤AIåŠ©æ‰‹åˆ†ç»„ååˆ·æ–°å…¨éƒ¨æ ‡ç­¾é¡µæ˜¾ç¤ºå®Œæˆ")
            }, 300)

            Toast.makeText(this, "AIåŠ©æ‰‹åˆ†ç»„å·²åˆ é™¤ï¼ŒAIå·²å›åˆ°\"å…¨éƒ¨\"ä¸­", Toast.LENGTH_SHORT).show()
            Log.d(TAG, "åˆ é™¤AIåŠ©æ‰‹åˆ†ç»„å®Œæˆ")

        } catch (e: Exception) {
            Log.e(TAG, "åˆ é™¤AIåŠ©æ‰‹åˆ†ç»„å¤±è´¥", e)
            Toast.makeText(this, "åˆ é™¤å¤±è´¥", Toast.LENGTH_SHORT).show()
        }
    }

    /**
     * æ˜¾ç¤ºè‡ªå®šä¹‰åˆ†ç»„ç®¡ç†
     */
    private fun showCustomGroupManagement(tab: com.google.android.material.tabs.TabLayout.Tab) {
        try {
            val groupName = tab.text?.toString() ?: return
            val category = allContacts.find { it.name == groupName }
            val aiCount = category?.contacts?.size ?: 0

            val options = arrayOf(
                "ğŸ“Š æŸ¥çœ‹åˆ†ç»„ä¿¡æ¯",
                "âœï¸ é‡å‘½ååˆ†ç»„",
                "ğŸ”” è®¾ä¸ºæœªè¯»",
                "ğŸ—‘ï¸ åˆ é™¤åˆ†ç»„"
            )

            AlertDialog.Builder(this, R.style.Theme_MaterialDialog)
                .setTitle("ç®¡ç†åˆ†ç»„: $groupName")
                .setItems(options) { _, which ->
                    when (which) {
                        0 -> showGroupInfo(groupName, aiCount)
                        1 -> showRenameGroupDialog(tab, groupName)
                        2 -> markCustomGroupAsUnread(groupName)
                        3 -> showDeleteGroupDialog(tab, groupName, aiCount)
                    }
                }
                .setNegativeButton("å–æ¶ˆ", null)
                .show()
        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºè‡ªå®šä¹‰åˆ†ç»„ç®¡ç†å¤±è´¥", e)
        }
    }

    /**
     * æ˜¾ç¤ºåˆ†ç»„ä¿¡æ¯
     */
    private fun showGroupInfo(groupName: String, aiCount: Int) {
        try {
            val category = allContacts.find { it.name == groupName }
            val aiList = category?.contacts?.joinToString("\n") { "â€¢ ${it.name}" } ?: "æ— "

            val message = """
                ğŸ“ åˆ†ç»„ä¿¡æ¯

                åˆ†ç»„åç§°: $groupName
                AIæ•°é‡: $aiCount

                åŒ…å«çš„AI:
                $aiList

                ğŸ’¡ æ‚¨å¯ä»¥é€šè¿‡é•¿æŒ‰AIæ¥ç§»åŠ¨å®ƒä»¬åˆ°å…¶ä»–åˆ†ç»„
            """.trimIndent()

            AlertDialog.Builder(this, R.style.Theme_MaterialDialog)
                .setTitle("åˆ†ç»„è¯¦æƒ…")
                .setMessage(message)
                .setPositiveButton("ç¡®å®š", null)
                .show()
        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºåˆ†ç»„ä¿¡æ¯å¤±è´¥", e)
        }
    }

    /**
     * æ˜¾ç¤ºé‡å‘½ååˆ†ç»„å¯¹è¯æ¡†
     */
    private fun showRenameGroupDialog(tab: com.google.android.material.tabs.TabLayout.Tab, currentName: String) {
        try {
            val input = android.widget.EditText(this).apply {
                hint = "è¾“å…¥æ–°çš„åˆ†ç»„åç§°"
                setText(currentName)
                selectAll()
                setPadding(50, 30, 50, 30)
            }

            AlertDialog.Builder(this, R.style.Theme_MaterialDialog)
                .setTitle("é‡å‘½ååˆ†ç»„")
                .setMessage("ä¸ºåˆ†ç»„è¾“å…¥æ–°åç§°")
                .setView(input)
                .setPositiveButton("ç¡®å®š") { _, _ ->
                    val newName = input.text.toString().trim()
                    if (newName.isNotEmpty() && newName != currentName) {
                        renameGroup(tab, currentName, newName)
                    } else if (newName.isEmpty()) {
                        Toast.makeText(this, "åˆ†ç»„åç§°ä¸èƒ½ä¸ºç©º", Toast.LENGTH_SHORT).show()
                    }
                }
                .setNegativeButton("å–æ¶ˆ", null)
                .show()
        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºé‡å‘½ååˆ†ç»„å¯¹è¯æ¡†å¤±è´¥", e)
        }
    }

    /**
     * æ˜¾ç¤ºåˆ é™¤åˆ†ç»„å¯¹è¯æ¡†
     */
    private fun showDeleteGroupDialog(tab: com.google.android.material.tabs.TabLayout.Tab, groupName: String, aiCount: Int) {
        try {
            val message = if (aiCount > 0) {
                "åˆ†ç»„ \"$groupName\" ä¸­è¿˜æœ‰ $aiCount ä¸ªAIåŠ©æ‰‹ã€‚\n\nåˆ é™¤åˆ†ç»„åï¼Œè¿™äº›AIå°†è¢«ç§»åŠ¨åˆ°\"AIåŠ©æ‰‹\"åˆ†ç»„ä¸­ã€‚\n\nç¡®å®šè¦åˆ é™¤è¿™ä¸ªåˆ†ç»„å—ï¼Ÿ"
            } else {
                "ç¡®å®šè¦åˆ é™¤ç©ºåˆ†ç»„ \"$groupName\" å—ï¼Ÿ"
            }

            AlertDialog.Builder(this, R.style.Theme_MaterialDialog)
                .setTitle("åˆ é™¤åˆ†ç»„")
                .setMessage(message)
                .setPositiveButton("åˆ é™¤") { _, _ ->
                    deleteGroup(tab, groupName)
                }
                .setNegativeButton("å–æ¶ˆ", null)
                .show()
        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºåˆ é™¤åˆ†ç»„å¯¹è¯æ¡†å¤±è´¥", e)
        }
    }

    /**
     * é‡å‘½ååˆ†ç»„
     */
    private fun renameGroup(tab: com.google.android.material.tabs.TabLayout.Tab, oldName: String, newName: String) {
        try {
            // æ£€æŸ¥æ–°åç§°æ˜¯å¦å·²å­˜åœ¨
            val existingCategory = allContacts.find { it.name == newName }
            if (existingCategory != null) {
                Toast.makeText(this, "åˆ†ç»„ \"$newName\" å·²å­˜åœ¨", Toast.LENGTH_SHORT).show()
                return
            }

            // æ›´æ–°ContactCategoryä¸­çš„åç§°
            val categoryIndex = allContacts.indexOfFirst { it.name == oldName }
            if (categoryIndex != -1) {
                val oldCategory = allContacts[categoryIndex]
                val newCategory = oldCategory.copy(name = newName)
                allContacts[categoryIndex] = newCategory
            }

            // æ›´æ–°TabLayoutä¸­çš„æ ‡ç­¾æ–‡æœ¬
            tab.text = newName

            // æ›´æ–°SharedPreferencesä¸­çš„è‡ªå®šä¹‰æ ‡ç­¾é¡µé…ç½®
            updateCustomTabName(oldName, newName)

            // ä¿å­˜è”ç³»äººæ•°æ®
            saveContacts()

            Toast.makeText(this, "åˆ†ç»„å·²é‡å‘½åä¸º \"$newName\"", Toast.LENGTH_SHORT).show()
            Log.d(TAG, "é‡å‘½ååˆ†ç»„: $oldName -> $newName")

        } catch (e: Exception) {
            Log.e(TAG, "é‡å‘½ååˆ†ç»„å¤±è´¥", e)
            Toast.makeText(this, "é‡å‘½åå¤±è´¥", Toast.LENGTH_SHORT).show()
        }
    }

    /**
     * åˆ é™¤åˆ†ç»„
     */
    private fun deleteGroup(tab: com.google.android.material.tabs.TabLayout.Tab, groupName: String) {
        try {
            // æ‰¾åˆ°è¦åˆ é™¤çš„åˆ†ç»„
            val categoryToDelete = allContacts.find { it.name == groupName }
            if (categoryToDelete != null) {
                // å¦‚æœåˆ†ç»„ä¸­æœ‰AIï¼Œå°†å®ƒä»¬ç§»åŠ¨åˆ°"AIåŠ©æ‰‹"åˆ†ç»„
                if (categoryToDelete.contacts.isNotEmpty()) {
                    val aiAssistantCategory = allContacts.find { it.name == "AIåŠ©æ‰‹" }
                    if (aiAssistantCategory != null) {
                        val updatedContacts = aiAssistantCategory.contacts.toMutableList()
                        updatedContacts.addAll(categoryToDelete.contacts)
                        val updatedCategory = aiAssistantCategory.copy(contacts = updatedContacts)
                        val index = allContacts.indexOf(aiAssistantCategory)
                        allContacts[index] = updatedCategory
                    } else {
                        // å¦‚æœ"AIåŠ©æ‰‹"åˆ†ç»„ä¸å­˜åœ¨ï¼Œåˆ›å»ºå®ƒ
                        val newAIAssistantCategory = ContactCategory(
                            name = "AIåŠ©æ‰‹",
                            contacts = categoryToDelete.contacts,
                            isExpanded = true
                        )
                        allContacts.add(newAIAssistantCategory)

                        // ç¡®ä¿AIåŠ©æ‰‹æ ‡ç­¾é¡µå­˜åœ¨
                        ensureAIAssistantTabExists()
                    }
                }

                // ä»allContactsä¸­ç§»é™¤åˆ†ç»„
                allContacts.remove(categoryToDelete)
            }

            // ä»TabLayoutä¸­ç§»é™¤æ ‡ç­¾
            val chatTabLayout = findViewById<com.google.android.material.tabs.TabLayout>(R.id.chat_tab_layout)
            chatTabLayout?.removeTab(tab)

            // ä»SharedPreferencesä¸­ç§»é™¤è‡ªå®šä¹‰æ ‡ç­¾é¡µé…ç½®
            removeCustomTabFromPreferences(groupName)

            // ä¿å­˜è”ç³»äººæ•°æ®
            saveContacts()

            // åˆ‡æ¢åˆ°"å…¨éƒ¨"æ ‡ç­¾é¡µ
            chatTabLayout?.getTabAt(0)?.select()

            // å»¶è¿Ÿåˆ·æ–°æ˜¾ç¤ºï¼Œé¿å…ç«‹å³è§¦å‘å¼¹çª—
            Handler(Looper.getMainLooper()).postDelayed({
                showAllUserAIContacts() // ç›´æ¥æ˜¾ç¤ºå…¨éƒ¨AIï¼Œé¿å…è§¦å‘ç®¡ç†å¼¹çª—
                Log.d(TAG, "åˆ é™¤åˆ†ç»„ååˆ·æ–°å…¨éƒ¨æ ‡ç­¾é¡µæ˜¾ç¤ºå®Œæˆ")
            }, 300)

            Toast.makeText(this, "åˆ†ç»„ \"$groupName\" å·²åˆ é™¤", Toast.LENGTH_SHORT).show()
            Log.d(TAG, "åˆ é™¤åˆ†ç»„: $groupName")

        } catch (e: Exception) {
            Log.e(TAG, "åˆ é™¤åˆ†ç»„å¤±è´¥", e)
            Toast.makeText(this, "åˆ é™¤å¤±è´¥", Toast.LENGTH_SHORT).show()
        }
    }

    /**
     * æ›´æ–°è‡ªå®šä¹‰æ ‡ç­¾é¡µåç§°
     */
    private fun updateCustomTabName(oldName: String, newName: String) {
        try {
            val prefs = getSharedPreferences("custom_tabs", MODE_PRIVATE)
            val customTabs = prefs.getString("custom_ai_tabs", "") ?: ""

            if (customTabs.isNotEmpty()) {
                val tabNames = customTabs.split(",").toMutableList()
                val index = tabNames.indexOf(oldName)
                if (index != -1) {
                    tabNames[index] = newName
                    prefs.edit().putString("custom_ai_tabs", tabNames.joinToString(",")).apply()
                }
            }
        } catch (e: Exception) {
            Log.e(TAG, "æ›´æ–°è‡ªå®šä¹‰æ ‡ç­¾é¡µåç§°å¤±è´¥", e)
        }
    }

    /**
     * ä»SharedPreferencesä¸­ç§»é™¤è‡ªå®šä¹‰æ ‡ç­¾é¡µ
     */
    private fun removeCustomTabFromPreferences(groupName: String) {
        try {
            val prefs = getSharedPreferences("custom_tabs", MODE_PRIVATE)
            val editor = prefs.edit()

            // 1. ä»custom_ai_tabsä¸­ç§»é™¤
            val customTabs = prefs.getString("custom_ai_tabs", "") ?: ""
            if (customTabs.isNotEmpty()) {
                val tabNames = customTabs.split(",").toMutableList()
                tabNames.remove(groupName)
                editor.putString("custom_ai_tabs", tabNames.joinToString(","))
            }

            // 2. ä»all_tab_orderä¸­ç§»é™¤
            val allTabOrder = prefs.getString("all_tab_order", "") ?: ""
            if (allTabOrder.isNotEmpty()) {
                val allTabs = allTabOrder.split(",").toMutableList()
                allTabs.remove(groupName)
                editor.putString("all_tab_order", allTabs.joinToString(","))
            }

            editor.apply()
            Log.d(TAG, "ä»SharedPreferencesä¸­ç§»é™¤æ ‡ç­¾é¡µ: $groupName")

        } catch (e: Exception) {
            Log.e(TAG, "ä»SharedPreferencesä¸­ç§»é™¤è‡ªå®šä¹‰æ ‡ç­¾é¡µå¤±è´¥", e)
        }
    }

    /**
     * ä¿å­˜è‡ªå®šä¹‰æ ‡ç­¾é¡µé…ç½®
     */
    private fun saveCustomTabConfiguration(tabName: String) {
        try {
            val prefs = getSharedPreferences("custom_tabs", MODE_PRIVATE)
            val existingTabs = prefs.getString("custom_ai_tabs", "") ?: ""

            val tabList = if (existingTabs.isNotEmpty()) {
                existingTabs.split(",").toMutableList()
            } else {
                mutableListOf()
            }

            if (!tabList.contains(tabName)) {
                tabList.add(tabName)
                prefs.edit().putString("custom_ai_tabs", tabList.joinToString(",")).apply()
            }
        } catch (e: Exception) {
            Log.e(TAG, "ä¿å­˜è‡ªå®šä¹‰æ ‡ç­¾é¡µé…ç½®å¤±è´¥", e)
        }
    }

    /**
     * ä»åˆ†ç»„ä¸­ç§»é™¤è”ç³»äººï¼ˆå›åˆ°"å…¨éƒ¨"æ ‡ç­¾ä¸‹ï¼‰
     */
    private fun removeContactFromGroup(contact: ChatContact) {
        try {
            // ä»å½“å‰åˆ†ç»„ä¸­ç§»é™¤
            val currentGroup = findContactGroup(contact)
            if (currentGroup != null && currentGroup != "æœªåˆ†ç»„") {
                val currentCategory = allContacts.find { it.name == currentGroup }
                if (currentCategory != null) {
                    val updatedContacts = currentCategory.contacts.filter { it.id != contact.id }.toMutableList()
                    val updatedCategory = currentCategory.copy(contacts = updatedContacts)
                    val index = allContacts.indexOf(currentCategory)
                    allContacts[index] = updatedCategory

                    // å¦‚æœåˆ†ç»„å˜ç©ºä¸”ä¸æ˜¯é¢„è®¾åˆ†ç»„ï¼Œç§»é™¤å¯¹åº”æ ‡ç­¾é¡µ
                    if (updatedContacts.isEmpty() &&
                        currentGroup != "AIåŠ©æ‰‹" &&
                        currentGroup != "å…¨éƒ¨" &&
                        currentGroup != "æœªåˆ†ç»„") {
                        Log.d(TAG, "åˆ†ç»„ $currentGroup å·²ç©ºï¼Œç§»é™¤å¯¹åº”æ ‡ç­¾é¡µ")
                        removeEmptyGroupTab(currentGroup)
                    }

                    // ä¿å­˜æ›´æ”¹
                    saveContacts()

                    // åˆ·æ–°å½“å‰æ˜¾ç¤ºï¼ˆä¸åˆ‡æ¢åˆ°"å…¨éƒ¨"æ ‡ç­¾é¡µï¼Œé¿å…å¼¹çª—ï¼‰
                    refreshCurrentTabDisplay()

                    // æ›´æ–°é€‚é…å™¨
                    chatContactAdapter?.updateContacts(allContacts)

                    Toast.makeText(this, "âœ… ${contact.name} å·²ç§»é™¤åˆ†ç»„ï¼Œç°åœ¨åœ¨\"å…¨éƒ¨\"ä¸­", Toast.LENGTH_LONG).show()
                    Log.d(TAG, "ç§»é™¤è”ç³»äººåˆ†ç»„: ${contact.name} ä» $currentGroup")
                } else {
                    Toast.makeText(this, "âŒ æœªæ‰¾åˆ°è”ç³»äººæ‰€åœ¨çš„åˆ†ç»„", Toast.LENGTH_SHORT).show()
                }
            } else {
                Toast.makeText(this, "${contact.name} å·²ç»åœ¨\"å…¨éƒ¨\"ä¸­", Toast.LENGTH_SHORT).show()
            }

        } catch (e: Exception) {
            Log.e(TAG, "ç§»é™¤è”ç³»äººåˆ†ç»„å¤±è´¥", e)
            Toast.makeText(this, "âŒ ç§»é™¤åˆ†ç»„å¤±è´¥: ${e.message}", Toast.LENGTH_SHORT).show()
        }
    }

    /**
     * ç§»é™¤ç©ºåˆ†ç»„çš„æ ‡ç­¾é¡µ
     */
    private fun removeEmptyGroupTab(groupName: String) {
        try {
            val chatTabLayout = findViewById<com.google.android.material.tabs.TabLayout>(R.id.chat_tab_layout)

            // æŸ¥æ‰¾å¹¶ç§»é™¤å¯¹åº”çš„æ ‡ç­¾é¡µ
            for (i in 0 until (chatTabLayout?.tabCount ?: 0)) {
                val tab = chatTabLayout?.getTabAt(i)
                if (tab?.text?.toString() == groupName) {
                    chatTabLayout?.removeTabAt(i)
                    Log.d(TAG, "ç§»é™¤ç©ºåˆ†ç»„æ ‡ç­¾é¡µ: $groupName")
                    break
                }
            }
        } catch (e: Exception) {
            Log.e(TAG, "ç§»é™¤ç©ºåˆ†ç»„æ ‡ç­¾é¡µå¤±è´¥", e)
        }
    }

    /**
     * è·å–æ‰€æœ‰å¯ç”¨çš„AIåŠ©æ‰‹åˆ—è¡¨ï¼ˆä»å­˜å‚¨çš„æ•°æ®ä¸­è·å–ï¼Œä¿æŒçŠ¶æ€ä¸€è‡´æ€§ï¼‰
     */
    private fun getAllAvailableAIs(): List<ChatContact> {
        return try {
            val availableAIs = mutableListOf<ChatContact>()

            // å®šä¹‰æ‰€æœ‰å¯ç”¨çš„AIåŠ©æ‰‹
            val aiDefinitions = listOf(
                "DeepSeek" to "ğŸš€ DeepSeek - æ€§èƒ½å¼ºåŠ²ï¼Œæ”¯æŒä¸­æ–‡",
                "ChatGPT" to "ğŸ¤– ChatGPT - OpenAIçš„ç»å…¸æ¨¡å‹",
                "Claude" to "ğŸ’¡ Claude - Anthropicçš„æ™ºèƒ½åŠ©æ‰‹",
                "Gemini" to "ğŸŒŸ Gemini - Googleçš„AIåŠ©æ‰‹",
                "æ™ºè°±AI" to "ğŸ§  æ™ºè°±AI - GLM-4å¤§è¯­è¨€æ¨¡å‹",
                "æ–‡å¿ƒä¸€è¨€" to "ğŸ“š æ–‡å¿ƒä¸€è¨€ - ç™¾åº¦çš„å¤§è¯­è¨€æ¨¡å‹",
                "é€šä¹‰åƒé—®" to "ğŸ¯ é€šä¹‰åƒé—® - é˜¿é‡Œå·´å·´çš„AI",
                "è®¯é£æ˜Ÿç«" to "âš¡ è®¯é£æ˜Ÿç« - ç§‘å¤§è®¯é£çš„AI",
                "Kimi" to "ğŸŒ™ Kimi - Moonshotçš„é•¿æ–‡æœ¬ä¸“å®¶"
            )

            aiDefinitions.forEach { (aiName, description) ->
                // ä½¿ç”¨ä¸çµåŠ¨å²›ç›¸åŒçš„IDç”Ÿæˆé€»è¾‘
                val processedName = if (aiName.contains(Regex("[\\u4e00-\\u9fff]"))) {
                    // åŒ…å«ä¸­æ–‡å­—ç¬¦ï¼Œç›´æ¥ä½¿ç”¨åŸåç§°
                    aiName
                } else {
                    // è‹±æ–‡å­—ç¬¦ï¼Œè½¬æ¢ä¸ºå°å†™
                    aiName.lowercase()
                }
                val aiId = "ai_${processedName.replace(" ", "_")}"
                
                Log.d(TAG, "getAllAvailableAIs - AIåç§°: $aiName, è”ç³»äººID: $aiId")

                // é¦–å…ˆå°è¯•ä»allContactsä¸­æ‰¾åˆ°å·²å­˜åœ¨çš„AIè”ç³»äºº
                var existingContact: ChatContact? = null
                allContacts.forEach { category ->
                    val found = category.contacts.find { it.id == aiId }
                    if (found != null) {
                        existingContact = found
                        return@forEach
                    }
                }

                val apiKey = getApiKeyForAI(aiName)
                val isConfigured = apiKey.isNotEmpty()

                val contact = if (existingContact != null) {
                    // å¦‚æœå·²å­˜åœ¨ï¼Œæ›´æ–°APIé…ç½®ä¿¡æ¯ä½†ä¿æŒå…¶ä»–çŠ¶æ€
                    existingContact!!.copy(
                        isOnline = isConfigured,
                        lastMessage = if (isConfigured) "APIå·²é…ç½®ï¼Œå¯ä»¥å¼€å§‹å¯¹è¯" else "ç‚¹å‡»é…ç½®APIå¯†é’¥",
                        customData = mapOf(
                            "api_url" to getDefaultApiUrl(aiName),
                            "api_key" to apiKey,
                            "model" to getDefaultModel(aiName),
                            "is_configured" to isConfigured.toString()
                        )
                    )
                } else {
                    // å¦‚æœä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°çš„AIè”ç³»äºº
                    ChatContact(
                        id = aiId,
                        name = aiName,
                        type = ContactType.AI,
                        description = description,
                        isOnline = isConfigured,
                        lastMessage = if (isConfigured) "APIå·²é…ç½®ï¼Œå¯ä»¥å¼€å§‹å¯¹è¯" else "ç‚¹å‡»é…ç½®APIå¯†é’¥",
                        lastMessageTime = System.currentTimeMillis(),
                        unreadCount = 0,
                        isPinned = false,
                        customData = mapOf(
                            "api_url" to getDefaultApiUrl(aiName),
                            "api_key" to apiKey,
                            "model" to getDefaultModel(aiName),
                            "is_configured" to isConfigured.toString()
                        ),
                        aiMembers = emptyList()
                    )
                }
                availableAIs.add(contact)
            }

            availableAIs
        } catch (e: Exception) {
            Log.e(TAG, "è·å–æ‰€æœ‰å¯ç”¨AIå¤±è´¥", e)
            emptyList()
        }
    }

    /**
     * æ˜¾ç¤ºåˆ†ç»„ç®¡ç†å¯¹è¯æ¡†ï¼ˆé•¿æŒ‰åˆ†ç»„åç§°è§¦å‘ï¼‰
     */
    private fun showCategoryManagementDialog(category: ContactCategory) {
        try {
            val groupName = category.name
            val aiCount = category.contacts.size

            // åªæœ‰ç”¨æˆ·åˆ›å»ºçš„åˆ†ç»„å’ŒAIåŠ©æ‰‹åˆ†ç»„æ‰æ˜¾ç¤ºç®¡ç†é€‰é¡¹
            if (groupName == "å…¨éƒ¨" || groupName == "æç¤º" || groupName == "æœªåˆ†ç»„") {
                Log.d(TAG, "ç³»ç»Ÿåˆ†ç»„ä¸æ”¯æŒç®¡ç†æ“ä½œ: $groupName")
                return
            }

            // æ ¹æ®åˆ†ç»„ç±»å‹æ˜¾ç¤ºä¸åŒçš„ç®¡ç†é€‰é¡¹
            val options = when (groupName) {
                "AIåŠ©æ‰‹" -> {
                    // "AIåŠ©æ‰‹"åˆ†ç»„å¯ä»¥é‡å‘½åã€åˆ é™¤ã€æ ‡ä¸ºæœªè¯»
                    arrayOf(
                        "ğŸ“Š æŸ¥çœ‹åˆ†ç»„ä¿¡æ¯ ($aiCount ä¸ªAI)",
                        "âœï¸ é‡å‘½ååˆ†ç»„",
                        "ğŸ”” æ ‡ä¸ºæœªè¯»",
                        "ğŸ—‘ï¸ åˆ é™¤åˆ†ç»„"
                    )
                }
                else -> {
                    // è‡ªå®šä¹‰åˆ†ç»„å¯ä»¥é‡å‘½åã€åˆ é™¤ã€æ ‡ä¸ºæœªè¯»
                    arrayOf(
                        "ğŸ“Š æŸ¥çœ‹åˆ†ç»„ä¿¡æ¯ ($aiCount ä¸ªAI)",
                        "âœï¸ é‡å‘½ååˆ†ç»„",
                        "ğŸ”” æ ‡ä¸ºæœªè¯»",
                        "ğŸ—‘ï¸ åˆ é™¤åˆ†ç»„"
                    )
                }
            }

            AlertDialog.Builder(this, R.style.Theme_MaterialDialog)
                .setTitle("ç®¡ç†åˆ†ç»„: $groupName")
                .setItems(options) { _, which ->
                    when (options[which]) {
                        "ğŸ“Š æŸ¥çœ‹åˆ†ç»„ä¿¡æ¯" -> showCategoryInfo(category)
                        "âœï¸ é‡å‘½ååˆ†ç»„" -> showRenameCategoryDialog(category)
                        "ğŸ“Œ ç½®é¡¶åˆ†ç»„" -> toggleCategoryPin(category, true)
                        "ğŸ”” æ ‡ä¸ºæœªè¯»" -> markCategoryAsUnread(category)
                        "ğŸ—‘ï¸ åˆ é™¤åˆ†ç»„" -> showDeleteCategoryDialog(category)
                    }
                }
                .setNegativeButton("å–æ¶ˆ", null)
                .show()
        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºåˆ†ç»„ç®¡ç†å¯¹è¯æ¡†å¤±è´¥", e)
        }
    }

    /**
     * æ˜¾ç¤ºåˆ†ç»„ä¿¡æ¯
     */
    private fun showCategoryInfo(category: ContactCategory) {
        try {
            val aiList = category.contacts.joinToString("\n") { "â€¢ ${it.name}" }
            val configuredCount = category.contacts.count { it.isOnline }

            val message = """
                ğŸ“ åˆ†ç»„è¯¦æƒ…

                åˆ†ç»„åç§°: ${category.name}
                AIæ•°é‡: ${category.contacts.size}
                å·²é…ç½®: $configuredCount
                æœªé…ç½®: ${category.contacts.size - configuredCount}

                åŒ…å«çš„AI:
                ${if (aiList.isNotEmpty()) aiList else "æ— "}

                ğŸ’¡ æ‚¨å¯ä»¥ï¼š
                â€¢ é•¿æŒ‰AIç§»åŠ¨åˆ°å…¶ä»–åˆ†ç»„
                â€¢ é‡å‘½åæˆ–åˆ é™¤è¿™ä¸ªåˆ†ç»„
                â€¢ åœ¨æœç´¢æ—¶åªå‘æ­¤åˆ†ç»„ä¸­çš„AIæé—®
            """.trimIndent()

            AlertDialog.Builder(this, R.style.Theme_MaterialDialog)
                .setTitle("åˆ†ç»„ä¿¡æ¯")
                .setMessage(message)
                .setPositiveButton("ç¡®å®š", null)
                .show()
        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºåˆ†ç»„ä¿¡æ¯å¤±è´¥", e)
        }
    }

    /**
     * æ˜¾ç¤ºé‡å‘½ååˆ†ç»„å¯¹è¯æ¡†
     */
    private fun showRenameCategoryDialog(category: ContactCategory) {
        try {
            val input = android.widget.EditText(this).apply {
                hint = "è¾“å…¥æ–°çš„åˆ†ç»„åç§°"
                setText(category.name)
                selectAll()
                setPadding(50, 30, 50, 30)
            }

            AlertDialog.Builder(this, R.style.Theme_MaterialDialog)
                .setTitle("é‡å‘½ååˆ†ç»„")
                .setMessage("ä¸ºåˆ†ç»„è¾“å…¥æ–°åç§°")
                .setView(input)
                .setPositiveButton("ç¡®å®š") { _, _ ->
                    val newName = input.text.toString().trim()
                    if (newName.isNotEmpty() && newName != category.name) {
                        renameCategoryInData(category, newName)
                    } else if (newName.isEmpty()) {
                        Toast.makeText(this, "åˆ†ç»„åç§°ä¸èƒ½ä¸ºç©º", Toast.LENGTH_SHORT).show()
                    }
                }
                .setNegativeButton("å–æ¶ˆ", null)
                .show()
        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºé‡å‘½ååˆ†ç»„å¯¹è¯æ¡†å¤±è´¥", e)
        }
    }

    /**
     * ç½®é¡¶åˆ†ç»„
     */
    private fun toggleCategoryPin(category: ContactCategory, isPinned: Boolean) {
        try {
            // æ‰¾åˆ°åˆ†ç»„å¹¶æ›´æ–°ç½®é¡¶çŠ¶æ€
            val categoryIndex = allContacts.indexOfFirst { it.name == category.name }
            if (categoryIndex != -1) {
                val updatedCategory = category.copy(isPinned = isPinned)
                allContacts[categoryIndex] = updatedCategory

                // é‡æ–°æ’åºï¼šç½®é¡¶çš„åˆ†ç»„åœ¨å‰é¢
                allContacts.sortWith(compareByDescending<ContactCategory> { it.isPinned }
                    .thenBy { it.name })

                // ä¿å­˜æ›´æ”¹
                saveContacts()

                // åˆ·æ–°æ˜¾ç¤º
                refreshCurrentTabDisplay()

                val action = if (isPinned) "ç½®é¡¶" else "å–æ¶ˆç½®é¡¶"
                Toast.makeText(this, "åˆ†ç»„ \"${category.name}\" å·²$action", Toast.LENGTH_SHORT).show()
            }
        } catch (e: Exception) {
            Log.e(TAG, "ç½®é¡¶åˆ†ç»„å¤±è´¥", e)
            Toast.makeText(this, "æ“ä½œå¤±è´¥", Toast.LENGTH_SHORT).show()
        }
    }

    /**
     * æ ‡è®°åˆ†ç»„ä¸ºæœªè¯»
     */
    private fun markCategoryAsUnread(category: ContactCategory) {
        try {
            // å°†åˆ†ç»„ä¸­æ‰€æœ‰è”ç³»äººæ ‡è®°ä¸ºæœªè¯»
            val categoryIndex = allContacts.indexOfFirst { it.name == category.name }
            if (categoryIndex != -1) {
                val updatedContacts = category.contacts.map { contact ->
                    contact.copy(unreadCount = contact.unreadCount + 1)
                }.toMutableList()
                val updatedCategory = category.copy(contacts = updatedContacts)
                allContacts[categoryIndex] = updatedCategory

                // ä¿å­˜æ›´æ”¹
                saveContacts()

                // åˆ·æ–°æ˜¾ç¤º
                refreshCurrentTabDisplay()

                Toast.makeText(this, "åˆ†ç»„ \"${category.name}\" å·²æ ‡ä¸ºæœªè¯»", Toast.LENGTH_SHORT).show()
            }
        } catch (e: Exception) {
            Log.e(TAG, "æ ‡è®°åˆ†ç»„ä¸ºæœªè¯»å¤±è´¥", e)
            Toast.makeText(this, "æ“ä½œå¤±è´¥", Toast.LENGTH_SHORT).show()
        }
    }

    /**
     * æ˜¾ç¤ºåˆ é™¤åˆ†ç»„å¯¹è¯æ¡†
     */
    private fun showDeleteCategoryDialog(category: ContactCategory) {
        try {
            val message = if (category.contacts.isNotEmpty()) {
                "åˆ†ç»„ \"${category.name}\" ä¸­è¿˜æœ‰ ${category.contacts.size} ä¸ªAIåŠ©æ‰‹ã€‚\n\nåˆ é™¤åˆ†ç»„åï¼Œè¿™äº›AIå°†å›åˆ°\"å…¨éƒ¨\"æ ‡ç­¾ä¸­ã€‚\n\nç¡®å®šè¦åˆ é™¤è¿™ä¸ªåˆ†ç»„å—ï¼Ÿ"
            } else {
                "ç¡®å®šè¦åˆ é™¤ç©ºåˆ†ç»„ \"${category.name}\" å—ï¼Ÿ"
            }

            AlertDialog.Builder(this, R.style.Theme_MaterialDialog)
                .setTitle("åˆ é™¤åˆ†ç»„")
                .setMessage(message)
                .setPositiveButton("åˆ é™¤") { _, _ ->
                    deleteCategoryFromData(category)
                }
                .setNegativeButton("å–æ¶ˆ", null)
                .show()
        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºåˆ é™¤åˆ†ç»„å¯¹è¯æ¡†å¤±è´¥", e)
        }
    }

    /**
     * åœ¨æ•°æ®ä¸­é‡å‘½ååˆ†ç»„
     */
    private fun renameCategoryInData(category: ContactCategory, newName: String) {
        try {
            // æ£€æŸ¥æ–°åç§°æ˜¯å¦å·²å­˜åœ¨
            val existingCategory = allContacts.find { it.name == newName }
            if (existingCategory != null) {
                Toast.makeText(this, "åˆ†ç»„ \"$newName\" å·²å­˜åœ¨", Toast.LENGTH_SHORT).show()
                return
            }

            // æ›´æ–°ContactCategoryä¸­çš„åç§°
            val categoryIndex = allContacts.indexOfFirst { it.name == category.name }
            if (categoryIndex != -1) {
                val updatedCategory = category.copy(name = newName)
                allContacts[categoryIndex] = updatedCategory

                // æ›´æ–°TabLayoutä¸­çš„æ ‡ç­¾æ–‡æœ¬ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                val chatTabLayout = findViewById<com.google.android.material.tabs.TabLayout>(R.id.chat_tab_layout)
                for (i in 0 until (chatTabLayout?.tabCount ?: 0)) {
                    val tab = chatTabLayout?.getTabAt(i)
                    if (tab?.text?.toString() == category.name) {
                        tab.text = newName
                        break
                    }
                }

                // æ›´æ–°SharedPreferencesä¸­çš„è‡ªå®šä¹‰æ ‡ç­¾é¡µé…ç½®
                updateCustomTabName(category.name, newName)

                // ä¿å­˜è”ç³»äººæ•°æ®
                saveContacts()

                // åˆ·æ–°æ˜¾ç¤º
                refreshCurrentTabDisplay()

                Toast.makeText(this, "åˆ†ç»„å·²é‡å‘½åä¸º \"$newName\"", Toast.LENGTH_SHORT).show()
                Log.d(TAG, "é‡å‘½ååˆ†ç»„: ${category.name} -> $newName")
            }
        } catch (e: Exception) {
            Log.e(TAG, "é‡å‘½ååˆ†ç»„å¤±è´¥", e)
            Toast.makeText(this, "é‡å‘½åå¤±è´¥", Toast.LENGTH_SHORT).show()
        }
    }

    /**
     * ä»æ•°æ®ä¸­åˆ é™¤åˆ†ç»„
     */
    private fun deleteCategoryFromData(category: ContactCategory) {
        try {
            // ç§»é™¤åˆ†ç»„
            allContacts.remove(category)

            // ä»TabLayoutä¸­ç§»é™¤å¯¹åº”çš„æ ‡ç­¾ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            val chatTabLayout = findViewById<com.google.android.material.tabs.TabLayout>(R.id.chat_tab_layout)
            for (i in 0 until (chatTabLayout?.tabCount ?: 0)) {
                val tab = chatTabLayout?.getTabAt(i)
                if (tab?.text?.toString() == category.name) {
                    chatTabLayout?.removeTab(tab)
                    break
                }
            }

            // ä»SharedPreferencesä¸­ç§»é™¤è‡ªå®šä¹‰æ ‡ç­¾é¡µé…ç½®
            removeCustomTabFromPreferences(category.name)

            // ä¿å­˜è”ç³»äººæ•°æ®
            saveContacts()

            // åˆ‡æ¢åˆ°"å…¨éƒ¨"æ ‡ç­¾é¡µ
            chatTabLayout?.getTabAt(0)?.select()

            Toast.makeText(this, "åˆ†ç»„ \"${category.name}\" å·²åˆ é™¤", Toast.LENGTH_SHORT).show()
            Log.d(TAG, "åˆ é™¤åˆ†ç»„: ${category.name}")

        } catch (e: Exception) {
            Log.e(TAG, "åˆ é™¤åˆ†ç»„å¤±è´¥", e)
            Toast.makeText(this, "åˆ é™¤å¤±è´¥", Toast.LENGTH_SHORT).show()
        }
    }

    /**
     * å°†AIåŠ©æ‰‹åˆ†ç»„æ ‡è®°ä¸ºæœªè¯»
     */
    private fun markAIAssistantGroupAsUnread() {
        try {
            val aiAssistantCategory = allContacts.find { it.name == "AIåŠ©æ‰‹" }
            if (aiAssistantCategory != null) {
                val categoryIndex = allContacts.indexOf(aiAssistantCategory)
                val updatedContacts = aiAssistantCategory.contacts.map { contact ->
                    contact.copy(unreadCount = contact.unreadCount + 1)
                }.toMutableList()
                val updatedCategory = aiAssistantCategory.copy(contacts = updatedContacts)
                allContacts[categoryIndex] = updatedCategory

                // ä¿å­˜æ›´æ”¹
                saveContacts()

                // åˆ·æ–°æ˜¾ç¤º
                refreshCurrentTabDisplay()

                Toast.makeText(this, "AIåŠ©æ‰‹åˆ†ç»„å·²æ ‡è®°ä¸ºæœªè¯»", Toast.LENGTH_SHORT).show()
            } else {
                Toast.makeText(this, "AIåŠ©æ‰‹åˆ†ç»„ä¸å­˜åœ¨", Toast.LENGTH_SHORT).show()
            }
        } catch (e: Exception) {
            Log.e(TAG, "æ ‡è®°AIåŠ©æ‰‹åˆ†ç»„ä¸ºæœªè¯»å¤±è´¥", e)
            Toast.makeText(this, "æ“ä½œå¤±è´¥", Toast.LENGTH_SHORT).show()
        }
    }

    /**
     * å°†è‡ªå®šä¹‰åˆ†ç»„æ ‡è®°ä¸ºæœªè¯»
     */
    private fun markCustomGroupAsUnread(groupName: String) {
        try {
            val customCategory = allContacts.find { it.name == groupName }
            if (customCategory != null) {
                val categoryIndex = allContacts.indexOf(customCategory)
                val updatedContacts = customCategory.contacts.map { contact ->
                    contact.copy(unreadCount = contact.unreadCount + 1)
                }.toMutableList()
                val updatedCategory = customCategory.copy(contacts = updatedContacts)
                allContacts[categoryIndex] = updatedCategory

                // ä¿å­˜æ›´æ”¹
                saveContacts()

                // åˆ·æ–°æ˜¾ç¤º
                refreshCurrentTabDisplay()

                Toast.makeText(this, "åˆ†ç»„ \"$groupName\" å·²æ ‡è®°ä¸ºæœªè¯»", Toast.LENGTH_SHORT).show()
            } else {
                Toast.makeText(this, "åˆ†ç»„ \"$groupName\" ä¸å­˜åœ¨", Toast.LENGTH_SHORT).show()
            }
        } catch (e: Exception) {
            Log.e(TAG, "æ ‡è®°è‡ªå®šä¹‰åˆ†ç»„ä¸ºæœªè¯»å¤±è´¥", e)
            Toast.makeText(this, "æ“ä½œå¤±è´¥", Toast.LENGTH_SHORT).show()
        }
    }

    /**
     * è®¾ç½®æ ‡ç­¾é¡µæ‹–åŠ¨æ’åºåŠŸèƒ½
     */
    private fun setupTabDragAndDrop(tabLayout: com.google.android.material.tabs.TabLayout?) {
        if (tabLayout == null) return

        try {
            // ä¸ºæ¯ä¸ªæ ‡ç­¾é¡µè®¾ç½®é•¿æŒ‰ç›‘å¬å™¨å’Œæ‹–æ‹½åŠŸèƒ½
            for (i in 0 until tabLayout.tabCount) {
                val tab = tabLayout.getTabAt(i)
                val tabView = (tabLayout.getChildAt(0) as? ViewGroup)?.getChildAt(i)

                tabView?.setOnLongClickListener { view ->
                    val tabPosition = i
                    val tabText = tab?.text?.toString()

                    // å…è®¸æ‹–åŠ¨æ‰€æœ‰æ ‡ç­¾ï¼ˆé™¤äº†"+"æŒ‰é’®ï¼‰
                    if (tabText != "+") {
                        startTabDragWithTouch(tabLayout, tabPosition, tabText ?: "", view)
                        true
                    } else {
                        false
                    }
                }
            }
        } catch (e: Exception) {
            Log.e(TAG, "è®¾ç½®æ ‡ç­¾é¡µæ‹–åŠ¨åŠŸèƒ½å¤±è´¥", e)
        }
    }

    /**
     * å¼€å§‹æ ‡ç­¾é¡µæ‹–åŠ¨ï¼ˆä½¿ç”¨è§¦æ‘¸æ‹–æ‹½ï¼‰
     */
    private fun startTabDragWithTouch(
        tabLayout: com.google.android.material.tabs.TabLayout,
        fromPosition: Int,
        tabText: String,
        dragView: View
    ) {
        try {
            // è·å–æ‰€æœ‰å¯æ‹–åŠ¨çš„æ ‡ç­¾ä½ç½®ï¼ˆæ’é™¤"+"ï¼‰
            val draggablePositions = mutableListOf<Int>()
            val draggableTexts = mutableListOf<String>()

            for (i in 0 until tabLayout.tabCount - 1) { // ä»ä½ç½®0å¼€å§‹ï¼Œåˆ°å€’æ•°ç¬¬äºŒä¸ªï¼ˆæ’é™¤+å·ï¼‰
                val tab = tabLayout.getTabAt(i)
                val text = tab?.text?.toString()
                if (text != null && text != "+") {
                    draggablePositions.add(i)
                    draggableTexts.add(text)
                }
            }

            if (draggablePositions.size <= 1) {
                Toast.makeText(this, "åªæœ‰ä¸€ä¸ªæ ‡ç­¾ï¼Œæ— æ³•æ’åº", Toast.LENGTH_SHORT).show()
                return
            }

            // åˆ›å»ºæ‹–æ‹½é˜´å½±
            val shadowBuilder = View.DragShadowBuilder(dragView)

            // å¼€å§‹æ‹–æ‹½
            if (android.os.Build.VERSION.SDK_INT >= android.os.Build.VERSION_CODES.N) {
                dragView.startDragAndDrop(null, shadowBuilder, TabDragData(fromPosition, tabText), 0)
            } else {
                @Suppress("DEPRECATION")
                dragView.startDrag(null, shadowBuilder, TabDragData(fromPosition, tabText), 0)
            }

            // è®¾ç½®æ‹–æ‹½ç›‘å¬å™¨
            setupTabDragListener(tabLayout)

            // ç§»é™¤æ‹–åŠ¨æç¤ºï¼Œè®©ç”¨æˆ·ä¸“æ³¨äºæ‹–æ‹½æ“ä½œ

        } catch (e: Exception) {
            Log.e(TAG, "å¼€å§‹æ ‡ç­¾é¡µæ‹–åŠ¨å¤±è´¥", e)
            // å¦‚æœæ‹–æ‹½å¤±è´¥ï¼Œå›é€€åˆ°å¯¹è¯æ¡†æ–¹å¼
            startTabDrag(tabLayout, fromPosition, tabText)
        }
    }

    /**
     * å¼€å§‹æ ‡ç­¾é¡µæ‹–åŠ¨ï¼ˆå¯¹è¯æ¡†æ–¹å¼ï¼Œä½œä¸ºå¤‡ç”¨ï¼‰
     */
    private fun startTabDrag(tabLayout: com.google.android.material.tabs.TabLayout, fromPosition: Int, tabText: String) {
        try {
            // è·å–æ‰€æœ‰å¯æ‹–åŠ¨çš„æ ‡ç­¾ä½ç½®ï¼ˆæ’é™¤"+"ï¼‰
            val draggablePositions = mutableListOf<Int>()
            val draggableTexts = mutableListOf<String>()

            for (i in 0 until tabLayout.tabCount - 1) { // ä»ä½ç½®0å¼€å§‹ï¼Œåˆ°å€’æ•°ç¬¬äºŒä¸ªï¼ˆæ’é™¤+å·ï¼‰
                val tab = tabLayout.getTabAt(i)
                val text = tab?.text?.toString()
                if (text != null && text != "+") {
                    draggablePositions.add(i)
                    draggableTexts.add(text)
                }
            }

            if (draggablePositions.size <= 1) {
                Toast.makeText(this, "åªæœ‰ä¸€ä¸ªè‡ªå®šä¹‰åˆ†ç»„ï¼Œæ— æ³•æ’åº", Toast.LENGTH_SHORT).show()
                return
            }

            // æ˜¾ç¤ºæ‹–åŠ¨æ’åºå¯¹è¯æ¡†
            showTabReorderDialog(tabLayout, fromPosition, tabText, draggablePositions, draggableTexts)

        } catch (e: Exception) {
            Log.e(TAG, "å¼€å§‹æ ‡ç­¾é¡µæ‹–åŠ¨å¤±è´¥", e)
        }
    }

    /**
     * æ˜¾ç¤ºæ ‡ç­¾é¡µé‡æ–°æ’åºå¯¹è¯æ¡†
     */
    private fun showTabReorderDialog(
        tabLayout: com.google.android.material.tabs.TabLayout,
        fromPosition: Int,
        tabText: String,
        draggablePositions: List<Int>,
        draggableTexts: List<String>
    ) {
        try {
            val currentIndex = draggableTexts.indexOf(tabText)
            if (currentIndex == -1) return

            val options = draggableTexts.mapIndexed { index, text ->
                if (index == currentIndex) {
                    "ğŸ“ $text (å½“å‰ä½ç½®)"
                } else {
                    "ğŸ“ $text"
                }
            }.toTypedArray()

            AlertDialog.Builder(this, R.style.Theme_MaterialDialog)
                .setTitle("è°ƒæ•´ \"$tabText\" çš„ä½ç½®")
                .setMessage("é€‰æ‹©è¦ç§»åŠ¨åˆ°çš„ä½ç½®ï¼š")
                .setItems(options) { _, which ->
                    if (which != currentIndex) {
                        val targetPosition = draggablePositions[which]
                        moveTab(tabLayout, fromPosition, targetPosition, tabText)
                    }
                }
                .setNegativeButton("å–æ¶ˆ", null)
                .show()
        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºæ ‡ç­¾é¡µé‡æ–°æ’åºå¯¹è¯æ¡†å¤±è´¥", e)
        }
    }

    /**
     * ç§»åŠ¨æ ‡ç­¾é¡µä½ç½®
     */
    private fun moveTab(
        tabLayout: com.google.android.material.tabs.TabLayout,
        fromPosition: Int,
        toPosition: Int,
        tabText: String
    ) {
        try {
            Log.d(TAG, "å¼€å§‹ç§»åŠ¨æ ‡ç­¾: $tabText ä»ä½ç½® $fromPosition åˆ° $toPosition")

            // æ”¶é›†æ‰€æœ‰æ ‡ç­¾çš„ä¿¡æ¯
            val allTabs = mutableListOf<String>()
            for (i in 0 until tabLayout.tabCount) {
                val tab = tabLayout.getTabAt(i)
                val text = tab?.text?.toString()
                if (text != null && text != "+") {
                    allTabs.add(text)
                }
            }

            Log.d(TAG, "ç§»åŠ¨å‰æ ‡ç­¾åˆ—è¡¨: ${allTabs.joinToString(", ")}")

            // åœ¨åˆ—è¡¨ä¸­ç§»åŠ¨æ ‡ç­¾
            if (fromPosition < allTabs.size && toPosition < allTabs.size) {
                val movedTab = allTabs.removeAt(fromPosition)
                allTabs.add(toPosition, movedTab)
            }

            Log.d(TAG, "ç§»åŠ¨åæ ‡ç­¾åˆ—è¡¨: ${allTabs.joinToString(", ")}")

            // æ¸…é™¤æ‰€æœ‰æ ‡ç­¾ï¼ˆä¿ç•™+å·ï¼‰
            val hasPlusTab = tabLayout.tabCount > 0 &&
                            tabLayout.getTabAt(tabLayout.tabCount - 1)?.text?.toString() == "+"

            // ä»åå¾€å‰ç§»é™¤æ‰€æœ‰æ ‡ç­¾
            while (tabLayout.tabCount > 0) {
                tabLayout.removeTabAt(0)
            }

            // é‡æ–°æ·»åŠ æ‰€æœ‰æ ‡ç­¾
            allTabs.forEachIndexed { index, tabName ->
                val newTab = tabLayout.newTab().setText(tabName)
                tabLayout.addTab(newTab, index)
            }

            // é‡æ–°æ·»åŠ +å·æ ‡ç­¾ï¼ˆå¦‚æœä¹‹å‰å­˜åœ¨ï¼‰
            if (hasPlusTab) {
                val plusTab = tabLayout.newTab().setText("+").setIcon(R.drawable.ic_add)
                tabLayout.addTab(plusTab)
            }

            // é‡æ–°è®¾ç½®æ‹–æ‹½ç›‘å¬å™¨
            setupTabDragAndDrop(tabLayout)

            // æ›´æ–°æ ‡ç­¾é¡µé¡ºåºåˆ°SharedPreferences
            updateAllTabOrder(allTabs)

            // é€‰ä¸­ç§»åŠ¨åçš„æ ‡ç­¾
            val targetTab = tabLayout.getTabAt(toPosition)
            targetTab?.select()

            Log.d(TAG, "æ ‡ç­¾ç§»åŠ¨å®Œæˆ: $tabText")

        } catch (e: Exception) {
            Log.e(TAG, "ç§»åŠ¨æ ‡ç­¾é¡µå¤±è´¥", e)
            Toast.makeText(this, "ç§»åŠ¨å¤±è´¥", Toast.LENGTH_SHORT).show()
        }
    }

    /**
     * æ›´æ–°æ‰€æœ‰æ ‡ç­¾é¡µé¡ºåºåˆ°SharedPreferences
     */
    private fun updateAllTabOrder(allTabs: List<String>) {
        try {
            val prefs = getSharedPreferences("custom_tabs", MODE_PRIVATE)
            val editor = prefs.edit()

            // ä¿å­˜æ‰€æœ‰æ ‡ç­¾çš„é¡ºåº
            editor.putString("all_tab_order", allTabs.joinToString(","))

            // åˆ†ç¦»è‡ªå®šä¹‰æ ‡ç­¾ï¼ˆæ’é™¤"å…¨éƒ¨"å’Œ"AIåŠ©æ‰‹"ï¼‰
            val customTabs = allTabs.filter { it != "å…¨éƒ¨" && it != "AIåŠ©æ‰‹" }
            editor.putString("custom_ai_tabs", customTabs.joinToString(","))

            editor.apply()

            Log.d(TAG, "æ›´æ–°æ‰€æœ‰æ ‡ç­¾é¡µé¡ºåº: ${allTabs.joinToString(", ")}")
            Log.d(TAG, "æ›´æ–°è‡ªå®šä¹‰æ ‡ç­¾é¡µé¡ºåº: ${customTabs.joinToString(", ")}")

        } catch (e: Exception) {
            Log.e(TAG, "æ›´æ–°æ ‡ç­¾é¡µé¡ºåºå¤±è´¥", e)
        }
    }

    /**
     * æ›´æ–°æ ‡ç­¾é¡µé¡ºåºåˆ°SharedPreferencesï¼ˆä¿æŒå‘åå…¼å®¹ï¼‰
     */
    private fun updateTabOrder(tabLayout: com.google.android.material.tabs.TabLayout) {
        try {
            val customTabs = mutableListOf<String>()

            // æ”¶é›†æ‰€æœ‰è‡ªå®šä¹‰æ ‡ç­¾ï¼ˆæ’é™¤"å…¨éƒ¨"ã€"AIåŠ©æ‰‹"å’Œ"+"ï¼‰
            for (i in 2 until tabLayout.tabCount - 1) {
                val tab = tabLayout.getTabAt(i)
                val text = tab?.text?.toString()
                if (text != null && text != "+") {
                    customTabs.add(text)
                }
            }

            // ä¿å­˜åˆ°SharedPreferences
            val prefs = getSharedPreferences("custom_tabs", MODE_PRIVATE)
            prefs.edit().putString("custom_ai_tabs", customTabs.joinToString(",")).apply()

            Log.d(TAG, "æ›´æ–°æ ‡ç­¾é¡µé¡ºåº: ${customTabs.joinToString(", ")}")

        } catch (e: Exception) {
            Log.e(TAG, "æ›´æ–°æ ‡ç­¾é¡µé¡ºåºå¤±è´¥", e)
        }
    }

    /**
     * æ›´æ–°è‡ªå®šä¹‰æ ‡ç­¾é¡µé¡ºåºï¼ˆä»å½“å‰TabLayoutè¯»å–ï¼‰
     */
    private fun updateCustomTabsOrder() {
        try {
            val chatTabLayout = findViewById<com.google.android.material.tabs.TabLayout>(R.id.chat_tab_layout)
            val customTabs = mutableListOf<String>()

            // æ”¶é›†æ‰€æœ‰è‡ªå®šä¹‰æ ‡ç­¾ï¼ˆæ’é™¤"å…¨éƒ¨"ã€"AIåŠ©æ‰‹"å’Œ"+"ï¼‰
            for (i in 2 until (chatTabLayout?.tabCount ?: 0) - 1) {
                val tab = chatTabLayout?.getTabAt(i)
                val text = tab?.text?.toString()
                if (text != null && text != "+") {
                    customTabs.add(text)
                }
            }

            // ä¿å­˜åˆ°SharedPreferences
            val prefs = getSharedPreferences("custom_tabs", MODE_PRIVATE)
            prefs.edit().putString("custom_ai_tabs", customTabs.joinToString(",")).apply()

            Log.d(TAG, "æ›´æ–°è‡ªå®šä¹‰æ ‡ç­¾é¡µé¡ºåº: ${customTabs.joinToString(", ")}")

        } catch (e: Exception) {
            Log.e(TAG, "æ›´æ–°è‡ªå®šä¹‰æ ‡ç­¾é¡µé¡ºåºå¤±è´¥", e)
        }
    }

    /**
     * æ ¹æ®å½“å‰æ ‡ç­¾é¡µè·å–å¯¹åº”çš„AIåˆ—è¡¨
     */
    private fun getAIsForCurrentTab(tabPosition: Int, tabName: String?): List<ChatContact> {
        return try {
            when (tabPosition) {
                0 -> {
                    // "å…¨éƒ¨"æ ‡ç­¾ - è¿”å›æ‰€æœ‰å·²é…ç½®çš„AI
                    allContacts.flatMap { category ->
                        category.contacts.filter { contact ->
                            contact.type == ContactType.AI && contact.isOnline && hasValidApiKey(contact)
                        }
                    }
                }
                1 -> {
                    // "AIåŠ©æ‰‹"æ ‡ç­¾ - è¿”å›AIåŠ©æ‰‹åˆ†ç»„ä¸­çš„AI
                    val aiAssistantCategory = allContacts.find { it.name == "AIåŠ©æ‰‹" }
                    aiAssistantCategory?.contacts?.filter { contact ->
                        contact.type == ContactType.AI && contact.isOnline && hasValidApiKey(contact)
                    } ?: emptyList()
                }
                else -> {
                    // è‡ªå®šä¹‰åˆ†ç»„æ ‡ç­¾ - è¿”å›è¯¥åˆ†ç»„ä¸­çš„AI
                    if (tabName != null && tabName != "+") {
                        val customCategory = allContacts.find { it.name == tabName }
                        customCategory?.contacts?.filter { contact ->
                            contact.type == ContactType.AI && contact.isOnline && hasValidApiKey(contact)
                        } ?: emptyList()
                    } else {
                        emptyList()
                    }
                }
            }
        } catch (e: Exception) {
            Log.e(TAG, "è·å–å½“å‰æ ‡ç­¾é¡µAIåˆ—è¡¨å¤±è´¥", e)
            emptyList()
        }
    }

    /**
     * æ ‡ç­¾æ‹–æ‹½æ•°æ®ç±»
     */
    private data class TabDragData(val fromPosition: Int, val tabText: String)

    /**
     * è®¾ç½®æ ‡ç­¾é¡µæ‹–æ‹½ç›‘å¬å™¨
     */
    private fun setupTabDragListener(tabLayout: com.google.android.material.tabs.TabLayout) {
        try {
            val tabStrip = tabLayout.getChildAt(0) as? ViewGroup ?: return

            for (i in 0 until tabLayout.tabCount - 1) { // ä¸ºæ‰€æœ‰æ ‡ç­¾è®¾ç½®ç›‘å¬å™¨ï¼ˆé™¤äº†+å·ï¼‰
                val tabView = tabStrip.getChildAt(i)
                tabView?.setOnDragListener { view, event ->
                    when (event.action) {
                        android.view.DragEvent.ACTION_DRAG_STARTED -> {
                            // å¼€å§‹æ‹–æ‹½ï¼Œè®¾ç½®æ‹–æ‹½çŠ¶æ€æ ‡å¿—
                            isDraggingTabs = true
                            Log.d(TAG, "å¼€å§‹æ‹–æ‹½æ ‡ç­¾é¡µ")
                            true
                        }
                        android.view.DragEvent.ACTION_DRAG_ENTERED -> {
                            // è¿›å…¥æ‹–æ‹½ç›®æ ‡
                            view.alpha = 0.5f
                            true
                        }
                        android.view.DragEvent.ACTION_DRAG_EXITED -> {
                            // ç¦»å¼€æ‹–æ‹½ç›®æ ‡
                            view.alpha = 1.0f
                            true
                        }
                        android.view.DragEvent.ACTION_DROP -> {
                            // æ”¾ä¸‹
                            view.alpha = 1.0f
                            val dragData = event.localState as? TabDragData
                            if (dragData != null) {
                                val targetPosition = i
                                if (targetPosition != dragData.fromPosition) {
                                    moveTab(tabLayout, dragData.fromPosition, targetPosition, dragData.tabText)
                                }
                            }
                            true
                        }
                        android.view.DragEvent.ACTION_DRAG_ENDED -> {
                            // æ‹–æ‹½ç»“æŸï¼Œæ¸…é™¤æ‹–æ‹½çŠ¶æ€æ ‡å¿—
                            view.alpha = 1.0f
                            // å»¶è¿Ÿæ¸…é™¤æ‹–æ‹½çŠ¶æ€ï¼Œé¿å…ç«‹å³è§¦å‘å…¶ä»–äº‹ä»¶
                            Handler(Looper.getMainLooper()).postDelayed({
                                isDraggingTabs = false
                                Log.d(TAG, "æ‹–æ‹½æ ‡ç­¾é¡µç»“æŸ")
                            }, 200)
                            true
                        }
                        else -> false
                    }
                }
            }
        } catch (e: Exception) {
            Log.e(TAG, "è®¾ç½®æ ‡ç­¾é¡µæ‹–æ‹½ç›‘å¬å™¨å¤±è´¥", e)
        }
    }

    /**
     * æŒ‰ç…§ä¿å­˜çš„é¡ºåºåŠ è½½æ ‡ç­¾é¡µ
     */
    private fun loadTabsInOrder() {
        try {
            val prefs = getSharedPreferences("custom_tabs", MODE_PRIVATE)
            val savedOrder = prefs.getString("all_tab_order", "")

            if (savedOrder.isNullOrEmpty()) {
                // å¦‚æœæ²¡æœ‰ä¿å­˜çš„é¡ºåºï¼Œä½¿ç”¨é»˜è®¤é¡ºåº
                val chatTabLayout = findViewById<com.google.android.material.tabs.TabLayout>(R.id.chat_tab_layout)
                chatTabLayout?.apply {
                    addTab(newTab().setText("å…¨éƒ¨"))      // æ˜¾ç¤ºæ‰€æœ‰ç”¨æˆ·æ·»åŠ çš„AIåŠ©æ‰‹

                    // åªæœ‰åœ¨ç”¨æˆ·æœªåˆ é™¤AIåŠ©æ‰‹åˆ†ç»„æ—¶æ‰æ·»åŠ 
                    val isAIAssistantGroupDeleted = prefs.getBoolean("ai_assistant_group_deleted", false)
                    if (!isAIAssistantGroupDeleted) {
                        addTab(newTab().setText("AIåŠ©æ‰‹"))    // é¢„è®¾åˆ†ç»„ï¼Œç”¨æˆ·å¯è‡ªå®šä¹‰ç§»åŠ¨AIåˆ°æ­¤åˆ†ç»„
                    }

                    // åŠ è½½å·²ä¿å­˜çš„è‡ªå®šä¹‰åˆ†ç»„æ ‡ç­¾é¡µ
                    loadCustomTabs()
                }
            } else {
                // æŒ‰ç…§ä¿å­˜çš„é¡ºåºåŠ è½½æ ‡ç­¾
                val tabOrder = savedOrder.split(",")
                val chatTabLayout = findViewById<com.google.android.material.tabs.TabLayout>(R.id.chat_tab_layout)

                val isAIAssistantGroupDeleted = prefs.getBoolean("ai_assistant_group_deleted", false)

                tabOrder.forEach { tabName ->
                    if (tabName.isNotEmpty()) {
                        // å¦‚æœæ˜¯AIåŠ©æ‰‹åˆ†ç»„ä¸”ç”¨æˆ·å·²åˆ é™¤ï¼Œåˆ™è·³è¿‡
                        if (tabName == "AIåŠ©æ‰‹" && isAIAssistantGroupDeleted) {
                            return@forEach
                        }

                        val newTab = chatTabLayout?.newTab()?.setText(tabName)
                        if (newTab != null) {
                            chatTabLayout.addTab(newTab)
                        }
                    }
                }

                // å¦‚æœä¿å­˜çš„é¡ºåºä¸­æ²¡æœ‰"å…¨éƒ¨"å’Œ"AIåŠ©æ‰‹"ï¼Œæ·»åŠ å®ƒä»¬
                val hasAll = tabOrder.contains("å…¨éƒ¨")
                val hasAI = tabOrder.contains("AIåŠ©æ‰‹")

                if (!hasAll) {
                    val allTab = chatTabLayout?.newTab()?.setText("å…¨éƒ¨")
                    if (allTab != null) {
                        chatTabLayout.addTab(allTab, 0) // æ·»åŠ åˆ°æœ€å‰é¢
                    }
                }

                // åªæœ‰åœ¨ç”¨æˆ·æœªåˆ é™¤AIåŠ©æ‰‹åˆ†ç»„æ—¶æ‰æ·»åŠ 
                if (!hasAI && !isAIAssistantGroupDeleted) {
                    val aiTab = chatTabLayout?.newTab()?.setText("AIåŠ©æ‰‹")
                    if (aiTab != null) {
                        val insertPosition = if (hasAll) 1 else 0
                        chatTabLayout.addTab(aiTab, insertPosition)
                    }
                }
            }

            Log.d(TAG, "æ ‡ç­¾é¡µåŠ è½½å®Œæˆï¼Œå½“å‰é¡ºåº: ${getCurrentTabOrder()}")

        } catch (e: Exception) {
            Log.e(TAG, "åŠ è½½æ ‡ç­¾é¡µé¡ºåºå¤±è´¥", e)
            // å¦‚æœåŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤é¡ºåº
            val chatTabLayout = findViewById<com.google.android.material.tabs.TabLayout>(R.id.chat_tab_layout)
            chatTabLayout?.apply {
                addTab(newTab().setText("å…¨éƒ¨"))
                addTab(newTab().setText("AIåŠ©æ‰‹"))
                loadCustomTabs()
            }
        }
    }

    /**
     * è·å–å½“å‰æ ‡ç­¾é¡µé¡ºåº
     */
    private fun getCurrentTabOrder(): String {
        val chatTabLayout = findViewById<com.google.android.material.tabs.TabLayout>(R.id.chat_tab_layout)
        val tabNames = mutableListOf<String>()

        for (i in 0 until (chatTabLayout?.tabCount ?: 0)) {
            val tab = chatTabLayout?.getTabAt(i)
            val text = tab?.text?.toString()
            if (text != null && text != "+") {
                tabNames.add(text)
            }
        }

        return tabNames.joinToString(", ")
    }

    /**
     * ç¡®ä¿æ‰€æœ‰æ˜¾ç¤ºçš„AIéƒ½åœ¨allContactsä¸­ï¼Œä»¥æ”¯æŒé•¿æŒ‰èœå•åŠŸèƒ½
     */
    private fun ensureAIsInAllContacts(displayCategories: List<ContactCategory>) {
        try {
            displayCategories.forEach { displayCategory ->
                displayCategory.contacts.forEach { contact ->
                    if (contact.type == ContactType.AI) {
                        // æ£€æŸ¥è¿™ä¸ªAIæ˜¯å¦å·²ç»åœ¨allContactsä¸­
                        var found = false
                        for (category in allContacts) {
                            if (category.contacts.any { it.id == contact.id }) {
                                found = true
                                break
                            }
                        }

                        if (!found) {
                            // å¦‚æœæ²¡æ‰¾åˆ°ï¼Œæ·»åŠ åˆ°å¯¹åº”çš„åˆ†ç»„ä¸­
                            val targetGroupName = displayCategory.name
                            val targetCategory = allContacts.find { it.name == targetGroupName }

                            if (targetCategory != null) {
                                // åˆ†ç»„å­˜åœ¨ï¼Œæ·»åŠ AIåˆ°è¯¥åˆ†ç»„
                                val updatedContacts = targetCategory.contacts.toMutableList()
                                updatedContacts.add(contact)
                                val index = allContacts.indexOf(targetCategory)
                                allContacts[index] = targetCategory.copy(contacts = updatedContacts)
                            } else {
                                // åˆ†ç»„ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°åˆ†ç»„
                                val newCategory = ContactCategory(
                                    name = targetGroupName,
                                    contacts = mutableListOf(contact),
                                    isExpanded = true
                                )
                                allContacts.add(newCategory)
                            }

                            Log.d(TAG, "å°†AI ${contact.name} æ·»åŠ åˆ°allContactsçš„åˆ†ç»„ $targetGroupName")
                        }
                    }
                }
            }

            // ä¿å­˜æ›´æ”¹
            saveContacts()

        } catch (e: Exception) {
            Log.e(TAG, "ç¡®ä¿AIåœ¨allContactsä¸­å¤±è´¥", e)
        }
    }

    /**
     * åŒæ­¥AIè”ç³»äººçŠ¶æ€ï¼Œç¡®ä¿æ˜¾ç¤ºçš„AIä¸å­˜å‚¨çš„AIçŠ¶æ€ä¸€è‡´
     */
    private fun syncAIContactStates(displayCategories: List<ContactCategory>) {
        try {
            displayCategories.forEach { displayCategory ->
                val updatedContacts = mutableListOf<ChatContact>()

                displayCategory.contacts.forEach { displayContact ->
                    if (displayContact.type == ContactType.AI) {
                        // æŸ¥æ‰¾åœ¨allContactsä¸­å¯¹åº”çš„AIè”ç³»äºº
                        var storedContact: ChatContact? = null
                        for (category in allContacts) {
                            val found = category.contacts.find { it.id == displayContact.id }
                            if (found != null) {
                                storedContact = found
                                break
                            }
                        }

                        // å¦‚æœæ‰¾åˆ°å­˜å‚¨çš„è”ç³»äººï¼Œä½¿ç”¨å­˜å‚¨çš„çŠ¶æ€
                        if (storedContact != null) {
                            updatedContacts.add(storedContact)
                            Log.d(TAG, "åŒæ­¥AIçŠ¶æ€: ${storedContact.name}, ç½®é¡¶: ${storedContact.isPinned}, é™éŸ³: ${storedContact.isMuted}")
                        } else {
                            // å¦‚æœæ²¡æ‰¾åˆ°ï¼Œä½¿ç”¨æ˜¾ç¤ºçš„è”ç³»äºº
                            updatedContacts.add(displayContact)
                            Log.d(TAG, "ä½¿ç”¨æ˜¾ç¤ºçŠ¶æ€: ${displayContact.name}")
                        }
                    } else {
                        // éAIè”ç³»äººç›´æ¥æ·»åŠ 
                        updatedContacts.add(displayContact)
                    }
                }

                // æ›´æ–°æ˜¾ç¤ºåˆ†ç±»çš„è”ç³»äººåˆ—è¡¨
                val categoryIndex = displayCategories.indexOf(displayCategory)
                if (categoryIndex != -1) {
                    // è¿™é‡Œä¸èƒ½ç›´æ¥ä¿®æ”¹displayCategoriesï¼Œå› ä¸ºå®ƒå¯èƒ½æ˜¯ä¸å¯å˜çš„
                    // ä½†æˆ‘ä»¬å¯ä»¥é€šè¿‡é€‚é…å™¨æ›´æ–°æ˜¾ç¤º
                    Log.d(TAG, "åˆ†ç±» ${displayCategory.name} çš„AIçŠ¶æ€å·²åŒæ­¥")
                }
            }

        } catch (e: Exception) {
            Log.e(TAG, "åŒæ­¥AIè”ç³»äººçŠ¶æ€å¤±è´¥", e)
        }
    }

    /**
     * å¤„ç†ä»å°ç»„ä»¶ä¼ å…¥çš„Intent
     */
    private fun handleWidgetIntent(intent: Intent?) {
        intent?.let {
            try {
                // å¤„ç† OPEN_URL actionï¼ˆç”¨äºæ‰“å¼€ç”µå­ä¹¦æ”¶è—ä¸­çš„é˜…è¯»æ¨¡å¼ï¼‰
                if (it.action == "OPEN_URL") {
                    var url = it.getStringExtra("url")
                    val enterReaderMode = it.getBooleanExtra("enter_reader_mode", false)
                    val autoLoadLastRead = it.getBooleanExtra("auto_load_last_read", false)
                    
                    // å¦‚æœURLä¸ºç©ºä¸”éœ€è¦è‡ªåŠ¨åŠ è½½ä¸Šä¸€æ¬¡é˜…è¯»è®°å½•ï¼Œåˆ™åŠ è½½ä¸Šä¸€æ¬¡çš„è®°å½•
                    if ((url == null || url.isEmpty()) && autoLoadLastRead) {
                        url = loadLastReadRecord()
                        if (url != null && url.isNotEmpty()) {
                            Log.d(TAG, "è‡ªåŠ¨åŠ è½½ä¸Šä¸€æ¬¡é˜…è¯»è®°å½•: $url")
                        }
                    }
                    
                    if (url != null && url.isNotEmpty()) {
                        Log.d(TAG, "æ”¶åˆ°OPEN_URLè¯·æ±‚: $url, è¿›å…¥é˜…è¯»æ¨¡å¼: $enterReaderMode")
                        
                        // ä¿å­˜ä¸Šä¸€æ¬¡é˜…è¯»çš„è®°å½•å’Œç½‘å€
                        if (enterReaderMode) {
                            saveLastReadRecord(url)
                        }
                        
                        // ğŸ”§ ä¼˜åŒ–ï¼šä¸€æ­¥å®Œæˆåˆ‡æ¢ï¼Œä½¿ç”¨åŠ¨ç”»è¿‡æ¸¡ï¼Œå‡å°‘å»¶è¿Ÿ
                        try {
                            // ç«‹å³åˆ‡æ¢åˆ°æœç´¢tab
                            switchToSearchTab()
                            
                            // ä½¿ç”¨åŠ¨ç”»è¿‡æ¸¡ï¼Œå‡å°‘å»¶è¿Ÿæ—¶é—´
                            Handler(Looper.getMainLooper()).postDelayed({
                                try {
                                    // æ·»åŠ æ–°æ ‡ç­¾é¡µå¹¶åŠ è½½URL
                                    val tab = paperStackWebViewManager?.addTab(url, null)
                                    
                                    if (tab != null) {
                                        Log.d(TAG, "å·²æ·»åŠ æ–°æ ‡ç­¾é¡µ: $url")
                                        
                                        // ä¸ºWebViewæ·»åŠ æ»šåŠ¨ç›‘å¬å™¨ï¼Œå®ç°è‡ªåŠ¨éšè—/æ˜¾ç¤ºå·¥å…·æ 
                                        addScrollListenerToWebView(tab.webView)
                                        
                                        if (enterReaderMode) {
                                            // å‡å°‘å»¶è¿Ÿæ—¶é—´ï¼Œæ›´å¿«è¿›å…¥é˜…è¯»æ¨¡å¼
                                            Handler(Looper.getMainLooper()).postDelayed({
                                                try {
                                                    // ç¡®ä¿é˜…è¯»æ¨¡å¼ç®¡ç†å™¨å·²åˆå§‹åŒ–
                                                    if (globalReaderModeManager == null) {
                                                        globalReaderModeManager = com.example.aifloatingball.reader.NovelReaderModeManager(this)
                                                        Log.d(TAG, "åˆå§‹åŒ–é˜…è¯»æ¨¡å¼ç®¡ç†å™¨")
                                                    }
                                                    
                                                    globalReaderModeManager?.enterReaderMode(tab.webView, url, useNoImageMode = false)
                                                    Log.d(TAG, "å·²è¿›å…¥é˜…è¯»æ¨¡å¼: $url")
                                                    
                                                    // ç¡®ä¿æ»šåŠ¨ç›‘å¬å™¨å·²æ·»åŠ 
                                                    addScrollListenerToWebView(tab.webView)
                                                } catch (e: Exception) {
                                                    Log.e(TAG, "è¿›å…¥é˜…è¯»æ¨¡å¼å¤±è´¥", e)
                                                    Toast.makeText(this, "è¿›å…¥é˜…è¯»æ¨¡å¼å¤±è´¥: ${e.message}", Toast.LENGTH_SHORT).show()
                                                }
                                            }, 800) // å‡å°‘å»¶è¿Ÿåˆ°800msï¼Œæ›´å¿«å“åº”
                                        }
                                    } else {
                                        Log.e(TAG, "æ·»åŠ æ ‡ç­¾é¡µå¤±è´¥")
                                        Toast.makeText(this, "æ‰“å¼€URLå¤±è´¥", Toast.LENGTH_SHORT).show()
                                    }
                                } catch (e: Exception) {
                                    Log.e(TAG, "æ‰“å¼€URLå¤±è´¥", e)
                                    Toast.makeText(this, "æ‰“å¼€URLå¤±è´¥: ${e.message}", Toast.LENGTH_SHORT).show()
                                }
                            }, 200) // å‡å°‘å»¶è¿Ÿåˆ°200msï¼Œæ›´å¿«å“åº”
                        } catch (e: Exception) {
                            Log.e(TAG, "åˆ‡æ¢åˆ°æœç´¢tabå¤±è´¥", e)
                            Toast.makeText(this, "åˆ‡æ¢åˆ°æœç´¢tabå¤±è´¥: ${e.message}", Toast.LENGTH_SHORT).show()
                        }
                    } else {
                        Log.e(TAG, "OPEN_URLè¯·æ±‚ä¸­URLä¸ºç©ºä¸”æ— æ³•åŠ è½½ä¸Šä¸€æ¬¡é˜…è¯»è®°å½•")
                        Toast.makeText(this, "URLä¸ºç©ºï¼Œæ— æ³•æ‰“å¼€", Toast.LENGTH_SHORT).show()
                    }
                    return
                }
                
                // æ£€æŸ¥æ˜¯å¦éœ€è¦ç›´æ¥è·³è½¬åˆ°è®¾ç½®é¡µé¢
                val openSettings = it.getBooleanExtra("open_settings", false)
                if (openSettings) {
                    Log.d(TAG, "æ”¶åˆ°æ‰“å¼€è®¾ç½®é¡µé¢çš„è¯·æ±‚")
                    Handler(Looper.getMainLooper()).post {
                        showSettings()
                    }
                    return
                }

                val source = it.getStringExtra("source")
                if (source?.contains("æ¡Œé¢å°ç»„ä»¶") == true) {
                    Log.d(TAG, "æ”¶åˆ°æ¥è‡ªæ¡Œé¢å°ç»„ä»¶çš„è¯·æ±‚: source=$source")

                    val searchQuery = it.getStringExtra("search_query")
                    val searchMode = it.getStringExtra("search_mode")
                    val autoSwitchToAppSearch = it.getBooleanExtra("auto_switch_to_app_search", false)
                    val showInputDialog = it.getBooleanExtra("show_input_dialog", false)

                    // æ–°å¢çš„å°ç»„ä»¶å›¾æ ‡ç‚¹å‡»å‚æ•°
                    val autoStartAIChat = it.getBooleanExtra("auto_start_ai_chat", false)
                    val autoStartWebSearch = it.getBooleanExtra("auto_start_web_search", false)
                    val useClipboardIfNoSearchBox = it.getBooleanExtra("use_clipboard_if_no_search_box", false)
                    val showSearchBox = it.getBooleanExtra("show_search_box", true)
                    val defaultAIQuery = it.getStringExtra("default_ai_query")
                    val defaultSearchQuery = it.getStringExtra("default_search_query")
                    val aiEngine = it.getStringExtra("ai_engine")
                    val aiName = it.getStringExtra("ai_name")
                    val searchEngine = it.getStringExtra("search_engine")
                    val searchEngineName = it.getStringExtra("search_engine_name")
                    val appPackage = it.getStringExtra("app_package")
                    val appName = it.getStringExtra("app_name")

                    when {
                        showInputDialog -> {
                            // æ˜¾ç¤ºè¾“å…¥å¯¹è¯æ¡†
                            Log.d(TAG, "å‡†å¤‡æ˜¾ç¤ºå°ç»„ä»¶è¾“å…¥å¯¹è¯æ¡†")
                            // å»¶è¿Ÿæ˜¾ç¤ºå¯¹è¯æ¡†ï¼Œç¡®ä¿Activityå®Œå…¨åŠ è½½
                            Handler(Looper.getMainLooper()).postDelayed({
                                showWidgetInputDialog()
                            }, 200)
                        }
                        autoStartAIChat -> {
                            // è‡ªåŠ¨å¯åŠ¨AIå¯¹è¯
                            Log.d(TAG, "è‡ªåŠ¨å¯åŠ¨AIå¯¹è¯: $aiName, æ˜¾ç¤ºæœç´¢æ¡†: $showSearchBox")
                            Handler(Looper.getMainLooper()).postDelayed({
                                startAIChatFromWidget(aiEngine, aiName, showSearchBox, useClipboardIfNoSearchBox)
                            }, 300)
                        }
                        autoStartWebSearch -> {
                            // è‡ªåŠ¨å¯åŠ¨ç½‘ç»œæœç´¢
                            Log.d(TAG, "è‡ªåŠ¨å¯åŠ¨ç½‘ç»œæœç´¢: $searchEngineName, æ˜¾ç¤ºæœç´¢æ¡†: $showSearchBox")
                            Handler(Looper.getMainLooper()).postDelayed({
                                startWebSearchFromWidget(searchEngine, searchEngineName, showSearchBox, useClipboardIfNoSearchBox)
                            }, 300)
                        }
                        autoSwitchToAppSearch -> {
                            // è‡ªåŠ¨åˆ‡æ¢åˆ°åº”ç”¨æœç´¢é¡µé¢
                            Log.d(TAG, "è‡ªåŠ¨åˆ‡æ¢åˆ°åº”ç”¨æœç´¢: $appName, æ˜¾ç¤ºæœç´¢æ¡†: $showSearchBox")
                            Handler(Looper.getMainLooper()).postDelayed({
                                startAppSearchFromWidget(appPackage, appName, showSearchBox, useClipboardIfNoSearchBox)
                            }, 300)
                        }
                        searchMode == "ai_chat" -> {
                            // å¤„ç†AIå¯¹è¯æ¨¡å¼ï¼ˆè¿™ç§æƒ…å†µä¸‹åº”è¯¥å·²ç»å¯åŠ¨äº†ChatActivityï¼‰
                            Log.d(TAG, "AIå¯¹è¯æ¨¡å¼ï¼Œquery: $searchQuery")
                        }
                        searchMode == "app_search" -> {
                            // åˆ‡æ¢åˆ°åº”ç”¨æœç´¢é¡µé¢
                            switchToAppSearchWithQuery(searchQuery)
                        }
                        searchMode == "web_search" -> {
                            // ç½‘ç»œæœç´¢æ¨¡å¼ï¼ˆè¿™ç§æƒ…å†µä¸‹åº”è¯¥å·²ç»å¯åŠ¨äº†DualFloatingWebViewServiceï¼‰
                            Log.d(TAG, "ç½‘ç»œæœç´¢æ¨¡å¼ï¼Œquery: $searchQuery")
                        }
                        searchQuery != null -> {
                            // æœ‰æœç´¢æŸ¥è¯¢ä½†æ²¡æœ‰æŒ‡å®šæ¨¡å¼ï¼Œæ˜¾ç¤ºé€‰æ‹©å¯¹è¯æ¡†
                            showSearchModeSelectionDialog(searchQuery)
                        }
                        else -> {
                            // é»˜è®¤æƒ…å†µï¼Œè®°å½•æ—¥å¿—
                            Log.d(TAG, "æ”¶åˆ°å°ç»„ä»¶è¯·æ±‚ä½†æ²¡æœ‰åŒ¹é…çš„å¤„ç†é€»è¾‘")
                        }
                    }
                } else {
                    // ä¸æ˜¯æ¥è‡ªå°ç»„ä»¶çš„è¯·æ±‚ï¼Œè®°å½•æ—¥å¿—
                    Log.d(TAG, "æ”¶åˆ°éå°ç»„ä»¶è¯·æ±‚: source=$source")
                }
            } catch (e: Exception) {
                Log.e(TAG, "å¤„ç†å°ç»„ä»¶Intentå¤±è´¥", e)
            }
        }
    }

    /**
     * æ˜¾ç¤ºå°ç»„ä»¶è¾“å…¥å¯¹è¯æ¡†
     */
    private fun showWidgetInputDialog() {
        Log.d(TAG, "æ˜¾ç¤ºå°ç»„ä»¶è¾“å…¥å¯¹è¯æ¡†")

        val input = EditText(this).apply {
            hint = "è¯·è¾“å…¥æœç´¢å†…å®¹"
            setPadding(50, 30, 50, 30)
            // è‡ªåŠ¨è·å–ç„¦ç‚¹å¹¶æ˜¾ç¤ºé”®ç›˜
            requestFocus()
        }

        val dialog = AlertDialog.Builder(this)
            .setTitle("æœç´¢å†…å®¹")
            .setMessage("è¯·è¾“å…¥æ‚¨è¦æœç´¢çš„å†…å®¹ï¼š")
            .setView(input)
            .setPositiveButton("AIå¯¹è¯") { _, _ ->
                val query = input.text.toString().trim()
                if (query.isNotEmpty()) {
                    startAIChatWithQuery(query)
                } else {
                    Toast.makeText(this, "è¯·è¾“å…¥æœç´¢å†…å®¹", Toast.LENGTH_SHORT).show()
                }
            }
            .setNeutralButton("åº”ç”¨æœç´¢") { _, _ ->
                val query = input.text.toString().trim()
                if (query.isNotEmpty()) {
                    switchToAppSearchWithQuery(query)
                } else {
                    Toast.makeText(this, "è¯·è¾“å…¥æœç´¢å†…å®¹", Toast.LENGTH_SHORT).show()
                }
            }
            .setNegativeButton("ç½‘ç»œæœç´¢") { _, _ ->
                val query = input.text.toString().trim()
                if (query.isNotEmpty()) {
                    startWebSearchWithQuery(query)
                } else {
                    Toast.makeText(this, "è¯·è¾“å…¥æœç´¢å†…å®¹", Toast.LENGTH_SHORT).show()
                }
            }
            .setCancelable(true)
            .create()

        dialog.show()

        // å»¶è¿Ÿæ˜¾ç¤ºé”®ç›˜ï¼Œç¡®ä¿å¯¹è¯æ¡†å®Œå…¨æ˜¾ç¤ºåå†æ˜¾ç¤ºé”®ç›˜
        Handler(Looper.getMainLooper()).postDelayed({
            input.requestFocus()
            val imm = getSystemService(Context.INPUT_METHOD_SERVICE) as InputMethodManager
            imm.showSoftInput(input, InputMethodManager.SHOW_IMPLICIT)
        }, 100)
    }

    /**
     * æ˜¾ç¤ºæœç´¢æ¨¡å¼é€‰æ‹©å¯¹è¯æ¡†
     */
    private fun showSearchModeSelectionDialog(query: String) {
        val options = arrayOf("AIå¯¹è¯", "åº”ç”¨æœç´¢", "ç½‘ç»œæœç´¢")

        AlertDialog.Builder(this)
            .setTitle("é€‰æ‹©æœç´¢æ–¹å¼")
            .setMessage("æœç´¢å†…å®¹ï¼š$query")
            .setItems(options) { _, which ->
                when (which) {
                    0 -> startAIChatWithQuery(query)
                    1 -> switchToAppSearchWithQuery(query)
                    2 -> startWebSearchWithQuery(query)
                }
            }
            .setNegativeButton("å–æ¶ˆ", null)
            .show()
    }

    /**
     * å¯åŠ¨AIå¯¹è¯
     */
    private fun startAIChatWithQuery(query: String?) {
        try {
            // æ‰¾åˆ°ç¬¬ä¸€ä¸ªå¯ç”¨çš„AIè”ç³»äºº
            val aiContact = findFirstAvailableAIContact()
            if (aiContact != null) {
                if (query != null) {
                    openChatWithContactAndMessage(aiContact, query)
                } else {
                    // åªè·³è½¬åˆ°å¯¹è¯ç•Œé¢ï¼Œä¸å‘é€æ¶ˆæ¯ï¼Œæ¿€æ´»è¾“å…¥çŠ¶æ€
                    openChatWithContactOnly(aiContact)
                }
            } else {
                // æ²¡æœ‰AIè”ç³»äººï¼Œæç¤ºç”¨æˆ·æ·»åŠ 
                showAddAIContactDialog(query ?: "")
            }
        } catch (e: Exception) {
            Log.e(TAG, "å¯åŠ¨AIå¯¹è¯å¤±è´¥", e)
            Toast.makeText(this, "å¯åŠ¨AIå¯¹è¯å¤±è´¥", Toast.LENGTH_SHORT).show()
        }
    }

    /**
     * åˆ‡æ¢åˆ°åº”ç”¨æœç´¢é¡µé¢å¹¶è®¾ç½®æŸ¥è¯¢
     */
    private fun switchToAppSearchWithQuery(query: String?) {
        try {
            // åˆ‡æ¢åˆ°åº”ç”¨æœç´¢é¡µé¢
            currentState = UIState.APP_SEARCH
            showAppSearch()

            // å¦‚æœæœ‰æŸ¥è¯¢å†…å®¹ï¼Œè®¾ç½®åˆ°è¾“å…¥æ¡†
            query?.let {
                appSearchInput.setText(it)
                appSearchInput.setSelection(it.length)
                // æ›´æ–°æœç´¢æŸ¥è¯¢
                if (::appSearchAdapter.isInitialized) {
                    appSearchAdapter.updateSearchQuery(it)
                }
                // æ›´æ–°æç¤ºæ–‡æœ¬
                appSearchHint.text = "è¾“å…¥å…³é”®è¯ï¼š$itï¼Œç‚¹å‡»åº”ç”¨å›¾æ ‡è¿›è¡Œæœç´¢"
            }
        } catch (e: Exception) {
            Log.e(TAG, "åˆ‡æ¢åˆ°åº”ç”¨æœç´¢å¤±è´¥", e)
            Toast.makeText(this, "åˆ‡æ¢åˆ°åº”ç”¨æœç´¢å¤±è´¥", Toast.LENGTH_SHORT).show()
        }
    }

    /**
     * å¯åŠ¨ç½‘ç»œæœç´¢
     */
    private fun startWebSearchWithQuery(query: String) {
        try {
            val intent = Intent(this, DualFloatingWebViewService::class.java).apply {
                putExtra("search_query", query)
                putExtra("engine_key", "baidu")
                putExtra("search_source", "ç®€æ˜“æ¨¡å¼å°ç»„ä»¶")
            }
            startService(intent)
            Toast.makeText(this, "æ­£åœ¨å¯åŠ¨ç½‘ç»œæœç´¢...", Toast.LENGTH_SHORT).show()
        } catch (e: Exception) {
            Log.e(TAG, "å¯åŠ¨ç½‘ç»œæœç´¢å¤±è´¥", e)
            Toast.makeText(this, "å¯åŠ¨ç½‘ç»œæœç´¢å¤±è´¥", Toast.LENGTH_SHORT).show()
        }
    }

    /**
     * æ‰¾åˆ°ç¬¬ä¸€ä¸ªå¯ç”¨çš„AIè”ç³»äºº
     */
    private fun findFirstAvailableAIContact(): ChatContact? {
        return try {
            allContacts.flatMap { it.contacts }
                .firstOrNull { contact ->
                    isAIContact(contact) && hasValidApiKey(contact)
                }
        } catch (e: Exception) {
            Log.e(TAG, "æŸ¥æ‰¾AIè”ç³»äººå¤±è´¥", e)
            null
        }
    }

    /**
     * æ˜¾ç¤ºæ·»åŠ AIè”ç³»äººå¯¹è¯æ¡†ï¼ˆå¸¦æŸ¥è¯¢å‚æ•°ï¼‰
     */
    private fun showAddAIContactDialog(query: String) {
        AlertDialog.Builder(this)
            .setTitle("éœ€è¦æ·»åŠ AIåŠ©æ‰‹")
            .setMessage("è¦ä½¿ç”¨AIå¯¹è¯åŠŸèƒ½ï¼Œè¯·å…ˆæ·»åŠ AIåŠ©æ‰‹ã€‚\n\næœç´¢å†…å®¹ï¼š$query")
            .setPositiveButton("æ·»åŠ AIåŠ©æ‰‹") { _, _ ->
                openAddAIContactDialog()
            }
            .setNegativeButton("å–æ¶ˆ", null)
            .show()
    }

    /**
     * åªæ‰“å¼€AIå¯¹è¯ç•Œé¢ï¼Œä¸å‘é€æ¶ˆæ¯ï¼Œæ¿€æ´»è¾“å…¥çŠ¶æ€
     */
    private fun openChatWithContactOnly(contact: ChatContact) {
        try {
            val intent = Intent(this, ChatActivity::class.java).apply {
                putExtra(ChatActivity.EXTRA_CONTACT, contact)
                putExtra("activate_input_only", true) // åªæ¿€æ´»è¾“å…¥çŠ¶æ€
                putExtra("source", "æ¡Œé¢å°ç»„ä»¶")
            }
            startActivity(intent)
            Log.d(TAG, "æ‰“å¼€AIå¯¹è¯ç•Œé¢: ${contact.name}, åªæ¿€æ´»è¾“å…¥çŠ¶æ€")
        } catch (e: Exception) {
            Log.e(TAG, "æ‰“å¼€AIå¯¹è¯ç•Œé¢å¤±è´¥", e)
            Toast.makeText(this, "æ‰“å¼€å¯¹è¯ç•Œé¢å¤±è´¥", Toast.LENGTH_SHORT).show()
        }
    }

    /**
     * ä»å°ç»„ä»¶å¯åŠ¨AIå¯¹è¯
     */
    private fun startAIChatFromWidget(aiEngine: String?, aiName: String?, showSearchBox: Boolean, useClipboard: Boolean) {
        Log.d(TAG, "ä»å°ç»„ä»¶å¯åŠ¨AIå¯¹è¯: $aiName, æ˜¾ç¤ºæœç´¢æ¡†: $showSearchBox, ä½¿ç”¨å‰ªè´´æ¿: $useClipboard")

        // ç¡®å®šè¦ä½¿ç”¨çš„æŸ¥è¯¢å†…å®¹å’Œæ˜¯å¦è‡ªåŠ¨å‘é€
        val (queryToUse, shouldAutoSend) = if (!showSearchBox && useClipboard) {
                // æ²¡æœ‰æœç´¢æ¡†æ—¶ï¼Œå°è¯•ä½¿ç”¨å‰ªè´´æ¿å†…å®¹
                val clipboardText = com.example.dalao.widget.ClipboardHelper.getClipboardText(this)
                if (com.example.dalao.widget.ClipboardHelper.isValidSearchQuery(clipboardText)) {
                    val cleanedText = com.example.dalao.widget.ClipboardHelper.cleanTextForSearch(clipboardText)
                    Log.d(TAG, "ä½¿ç”¨å‰ªè´´æ¿å†…å®¹ä½œä¸ºAIæŸ¥è¯¢: $cleanedText")
                    Pair(cleanedText, true) // æœ‰å‰ªè´´æ¿å†…å®¹æ—¶è‡ªåŠ¨å‘é€
                } else {
                    Log.d(TAG, "å‰ªè´´æ¿å†…å®¹æ— æ•ˆæˆ–ä¸ºç©ºï¼Œåªè·³è½¬åˆ°å¯¹è¯ç•Œé¢")
                    Pair(null, false) // æ— æœ‰æ•ˆå‰ªè´´æ¿å†…å®¹æ—¶ä¸è‡ªåŠ¨å‘é€
                }
            } else {
                // æœ‰æœç´¢æ¡†æ—¶ä¹Ÿä¸è‡ªåŠ¨å‘é€æ¶ˆæ¯ï¼Œåªæ¿€æ´»è¾“å…¥çŠ¶æ€
                Pair(null, false)
            }

        try {
            if (aiEngine.isNullOrEmpty() || aiName.isNullOrEmpty()) {
                Log.w(TAG, "AIå¼•æ“ä¿¡æ¯ä¸å®Œæ•´ï¼Œä½¿ç”¨é»˜è®¤æŸ¥è¯¢")
                if (shouldAutoSend && queryToUse != null) {
                    startAIChatWithQuery(queryToUse)
                } else {
                    // åªè·³è½¬åˆ°å¯¹è¯ç•Œé¢ï¼Œä¸å‘é€æ¶ˆæ¯
                    startAIChatWithQuery(null)
                }
                return
            }

            // åˆ›å»ºAIè”ç³»äººï¼ŒåŒ…å«å¿…è¦çš„APIé…ç½®
            val apiKey = getApiKeyForAI(aiName)

            // æ£€æŸ¥APIå¯†é’¥æ˜¯å¦é…ç½®
            if (apiKey.isBlank()) {
                Log.w(TAG, "AIåŠ©æ‰‹ $aiName çš„APIå¯†é’¥æœªé…ç½®")
                // æ˜¾ç¤ºé…ç½®æç¤º
                Handler(Looper.getMainLooper()).post {
                    showAIConfigurationDialog(aiName, queryToUse ?: "")
                }
                return
            }

            val aiContact = ChatContact(
                id = "widget_$aiEngine",
                name = aiName,
                type = ContactType.AI,
                lastMessage = "",
                lastMessageTime = System.currentTimeMillis(),
                customData = mutableMapOf(
                    "engine" to aiEngine,
                    "api_url" to getDefaultApiUrl(aiName),
                    "api_key" to apiKey,
                    "model" to getDefaultModel(aiName)
                ),
                aiMembers = emptyList()
            )

            // å¯åŠ¨ChatActivity
            val intent = Intent(this, ChatActivity::class.java).apply {
                putExtra(ChatActivity.EXTRA_CONTACT, aiContact)
                if (shouldAutoSend && queryToUse != null) {
                    putExtra("auto_send_message", queryToUse)
                    Log.d(TAG, "å°†è‡ªåŠ¨å‘é€æ¶ˆæ¯: $queryToUse")
                } else {
                    // ä¸è‡ªåŠ¨å‘é€æ¶ˆæ¯ï¼Œåªæ¿€æ´»è¾“å…¥çŠ¶æ€
                    putExtra("activate_input_only", true)
                    Log.d(TAG, "åªæ¿€æ´»è¾“å…¥çŠ¶æ€ï¼Œä¸è‡ªåŠ¨å‘é€æ¶ˆæ¯")
                }
                putExtra("source", "æ¡Œé¢å°ç»„ä»¶")
            }

            startActivity(intent)
            Log.d(TAG, "AIå¯¹è¯å¯åŠ¨æˆåŠŸ: $aiName, è‡ªåŠ¨å‘é€: $shouldAutoSend")

        } catch (e: Exception) {
            Log.e(TAG, "ä»å°ç»„ä»¶å¯åŠ¨AIå¯¹è¯å¤±è´¥", e)
            // å›é€€åˆ°ç®€å•çš„AIå¯¹è¯å¯åŠ¨
            if (shouldAutoSend && queryToUse != null) {
                startAIChatWithQuery(queryToUse)
            } else {
                startAIChatWithQuery(null) // åªè·³è½¬ï¼Œä¸å‘é€æ¶ˆæ¯
            }
        }
    }

    /**
     * ä»å°ç»„ä»¶å¯åŠ¨ç½‘ç»œæœç´¢
     */
    private fun startWebSearchFromWidget(searchEngine: String?, searchEngineName: String?, showSearchBox: Boolean, useClipboard: Boolean) {
        try {
            Log.d(TAG, "ä»å°ç»„ä»¶å¯åŠ¨ç½‘ç»œæœç´¢: $searchEngineName, æ˜¾ç¤ºæœç´¢æ¡†: $showSearchBox, ä½¿ç”¨å‰ªè´´æ¿: $useClipboard")

            // ç¡®å®šè¦ä½¿ç”¨çš„æœç´¢å†…å®¹ - å§‹ç»ˆå°è¯•ä½¿ç”¨å‰ªè´´æ¿å†…å®¹
            val clipboardText = com.example.dalao.widget.ClipboardHelper.getClipboardText(this)
            val queryToUse = if (com.example.dalao.widget.ClipboardHelper.isValidSearchQuery(clipboardText)) {
                val cleanedText = com.example.dalao.widget.ClipboardHelper.cleanTextForSearch(clipboardText)
                Log.d(TAG, "ä½¿ç”¨å‰ªè´´æ¿å†…å®¹è¿›è¡Œç½‘ç»œæœç´¢: $cleanedText")
                cleanedText
            } else {
                Log.d(TAG, "å‰ªè´´æ¿å†…å®¹æ— æ•ˆæˆ–ä¸ºç©ºï¼Œç›´æ¥æ‰“å¼€æœç´¢å¼•æ“é¦–é¡µ")
                null // è¿”å›nullè¡¨ç¤ºç›´æ¥æ‰“å¼€é¦–é¡µ
            }

            // åˆ‡æ¢åˆ°æµè§ˆå™¨ç•Œé¢
            showBrowser()

            // æ ¹æ®æœç´¢å¼•æ“å‚æ•°è®¾ç½®æ­£ç¡®çš„æœç´¢å¼•æ“
            setCurrentSearchEngineByName(searchEngine, searchEngineName)

            if (queryToUse != null) {
                // æœ‰æœç´¢å†…å®¹æ—¶æ‰§è¡Œæœç´¢
                browserSearchInput.setText(queryToUse)
                performBrowserSearch()
                Log.d(TAG, "ç½‘ç»œæœç´¢å¯åŠ¨æˆåŠŸ: $queryToUse")
            } else {
                // æ²¡æœ‰æœç´¢å†…å®¹æ—¶ï¼Œæ ¹æ®æœç´¢å¼•æ“æ‰“å¼€é¦–é¡µ
                val homepageUrl = getSearchEngineHomepage(searchEngine, searchEngineName)
                if (homepageUrl != null) {
                    // ç›´æ¥åŠ è½½é¦–é¡µURL
                    loadBrowserContent(homepageUrl)
                    Log.d(TAG, "æ‰“å¼€æœç´¢å¼•æ“é¦–é¡µ: $homepageUrl")
                } else {
                    // å¦‚æœæ— æ³•ç¡®å®šé¦–é¡µï¼Œç›´æ¥æ‰“å¼€æµè§ˆå™¨ç©ºç™½é¡µ
                    showBrowser()
                    Log.d(TAG, "æ‰“å¼€æµè§ˆå™¨ç©ºç™½é¡µ")
                }
            }

        } catch (e: Exception) {
            Log.e(TAG, "ä»å°ç»„ä»¶å¯åŠ¨ç½‘ç»œæœç´¢å¤±è´¥", e)
            // å›é€€ï¼šç›´æ¥æ‰“å¼€æµè§ˆå™¨ç©ºç™½é¡µ
            showBrowser()
            Log.d(TAG, "å›é€€ï¼šæ‰“å¼€æµè§ˆå™¨ç©ºç™½é¡µ")
        }
    }

    /**
     * ä»å°ç»„ä»¶å¯åŠ¨åº”ç”¨æœç´¢
     */
    private fun startAppSearchFromWidget(appPackage: String?, appName: String?, showSearchBox: Boolean, useClipboard: Boolean) {
        try {
            Log.d(TAG, "ä»å°ç»„ä»¶å¯åŠ¨åº”ç”¨æœç´¢: $appName, æ˜¾ç¤ºæœç´¢æ¡†: $showSearchBox, ä½¿ç”¨å‰ªè´´æ¿: $useClipboard")

            // ç¡®å®šè¦ä½¿ç”¨çš„æœç´¢å†…å®¹ - å§‹ç»ˆå°è¯•ä½¿ç”¨å‰ªè´´æ¿å†…å®¹
            val clipboardText = com.example.dalao.widget.ClipboardHelper.getClipboardText(this)
            val queryToUse = if (com.example.dalao.widget.ClipboardHelper.isValidSearchQuery(clipboardText)) {
                val cleanedText = com.example.dalao.widget.ClipboardHelper.cleanTextForSearch(clipboardText)
                Log.d(TAG, "ä½¿ç”¨å‰ªè´´æ¿å†…å®¹è¿›è¡Œåº”ç”¨æœç´¢: $cleanedText")
                cleanedText
            } else {
                Log.d(TAG, "å‰ªè´´æ¿å†…å®¹æ— æ•ˆæˆ–ä¸ºç©ºï¼Œç›´æ¥æ‰“å¼€åº”ç”¨")
                null // è¿”å›nullè¡¨ç¤ºç›´æ¥æ‰“å¼€åº”ç”¨
            }

            if (queryToUse != null && !appPackage.isNullOrEmpty()) {
                // æœ‰æœç´¢å†…å®¹æ—¶ï¼Œå°è¯•ç›´æ¥åœ¨ç›®æ ‡åº”ç”¨ä¸­æœç´¢
                val success = launchAppWithSearch(appPackage, appName, queryToUse)
                if (!success) {
                    // å¦‚æœç›´æ¥æœç´¢å¤±è´¥ï¼Œå°è¯•ç›´æ¥æ‰“å¼€åº”ç”¨
                    Log.w(TAG, "ç›´æ¥åº”ç”¨æœç´¢å¤±è´¥ï¼Œå°è¯•ç›´æ¥æ‰“å¼€åº”ç”¨")
                    val launchIntent = packageManager.getLaunchIntentForPackage(appPackage)
                    if (launchIntent != null) {
                        startActivity(launchIntent)
                        Log.d(TAG, "ç›´æ¥å¯åŠ¨åº”ç”¨: $appName")
                    } else {
                        Log.w(TAG, "æ— æ³•å¯åŠ¨åº”ç”¨: $appName, åº”ç”¨å¯èƒ½æœªå®‰è£…")
                        Toast.makeText(this, "åº”ç”¨ $appName æœªå®‰è£…", Toast.LENGTH_SHORT).show()
                    }
                }
            } else {
                // æ²¡æœ‰æœç´¢å†…å®¹æ—¶ï¼Œç›´æ¥æ‰“å¼€åº”ç”¨
                if (!appPackage.isNullOrEmpty()) {
                    val launchIntent = packageManager.getLaunchIntentForPackage(appPackage)
                    if (launchIntent != null) {
                        startActivity(launchIntent)
                        Log.d(TAG, "ç›´æ¥å¯åŠ¨åº”ç”¨: $appName")
                    } else {
                        Log.w(TAG, "æ— æ³•å¯åŠ¨åº”ç”¨: $appName, åº”ç”¨å¯èƒ½æœªå®‰è£…")
                        Toast.makeText(this, "åº”ç”¨ $appName æœªå®‰è£…", Toast.LENGTH_SHORT).show()
                    }
                } else {
                    Log.w(TAG, "åº”ç”¨åŒ…åä¸ºç©ºï¼Œæ— æ³•å¯åŠ¨åº”ç”¨")
                    Toast.makeText(this, "åº”ç”¨ä¿¡æ¯ä¸å®Œæ•´", Toast.LENGTH_SHORT).show()
                }
            }

        } catch (e: Exception) {
            Log.e(TAG, "ä»å°ç»„ä»¶å¯åŠ¨åº”ç”¨æœç´¢å¤±è´¥", e)
            // å›é€€ï¼šå°è¯•ç›´æ¥æ‰“å¼€åº”ç”¨
            if (!appPackage.isNullOrEmpty()) {
                try {
                    val launchIntent = packageManager.getLaunchIntentForPackage(appPackage)
                    if (launchIntent != null) {
                        startActivity(launchIntent)
                        Log.d(TAG, "å›é€€å¯åŠ¨åº”ç”¨æˆåŠŸ: $appName")
                    } else {
                        Toast.makeText(this, "åº”ç”¨ $appName æœªå®‰è£…", Toast.LENGTH_SHORT).show()
                    }
                } catch (e2: Exception) {
                    Log.e(TAG, "å›é€€å¯åŠ¨åº”ç”¨ä¹Ÿå¤±è´¥", e2)
                    Toast.makeText(this, "å¯åŠ¨åº”ç”¨å¤±è´¥", Toast.LENGTH_SHORT).show()
                }
            } else {
                Toast.makeText(this, "åº”ç”¨ä¿¡æ¯ä¸å®Œæ•´", Toast.LENGTH_SHORT).show()
            }
        }
    }

    /**
     * åœ¨æŒ‡å®šåº”ç”¨ä¸­å¯åŠ¨æœç´¢
     */
    private fun launchAppWithSearch(packageName: String, appName: String?, query: String): Boolean {
        try {
            Log.d(TAG, "å°è¯•åœ¨åº”ç”¨ $appName ä¸­æœç´¢: $query")

            // æ ¹æ®ä¸åŒåº”ç”¨ä½¿ç”¨ä¸åŒçš„æœç´¢Intent
            val searchIntent = when (packageName) {
                "com.tencent.mm" -> {
                    // å¾®ä¿¡æœç´¢
                    Intent().apply {
                        action = Intent.ACTION_VIEW
                        data = android.net.Uri.parse("weixin://")
                        setPackage(packageName)
                    }
                }
                "com.taobao.taobao" -> {
                    // æ·˜å®æœç´¢
                    Intent().apply {
                        action = Intent.ACTION_VIEW
                        data = android.net.Uri.parse("taobao://s.taobao.com/search?q=${android.net.Uri.encode(query)}")
                        setPackage(packageName)
                    }
                }
                "com.jingdong.app.mall" -> {
                    // äº¬ä¸œæœç´¢
                    Intent().apply {
                        action = Intent.ACTION_VIEW
                        data = android.net.Uri.parse("openjd://virtual?params={\"des\":\"productList\",\"keyWord\":\"${query}\"}")
                        setPackage(packageName)
                    }
                }
                "com.ss.android.ugc.aweme" -> {
                    // æŠ–éŸ³æœç´¢
                    Intent().apply {
                        action = Intent.ACTION_VIEW
                        data = android.net.Uri.parse("snssdk1128://search/tabs?keyword=${android.net.Uri.encode(query)}")
                        setPackage(packageName)
                    }
                }
                "com.xingin.xhs" -> {
                    // å°çº¢ä¹¦æœç´¢
                    Intent().apply {
                        action = Intent.ACTION_VIEW
                        data = android.net.Uri.parse("xhsdiscover://search/result?keyword=${android.net.Uri.encode(query)}")
                        setPackage(packageName)
                    }
                }
                "com.sankuai.meituan" -> {
                    // ç¾å›¢æœç´¢
                    Intent().apply {
                        action = Intent.ACTION_VIEW
                        data = android.net.Uri.parse("imeituan://www.meituan.com/search?q=${android.net.Uri.encode(query)}")
                        setPackage(packageName)
                    }
                }
                "me.ele" -> {
                    // é¥¿äº†ä¹ˆæœç´¢
                    Intent().apply {
                        action = Intent.ACTION_VIEW
                        data = android.net.Uri.parse("eleme://search?keyword=${android.net.Uri.encode(query)}")
                        setPackage(packageName)
                    }
                }
                "com.android.chrome" -> {
                    // Chromeæµè§ˆå™¨æœç´¢
                    Intent().apply {
                        action = Intent.ACTION_VIEW
                        data = android.net.Uri.parse("googlechrome://www.google.com/search?q=${android.net.Uri.encode(query)}")
                        setPackage(packageName)
                    }
                }
                else -> {
                    // é€šç”¨æœç´¢Intentï¼Œå°è¯•ä½¿ç”¨ACTION_WEB_SEARCH
                    Intent().apply {
                        action = Intent.ACTION_WEB_SEARCH
                        putExtra("query", query)
                        setPackage(packageName)
                    }
                }
            }

            // å°è¯•å¯åŠ¨æœç´¢Intent
            startActivity(searchIntent)
            Log.d(TAG, "æˆåŠŸåœ¨åº”ç”¨ $appName ä¸­å¯åŠ¨æœç´¢: $query")
            Toast.makeText(this, "åœ¨ $appName ä¸­æœç´¢: $query", Toast.LENGTH_SHORT).show()
            return true

        } catch (e: Exception) {
            Log.e(TAG, "åœ¨åº”ç”¨ $appName ä¸­æœç´¢å¤±è´¥", e)
            return false
        }
    }

    /**
     * æ ¹æ®æœç´¢å¼•æ“åç§°è®¾ç½®å½“å‰æœç´¢å¼•æ“
     */
    private fun setCurrentSearchEngineByName(searchEngine: String?, searchEngineName: String?) {
        try {
            Log.d(TAG, "è®¾ç½®æœç´¢å¼•æ“: searchEngine='$searchEngine', searchEngineName='$searchEngineName'")

            // è·å–æ‰€æœ‰å¯ç”¨çš„æœç´¢å¼•æ“
            val allEngines = com.example.aifloatingball.model.SearchEngine.DEFAULT_ENGINES

            // æ ¹æ®æœç´¢å¼•æ“å‚æ•°æŸ¥æ‰¾åŒ¹é…çš„æœç´¢å¼•æ“
            val targetEngine = allEngines.find { engine ->
                when {
                    // ä¼˜å…ˆåŒ¹é… searchEngine å‚æ•°
                    !searchEngine.isNullOrEmpty() -> {
                        engine.name.equals(searchEngine, ignoreCase = true) ||
                        engine.displayName.equals(searchEngine, ignoreCase = true)
                    }
                    // å…¶æ¬¡åŒ¹é… searchEngineName å‚æ•°
                    !searchEngineName.isNullOrEmpty() -> {
                        engine.name.equals(searchEngineName, ignoreCase = true) ||
                        engine.displayName.equals(searchEngineName, ignoreCase = true)
                    }
                    else -> false
                }
            }

            if (targetEngine != null) {
                currentSearchEngine = targetEngine
                Log.d(TAG, "æˆåŠŸè®¾ç½®æœç´¢å¼•æ“: ${targetEngine.displayName} (${targetEngine.name})")
            } else {
                Log.w(TAG, "æœªæ‰¾åˆ°åŒ¹é…çš„æœç´¢å¼•æ“ï¼Œä½¿ç”¨é»˜è®¤æœç´¢å¼•æ“")
                // ä¿æŒå½“å‰æœç´¢å¼•æ“ä¸å˜ï¼Œæˆ–ä½¿ç”¨é»˜è®¤çš„Google
                if (currentSearchEngine == null) {
                    currentSearchEngine = allEngines.find { it.name == "google" } ?: allEngines.firstOrNull()
                }
            }

        } catch (e: Exception) {
            Log.e(TAG, "è®¾ç½®æœç´¢å¼•æ“å¤±è´¥", e)
        }
    }

    /**
     * è·å–æœç´¢å¼•æ“é¦–é¡µURL
     */
    private fun getSearchEngineHomepage(searchEngine: String?, searchEngineName: String?): String? {
        Log.d(TAG, "è·å–æœç´¢å¼•æ“é¦–é¡µ: searchEngine='$searchEngine', searchEngineName='$searchEngineName'")

        return when (searchEngine?.lowercase()) {
            "baidu", "ç™¾åº¦" -> "https://m.baidu.com"
            "google", "è°·æ­Œ" -> "https://www.google.com"
            "bing", "å¿…åº”" -> "https://www.bing.com"
            "sogou", "æœç‹—" -> "https://www.sogou.com"
            "360", "360æœç´¢", "so360" -> "https://www.so.com"
            "yandex" -> "https://www.yandex.com"
            "duckduckgo" -> "https://duckduckgo.com"
            "quark" -> "https://quark.sm.cn"
            else -> {
                // æ ¹æ®æœç´¢å¼•æ“åç§°æ¨æµ‹
                when (searchEngineName?.lowercase()) {
                    "ç™¾åº¦" -> "https://m.baidu.com"
                    "google", "è°·æ­Œ" -> "https://www.google.com"
                    "bing", "å¿…åº”" -> "https://www.bing.com"
                    "æœç‹—" -> "https://www.sogou.com"
                    "360æœç´¢" -> "https://www.so.com"
                    "å¤¸å…‹" -> "https://quark.sm.cn"
                    "duckduckgo" -> "https://duckduckgo.com"
                    else -> {
                        Log.w(TAG, "æœªçŸ¥çš„æœç´¢å¼•æ“: $searchEngine / $searchEngineName")
                        null
                    }
                }
            }
        }
    }

    /**
     * æ˜¾ç¤ºAIé…ç½®å¯¹è¯æ¡†
     */
    private fun showAIConfigurationDialog(aiName: String, queryToUse: String) {
        AlertDialog.Builder(this)
            .setTitle("é…ç½®AIåŠ©æ‰‹")
            .setMessage("è¦ä½¿ç”¨ $aiNameï¼Œè¯·å…ˆé…ç½®APIå¯†é’¥ã€‚\n\næœç´¢å†…å®¹ï¼š$queryToUse")
            .setPositiveButton("å»é…ç½®") { _, _ ->
                // æ‰“å¼€AIè”ç³»äººåˆ—è¡¨ç•Œé¢è¿›è¡Œé…ç½®
                openAIContactListActivity()
            }
            .setNegativeButton("ä½¿ç”¨é»˜è®¤AI") { _, _ ->
                // ä½¿ç”¨é»˜è®¤çš„AIå¯¹è¯å¯åŠ¨
                startAIChatWithQuery(queryToUse)
            }
            .setNeutralButton("å–æ¶ˆ", null)
            .show()
    }

    // ==================== æ¨ªæ»‘é¢„è§ˆæŒ‡ç¤ºå™¨ç›¸å…³æ–¹æ³• ====================

    private var swipePreviewIndicator: View? = null
    private var swipePreviewContainer: LinearLayout? = null
    private var swipePreviewTitle: TextView? = null
    private var swipePreviewDots: MutableList<View> = mutableListOf()

    // åº•éƒ¨tabæ¨ªæ»‘æ‰‹åŠ¿ç›¸å…³
    private var tabSwipeGestureIndicator: View? = null
    private var lastSwipeTime = 0L
    private val swipeDebounceDelay = 300L // é˜²æŠ–å»¶è¿Ÿ300ms

    // æœç´¢tabæ¨ªæ»‘çƒ­åŒºç›¸å…³
    private var searchTabSwipeHotArea: View? = null
    private var searchTabSwipeIndicator: View? = null
    private var lastSearchTabSwipeTime = 0L

    // TabåŒºåŸŸæ»‘åŠ¨ç›¸å…³
    private var tabSwipeIndicator: View? = null
    private var lastTabSwipeTime = 0L
    private val tabSwipeDebounceDelay = 300L

    // å¯¹è¯tabæ¨ªæ»‘æ‰‹åŠ¿ç›¸å…³
    private var chatTabSwipeGestureDetector: GestureDetectorCompat? = null
    private var chatTabSwipeIndicator: View? = null
    private var lastChatTabSwipeTime = 0L

    /**
     * æ˜¾ç¤ºæ¨ªæ»‘é¢„è§ˆæŒ‡ç¤ºå™¨
     */
    private fun showSwipePreviewIndicator(cards: List<GestureCardWebViewManager.WebViewCardData>, currentIndex: Int) {
        if (swipePreviewIndicator == null) {
            createSwipePreviewIndicator()
        }

        // æ›´æ–°æŒ‡ç¤ºå™¨å†…å®¹
        updateSwipePreviewDots(cards.size, currentIndex)

        // æ›´æ–°å½“å‰é¡µé¢æ ‡é¢˜ï¼ˆæ˜¾ç¤ºå‰ä¸¤ä¸ªå­—ï¼‰
        if (currentIndex < cards.size) {
            val title = cards[currentIndex].title
            val shortTitle = if (title.length >= 2) title.substring(0, 2) else title
            swipePreviewTitle?.text = shortTitle
        }

        // æ˜¾ç¤ºæŒ‡ç¤ºå™¨ - ç®€åŒ–åŠ¨ç”»æ•ˆæœ
        swipePreviewIndicator?.apply {
            visibility = View.VISIBLE
            alpha = 0f

            animate()
                .alpha(1f)
                .setDuration(150) // å‡å°‘åŠ¨ç”»æ—¶é—´
                .start()
        }
    }

    /**
     * åˆ›å»ºæ¨ªæ»‘é¢„è§ˆæŒ‡ç¤ºå™¨
     */
    private fun createSwipePreviewIndicator() {
        // åˆ›å»ºä¸»å®¹å™¨ - å‚ç›´å¸ƒå±€ï¼ŒåŒ…å«æŒ‡ç¤ºå™¨å’Œæ ‡é¢˜
        val mainContainer = LinearLayout(this).apply {
            orientation = LinearLayout.VERTICAL
            gravity = android.view.Gravity.CENTER
            setPadding(16, 8, 16, 8)
        }

        // åˆ›å»ºåœ†ç‚¹æŒ‡ç¤ºå™¨å®¹å™¨
        swipePreviewContainer = LinearLayout(this).apply {
            orientation = LinearLayout.HORIZONTAL
            gravity = android.view.Gravity.CENTER
            setPadding(0, 0, 0, 4) // åœ†ç‚¹ä¸‹æ–¹ç•™ç©ºé—´ç»™æ ‡é¢˜
        }

        // åˆ›å»ºæ ‡é¢˜æ˜¾ç¤º
        val titleText = TextView(this).apply {
            textSize = 12f
            setTextColor(android.graphics.Color.WHITE)
            gravity = android.view.Gravity.CENTER
            maxLines = 1
            ellipsize = android.text.TextUtils.TruncateAt.END
        }

        // æ·»åŠ åˆ°ä¸»å®¹å™¨
        mainContainer.addView(swipePreviewContainer)
        mainContainer.addView(titleText)

        // åˆ›å»ºæŒ‡ç¤ºå™¨èƒŒæ™¯ - å»æ‰é€æ˜åŒºåŸŸï¼Œåªä¿ç•™æŒ‡ç¤ºå™¨
        swipePreviewIndicator = FrameLayout(this).apply {
            layoutParams = FrameLayout.LayoutParams(
                FrameLayout.LayoutParams.WRAP_CONTENT,
                FrameLayout.LayoutParams.WRAP_CONTENT
            ).apply {
                gravity = android.view.Gravity.BOTTOM or android.view.Gravity.CENTER_HORIZONTAL
                bottomMargin = 100 // è·ç¦»åº•éƒ¨100dpï¼Œé¿å…é®æŒ¡tabåŒºåŸŸ
            }

            // å»æ‰èƒŒæ™¯ï¼Œåªä¿ç•™å†…å®¹
            background = null
            elevation = 0f

            addView(mainContainer)
            visibility = View.GONE
        }

        // ä¿å­˜æ ‡é¢˜å¼•ç”¨
        swipePreviewTitle = titleText

        // æ·»åŠ åˆ°ä¸»å¸ƒå±€
        browserLayout.addView(swipePreviewIndicator)
    }

    /**
     * æ›´æ–°æ¨ªæ»‘é¢„è§ˆæŒ‡ç¤ºå™¨çš„ç‚¹
     */
    private fun updateSwipePreviewDots(cardCount: Int, currentIndex: Int) {
        swipePreviewContainer?.removeAllViews()
        swipePreviewDots.clear()

        for (i in 0 until cardCount) {
            val dot = View(this).apply {
                layoutParams = LinearLayout.LayoutParams(12, 12).apply { // å‡å°åœ†ç‚¹å°ºå¯¸
                    setMargins(4, 0, 4, 0)
                }
                background = android.graphics.drawable.GradientDrawable().apply {
                    shape = android.graphics.drawable.GradientDrawable.OVAL
                    if (i == currentIndex) {
                        setColor(android.graphics.Color.WHITE) // å½“å‰é¡µé¢ç™½è‰²
                    } else {
                        setColor(android.graphics.Color.parseColor("#80FFFFFF")) // å…¶ä»–é¡µé¢åŠé€æ˜ç™½è‰²
                    }
                }
            }
            swipePreviewDots.add(dot)
            swipePreviewContainer?.addView(dot)
        }
    }

    /**
     * æ›´æ–°æ¨ªæ»‘é¢„è§ˆæŒ‡ç¤ºå™¨ä½ç½®
     */
    private fun updateSwipePreviewIndicator(position: Int, positionOffset: Float) {
        // æ›´æ–°å½“å‰æ´»è·ƒçš„ç‚¹
        swipePreviewDots.forEachIndexed { index, dot ->
            val alpha = when {
                index == position -> 1f - positionOffset
                index == position + 1 -> positionOffset
                else -> 0.5f
            }
            dot.alpha = alpha
        }

        // æ›´æ–°æ ‡é¢˜æ˜¾ç¤º
        val cards = gestureCardWebViewManager?.getAllCards() ?: return
        val currentIndex = if (positionOffset > 0.5f && position + 1 < cards.size) position + 1 else position
        if (currentIndex < cards.size) {
            val title = cards[currentIndex].title
            val shortTitle = if (title.length >= 2) title.substring(0, 2) else title
            swipePreviewTitle?.text = shortTitle
        }
    }

    /**
     * éšè—æ¨ªæ»‘é¢„è§ˆæŒ‡ç¤ºå™¨
     */
    private fun hideSwipePreviewIndicator() {
        swipePreviewIndicator?.animate()
            ?.alpha(0f)
            ?.setDuration(150) // å‡å°‘åŠ¨ç”»æ—¶é—´
            ?.withEndAction {
                swipePreviewIndicator?.visibility = View.GONE
            }
            ?.start()
    }

    // ==================== åº•éƒ¨tabåŒºåŸŸæ¨ªæ»‘æ‰‹åŠ¿å¤„ç† ====================

    /**
     * è®¾ç½®åº•éƒ¨tabåŒºåŸŸçš„æ¨ªæ»‘æ‰‹åŠ¿ - ä¸“é—¨ç”¨äºåˆ‡æ¢webviewå¡ç‰‡
     * æ³¨æ„ï¼šç°åœ¨æ‰‹åŠ¿æ£€æµ‹å·²ç»é›†æˆåˆ°setupBottomNavigationä¸­çš„æ¯ä¸ªtab
     */
    private fun setupTabAreaSwipeGesture() {
        Log.d(TAG, "âœ… åº•éƒ¨tabåŒºåŸŸwebviewå¡ç‰‡åˆ‡æ¢æ‰‹åŠ¿å·²é›†æˆåˆ°setupBottomNavigationä¸­")

        // æ·»åŠ é•¿æŒ‰æµ‹è¯•åŠŸèƒ½åˆ°æ•´ä¸ªåº•éƒ¨å¯¼èˆªæ 
        val bottomNav = findViewById<LinearLayout>(R.id.bottom_navigation)
        bottomNav?.setOnLongClickListener {
            if (getCurrentTabIndex() == 1) {
                // è°ƒè¯•ï¼šæµ‹è¯•æ–°çš„æ‰‹åŠ¿æœºåˆ¶
                testNewGestureMechanism()
            } else {
                Toast.makeText(this@SimpleModeActivity, "è¯·å…ˆåˆ‡æ¢åˆ°æœç´¢tabå†æµ‹è¯•", Toast.LENGTH_SHORT).show()
            }
            true
        }
    }

    /**
     * åˆ›å»ºwebviewå¡ç‰‡åˆ‡æ¢æ‰‹åŠ¿æ£€æµ‹å™¨
     */
    private fun createWebViewCardSwipeDetector(): GestureDetector {
        return GestureDetector(this, object : GestureDetector.SimpleOnGestureListener() {
            override fun onFling(
                e1: MotionEvent?,
                e2: MotionEvent,
                velocityX: Float,
                velocityY: Float
            ): Boolean {
                if (e1 == null) return false

                // é˜²æŠ–å¤„ç†
                val currentTime = System.currentTimeMillis()
                if (currentTime - lastSwipeTime < swipeDebounceDelay) {
                    Log.d(TAG, "ğŸš« æ‰‹åŠ¿é˜²æŠ–ï¼Œå¿½ç•¥æ­¤æ¬¡æ“ä½œ")
                    return false
                }

                val deltaX = e2.x - e1.x
                val deltaY = e2.y - e1.y

                // ç¡®ä¿æ˜¯æ°´å¹³æ»‘åŠ¨ä¸”æ»‘åŠ¨è·ç¦»è¶³å¤Ÿ
                if (abs(deltaX) > abs(deltaY) && abs(deltaX) > 80) { // é™ä½åˆ°80px
                    lastSwipeTime = currentTime

                    Log.d(TAG, "ğŸ¯ åº•éƒ¨tabæ£€æµ‹åˆ°æ¨ªæ»‘æ‰‹åŠ¿ï¼ŒdeltaX: $deltaX, å½“å‰tab: ${getCurrentTabIndex()}")

                    // æ ¹æ®å½“å‰tabæ‰§è¡Œä¸åŒçš„åˆ‡æ¢é€»è¾‘
                    when (getCurrentTabIndex()) {
                        0 -> { // 0 = CHAT (å¯¹è¯tab)
                            if (deltaX > 0) {
                                // å‘å³æ»‘åŠ¨ï¼Œåˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªå¯¹è¯æ ‡ç­¾ï¼ˆå³è¾¹çš„æ ‡ç­¾ï¼‰
                                val targetTabName = switchToNextChatTab()
                                showChatTabSwipeIndicator(targetTabName ?: "ä¸‹ä¸€ä¸ªæ ‡ç­¾")
                                Log.d(TAG, "âœ… åº•éƒ¨tabå³æ»‘æˆåŠŸ - åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªå¯¹è¯æ ‡ç­¾: $targetTabName")
                            } else {
                                // å‘å·¦æ»‘åŠ¨ï¼Œåˆ‡æ¢åˆ°ä¸Šä¸€ä¸ªå¯¹è¯æ ‡ç­¾ï¼ˆå·¦è¾¹çš„æ ‡ç­¾ï¼‰
                                val targetTabName = switchToPreviousChatTab()
                                showChatTabSwipeIndicator(targetTabName ?: "ä¸Šä¸€ä¸ªæ ‡ç­¾")
                                Log.d(TAG, "âœ… åº•éƒ¨tabå·¦æ»‘æˆåŠŸ - åˆ‡æ¢åˆ°ä¸Šä¸€ä¸ªå¯¹è¯æ ‡ç­¾: $targetTabName")
                            }
                            return true
                        }
                        1 -> { // 1 = BROWSER (æœç´¢tab)
                            // æ£€æŸ¥æ˜¯å¦æœ‰æ´»åŠ¨çš„WebView
                            val hasActiveWebView = gestureCardWebViewManager?.getCurrentCard()?.webView != null
                            if (hasActiveWebView) {
                                if (deltaX > 0) {
                                    // å‘å³æ»‘åŠ¨ï¼Œç½‘é¡µåé€€
                                    goBackInCurrentWebView()
                                    showSearchTabSwipeIndicator("åé€€")
                                    Log.d(TAG, "âœ… åº•éƒ¨tabå³æ»‘æˆåŠŸ - ç½‘é¡µåé€€")
                                } else {
                                    // å‘å·¦æ»‘åŠ¨ï¼Œç½‘é¡µå‰è¿›
                                    goForwardInCurrentWebView()
                                    showSearchTabSwipeIndicator("å‰è¿›")
                                    Log.d(TAG, "âœ… åº•éƒ¨tabå·¦æ»‘æˆåŠŸ - ç½‘é¡µå‰è¿›")
                                }
                                return true
                            } else {
                                // æ²¡æœ‰æ´»åŠ¨çš„WebViewï¼Œæ¶ˆè´¹äº‹ä»¶é˜²æ­¢ç³»ç»Ÿå¤„ç†
                                Log.d(TAG, "âš ï¸ æœç´¢tabæ²¡æœ‰æ´»åŠ¨çš„WebViewï¼Œæ¶ˆè´¹ä¾§æ»‘æ‰‹åŠ¿é˜²æ­¢ç³»ç»Ÿå¤„ç†")
                                return true
                            }
                        }
                        else -> {
                            // å…¶ä»–tabæš‚ä¸æ”¯æŒæ¨ªæ»‘åŠŸèƒ½
                            Log.d(TAG, "âš ï¸ å½“å‰tabä¸æ”¯æŒæ¨ªæ»‘åŠŸèƒ½ï¼Œå½“å‰tab: ${getCurrentTabIndex()}")
                        }
                    }
                } else {
                    Log.d(TAG, "ğŸš« æ‰‹åŠ¿ä¸ç¬¦åˆæ¡ä»¶ - deltaX: $deltaX, deltaY: $deltaY")
                }
                return false
            }

            override fun onDown(e: MotionEvent): Boolean {
                Log.d(TAG, "ğŸ‘† åº•éƒ¨tabåŒºåŸŸæŒ‰ä¸‹ï¼Œå½“å‰tab: ${getCurrentTabIndex()}")
                return true
            }
        })
    }

    /**
     * è®¾ç½®Materialæ³¢æµªè¿½è¸ªå™¨å’Œå±‚å å¡ç‰‡é¢„è§ˆå™¨
     */
    private fun setupMaterialWaveTracker() {
        try {
            // åˆ›å»ºå±‚å å¡ç‰‡é¢„è§ˆå™¨ï¼ˆæ–°çš„ä¸»è¦é¢„è§ˆæ–¹å¼ï¼‰
            stackedCardPreview = com.example.aifloatingball.views.StackedCardPreview(this).apply {
                // è®¾ç½®å±‚çº§
                elevation = 18f

                // è®¾ç½®åº•éƒ¨å¯¼èˆªæ é«˜åº¦æä¾›è€…
                setBottomNavHeightProvider {
                    val bottomNav = findViewById<LinearLayout>(R.id.bottom_navigation)
                    if (bottomNav != null && bottomNav.height > 0) {
                        bottomNav.height
                    } else {
                        // ä½¿ç”¨å¸ƒå±€ä¸­å®šä¹‰çš„64dpé«˜åº¦ä½œä¸ºfallback
                        (64 * resources.displayMetrics.density).toInt()
                    }
                }

                // è®¾ç½®å¡ç‰‡é€‰æ‹©ç›‘å¬å™¨
                setOnCardSelectedListener { cardIndex ->
                    // åˆ‡æ¢åˆ°é€‰ä¸­çš„å¡ç‰‡
                    Log.d(TAG, "ğŸ¯ StackedCardPreview é€‰æ‹©å¡ç‰‡: $cardIndex")
                    switchToWebViewCard(cardIndex)
                }

                // è®¾ç½®å¡ç‰‡å…³é—­ç›‘å¬å™¨
                setOnCardCloseListener { url ->
                    // é€šè¿‡URLå…³é—­æŒ‡å®šçš„webviewå¡ç‰‡
                    Log.d(TAG, "ğŸ”— StackedCardPreview è¯·æ±‚å…³é—­å¡ç‰‡: $url")
                    closeWebViewCardByUrl(url)
                }

                // æ·»åŠ æµ‹è¯•æ–¹æ³•ï¼Œæ–¹ä¾¿è°ƒè¯•
                Log.d(TAG, "ğŸ“Š StackedCardPreview åˆå§‹çŠ¶æ€ï¼š")
                printDebugInfo()

                // æ£€æŸ¥SharedPreferencesçŠ¶æ€
                checkSavedState()

                // è®¾ç½®å¡ç‰‡åˆ·æ–°ç›‘å¬å™¨
                setOnCardRefreshListener { cardIndex ->
                    // åˆ·æ–°æŒ‡å®šçš„webviewå¡ç‰‡
                    refreshWebViewCard(cardIndex)
                }

                // è®¾ç½®æ‰€æœ‰å¡ç‰‡ç§»é™¤ç›‘å¬å™¨
                setOnAllCardsRemovedListener {
                    // æ‰€æœ‰å¡ç‰‡éƒ½è¢«ç§»é™¤äº†ï¼Œè¿”å›æœç´¢tab
                    browserLayout.postDelayed({
                        switchToSearchTab()
                        Log.d(TAG, "æ‰€æœ‰å¡ç‰‡å·²ç§»é™¤ï¼Œè¿”å›æœç´¢tab")
                    }, 300)
                }

                // è®¾ç½®æ–°å»ºå¡ç‰‡è¯·æ±‚ç›‘å¬å™¨
                setOnNewCardRequestedListener {
                    Log.d(TAG, "ğŸ“± æ‚¬æµ®å¡ç‰‡ä¸­çš„æ–°å»ºæŒ‰é’®è¢«ç‚¹å‡»")
                    try {
                        // æ˜¾ç¤ºæ–°å»ºå¡ç‰‡é€‰æ‹©å¼¹çª—
                        showNewCardSelectionDialog()
                    } catch (e: Exception) {
                        Log.e(TAG, "æ˜¾ç¤ºæ–°å»ºå¡ç‰‡å¼¹çª—å¤±è´¥ï¼Œå°è¯•ç›´æ¥åˆ›å»ºæ–°WebViewå¡ç‰‡", e)
                        // å¦‚æœå¯¹è¯æ¡†æ— æ³•æ˜¾ç¤ºï¼Œç›´æ¥åˆ›å»ºæ–°çš„WebViewå¡ç‰‡ä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆ
                        try {
                            createNewWebViewCardForFloatingCard()
                        } catch (e2: Exception) {
                            Log.e(TAG, "åˆ›å»ºæ–°å¡ç‰‡ä¹Ÿå¤±è´¥", e2)
                            Toast.makeText(this@SimpleModeActivity, "åˆ›å»ºå¡ç‰‡å¤±è´¥ï¼Œè¯·é‡è¯•", Toast.LENGTH_SHORT).show()
                        }
                    }
                }
                
                // è®¾ç½®å¡ç‰‡æ”¶è—ç›‘å¬å™¨
                setOnCardFavoriteListener { cardIndex, url ->
                    Log.d(TAG, "â­ æ‚¬æµ®å¡ç‰‡ä¸­çš„æ”¶è—æŒ‰é’®è¢«ç‚¹å‡»: index=$cardIndex, url=$url")
                    try {
                        if (url.isNullOrBlank()) {
                            Toast.makeText(this@SimpleModeActivity, "æ— æ³•æ”¶è—ï¼šURLä¸ºç©º", Toast.LENGTH_SHORT).show()
                            return@setOnCardFavoriteListener
                        }
                        
                        // ä»ç»Ÿä¸€å¡ç‰‡æ•°æ®ä¸­è·å–å¡ç‰‡æ ‡é¢˜
                        val allCards = getAllUnifiedCards()
                        val cardTitle = try {
                            // ä¼˜å…ˆä»ç´¢å¼•è·å–
                            if (cardIndex >= 0 && cardIndex < allCards.size) {
                                val card = allCards[cardIndex]
                                val cardUrl = card.url ?: ""
                                if (card.title.isNotEmpty() && card.title != "æ–°æ ‡ç­¾é¡µ" && card.title != "åŠ è½½ä¸­...") {
                                    card.title
                                } else {
                                    cardUrl.ifEmpty { "æœªå‘½åé¡µé¢" }
                                }
                            } else {
                                // å¦‚æœç´¢å¼•æ— æ•ˆï¼Œä»URLæŸ¥æ‰¾
                                val foundCard = allCards.firstOrNull { 
                                    val cardUrl = it.url ?: ""
                                    cardUrl == url || cardUrl.equals(url, ignoreCase = true)
                                }
                                if (foundCard != null) {
                                    val cardTitle = foundCard.title
                                    if (cardTitle.isNotEmpty() && cardTitle != "æ–°æ ‡ç­¾é¡µ" && cardTitle != "åŠ è½½ä¸­...") {
                                        cardTitle
                                    } else {
                                        url
                                    }
                                } else {
                                    url
                                }
                            }
                        } catch (e: Exception) {
                            Log.w(TAG, "è·å–å¡ç‰‡æ ‡é¢˜å¤±è´¥ï¼Œä½¿ç”¨URLä½œä¸ºæ ‡é¢˜", e)
                            url
                        }
                        
                        // åˆ›å»ºå†å²è®°å½•æ¡ç›®ç”¨äºæ”¶è—
                        val historyEntry = com.example.aifloatingball.model.HistoryEntry(
                            id = System.currentTimeMillis().toString(),
                            title = cardTitle,
                            url = url,
                            visitTime = java.util.Date()
                        )
                        
                        // æ·»åŠ åˆ°æ”¶è—
                        addBookmarkFromHistoryEntry(historyEntry)
                        Toast.makeText(this@SimpleModeActivity, "å·²æ·»åŠ åˆ°æ”¶è—", Toast.LENGTH_SHORT).show()
                    } catch (e: Exception) {
                        Log.e(TAG, "æ”¶è—å¡ç‰‡å¤±è´¥", e)
                        Toast.makeText(this@SimpleModeActivity, "æ”¶è—å¤±è´¥: ${e.message}", Toast.LENGTH_SHORT).show()
                    }
                }
                
                // è®¾ç½®å¤åˆ¶ç½‘å€ç›‘å¬å™¨
                setOnCardCopyUrlListener { cardIndex, url ->
                    Log.d(TAG, "ğŸ“‹ æ‚¬æµ®å¡ç‰‡ä¸­çš„å¤åˆ¶ç½‘å€æŒ‰é’®è¢«ç‚¹å‡»: index=$cardIndex, url=$url")
                    try {
                        if (url.isNullOrBlank()) {
                            Toast.makeText(this@SimpleModeActivity, "æ— æ³•å¤åˆ¶ï¼šURLä¸ºç©º", Toast.LENGTH_SHORT).show()
                            return@setOnCardCopyUrlListener
                        }
                        
                        val clipboard = getSystemService(Context.CLIPBOARD_SERVICE) as ClipboardManager
                        val clip = ClipData.newPlainText("URL", url)
                        clipboard.setPrimaryClip(clip)
                        Toast.makeText(this@SimpleModeActivity, "ç½‘å€å·²å¤åˆ¶", Toast.LENGTH_SHORT).show()
                    } catch (e: Exception) {
                        Log.e(TAG, "å¤åˆ¶ç½‘å€å¤±è´¥", e)
                        Toast.makeText(this@SimpleModeActivity, "å¤åˆ¶å¤±è´¥: ${e.message}", Toast.LENGTH_SHORT).show()
                    }
                }
            }

            // ä¿ç•™åŸæœ‰çš„Materialæ³¢æµªè¿½è¸ªå™¨ä½œä¸ºå¤‡ç”¨
            materialWaveTracker = com.example.aifloatingball.views.MaterialWaveTracker(this).apply {
                // è®¾ç½®å¡ç‰‡é¢œè‰²
                setCardColor(android.graphics.Color.WHITE)

                // è®¾ç½®å±‚çº§
                elevation = 16f

                // è®¾ç½®åº•éƒ¨å¯¼èˆªæ é«˜åº¦æä¾›è€…
                setBottomNavHeightProvider {
                    val bottomNav = findViewById<LinearLayout>(R.id.bottom_navigation)
                    if (bottomNav != null && bottomNav.height > 0) {
                        bottomNav.height
                    } else {
                        // ä½¿ç”¨å¸ƒå±€ä¸­å®šä¹‰çš„64dpé«˜åº¦ä½œä¸ºfallback
                        (64 * resources.displayMetrics.density).toInt()
                    }
                }

                // è®¾ç½®å¡ç‰‡é€‰æ‹©ç›‘å¬å™¨
                setOnCardSelectedListener { cardIndex ->
                    // åˆ‡æ¢åˆ°é€‰ä¸­çš„å¡ç‰‡
                    switchToWebViewCard(cardIndex)
                }
            }

            // å°†é¢„è§ˆå™¨æ·»åŠ ä¸ºç‹¬ç«‹çš„è¦†ç›–å±‚ï¼Œä¸å½±å“åº•éƒ¨å¯¼èˆªæ 
            // è·å–Activityçš„æ ¹è§†å›¾ï¼ˆDecorViewï¼‰ï¼Œè¿™æ ·ä¸ä¼šå½±å“å¸ƒå±€
            val decorView = window.decorView as ViewGroup
            val bottomNav = findViewById<LinearLayout>(R.id.bottom_navigation)

            if (decorView != null && bottomNav != null) {
                // æ·»åŠ å±‚å å¡ç‰‡é¢„è§ˆå™¨ï¼ˆä¸»è¦é¢„è§ˆæ–¹å¼ï¼‰
                stackedCardPreview?.apply {
                    // è®¾ç½®ä¸ºå…¨å±è¦†ç›–ï¼Œä½†ä¸å½±å“å¸ƒå±€
                    layoutParams = ViewGroup.LayoutParams(
                        ViewGroup.LayoutParams.MATCH_PARENT,
                        ViewGroup.LayoutParams.MATCH_PARENT
                    )

                    // åˆå§‹çŠ¶æ€è®¾ç½®ä¸ºä¸å¯äº¤äº’ï¼Œæ¿€æ´»æ—¶ä¼šé‡æ–°è®¾ç½®
                    isClickable = false
                    isFocusable = false
                    isFocusableInTouchMode = false
                    isEnabled = false
                    // åˆå§‹çŠ¶æ€éšè—
                    visibility = View.GONE

                    // ä¸è®¾ç½®OnTouchListenerï¼Œè®©StackedCardPreviewè‡ªå·±å¤„ç†è§¦æ‘¸äº‹ä»¶
                }

                // å°†Materialæ³¢æµªè¿½è¸ªå™¨æ·»åŠ åˆ°DecorViewä½œä¸ºè¦†ç›–å±‚ï¼ˆå¤‡ç”¨ï¼‰
                materialWaveTracker?.apply {
                    // è®¾ç½®ä¸ºå…¨å±è¦†ç›–ï¼Œä½†ä¸å½±å“å¸ƒå±€
                    layoutParams = ViewGroup.LayoutParams(
                        ViewGroup.LayoutParams.MATCH_PARENT,
                        ViewGroup.LayoutParams.MATCH_PARENT
                    )

                    // è®¾ç½®ä¸ºå®Œå…¨ä¸å¯äº¤äº’ï¼Œè®©è§¦æ‘¸äº‹ä»¶ç©¿é€åˆ°åº•å±‚
                    isClickable = false
                    isFocusable = false
                    isFocusableInTouchMode = false
                    isEnabled = false
                    // åˆå§‹çŠ¶æ€éšè—
                    visibility = View.GONE

                    // ç¡®ä¿ä¸æ‹¦æˆªè§¦æ‘¸äº‹ä»¶
                    setOnTouchListener { _, _ -> false }
                }

                // æ·»åŠ åˆ°DecorViewä½œä¸ºæœ€é¡¶å±‚çš„è¦†ç›–å±‚ï¼Œä¸å½±å“åŸæœ‰å¸ƒå±€
                decorView.addView(stackedCardPreview)
                decorView.addView(materialWaveTracker)

                // åˆå§‹åŒ–å¡ç‰‡æ•°æ®
                updateWaveTrackerCards()

                Log.d(TAG, "âœ… å¡ç‰‡é¢„è§ˆæ³¢æµªè¿½è¸ªå™¨å·²æˆåŠŸè®¾ç½®")
            } else {
                Log.e(TAG, "âŒ æ— æ³•æ‰¾åˆ°åº•éƒ¨å¯¼èˆªæ æˆ–æ ¹å¸ƒå±€")
            }
        } catch (e: Exception) {
            Log.e(TAG, "âŒ è®¾ç½®Materialæ³¢æµªè¿½è¸ªå™¨å¤±è´¥", e)
        }
    }

    /**
     * æ›´æ–°å¡ç‰‡é¢„è§ˆå™¨çš„å¡ç‰‡æ•°æ®
     */
    private fun updateWaveTrackerCards() {
        try {
            // ä½¿ç”¨StackedCardPreviewä¸“ç”¨çš„å¡ç‰‡æ•°æ®è·å–æ–¹æ³•ï¼Œæ’é™¤è‡ªåŠ¨åˆ›å»ºçš„baidué¦–é¡µ
            val allCards = getStackedCardPreviewCards()

            Log.d(TAG, "æ›´æ–°å¡ç‰‡é¢„è§ˆå™¨ - æ€»è®¡: ${allCards.size}")

            if (allCards.isNotEmpty()) {
                // ä¸ºMaterialWaveTrackerå‡†å¤‡æ•°æ®
                val waveTrackerCardDataList = allCards.map { cardData ->
                    com.example.aifloatingball.views.MaterialWaveTracker.WebViewCardData(
                        title = cardData.title ?: "æ— æ ‡é¢˜",
                        url = cardData.url ?: "",
                        favicon = null, // å¯ä»¥åç»­æ·»åŠ faviconæ”¯æŒ
                        screenshot = cardData.screenshot ?: cardData.webView?.let { webView ->
                            // ğŸ”§ ä¿®å¤4ï¼šä¼˜å…ˆä½¿ç”¨ä¿å­˜çš„æˆªå›¾ï¼Œå¦‚æœæ²¡æœ‰åˆ™å°è¯•è·å–WebViewæˆªå›¾
                            try {
                                val bitmap = Bitmap.createBitmap(
                                    webView.width,
                                    webView.height,
                                    Bitmap.Config.ARGB_8888
                                )
                                val canvas = Canvas(bitmap)
                                webView.draw(canvas)
                                bitmap
                            } catch (e: Exception) {
                                Log.w(TAG, "è·å–WebViewæˆªå›¾å¤±è´¥", e)
                                null
                            }
                        }
                    )
                }

                // ä¸ºStackedCardPreviewå‡†å¤‡æ•°æ®
                val stackedCardDataList = allCards.map { cardData ->
                    com.example.aifloatingball.views.StackedCardPreview.WebViewCardData(
                        title = cardData.title ?: "æ— æ ‡é¢˜",
                        url = cardData.url ?: "",
                        favicon = null, // å¯ä»¥åç»­æ·»åŠ faviconæ”¯æŒ
                        screenshot = cardData.screenshot ?: cardData.webView?.let { webView ->
                            // ğŸ”§ ä¿®å¤4ï¼šä¼˜å…ˆä½¿ç”¨ä¿å­˜çš„æˆªå›¾ï¼Œå¦‚æœæ²¡æœ‰åˆ™å°è¯•è·å–WebViewæˆªå›¾
                            try {
                                val bitmap = Bitmap.createBitmap(
                                    webView.width,
                                    webView.height,
                                    Bitmap.Config.ARGB_8888
                                )
                                val canvas = Canvas(bitmap)
                                webView.draw(canvas)
                                bitmap
                            } catch (e: Exception) {
                                Log.w(TAG, "è·å–WebViewæˆªå›¾å¤±è´¥", e)
                                null
                            }
                        }
                    )
                }

                // æ›´æ–°ä¸¤ä¸ªé¢„è§ˆå™¨
                materialWaveTracker?.updateWebViewCards(waveTrackerCardDataList)
                stackedCardPreview?.setWebViewCards(stackedCardDataList)
                Log.d(TAG, "âœ… æ›´æ–°äº† ${stackedCardDataList.size} ä¸ªå¡ç‰‡åˆ°é¢„è§ˆå™¨")
            } else {
                Log.d(TAG, "æ²¡æœ‰å¡ç‰‡éœ€è¦æ›´æ–°åˆ°é¢„è§ˆå™¨")
            }
        } catch (e: Exception) {
            Log.e(TAG, "âŒ æ›´æ–°å¡ç‰‡é¢„è§ˆå™¨æ•°æ®å¤±è´¥", e)
        }
    }

    /**
     * åˆ‡æ¢åˆ°æŒ‡å®šçš„webviewå¡ç‰‡
     */
    private fun switchToWebViewCard(cardIndex: Int) {
        try {
            Log.d(TAG, "ğŸ¯ åˆ‡æ¢åˆ°å¡ç‰‡: $cardIndex")
            
            // è·å–ç»Ÿä¸€å¡ç‰‡æ•°æ®
            val allCards = getAllUnifiedCards()
            if (cardIndex >= 0 && cardIndex < allCards.size) {
                val selectedCard = allCards[cardIndex]
                Log.d(TAG, "é€‰ä¸­å¡ç‰‡: ${selectedCard.title} - ${selectedCard.url}")
                
                // æ£€æŸ¥å¡ç‰‡æ¥æºï¼Œå†³å®šå¦‚ä½•åˆ‡æ¢
                val paperStackTabs = paperStackWebViewManager?.getAllTabs() ?: emptyList()
                val isPaperStackCard = paperStackTabs.any { it.url == selectedCard.url }
                
                if (isPaperStackCard) {
                    // å¦‚æœæ˜¯çº¸å †æ ‡ç­¾é¡µï¼Œåˆ‡æ¢åˆ°çº¸å †æ¨¡å¼
                    Log.d(TAG, "åˆ‡æ¢åˆ°çº¸å †æ¨¡å¼æ ‡ç­¾é¡µ")
                    switchToPaperStackTab(selectedCard.url)
                } else {
                    // å¦‚æœæ˜¯å…¶ä»–å¡ç‰‡ï¼Œä½¿ç”¨åŸæœ‰é€»è¾‘
                    Log.d(TAG, "åˆ‡æ¢åˆ°æ‰‹åŠ¿å¡ç‰‡")
                    gestureCardWebViewManager?.let { manager ->
                        val gestureCards = manager.getAllCards()
                        val gestureCardIndex = gestureCards.indexOfFirst { it.url == selectedCard.url }
                        if (gestureCardIndex >= 0) {
                            manager.switchToCard(gestureCardIndex)
                            Log.d(TAG, "âœ… é€šè¿‡å¡ç‰‡é¢„è§ˆåˆ‡æ¢åˆ°æ‰‹åŠ¿å¡ç‰‡: $gestureCardIndex")
                        }
                    }
                }
                
                // æ›´æ–°å¡ç‰‡æ•°æ®ï¼ˆå¯èƒ½æœ‰å˜åŒ–ï¼‰
                updateWaveTrackerCards()
            } else {
                Log.w(TAG, "âš ï¸ æ— æ•ˆçš„å¡ç‰‡ç´¢å¼•: $cardIndex")
            }
        } catch (e: Exception) {
            Log.e(TAG, "âŒ åˆ‡æ¢åˆ°webviewå¡ç‰‡å¤±è´¥", e)
        }
    }
    
    /**
     * åˆ‡æ¢åˆ°çº¸å †æ¨¡å¼çš„æŒ‡å®šæ ‡ç­¾é¡µ
     */
    private fun switchToPaperStackTab(url: String) {
        try {
            val paperStackTabs = paperStackWebViewManager?.getAllTabs() ?: emptyList()
            val tabIndex = paperStackTabs.indexOfFirst { it.url == url }
            
            if (tabIndex >= 0) {
                // ç¡®ä¿åœ¨çº¸å †æ¨¡å¼ä¸‹
                val paperStackLayout = findViewById<View>(R.id.paper_stack_layout)
                paperStackLayout?.visibility = View.VISIBLE
                browserHomeContent.visibility = View.GONE
                browserTabContainer.visibility = View.GONE
                
                // åˆ‡æ¢åˆ°æŒ‡å®šæ ‡ç­¾é¡µ
                paperStackWebViewManager?.switchToTab(tabIndex)
                
                // æ›´æ–°æœç´¢æ¡†æ˜¾ç¤ºå½“å‰URL
                browserSearchInput.setText(url)
                
                // å…³é—­StackedCardPreview
                deactivateStackedCardPreview()
                
                Log.d(TAG, "âœ… å·²åˆ‡æ¢åˆ°çº¸å †æ ‡ç­¾é¡µ: ${paperStackTabs[tabIndex].title}")
            } else {
                Log.w(TAG, "âš ï¸ æœªæ‰¾åˆ°URLå¯¹åº”çš„çº¸å †æ ‡ç­¾é¡µ: $url")
            }
        } catch (e: Exception) {
            Log.e(TAG, "âŒ åˆ‡æ¢åˆ°çº¸å †æ ‡ç­¾é¡µå¤±è´¥", e)
        }
    }

    /**
     * é€šè¿‡URLå…³é—­æŒ‡å®šçš„webviewå¡ç‰‡
     */
    private fun closeWebViewCardByUrl(url: String) {
        try {
            Log.d(TAG, "ğŸ”¥ å¼€å§‹å…³é—­å¡ç‰‡ï¼ŒURL: $url")

            // æ£€æŸ¥æ˜¯å¦æ˜¯åŠŸèƒ½ä¸»é¡µï¼Œå¦‚æœæ˜¯åˆ™ä¸å…è®¸å…³é—­
            if (url == "home://functional") {
                Log.d(TAG, "âš ï¸ åŠŸèƒ½ä¸»é¡µä¸èƒ½è¢«å…³é—­")
                Toast.makeText(this, "åŠŸèƒ½ä¸»é¡µä¸èƒ½è¢«å…³é—­", Toast.LENGTH_SHORT).show()
                return
            }

            var cardClosed = false

            // å…³é”®ä¿®å¤ï¼šåŒæ—¶ä»ä¸¤ä¸ªç®¡ç†å™¨ä¸­æŸ¥æ‰¾å¹¶åˆ é™¤å¡ç‰‡
            // 1. ä»GestureCardWebViewManagerä¸­åˆ é™¤
            gestureCardWebViewManager?.let { manager ->
                val allCards = manager.getAllCards()
                val cardIndex = allCards.indexOfFirst { it.url == url }

                if (cardIndex >= 0) {
                    val cardData = allCards[cardIndex]
                    Log.d(TAG, "ğŸ“ åœ¨GestureCardWebViewManagerä¸­æ‰¾åˆ°å¡ç‰‡: ${cardData.title}")

                    // å…³é”®ä¿®å¤ï¼šå½»åº•é”€æ¯WebViewï¼Œç¡®ä¿ç½‘é¡µå®Œå…¨å…³é—­
                    cardData.webView?.let { webView ->
                        try {
                            Log.d(TAG, "å¼€å§‹å½»åº•é”€æ¯WebView: ${cardData.title}")

                            // 1. åœæ­¢æ‰€æœ‰åŠ è½½å’ŒJavaScriptæ‰§è¡Œ
                            webView.stopLoading()

                            // 2. åŠ è½½ç©ºç™½é¡µé¢ï¼Œåœæ­¢å½“å‰é¡µé¢çš„æ‰€æœ‰æ´»åŠ¨
                            webView.loadUrl("about:blank")

                            // 3. æ¸…é™¤å†å²è®°å½•
                            webView.clearHistory()

                            // 4. æ¸…é™¤ç¼“å­˜å’Œæ•°æ®
                            webView.clearCache(true)
                            webView.clearFormData()

                            // 5. ç§»é™¤æ‰€æœ‰JavaScriptæ¥å£ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
                            try {
                                webView.removeJavascriptInterface("AndroidInterface")
                            } catch (e: Exception) {
                                // å¿½ç•¥æ¥å£ä¸å­˜åœ¨çš„å¼‚å¸¸
                            }

                            // 6. æš‚åœWebViewçš„æ‰€æœ‰æ´»åŠ¨
                            webView.onPause()

                            // 7. ç§»é™¤WebViewçš„çˆ¶å®¹å™¨
                            (webView.parent as? ViewGroup)?.removeView(webView)

                            // 8. æœ€ç»ˆé”€æ¯WebView
                            webView.destroy()

                            Log.d(TAG, "ğŸ”’ WebViewå·²å½»åº•é”€æ¯: ${cardData.title}")
                        } catch (webViewException: Exception) {
                            Log.e(TAG, "é”€æ¯WebViewæ—¶å‘ç”Ÿå¼‚å¸¸: ${cardData.title}", webViewException)
                            // å³ä½¿WebViewé”€æ¯å¤±è´¥ï¼Œä¹Ÿè¦ç»§ç»­ç§»é™¤å¡ç‰‡
                        }
                    }

                    // ä»ç®¡ç†å™¨ä¸­ç§»é™¤å¡ç‰‡
                    manager.removeCard(cardIndex)
                    Log.d(TAG, "âœ… ä»GestureCardWebViewManagerç§»é™¤å¡ç‰‡: $cardIndex (${cardData.title})")

                    // å…³é”®ä¿®å¤ï¼šç«‹å³æ›´æ–°ä¿å­˜çŠ¶æ€ï¼Œé˜²æ­¢æ¢å¤æœºåˆ¶é‡æ–°åŠ è½½å·²å…³é—­çš„å¡ç‰‡
                    manager.saveCardsState()

                    cardClosed = true
                }
            }

            // 2. å…³é”®ä¿®å¤ï¼šåŒæ—¶ä»MobileCardManagerä¸­åˆ é™¤ç›¸åŒURLçš„å¡ç‰‡
            mobileCardManager?.let { manager ->
                try {
                    Log.d(TAG, "ğŸ” æ£€æŸ¥MobileCardManagerä¸­æ˜¯å¦æœ‰ç›¸åŒURLçš„å¡ç‰‡")
                    manager.closeCardByUrl(url)
                    Log.d(TAG, "âœ… ä»MobileCardManagerç§»é™¤å¡ç‰‡ï¼ˆå¦‚æœå­˜åœ¨ï¼‰")
                } catch (e: Exception) {
                    Log.w(TAG, "ä»MobileCardManagerç§»é™¤å¡ç‰‡æ—¶å‡ºé”™", e)
                }
            }
            
            // 3. å…³é”®ä¿®å¤ï¼šåŒæ—¶ä»çº¸å †æ¨¡å¼ä¸­åˆ é™¤ç›¸åŒURLçš„æ ‡ç­¾é¡µ
            paperStackWebViewManager?.let { manager ->
                try {
                    Log.d(TAG, "ğŸ” æ£€æŸ¥çº¸å †æ¨¡å¼ä¸­æ˜¯å¦æœ‰ç›¸åŒURLçš„æ ‡ç­¾é¡µ")
                    val paperStackTabs = manager.getAllTabs()
                    val tabToRemove = paperStackTabs.find { it.url == url }
                    
                    if (tabToRemove != null) {
                        Log.d(TAG, "ğŸ“ åœ¨çº¸å †æ¨¡å¼ä¸­æ‰¾åˆ°æ ‡ç­¾é¡µ: ${tabToRemove.title}")
                        
                        // é”€æ¯WebView
                        tabToRemove.webView?.let { webView ->
                            try {
                                Log.d(TAG, "å¼€å§‹é”€æ¯çº¸å †æ ‡ç­¾é¡µWebView: ${tabToRemove.title}")
                                webView.stopLoading()
                                webView.loadUrl("about:blank")
                                webView.clearHistory()
                                webView.clearCache(true)
                                webView.clearFormData()
                                webView.onPause()
                                (webView.parent as? ViewGroup)?.removeView(webView)
                                webView.destroy()
                                Log.d(TAG, "ğŸ”’ çº¸å †æ ‡ç­¾é¡µWebViewå·²é”€æ¯: ${tabToRemove.title}")
                            } catch (e: Exception) {
                                Log.e(TAG, "é”€æ¯çº¸å †æ ‡ç­¾é¡µWebViewæ—¶å‘ç”Ÿå¼‚å¸¸", e)
                            }
                        }
                        
                        // ä»çº¸å †ç®¡ç†å™¨ä¸­ç§»é™¤æ ‡ç­¾é¡µ
                        manager.removeTab(tabToRemove.id)
                        // âš¡ ç«‹å³æ›´æ–°é¡µé¢æ•°é‡æ˜¾ç¤º
                        handler.post {
                            updatePageCountDisplay()
                        }
                        Log.d(TAG, "âœ… ä»çº¸å †æ¨¡å¼ç§»é™¤æ ‡ç­¾é¡µ: ${tabToRemove.title}")
                        
                        // å¦‚æœçº¸å †æ¨¡å¼æ²¡æœ‰æ ‡ç­¾é¡µäº†ï¼Œè¿”å›ä¸»é¡µ
                        if (manager.getTabCount() == 0) {
                            Log.d(TAG, "çº¸å †æ¨¡å¼æ²¡æœ‰æ ‡ç­¾é¡µäº†ï¼Œè¿”å›ä¸»é¡µ")
                            browserHomeContent.visibility = View.VISIBLE
                            // ğŸ”§ ä¿®å¤ï¼šæ ‡ç­¾æ å®¹å™¨å·²æ°¸ä¹…éšè—
                            browserTabContainer.visibility = View.GONE
                            val paperStackLayout = findViewById<View>(R.id.paper_stack_layout)
                            paperStackLayout?.visibility = View.GONE
                        }
                        
                        cardClosed = true
                    } else {
                        Log.d(TAG, "çº¸å †æ¨¡å¼ä¸­æœªæ‰¾åˆ°URLå¯¹åº”çš„æ ‡ç­¾é¡µ: $url")
                    }
                } catch (e: Exception) {
                    Log.w(TAG, "ä»çº¸å †æ¨¡å¼ç§»é™¤æ ‡ç­¾é¡µæ—¶å‡ºé”™", e)
                }
            }

            if (cardClosed) {
                // ç«‹å³åŒæ­¥æ‰€æœ‰å¡ç‰‡ç³»ç»Ÿæ•°æ®ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§
                syncAllCardSystems()

                // å…³é”®ä¿®å¤ï¼šå¼ºåˆ¶æ›´æ–°StackedCardPreviewçš„æ•°æ®ï¼Œç¡®ä¿æ˜¾ç¤ºçŠ¶æ€æ­£ç¡®
                stackedCardPreview?.let { preview ->
                    val remainingCards = getAllUnifiedCards()
                    Log.d(TAG, "ğŸ”„ æ›´æ–°StackedCardPreviewï¼Œå‰©ä½™å¡ç‰‡æ•°: ${remainingCards.size}")
                    preview.setWebViewCards(remainingCards.map { card ->
                        com.example.aifloatingball.views.StackedCardPreview.WebViewCardData(
                            title = card.title,
                            url = card.url,
                            favicon = card.favicon,
                            screenshot = null
                        )
                    })
                    if (remainingCards.isEmpty()) {
                        preview.visibility = View.GONE
                        Log.d(TAG, "ğŸ“´ æ²¡æœ‰å‰©ä½™å¡ç‰‡ï¼Œéšè—StackedCardPreview")
                    }
                }

                // é”™è¯¯æ¢å¤æœºåˆ¶ï¼šå»¶è¿Ÿæ£€æŸ¥çŠ¶æ€ä¸€è‡´æ€§
                browserLayout.postDelayed({
                    verifyCardStateConsistency(url)
                }, 500)

                // ç«‹å³ä»SharedPreferencesä¸­ç§»é™¤è¯¥URL
                removeUrlFromSavedState(url)

                // å¼ºåˆ¶åˆ·æ–°SharedPreferencesï¼Œç¡®ä¿å…³é—­çš„å¡ç‰‡ä¸ä¼šè¢«æ¢å¤
                handler.postDelayed({
                    gestureCardWebViewManager?.saveCardsState()
                    Log.d(TAG, "ğŸ”„ å»¶è¿Ÿä¿å­˜å¡ç‰‡çŠ¶æ€ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§")
                }, 100)

                // æä¾›ç”¨æˆ·åé¦ˆ
                Toast.makeText(this, "å¡ç‰‡å·²å…³é—­", Toast.LENGTH_SHORT).show()
                Log.d(TAG, "âœ… æˆåŠŸå…³é—­webviewå¡ç‰‡ï¼ŒURL: $url")

            } else {
                Log.w(TAG, "âš ï¸ å°è¯•å…³é—­ä¸å­˜åœ¨çš„webviewå¡ç‰‡ï¼ŒURL: $url")
                // å°è¯•ä»StackedCardPreviewä¸­ç§»é™¤è¯¥URLçš„å¡ç‰‡
                forceRemoveCardFromPreview(url)
            }
        } catch (e: Exception) {
            Log.e(TAG, "âŒ å…³é—­webviewå¡ç‰‡å¤±è´¥ï¼ŒURL: $url", e)
            // é”™è¯¯æ¢å¤ï¼šå°è¯•å¼ºåˆ¶æ¸…ç†
            forceCleanupCard(url)
        }
    }

    /**
     * éªŒè¯å¡ç‰‡çŠ¶æ€ä¸€è‡´æ€§
     */
    private fun verifyCardStateConsistency(closedUrl: String) {
        try {
            Log.d(TAG, "ğŸ” éªŒè¯å¡ç‰‡çŠ¶æ€ä¸€è‡´æ€§ï¼ŒURL: $closedUrl")

            var needsCleanup = false

            // æ£€æŸ¥GestureCardWebViewManager
            gestureCardWebViewManager?.let { manager ->
                val allCards = manager.getAllCards()
                val stillExists = allCards.any { it.url == closedUrl }

                if (stillExists) {
                    Log.w(TAG, "âš ï¸ GestureCardWebViewManagerä¸­URL $closedUrl ä»ç„¶å­˜åœ¨")
                    needsCleanup = true
                } else {
                    Log.d(TAG, "âœ… GestureCardWebViewManageréªŒè¯é€šè¿‡")
                }
            }

            // å…³é”®ä¿®å¤ï¼šåŒæ—¶æ£€æŸ¥MobileCardManager
            mobileCardManager?.let { manager ->
                val allCards = manager.getAllCards()
                val stillExists = allCards.any { it.url == closedUrl }

                if (stillExists) {
                    Log.w(TAG, "âš ï¸ MobileCardManagerä¸­URL $closedUrl ä»ç„¶å­˜åœ¨")
                    needsCleanup = true
                } else {
                    Log.d(TAG, "âœ… MobileCardManageréªŒè¯é€šè¿‡")
                }
            }

            // å¦‚æœä»»ä½•ä¸€ä¸ªç®¡ç†å™¨ä¸­è¿˜å­˜åœ¨ï¼Œæ‰§è¡Œå¼ºåˆ¶æ¸…ç†
            if (needsCleanup) {
                Log.w(TAG, "âš ï¸ å¡ç‰‡çŠ¶æ€ä¸ä¸€è‡´ï¼Œå°è¯•å¼ºåˆ¶æ¸…ç†")
                forceCleanupCard(closedUrl)
            } else {
                Log.d(TAG, "âœ… å¡ç‰‡çŠ¶æ€éªŒè¯é€šè¿‡ï¼ŒURL $closedUrl å·²æ­£ç¡®å…³é—­")
            }
        } catch (e: Exception) {
            Log.e(TAG, "éªŒè¯å¡ç‰‡çŠ¶æ€ä¸€è‡´æ€§å¤±è´¥", e)
        }
    }

    /**
     * å¼ºåˆ¶ä»é¢„è§ˆä¸­ç§»é™¤å¡ç‰‡
     */
    private fun forceRemoveCardFromPreview(url: String) {
        try {
            stackedCardPreview?.let { preview ->
                // è¿™é‡Œéœ€è¦è®¿é—®StackedCardPreviewçš„å†…éƒ¨çŠ¶æ€ï¼Œæš‚æ—¶è®°å½•æ—¥å¿—
                Log.d(TAG, "å°è¯•å¼ºåˆ¶ä»é¢„è§ˆä¸­ç§»é™¤URL: $url")
                // å¯ä»¥æ·»åŠ æ›´å¤šå¼ºåˆ¶æ¸…ç†é€»è¾‘
            }
        } catch (e: Exception) {
            Log.e(TAG, "å¼ºåˆ¶ç§»é™¤é¢„è§ˆå¡ç‰‡å¤±è´¥", e)
        }
    }

    /**
     * å¼ºåˆ¶æ¸…ç†å¡ç‰‡
     */
    private fun forceCleanupCard(url: String) {
        try {
            Log.d(TAG, "ğŸ§¹ æ‰§è¡Œå¼ºåˆ¶æ¸…ç†å¡ç‰‡ï¼ŒURL: $url")

            // ä»GestureCardWebViewManagerä¸­æ¸…ç†
            gestureCardWebViewManager?.let { manager ->
                val allCards = manager.getAllCards()
                val cardIndex = allCards.indexOfFirst { it.url == url }

                if (cardIndex >= 0) {
                    Log.d(TAG, "ä»GestureCardWebViewManagerå¼ºåˆ¶ç§»é™¤å¡ç‰‡: $cardIndex")
                    manager.removeCard(cardIndex)
                    manager.saveCardsState()
                }
            }

            // å…³é”®ä¿®å¤ï¼šåŒæ—¶ä»MobileCardManagerä¸­æ¸…ç†
            mobileCardManager?.let { manager ->
                try {
                    Log.d(TAG, "ä»MobileCardManagerå¼ºåˆ¶ç§»é™¤å¡ç‰‡")
                    manager.closeCardByUrl(url)
                } catch (e: Exception) {
                    Log.w(TAG, "ä»MobileCardManagerå¼ºåˆ¶ç§»é™¤å¡ç‰‡æ—¶å‡ºé”™", e)
                }
            }

            // åŒæ­¥æ‰€æœ‰å¡ç‰‡ç³»ç»Ÿ
            syncAllCardSystems()

            // åŒæ—¶ä»SharedPreferencesä¸­ç§»é™¤
            removeUrlFromSavedState(url)

            Log.d(TAG, "âœ… å¼ºåˆ¶æ¸…ç†å®Œæˆ")
        } catch (e: Exception) {
            Log.e(TAG, "å¼ºåˆ¶æ¸…ç†å¡ç‰‡å¤±è´¥", e)
        }
    }

    /**
     * ä»SharedPreferencesä¸­ç§»é™¤æŒ‡å®šURL
     */
    private fun removeUrlFromSavedState(url: String) {
        try {
            val sharedPreferences = getSharedPreferences("gesture_cards_state", Context.MODE_PRIVATE)
            val savedUrls = sharedPreferences.getStringSet("floating_card_urls", emptySet())?.toMutableSet() ?: mutableSetOf()

            Log.d(TAG, "ğŸ—‘ï¸ ä»SharedPreferencesä¸­ç§»é™¤URL: $url")
            Log.d(TAG, "ç§»é™¤å‰URLåˆ—è¡¨: $savedUrls")

            val removed = savedUrls.remove(url)
            if (removed) {
                sharedPreferences.edit().putStringSet("floating_card_urls", savedUrls).apply()
                Log.d(TAG, "âœ… æˆåŠŸä»SharedPreferencesä¸­ç§»é™¤URL: $url")
                Log.d(TAG, "ç§»é™¤åURLåˆ—è¡¨: $savedUrls")
            } else {
                Log.w(TAG, "âš ï¸ URLä¸åœ¨SharedPreferencesä¸­: $url")
            }
        } catch (e: Exception) {
            Log.e(TAG, "ä»SharedPreferencesä¸­ç§»é™¤URLå¤±è´¥", e)
        }
    }

    /**
     * å…³é—­æŒ‡å®šçš„webviewå¡ç‰‡ï¼ˆä¿ç•™åŸæ–¹æ³•ä»¥å…¼å®¹å…¶ä»–è°ƒç”¨ï¼‰
     */
    private fun closeWebViewCard(cardIndex: Int) {
        try {
            gestureCardWebViewManager?.let { manager ->
                val allCards = manager.getAllCards()
                if (cardIndex >= 0 && cardIndex < allCards.size) {
                    val cardData = allCards[cardIndex]
                    
                    // ä½¿ç”¨æ–°çš„URLå…³é—­æ–¹æ³•
                    closeWebViewCardByUrl(cardData.url)
                } else {
                    Log.w(TAG, "âš ï¸ æ— æ•ˆçš„å¡ç‰‡ç´¢å¼•: $cardIndex")
                }
            }
        } catch (e: Exception) {
            Log.e(TAG, "âŒ å…³é—­webviewå¡ç‰‡å¤±è´¥: $cardIndex", e)
        }
    }

    /**
     * åˆ·æ–°æŒ‡å®šçš„webviewå¡ç‰‡
     */
    private fun refreshWebViewCard(cardIndex: Int) {
        try {
            gestureCardWebViewManager?.let { manager ->
                val allCards = manager.getAllCards()
                if (cardIndex >= 0 && cardIndex < allCards.size) {
                    val cardData = allCards[cardIndex]

                    // åˆ·æ–°webview
                    cardData.webView?.reload()

                    Log.d(TAG, "âœ… åˆ·æ–°webviewå¡ç‰‡: $cardIndex (${cardData.title})")

                    // æ˜¾ç¤ºåˆ·æ–°æç¤º
                    runOnUiThread {
                        Toast.makeText(this@SimpleModeActivity, "é¡µé¢å·²åˆ·æ–°", Toast.LENGTH_SHORT).show()
                    }
                } else {
                    Log.w(TAG, "âš ï¸ æ— æ•ˆçš„å¡ç‰‡ç´¢å¼•: $cardIndex")
                }
            }
        } catch (e: Exception) {
            Log.e(TAG, "âŒ åˆ·æ–°webviewå¡ç‰‡å¤±è´¥", e)
        }
    }





    /**
     * ä¸ºå•ä¸ªtabè®¾ç½®æ‰‹åŠ¿æ£€æµ‹
     */
    private fun setupTabGestureDetection(tabView: LinearLayout, gestureDetector: GestureDetector) {
        tabView.setOnTouchListener { view, event ->
            // å¦‚æœæœç´¢tabæ‰‹åŠ¿é®ç½©åŒºæ¿€æ´»ï¼Œä¸”è¿™æ˜¯æœç´¢tabï¼Œåˆ™ä¼˜å…ˆå¤„ç†åŸæœ‰çš„å¤šå¡ç‰‡æ¿€æ´»æœºåˆ¶
            val isSearchTab = view.id == R.id.tab_search
            val isCurrentlyInSearchTab = getCurrentTabIndex() == 1

            // æ£€æŸ¥æ˜¯å¦æœ‰æ‚¬æµ®å¡ç‰‡é¢„è§ˆæ­£åœ¨æ˜¾ç¤º
            val isStackedPreviewVisible = stackedCardPreview?.visibility == View.VISIBLE

            if (isStackedPreviewVisible) {
                // å±‚å å¡ç‰‡é¢„è§ˆæ¨¡å¼ä¸‹ï¼Œä¸å¤„ç†è§¦æ‘¸äº‹ä»¶ï¼Œè®©StackedCardPreviewè‡ªå·±å¤„ç†
                Log.d(TAG, "tabåŒºåŸŸè§¦æ‘¸ï¼Œå±‚å å¡ç‰‡é¢„è§ˆå¯è§ï¼Œä¸æ‹¦æˆªè§¦æ‘¸äº‹ä»¶")
                false
            } else {
                // å·²ç¦ç”¨æœç´¢tabçš„å±‚å å¡ç‰‡é¢„è§ˆæ•ˆæœ
                // ç°åœ¨åªæœ‰é€šè¿‡å·¦ä¸Šè§’æŒ‰é’®æ‰èƒ½æ¿€æ´»å¡ç‰‡é¢„è§ˆ

                // å¤„ç†æ‰‹åŠ¿æ£€æµ‹ï¼ˆæ¨ªæ»‘åˆ‡æ¢ï¼‰
                gestureDetector.onTouchEvent(event)

                // ä¸æ¶ˆè´¹äº‹ä»¶ï¼Œè®©ç‚¹å‡»äº‹ä»¶ç»§ç»­ä¼ é€’
                false
            }
        }
    }



    /**
     * æµ‹è¯•webviewå¡ç‰‡åˆ‡æ¢åŠŸèƒ½
     */
    private fun testWebViewCardSwitching() {
        Log.d(TAG, "ğŸ§ª å¼€å§‹æµ‹è¯•webviewå¡ç‰‡åˆ‡æ¢åŠŸèƒ½")

        gestureCardWebViewManager?.let { manager ->
            val allCards = manager.getAllCards()
            val totalPages = allCards.size

            Log.d(TAG, "ğŸ“Š æµ‹è¯•ç»“æœ - æ€»é¡µé¢æ•°: $totalPages")
            Log.d(TAG, "ğŸ“‹ æ‰€æœ‰å¡ç‰‡: ${allCards.map { it.title ?: "æ— æ ‡é¢˜" }}")

            val message = "æµ‹è¯•ç»“æœï¼šå…±æœ‰ $totalPages ä¸ªé¡µé¢"
            Toast.makeText(this, message, Toast.LENGTH_LONG).show()

            if (totalPages > 1) {
                Log.d(TAG, "ğŸ”„ æµ‹è¯•åˆ‡æ¢åˆ°ä¸‹ä¸€é¡µ")
                switchToNextWebPage()
            } else if (totalPages == 1) {
                Log.d(TAG, "âš ï¸ åªæœ‰ä¸€ä¸ªé¡µé¢ï¼Œæ— æ³•æµ‹è¯•åˆ‡æ¢")
                Toast.makeText(this, "åªæœ‰ä¸€ä¸ªé¡µé¢ï¼Œè¯·å…ˆæ‰“å¼€å¤šä¸ªç½‘é¡µ", Toast.LENGTH_LONG).show()
            } else {
                Log.d(TAG, "âš ï¸ æ²¡æœ‰é¡µé¢")
                Toast.makeText(this, "æ²¡æœ‰æ‰“å¼€çš„é¡µé¢ï¼Œè¯·å…ˆæœç´¢ä¸€äº›å†…å®¹", Toast.LENGTH_LONG).show()
            }
        } ?: run {
            Log.w(TAG, "âŒ gestureCardWebViewManagerä¸ºnull")
            Toast.makeText(this, "é¡µé¢ç®¡ç†å™¨æœªåˆå§‹åŒ–", Toast.LENGTH_LONG).show()
        }
    }



    /**
     * åˆ‡æ¢åˆ°ä¸Šä¸€ä¸ªtab
     */
    private fun switchToPreviousTab() {
        val currentTab = getCurrentTabIndex()
        val visibleTabs = getVisibleTabs()
        val currentIndex = visibleTabs.indexOf(currentTab)

        if (currentIndex > 0) {
            val previousTab = visibleTabs[currentIndex - 1]
            switchToTab(previousTab)
            Log.d(TAG, "æ¨ªæ»‘åˆ‡æ¢åˆ°ä¸Šä¸€ä¸ªtab: $previousTab")
        }
    }

    /**
     * åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªtab
     */
    private fun switchToNextTab() {
        val currentTab = getCurrentTabIndex()
        val visibleTabs = getVisibleTabs()
        val currentIndex = visibleTabs.indexOf(currentTab)

        if (currentIndex < visibleTabs.size - 1) {
            val nextTab = visibleTabs[currentIndex + 1]
            switchToTab(nextTab)
            Log.d(TAG, "æ¨ªæ»‘åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªtab: $nextTab")
        }
    }

    /**
     * è·å–å½“å‰tabç´¢å¼•
     */
    private fun getCurrentTabIndex(): Int {
        return when (currentState) {
            UIState.CHAT -> 0
            UIState.BROWSER -> 1
            UIState.TASK_SELECTION -> 2
            UIState.VOICE -> 3
            UIState.APP_SEARCH -> 4
            UIState.SETTINGS -> 5
            else -> 0
        }
    }

    /**
     * è·å–å¯è§çš„tabåˆ—è¡¨
     */
    private fun getVisibleTabs(): List<Int> {
        val tabs = mutableListOf<Int>()
        tabs.add(0) // å¯¹è¯
        tabs.add(1) // æœç´¢
        tabs.add(2) // ä»»åŠ¡

        // æ£€æŸ¥è¯­éŸ³tabæ˜¯å¦å¯è§
        val voiceTab = findViewById<LinearLayout>(R.id.tab_voice)
        if (voiceTab?.visibility == View.VISIBLE) {
            tabs.add(3) // è¯­éŸ³
        }

        tabs.add(4) // è½¯ä»¶
        tabs.add(5) // è®¾ç½®

        return tabs
    }

    /**
     * åˆ‡æ¢åˆ°æŒ‡å®štab
     */
    private fun switchToTab(tabIndex: Int) {
        when (tabIndex) {
            0 -> showChat()
            1 -> showBrowser()
            2 -> showAIAssistantCenter()
            3 -> showVoice()
            4 -> showAppSearch()
            5 -> showSettings()
        }
    }

    /**
     * åˆ‡æ¢åˆ°æœç´¢tab
     */
    private fun switchToSearchTab() {
        try {
            deactivateStackedCardPreview()
            showBrowser()
            
            // ğŸ”§ ä¿®å¤ï¼šç¡®ä¿åˆ‡æ¢åˆ°æœç´¢tabæ—¶ï¼Œå·¥å…·æ å’Œç»„æ ‡ç­¾æ éƒ½æ˜¯å¯è§çš„
            // è¿™æ ·ç”¨æˆ·åˆšè¿›å…¥æœç´¢tabæ—¶ï¼Œç»„æ ‡ç­¾æ ä¼šæ­£å¸¸æ˜¾ç¤º
            if (!isToolbarVisible) {
                showToolbar()
                showBottomNavigationAndHideQuickActions()
            }
            
            // ğŸ”§ ä¿®å¤ï¼šé€€å‡ºæœç´¢tabæ—¶ï¼Œç¡®ä¿tabæ ï¼ˆç»„æ ‡ç­¾æ ï¼‰æ¢å¤æ˜¾ç¤º
            groupTabsContainer?.let { container ->
                if (currentState == UIState.BROWSER) {
                    container.visibility = View.VISIBLE
                    container.alpha = 1f
                    container.translationY = 0f
                    Log.d(TAG, "ğŸ”§ åˆ‡æ¢åˆ°æœç´¢tabæ—¶ï¼Œæ¢å¤ç»„æ ‡ç­¾æ æ˜¾ç¤º")
                }
            }
            
            // ç¡®ä¿çº¸å †WebViewç®¡ç†å™¨å·²åˆå§‹åŒ–
            if (paperStackWebViewManager == null) {
                Log.d(TAG, "çº¸å †WebViewç®¡ç†å™¨æœªåˆå§‹åŒ–ï¼Œé‡æ–°åˆå§‹åŒ–")
                setupBrowserWebView()
            }
            
            // æ›´æ–°é¡µé¢æ•°é‡æ˜¾ç¤º
            updatePageCountDisplay()
            
            // ğŸ”§ ä¿®å¤ï¼šåˆ·æ–°ç»„æ ‡ç­¾æ ï¼Œç¡®ä¿åœ¨å·¥å…·æ å¯è§æ—¶æ˜¾ç¤º
            refreshGroupTabs()
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æ ‡ç­¾é¡µ
            val tabCount = paperStackWebViewManager?.getTabCount() ?: 0
            if (tabCount == 0) {
                // æ²¡æœ‰æ ‡ç­¾é¡µï¼Œè‡ªåŠ¨åˆ›å»ºåŠŸèƒ½ä¸»é¡µå¡ç‰‡
                Log.d(TAG, "åˆ‡æ¢åˆ°æœç´¢tabï¼šæ²¡æœ‰æ ‡ç­¾é¡µï¼Œè‡ªåŠ¨åˆ›å»ºåŠŸèƒ½ä¸»é¡µå¡ç‰‡")
                createFunctionalHomeTab()
            } else {
                // æœ‰æ ‡ç­¾é¡µï¼Œè¿›å…¥çº¸å †æ¨¡å¼
                Log.d(TAG, "åˆ‡æ¢åˆ°æœç´¢tabï¼šæœ‰ $tabCount ä¸ªæ ‡ç­¾é¡µï¼Œè¿›å…¥çº¸å †æ¨¡å¼")
                enterPaperStackMode()
                
                // ğŸ”§ ä¿®å¤ï¼šç¡®ä¿çº¸å †å¸ƒå±€æ˜¾ç¤º
                val paperStackLayout = findViewById<View>(R.id.paper_stack_layout)
                paperStackLayout?.visibility = View.VISIBLE
                browserHomeContent.visibility = View.GONE
                browserTabContainer.visibility = View.GONE
                
                // ğŸ”§ æ–°å¢ï¼šå¦‚æœå½“å‰æ ‡ç­¾é¡µæ˜¯åŠŸèƒ½ä¸»é¡µï¼Œç¡®ä¿æ˜¾ç¤ºtabæ å’Œç»„æ ‡ç­¾
                paperStackWebViewManager?.getCurrentTab()?.let { currentTab ->
                    if (currentTab.url == "home://functional") {
                        // ç¡®ä¿å·¥å…·æ å¯è§
                        if (!isToolbarVisible) {
                            showToolbar()
                            showBottomNavigationAndHideQuickActions()
                        }
                        
                        // ç¡®ä¿ç»„æ ‡ç­¾æ å¯è§
                        groupTabsContainer?.let { container ->
                            if (container.visibility != View.VISIBLE) {
                                container.visibility = View.VISIBLE
                                container.alpha = 1f
                                container.translationY = 0f
                                Log.d(TAG, "è¿›å…¥åŠŸèƒ½ä¸»é¡µï¼Œæ¢å¤ç»„æ ‡ç­¾æ æ˜¾ç¤º")
                            }
                        }
                        
                        // åˆ·æ–°ç»„æ ‡ç­¾æ 
                        refreshGroupTabs()
                    }
                }
                
                // ğŸ”§ ä¿®å¤ï¼šä¸ºå½“å‰æ´»åŠ¨çš„WebViewæ·»åŠ æ»šåŠ¨ç›‘å¬å™¨ï¼Œç¡®ä¿å·¥å…·æ èƒ½æ­£å¸¸æ˜¾ç¤º/éšè—
                paperStackWebViewManager?.getCurrentTab()?.let { currentTab ->
                    // ç¡®ä¿WebViewå¯è§
                    currentTab.webView.visibility = View.VISIBLE
                    currentTab.webView.bringToFront()
                    
                    handler.postDelayed({
                        addScrollListenerToWebView(currentTab.webView)
                        Log.d(TAG, "ä¸ºå½“å‰æ ‡ç­¾é¡µæ·»åŠ æ»šåŠ¨ç›‘å¬å™¨: ${currentTab.title}")
                        
                        // ğŸ”§ ä¿®å¤ï¼šå¦‚æœå½“å‰æ ‡ç­¾é¡µæ˜¯åŠŸèƒ½ä¸»é¡µä½†æœªåŠ è½½ï¼Œå¼ºåˆ¶åŠ è½½
                        if (currentTab.url == "home://functional" && 
                            (currentTab.webView.url.isNullOrEmpty() || 
                             currentTab.webView.url != "file:///android_asset/functional_home.html")) {
                            Log.d(TAG, "ğŸ”§ åŠŸèƒ½ä¸»é¡µæœªæ­£ç¡®åŠ è½½ï¼Œé‡æ–°åŠ è½½")
                            currentTab.webView.loadUrl("file:///android_asset/functional_home.html")
                        }
                    }, 100) // å»¶è¿Ÿ100msï¼Œç¡®ä¿WebViewå·²å®Œå…¨åˆå§‹åŒ–
                }
            }
            
            // æ£€æŸ¥æ˜¯å¦éœ€è¦æ¢å¤é¡µé¢ï¼ˆå»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿UIå·²åˆå§‹åŒ–ï¼‰
            handler.postDelayed({
                try {
                    checkAndShowRecoveryPrompt()
                } catch (e: Exception) {
                    Log.e(TAG, "æ£€æŸ¥æ¢å¤æç¤ºå¤±è´¥", e)
                }
            }, 500) // å»¶è¿Ÿ500msï¼Œç¡®ä¿UIå·²å®Œå…¨åˆå§‹åŒ–
            
            Log.d(TAG, "åˆ‡æ¢åˆ°æœç´¢tabå®Œæˆ")
        } catch (e: Exception) {
            Log.e(TAG, "åˆ‡æ¢åˆ°æœç´¢tabå¤±è´¥", e)
        }
    }
    
    /**
     * ä¿å­˜ä¸Šä¸€æ¬¡é˜…è¯»çš„è®°å½•å’Œç½‘å€
     */
    private fun saveLastReadRecord(url: String) {
        try {
            val prefs = getSharedPreferences(PREFS_LAST_READ, Context.MODE_PRIVATE)
            prefs.edit()
                .putString(KEY_LAST_READ_URL, url)
                .putLong(KEY_LAST_READ_TIME, System.currentTimeMillis())
                .apply()
            Log.d(TAG, "å·²ä¿å­˜ä¸Šä¸€æ¬¡é˜…è¯»è®°å½•: $url")
        } catch (e: Exception) {
            Log.e(TAG, "ä¿å­˜ä¸Šä¸€æ¬¡é˜…è¯»è®°å½•å¤±è´¥", e)
        }
    }
    
    /**
     * åŠ è½½ä¸Šä¸€æ¬¡é˜…è¯»çš„è®°å½•å’Œç½‘å€
     */
    private fun loadLastReadRecord(): String? {
        return try {
            val prefs = getSharedPreferences(PREFS_LAST_READ, Context.MODE_PRIVATE)
            val url = prefs.getString(KEY_LAST_READ_URL, null)
            val lastReadTime = prefs.getLong(KEY_LAST_READ_TIME, 0L)
            
            if (url != null && url.isNotEmpty() && lastReadTime > 0) {
                Log.d(TAG, "åŠ è½½ä¸Šä¸€æ¬¡é˜…è¯»è®°å½•: $url, æ—¶é—´: $lastReadTime")
                url
            } else {
                Log.d(TAG, "æ²¡æœ‰æ‰¾åˆ°ä¸Šä¸€æ¬¡é˜…è¯»è®°å½•")
                null
            }
        } catch (e: Exception) {
            Log.e(TAG, "åŠ è½½ä¸Šä¸€æ¬¡é˜…è¯»è®°å½•å¤±è´¥", e)
            null
        }
    }
    
    /**
     * åˆ›å»ºåŠŸèƒ½ä¸»é¡µæ ‡ç­¾é¡µ
     */
    private fun createFunctionalHomeTab() {
        try {
            Log.d(TAG, "å¼€å§‹åˆ›å»ºåŠŸèƒ½ä¸»é¡µæ ‡ç­¾é¡µ")
            
            // ğŸ”§ ä¿®å¤ï¼šå…ˆæ¸…ç†é‡å¤çš„åŠŸèƒ½ä¸»é¡µ
            paperStackWebViewManager?.cleanupDuplicateFunctionalHomes()
            
            // å…ˆéšè—åŸç”ŸåŠŸèƒ½ä¸»é¡µï¼Œç¡®ä¿ä¸ä¼šæ˜¾ç¤º
            browserHomeContent.visibility = View.GONE
            browserTabContainer.visibility = View.GONE
            
            // ğŸ”§ ä¿®å¤ï¼šå…ˆæ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨åŠŸèƒ½ä¸»é¡µï¼Œé¿å…é‡å¤åˆ›å»º
            // æ£€æŸ¥å½“å‰ç»„çš„æ ‡ç­¾é¡µ
            val currentGroupTabs = paperStackWebViewManager?.getAllTabs() ?: emptyList()
            val existingFunctionalTab = currentGroupTabs.firstOrNull { tab ->
                tab.url == "home://functional" || tab.url == "file:///android_asset/functional_home.html"
            }
            
            if (existingFunctionalTab != null) {
                Log.d(TAG, "ğŸ”§ åŠŸèƒ½ä¸»é¡µå·²å­˜åœ¨ï¼Œåˆ‡æ¢åˆ°å·²å­˜åœ¨çš„åŠŸèƒ½ä¸»é¡µ: ${existingFunctionalTab.title}")
                
                // æ‰¾åˆ°åŠŸèƒ½ä¸»é¡µåœ¨å½“å‰ç»„æ ‡ç­¾é¡µåˆ—è¡¨ä¸­çš„ç´¢å¼•
                val tabIndex = currentGroupTabs.indexOfFirst { it.id == existingFunctionalTab.id }
                
                if (tabIndex >= 0) {
                    paperStackWebViewManager?.switchToTab(tabIndex)
                    Log.d(TAG, "ğŸ”§ å·²åˆ‡æ¢åˆ°å·²å­˜åœ¨çš„åŠŸèƒ½ä¸»é¡µï¼Œç´¢å¼•: $tabIndex")
                }
                
                // ç¡®ä¿æ˜¾ç¤ºtabæ å’Œç»„æ ‡ç­¾
                if (!isToolbarVisible) {
                    showToolbar()
                    showBottomNavigationAndHideQuickActions()
                }
                
                groupTabsContainer?.let { container ->
                    if (container.visibility != View.VISIBLE) {
                        container.visibility = View.VISIBLE
                        container.alpha = 1f
                        container.translationY = 0f
                        Log.d(TAG, "åˆ‡æ¢åˆ°å·²å­˜åœ¨çš„åŠŸèƒ½ä¸»é¡µï¼Œæ¢å¤ç»„æ ‡ç­¾æ æ˜¾ç¤º")
                    }
                }
                
                refreshGroupTabs()
                return
            }
            
            // åˆ›å»ºåŠŸèƒ½ä¸»é¡µå¡ç‰‡
            val functionalHomeUrl = "home://functional"
            
            Log.d(TAG, "å‡†å¤‡åˆ›å»ºåŠŸèƒ½ä¸»é¡µæ ‡ç­¾é¡µï¼ŒURL: $functionalHomeUrl")
            
            // åˆ›å»ºåŠŸèƒ½ä¸»é¡µæ ‡ç­¾é¡µ
            val functionalTab = paperStackWebViewManager?.addTab(
                url = functionalHomeUrl,
                title = "ä¸»é¡µ"
            )
            
            // âš¡ åˆ›å»ºåŠŸèƒ½ä¸»é¡µåä¹Ÿè¦æ›´æ–°è®¡æ•°ï¼ˆè™½ç„¶åŠŸèƒ½ä¸»é¡µä¼šè¢«æ’é™¤ï¼Œä½†ç¡®ä¿UIåŒæ­¥ï¼‰
            handler.post {
                updatePageCountDisplay()
            }
            
            if (functionalTab != null) {
                Log.d(TAG, "âœ… åŠŸèƒ½ä¸»é¡µå¡ç‰‡åˆ›å»ºæˆåŠŸ: ${functionalTab.url}")
                
                // ğŸ”§ ä¿®å¤ï¼šç«‹å³æ˜¾ç¤ºçº¸å †å¸ƒå±€ï¼Œç¡®ä¿ç”¨æˆ·çœ‹åˆ°å†…å®¹
                val paperStackLayout = findViewById<View>(R.id.paper_stack_layout)
                paperStackLayout?.visibility = View.VISIBLE
                browserHomeContent.visibility = View.GONE
                browserTabContainer.visibility = View.GONE
                browserSearchInput.setText("")
                
                // ğŸ”§ æ–°å¢ï¼šåˆ›å»ºåŠŸèƒ½ä¸»é¡µæ—¶ï¼Œç¡®ä¿æ˜¾ç¤ºtabæ å’Œç»„æ ‡ç­¾
                // ç¡®ä¿å·¥å…·æ å¯è§
                if (!isToolbarVisible) {
                    showToolbar()
                    showBottomNavigationAndHideQuickActions()
                }
                
                // ç¡®ä¿ç»„æ ‡ç­¾æ å¯è§
                groupTabsContainer?.let { container ->
                    if (container.visibility != View.VISIBLE) {
                        container.visibility = View.VISIBLE
                        container.alpha = 1f
                        container.translationY = 0f
                        Log.d(TAG, "åˆ›å»ºåŠŸèƒ½ä¸»é¡µï¼Œæ¢å¤ç»„æ ‡ç­¾æ æ˜¾ç¤º")
                    }
                }
                
                // åˆ·æ–°ç»„æ ‡ç­¾æ 
                refreshGroupTabs()
                
                // ç¡®ä¿WebViewå¯è§å¹¶æ­£ç¡®æ˜¾ç¤º
                functionalTab.webView.visibility = View.VISIBLE
                functionalTab.webView.bringToFront()
                
                // å»¶è¿Ÿä¸€ç‚¹æ—¶é—´ç¡®ä¿æ ‡ç­¾é¡µå®Œå…¨åˆ›å»ºå’ŒåŠ è½½
                handler.postDelayed({
                    // ç¡®ä¿åˆ‡æ¢åˆ°æ–°åˆ›å»ºçš„æ ‡ç­¾é¡µ
                    val tabCount = paperStackWebViewManager?.getTabCount() ?: 0
                    val currentTab = paperStackWebViewManager?.getCurrentTab()
                    
                    Log.d(TAG, "æ ‡ç­¾é¡µæ•°é‡: $tabCount, å½“å‰æ ‡ç­¾é¡µURL: ${currentTab?.url}")
                    
                    if (currentTab != null) {
                        // ğŸ”§ ä¿®å¤ï¼šæ£€æŸ¥URLæ˜¯å¦ä¸ºåŠŸèƒ½ä¸»é¡µï¼ˆå¯èƒ½æ˜¯home://functionalæˆ–file:///android_asset/functional_home.htmlï¼‰
                        val isFunctionalHome = currentTab.url == functionalHomeUrl || 
                                             currentTab.url == "file:///android_asset/functional_home.html"
                        
                        if (isFunctionalHome) {
                            Log.d(TAG, "âœ… åŠŸèƒ½ä¸»é¡µæ ‡ç­¾é¡µå·²åˆ›å»ºå¹¶åˆ‡æ¢ï¼ŒURL: ${currentTab.url}")
                            // ç¡®ä¿WebViewå¯è§
                            currentTab.webView.visibility = View.VISIBLE
                            currentTab.webView.bringToFront()
                            // ç¡®ä¿çº¸å †å¸ƒå±€æ˜¾ç¤º
                            paperStackLayout?.visibility = View.VISIBLE
                            
                            // ğŸ”§ ä¿®å¤ï¼šå¦‚æœWebViewè¿˜æ²¡æœ‰åŠ è½½ï¼Œå¼ºåˆ¶é‡æ–°åŠ è½½
                            if (currentTab.webView.url.isNullOrEmpty() || 
                                (currentTab.webView.url != "file:///android_asset/functional_home.html" && 
                                 currentTab.url == functionalHomeUrl)) {
                                Log.d(TAG, "ğŸ”§ WebViewæœªæ­£ç¡®åŠ è½½ï¼Œé‡æ–°åŠ è½½åŠŸèƒ½ä¸»é¡µ")
                                currentTab.webView.loadUrl("file:///android_asset/functional_home.html")
                            }
                        } else {
                            Log.w(TAG, "âš ï¸ å½“å‰æ ‡ç­¾é¡µä¸æ˜¯åŠŸèƒ½ä¸»é¡µï¼ŒURL: ${currentTab.url}")
                            // ğŸ”§ ä¿®å¤ï¼šå¦‚æœå½“å‰æ ‡ç­¾é¡µä¸æ˜¯åŠŸèƒ½ä¸»é¡µï¼Œç¡®ä¿è‡³å°‘æ˜¾ç¤ºçº¸å †å¸ƒå±€
                            paperStackLayout?.visibility = View.VISIBLE
                        }
                    } else {
                        Log.w(TAG, "âš ï¸ å½“å‰æ ‡ç­¾é¡µä¸ºç©º")
                        // ç¡®ä¿çº¸å †å¸ƒå±€æ˜¾ç¤º
                        paperStackLayout?.visibility = View.VISIBLE
                    }
                }, 200) // å¢åŠ å»¶è¿Ÿæ—¶é—´ï¼Œç¡®ä¿WebViewå®Œå…¨åˆå§‹åŒ–
            } else {
                Log.e(TAG, "âŒ åˆ›å»ºåŠŸèƒ½ä¸»é¡µå¡ç‰‡å¤±è´¥ï¼Œæ˜¾ç¤ºåŸç”ŸåŠŸèƒ½ä¸»é¡µ")
                // ğŸ”§ ä¿®å¤ï¼šå¦‚æœåˆ›å»ºå¤±è´¥ï¼Œç«‹å³æ˜¾ç¤ºåŸç”ŸåŠŸèƒ½ä¸»é¡µä½œä¸ºåå¤‡ï¼Œé¿å…ç©ºç™½é¡µé¢
                handler.post {
                    showBrowserHome()
                }
            }
        } catch (e: Exception) {
            Log.e(TAG, "âŒ åˆ›å»ºåŠŸèƒ½ä¸»é¡µæ ‡ç­¾é¡µå¤±è´¥", e)
            e.printStackTrace()
            // ğŸ”§ ä¿®å¤ï¼šå¦‚æœåˆ›å»ºå¤±è´¥ï¼Œç«‹å³æ˜¾ç¤ºåŸç”ŸåŠŸèƒ½ä¸»é¡µä½œä¸ºåå¤‡ï¼Œé¿å…ç©ºç™½é¡µé¢
            handler.post {
                showBrowserHome()
            }
        }
    }

    /**
     * å½“å‰WebViewåé€€
     */
    private fun goBackInCurrentWebView() {
        try {
            var handled = false
            
            // 1. ä¼˜å…ˆæ£€æŸ¥çº¸å †æ¨¡å¼WebViewç®¡ç†å™¨
            if (paperStackWebViewManager?.canGoBack() == true) {
                paperStackWebViewManager?.goBack()
                Log.d(TAG, "çº¸å †æ¨¡å¼WebViewåé€€æˆåŠŸ")
                handled = true
            }
            // 2. æ£€æŸ¥æ‰‹åŠ¿å¡ç‰‡WebViewç®¡ç†å™¨
            if (!handled) {
                gestureCardWebViewManager?.getCurrentCard()?.webView?.let { webView ->
                    if (webView.canGoBack()) {
                        webView.goBack()
                        Log.d(TAG, "æ‰‹åŠ¿å¡ç‰‡WebViewåé€€æˆåŠŸ")
                        handled = true
                    } else {
                        Log.d(TAG, "æ‰‹åŠ¿å¡ç‰‡WebViewæ— æ³•åé€€")
                    }
                }
            }
            // 3. æ£€æŸ¥æ‰‹æœºå¡ç‰‡ç®¡ç†å™¨
            if (!handled) {
                mobileCardManager?.getCurrentCard()?.webView?.let { webView ->
                    if (webView.canGoBack()) {
                        webView.goBack()
                        Log.d(TAG, "æ‰‹æœºå¡ç‰‡WebViewåé€€æˆåŠŸ")
                        handled = true
                    } else {
                        Log.d(TAG, "æ‰‹æœºå¡ç‰‡WebViewæ— æ³•åé€€")
                    }
                }
            }
            // 4. ä½¿ç”¨ç»Ÿä¸€WebViewç®¡ç†å™¨
            if (!handled) {
                if (unifiedWebViewManager.canGoBack()) {
                    unifiedWebViewManager.goBack()
                    Log.d(TAG, "ç»Ÿä¸€WebViewç®¡ç†å™¨åé€€æˆåŠŸ")
                    handled = true
                }
            }
            
            if (!handled) {
                Log.d(TAG, "æ²¡æœ‰å¯åé€€çš„WebView")
                Toast.makeText(this, "æ— æ³•åé€€", Toast.LENGTH_SHORT).show()
            }
        } catch (e: Exception) {
            Log.e(TAG, "WebViewåé€€å¤±è´¥", e)
            Toast.makeText(this, "åé€€å¤±è´¥: ${e.message}", Toast.LENGTH_SHORT).show()
        }
    }

    /**
     * å½“å‰WebViewå‰è¿›
     */
    private fun goForwardInCurrentWebView() {
        try {
            var handled = false
            
            // 1. ä¼˜å…ˆæ£€æŸ¥çº¸å †æ¨¡å¼WebViewç®¡ç†å™¨
            if (paperStackWebViewManager?.canGoForward() == true) {
                paperStackWebViewManager?.goForward()
                Log.d(TAG, "çº¸å †æ¨¡å¼WebViewå‰è¿›æˆåŠŸ")
                handled = true
            }
            // 2. æ£€æŸ¥æ‰‹åŠ¿å¡ç‰‡WebViewç®¡ç†å™¨
            if (!handled) {
                gestureCardWebViewManager?.getCurrentCard()?.webView?.let { webView ->
                    if (webView.canGoForward()) {
                        webView.goForward()
                        Log.d(TAG, "æ‰‹åŠ¿å¡ç‰‡WebViewå‰è¿›æˆåŠŸ")
                        handled = true
                    } else {
                        Log.d(TAG, "æ‰‹åŠ¿å¡ç‰‡WebViewæ— æ³•å‰è¿›")
                    }
                }
            }
            // 3. æ£€æŸ¥æ‰‹æœºå¡ç‰‡ç®¡ç†å™¨
            if (!handled) {
                mobileCardManager?.getCurrentCard()?.webView?.let { webView ->
                    if (webView.canGoForward()) {
                        webView.goForward()
                        Log.d(TAG, "æ‰‹æœºå¡ç‰‡WebViewå‰è¿›æˆåŠŸ")
                        handled = true
                    } else {
                        Log.d(TAG, "æ‰‹æœºå¡ç‰‡WebViewæ— æ³•å‰è¿›")
                    }
                }
            }
            // 4. ä½¿ç”¨ç»Ÿä¸€WebViewç®¡ç†å™¨
            if (!handled) {
                if (unifiedWebViewManager.canGoForward()) {
                    unifiedWebViewManager.goForward()
                    Log.d(TAG, "ç»Ÿä¸€WebViewç®¡ç†å™¨å‰è¿›æˆåŠŸ")
                    handled = true
                }
            }
            
            if (!handled) {
                Log.d(TAG, "æ²¡æœ‰å¯å‰è¿›çš„WebView")
                Toast.makeText(this, "æ— æ³•å‰è¿›", Toast.LENGTH_SHORT).show()
            }
        } catch (e: Exception) {
            Log.e(TAG, "WebViewå‰è¿›å¤±è´¥", e)
            Toast.makeText(this, "å‰è¿›å¤±è´¥: ${e.message}", Toast.LENGTH_SHORT).show()
        }
    }

    // ==================== è¾“å…¥æ³•æ§åˆ¶æ–¹æ³• ====================

    /**
     * æ˜¾ç¤ºè½¯é”®ç›˜
     */
    private fun showKeyboard(editText: EditText) {
        try {
            val imm = getSystemService(Context.INPUT_METHOD_SERVICE) as InputMethodManager
            imm.showSoftInput(editText, InputMethodManager.SHOW_IMPLICIT)
            Log.d(TAG, "æ˜¾ç¤ºè½¯é”®ç›˜")
        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºè½¯é”®ç›˜å¤±è´¥", e)
        }
    }

    /**
     * éšè—è½¯é”®ç›˜
     */
    private fun hideKeyboard(view: View) {
        try {
            val imm = getSystemService(Context.INPUT_METHOD_SERVICE) as InputMethodManager
            imm.hideSoftInputFromWindow(view.windowToken, 0)
            Log.d(TAG, "éšè—è½¯é”®ç›˜")
        } catch (e: Exception) {
            Log.e(TAG, "éšè—è½¯é”®ç›˜å¤±è´¥", e)
        }
    }

    // ==================== åº•éƒ¨tabæ‰‹åŠ¿æŒ‡ç¤ºå™¨ ====================

    /**
     * åˆ›å»ºåº•éƒ¨tabåŒºåŸŸçš„æ‰‹åŠ¿æŒ‡ç¤ºå™¨
     */
    private fun createTabSwipeGestureIndicator() {
        try {
            // åˆ›å»ºæ‰‹åŠ¿æŒ‡ç¤ºå™¨å®¹å™¨
            val indicatorContainer = LinearLayout(this).apply {
                orientation = LinearLayout.HORIZONTAL
                gravity = android.view.Gravity.CENTER
                setPadding(16, 8, 16, 8)
            }

            // åˆ›å»ºå·¦ç®­å¤´
            val leftArrow = TextView(this).apply {
                text = "â—€"
                textSize = 16f
                setTextColor(android.graphics.Color.WHITE)
                alpha = 0.7f
            }

            // åˆ›å»ºä¸­é—´æç¤ºæ–‡å­—
            val hintText = TextView(this).apply {
                text = "å·¦å³æ»‘åŠ¨åˆ‡æ¢"
                textSize = 12f
                setTextColor(android.graphics.Color.WHITE)
                alpha = 0.8f
                setPadding(16, 0, 16, 0)
            }

            // åˆ›å»ºå³ç®­å¤´
            val rightArrow = TextView(this).apply {
                text = "â–¶"
                textSize = 16f
                setTextColor(android.graphics.Color.WHITE)
                alpha = 0.7f
            }

            // æ·»åŠ åˆ°å®¹å™¨
            indicatorContainer.addView(leftArrow)
            indicatorContainer.addView(hintText)
            indicatorContainer.addView(rightArrow)

            // åˆ›å»ºæŒ‡ç¤ºå™¨èƒŒæ™¯
            tabSwipeGestureIndicator = FrameLayout(this).apply {
                layoutParams = FrameLayout.LayoutParams(
                    FrameLayout.LayoutParams.WRAP_CONTENT,
                    FrameLayout.LayoutParams.WRAP_CONTENT
                ).apply {
                    gravity = android.view.Gravity.BOTTOM or android.view.Gravity.CENTER_HORIZONTAL
                    bottomMargin = 120 // åœ¨åº•éƒ¨tabä¸Šæ–¹æ˜¾ç¤º
                }

                // è®¾ç½®èƒŒæ™¯
                background = android.graphics.drawable.GradientDrawable().apply {
                    setColor(android.graphics.Color.parseColor("#80000000"))
                    cornerRadius = 20f
                }

                addView(indicatorContainer)
                visibility = View.GONE
            }

            // æ·»åŠ åˆ°ä¸»å¸ƒå±€
            val rootLayout = findViewById<FrameLayout>(android.R.id.content)
            rootLayout.addView(tabSwipeGestureIndicator)

            Log.d(TAG, "åº•éƒ¨tabæ‰‹åŠ¿æŒ‡ç¤ºå™¨åˆ›å»ºå®Œæˆ")
        } catch (e: Exception) {
            Log.e(TAG, "åˆ›å»ºåº•éƒ¨tabæ‰‹åŠ¿æŒ‡ç¤ºå™¨å¤±è´¥", e)
        }
    }

    /**
     * æ˜¾ç¤ºåº•éƒ¨tabæ‰‹åŠ¿æŒ‡ç¤ºå™¨
     */
    private fun showTabSwipeGestureIndicator() {
        tabSwipeGestureIndicator?.apply {
            visibility = View.VISIBLE
            alpha = 0f
            scaleX = 0.8f
            scaleY = 0.8f

            animate()
                .alpha(1f)
                .scaleX(1f)
                .scaleY(1f)
                .setDuration(200)
                .start()

            // 2ç§’åè‡ªåŠ¨éšè—
            postDelayed({
                hideTabSwipeGestureIndicator()
            }, 2000)
        }
    }

    /**
     * éšè—åº•éƒ¨tabæ‰‹åŠ¿æŒ‡ç¤ºå™¨
     */
    private fun hideTabSwipeGestureIndicator() {
        tabSwipeGestureIndicator?.animate()
            ?.alpha(0f)
            ?.scaleX(0.8f)
            ?.scaleY(0.8f)
            ?.setDuration(200)
            ?.withEndAction {
                tabSwipeGestureIndicator?.visibility = View.GONE
            }
            ?.start()
    }

    /**
     * ç¡®ä¿AIåŠ©æ‰‹æ ‡ç­¾é¡µå­˜åœ¨
     */
    private fun ensureAIAssistantTabExists() {
        try {
            val chatTabLayout = findViewById<com.google.android.material.tabs.TabLayout>(R.id.chat_tab_layout)

            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨"AIåŠ©æ‰‹"æ ‡ç­¾é¡µ
            var aiTabExists = false
            for (i in 0 until (chatTabLayout?.tabCount ?: 0)) {
                val tab = chatTabLayout?.getTabAt(i)
                if (tab?.text?.toString() == "AIåŠ©æ‰‹") {
                    aiTabExists = true
                    break
                }
            }

            // å¦‚æœä¸å­˜åœ¨ï¼Œåˆ›å»º"AIåŠ©æ‰‹"æ ‡ç­¾é¡µ
            if (!aiTabExists) {
                val aiTab = chatTabLayout?.newTab()?.setText("AIåŠ©æ‰‹")
                if (aiTab != null) {
                    // åœ¨"å…¨éƒ¨"æ ‡ç­¾é¡µåé¢æ’å…¥
                    chatTabLayout?.addTab(aiTab, 1)
                    Log.d(TAG, "åˆ›å»ºAIåŠ©æ‰‹æ ‡ç­¾é¡µ")

                    // æ¸…é™¤åˆ é™¤æ ‡è®°
                    val prefs = getSharedPreferences("custom_tabs", MODE_PRIVATE)
                    prefs.edit().putBoolean("ai_assistant_group_deleted", false).apply()
                }
            }
        } catch (e: Exception) {
            Log.e(TAG, "ç¡®ä¿AIåŠ©æ‰‹æ ‡ç­¾é¡µå­˜åœ¨å¤±è´¥", e)
        }
    }

    // ==================== æœç´¢tabæ¨ªæ»‘çƒ­åŒº ====================

    /**
     * åˆ›å»ºæœç´¢tabæ¨ªæ»‘çƒ­åŒº
     */
    private fun createSearchTabSwipeHotArea() {
        try {
            // ä½¿ç”¨æµè§ˆå™¨WebViewå®¹å™¨ä½œä¸ºæœç´¢tabå®¹å™¨
            val searchTabContainer = findViewById<FrameLayout>(R.id.browser_webview_container)
            if (searchTabContainer == null) {
                Log.w(TAG, "æœç´¢tabå®¹å™¨æœªæ‰¾åˆ°ï¼Œæ— æ³•åˆ›å»ºæ¨ªæ»‘çƒ­åŒº")
                return
            }

            // åˆ›å»ºæ¨ªæ»‘çƒ­åŒºï¼ˆé€æ˜è¦†ç›–å±‚ï¼‰
            searchTabSwipeHotArea = View(this).apply {
                layoutParams = FrameLayout.LayoutParams(
                    FrameLayout.LayoutParams.MATCH_PARENT,
                    120 // çƒ­åŒºé«˜åº¦120dpï¼Œé¿å…è¦†ç›–æœç´¢tabåŒºåŸŸ
                ).apply {
                    gravity = android.view.Gravity.TOP
                    topMargin = 200 // è·ç¦»é¡¶éƒ¨200dpå¼€å§‹ï¼Œç¡®ä¿ä¸è¦†ç›–æœç´¢tab
                }

                // è®¾ç½®é€æ˜èƒŒæ™¯
                setBackgroundColor(android.graphics.Color.TRANSPARENT)

                // è®¾ç½®è§¦æ‘¸ç›‘å¬
                setOnTouchListener(createSearchTabSwipeGestureListener())
            }

            // æ·»åŠ åˆ°æœç´¢tabå®¹å™¨
            searchTabContainer.addView(searchTabSwipeHotArea)

            // åˆ›å»ºæ¨ªæ»‘æŒ‡ç¤ºå™¨
            createSearchTabSwipeIndicator()

            Log.d(TAG, "æœç´¢tabæ¨ªæ»‘çƒ­åŒºåˆ›å»ºå®Œæˆ")
        } catch (e: Exception) {
            Log.e(TAG, "åˆ›å»ºæœç´¢tabæ¨ªæ»‘çƒ­åŒºå¤±è´¥", e)
        }
    }

    /**
     * åˆ›å»ºæœç´¢tabæ¨ªæ»‘æŒ‡ç¤ºå™¨
     */
    private fun createSearchTabSwipeIndicator() {
        try {
            // åˆ›å»ºæŒ‡ç¤ºå™¨å®¹å™¨
            val indicatorContainer = LinearLayout(this).apply {
                orientation = LinearLayout.HORIZONTAL
                gravity = android.view.Gravity.CENTER
                setPadding(20, 10, 20, 10)
            }

            // åˆ›å»ºå·¦ç®­å¤´
            val leftArrow = TextView(this).apply {
                text = "â—€"
                textSize = 18f
                setTextColor(android.graphics.Color.WHITE)
                alpha = 0.8f
            }

            // åˆ›å»ºä¸­é—´æç¤ºæ–‡å­—
            val hintText = TextView(this).apply {
                text = "å·¦å³æ»‘åŠ¨åˆ‡æ¢é¡µé¢"
                textSize = 14f
                setTextColor(android.graphics.Color.WHITE)
                alpha = 0.9f
                setPadding(20, 0, 20, 0)
            }

            // åˆ›å»ºå³ç®­å¤´
            val rightArrow = TextView(this).apply {
                text = "â–¶"
                textSize = 18f
                setTextColor(android.graphics.Color.WHITE)
                alpha = 0.8f
            }

            // æ·»åŠ åˆ°å®¹å™¨
            indicatorContainer.addView(leftArrow)
            indicatorContainer.addView(hintText)
            indicatorContainer.addView(rightArrow)

            // åˆ›å»ºæŒ‡ç¤ºå™¨èƒŒæ™¯
            searchTabSwipeIndicator = FrameLayout(this).apply {
                layoutParams = FrameLayout.LayoutParams(
                    FrameLayout.LayoutParams.WRAP_CONTENT,
                    FrameLayout.LayoutParams.WRAP_CONTENT
                ).apply {
                    gravity = android.view.Gravity.CENTER_HORIZONTAL or android.view.Gravity.TOP
                    topMargin = 150 // åœ¨çƒ­åŒºä¸­å¤®æ˜¾ç¤º
                }

                // è®¾ç½®èƒŒæ™¯
                background = android.graphics.drawable.GradientDrawable().apply {
                    setColor(android.graphics.Color.parseColor("#CC000000"))
                    cornerRadius = 25f
                }

                addView(indicatorContainer)
                visibility = View.GONE
            }

            // æ·»åŠ åˆ°ä¸»å¸ƒå±€
            val rootLayout = findViewById<FrameLayout>(android.R.id.content)
            rootLayout.addView(searchTabSwipeIndicator)

            Log.d(TAG, "æœç´¢tabæ¨ªæ»‘æŒ‡ç¤ºå™¨åˆ›å»ºå®Œæˆ")
        } catch (e: Exception) {
            Log.e(TAG, "åˆ›å»ºæœç´¢tabæ¨ªæ»‘æŒ‡ç¤ºå™¨å¤±è´¥", e)
        }
    }

    /**
     * åˆ›å»ºæœç´¢tabæ¨ªæ»‘æ‰‹åŠ¿ç›‘å¬å™¨
     */
    private fun createSearchTabSwipeGestureListener(): View.OnTouchListener {
        val gestureDetector = GestureDetector(this, object : GestureDetector.SimpleOnGestureListener() {
            override fun onFling(
                e1: MotionEvent?,
                e2: MotionEvent,
                velocityX: Float,
                velocityY: Float
            ): Boolean {
                if (e1 == null) return false

                // æ£€æŸ¥æ˜¯å¦æœ‰æ‚¬æµ®å¡ç‰‡é¢„è§ˆæ­£åœ¨æ˜¾ç¤º
                val isStackedPreviewVisible = stackedCardPreview?.visibility == View.VISIBLE
                if (isStackedPreviewVisible) {
                    // æ‚¬æµ®å¡ç‰‡æ˜¾ç¤ºæ—¶ï¼Œä¸å¤„ç†é¡µé¢åˆ‡æ¢æ‰‹åŠ¿
                    Log.d(TAG, "æ‚¬æµ®å¡ç‰‡é¢„è§ˆå¯è§ï¼Œä¸å¤„ç†é¡µé¢åˆ‡æ¢æ‰‹åŠ¿")
                    return false
                }

                // é˜²æŠ–å¤„ç†
                val currentTime = System.currentTimeMillis()
                if (currentTime - lastSearchTabSwipeTime < swipeDebounceDelay) {
                    Log.d(TAG, "æœç´¢tabæ¨ªæ»‘æ‰‹åŠ¿é˜²æŠ–ï¼Œå¿½ç•¥æ­¤æ¬¡æ“ä½œ")
                    return false
                }

                val deltaX = e2.x - e1.x
                val deltaY = e2.y - e1.y

                // ç¡®ä¿æ˜¯æ°´å¹³æ»‘åŠ¨ä¸”æ»‘åŠ¨è·ç¦»è¶³å¤Ÿ
                if (abs(deltaX) > abs(deltaY) && abs(deltaX) > 120) {
                    lastSearchTabSwipeTime = currentTime

                    // å½“â€œæœç´¢tabæ‰‹åŠ¿é®ç½©å±‚â€æ¿€æ´»æ—¶ï¼Œå·¦å³æ»‘åŠ¨ç”¨äºç½‘é¡µå‰è¿›/åé€€ï¼›
                    // å¦åˆ™ä¿æŒåŸæœ‰â€œåˆ‡æ¢é¡µé¢å¡ç‰‡â€çš„é€»è¾‘ã€‚
                    if (isSearchTabGestureOverlayActive) {
                        // è·å–å½“å‰WebViewï¼ˆä¼˜å…ˆæ‰‹æœºå¡ç‰‡ç®¡ç†å™¨ï¼Œå…¶æ¬¡æ‰‹åŠ¿å¡ç‰‡ç®¡ç†å™¨ï¼‰
                        val currentWebView = try {
                            mobileCardManager?.getCurrentCard()?.webView
                                ?: gestureCardWebViewManager?.getCurrentCard()?.webView
                        } catch (e: Exception) { null }

                        if (deltaX > 0) {
                            // å‘å³æ»‘åŠ¨ - ç½‘é¡µåé€€
                            var handled = false
                            try {
                                // å…ˆå°è¯•çº¸å †ç®¡ç†å™¨çš„åé€€
                                paperStackWebViewManager?.goBack()
                                handled = true
                            } catch (_: Exception) {}

                            if (!handled && currentWebView?.canGoBack() == true) {
                                currentWebView.goBack()
                                handled = true
                            }

                            showSearchTabSwipeIndicator("åé€€")
                            Log.d(TAG, "æœç´¢tabé®ç½©å±‚ï¼šå³æ»‘ â†’ ç½‘é¡µåé€€ï¼Œhandled=$handled")
                        } else {
                            // å‘å·¦æ»‘åŠ¨ - ç½‘é¡µå‰è¿›
                            var handled = false
                            try {
                                // å¦‚æœæœ‰ç»Ÿä¸€/çº¸å †ç®¡ç†å™¨å‰è¿›ï¼Œå¯åœ¨æ­¤è¡¥å……ï¼›å¦åˆ™ç›´æ¥ç”¨å½“å‰WebView
                                // paperStackWebViewManager?.goForward() // è‹¥å­˜åœ¨å¯å¯ç”¨
                            } catch (_: Exception) {}

                            if (!handled && currentWebView?.canGoForward() == true) {
                                currentWebView.goForward()
                                handled = true
                            }

                            showSearchTabSwipeIndicator("å‰è¿›")
                            Log.d(TAG, "æœç´¢tabé®ç½©å±‚ï¼šå·¦æ»‘ â†’ ç½‘é¡µå‰è¿›ï¼Œhandled=$handled")
                        }
                    } else {
                        if (deltaX > 0) {
                            // å‘å³æ»‘åŠ¨ï¼Œåˆ‡æ¢åˆ°ä¸Šä¸€ä¸ªé¡µé¢
                            switchToPreviousWebPage()
                            showSearchTabSwipeIndicator("ä¸Šä¸€é¡µ")
                        } else {
                            // å‘å·¦æ»‘åŠ¨ï¼Œåˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªé¡µé¢
                            switchToNextWebPage()
                            showSearchTabSwipeIndicator("ä¸‹ä¸€é¡µ")
                        }
                    }
                    return true
                }
                return false
            }

            override fun onDown(e: MotionEvent): Boolean {
                // æ£€æŸ¥æ˜¯å¦æœ‰æ‚¬æµ®å¡ç‰‡é¢„è§ˆæ­£åœ¨æ˜¾ç¤º
                val isStackedPreviewVisible = stackedCardPreview?.visibility == View.VISIBLE
                if (!isStackedPreviewVisible) {
                    // åªæœ‰åœ¨æ²¡æœ‰æ‚¬æµ®å¡ç‰‡æ—¶æ‰æ˜¾ç¤ºæ‰‹åŠ¿æç¤º
                    showSearchTabSwipeIndicator(if (isSearchTabGestureOverlayActive) "å‰è¿›/åé€€" else "æ»‘åŠ¨åˆ‡æ¢")
                }
                return true
            }
        })

        return View.OnTouchListener { view, event ->
            // æ£€æŸ¥æ˜¯å¦æœ‰æ‚¬æµ®å¡ç‰‡é¢„è§ˆæ­£åœ¨æ˜¾ç¤º
            val isStackedPreviewVisible = stackedCardPreview?.visibility == View.VISIBLE

            if (isStackedPreviewVisible) {
                // å±‚å å¡ç‰‡é¢„è§ˆæ¨¡å¼ä¸‹ï¼Œä¸å¤„ç†è§¦æ‘¸äº‹ä»¶ï¼Œè®©StackedCardPreviewè‡ªå·±å¤„ç†
                Log.d(TAG, "æœç´¢tabåŒºåŸŸè§¦æ‘¸ï¼Œå±‚å å¡ç‰‡é¢„è§ˆå¯è§ï¼Œä¸æ‹¦æˆªè§¦æ‘¸äº‹ä»¶")
                false
            } else {
                // æ­£å¸¸æ¨¡å¼ä¸‹ï¼Œå¤„ç†é¡µé¢åˆ‡æ¢æ‰‹åŠ¿
                gestureDetector.onTouchEvent(event)
                false
            }
        }
    }

    /**
     * æ˜¾ç¤ºæœç´¢tabæ¨ªæ»‘æŒ‡ç¤ºå™¨
     */
    private fun showSearchTabSwipeIndicator(action: String = "æ»‘åŠ¨åˆ‡æ¢") {
        searchTabSwipeIndicator?.apply {
            // æ›´æ–°æç¤ºæ–‡å­—å’Œç®­å¤´ - æŸ¥æ‰¾LinearLayoutä¸­çš„TextView
            val frameLayout = this as FrameLayout
            val container = frameLayout.getChildAt(0) as? LinearLayout
            val leftArrow = container?.getChildAt(0) as? TextView
            val hintText = container?.getChildAt(1) as? TextView // ä¸­é—´çš„æç¤ºæ–‡å­—
            val rightArrow = container?.getChildAt(2) as? TextView

            // æ›´æ–°æ–‡å­—å’Œç®­å¤´æ˜¾ç¤º
            when (action) {
                "ä¸Šä¸€é¡µ" -> {
                    hintText?.text = "ä¸Šä¸€é¡µ"
                    leftArrow?.visibility = View.VISIBLE
                    rightArrow?.visibility = View.GONE
                    leftArrow?.text = "â—€"
                }
                "ä¸‹ä¸€é¡µ" -> {
                    hintText?.text = "ä¸‹ä¸€é¡µ"
                    leftArrow?.visibility = View.GONE
                    rightArrow?.visibility = View.VISIBLE
                    rightArrow?.text = "â–¶"
                }
                else -> {
                    hintText?.text = "å·¦å³æ»‘åŠ¨åˆ‡æ¢é¡µé¢"
                    leftArrow?.visibility = View.VISIBLE
                    rightArrow?.visibility = View.VISIBLE
                    leftArrow?.text = "â—€"
                    rightArrow?.text = "â–¶"
                }
            }

            visibility = View.VISIBLE
            alpha = 0f
            scaleX = 0.8f
            scaleY = 0.8f
            translationY = 20f

            // Materialé£æ ¼çš„åŠ¨ç”»
            animate()
                .alpha(1f)
                .scaleX(1f)
                .scaleY(1f)
                .translationY(0f)
                .setDuration(300)
                .setInterpolator(android.view.animation.DecelerateInterpolator(2f))
                .withEndAction {
                    // æ·»åŠ ç®­å¤´åŠ¨ç”»
                    animateArrows(leftArrow, rightArrow, action)
                }
                .start()

            // 2ç§’åè‡ªåŠ¨éšè—
            postDelayed({
                hideSearchTabSwipeIndicator()
            }, 2000)
        }
    }

    /**
     * éšè—æœç´¢tabæ¨ªæ»‘æŒ‡ç¤ºå™¨
     */
    private fun hideSearchTabSwipeIndicator() {
        searchTabSwipeIndicator?.animate()
            ?.alpha(0f)
            ?.scaleX(0.8f)
            ?.scaleY(0.8f)
            ?.translationY(20f)
            ?.setDuration(200)
            ?.setInterpolator(android.view.animation.AccelerateInterpolator(2f))
            ?.withEndAction {
                searchTabSwipeIndicator?.visibility = View.GONE
            }
            ?.start()
    }

    /**
     * åŠ¨ç”»ç®­å¤´
     */
    private fun animateArrows(leftArrow: TextView?, rightArrow: TextView?, action: String) {
        when (action) {
            "ä¸Šä¸€é¡µ" -> {
                leftArrow?.let { arrow ->
                    // å·¦ç®­å¤´å‘å³ç§»åŠ¨çš„åŠ¨ç”»
                    arrow.animate()
                        .translationX(10f)
                        .setDuration(200)
                        .withEndAction {
                            arrow.animate()
                                .translationX(0f)
                                .setDuration(200)
                                .start()
                        }
                        .start()
                }
            }
            "ä¸‹ä¸€é¡µ" -> {
                rightArrow?.let { arrow ->
                    // å³ç®­å¤´å‘å·¦ç§»åŠ¨çš„åŠ¨ç”»
                    arrow.animate()
                        .translationX(-10f)
                        .setDuration(200)
                        .withEndAction {
                            arrow.animate()
                                .translationX(0f)
                                .setDuration(200)
                                .start()
                        }
                        .start()
                }
            }
            else -> {
                // å·¦å³ç®­å¤´äº¤æ›¿åŠ¨ç”»
                leftArrow?.let { left ->
                    left.animate()
                        .translationX(5f)
                        .setDuration(300)
                        .withEndAction {
                            left.animate()
                                .translationX(0f)
                                .setDuration(300)
                                .start()
                        }
                        .start()
                }
                rightArrow?.let { right ->
                    right.animate()
                        .translationX(-5f)
                        .setDuration(300)
                        .withEndAction {
                            right.animate()
                                .translationX(0f)
                                .setDuration(300)
                                .start()
                        }
                        .start()
                }
            }
        }
    }

    /**
     * è®¾ç½®tabåŒºåŸŸä¹‹é—´çš„æ»‘åŠ¨åˆ‡æ¢ç½‘é¡µåŠŸèƒ½
     */
    private fun setupTabAreaSwipeForWebPageSwitch() {
        try {
            // åˆ›å»ºtabåŒºåŸŸæ»‘åŠ¨æ‰‹åŠ¿æ£€æµ‹å™¨
            val tabSwipeDetector = GestureDetector(this, object : GestureDetector.SimpleOnGestureListener() {
                override fun onFling(
                    e1: MotionEvent?,
                    e2: MotionEvent,
                    velocityX: Float,
                    velocityY: Float
                ): Boolean {
                    if (e1 == null) return false

                    // é˜²æŠ–å¤„ç†
                    val currentTime = System.currentTimeMillis()
                    if (currentTime - lastTabSwipeTime < tabSwipeDebounceDelay) {
                        return false
                    }

                    val deltaX = e2.x - e1.x
                    val deltaY = e2.y - e1.y

                    // ç¡®ä¿æ˜¯æ°´å¹³æ»‘åŠ¨ä¸”æ»‘åŠ¨è·ç¦»è¶³å¤Ÿ
                    if (abs(deltaX) > abs(deltaY) && abs(deltaX) > 120) {
                        lastTabSwipeTime = currentTime

                        if (deltaX > 0) {
                            // å‘å³æ»‘åŠ¨ï¼Œåˆ‡æ¢åˆ°ä¸Šä¸€ä¸ªç½‘é¡µ
                            switchToPreviousWebPage()
                            showTabSwipeIndicator("ä¸Šä¸€ä¸ªæ ‡ç­¾")
                        } else {
                            // å‘å·¦æ»‘åŠ¨ï¼Œåˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªç½‘é¡µ
                            switchToNextWebPage()
                            showTabSwipeIndicator("ä¸‹ä¸€ä¸ªæ ‡ç­¾")
                        }
                        return true
                    }
                    return false
                }

                override fun onDown(e: MotionEvent): Boolean {
                    // æ˜¾ç¤ºæ‰‹åŠ¿æç¤º
                    showTabSwipeIndicator("å·¦å³æ»‘åŠ¨åˆ‡æ¢ç½‘é¡µ")
                    return true
                }
            })

            // ä¸ºåº•éƒ¨å¯¼èˆªæ è®¾ç½®æ‰‹åŠ¿ç›‘å¬
            val bottomNav = findViewById<LinearLayout>(R.id.bottom_navigation)
            bottomNav?.setOnTouchListener { _, event ->
                // å¦‚æœStackedCardPreviewæ­£åœ¨æ˜¾ç¤ºï¼Œä¸å¤„ç†è§¦æ‘¸äº‹ä»¶
                if (stackedCardPreview?.visibility == View.VISIBLE) {
                    Log.d(TAG, "åº•éƒ¨å¯¼èˆªæ è§¦æ‘¸ï¼ŒStackedCardPreviewå¯è§ï¼Œä¸å¤„ç†è§¦æ‘¸äº‹ä»¶")
                    false
                } else {
                    // åªæœ‰åœ¨æœç´¢tabæ—¶æ‰å¤„ç†ç½‘é¡µåˆ‡æ¢æ‰‹åŠ¿
                    if (getCurrentTabIndex() == 1) {
                        tabSwipeDetector.onTouchEvent(event)
                    } else {
                        false
                    }
                }
            }

            Log.d(TAG, "TabåŒºåŸŸæ»‘åŠ¨åˆ‡æ¢ç½‘é¡µåŠŸèƒ½è®¾ç½®å®Œæˆ")
        } catch (e: Exception) {
            Log.e(TAG, "è®¾ç½®tabåŒºåŸŸæ»‘åŠ¨åˆ‡æ¢ç½‘é¡µåŠŸèƒ½å¤±è´¥", e)
        }
    }

    /**
     * åˆ›å»ºtabæ»‘åŠ¨æŒ‡ç¤ºå™¨
     */
    private fun createTabSwipeIndicator() {
        try {
            // åˆ›å»ºæŒ‡ç¤ºå™¨å®¹å™¨
            val indicatorContainer = LinearLayout(this).apply {
                orientation = LinearLayout.HORIZONTAL
                gravity = Gravity.CENTER
                setPadding(24, 16, 24, 16)
            }

            // å·¦ç®­å¤´
            val leftArrow = TextView(this).apply {
                text = "â—€"
                textSize = 20f
                setTextColor(ContextCompat.getColor(this@SimpleModeActivity, R.color.material_green_500))
                gravity = Gravity.CENTER
                layoutParams = LinearLayout.LayoutParams(
                    LinearLayout.LayoutParams.WRAP_CONTENT,
                    LinearLayout.LayoutParams.WRAP_CONTENT
                ).apply {
                    marginEnd = 8
                }
            }

            // æç¤ºæ–‡å­—
            val hintText = TextView(this).apply {
                text = "å·¦å³æ»‘åŠ¨åˆ‡æ¢ç½‘é¡µ"
                textSize = 16f
                setTextColor(ContextCompat.getColor(this@SimpleModeActivity, R.color.material_grey_800))
                gravity = Gravity.CENTER
                layoutParams = LinearLayout.LayoutParams(
                    LinearLayout.LayoutParams.WRAP_CONTENT,
                    LinearLayout.LayoutParams.WRAP_CONTENT
                ).apply {
                    marginStart = 8
                    marginEnd = 8
                }
            }

            // å³ç®­å¤´
            val rightArrow = TextView(this).apply {
                text = "â–¶"
                textSize = 20f
                setTextColor(ContextCompat.getColor(this@SimpleModeActivity, R.color.material_green_500))
                gravity = Gravity.CENTER
                layoutParams = LinearLayout.LayoutParams(
                    LinearLayout.LayoutParams.WRAP_CONTENT,
                    LinearLayout.LayoutParams.WRAP_CONTENT
                ).apply {
                    marginStart = 8
                }
            }

            indicatorContainer.addView(leftArrow)
            indicatorContainer.addView(hintText)
            indicatorContainer.addView(rightArrow)

            // åˆ›å»ºæŒ‡ç¤ºå™¨èƒŒæ™¯
            tabSwipeIndicator = FrameLayout(this).apply {
                layoutParams = FrameLayout.LayoutParams(
                    FrameLayout.LayoutParams.WRAP_CONTENT,
                    FrameLayout.LayoutParams.WRAP_CONTENT
                ).apply {
                    gravity = android.view.Gravity.CENTER_HORIZONTAL or android.view.Gravity.TOP
                    topMargin = 150 // åœ¨tabåŒºåŸŸä¸Šæ–¹æ˜¾ç¤º
                }

                // è®¾ç½®èƒŒæ™¯
                background = android.graphics.drawable.GradientDrawable().apply {
                    setColor(ContextCompat.getColor(this@SimpleModeActivity, R.color.material_grey_100))
                    cornerRadius = 24f
                    setStroke(2, ContextCompat.getColor(this@SimpleModeActivity, R.color.material_green_500))
                }

                addView(indicatorContainer)
                visibility = View.GONE
            }

            // æ·»åŠ åˆ°ä¸»å¸ƒå±€
            val rootLayout = findViewById<FrameLayout>(android.R.id.content)
            rootLayout.addView(tabSwipeIndicator)

            Log.d(TAG, "Tabæ»‘åŠ¨æŒ‡ç¤ºå™¨åˆ›å»ºå®Œæˆ")
        } catch (e: Exception) {
            Log.e(TAG, "åˆ›å»ºtabæ»‘åŠ¨æŒ‡ç¤ºå™¨å¤±è´¥", e)
        }
    }

    /**
     * æ˜¾ç¤ºtabæ»‘åŠ¨æŒ‡ç¤ºå™¨
     */
    private fun showTabSwipeIndicator(action: String = "å·¦å³æ»‘åŠ¨åˆ‡æ¢ç½‘é¡µ") {
        tabSwipeIndicator?.apply {
            // æ›´æ–°æç¤ºæ–‡å­—å’Œç®­å¤´
            val frameLayout = this as FrameLayout
            val container = frameLayout.getChildAt(0) as? LinearLayout
            val leftArrow = container?.getChildAt(0) as? TextView
            val hintText = container?.getChildAt(1) as? TextView
            val rightArrow = container?.getChildAt(2) as? TextView

            // æ›´æ–°æ–‡å­—å’Œç®­å¤´æ˜¾ç¤º
            when (action) {
                "ä¸Šä¸€ä¸ªæ ‡ç­¾" -> {
                    hintText?.text = "ä¸Šä¸€ä¸ªæ ‡ç­¾"
                    leftArrow?.visibility = View.VISIBLE
                    rightArrow?.visibility = View.GONE
                    leftArrow?.text = "â—€"
                }
                "ä¸‹ä¸€ä¸ªæ ‡ç­¾" -> {
                    hintText?.text = "ä¸‹ä¸€ä¸ªæ ‡ç­¾"
                    leftArrow?.visibility = View.GONE
                    rightArrow?.visibility = View.VISIBLE
                    rightArrow?.text = "â–¶"
                }
                else -> {
                    hintText?.text = "å·¦å³æ»‘åŠ¨åˆ‡æ¢ç½‘é¡µ"
                    leftArrow?.visibility = View.VISIBLE
                    rightArrow?.visibility = View.VISIBLE
                    leftArrow?.text = "â—€"
                    rightArrow?.text = "â–¶"
                }
            }

            visibility = View.VISIBLE
            alpha = 0f
            scaleX = 0.8f
            scaleY = 0.8f
            translationY = 20f

            // Materialé£æ ¼çš„åŠ¨ç”»
            animate()
                .alpha(1f)
                .scaleX(1f)
                .scaleY(1f)
                .translationY(0f)
                .setDuration(300)
                .setInterpolator(android.view.animation.DecelerateInterpolator(2f))
                .withEndAction {
                    // æ·»åŠ ç®­å¤´åŠ¨ç”»
                    animateTabArrows(leftArrow, rightArrow, action)
                }
                .start()

            // 2ç§’åè‡ªåŠ¨éšè—
            postDelayed({
                hideTabSwipeIndicator()
            }, 2000)
        }
    }

    /**
     * éšè—tabæ»‘åŠ¨æŒ‡ç¤ºå™¨
     */
    private fun hideTabSwipeIndicator() {
        tabSwipeIndicator?.animate()
            ?.alpha(0f)
            ?.scaleX(0.8f)
            ?.scaleY(0.8f)
            ?.translationY(20f)
            ?.setDuration(200)
            ?.setInterpolator(android.view.animation.AccelerateInterpolator(2f))
            ?.withEndAction {
                tabSwipeIndicator?.visibility = View.GONE
            }
            ?.start()
    }

    /**
     * åŠ¨ç”»tabç®­å¤´
     */
    private fun animateTabArrows(leftArrow: TextView?, rightArrow: TextView?, action: String) {
        when (action) {
            "ä¸Šä¸€ä¸ªæ ‡ç­¾" -> {
                leftArrow?.let { arrow ->
                    // å·¦ç®­å¤´å‘å³ç§»åŠ¨çš„åŠ¨ç”»
                    arrow.animate()
                        .translationX(10f)
                        .setDuration(200)
                        .withEndAction {
                            arrow.animate()
                                .translationX(0f)
                                .setDuration(200)
                                .start()
                        }
                        .start()
                }
            }
            "ä¸‹ä¸€ä¸ªæ ‡ç­¾" -> {
                rightArrow?.let { arrow ->
                    // å³ç®­å¤´å‘å·¦ç§»åŠ¨çš„åŠ¨ç”»
                    arrow.animate()
                        .translationX(-10f)
                        .setDuration(200)
                        .withEndAction {
                            arrow.animate()
                                .translationX(0f)
                                .setDuration(200)
                                .start()
                        }
                        .start()
                }
            }
            else -> {
                // å·¦å³ç®­å¤´äº¤æ›¿åŠ¨ç”»
                leftArrow?.let { left ->
                    left.animate()
                        .translationX(5f)
                        .setDuration(300)
                        .withEndAction {
                            left.animate()
                                .translationX(0f)
                                .setDuration(300)
                                .start()
                        }
                        .start()
                }
                rightArrow?.let { right ->
                    right.animate()
                        .translationX(-5f)
                        .setDuration(300)
                        .withEndAction {
                            right.animate()
                                .translationX(0f)
                                .setDuration(300)
                                .start()
                        }
                        .start()
                }
            }
        }
    }

    /**
     * åˆ‡æ¢åˆ°ä¸Šä¸€ä¸ªç½‘é¡µ
     */
    private fun switchToPreviousWebPage() {
        Log.d(TAG, "ğŸ”„ å¼€å§‹åˆ‡æ¢åˆ°ä¸Šä¸€ä¸ªç½‘é¡µ")
        try {
            gestureCardWebViewManager?.let { manager ->
                val allCards = manager.getAllCards()
                val currentCard = manager.getCurrentCard()
                val currentIndex = allCards.indexOf(currentCard)
                val totalPages = allCards.size

                Log.d(TAG, "ğŸ“Š åˆ‡æ¢åˆ°ä¸Šä¸€ä¸ªç½‘é¡µ - å½“å‰ç´¢å¼•: $currentIndex, æ€»é¡µé¢æ•°: $totalPages")
                Log.d(TAG, "ğŸ“‹ æ‰€æœ‰å¡ç‰‡: ${allCards.map { it.title ?: "æ— æ ‡é¢˜" }}")

                if (totalPages > 1) {
                    val previousIndex = if (currentIndex > 0) currentIndex - 1 else totalPages - 1
                    manager.switchToCard(previousIndex)

                    Log.d(TAG, "âœ… æˆåŠŸåˆ‡æ¢åˆ°ä¸Šä¸€ä¸ªç½‘é¡µ: $previousIndex")

                    // æ˜¾ç¤ºé¡µé¢åˆ‡æ¢åŠ¨ç”»
                    showPageSwitchAnimation("ä¸Šä¸€é¡µ", previousIndex + 1, totalPages)

                    // é™é»˜åˆ‡æ¢ï¼Œä¸æ˜¾ç¤ºæç¤º
                } else if (totalPages == 1) {
                    Log.d(TAG, "âš ï¸ åªæœ‰ä¸€ä¸ªé¡µé¢ï¼Œæ— æ³•åˆ‡æ¢")
                } else {
                    Log.d(TAG, "âš ï¸ æ²¡æœ‰é¡µé¢")
                }
            } ?: run {
                Log.w(TAG, "âŒ gestureCardWebViewManagerä¸ºnullï¼Œæ— æ³•åˆ‡æ¢é¡µé¢")
            }
        } catch (e: Exception) {
            Log.e(TAG, "âŒ åˆ‡æ¢åˆ°ä¸Šä¸€ä¸ªç½‘é¡µå¤±è´¥", e)
        }
    }

    /**
     * åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªç½‘é¡µ
     */
    private fun switchToNextWebPage() {
        Log.d(TAG, "ğŸ”„ å¼€å§‹åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªç½‘é¡µ")
        try {
            gestureCardWebViewManager?.let { manager ->
                val allCards = manager.getAllCards()
                val currentCard = manager.getCurrentCard()
                val currentIndex = allCards.indexOf(currentCard)
                val totalPages = allCards.size

                Log.d(TAG, "ğŸ“Š åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªç½‘é¡µ - å½“å‰ç´¢å¼•: $currentIndex, æ€»é¡µé¢æ•°: $totalPages")
                Log.d(TAG, "ğŸ“‹ æ‰€æœ‰å¡ç‰‡: ${allCards.map { it.title ?: "æ— æ ‡é¢˜" }}")

                if (totalPages > 1) {
                    val nextIndex = if (currentIndex < totalPages - 1) currentIndex + 1 else 0
                    manager.switchToCard(nextIndex)

                    Log.d(TAG, "âœ… æˆåŠŸåˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªç½‘é¡µ: $nextIndex")

                    // æ˜¾ç¤ºé¡µé¢åˆ‡æ¢åŠ¨ç”»
                    showPageSwitchAnimation("ä¸‹ä¸€é¡µ", nextIndex + 1, totalPages)

                    // é™é»˜åˆ‡æ¢ï¼Œä¸æ˜¾ç¤ºæç¤º
                } else if (totalPages == 1) {
                    Log.d(TAG, "âš ï¸ åªæœ‰ä¸€ä¸ªé¡µé¢ï¼Œæ— æ³•åˆ‡æ¢")
                } else {
                    Log.d(TAG, "âš ï¸ æ²¡æœ‰é¡µé¢")
                }
            } ?: run {
                Log.w(TAG, "âŒ gestureCardWebViewManagerä¸ºnullï¼Œæ— æ³•åˆ‡æ¢é¡µé¢")
            }
        } catch (e: Exception) {
            Log.e(TAG, "âŒ åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªç½‘é¡µå¤±è´¥", e)
        }
    }

    // ==================== å¯¹è¯tabæ¨ªæ»‘æ‰‹åŠ¿å¤„ç† ====================

    /**
     * åˆ‡æ¢åˆ°ä¸Šä¸€ä¸ªå¯¹è¯æ ‡ç­¾
     * @return ç›®æ ‡æ ‡ç­¾çš„åç§°
     */
    private fun switchToPreviousChatTab(): String? {
        try {
            val chatTabLayout = findViewById<com.google.android.material.tabs.TabLayout>(R.id.chat_tab_layout)
            if (chatTabLayout == null) {
                Log.w(TAG, "å¯¹è¯TabLayoutæœªæ‰¾åˆ°")
                return null
            }

            val currentPosition = chatTabLayout.selectedTabPosition
            val tabCount = chatTabLayout.tabCount

            if (tabCount <= 1) {
                Log.d(TAG, "åªæœ‰ä¸€ä¸ªæ ‡ç­¾ï¼Œæ— æ³•åˆ‡æ¢")
                return null
            }

            // è®¡ç®—ä¸Šä¸€ä¸ªæ ‡ç­¾ä½ç½®ï¼ˆè·³è¿‡"+"æŒ‰é’®ï¼‰
            var previousPosition = currentPosition - 1
            if (previousPosition < 0) {
                // å¦‚æœå·²ç»æ˜¯ç¬¬ä¸€ä¸ªæ ‡ç­¾ï¼Œåˆ‡æ¢åˆ°æœ€åä¸€ä¸ªæœ‰æ•ˆæ ‡ç­¾ï¼ˆæ’é™¤"+"æŒ‰é’®ï¼‰
                previousPosition = tabCount - 2 // å€’æ•°ç¬¬äºŒä¸ªï¼ˆå› ä¸ºæœ€åä¸€ä¸ªæ˜¯"+"æŒ‰é’®ï¼‰
                if (previousPosition < 0) previousPosition = 0
            }

            // æ£€æŸ¥ç›®æ ‡æ ‡ç­¾æ˜¯å¦æ˜¯"+"æŒ‰é’®ï¼Œå¦‚æœæ˜¯åˆ™å†å¾€å‰ä¸€ä¸ª
            val targetTab = chatTabLayout.getTabAt(previousPosition)
            if (targetTab?.text?.toString() == "+") {
                previousPosition = if (previousPosition > 0) previousPosition - 1 else tabCount - 2
            }

            // åˆ‡æ¢åˆ°ç›®æ ‡æ ‡ç­¾
            if (previousPosition >= 0 && previousPosition < tabCount) {
                val finalTargetTab = chatTabLayout.getTabAt(previousPosition)
                finalTargetTab?.select()
                val tabName = finalTargetTab?.text?.toString()
                Log.d(TAG, "âœ… åˆ‡æ¢åˆ°ä¸Šä¸€ä¸ªå¯¹è¯æ ‡ç­¾: $previousPosition ($tabName)")
                return tabName
            }
        } catch (e: Exception) {
            Log.e(TAG, "âŒ åˆ‡æ¢åˆ°ä¸Šä¸€ä¸ªå¯¹è¯æ ‡ç­¾å¤±è´¥", e)
        }
        return null
    }

    /**
     * åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªå¯¹è¯æ ‡ç­¾
     * @return ç›®æ ‡æ ‡ç­¾çš„åç§°
     */
    private fun switchToNextChatTab(): String? {
        try {
            val chatTabLayout = findViewById<com.google.android.material.tabs.TabLayout>(R.id.chat_tab_layout)
            if (chatTabLayout == null) {
                Log.w(TAG, "å¯¹è¯TabLayoutæœªæ‰¾åˆ°")
                return null
            }

            val currentPosition = chatTabLayout.selectedTabPosition
            val tabCount = chatTabLayout.tabCount

            if (tabCount <= 1) {
                Log.d(TAG, "åªæœ‰ä¸€ä¸ªæ ‡ç­¾ï¼Œæ— æ³•åˆ‡æ¢")
                return null
            }

            // è®¡ç®—ä¸‹ä¸€ä¸ªæ ‡ç­¾ä½ç½®ï¼ˆè·³è¿‡"+"æŒ‰é’®ï¼‰
            var nextPosition = currentPosition + 1

            // æ£€æŸ¥æ˜¯å¦åˆ°è¾¾"+"æŒ‰é’®æˆ–è¶…å‡ºèŒƒå›´
            if (nextPosition >= tabCount - 1) { // æœ€åä¸€ä¸ªæ˜¯"+"æŒ‰é’®
                nextPosition = 0 // å›åˆ°ç¬¬ä¸€ä¸ªæ ‡ç­¾
            }

            // å†æ¬¡æ£€æŸ¥ç›®æ ‡æ ‡ç­¾æ˜¯å¦æ˜¯"+"æŒ‰é’®
            val targetTab = chatTabLayout.getTabAt(nextPosition)
            if (targetTab?.text?.toString() == "+") {
                nextPosition = 0 // å¦‚æœé‡åˆ°"+"æŒ‰é’®ï¼Œå›åˆ°ç¬¬ä¸€ä¸ªæ ‡ç­¾
            }

            // åˆ‡æ¢åˆ°ç›®æ ‡æ ‡ç­¾
            if (nextPosition >= 0 && nextPosition < tabCount) {
                val finalTargetTab = chatTabLayout.getTabAt(nextPosition)
                finalTargetTab?.select()
                val tabName = finalTargetTab?.text?.toString()
                Log.d(TAG, "âœ… åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªå¯¹è¯æ ‡ç­¾: $nextPosition ($tabName)")
                return tabName
            }
        } catch (e: Exception) {
            Log.e(TAG, "âŒ åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªå¯¹è¯æ ‡ç­¾å¤±è´¥", e)
        }
        return null
    }

    /**
     * åˆ›å»ºå¯¹è¯tabæ¨ªæ»‘æŒ‡ç¤ºå™¨
     */
    private fun createChatTabSwipeIndicator() {
        try {
            // åˆ›å»ºæŒ‡ç¤ºå™¨å®¹å™¨
            val indicatorContainer = LinearLayout(this).apply {
                orientation = LinearLayout.HORIZONTAL
                gravity = android.view.Gravity.CENTER
                setPadding(16, 8, 16, 8)
            }

            // åˆ›å»ºå·¦ç®­å¤´
            val leftArrow = TextView(this).apply {
                text = "â—€"
                textSize = 16f
                setTextColor(android.graphics.Color.WHITE)
                alpha = 0.8f
            }

            // åˆ›å»ºä¸­é—´æç¤ºæ–‡å­—
            val hintText = TextView(this).apply {
                text = "å·¦å³æ»‘åŠ¨åˆ‡æ¢æ ‡ç­¾"
                textSize = 14f
                setTextColor(android.graphics.Color.WHITE)
                alpha = 0.9f
                setPadding(20, 0, 20, 0)
            }

            // åˆ›å»ºå³ç®­å¤´
            val rightArrow = TextView(this).apply {
                text = "â–¶"
                textSize = 16f
                setTextColor(android.graphics.Color.WHITE)
                alpha = 0.8f
            }

            // æ·»åŠ åˆ°å®¹å™¨
            indicatorContainer.addView(leftArrow)
            indicatorContainer.addView(hintText)
            indicatorContainer.addView(rightArrow)

            // åˆ›å»ºæŒ‡ç¤ºå™¨èƒŒæ™¯
            chatTabSwipeIndicator = FrameLayout(this).apply {
                layoutParams = FrameLayout.LayoutParams(
                    FrameLayout.LayoutParams.WRAP_CONTENT,
                    FrameLayout.LayoutParams.WRAP_CONTENT
                ).apply {
                    gravity = android.view.Gravity.CENTER_HORIZONTAL or android.view.Gravity.TOP
                    topMargin = 200 // è·ç¦»é¡¶éƒ¨200dpï¼Œæ˜¾ç¤ºåœ¨å¯¹è¯tabåŒºåŸŸé™„è¿‘
                }

                background = android.graphics.drawable.GradientDrawable().apply {
                    setColor(android.graphics.Color.parseColor("#CC000000"))
                    cornerRadius = 24f
                }

                addView(indicatorContainer)
                visibility = View.GONE
            }

            // æ·»åŠ åˆ°ä¸»å¸ƒå±€
            val rootLayout = findViewById<FrameLayout>(android.R.id.content)
            rootLayout.addView(chatTabSwipeIndicator)

            Log.d(TAG, "å¯¹è¯tabæ¨ªæ»‘æŒ‡ç¤ºå™¨åˆ›å»ºå®Œæˆ")
        } catch (e: Exception) {
            Log.e(TAG, "åˆ›å»ºå¯¹è¯tabæ¨ªæ»‘æŒ‡ç¤ºå™¨å¤±è´¥", e)
        }
    }

    /**
     * æ˜¾ç¤ºå¯¹è¯tabæ¨ªæ»‘æŒ‡ç¤ºå™¨
     */
    private fun showChatTabSwipeIndicator(tabName: String = "å·¦å³æ»‘åŠ¨åˆ‡æ¢æ ‡ç­¾") {
        chatTabSwipeIndicator?.apply {
            // æ›´æ–°æç¤ºæ–‡å­— - æŸ¥æ‰¾LinearLayoutä¸­çš„TextView
            val frameLayout = this as FrameLayout
            val container = frameLayout.getChildAt(0) as? LinearLayout
            val hintText = container?.getChildAt(1) as? TextView // ä¸­é—´çš„æç¤ºæ–‡å­—

            // æ˜¾ç¤ºå½“å‰åˆ‡æ¢åˆ°çš„æ ‡ç­¾åç§°
            hintText?.text = if (tabName == "å·¦å³æ»‘åŠ¨åˆ‡æ¢æ ‡ç­¾") {
                tabName
            } else {
                "å½“å‰: $tabName"
            }

            visibility = View.VISIBLE
            alpha = 0f
            scaleX = 0.8f
            scaleY = 0.8f

            animate()
                .alpha(1f)
                .scaleX(1f)
                .scaleY(1f)
                .setDuration(200)
                .start()

            // 2ç§’åè‡ªåŠ¨éšè—
            postDelayed({
                hideChatTabSwipeIndicator()
            }, 2000)
        }
    }

    /**
     * éšè—å¯¹è¯tabæ¨ªæ»‘æŒ‡ç¤ºå™¨
     */
    private fun hideChatTabSwipeIndicator() {
        chatTabSwipeIndicator?.animate()
            ?.alpha(0f)
            ?.scaleX(0.8f)
            ?.scaleY(0.8f)
            ?.setDuration(200)
            ?.withEndAction {
                chatTabSwipeIndicator?.visibility = View.GONE
            }
            ?.start()
    }

    /**
     * æ˜¾ç¤ºé¡µé¢åˆ‡æ¢åŠ¨ç”»
     */
    private fun showPageSwitchAnimation(direction: String, currentPage: Int, totalPages: Int) {
        try {
            // åˆ›å»ºé¡µé¢åˆ‡æ¢æç¤º
            val switchHint = TextView(this).apply {
                text = "$direction ($currentPage/$totalPages)"
                textSize = 16f
                setTextColor(android.graphics.Color.WHITE)
                setPadding(30, 15, 30, 15)
                background = android.graphics.drawable.GradientDrawable().apply {
                    setColor(android.graphics.Color.parseColor("#DD000000"))
                    cornerRadius = 20f
                }
            }

            val switchIndicator = FrameLayout(this).apply {
                layoutParams = FrameLayout.LayoutParams(
                    FrameLayout.LayoutParams.WRAP_CONTENT,
                    FrameLayout.LayoutParams.WRAP_CONTENT
                ).apply {
                    gravity = android.view.Gravity.CENTER
                }
                addView(switchHint)
            }

            // æ·»åŠ åˆ°ä¸»å¸ƒå±€
            val rootLayout = findViewById<FrameLayout>(android.R.id.content)
            rootLayout.addView(switchIndicator)

            // æ˜¾ç¤ºåŠ¨ç”»
            switchIndicator.alpha = 0f
            switchIndicator.scaleX = 0.8f
            switchIndicator.scaleY = 0.8f

            switchIndicator.animate()
                .alpha(1f)
                .scaleX(1f)
                .scaleY(1f)
                .setDuration(200)
                .withEndAction {
                    // 1.5ç§’åéšè—
                    switchIndicator.postDelayed({
                        switchIndicator.animate()
                            .alpha(0f)
                            .scaleX(0.8f)
                            .scaleY(0.8f)
                            .setDuration(200)
                            .withEndAction {
                                rootLayout.removeView(switchIndicator)
                            }
                            .start()
                    }, 1500)
                }
                .start()

        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºé¡µé¢åˆ‡æ¢åŠ¨ç”»å¤±è´¥", e)
        }
    }

    // ==================== å¡ç‰‡é¢„è§ˆåŠŸèƒ½ ====================

    /**
     * è®¾ç½®é¡µé¢æ•°é‡æŒ‰é’®ï¼ˆæ˜¾ç¤ºæ•°å­—ï¼‰
     */
    private fun setupCardPreviewButtonIcon() {
        try {
            // è®¾ç½®æŒ‰é’®æç¤ºæ–‡å­—
            if (::browserBtnClose.isInitialized) {
                browserBtnClose.contentDescription = "é¡µé¢æ•°é‡"
            }
            
            // æ›´æ–°é¡µé¢æ•°é‡æ˜¾ç¤º
            updatePageCountDisplay()

            Log.d(TAG, "é¡µé¢æ•°é‡æŒ‰é’®è®¾ç½®å®Œæˆ")
        } catch (e: Exception) {
            Log.e(TAG, "è®¾ç½®é¡µé¢æ•°é‡æŒ‰é’®å¤±è´¥", e)
        }
    }

    /**
     * æ˜¾ç¤ºå¡ç‰‡é¢„è§ˆå¯¹è¯æ¡†
     */
    private fun showCardPreviewDialog() {
        Log.d(TAG, "=== æœç´¢tabå¡ç‰‡é¢„è§ˆæŒ‰é’®è¢«ç‚¹å‡» ===")
        try {
            // å…ˆå¼ºåˆ¶åŒæ­¥æ‰€æœ‰å¡ç‰‡ç³»ç»Ÿæ•°æ®
            syncAllCardSystems()

            // ä½¿ç”¨ç»Ÿä¸€çš„å¡ç‰‡æ•°æ®è·å–æ–¹æ³•
            val allCards = getAllUnifiedCards()
            val totalPages = allCards.size

            Log.d(TAG, "æœç´¢tabå¡ç‰‡é¢„è§ˆ - ç»Ÿä¸€æ•°æ®æºå¡ç‰‡æ•°é‡: $totalPages")

            if (totalPages == 0) {
                Log.w(TAG, "æ²¡æœ‰æ‰¾åˆ°ä»»ä½•å¡ç‰‡")
                Toast.makeText(this, "æ²¡æœ‰æ‰“å¼€çš„é¡µé¢", Toast.LENGTH_SHORT).show()
                return
            }

            // æ¿€æ´»æœç´¢tabé¦–é¡µçš„å¡ç‰‡é¢„è§ˆçª—å£
            activateSearchTabCardPreview()

            Log.d(TAG, "âœ… æ¿€æ´»æœç´¢tabå¡ç‰‡é¢„è§ˆçª—å£ï¼Œå…± $totalPages ä¸ªé¡µé¢")
        } catch (e: Exception) {
            Log.e(TAG, "æ¿€æ´»æœç´¢tabå¡ç‰‡é¢„è§ˆçª—å£å¤±è´¥", e)
            // é™çº§åˆ°ç®€å•é¢„è§ˆ
            showSimpleCardPreviewDialog()
        }
    }

    /**
     * æ¿€æ´»æœç´¢tabé¦–é¡µçš„å¡ç‰‡é¢„è§ˆçª—å£
     */
    private fun activateSearchTabCardPreview() {
        try {
            Log.d(TAG, "æ¿€æ´»æœç´¢tabå¡ç‰‡é¢„è§ˆçª—å£")
            // ç›´æ¥è°ƒç”¨ç°æœ‰çš„showCardPreviewæ–¹æ³•
            showCardPreview()
        } catch (e: Exception) {
            Log.e(TAG, "æ¿€æ´»æœç´¢tabå¡ç‰‡é¢„è§ˆçª—å£å¤±è´¥", e)
            // å¦‚æœé¢„è§ˆæ¨¡å¼ä¸å¯ç”¨ï¼Œæ˜¾ç¤ºç®€å•å¯¹è¯æ¡†
            showSimpleCardPreviewDialog()
        }
    }

    /**
     * æ¿€æ´»å±‚å å¡ç‰‡é¢„è§ˆï¼ˆé•¿æŒ‰æœç´¢tabè§¦å‘ï¼‰
     */
    private fun activateStackedCardPreview() {
        try {
            // æ£€æŸ¥ActivityçŠ¶æ€
            if (isFinishing || isDestroyed) {
                Log.w(TAG, "Activityæ­£åœ¨é”€æ¯ï¼Œè·³è¿‡å±‚å å¡ç‰‡é¢„è§ˆæ¿€æ´»")
                return
            }

            Log.d(TAG, "ğŸ¯ æœç´¢tabæ¿€æ´»å±‚å å¡ç‰‡é¢„è§ˆ")

            // ç¡®ä¿çº¸å †WebViewç®¡ç†å™¨å·²åˆå§‹åŒ–
            if (paperStackWebViewManager == null) {
                Log.d(TAG, "çº¸å †WebViewç®¡ç†å™¨æœªåˆå§‹åŒ–ï¼Œé‡æ–°åˆå§‹åŒ–")
                setupBrowserWebView()
            }

            // å¦‚æœçº¸å †æ ˆä¸ºç©ºï¼Œè‡ªåŠ¨åˆ›å»ºåŠŸèƒ½ä¸»é¡µå¡ç‰‡
            val tabCount = paperStackWebViewManager?.getTabCount() ?: 0
            if (tabCount == 0) {
                Log.d(TAG, "çº¸å †æ ˆä¸ºç©ºï¼Œè‡ªåŠ¨åˆ›å»ºåŠŸèƒ½ä¸»é¡µå¡ç‰‡")
                
                // åˆ›å»ºåŠŸèƒ½ä¸»é¡µå¡ç‰‡ï¼ˆä½¿ç”¨ç‰¹æ®ŠURLæ ‡è¯†ï¼Œä¸èƒ½è¢«å…³é—­ï¼‰
                val functionalHomeUrl = "home://functional"
                
                // åˆ›å»ºåŠŸèƒ½ä¸»é¡µæ ‡ç­¾é¡µ
                val functionalTab = paperStackWebViewManager?.addTab(
                    url = functionalHomeUrl,
                    title = "ä¸»é¡µ"
                )
                
                // ç­‰å¾…æ ‡ç­¾é¡µåˆ›å»ºå®Œæˆåå†ç»§ç»­
                handler.postDelayed({
                    // é‡æ–°è·å–å¡ç‰‡æ•°æ®
                    val allCards = getStackedCardPreviewCards()
                    if (allCards.isEmpty()) {
                        Toast.makeText(this, "åˆ›å»ºåŠŸèƒ½ä¸»é¡µå¡ç‰‡å¤±è´¥", Toast.LENGTH_SHORT).show()
                        return@postDelayed
                    }
                    proceedWithActivateStackedCardPreview(allCards)
                }, 300) // å»¶è¿Ÿ300msï¼Œç­‰å¾…æ ‡ç­¾é¡µåˆ›å»ºå®Œæˆ
                return
            }

            // ä½¿ç”¨StackedCardPreviewä¸“ç”¨çš„å¡ç‰‡æ•°æ®è·å–æ–¹æ³•ï¼Œæ’é™¤è‡ªåŠ¨åˆ›å»ºçš„baidué¦–é¡µ
            val allCards = getStackedCardPreviewCards()

            Log.d(TAG, "ğŸ“Š æœç´¢tabæ¿€æ´»å±‚å å¡ç‰‡é¢„è§ˆ - æ€»è®¡: ${allCards.size}")

            // è¯¦ç»†æ—¥å¿—ï¼šæ˜¾ç¤ºæ¯å¼ å¡ç‰‡çš„ä¿¡æ¯
            allCards.forEachIndexed { index, card ->
                Log.d(TAG, "  å¡ç‰‡ $index: ${card.title} - ${card.url}")
            }

            if (allCards.isEmpty()) {
                Toast.makeText(this, "æ²¡æœ‰æ‰“å¼€çš„ç½‘é¡µå¡ç‰‡", Toast.LENGTH_SHORT).show()
                return
            }
            
            proceedWithActivateStackedCardPreview(allCards)
        } catch (e: Exception) {
            Log.e(TAG, "æ¿€æ´»å±‚å å¡ç‰‡é¢„è§ˆå¤±è´¥", e)
            Toast.makeText(this, "æ¿€æ´»å¡ç‰‡é¢„è§ˆå¤±è´¥", Toast.LENGTH_SHORT).show()
        }
    }
    
    /**
     * ç»§ç»­æ¿€æ´»å±‚å å¡ç‰‡é¢„è§ˆï¼ˆå†…éƒ¨æ–¹æ³•ï¼Œç”¨äºå¤„ç†å¡ç‰‡æ•°æ®ï¼‰
     */
    private fun proceedWithActivateStackedCardPreview(allCards: List<GestureCardWebViewManager.WebViewCardData>) {
        try {
            // æ˜¾ç¤ºå±‚å å¡ç‰‡é¢„è§ˆ
            stackedCardPreview?.apply {
                // ç¡®ä¿é‡ç½®ä¸ºå±‚å æ¨¡å¼ï¼ˆä¸æ˜¯æ‚¬æµ®æ¨¡å¼ï¼Œä¼šè‡ªåŠ¨æ¿€æ´»å››ä¸ªæŒ‰é’®ï¼‰
                resetToStackedMode()

                // ç›´æ¥è®¾ç½®å¡ç‰‡æ•°æ®ï¼Œè€Œä¸æ˜¯è°ƒç”¨updateWaveTrackerCards
                val stackedCardDataList = allCards.map { cardData ->
                    com.example.aifloatingball.views.StackedCardPreview.WebViewCardData(
                        title = cardData.title ?: "æ— æ ‡é¢˜",
                        url = cardData.url ?: "",
                        favicon = null,
                        screenshot = cardData.screenshot ?: cardData.webView?.let { webView ->
                            // ğŸ”§ ä¿®å¤4ï¼šä¼˜å…ˆä½¿ç”¨ä¿å­˜çš„æˆªå›¾ï¼Œå¦‚æœæ²¡æœ‰åˆ™å°è¯•è·å–WebViewæˆªå›¾
                            try {
                                val bitmap = Bitmap.createBitmap(
                                    webView.width,
                                    webView.height,
                                    Bitmap.Config.ARGB_8888
                                )
                                val canvas = Canvas(bitmap)
                                webView.draw(canvas)
                                bitmap
                            } catch (e: Exception) {
                                Log.w(TAG, "è·å–WebViewæˆªå›¾å¤±è´¥", e)
                                null
                            }
                        }
                    )
                }
                
                // è®¾ç½®å¡ç‰‡æ•°æ®
                setWebViewCards(stackedCardDataList)

                // å¯ç”¨å±‚å é¢„è§ˆæ¨¡å¼çš„äº¤äº’
                enableStackedInteraction()

                // æ˜¾ç¤ºé¢„è§ˆå™¨
                visibility = View.VISIBLE
                
                // ğŸ”§ æ–°åŠŸèƒ½ï¼šæ·»åŠ ç‚¹å‡»å¤–éƒ¨åŒºåŸŸé€€å‡ºé¢„è§ˆçª—å£çš„åŠŸèƒ½
                setupStackedCardPreviewOutsideClick()

                Log.d(TAG, "âœ… å±‚å å¡ç‰‡é¢„è§ˆå·²æ¿€æ´»ï¼Œæ˜¾ç¤º ${allCards.size} å¼ å¡ç‰‡ï¼Œäº¤äº’å·²å¯ç”¨")
            }

            // ç¡®ä¿æœç´¢tabä¿æŒé€‰ä¸­çŠ¶æ€ï¼ˆç»¿è‰²ä¸»é¢˜ï¼‰
            updateTabColors()

        } catch (e: Exception) {
            Log.e(TAG, "æ¿€æ´»å±‚å å¡ç‰‡é¢„è§ˆå¤±è´¥", e)
            Toast.makeText(this, "æ¿€æ´»å¡ç‰‡é¢„è§ˆå¤±è´¥", Toast.LENGTH_SHORT).show()
        }
    }

    /**
     * å¤„ç†å±‚å å¡ç‰‡é¢„è§ˆçš„è§¦æ‘¸äº‹ä»¶
     */
    private fun handleStackedCardPreviewTouch(event: MotionEvent) {
        try {
            stackedCardPreview?.let { preview ->
                // å°†è§¦æ‘¸åæ ‡è½¬æ¢ä¸ºå±‚å å¡ç‰‡é¢„è§ˆå™¨çš„åæ ‡ç³»
                val location = IntArray(2)
                browserWebViewContainer.getLocationOnScreen(location)
                val previewLocation = IntArray(2)
                preview.getLocationOnScreen(previewLocation)

                val relativeX = location[0] - previewLocation[0] + event.x
                val relativeY = location[1] - previewLocation[1] + event.y

                when (event.action) {
                    MotionEvent.ACTION_DOWN -> {
                        Log.d(TAG, "å±‚å é¢„è§ˆ - æ‰‹æŒ‡æŒ‰ä¸‹: ($relativeX, $relativeY)")
                        // æ›´æ–°æ‰‹æŒ‡ä½ç½®ï¼Œå¼€å§‹æ‚¬åœæ£€æµ‹
                        preview.updateFingerPosition(relativeX, relativeY)
                    }

                    MotionEvent.ACTION_MOVE -> {
                        Log.d(TAG, "å±‚å é¢„è§ˆ - æ‰‹æŒ‡ç§»åŠ¨: ($relativeX, $relativeY)")
                        // ç»§ç»­æ›´æ–°æ‰‹æŒ‡ä½ç½®ï¼Œå®æ—¶æ‚¬åœæ£€æµ‹
                        preview.updateFingerPosition(relativeX, relativeY)
                    }

                    MotionEvent.ACTION_UP, MotionEvent.ACTION_CANCEL -> {
                        Log.d(TAG, "å±‚å é¢„è§ˆ - æ‰‹æŒ‡æŠ¬èµ·ï¼Œè¿›å…¥æ‚¬æµ®æ¨¡å¼")
                        // æ‰‹æŒ‡æŠ¬èµ·ï¼Œåœæ­¢é¢„è§ˆå¹¶è¿›å…¥æ‚¬æµ®æ¨¡å¼
                        preview.stopWave()
                    }
                }
            }
        } catch (e: Exception) {
            Log.e(TAG, "å¤„ç†å±‚å å¡ç‰‡é¢„è§ˆè§¦æ‘¸äº‹ä»¶å¤±è´¥", e)
        }
    }

    /**
     * æµ‹è¯•æœç´¢tabé•¿æŒ‰æ¿€æ´»å±‚å å¡ç‰‡åŠŸèƒ½
     */
    private fun testSearchTabLongPressStackedCards() {
        try {
            Log.d(TAG, "æµ‹è¯•æœç´¢tabé•¿æŒ‰æ¿€æ´»å±‚å å¡ç‰‡åŠŸèƒ½")

            // æ£€æŸ¥æ˜¯å¦åœ¨æœç´¢tab
            if (getCurrentTabIndex() != 1) {
                Toast.makeText(this, "è¯·å…ˆåˆ‡æ¢åˆ°æœç´¢tab", Toast.LENGTH_SHORT).show()
                return
            }

            // æ£€æŸ¥æ˜¯å¦æœ‰webviewå¡ç‰‡
            gestureCardWebViewManager?.let { manager ->
                val allCards = manager.getAllCards()
                if (allCards.isEmpty()) {
                    Toast.makeText(this, "è¯·å…ˆæ‰“å¼€ä¸€äº›ç½‘é¡µï¼Œç„¶åå†æµ‹è¯•", Toast.LENGTH_SHORT).show()
                    return
                }

                Log.d(TAG, "æ‰¾åˆ° ${allCards.size} ä¸ªwebviewå¡ç‰‡")

                // æ¨¡æ‹Ÿé•¿æŒ‰æ¿€æ´»
                activateStackedCardPreview()

                // å»æ‰æ¿€æ´»æç¤ºå¼¹çª—

            } ?: run {
                // å»æ‰é”™è¯¯æç¤º
            }

        } catch (e: Exception) {
            Log.e(TAG, "æµ‹è¯•æœç´¢tabé•¿æŒ‰åŠŸèƒ½å¤±è´¥", e)
            Toast.makeText(this, "æµ‹è¯•å¤±è´¥: ${e.message}", Toast.LENGTH_SHORT).show()
        }
    }

    /**
     * æµ‹è¯•æ–°çš„æ‰‹åŠ¿æœºåˆ¶
     */
    private fun testNewGestureMechanism() {
        try {
            Log.d(TAG, "ğŸ§ª å¼€å§‹æµ‹è¯•æ–°çš„æ‰‹åŠ¿æœºåˆ¶")

            val message = StringBuilder()
            message.append("ğŸ¯ æ–°æ‰‹åŠ¿æœºåˆ¶æµ‹è¯•è¯´æ˜ï¼š\n\n")
            message.append("1ï¸âƒ£ é•¿æŒ‰æœç´¢tabå›¾æ ‡ â†’ æ¿€æ´»/é€€å‡ºé®ç½©å±‚\n")
            message.append("2ï¸âƒ£ é®ç½©å±‚ä¸­å•å‡»æœç´¢tab â†’ æ¿€æ´»å¤šå¡ç‰‡ç³»ç»Ÿ\n")
            message.append("3ï¸âƒ£ é®ç½©å±‚ä¸­å•å‡»å…¶ä»–tab â†’ é€€å‡ºé®ç½©å±‚å¹¶åˆ‡æ¢é¡µé¢\n")
            message.append("4ï¸âƒ£ é®ç½©å±‚ä¸­å·¦å³æ»‘åŠ¨ â†’ å‰è¿›/åé€€\n")
            message.append("5ï¸âƒ£ é®ç½©å±‚ä¸­åŒå‡» â†’ å…³é—­å½“å‰é¡µé¢\n\n")

            // æ£€æŸ¥å½“å‰çŠ¶æ€
            if (isSearchTabGestureOverlayActive) {
                message.append("âœ… é®ç½©å±‚å·²æ¿€æ´»\n")
                message.append("ğŸ’¡ ç°åœ¨å¯ä»¥æµ‹è¯•é®ç½©å±‚å†…çš„æ‰‹åŠ¿æ“ä½œ")
            } else {
                message.append("âš ï¸ é®ç½©å±‚æœªæ¿€æ´»\n")
                message.append("ğŸ’¡ è¯·é•¿æŒ‰æœç´¢tabæ¿€æ´»é®ç½©å±‚")
            }

            // æ£€æŸ¥ç½‘é¡µå¡ç‰‡æ•°é‡
            val cardCount = gestureCardWebViewManager?.getAllCards()?.size ?: 0
            message.append("\nğŸ“Š å½“å‰ç½‘é¡µå¡ç‰‡æ•°é‡: $cardCount")

            if (cardCount == 0) {
                message.append("\nğŸ’¡ å»ºè®®å…ˆæ‰“å¼€ä¸€äº›ç½‘é¡µè¿›è¡Œæµ‹è¯•")
            }

            AlertDialog.Builder(this)
                .setTitle("ğŸ§ª æ–°æ‰‹åŠ¿æœºåˆ¶æµ‹è¯•")
                .setMessage(message.toString())
                .setPositiveButton("æµ‹è¯•é•¿æŒ‰æ¿€æ´»") { _, _ ->
                    // æç¤ºç”¨æˆ·é•¿æŒ‰æœç´¢tab
                    Toast.makeText(this, "è¯·é•¿æŒ‰æœç´¢tabå›¾æ ‡æ¥æ¿€æ´»/é€€å‡ºé®ç½©å±‚", Toast.LENGTH_LONG).show()
                }
                .setNeutralButton("è‡ªåŠ¨æ¿€æ´»") { _, _ ->
                    // å¦‚æœé®ç½©å±‚æœªæ¿€æ´»ï¼Œè‡ªåŠ¨æ¿€æ´»
                    if (!isSearchTabGestureOverlayActive) {
                        activateSearchTabGestureOverlay()
                    } else {
                        Toast.makeText(this, "é®ç½©å±‚å·²æ¿€æ´»ï¼Œè¯·æµ‹è¯•æ‰‹åŠ¿æ“ä½œ", Toast.LENGTH_LONG).show()
                    }
                }
                .setNegativeButton("å–æ¶ˆ", null)
                .show()

            Log.d(TAG, "æ–°æ‰‹åŠ¿æœºåˆ¶æµ‹è¯•å¯¹è¯æ¡†å·²æ˜¾ç¤º")

        } catch (e: Exception) {
            Log.e(TAG, "æµ‹è¯•æ–°æ‰‹åŠ¿æœºåˆ¶å¤±è´¥", e)
            Toast.makeText(this, "æµ‹è¯•å¤±è´¥: ${e.message}", Toast.LENGTH_SHORT).show()
        }
    }

    /**
     * è°ƒè¯•ï¼šå¼ºåˆ¶æ˜¾ç¤ºå±‚å å¡ç‰‡é¢„è§ˆ
     */
    private fun debugShowStackedCards() {
        try {
            Log.d(TAG, "è°ƒè¯•ï¼šå¼ºåˆ¶æ˜¾ç¤ºå±‚å å¡ç‰‡é¢„è§ˆ")

            gestureCardWebViewManager?.let { manager ->
                val allCards = manager.getAllCards()
                Log.d(TAG, "è°ƒè¯•ï¼šæ‰¾åˆ° ${allCards.size} ä¸ªwebviewå¡ç‰‡")

                if (allCards.isEmpty()) {
                    // å¦‚æœæ²¡æœ‰å¡ç‰‡ï¼Œåˆ›å»ºä¸€äº›æµ‹è¯•å¡ç‰‡
                    Log.d(TAG, "è°ƒè¯•ï¼šæ²¡æœ‰å¡ç‰‡ï¼Œåˆ›å»ºæµ‹è¯•æ•°æ®")
                    val testCards = listOf(
                        com.example.aifloatingball.views.StackedCardPreview.WebViewCardData(
                            title = "æµ‹è¯•å¡ç‰‡1",
                            url = "https://m.baidu.com",
                            favicon = null,
                            screenshot = null
                        ),
                        com.example.aifloatingball.views.StackedCardPreview.WebViewCardData(
                            title = "æµ‹è¯•å¡ç‰‡2",
                            url = "https://www.google.com",
                            favicon = null,
                            screenshot = null
                        ),
                        com.example.aifloatingball.views.StackedCardPreview.WebViewCardData(
                            title = "æµ‹è¯•å¡ç‰‡3",
                            url = "https://www.github.com",
                            favicon = null,
                            screenshot = null
                        )
                    )

                    stackedCardPreview?.apply {
                        resetToStackedMode()
                        setWebViewCards(testCards)
                        enableStackedInteraction()
                        visibility = View.VISIBLE
                    }

                    Toast.makeText(this, "è°ƒè¯•ï¼šå·²æ˜¾ç¤º3å¼ æµ‹è¯•å¡ç‰‡", Toast.LENGTH_LONG).show()
                } else {
                    // ä½¿ç”¨çœŸå®å¡ç‰‡
                    activateStackedCardPreview()
                }
            }
        } catch (e: Exception) {
            Log.e(TAG, "è°ƒè¯•æ˜¾ç¤ºå±‚å å¡ç‰‡å¤±è´¥", e)
            Toast.makeText(this, "è°ƒè¯•å¤±è´¥: ${e.message}", Toast.LENGTH_SHORT).show()
        }
    }

    /**
     * æ˜¾ç¤ºç®€å•çš„å¡ç‰‡é¢„è§ˆå¯¹è¯æ¡†ï¼ˆé™çº§æ–¹æ¡ˆï¼‰
     */
    private fun showSimpleCardPreviewDialog() {
        try {
            Log.d(TAG, "=== æ˜¾ç¤ºç®€å•å¡ç‰‡é¢„è§ˆå¯¹è¯æ¡† ===")

            // ä½¿ç”¨ç»Ÿä¸€çš„å¡ç‰‡æ•°æ®è·å–æ–¹æ³•
            val allCards = getAllUnifiedCards()
            val totalPages = allCards.size

            Log.d(TAG, "ç®€å•å¡ç‰‡é¢„è§ˆ - ç»Ÿä¸€æ•°æ®æºå¡ç‰‡æ•°é‡: $totalPages")

            if (totalPages == 0) {
                Toast.makeText(this, "æ²¡æœ‰æ‰“å¼€çš„é¡µé¢", Toast.LENGTH_SHORT).show()
                return
            }

            // è·å–å½“å‰å¡ç‰‡ç´¢å¼•
            val currentCard = gestureCardWebViewManager?.getCurrentCard() ?: mobileCardManager?.getCurrentCard()
            val currentIndex = if (currentCard != null) {
                allCards.indexOfFirst { it.id == currentCard.id }
            } else {
                0
            }

            // è·å–æ‰€æœ‰é¡µé¢ä¿¡æ¯
            val pageItems = mutableListOf<String>()
            for (i in allCards.indices) {
                val card = allCards[i]
                val title = card.title ?: card.webView?.title ?: "é¡µé¢ ${i + 1}"
                val url = card.url ?: card.webView?.url ?: "æœªçŸ¥åœ°å€"
                val status = if (i == currentIndex) " [å½“å‰]" else ""
                pageItems.add("${i + 1}. $title$status\n$url")
                Log.d(TAG, "å¡ç‰‡[$i]: $title - $url")
            }

            // åˆ›å»ºé€‰æ‹©å¯¹è¯æ¡†
            AlertDialog.Builder(this, R.style.Theme_MaterialDialog)
                .setTitle("é¡µé¢å¡ç‰‡é¢„è§ˆ ($totalPages ä¸ªé¡µé¢)")
                .setItems(pageItems.toTypedArray()) { _, which ->
                    // åˆ‡æ¢åˆ°é€‰ä¸­çš„é¡µé¢
                    try {
                        // ä¼˜å…ˆä½¿ç”¨æ‰‹åŠ¿ç®¡ç†å™¨ï¼Œå¦‚æœå¤±è´¥åˆ™ä½¿ç”¨æ‰‹æœºç®¡ç†å™¨
                        var switched = false
                        if (gestureCardWebViewManager != null) {
                            gestureCardWebViewManager?.switchToCard(which)
                            switched = true
                            Log.d(TAG, "ä½¿ç”¨æ‰‹åŠ¿ç®¡ç†å™¨åˆ‡æ¢åˆ°å¡ç‰‡: $which")
                        } else if (mobileCardManager != null) {
                            mobileCardManager?.switchToCard(which)
                            switched = true
                            Log.d(TAG, "ä½¿ç”¨æ‰‹æœºç®¡ç†å™¨åˆ‡æ¢åˆ°å¡ç‰‡: $which")
                        }

                        if (switched) {
                            showPageSwitchAnimation("åˆ‡æ¢åˆ°", which + 1, totalPages)
                        } else {
                            Toast.makeText(this@SimpleModeActivity, "åˆ‡æ¢å¤±è´¥", Toast.LENGTH_SHORT).show()
                        }
                    } catch (e: Exception) {
                        Log.e(TAG, "åˆ‡æ¢å¡ç‰‡å¤±è´¥", e)
                        Toast.makeText(this@SimpleModeActivity, "åˆ‡æ¢å¤±è´¥", Toast.LENGTH_SHORT).show()
                    }
                }
                .setNegativeButton("å…³é—­", null)
                .show()

            Log.d(TAG, "âœ… æ˜¾ç¤ºç®€å•å¡ç‰‡é¢„è§ˆå¯¹è¯æ¡†ï¼Œå…± $totalPages ä¸ªé¡µé¢")
        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºç®€å•å¡ç‰‡é¢„è§ˆå¯¹è¯æ¡†å¤±è´¥", e)
            Toast.makeText(this, "æ— æ³•æ˜¾ç¤ºé¡µé¢é¢„è§ˆ", Toast.LENGTH_SHORT).show()
        }
    }

    /**
     * å¡ç‰‡é¢„è§ˆé€‚é…å™¨ï¼ˆç®€åŒ–ç‰ˆï¼Œä¸å†ä½¿ç”¨ï¼‰
     */
    private inner class CardPreviewAdapter(
        private val manager: GestureCardWebViewManager,
        private val currentIndex: Int,
        private val onItemClick: (Int) -> Unit
    ) : androidx.recyclerview.widget.RecyclerView.Adapter<CardPreviewAdapter.ViewHolder>() {

        inner class ViewHolder(view: View) : androidx.recyclerview.widget.RecyclerView.ViewHolder(view) {
            // ä½¿ç”¨ç³»ç»Ÿå¸ƒå±€ï¼Œä¸éœ€è¦è‡ªå®šä¹‰å­—æ®µ
        }

        override fun onCreateViewHolder(parent: ViewGroup, viewType: Int): ViewHolder {
            // åˆ›å»ºç®€å•çš„å¡ç‰‡é¡¹å¸ƒå±€
            val view = LayoutInflater.from(parent.context).inflate(
                android.R.layout.simple_list_item_2, parent, false
            )
            return ViewHolder(view)
        }

        override fun onBindViewHolder(holder: ViewHolder, position: Int) {
            try {
                val allCards = manager.getAllCards()
                val card = allCards.getOrNull(position)
                val title = card?.webView?.title ?: "é¡µé¢ ${position + 1}"
                val url = card?.webView?.url ?: "æœªçŸ¥åœ°å€"

                // ä½¿ç”¨ç³»ç»Ÿå¸ƒå±€çš„æ–‡æœ¬è§†å›¾
                val text1 = holder.itemView.findViewById<TextView>(android.R.id.text1)
                val text2 = holder.itemView.findViewById<TextView>(android.R.id.text2)

                text1?.text = "${position + 1}. $title${if (position == currentIndex) " [å½“å‰]" else ""}"
                text2?.text = url

                // è®¾ç½®å½“å‰é¡µé¢çš„èƒŒæ™¯è‰²
                if (position == currentIndex) {
                    holder.itemView.setBackgroundColor(
                        ContextCompat.getColor(this@SimpleModeActivity, R.color.simple_mode_accent_light)
                    )
                    text1?.setTextColor(android.graphics.Color.WHITE)
                    text2?.setTextColor(android.graphics.Color.WHITE)
                } else {
                    holder.itemView.setBackgroundColor(android.graphics.Color.TRANSPARENT)
                    text1?.setTextColor(ContextCompat.getColor(this@SimpleModeActivity, R.color.simple_mode_text_primary_light))
                    text2?.setTextColor(ContextCompat.getColor(this@SimpleModeActivity, R.color.simple_mode_text_secondary_light))
                }

                // è®¾ç½®ç‚¹å‡»ç›‘å¬
                holder.itemView.setOnClickListener {
                    onItemClick(position)
                }
            } catch (e: Exception) {
                Log.e(TAG, "ç»‘å®šå¡ç‰‡é¢„è§ˆé¡¹å¤±è´¥", e)
            }
        }

        override fun getItemCount(): Int = manager.getAllCards().size
    }
    
    // ==================== GroupChatDataChangeListener å®ç° ====================
    
    override fun onGroupChatCreated(groupChat: GroupChat) {
        try {
            Log.d(TAG, "æ”¶åˆ°ç¾¤èŠåˆ›å»ºäº‹ä»¶: ${groupChat.name}")
            
            // åœ¨ä¸»çº¿ç¨‹ä¸­å¤„ç†UIæ›´æ–°
            runOnUiThread {
                refreshCurrentTabDisplay()
            }
        } catch (e: Exception) {
            Log.e(TAG, "å¤„ç†ç¾¤èŠåˆ›å»ºäº‹ä»¶å¤±è´¥", e)
        }
    }
    
    override fun onGroupChatDeleted(groupId: String) {
        try {
            Log.d(TAG, "æ”¶åˆ°ç¾¤èŠåˆ é™¤äº‹ä»¶: $groupId")
            
            // åœ¨ä¸»çº¿ç¨‹ä¸­å¤„ç†UIæ›´æ–°
            runOnUiThread {
                refreshCurrentTabDisplay()
            }
        } catch (e: Exception) {
            Log.e(TAG, "å¤„ç†ç¾¤èŠåˆ é™¤äº‹ä»¶å¤±è´¥", e)
        }
    }
    
    override fun onGroupChatUpdated(groupChat: GroupChat) {
        try {
            Log.d(TAG, "æ”¶åˆ°ç¾¤èŠæ›´æ–°äº‹ä»¶: ${groupChat.name}")
            
            // åœ¨ä¸»çº¿ç¨‹ä¸­å¤„ç†UIæ›´æ–°
            runOnUiThread {
                refreshCurrentTabDisplay()
            }
        } catch (e: Exception) {
            Log.e(TAG, "å¤„ç†ç¾¤èŠæ›´æ–°äº‹ä»¶å¤±è´¥", e)
        }
    }
    
    override fun onGroupChatsReloaded(groupChats: List<GroupChat>) {
        try {
            Log.d(TAG, "æ”¶åˆ°ç¾¤èŠé‡æ–°åŠ è½½äº‹ä»¶ï¼Œå…± ${groupChats.size} ä¸ªç¾¤èŠ")
            
            // åœ¨ä¸»çº¿ç¨‹ä¸­å¤„ç†UIæ›´æ–°
            runOnUiThread {
                refreshCurrentTabDisplay()
            }
        } catch (e: Exception) {
            Log.e(TAG, "å¤„ç†ç¾¤èŠé‡æ–°åŠ è½½äº‹ä»¶å¤±è´¥", e)
        }
    }
    
    /**
     * åˆ·æ–°å½“å‰æ ‡ç­¾é¡µæ˜¾ç¤º
     * åŸºäºäº‹ä»¶é©±åŠ¨æ¨¡å¼é‡æ„çš„åˆ·æ–°é€»è¾‘
     */
    private fun refreshCurrentTabDisplay() {
        try {
            val chatTabLayout = findViewById<com.google.android.material.tabs.TabLayout>(R.id.chat_tab_layout)
            val currentTab = chatTabLayout?.getTabAt(chatTabLayout.selectedTabPosition)
            val currentTabText = currentTab?.text?.toString()
            
            Log.d(TAG, "åˆ·æ–°å½“å‰æ ‡ç­¾é¡µæ˜¾ç¤º: $currentTabText")
            
            when (currentTabText) {
                "å…¨éƒ¨" -> {
                    showAllUserAIContacts()
                }
                "AIåŠ©æ‰‹" -> {
                    showAIAssistantGroup()
                }
                else -> {
                    if (currentTabText != null && currentTabText != "+") {
                        showCustomGroupContacts(currentTabText)
                    }
                }
            }
        } catch (e: Exception) {
            Log.e(TAG, "åˆ·æ–°å½“å‰æ ‡ç­¾é¡µæ˜¾ç¤ºå¤±è´¥", e)
        }
    }

    // ==================== æœç´¢tabæ‰‹åŠ¿é®ç½©åŒºåŠŸèƒ½ ====================

    /**
     * æ¿€æ´»æœç´¢tabæ‰‹åŠ¿é®ç½©åŒº
     * åœ¨æ•´ä¸ªtabåŒºåŸŸåˆ›å»ºä¸€ä¸ªæ¨¡ç³Šé®ç½©å±‚ï¼Œæ”¯æŒæ‰‹åŠ¿æ“ä½œå’Œç©¿é€ç‚¹å‡»
     */
    private fun activateSearchTabGestureOverlay() {
        try {
            // å¦‚æœå·²ç»æ¿€æ´»ï¼Œç›´æ¥è¿”å›
            if (isSearchTabGestureOverlayActive) {
                Log.d(TAG, "æœç´¢tabæ‰‹åŠ¿é®ç½©åŒºå·²æ¿€æ´»ï¼Œè·³è¿‡é‡å¤æ¿€æ´»")
                return
            }

            Log.d(TAG, "æ¿€æ´»æœç´¢tabæ‰‹åŠ¿é®ç½©åŒº")

            // æ¿€æ´»éœ‡åŠ¨åé¦ˆ
            performGestureVibration("heavy")

            // æ˜¾ç¤ºæ¿€æ´»æç¤º
            showMaterialToast("æ‰‹åŠ¿åŒºå·²æ¿€æ´»")

            // åªåœ¨é¦–æ¬¡å®‰è£…åç¬¬ä¸€æ¬¡æ¿€æ´»æ—¶æ˜¾ç¤ºè¯¦ç»†æ“ä½œè¯´æ˜
            val sharedPrefs = getSharedPreferences("app_settings", MODE_PRIVATE)
            val hasShownGuide = sharedPrefs.getBoolean(PREF_GESTURE_GUIDE_SHOWN, false)

            if (!hasShownGuide) {
                handler.postDelayed({
                    if (!isFinishing && !isDestroyed) {
                        showGestureInstructions()
                        // æ ‡è®°å·²æ˜¾ç¤ºè¿‡ï¼Œä»¥åä¸å†è‡ªåŠ¨æ˜¾ç¤º
                        sharedPrefs.edit().putBoolean(PREF_GESTURE_GUIDE_SHOWN, true).apply()
                    }
                }, 1500)
            }

            // è·å–åº•éƒ¨å¯¼èˆªæ å®¹å™¨
            val bottomNavigation = findViewById<LinearLayout>(R.id.bottom_navigation)
            if (bottomNavigation == null) {
                Log.e(TAG, "åº•éƒ¨å¯¼èˆªæ æœªæ‰¾åˆ°ï¼Œæ— æ³•åˆ›å»ºæ‰‹åŠ¿é®ç½©åŒº")
                return
            }

            // åˆ›å»ºæ‰‹åŠ¿æ£€æµ‹å™¨ - ç½‘é¡µæµè§ˆæ‰‹åŠ¿æ“ä½œ
            // åˆ›å»ºæ‰‹åŠ¿ç›‘å¬å™¨
            val gestureListener = object : GestureDetector.SimpleOnGestureListener(), GestureDetector.OnDoubleTapListener {
                override fun onDown(e: MotionEvent): Boolean {
                    // é‡ç½®æ‰‹åŠ¿çŠ¶æ€
                    isLongPressDetected = false
                    isDoubleTapDetected = false
                    Log.d(TAG, "æ‰‹åŠ¿å¼€å§‹: x=${e.x}, y=${e.y}")
                    return true // è¿”å›trueè¡¨ç¤ºæˆ‘ä»¬æƒ³è¦å¤„ç†åç»­äº‹ä»¶
                }

                override fun onFling(e1: MotionEvent?, e2: MotionEvent, velocityX: Float, velocityY: Float): Boolean {
                    Log.d(TAG, "æ£€æµ‹åˆ°æ»‘åŠ¨æ‰‹åŠ¿: velocityX=$velocityX, velocityY=$velocityY")
                    // å¦‚æœå·²ç»æ£€æµ‹åˆ°é•¿æŒ‰æˆ–åŒå‡»ï¼Œä¸å¤„ç†æ»‘åŠ¨
                    if (isLongPressDetected || isDoubleTapDetected) {
                        Log.d(TAG, "å·²æ£€æµ‹åˆ°å…¶ä»–æ‰‹åŠ¿ï¼Œè·³è¿‡æ»‘åŠ¨å¤„ç†")
                        return false
                    }
                    // ç½‘é¡µæµè§ˆæ‰‹åŠ¿æ“ä½œ
                    val handled = handleWebBrowsingGesture(e1, e2, velocityX, velocityY)
                    Log.d(TAG, "æ»‘åŠ¨æ‰‹åŠ¿å¤„ç†ç»“æœ: $handled")
                    return handled // åªæœ‰æˆåŠŸå¤„ç†æ—¶æ‰æ¶ˆè´¹äº‹ä»¶
                }

                override fun onLongPress(e: MotionEvent) {
                    Log.d(TAG, "æ£€æµ‹åˆ°é•¿æŒ‰æ‰‹åŠ¿ï¼Œä½†ä¸å¤„ç†ä»¥é¿å…ä¸æœç´¢tabé•¿æŒ‰å†²çª")
                    // ç§»é™¤é•¿æŒ‰åˆ·æ–°åŠŸèƒ½ï¼Œè®©é•¿æŒ‰äº‹ä»¶ç©¿é€åˆ°æœç´¢tabå¤„ç†é€€å‡ºæ“ä½œ
                    // è¿™æ ·ç”¨æˆ·å¯ä»¥é€šè¿‡é•¿æŒ‰æœç´¢tabæ¥é€€å‡ºé®ç½©å±‚
                    isLongPressDetected = false // ä¸æ ‡è®°ä¸ºå·²å¤„ç†ï¼Œè®©äº‹ä»¶ç©¿é€
                }

                override fun onDoubleTap(e: MotionEvent): Boolean {
                    Log.d(TAG, "æ£€æµ‹åˆ°åŒå‡»æ‰‹åŠ¿")
                    isDoubleTapDetected = true
                    // åŒå‡»æ‰‹åŠ¿ - å…³é—­å½“å‰é¡µé¢
                    handleDoubleTapGesture(e)
                    return true // æ¶ˆè´¹åŒå‡»äº‹ä»¶
                }

                override fun onSingleTapConfirmed(e: MotionEvent): Boolean {
                    // å•å‡»ç¡®è®¤ - æ£€æŸ¥æ˜¯å¦ç‚¹å‡»tabåŒºåŸŸ
                    Log.d(TAG, "é®ç½©åŒºå•å‡»ç¡®è®¤: x=${e.x}, y=${e.y}")

                    // é¦–å…ˆæ£€æŸ¥æ˜¯å¦ç‚¹å‡»åœ¨å‰è¿›/åé€€æŒ‰é’®ä¸Šï¼Œå¦‚æœæ˜¯åˆ™ä¸å¤„ç†tabç‚¹å‡»
                    if (isTouchOnNavigationButtons(e)) {
                        Log.d(TAG, "å•å‡»åœ¨å‰è¿›/åé€€æŒ‰é’®ä¸Šï¼Œä¸å¤„ç†tabç‚¹å‡»")
                        return false
                    }

                    // æ£€æµ‹ç‚¹å‡»çš„tabåŒºåŸŸ
                    val bottomNavigation = findViewById<LinearLayout>(R.id.bottom_navigation)
                    if (bottomNavigation != null) {
                        val location = IntArray(2)
                        bottomNavigation.getLocationOnScreen(location)
                        val relativeX = e.rawX - location[0]

                        // åŠ¨æ€è®¡ç®—tabæ•°é‡ï¼ˆè€ƒè™‘è¯­éŸ³tabçš„å¯è§æ€§ï¼‰
                        val voiceTab = findViewById<LinearLayout>(R.id.tab_voice)
                        val totalTabs = if (voiceTab?.visibility == View.VISIBLE) 6 else 5
                        val tabWidth = bottomNavigation.width.toFloat() / totalTabs
                        val tabIndex = (relativeX / tabWidth).toInt()

                        Log.d(TAG, "é®ç½©å±‚ä¸­å•å‡»tabï¼ŒtabIndex=$tabIndex, totalTabs=$totalTabs, voiceTabVisible=${voiceTab?.visibility == View.VISIBLE}")

                        // æ ¹æ®è¯­éŸ³tabçš„å¯è§æ€§è°ƒæ•´ç´¢å¼•å¤„ç†
                        val isVoiceTabVisible = voiceTab?.visibility == View.VISIBLE

                        when (tabIndex) {
                            0 -> {
                                // å•å‡»å¯¹è¯tab - é€€å‡ºé®ç½©å±‚å¹¶è¿›å…¥å¯¹è¯é¡µé¢
                                Log.d(TAG, "é®ç½©å±‚ä¸­å•å‡»å¯¹è¯tabï¼Œé€€å‡ºé®ç½©å±‚å¹¶è¿›å…¥å¯¹è¯é¡µé¢")
                                performGestureVibration("light")
                                deactivateSearchTabGestureOverlay()
                                showChat()
                                return true
                            }
                            1 -> {
                                // åœ¨é®ç½©å±‚ä¸­å•å‡»æœç´¢tab - é€€å‡ºé®ç½©å±‚
                                Log.d(TAG, "é®ç½©å±‚ä¸­å•å‡»æœç´¢tabï¼Œé€€å‡ºé®ç½©å±‚")
                                performGestureVibration("light")
                                deactivateSearchTabGestureOverlay()
                                showMaterialToast("å·²é€€å‡ºé®ç½©å±‚")
                                return true
                            }
                            2 -> {
                                // å•å‡»ä»»åŠ¡tab - é€€å‡ºé®ç½©å±‚å¹¶è¿›å…¥ä»»åŠ¡é¡µé¢
                                Log.d(TAG, "é®ç½©å±‚ä¸­å•å‡»AIåŠ©æ‰‹tabï¼Œé€€å‡ºé®ç½©å±‚å¹¶è¿›å…¥AIåŠ©æ‰‹ä¸­å¿ƒé¡µé¢")
                                performGestureVibration("light")
                                deactivateSearchTabGestureOverlay()
                                showAIAssistantCenter()
                                return true
                            }
                            3 -> {
                                if (isVoiceTabVisible) {
                                    // è¯­éŸ³tabå¯è§ï¼Œå•å‡»è¯­éŸ³tab
                                    Log.d(TAG, "é®ç½©å±‚ä¸­å•å‡»è¯­éŸ³tabï¼Œé€€å‡ºé®ç½©å±‚å¹¶è¿›å…¥è¯­éŸ³é¡µé¢")
                                    performGestureVibration("light")
                                    deactivateSearchTabGestureOverlay()
                                    showVoice()
                                    return true
                                } else {
                                    // è¯­éŸ³tabéšè—ï¼Œè¿™æ˜¯è½¯ä»¶tab
                                    Log.d(TAG, "é®ç½©å±‚ä¸­å•å‡»è½¯ä»¶tabï¼ˆè¯­éŸ³tabéšè—ï¼‰ï¼Œé€€å‡ºé®ç½©å±‚å¹¶è¿›å…¥è½¯ä»¶é¡µé¢")
                                    performGestureVibration("light")
                                    deactivateSearchTabGestureOverlay()
                                    showAppSearch()
                                    return true
                                }
                            }
                            4 -> {
                                if (isVoiceTabVisible) {
                                    // è¯­éŸ³tabå¯è§ï¼Œè¿™æ˜¯è½¯ä»¶tab
                                    Log.d(TAG, "é®ç½©å±‚ä¸­å•å‡»è½¯ä»¶tabï¼Œé€€å‡ºé®ç½©å±‚å¹¶è¿›å…¥è½¯ä»¶é¡µé¢")
                                    performGestureVibration("light")
                                    deactivateSearchTabGestureOverlay()
                                    showAppSearch()
                                    return true
                                } else {
                                    // è¯­éŸ³tabéšè—ï¼Œè¿™æ˜¯è®¾ç½®tab
                                    Log.d(TAG, "é®ç½©å±‚ä¸­å•å‡»è®¾ç½®tabï¼ˆè¯­éŸ³tabéšè—ï¼‰ï¼Œé€€å‡ºé®ç½©å±‚å¹¶è¿›å…¥è®¾ç½®é¡µé¢")
                                    performGestureVibration("light")
                                    deactivateSearchTabGestureOverlay()
                                    showSettings()
                                    return true
                                }
                            }
                            5 -> {
                                // åªæœ‰è¯­éŸ³tabå¯è§æ—¶æ‰æœ‰ç¬¬5ä¸ªç´¢å¼•ï¼ˆè®¾ç½®tabï¼‰
                                if (isVoiceTabVisible) {
                                    Log.d(TAG, "é®ç½©å±‚ä¸­å•å‡»è®¾ç½®tabï¼Œé€€å‡ºé®ç½©å±‚å¹¶è¿›å…¥è®¾ç½®é¡µé¢")
                                    performGestureVibration("light")
                                    deactivateSearchTabGestureOverlay()
                                    showSettings()
                                    return true
                                }
                            }
                        }
                    }

                    return false // ä¸æ¶ˆè´¹äº‹ä»¶ï¼Œä¿æŒç©¿é€
                }

                // DoubleTapListener æ–¹æ³•
                override fun onDoubleTapEvent(e: MotionEvent): Boolean {
                    Log.d(TAG, "åŒå‡»äº‹ä»¶: action=${e.action}")
                    return false
                }

                override fun onSingleTapUp(e: MotionEvent): Boolean {
                    Log.d(TAG, "å•å‡»æŠ¬èµ·: x=${e.x}, y=${e.y}")
                    return false // ä¸æ¶ˆè´¹ï¼Œè®©åŒå‡»æ£€æµ‹å™¨å¤„ç†
                }
            }

            gestureDetectorForOverlay = GestureDetectorCompat(this, gestureListener)
            // å¯ç”¨åŒå‡»æ£€æµ‹
            gestureDetectorForOverlay?.setOnDoubleTapListener(gestureListener)
            // ç¡®ä¿é•¿æŒ‰æ£€æµ‹å¯ç”¨
            gestureDetectorForOverlay?.setIsLongpressEnabled(true)
            Log.d(TAG, "æ‰‹åŠ¿æ£€æµ‹å™¨é…ç½®å®Œæˆï¼ŒåŒå‡»å’Œé•¿æŒ‰æ£€æµ‹å·²å¯ç”¨")

            // åˆ›å»ºæ‰‹åŠ¿é®ç½©å±‚ - åªè¦†ç›–åº•éƒ¨å¯¼èˆªæ åŒºåŸŸ
            searchTabGestureOverlay = FrameLayout(this).apply {
                layoutParams = FrameLayout.LayoutParams(
                    FrameLayout.LayoutParams.MATCH_PARENT,
                    bottomNavigation.height
                ).apply {
                    gravity = android.view.Gravity.BOTTOM
                }

                // è®¾ç½®æ¨¡ç³ŠèƒŒæ™¯å’Œç»¿è‰²è¾¹æ¡†
                background = createOverlayBackground()

                // å…³é”®ï¼šè®¾ç½®ä¸ºä¸å¯ç‚¹å‡»ï¼Œä½†å¯ä»¥æ¥æ”¶è§¦æ‘¸äº‹ä»¶ç”¨äºæ£€æµ‹
                isClickable = false
                isFocusable = false
                isFocusableInTouchMode = false

                // é‡è¦ï¼šè®¾ç½®è§¦æ‘¸äº‹ä»¶ç©¿é€ï¼Œè®©WebViewå¯ä»¥æ­£å¸¸æ¥æ”¶è§¦æ‘¸
                setOnTouchListener { _, event ->
                    // åªå¤„ç†åº•éƒ¨å¯¼èˆªæ åŒºåŸŸçš„è§¦æ‘¸äº‹ä»¶
                    val bottomNavLocation = IntArray(2)
                    bottomNavigation.getLocationOnScreen(bottomNavLocation)
                    val relativeY = event.rawY - bottomNavLocation[1]
                    
                    // å¦‚æœè§¦æ‘¸åœ¨åº•éƒ¨å¯¼èˆªæ åŒºåŸŸå†…ï¼Œè¿›è¡Œæ‰‹åŠ¿æ£€æµ‹
                    if (relativeY >= 0 && relativeY <= bottomNavigation.height) {
                        handleGestureOverlayTouch(event)
                    } else {
                        // è§¦æ‘¸åœ¨WebViewåŒºåŸŸï¼Œç›´æ¥ç©¿é€
                        false
                    }
                }

                // æ³¨æ„ï¼šå‰è¿›å’Œåé€€æŒ‰é’®ä¸å†æ·»åŠ åˆ°é®ç½©å±‚
                // æŒ‰é’®ä¼šé€šè¿‡addNavigationButtons()æ–¹æ³•ç›´æ¥æ·»åŠ åˆ°åº•éƒ¨å¯¼èˆªæ 
            }

            // å·²ç§»é™¤ï¼šç¼©å°tabé—´è·å’Œæ·»åŠ å‰è¿›åé€€æŒ‰é’®åŠŸèƒ½ï¼Œç°åœ¨ç”±ä¸‹æ»‘é¡µé¢è‡ªåŠ¨å¼¹å‡ºæ‚¬æµ®å¿«æ·æ“ä½œèœå•æ›¿ä»£
            // adjustBottomNavigationForOverlay(true)
            // addNavigationButtons()
            
            // å°†é®ç½©å±‚æ·»åŠ åˆ°æ ¹å¸ƒå±€
            val rootLayout = findViewById<FrameLayout>(android.R.id.content)
            rootLayout.addView(searchTabGestureOverlay)

            isSearchTabGestureOverlayActive = true
            Log.d(TAG, "æœç´¢tabæ‰‹åŠ¿é®ç½©åŒºæ¿€æ´»æˆåŠŸ")

            // ç¡®ä¿æœç´¢tabä¿æŒé€‰ä¸­çŠ¶æ€ï¼ˆç»¿è‰²ä¸»é¢˜ï¼‰
            updateTabColors()

        } catch (e: Exception) {
            Log.e(TAG, "æ¿€æ´»æœç´¢tabæ‰‹åŠ¿é®ç½©åŒºå¤±è´¥", e)
        }
    }

    /**
     * å¤„ç†æ‰‹åŠ¿é®ç½©å±‚çš„è§¦æ‘¸äº‹ä»¶
     */
    private fun handleGestureOverlayTouch(event: MotionEvent): Boolean {
        return try {
                        // è®°å½•é®ç½©å±‚æ¥æ”¶åˆ°çš„è§¦æ‘¸äº‹ä»¶
                        Log.d(TAG, "é®ç½©å±‚æ¥æ”¶åˆ°è§¦æ‘¸äº‹ä»¶: action=${event.action}, x=${event.x}, y=${event.y}")

                        // é¦–å…ˆæ£€æŸ¥æ˜¯å¦ç‚¹å‡»åœ¨å‰è¿›/åé€€æŒ‰é’®ä¸Š
                        if (isTouchOnNavigationButtons(event)) {
                            Log.d(TAG, "è§¦æ‘¸åœ¨å‰è¿›/åé€€æŒ‰é’®ä¸Šï¼Œä¸å¤„ç†ï¼Œè®©æŒ‰é’®è‡ªå·±å¤„ç†")
                            return false // è®©æŒ‰é’®è‡ªå·±å¤„ç†ç‚¹å‡»äº‹ä»¶
                        }

                        // æ£€æµ‹ç‚¹å‡»çš„tabåŒºåŸŸ
                        var isSearchTabTouch = false
                        if (event.action == MotionEvent.ACTION_DOWN) {
                            val bottomNavigation = findViewById<LinearLayout>(R.id.bottom_navigation)
                            if (bottomNavigation != null) {
                                val location = IntArray(2)
                                bottomNavigation.getLocationOnScreen(location)
                                val relativeX = event.rawX - location[0]

                                // åŠ¨æ€è®¡ç®—tabæ•°é‡ï¼ˆè€ƒè™‘è¯­éŸ³tabçš„å¯è§æ€§å’Œå¯¼èˆªæŒ‰é’®ï¼‰
                                val voiceTab = findViewById<LinearLayout>(R.id.tab_voice)
                                val hasNavigationButtons = navBackButton != null && navForwardButton != null
                                // å¦‚æœæœ‰å¯¼èˆªæŒ‰é’®ï¼Œéœ€è¦ä»æ€»å®½åº¦ä¸­å‡å»æŒ‰é’®å®½åº¦
                                val buttonAreaWidth = if (hasNavigationButtons) {
                                    (navBackButton?.width ?: 0) + (navForwardButton?.width ?: 0) + (16 * resources.displayMetrics.density).toInt()
                                } else 0
                                val availableWidth = bottomNavigation.width - buttonAreaWidth
                                val totalTabs = if (voiceTab?.visibility == View.VISIBLE) 6 else 5
                                val tabWidth = availableWidth.toFloat() / totalTabs
                                // è°ƒæ•´relativeXï¼Œå‡å»æŒ‰é’®åŒºåŸŸçš„å®½åº¦
                                val adjustedX = relativeX - buttonAreaWidth
                                if (adjustedX >= 0) { // ç¡®ä¿åœ¨tabåŒºåŸŸå†…
                                    val tabIndex = (adjustedX / tabWidth).toInt().coerceIn(0, totalTabs - 1)

                                    Log.d(TAG, "é®ç½©å±‚æ£€æµ‹åˆ°tabè§¦æ‘¸: tabIndex=$tabIndex, relativeX=$relativeX, adjustedX=$adjustedX, totalTabs=$totalTabs, buttonAreaWidth=$buttonAreaWidth")

                                    when (tabIndex) {
                                        1 -> {
                                            // è§¦æ‘¸æœç´¢tab - å¯èƒ½æ˜¯å•å‡»æˆ–é•¿æŒ‰
                                            isSearchTabTouch = true
                                            Log.d(TAG, "é®ç½©å±‚æ£€æµ‹åˆ°æœç´¢tabè§¦æ‘¸ï¼Œå°†ç©¿é€å¤„ç†")
                                        }
                                        in 0..5 -> {
                                            // è§¦æ‘¸å…¶ä»–tab - å°†ç”±æ‰‹åŠ¿æ£€æµ‹å™¨å¤„ç†å•å‡»äº‹ä»¶
                                            Log.d(TAG, "é®ç½©å±‚æ£€æµ‹åˆ°å…¶ä»–tabè§¦æ‘¸ï¼Œå°†ç”±æ‰‹åŠ¿æ£€æµ‹å™¨å¤„ç†")
                                        }
                                    }
                                }
                            }
                        }

                        // å¦‚æœæ˜¯æœç´¢tabçš„è§¦æ‘¸ï¼Œè®©äº‹ä»¶ç›´æ¥ç©¿é€ï¼Œä¸è¿›è¡Œæ‰‹åŠ¿æ£€æµ‹
                        if (isSearchTabTouch) {
                            Log.d(TAG, "æœç´¢tabè§¦æ‘¸ï¼Œç›´æ¥ç©¿é€åˆ°åº•å±‚å¤„ç†é•¿æŒ‰/å•å‡»")
                return false // ç›´æ¥ç©¿é€
                        }

                        // è®©æ‰‹åŠ¿æ£€æµ‹å™¨å¤„ç†æ‰‹åŠ¿ï¼Œè·å–å¤„ç†ç»“æœ
                        val gestureHandled = gestureDetectorForOverlay?.onTouchEvent(event) ?: false
                        Log.d(TAG, "æ‰‹åŠ¿æ£€æµ‹å™¨å¤„ç†ç»“æœ: $gestureHandled")

                        // æ£€æŸ¥æ˜¯å¦æœ‰æ‰‹åŠ¿è¢«è¯†åˆ«ï¼ˆåŒå‡»ï¼Œä½†ä¸åŒ…æ‹¬é•¿æŒ‰ï¼‰
                        // é•¿æŒ‰äº‹ä»¶éœ€è¦ç©¿é€åˆ°æœç´¢tabå¤„ç†é€€å‡ºæ“ä½œ
                        val anyGestureDetected = gestureHandled || isDoubleTapDetected
                        Log.d(TAG, "æ‰‹åŠ¿çŠ¶æ€: gestureHandled=$gestureHandled, longPress=$isLongPressDetected(ç©¿é€), doubleTap=$isDoubleTapDetected")

                        // å¦‚æœæœ‰æ‰‹åŠ¿è¢«å¤„ç†äº†ï¼Œæ¶ˆè´¹äº‹ä»¶ï¼›å¦åˆ™ç©¿é€åˆ°åº•å±‚
                        if (anyGestureDetected) {
                            Log.d(TAG, "æ‰‹åŠ¿è¢«å¤„ç†ï¼Œæ¶ˆè´¹äº‹ä»¶")
                            true // æ¶ˆè´¹äº‹ä»¶
                        } else {
                            Log.d(TAG, "æ‰‹åŠ¿æœªè¢«å¤„ç†ï¼Œç©¿é€äº‹ä»¶")
                            false // ç©¿é€åˆ°åº•å±‚
                        }

                    } catch (e: Exception) {
                        Log.e(TAG, "é®ç½©å±‚è§¦æ‘¸å¤„ç†å¤±è´¥", e)
                        false
        }
    }

    /**
     * é€€å‡ºæœç´¢tabæ‰‹åŠ¿é®ç½©åŒº
     */
    private fun deactivateSearchTabGestureOverlay() {
        try {
            if (!isSearchTabGestureOverlayActive) {
                return
            }

            Log.d(TAG, "é€€å‡ºæœç´¢tabæ‰‹åŠ¿é®ç½©åŒº")

            // é€€å‡ºéœ‡åŠ¨åé¦ˆ
            performGestureVibration("light")

            // æ˜¾ç¤ºé€€å‡ºæç¤º
            showMaterialToast("æ‰‹åŠ¿åŒºå·²å…³é—­")

            // å·²ç§»é™¤ï¼šç§»é™¤å‰è¿›åé€€æŒ‰é’®å’Œæ¢å¤åº•éƒ¨å¯¼èˆªæ å¸ƒå±€åŠŸèƒ½
            // removeNavigationButtons()
            // adjustBottomNavigationForOverlay(false)
            
            // ç§»é™¤é®ç½©å±‚
            searchTabGestureOverlay?.let { overlay ->
                val rootLayout = findViewById<FrameLayout>(android.R.id.content)
                rootLayout.removeView(overlay)
            }

            searchTabGestureOverlay = null
            gestureDetectorForOverlay = null
            isSearchTabGestureOverlayActive = false

            // é‡ç½®æ‰‹åŠ¿çŠ¶æ€
            isLongPressDetected = false
            isDoubleTapDetected = false

            Log.d(TAG, "æœç´¢tabæ‰‹åŠ¿é®ç½©åŒºå·²é€€å‡º")

            // ç¡®ä¿tabé¢œè‰²çŠ¶æ€æ­£ç¡®æ›´æ–°
            updateTabColors()

        } catch (e: Exception) {
            Log.e(TAG, "é€€å‡ºæœç´¢tabæ‰‹åŠ¿é®ç½©åŒºå¤±è´¥", e)
        }
    }

    /**
     * æ˜¾ç¤ºæ‰‹åŠ¿æ“ä½œè¯´æ˜
     */
    private fun showGestureInstructions() {
        try {
            val instructions = """
                ğŸ¯ æ‰‹åŠ¿åŒºå·²æ¿€æ´»ï¼

                ğŸ”¥ æ¿€æ´»æ–¹å¼ï¼š
                é•¿æŒ‰æœç´¢tab â†’ å¼€å¯/å…³é—­æ‰‹åŠ¿åŒº

                âš¡ å¿«æ·æ“ä½œï¼š
                â€¢ ç‚¹å‡»æœç´¢tab â†’ å¤šå¡ç‰‡ç®¡ç†
                â€¢ ç‚¹å‡»å…¶ä»–tab â†’ å¿«é€Ÿåˆ‡æ¢é¡µé¢
                â€¢ å·¦å³æ»‘åŠ¨ â†’ å‰è¿›/åé€€
                â€¢ åŒå‡» â†’ å…³é—­å½“å‰ç½‘é¡µ

                ğŸ’¡ éšæ—¶é•¿æŒ‰æœç´¢tabå¯é€€å‡ºæ‰‹åŠ¿åŒº
            """.trimIndent()

            AlertDialog.Builder(this)
                .setTitle("ğŸ® æ‰‹åŠ¿æ“ä½œæŒ‡å—")
                .setMessage(instructions)
                .setPositiveButton("å¼€å§‹ä½¿ç”¨") { _, _ ->
                    // ç¡®ä¿æ‰‹åŠ¿åŒºå¤„äºæ¿€æ´»çŠ¶æ€
                    if (!isSearchTabGestureOverlayActive) {
                        activateSearchTabGestureOverlay()
                    }
                    // æ˜¾ç¤ºä½¿ç”¨æç¤º
                    showMaterialToast("ğŸ¯ æ‰‹åŠ¿åŒºå·²æ¿€æ´»ï¼ç°åœ¨å¯ä»¥ä½¿ç”¨å¿«æ·æ‰‹åŠ¿æ“ä½œ")
                }
                .setNegativeButton("å…³é—­æ‰‹åŠ¿åŒº") { _, _ ->
                    deactivateSearchTabGestureOverlay()
                }
                .show()

        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºæ‰‹åŠ¿è¯´æ˜å¤±è´¥", e)
        }
    }
    
    /**
     * è°ƒæ•´åº•éƒ¨å¯¼èˆªæ å¸ƒå±€ä»¥é€‚åº”é®ç½©å±‚
     * @param enable true=ç¼©å°é—´è·éšè—æ–‡å­—ï¼Œfalse=æ¢å¤åŸæ ·
     */
    private fun adjustBottomNavigationForOverlay(enable: Boolean) {
        try {
            val bottomNavigation = findViewById<LinearLayout>(R.id.bottom_navigation) ?: return
            val tabIds = listOf(R.id.tab_chat, R.id.tab_search, R.id.tab_home, R.id.tab_app_search, R.id.tab_settings)
            
            if (enable) {
                // ä¿å­˜åŸå§‹å¸ƒå±€å‚æ•°å’Œæ–‡å­—è§†å›¾
                tabIds.forEach { tabId ->
                    val tab = findViewById<LinearLayout>(tabId) ?: return@forEach
                    
                    // ä¿å­˜åŸå§‹å¸ƒå±€å‚æ•°
                    originalTabLayoutParams[tabId] = tab.layoutParams
                    
                    // éšè—æ–‡å­—
                    val textView = tab.getChildAt(1) as? TextView
                    originalTabTextViews[tabId] = textView
                    textView?.visibility = View.GONE
                    
                    // ç¼©å°tabå®½åº¦ï¼ˆå‡å°‘weightï¼‰
                    val layoutParams = tab.layoutParams as? LinearLayout.LayoutParams
                    layoutParams?.weight = 0.8f // ä»1.0ç¼©å°åˆ°0.8ï¼Œç•™å‡ºç©ºé—´ç»™æŒ‰é’®
                    tab.layoutParams = layoutParams
                    
                    Log.d(TAG, "è°ƒæ•´tabå¸ƒå±€: ${resources.getResourceEntryName(tabId)}, weight=${layoutParams?.weight}")
                }
            } else {
                // æ¢å¤åŸå§‹å¸ƒå±€
                tabIds.forEach { tabId ->
                    val tab = findViewById<LinearLayout>(tabId) ?: return@forEach
                    
                    // æ¢å¤å¸ƒå±€å‚æ•°
                    originalTabLayoutParams[tabId]?.let {
                        tab.layoutParams = it
                    }
                    
                    // æ˜¾ç¤ºæ–‡å­—
                    originalTabTextViews[tabId]?.visibility = View.VISIBLE
                    
                    Log.d(TAG, "æ¢å¤tabå¸ƒå±€: ${resources.getResourceEntryName(tabId)}")
                }
                
                // æ¸…ç©ºä¿å­˜çš„æ•°æ®
                originalTabLayoutParams.clear()
                originalTabTextViews.clear()
            }
        } catch (e: Exception) {
            Log.e(TAG, "è°ƒæ•´åº•éƒ¨å¯¼èˆªæ å¸ƒå±€å¤±è´¥", e)
        }
    }
    
    /**
     * åœ¨å¯¹è¯tabå·¦è¾¹æ·»åŠ å‰è¿›å’Œåé€€æŒ‰é’®
     */
    private fun addNavigationButtons() {
        try {
            val bottomNavigation = findViewById<LinearLayout>(R.id.bottom_navigation) ?: return
            val tabChat = findViewById<LinearLayout>(R.id.tab_chat) ?: return
            
            // å¦‚æœæŒ‰é’®å·²å­˜åœ¨ï¼Œå…ˆç§»é™¤
            removeNavigationButtons()
            
            // åˆ›å»ºæŒ‰é’®å®¹å™¨
            val buttonContainer = LinearLayout(this).apply {
                orientation = LinearLayout.HORIZONTAL
                gravity = Gravity.CENTER_VERTICAL
                layoutParams = LinearLayout.LayoutParams(
                    LinearLayout.LayoutParams.WRAP_CONTENT,
                    LinearLayout.LayoutParams.MATCH_PARENT
                ).apply {
                    setMargins((8 * resources.displayMetrics.density).toInt(), 0, 0, 0)
                }
                
                // è®¾ç½®å®¹å™¨å¯ä»¥ç‚¹å‡»ï¼Œä½†é˜»æ­¢äº‹ä»¶ä¼ æ’­åˆ°åº•å±‚
                isClickable = false
                isFocusable = false
                
                // è§¦æ‘¸äº‹ä»¶æ‹¦æˆªï¼šé˜»æ­¢äº‹ä»¶ä¼ æ’­åˆ°é®ç½©å±‚
                setOnTouchListener { container, event ->
                    when (event.action) {
                        MotionEvent.ACTION_DOWN -> {
                            // é˜»æ­¢æ‰€æœ‰çˆ¶è§†å›¾ï¼ˆåŒ…æ‹¬é®ç½©å±‚ï¼‰æ‹¦æˆªäº‹ä»¶
                            var parent = container.parent
                            while (parent != null) {
                                parent.requestDisallowInterceptTouchEvent(true)
                                parent = (parent as? View)?.parent
                            }
                        }
                        MotionEvent.ACTION_UP, MotionEvent.ACTION_CANCEL -> {
                            // æ¢å¤æ‹¦æˆªæƒé™
                            var parent = container.parent
                            while (parent != null) {
                                parent.requestDisallowInterceptTouchEvent(false)
                                parent = (parent as? View)?.parent
                            }
                        }
                    }
                    false // ä¸æ¶ˆè´¹äº‹ä»¶ï¼Œè®©å­æŒ‰é’®å¤„ç†
                }
            }
            
            // åˆ›å»ºåé€€æŒ‰é’®
            navBackButton = Button(this).apply {
                layoutParams = LinearLayout.LayoutParams(
                    (48 * resources.displayMetrics.density).toInt(),
                    (48 * resources.displayMetrics.density).toInt()
                ).apply {
                    setMargins(0, 0, (4 * resources.displayMetrics.density).toInt(), 0)
                }
                
                text = "â—€"
                textSize = 24f
                setTextColor(Color.WHITE)
                gravity = Gravity.CENTER
                
                // è®¾ç½®èƒŒæ™¯ä¸ºç»¿è‰²åœ†å½¢æŒ‰é’®
                background = android.graphics.drawable.GradientDrawable().apply {
                    shape = android.graphics.drawable.GradientDrawable.OVAL
                    setColor(android.graphics.Color.GREEN)
                    setStroke((2 * resources.displayMetrics.density).toInt(), Color.WHITE)
                }
                
                minWidth = 0
                minHeight = 0
                
                // ç‚¹å‡»äº‹ä»¶
                setOnClickListener { view ->
                    // é˜»æ­¢äº‹ä»¶ä¼ æ’­ï¼Œç¡®ä¿ä¸ä¼šè§¦å‘é®ç½©å±‚é€€å‡º
                    view.performHapticFeedback(android.view.HapticFeedbackConstants.VIRTUAL_KEY)
                    Log.d(TAG, "å¯¼èˆªæ åé€€æŒ‰é’®è¢«ç‚¹å‡»")
                    performGestureVibration("light")
                    goBackInCurrentWebView()
                    showSearchTabSwipeIndicator("åé€€")
                }
                
                // è§¦æ‘¸äº‹ä»¶ï¼šé˜»æ­¢äº‹ä»¶ä¼ æ’­åˆ°é®ç½©å±‚ï¼Œä½†å…è®¸onClickè§¦å‘
                setOnTouchListener { view, event ->
                    when (event.action) {
                        MotionEvent.ACTION_DOWN -> {
                            // é˜»æ­¢æ‰€æœ‰çˆ¶è§†å›¾ï¼ˆåŒ…æ‹¬é®ç½©å±‚ï¼‰æ‹¦æˆªäº‹ä»¶
                            var parent = view.parent
                            while (parent != null) {
                                parent.requestDisallowInterceptTouchEvent(true)
                                parent = (parent as? View)?.parent
                            }
                            // æ ‡è®°è§¦æ‘¸å¼€å§‹ï¼Œä¸æ¶ˆè´¹äº‹ä»¶ï¼Œè®©onClickèƒ½è§¦å‘
                        }
                        MotionEvent.ACTION_UP -> {
                            // ä¸æ¶ˆè´¹UPäº‹ä»¶ï¼Œè®©onClickèƒ½è§¦å‘
                            // ä½†ä¹‹å‰å·²ç»é˜»æ­¢äº†æ‹¦æˆªï¼Œæ‰€ä»¥ä¸ä¼šä¼ æ’­åˆ°é®ç½©å±‚
                        }
                        MotionEvent.ACTION_CANCEL -> {
                            // æ¢å¤æ‹¦æˆªæƒé™
                            var parent = view.parent
                            while (parent != null) {
                                parent.requestDisallowInterceptTouchEvent(false)
                                parent = (parent as? View)?.parent
                            }
                        }
                    }
                    false // ä¸æ¶ˆè´¹äº‹ä»¶ï¼Œè®©onClickç»§ç»­å¤„ç†
                }
                
                // é•¿æŒ‰äº‹ä»¶
                setOnLongClickListener {
                    showMaterialToast("ç½‘é¡µåé€€")
                    true
                }
                
                isClickable = true
                isFocusable = true
            }
            
            // åˆ›å»ºå‰è¿›æŒ‰é’®
            navForwardButton = Button(this).apply {
                layoutParams = LinearLayout.LayoutParams(
                    (48 * resources.displayMetrics.density).toInt(),
                    (48 * resources.displayMetrics.density).toInt()
                )
                
                text = "â–¶"
                textSize = 24f
                setTextColor(Color.WHITE)
                gravity = Gravity.CENTER
                
                // è®¾ç½®èƒŒæ™¯ä¸ºç»¿è‰²åœ†å½¢æŒ‰é’®
                background = android.graphics.drawable.GradientDrawable().apply {
                    shape = android.graphics.drawable.GradientDrawable.OVAL
                    setColor(android.graphics.Color.GREEN)
                    setStroke((2 * resources.displayMetrics.density).toInt(), Color.WHITE)
                }
                
                minWidth = 0
                minHeight = 0
                
                // ç‚¹å‡»äº‹ä»¶
                setOnClickListener { view ->
                    // é˜»æ­¢äº‹ä»¶ä¼ æ’­ï¼Œç¡®ä¿ä¸ä¼šè§¦å‘é®ç½©å±‚é€€å‡º
                    view.performHapticFeedback(android.view.HapticFeedbackConstants.VIRTUAL_KEY)
                    Log.d(TAG, "å¯¼èˆªæ å‰è¿›æŒ‰é’®è¢«ç‚¹å‡»")
                    performGestureVibration("light")
                    goForwardInCurrentWebView()
                    showSearchTabSwipeIndicator("å‰è¿›")
                }
                
                // è§¦æ‘¸äº‹ä»¶ï¼šé˜»æ­¢äº‹ä»¶ä¼ æ’­åˆ°é®ç½©å±‚ï¼Œä½†å…è®¸onClickè§¦å‘
                setOnTouchListener { view, event ->
                    when (event.action) {
                        MotionEvent.ACTION_DOWN -> {
                            // é˜»æ­¢æ‰€æœ‰çˆ¶è§†å›¾ï¼ˆåŒ…æ‹¬é®ç½©å±‚ï¼‰æ‹¦æˆªäº‹ä»¶
                            var parent = view.parent
                            while (parent != null) {
                                parent.requestDisallowInterceptTouchEvent(true)
                                parent = (parent as? View)?.parent
                            }
                            // æ ‡è®°è§¦æ‘¸å¼€å§‹ï¼Œä¸æ¶ˆè´¹äº‹ä»¶ï¼Œè®©onClickèƒ½è§¦å‘
                        }
                        MotionEvent.ACTION_UP -> {
                            // ä¸æ¶ˆè´¹UPäº‹ä»¶ï¼Œè®©onClickèƒ½è§¦å‘
                            // ä½†ä¹‹å‰å·²ç»é˜»æ­¢äº†æ‹¦æˆªï¼Œæ‰€ä»¥ä¸ä¼šä¼ æ’­åˆ°é®ç½©å±‚
                        }
                        MotionEvent.ACTION_CANCEL -> {
                            // æ¢å¤æ‹¦æˆªæƒé™
                            var parent = view.parent
                            while (parent != null) {
                                parent.requestDisallowInterceptTouchEvent(false)
                                parent = (parent as? View)?.parent
                            }
                        }
                    }
                    false // ä¸æ¶ˆè´¹äº‹ä»¶ï¼Œè®©onClickç»§ç»­å¤„ç†
                }
                
                // é•¿æŒ‰äº‹ä»¶
                setOnLongClickListener {
                    showMaterialToast("ç½‘é¡µå‰è¿›")
                    true
                }
                
                isClickable = true
                isFocusable = true
            }
            
            // å°†æŒ‰é’®æ·»åŠ åˆ°å®¹å™¨
            buttonContainer.addView(navBackButton)
            buttonContainer.addView(navForwardButton)
            
            // å°†å®¹å™¨æ’å…¥åˆ°å¯¹è¯tabä¹‹å‰ï¼ˆå·¦è¾¹ï¼‰
            val chatIndex = bottomNavigation.indexOfChild(tabChat)
            bottomNavigation.addView(buttonContainer, chatIndex)
            
            Log.d(TAG, "å‰è¿›å’Œåé€€æŒ‰é’®å·²æ·»åŠ åˆ°åº•éƒ¨å¯¼èˆªæ ")
        } catch (e: Exception) {
            Log.e(TAG, "æ·»åŠ å¯¼èˆªæŒ‰é’®å¤±è´¥", e)
        }
    }
    
    /**
     * ç§»é™¤å‰è¿›å’Œåé€€æŒ‰é’®
     */
    private fun removeNavigationButtons() {
        try {
            val bottomNavigation = findViewById<LinearLayout>(R.id.bottom_navigation) ?: return
            
            // æŸ¥æ‰¾å¹¶ç§»é™¤æŒ‰é’®å®¹å™¨
            for (i in 0 until bottomNavigation.childCount) {
                val child = bottomNavigation.getChildAt(i)
                if (child is LinearLayout && child.childCount == 2) {
                    // æ£€æŸ¥æ˜¯å¦åŒ…å«æˆ‘ä»¬çš„æŒ‰é’®ï¼ˆåé€€å’Œå‰è¿›æŒ‰é’®ï¼‰
                    val firstChild = child.getChildAt(0)
                    val secondChild = child.getChildAt(1)
                    if (firstChild is Button && secondChild is Button) {
                        val backButton = firstChild as Button
                        val forwardButton = secondChild as Button
                        if (backButton.text == "â—€" && forwardButton.text == "â–¶") {
                            bottomNavigation.removeView(child)
                            Log.d(TAG, "å·²ç§»é™¤å¯¼èˆªæŒ‰é’®å®¹å™¨")
                            break
                        }
                    }
                }
            }
            
            navBackButton = null
            navForwardButton = null
            
            Log.d(TAG, "å‰è¿›å’Œåé€€æŒ‰é’®å·²ç§»é™¤")
        } catch (e: Exception) {
            Log.e(TAG, "ç§»é™¤å¯¼èˆªæŒ‰é’®å¤±è´¥", e)
        }
    }

    /**
     * æ£€æŸ¥è§¦æ‘¸äº‹ä»¶æ˜¯å¦åœ¨å‰è¿›/åé€€æŒ‰é’®ä¸Š
     */
    private fun isTouchOnNavigationButtons(event: MotionEvent): Boolean {
        try {
            val bottomNavigation = findViewById<LinearLayout>(R.id.bottom_navigation) ?: return false
            
            // è·å–æŒ‰é’®ä½ç½®
            navBackButton?.let { backButton ->
                val backLocation = IntArray(2)
                backButton.getLocationOnScreen(backLocation)
                val backLeft = backLocation[0]
                val backRight = backLeft + backButton.width
                val backTop = backLocation[1]
                val backBottom = backTop + backButton.height
                
                if (event.rawX >= backLeft && event.rawX <= backRight &&
                    event.rawY >= backTop && event.rawY <= backBottom) {
                    return true
                }
            }
            
            navForwardButton?.let { forwardButton ->
                val forwardLocation = IntArray(2)
                forwardButton.getLocationOnScreen(forwardLocation)
                val forwardLeft = forwardLocation[0]
                val forwardRight = forwardLeft + forwardButton.width
                val forwardTop = forwardLocation[1]
                val forwardBottom = forwardTop + forwardButton.height
                
                if (event.rawX >= forwardLeft && event.rawX <= forwardRight &&
                    event.rawY >= forwardTop && event.rawY <= forwardBottom) {
                    return true
                }
            }
            
            return false
        } catch (e: Exception) {
            Log.e(TAG, "æ£€æŸ¥æŒ‰é’®è§¦æ‘¸ä½ç½®å¤±è´¥", e)
            return false
        }
    }
    
    /**
     * å¤„ç†æœç´¢tabæ‰‹åŠ¿é®ç½©åŒºçš„è§¦æ‘¸äº‹ä»¶ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼Œä¸»è¦é€»è¾‘å·²ç§»åˆ°è§¦æ‘¸ç›‘å¬å™¨ä¸­ï¼‰
     */
    private fun handleSearchTabGestureOverlayTouch(event: MotionEvent) {
        // è¿™ä¸ªæ–¹æ³•ç°åœ¨ä¸»è¦ç”¨äºå…¼å®¹æ€§ï¼Œå®é™…å¤„ç†é€»è¾‘åœ¨è§¦æ‘¸ç›‘å¬å™¨ä¸­
        Log.d(TAG, "handleSearchTabGestureOverlayTouch called: x=${event.x}, y=${event.y}")
    }

    /**
     * å¤„ç†ç½‘é¡µæµè§ˆæ‰‹åŠ¿æ“ä½œ
     * @return true å¦‚æœæ‰‹åŠ¿è¢«æˆåŠŸå¤„ç†ï¼Œfalse å¦‚æœæ‰‹åŠ¿æœªè¢«è¯†åˆ«
     */
    private fun handleWebBrowsingGesture(e1: MotionEvent?, e2: MotionEvent, velocityX: Float, velocityY: Float): Boolean {
        try {
            if (e1 == null) return false

            val deltaX = e2.x - e1.x
            val deltaY = e2.y - e1.y
            val absVelocityX = kotlin.math.abs(velocityX)
            val absVelocityY = kotlin.math.abs(velocityY)
            val absDeltaX = kotlin.math.abs(deltaX)
            val absDeltaY = kotlin.math.abs(deltaY)

            Log.d(TAG, "ç½‘é¡µæµè§ˆæ‰‹åŠ¿åˆ†æ: deltaX=$deltaX, deltaY=$deltaY, velocityX=$velocityX, velocityY=$velocityY")
            Log.d(TAG, "é€Ÿåº¦åˆ†æ: absVelocityX=$absVelocityX, absVelocityY=$absVelocityY")
            Log.d(TAG, "è·ç¦»åˆ†æ: absDeltaX=$absDeltaX, absDeltaY=$absDeltaY")

            // åˆ¤æ–­æ‰‹åŠ¿æ–¹å‘å’Œé€Ÿåº¦ï¼ˆä¼˜åŒ–è¯†åˆ«é€»è¾‘ï¼‰
            when {
                // æ°´å¹³æ»‘åŠ¨ - é¡µé¢å¡ç‰‡åˆ‡æ¢æˆ–å‰è¿›åé€€
                // æ¡ä»¶ï¼šæ°´å¹³è·ç¦»å¤§äºå‚ç›´è·ç¦» ä¸” (æ°´å¹³é€Ÿåº¦å¤§äºé˜ˆå€¼ æˆ– æ°´å¹³è·ç¦»è¶³å¤Ÿå¤§)
                absDeltaX > absDeltaY && (absVelocityX > 300 || absDeltaX > 80) -> {
                    Log.d(TAG, "æ£€æµ‹åˆ°æ°´å¹³æ»‘åŠ¨æ‰‹åŠ¿ï¼Œé®ç½©å±‚æ¿€æ´»çŠ¶æ€: $isSearchTabGestureOverlayActive")
                    
                    // å¦‚æœé®ç½©å±‚å·²æ¿€æ´»ï¼Œä½¿ç”¨å‰è¿›åé€€åŠŸèƒ½ï¼›å¦åˆ™ä½¿ç”¨é¡µé¢åˆ‡æ¢åŠŸèƒ½
                    if (isSearchTabGestureOverlayActive) {
                        // é®ç½©å±‚æ¿€æ´»æ—¶ï¼šå·¦å³æ»‘åŠ¨æ§åˆ¶å‰è¿›åé€€
                        if (deltaX > 30) {
                            // å‘å³æ»‘åŠ¨ - ç½‘é¡µåé€€
                            Log.d(TAG, "å‘å³æ»‘åŠ¨ - ç½‘é¡µåé€€")
                            performGestureVibration("swipe") // æ»‘åŠ¨éœ‡åŠ¨åé¦ˆ
                            goBackInCurrentWebView()
                            showSearchTabSwipeIndicator("åé€€")
                            return true
                        } else if (deltaX < -30) {
                            // å‘å·¦æ»‘åŠ¨ - ç½‘é¡µå‰è¿›
                            Log.d(TAG, "å‘å·¦æ»‘åŠ¨ - ç½‘é¡µå‰è¿›")
                            performGestureVibration("swipe") // æ»‘åŠ¨éœ‡åŠ¨åé¦ˆ
                            goForwardInCurrentWebView()
                            showSearchTabSwipeIndicator("å‰è¿›")
                            return true
                        } else {
                            Log.d(TAG, "æ»‘åŠ¨è·ç¦»ä¸è¶³: deltaX=$deltaX")
                            return false
                        }
                    } else {
                        // é®ç½©å±‚æœªæ¿€æ´»æ—¶ï¼šå·¦å³æ»‘åŠ¨åˆ‡æ¢é¡µé¢å¡ç‰‡ï¼ˆä¿æŒåŸæœ‰é€»è¾‘ï¼‰
                        if (deltaX > 30) {
                            // å‘å³æ»‘åŠ¨ - åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªé¡µé¢å¡ç‰‡
                            Log.d(TAG, "å‘å³æ»‘åŠ¨ - åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªé¡µé¢å¡ç‰‡")
                            performGestureVibration("swipe") // æ»‘åŠ¨éœ‡åŠ¨åé¦ˆ
                            handleNextPageCardGesture()
                            return true
                        } else if (deltaX < -30) {
                            // å‘å·¦æ»‘åŠ¨ - åˆ‡æ¢åˆ°ä¸Šä¸€ä¸ªé¡µé¢å¡ç‰‡
                            Log.d(TAG, "å‘å·¦æ»‘åŠ¨ - åˆ‡æ¢åˆ°ä¸Šä¸€ä¸ªé¡µé¢å¡ç‰‡")
                            performGestureVibration("swipe") // æ»‘åŠ¨éœ‡åŠ¨åé¦ˆ
                            handlePreviousPageCardGesture()
                            return true
                        } else {
                            Log.d(TAG, "æ»‘åŠ¨è·ç¦»ä¸è¶³: deltaX=$deltaX")
                            return false
                        }
                    }
                }
                else -> {
                    Log.d(TAG, "æœªè¯†åˆ«çš„æ‰‹åŠ¿æˆ–ä¸ç¬¦åˆæ°´å¹³æ»‘åŠ¨æ¡ä»¶")
                    return false
                }
            }

        } catch (e: Exception) {
            Log.e(TAG, "å¤„ç†ç½‘é¡µæµè§ˆæ‰‹åŠ¿å¤±è´¥", e)
            return false
        }
    }

    /**
     * å¤„ç†é•¿æŒ‰æ‰‹åŠ¿ - åˆ·æ–°å½“å‰é¡µé¢
     */
    private fun handleLongPressGesture(e: MotionEvent) {
        try {
            Log.d(TAG, "é®ç½©åŒºé•¿æŒ‰æ‰‹åŠ¿ - åˆ·æ–°å½“å‰é¡µé¢")

            // é•¿æŒ‰éœ‡åŠ¨åé¦ˆ
            performGestureVibration("medium")

            // åˆ·æ–°å½“å‰é¡µé¢
            refreshCurrentWebPage()

            // æ˜¾ç¤ºMaterialé£æ ¼åŠ¨æ•ˆ
            showGestureAnimation(e.x, e.y, "åˆ·æ–°", R.drawable.ic_refresh, android.graphics.Color.GREEN)

            // Toastæç¤º
            showMaterialToast("é¡µé¢å·²åˆ·æ–°", android.graphics.Color.GREEN)

        } catch (e: Exception) {
            Log.e(TAG, "å¤„ç†é•¿æŒ‰æ‰‹åŠ¿å¤±è´¥", e)
        }
    }

    /**
     * å¤„ç†åŒå‡»æ‰‹åŠ¿ - å…³é—­å½“å‰é¡µé¢
     */
    private fun handleDoubleTapGesture(e: MotionEvent) {
        try {
            Log.d(TAG, "é®ç½©åŒºåŒå‡»æ‰‹åŠ¿ - å…³é—­å½“å‰é¡µé¢")

            // åŒå‡»éœ‡åŠ¨åé¦ˆ
            performGestureVibration("double")

            // å…³é—­å½“å‰é¡µé¢
            closeCurrentWebPage()

            // æ˜¾ç¤ºMaterialé£æ ¼åŠ¨æ•ˆ
            showGestureAnimation(e.x, e.y, "å…³é—­", R.drawable.ic_close, android.graphics.Color.GREEN)

            // Toastæç¤º
            showMaterialToast("é¡µé¢å·²å…³é—­", android.graphics.Color.GREEN)

        } catch (e: Exception) {
            Log.e(TAG, "å¤„ç†åŒå‡»æ‰‹åŠ¿å¤±è´¥", e)
        }
    }

    /**
     * å¤„ç†ä¸‹ä¸€ä¸ªé¡µé¢å¡ç‰‡æ‰‹åŠ¿
     */
    private fun handleNextPageCardGesture() {
        try {
            var handled = false

            // ä¼˜å…ˆæ£€æŸ¥MobileCardManager
            val mobileCards = mobileCardManager?.getAllCards()
            if (!mobileCards.isNullOrEmpty() && mobileCards.size > 1) {
                val currentCard = mobileCardManager?.getCurrentCard()
                val currentIndex = mobileCards.indexOf(currentCard)
                val nextIndex = if (currentIndex >= 0 && currentIndex < mobileCards.size - 1) {
                    currentIndex + 1
                } else {
                    0 // å¾ªç¯åˆ°ç¬¬ä¸€ä¸ª
                }

                mobileCardManager?.switchToCard(nextIndex)
                val nextCard = mobileCards[nextIndex]
                showMaterialToast("åˆ‡æ¢åˆ°: ${nextCard.title ?: "ä¸‹ä¸€é¡µ"}", android.graphics.Color.GREEN)
                // æ˜¾ç¤ºæ»‘åŠ¨åŠ¨ç”»æ•ˆæœ
                showSwipeAnimation(true) // trueè¡¨ç¤ºå‘å³æ»‘åŠ¨
                handled = true
                Log.d(TAG, "æ‰‹åŠ¿é®ç½©åŒºï¼šæ‰‹æœºå¡ç‰‡åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªé¡µé¢")
            }

            // å¦‚æœMobileCardManageræ²¡æœ‰å¤„ç†ï¼Œæ£€æŸ¥GestureCardWebViewManager
            if (!handled) {
                val gestureCards = gestureCardWebViewManager?.getAllCards()
                if (!gestureCards.isNullOrEmpty() && gestureCards.size > 1) {
                    val currentCard = gestureCardWebViewManager?.getCurrentCard()
                    val currentIndex = gestureCards.indexOf(currentCard)
                    val nextIndex = if (currentIndex >= 0 && currentIndex < gestureCards.size - 1) {
                        currentIndex + 1
                    } else {
                        0 // å¾ªç¯åˆ°ç¬¬ä¸€ä¸ª
                    }

                    gestureCardWebViewManager?.switchToCard(nextIndex)
                    val nextCard = gestureCards[nextIndex]
                    showMaterialToast("åˆ‡æ¢åˆ°: ${nextCard.title ?: "ä¸‹ä¸€é¡µ"}", android.graphics.Color.GREEN)
                    // æ˜¾ç¤ºæ»‘åŠ¨åŠ¨ç”»æ•ˆæœ
                    showSwipeAnimation(true) // trueè¡¨ç¤ºå‘å³æ»‘åŠ¨
                    handled = true
                    Log.d(TAG, "æ‰‹åŠ¿é®ç½©åŒºï¼šæ‰‹åŠ¿å¡ç‰‡åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªé¡µé¢")
                }
            }

            if (!handled) {
                showMaterialToast("æ²¡æœ‰å…¶ä»–é¡µé¢", android.graphics.Color.GREEN)
                Log.d(TAG, "æ‰‹åŠ¿é®ç½©åŒºï¼šæ²¡æœ‰å…¶ä»–é¡µé¢å¯åˆ‡æ¢")
            }

        } catch (e: Exception) {
            Log.e(TAG, "å¤„ç†ä¸‹ä¸€ä¸ªé¡µé¢å¡ç‰‡æ‰‹åŠ¿å¤±è´¥", e)
        }
    }

    /**
     * å¤„ç†ä¸Šä¸€ä¸ªé¡µé¢å¡ç‰‡æ‰‹åŠ¿
     */
    private fun handlePreviousPageCardGesture() {
        try {
            var handled = false

            // ä¼˜å…ˆæ£€æŸ¥MobileCardManager
            val mobileCards = mobileCardManager?.getAllCards()
            if (!mobileCards.isNullOrEmpty() && mobileCards.size > 1) {
                val currentCard = mobileCardManager?.getCurrentCard()
                val currentIndex = mobileCards.indexOf(currentCard)
                val prevIndex = if (currentIndex > 0) {
                    currentIndex - 1
                } else {
                    mobileCards.size - 1 // å¾ªç¯åˆ°æœ€åä¸€ä¸ª
                }

                mobileCardManager?.switchToCard(prevIndex)
                val prevCard = mobileCards[prevIndex]
                showMaterialToast("åˆ‡æ¢åˆ°: ${prevCard.title ?: "ä¸Šä¸€é¡µ"}", android.graphics.Color.GREEN)
                // æ˜¾ç¤ºæ»‘åŠ¨åŠ¨ç”»æ•ˆæœ
                showSwipeAnimation(false) // falseè¡¨ç¤ºå‘å·¦æ»‘åŠ¨
                handled = true
                Log.d(TAG, "æ‰‹åŠ¿é®ç½©åŒºï¼šæ‰‹æœºå¡ç‰‡åˆ‡æ¢åˆ°ä¸Šä¸€ä¸ªé¡µé¢")
            }

            // å¦‚æœMobileCardManageræ²¡æœ‰å¤„ç†ï¼Œæ£€æŸ¥GestureCardWebViewManager
            if (!handled) {
                val gestureCards = gestureCardWebViewManager?.getAllCards()
                if (!gestureCards.isNullOrEmpty() && gestureCards.size > 1) {
                    val currentCard = gestureCardWebViewManager?.getCurrentCard()
                    val currentIndex = gestureCards.indexOf(currentCard)
                    val prevIndex = if (currentIndex > 0) {
                        currentIndex - 1
                    } else {
                        gestureCards.size - 1 // å¾ªç¯åˆ°æœ€åä¸€ä¸ª
                    }

                    gestureCardWebViewManager?.switchToCard(prevIndex)
                    val prevCard = gestureCards[prevIndex]
                    showMaterialToast("åˆ‡æ¢åˆ°: ${prevCard.title ?: "ä¸Šä¸€é¡µ"}", android.graphics.Color.GREEN)
                    // æ˜¾ç¤ºæ»‘åŠ¨åŠ¨ç”»æ•ˆæœ
                    showSwipeAnimation(false) // falseè¡¨ç¤ºå‘å·¦æ»‘åŠ¨
                    handled = true
                    Log.d(TAG, "æ‰‹åŠ¿é®ç½©åŒºï¼šæ‰‹åŠ¿å¡ç‰‡åˆ‡æ¢åˆ°ä¸Šä¸€ä¸ªé¡µé¢")
                }
            }

            if (!handled) {
                showMaterialToast("æ²¡æœ‰å…¶ä»–é¡µé¢", android.graphics.Color.GREEN)
                Log.d(TAG, "æ‰‹åŠ¿é®ç½©åŒºï¼šæ²¡æœ‰å…¶ä»–é¡µé¢å¯åˆ‡æ¢")
            }

        } catch (e: Exception) {
            Log.e(TAG, "å¤„ç†ä¸Šä¸€ä¸ªé¡µé¢å¡ç‰‡æ‰‹åŠ¿å¤±è´¥", e)
        }
    }

    /**
     * å…³é—­å½“å‰ç½‘é¡µé¡µé¢
     */
    private fun closeCurrentWebPage() {
        try {
            var handled = false

            // ä¼˜å…ˆæ£€æŸ¥MobileCardManager
            val mobileCards = mobileCardManager?.getAllCards()
            if (!mobileCards.isNullOrEmpty()) {
                val currentCard = mobileCardManager?.getCurrentCard()
                val currentIndex = mobileCards.indexOf(currentCard)
                if (currentIndex >= 0) {
                    mobileCardManager?.removeCard(currentIndex)
                    handled = true
                    Log.d(TAG, "æ‰‹åŠ¿é®ç½©åŒºï¼šå…³é—­æ‰‹æœºå¡ç‰‡é¡µé¢")
                }
            }

            // å¦‚æœMobileCardManageræ²¡æœ‰å¤„ç†ï¼Œæ£€æŸ¥GestureCardWebViewManager
            if (!handled) {
                val gestureCards = gestureCardWebViewManager?.getAllCards()
                if (!gestureCards.isNullOrEmpty()) {
                    val currentCard = gestureCardWebViewManager?.getCurrentCard()
                    val currentIndex = gestureCards.indexOf(currentCard)
                    if (currentIndex >= 0) {
                        gestureCardWebViewManager?.removeCard(currentIndex)
                        handled = true
                        Log.d(TAG, "æ‰‹åŠ¿é®ç½©åŒºï¼šå…³é—­æ‰‹åŠ¿å¡ç‰‡é¡µé¢")
                    }
                }
            }

            if (!handled) {
                showMaterialToast("æ²¡æœ‰å¯å…³é—­çš„é¡µé¢", android.graphics.Color.GREEN)
                Log.d(TAG, "æ‰‹åŠ¿é®ç½©åŒºï¼šæ²¡æœ‰å¯å…³é—­çš„é¡µé¢")
            }

        } catch (e: Exception) {
            Log.e(TAG, "å…³é—­å½“å‰ç½‘é¡µé¡µé¢å¤±è´¥", e)
        }
    }



    /**
     * åˆ·æ–°å½“å‰ç½‘é¡µ
     */
    private fun refreshCurrentWebPage() {
        try {
            var handled = false

            // ä¼˜å…ˆæ£€æŸ¥PaperStackWebViewManager
            paperStackWebViewManager?.let { manager ->
                val currentTab = manager.getCurrentTab()
                currentTab?.webView?.let { webView ->
                    webView.reload()
                    handled = true
                    Log.d(TAG, "åˆ·æ–°é¡µé¢ï¼šçº¸å †æ¨¡å¼")
                }
            }

            // å¦‚æœPaperStackWebViewManageræ²¡æœ‰å¤„ç†ï¼Œæ£€æŸ¥MultiPageWebViewManager
            if (!handled) {
                multiPageWebViewManager?.let { manager ->
                    manager.reload()
                    handled = true
                    Log.d(TAG, "åˆ·æ–°é¡µé¢ï¼šå¤šé¡µé¢æ¨¡å¼")
                }
            }

            // å¦‚æœMultiPageWebViewManageræ²¡æœ‰å¤„ç†ï¼Œæ£€æŸ¥MobileCardManager
            if (!handled) {
                val mobileCurrentCard = mobileCardManager?.getCurrentCard()
                if (mobileCurrentCard?.webView != null) {
                    mobileCurrentCard.webView.reload()
                    handled = true
                    Log.d(TAG, "åˆ·æ–°é¡µé¢ï¼šæ‰‹æœºå¡ç‰‡æ¨¡å¼")
                }
            }

            // å¦‚æœMobileCardManageræ²¡æœ‰å¤„ç†ï¼Œæ£€æŸ¥GestureCardWebViewManager
            if (!handled) {
                val gestureCurrentCard = gestureCardWebViewManager?.getCurrentCard()
                if (gestureCurrentCard?.webView != null) {
                    gestureCurrentCard.webView.reload()
                    handled = true
                    Log.d(TAG, "åˆ·æ–°é¡µé¢ï¼šæ‰‹åŠ¿å¡ç‰‡æ¨¡å¼")
                }
            }

            // å¦‚æœä»¥ä¸Šéƒ½æ²¡æœ‰å¤„ç†ï¼Œä½¿ç”¨é€šç”¨æ–¹æ³•
            if (!handled) {
                val currentWebView = getCurrentWebViewForScrollCheck()
                currentWebView?.let { webView ->
                    webView.reload()
                    handled = true
                    Log.d(TAG, "åˆ·æ–°é¡µé¢ï¼šé€šç”¨æ–¹æ³•")
                }
            }

            if (handled) {
                showMaterialToast("é¡µé¢å·²åˆ·æ–°")
            } else {
                showMaterialToast("æ²¡æœ‰å¯åˆ·æ–°çš„é¡µé¢", android.graphics.Color.GREEN)
                Log.d(TAG, "æ²¡æœ‰å¯åˆ·æ–°çš„é¡µé¢")
            }

        } catch (e: Exception) {
            Log.e(TAG, "åˆ·æ–°å½“å‰ç½‘é¡µå¤±è´¥", e)
            showMaterialToast("åˆ·æ–°é¡µé¢å¤±è´¥")
        }
    }

    /**
     * åˆ›å»ºæ–°ç½‘é¡µï¼ˆä¸€æ¬¡åªèƒ½åˆ›å»ºä¸€ä¸ªï¼‰
     */
    private fun createNewWebPage() {
        try {
            var created = false

            // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰å¤šä¸ªé¡µé¢ï¼Œå¦‚æœæœ‰åˆ™ä¸åˆ›å»ºæ–°é¡µé¢
            val mobileCards = mobileCardManager?.getAllCards()
            val gestureCards = gestureCardWebViewManager?.getAllCards()

            val totalCards = (mobileCards?.size ?: 0) + (gestureCards?.size ?: 0)
            if (totalCards >= 5) { // é™åˆ¶æœ€å¤š5ä¸ªé¡µé¢
                showMaterialToast("é¡µé¢æ•°é‡å·²è¾¾ä¸Šé™", android.graphics.Color.GREEN)
                Log.d(TAG, "é¡µé¢æ•°é‡å·²è¾¾ä¸Šé™ï¼Œæ— æ³•åˆ›å»ºæ–°é¡µé¢")
                return
            }

            // ä¼˜å…ˆä½¿ç”¨MobileCardManager
            if (mobileCardManager != null) {
                val newCard = mobileCardManager?.addNewCard("about:blank")
                if (newCard != null) {
                    created = true
                    showMaterialToast("å·²æ‰“å¼€æ–°é¡µé¢", android.graphics.Color.GREEN)
                    Log.d(TAG, "ä½¿ç”¨MobileCardManageråˆ›å»ºæ–°é¡µé¢")
                }
            }

            // å¦‚æœMobileCardManagerä¸å¯ç”¨ï¼Œä½¿ç”¨GestureCardWebViewManager
            if (!created && gestureCardWebViewManager != null) {
                val newCard = gestureCardWebViewManager?.addNewCard("about:blank")
                if (newCard != null) {
                    created = true
                    showMaterialToast("å·²æ‰“å¼€æ–°é¡µé¢", android.graphics.Color.GREEN)
                    Log.d(TAG, "ä½¿ç”¨GestureCardWebViewManageråˆ›å»ºæ–°é¡µé¢")
                }
            }

            if (!created) {
                showMaterialToast("æ— æ³•åˆ›å»ºæ–°é¡µé¢", android.graphics.Color.GREEN)
                Log.w(TAG, "åˆ›å»ºæ–°é¡µé¢å¤±è´¥")
            }

        } catch (e: Exception) {
            Log.e(TAG, "åˆ›å»ºæ–°ç½‘é¡µå¤±è´¥", e)
            showMaterialToast("åˆ›å»ºé¡µé¢å¤±è´¥", android.graphics.Color.GREEN)
        }
    }

    /**
     * æ‰§è¡ŒAIæœç´¢
     */
    private fun performAISearch(query: String) {
        try {
            Log.d(TAG, "æ‰§è¡ŒAIæœç´¢: $query")

            // ä½¿ç”¨é»˜è®¤AIæœç´¢å¼•æ“è¿›è¡Œæœç´¢
            val aiSearchUrl = "https://www.perplexity.ai/search?q=${java.net.URLEncoder.encode(query, "UTF-8")}"

            // è·å–å½“å‰WebView
            val currentCard = gestureCardWebViewManager?.getCurrentCard() ?: mobileCardManager?.getCurrentCard()
            if (currentCard?.webView != null) {
                currentCard.webView.loadUrl(aiSearchUrl)
                showMaterialToast("ğŸ¤– AIæœç´¢: $query")
            } else {
                // å¦‚æœæ²¡æœ‰å½“å‰WebViewï¼Œåˆ›å»ºæ–°çš„
                createNewWebPage()
                // ç­‰å¾…WebViewåˆ›å»ºå®ŒæˆååŠ è½½URL
                Handler(Looper.getMainLooper()).postDelayed({
                    val newCard = gestureCardWebViewManager?.getCurrentCard() ?: mobileCardManager?.getCurrentCard()
                    newCard?.webView?.loadUrl(aiSearchUrl)
                }, 100)
                showMaterialToast("ğŸ¤– æ–°å»ºAIæœç´¢é¡µé¢: $query")
            }

            // æ¸…ç©ºæœç´¢æ¡†
            browserSearchInput.setText("")

        } catch (e: Exception) {
            Log.e(TAG, "AIæœç´¢å¤±è´¥", e)
            showMaterialToast("âŒ AIæœç´¢å¤±è´¥ï¼Œè¯·é‡è¯•")
        }
    }

    /**
     * æ‰“å¼€AIåŠ©æ‰‹
     */
    private fun openAIAssistant() {
        try {
            Log.d(TAG, "æ‰“å¼€AIåŠ©æ‰‹")

            // åˆ‡æ¢åˆ°å¯¹è¯tabï¼Œæ¿€æ´»AIåŠ©æ‰‹åŠŸèƒ½
            showChat()
            showMaterialToast("ğŸ¤– AIåŠ©æ‰‹å·²æ¿€æ´»")

        } catch (e: Exception) {
            Log.e(TAG, "æ‰“å¼€AIåŠ©æ‰‹å¤±è´¥", e)
            showMaterialToast("âŒ æ— æ³•æ‰“å¼€AIåŠ©æ‰‹")
        }
    }

    /**
     * æ˜¾ç¤ºç»Ÿä¸€æ ·å¼çš„Toastæç¤º - ç®€æ´æ–‡æ¡ˆï¼Œç»Ÿä¸€ä½ç½®
     */
    private fun showMaterialToast(message: String, color: Int = android.graphics.Color.GREEN) {
        try {
            runOnUiThread {
                // æ£€æµ‹å½“å‰ä¸»é¢˜æ¨¡å¼
                val isDarkMode = (resources.configuration.uiMode and
                    android.content.res.Configuration.UI_MODE_NIGHT_MASK) ==
                    android.content.res.Configuration.UI_MODE_NIGHT_YES

                // åˆ›å»ºè‡ªå®šä¹‰Toastå¸ƒå±€
                val layout = LinearLayout(this).apply {
                    orientation = LinearLayout.HORIZONTAL
                    setPadding(24, 16, 24, 16)
                    background = GradientDrawable().apply {
                        // æ ¹æ®ä¸»é¢˜è®¾ç½®èƒŒæ™¯è‰²
                        val backgroundColor = if (isDarkMode) {
                            android.graphics.Color.parseColor("#2D2D2D") // æš—è‰²æ¨¡å¼ï¼šæ·±ç°è‰²èƒŒæ™¯
                        } else {
                            android.graphics.Color.parseColor("#FFFFFF") // äº®è‰²æ¨¡å¼ï¼šç™½è‰²èƒŒæ™¯
                        }
                        setColor(backgroundColor)
                        setStroke(4, android.graphics.Color.parseColor("#4CAF50")) // ç»¿è‰²è¾¹æ¡†
                        cornerRadius = 24f
                    }
                    elevation = 8f
                }

                // æ·»åŠ æ–‡æœ¬
                val textView = TextView(this).apply {
                    text = message
                    // æ ¹æ®ä¸»é¢˜è®¾ç½®æ–‡å­—é¢œè‰²
                    val textColor = if (isDarkMode) {
                        android.graphics.Color.parseColor("#FFFFFF") // æš—è‰²æ¨¡å¼ï¼šç™½è‰²æ–‡å­—
                    } else {
                        android.graphics.Color.parseColor("#2E7D32") // äº®è‰²æ¨¡å¼ï¼šæ·±ç»¿è‰²æ–‡å­—
                    }
                    setTextColor(textColor)
                    textSize = 15f
                    typeface = android.graphics.Typeface.DEFAULT
                    layoutParams = LinearLayout.LayoutParams(
                        LinearLayout.LayoutParams.WRAP_CONTENT,
                        LinearLayout.LayoutParams.WRAP_CONTENT
                    ).apply {
                        gravity = android.view.Gravity.CENTER_VERTICAL
                    }
                }

                layout.addView(textView)

                // åˆ›å»ºå¹¶æ˜¾ç¤ºToast - ç»Ÿä¸€ä½ç½®ï¼šå±å¹•é¡¶éƒ¨ä¸­å¤®
                val toast = Toast(this).apply {
                    view = layout
                    duration = Toast.LENGTH_SHORT
                    // ç»Ÿä¸€ä½ç½®ï¼šå±å¹•é¡¶éƒ¨ä¸­å¤®ï¼Œè·ç¦»é¡¶éƒ¨150px
                    setGravity(android.view.Gravity.TOP or android.view.Gravity.CENTER_HORIZONTAL, 0, 150)
                }

                toast.show()
                Log.d(TAG, "æ˜¾ç¤ºToast: $message")
            }
        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºToastå¤±è´¥", e)
            // å›é€€åˆ°æ™®é€šToast
            runOnUiThread {
                Toast.makeText(this, message, Toast.LENGTH_SHORT).apply {
                    setGravity(android.view.Gravity.TOP or android.view.Gravity.CENTER_HORIZONTAL, 0, 150)
                }.show()
            }
        }
    }

    /**
     * æ˜¾ç¤ºæ‰‹åŠ¿åŠ¨ç”»æ•ˆæœ - Material Designé£æ ¼
     */
    private fun showGestureAnimation(x: Float, y: Float, actionText: String, iconRes: Int, color: Int) {
        try {
            runOnUiThread {
                // åˆ›å»ºåŠ¨ç”»å®¹å™¨
                val animationContainer = FrameLayout(this)

                // åˆ›å»ºèƒŒæ™¯åœ†åœˆ
                val backgroundCircle = android.view.View(this)
                val circleDrawable = android.graphics.drawable.GradientDrawable()
                circleDrawable.shape = android.graphics.drawable.GradientDrawable.OVAL
                circleDrawable.setColor(android.graphics.Color.argb(80, 0, 255, 0)) // åŠé€æ˜ç»¿è‰²
                backgroundCircle.background = circleDrawable

                // åˆ›å»ºå›¾æ ‡è§†å›¾
                val iconView = ImageView(this)
                iconView.setImageResource(android.R.drawable.ic_menu_rotate) // ä½¿ç”¨ç³»ç»Ÿå›¾æ ‡ä½œä¸ºå ä½ç¬¦
                iconView.setColorFilter(color)

                // è®¾ç½®å¸ƒå±€å‚æ•°
                val circleSize = 120
                val iconSize = 48

                val circleParams = FrameLayout.LayoutParams(circleSize, circleSize)
                circleParams.gravity = android.view.Gravity.CENTER
                backgroundCircle.layoutParams = circleParams

                val iconParams = FrameLayout.LayoutParams(iconSize, iconSize)
                iconParams.gravity = android.view.Gravity.CENTER
                iconView.layoutParams = iconParams

                // æ·»åŠ è§†å›¾åˆ°å®¹å™¨
                animationContainer.addView(backgroundCircle)
                animationContainer.addView(iconView)

                // è®¾ç½®å®¹å™¨ä½ç½®
                val containerParams = FrameLayout.LayoutParams(circleSize, circleSize)
                animationContainer.layoutParams = containerParams
                animationContainer.x = x - circleSize / 2
                animationContainer.y = y - circleSize / 2

                // è®¾ç½®åˆå§‹çŠ¶æ€
                animationContainer.alpha = 0f
                animationContainer.scaleX = 0.3f
                animationContainer.scaleY = 0.3f

                // æ·»åŠ åˆ°é®ç½©å±‚
                searchTabGestureOverlay?.addView(animationContainer)

                // Material Designé£æ ¼åŠ¨ç”»
                // ç¬¬ä¸€é˜¶æ®µï¼šå¿«é€Ÿæ”¾å¤§å¹¶æ˜¾ç¤º
                animationContainer.animate()
                    .alpha(1f)
                    .scaleX(1.1f)
                    .scaleY(1.1f)
                    .setDuration(150)
                    .setInterpolator(android.view.animation.DecelerateInterpolator())
                    .withEndAction {
                        // ç¬¬äºŒé˜¶æ®µï¼šè½»å¾®å›å¼¹
                        animationContainer.animate()
                            .scaleX(1.0f)
                            .scaleY(1.0f)
                            .setDuration(100)
                            .setInterpolator(android.view.animation.OvershootInterpolator())
                            .withEndAction {
                                // ç¬¬ä¸‰é˜¶æ®µï¼šä¿æŒä¸€æ®µæ—¶é—´åæ·¡å‡º
                                android.os.Handler(android.os.Looper.getMainLooper()).postDelayed({
                                    animationContainer.animate()
                                        .alpha(0f)
                                        .scaleX(0.8f)
                                        .scaleY(0.8f)
                                        .setDuration(200)
                                        .setInterpolator(android.view.animation.AccelerateInterpolator())
                                        .withEndAction {
                                            searchTabGestureOverlay?.removeView(animationContainer)
                                        }
                                        .start()
                                }, 500) // ä¿æŒ500ms
                            }
                            .start()
                    }
                    .start()

                Log.d(TAG, "æ˜¾ç¤ºMaterialé£æ ¼æ‰‹åŠ¿åŠ¨ç”»: $actionText")
            }
        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºæ‰‹åŠ¿åŠ¨ç”»å¤±è´¥", e)
        }
    }

    /**
     * æ˜¾ç¤ºæ»‘åŠ¨åŠ¨ç”»æ•ˆæœ - Material Designé£æ ¼
     */
    private fun showSwipeAnimation(isRightSwipe: Boolean) {
        try {
            runOnUiThread {
                val overlay = searchTabGestureOverlay ?: return@runOnUiThread

                // åˆ›å»ºæ»‘åŠ¨æŒ‡ç¤ºå™¨
                val swipeIndicator = android.view.View(this)
                val indicatorDrawable = android.graphics.drawable.GradientDrawable()
                indicatorDrawable.shape = android.graphics.drawable.GradientDrawable.RECTANGLE
                indicatorDrawable.setColor(android.graphics.Color.argb(120, 0, 255, 0)) // åŠé€æ˜ç»¿è‰²
                indicatorDrawable.cornerRadius = 8f
                swipeIndicator.background = indicatorDrawable

                // è®¾ç½®æŒ‡ç¤ºå™¨å¤§å°å’Œä½ç½®
                val indicatorWidth = 100
                val indicatorHeight = 8
                val layoutParams = FrameLayout.LayoutParams(indicatorWidth, indicatorHeight)
                layoutParams.gravity = android.view.Gravity.CENTER
                swipeIndicator.layoutParams = layoutParams

                // è®¾ç½®åˆå§‹ä½ç½®
                val centerX = overlay.width / 2f
                val centerY = overlay.height / 2f
                val startOffset = if (isRightSwipe) -50f else 50f

                swipeIndicator.x = centerX + startOffset - indicatorWidth / 2
                swipeIndicator.y = centerY - indicatorHeight / 2
                swipeIndicator.alpha = 0f

                // æ·»åŠ åˆ°é®ç½©å±‚
                overlay.addView(swipeIndicator)

                // æ‰§è¡Œæ»‘åŠ¨åŠ¨ç”»
                val endOffset = if (isRightSwipe) 50f else -50f
                swipeIndicator.animate()
                    .alpha(1f)
                    .setDuration(100)
                    .withEndAction {
                        swipeIndicator.animate()
                            .translationX(endOffset)
                            .setDuration(300)
                            .setInterpolator(android.view.animation.DecelerateInterpolator())
                            .withEndAction {
                                swipeIndicator.animate()
                                    .alpha(0f)
                                    .setDuration(200)
                                    .withEndAction {
                                        overlay.removeView(swipeIndicator)
                                    }
                                    .start()
                            }
                            .start()
                    }
                    .start()

                Log.d(TAG, "æ˜¾ç¤ºæ»‘åŠ¨åŠ¨ç”»: ${if (isRightSwipe) "å‘å³" else "å‘å·¦"}")
            }
        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºæ»‘åŠ¨åŠ¨ç”»å¤±è´¥", e)
        }
    }



    /**
     * åˆ›å»ºé®ç½©å±‚èƒŒæ™¯ï¼ˆæ¨¡ç³Šæ•ˆæœ + ç»¿è‰²è¾¹æ¡†ï¼‰
     */
    private fun createOverlayBackground(): android.graphics.drawable.Drawable {
        return android.graphics.drawable.GradientDrawable().apply {
            setColor(android.graphics.Color.argb(120, 255, 255, 255)) // åŠé€æ˜ç™½è‰²æ¨¡ç³Šæ•ˆæœ
            setStroke(4, android.graphics.Color.GREEN) // ç»¿è‰²è¾¹æ¡†
            cornerRadius = 8f // åœ†è§’
        }
    }

    /**
     * å†…è”ç¼–è¾‘æ•°æ®ç»“æ„
     */
    data class InlineEditData(
        // åŸºç¡€ä¿¡æ¯
        var profileName: String = "é»˜è®¤ç”»åƒ",
        var persona: String = "ä¸€ä¸ªä¹äºåŠ©äººçš„é€šç”¨AIåŠ©æ‰‹",
        var domain: String = "é€šç”¨é¢†åŸŸ",
        
        // æ‰©å±•é…ç½®
        var systemRole: String = "AIåŠ©æ‰‹",
        var techParams: String = "æ ‡å‡†é…ç½®",
        var format: String = "ä½¿ç”¨Markdownæ ¼å¼",
        
        // AIè¡Œä¸º
        var tone: String = "å‹å¥½ã€æ¸…æ™°ã€ç®€æ´",
        var formality: String = "é€‚ä¸­",
        var length: String = "é€‚ä¸­",
        var responseMode: String = "å¹³è¡¡æ¨¡å¼",
        
        // ä¸ªæ€§åŒ– - åŸºæœ¬ä¿¡æ¯
        var gender: String = "æœªè®¾ç½®",
        var ageGroup: String = "æœªè®¾ç½®",
        
        // ä¸ªæ€§åŒ– - èŒä¸šä¿¡æ¯
        var occupation: String = "æœªè®¾ç½®",
        var occupationInterest: String = "æœªè®¾ç½®",
        var education: String = "æœªè®¾ç½®",
        
        // ä¸ªæ€§åŒ– - å…´è¶£ä¸åå¥½
        var entertainment: String = "æœªè®¾ç½®",
        var shopping: String = "æœªè®¾ç½®",
        var niche: String = "æœªè®¾ç½®",
        
        // ä¸ªæ€§åŒ– - è§‚å¿µä¸å–å‘
        var orientation: String = "ä¸æ„¿é€éœ²",
        var values: String = "æœªè®¾ç½®",
        
        // ä¸ªæ€§åŒ– - å¥åº·ä¿¡æ¯
        var diagnosed: String = "æ— ä¸Šè¿°ç–¾ç—…",
        var dietary: String = "æœªè®¾ç½®",
        var sleep: String = "æœªè®¾ç½®",
        
        // ä¸ªæ€§åŒ– - å…¶ä»–è®¾ç½®
        var language: String = "ä¸­æ–‡",
        var preferences: String = "æ ‡å‡†åå¥½",
        var customization: String = "é»˜è®¤å®šåˆ¶"
    )

    /**
     * é¢„è®¾é€‰é¡¹é…ç½®
     */
    // åŸºç¡€ä¿¡æ¯é€‰é¡¹
    private val profileNameOptions = listOf(
        "é»˜è®¤ç”»åƒ",
        "å­¦ä¹ åŠ©æ‰‹",
        "å·¥ä½œä¼™ä¼´",
        "åˆ›æ„åŠ©æ‰‹",
        "æŠ€æœ¯é¡¾é—®",
        "å†™ä½œåŠ©æ‰‹",
        "ç¿»è¯‘åŠ©æ‰‹",
        "å®¢æœåŠ©æ‰‹"
    )

    private val personaOptions = listOf(
        "ä¸€ä¸ªä¹äºåŠ©äººçš„é€šç”¨AIåŠ©æ‰‹",
        "ä¸“ä¸šçš„æŠ€æœ¯é¡¾é—®",
        "å‹å¥½çš„å®¢æœä»£è¡¨",
        "ä¸¥è°¨çš„å­¦æœ¯å¯¼å¸ˆ",
        "åˆ›æ„å†™ä½œåŠ©æ‰‹",
        "æ•°æ®åˆ†æä¸“å®¶",
        "ç¼–ç¨‹åŠ©æ‰‹",
        "ç¿»è¯‘ä¸“å®¶"
    )

    private val domainOptions = listOf(
        "é€šç”¨é¢†åŸŸ",
        "æŠ€æœ¯å¼€å‘",
        "å­¦æœ¯ç ”ç©¶",
        "å•†ä¸šç®¡ç†",
        "åˆ›æ„è®¾è®¡",
        "æ•™è‚²åŸ¹è®­",
        "åŒ»ç–—å¥åº·",
        "æ³•å¾‹å’¨è¯¢"
    )

    // æ‰©å±•é…ç½®é€‰é¡¹
    private val systemRoleOptions = listOf(
        "AIåŠ©æ‰‹",
        "ä¸“ä¸šé¡¾é—®",
        "å­¦ä¹ å¯¼å¸ˆ",
        "åˆ›æ„ä¼™ä¼´",
        "æŠ€æœ¯ä¸“å®¶",
        "å®¢æœä»£è¡¨",
        "ç¿»è¯‘ä¸“å®¶",
        "æ•°æ®åˆ†æå¸ˆ"
    )

    private val techParamsOptions = listOf(
        "æ ‡å‡†é…ç½®",
        "é«˜æ€§èƒ½æ¨¡å¼",
        "èŠ‚èƒ½æ¨¡å¼",
        "å¿«é€Ÿå“åº”",
        "æ·±åº¦åˆ†æ",
        "å¹³è¡¡æ¨¡å¼",
        "å®šåˆ¶é…ç½®"
    )

    private val formatOptions = listOf(
        "ä½¿ç”¨Markdownæ ¼å¼",
        "çº¯æ–‡æœ¬æ ¼å¼",
        "HTMLæ ¼å¼",
        "JSONæ ¼å¼",
        "XMLæ ¼å¼",
        "è‡ªå®šä¹‰æ ¼å¼"
    )

    // AIè¡Œä¸ºé€‰é¡¹
    private val toneOptions = listOf(
        "å‹å¥½ã€æ¸…æ™°ã€ç®€æ´",
        "ä¸“ä¸šã€ä¸¥è°¨ã€è¯¦ç»†",
        "è½»æ¾ã€å¹½é»˜ã€æœ‰è¶£",
        "æ­£å¼ã€æƒå¨ã€ä¸“ä¸š",
        "æ¸©å’Œã€è€å¿ƒã€ç»†è‡´",
        "ç›´æ¥ã€é«˜æ•ˆã€å®ç”¨"
    )

    private val formalityOptions = listOf(
        "éå¸¸æ­£å¼",
        "æ­£å¼",
        "é€‚ä¸­",
        "éæ­£å¼",
        "éå¸¸éšæ„"
    )

    private val lengthOptions = listOf(
        "éå¸¸ç®€çŸ­",
        "ç®€çŸ­",
        "é€‚ä¸­",
        "è¯¦ç»†",
        "éå¸¸è¯¦ç»†"
    )

    private val responseModeOptions = listOf(
        "å¹³è¡¡æ¨¡å¼",
        "å¿«é€Ÿæ¨¡å¼",
        "æ·±åº¦æ¨¡å¼",
        "åˆ›æ„æ¨¡å¼",
        "åˆ†ææ¨¡å¼",
        "å¯¹è¯æ¨¡å¼"
    )

    // ä¸ªæ€§åŒ–é€‰é¡¹ - åŸºæœ¬ä¿¡æ¯
    private val genderOptions = listOf(
        "æœªè®¾ç½®",
        "ç”·",
        "å¥³",
        "å…¶ä»–"
    )

    private val ageGroupOptions = listOf(
        "æœªè®¾ç½®",
        "90å (1990-1999)",
        "80å (1980-1989)",
        "70å (1970-1979)",
        "60å (1960-1969)",
        "å…¶ä»–"
    )

    // ä¸ªæ€§åŒ–é€‰é¡¹ - èŒä¸šä¿¡æ¯
    private val occupationOptions = listOf(
        "æœªè®¾ç½®",
        "å­¦ç”Ÿ",
        "ä¿¡æ¯æŠ€æœ¯/äº’è”ç½‘",
        "åŒ»ç–—/å¥åº·",
        "æ•™è‚²/ç§‘ç ”",
        "é‡‘è/æ³•å¾‹/å’¨è¯¢",
        "è‰ºæœ¯/è®¾è®¡/åª’ä½“",
        "é”€å”®/å¸‚åœº/è¿è¥",
        "å»ºç­‘/æˆ¿åœ°äº§",
        "åˆ¶é€ ä¸š/ç‰©æµ",
        "è‡ªç”±èŒä¸š/åˆ›ä¸šè€…",
        "æ”¿åºœ/éè¥åˆ©ç»„ç»‡",
        "å…¶ä»–"
    )

    private val occupationInterestOptions = listOf(
        "æœªè®¾ç½®",
        "äººå·¥æ™ºèƒ½/æ•°æ®ç§‘å­¦",
        "äº§å“ç®¡ç†",
        "å¸‚åœºè¥é”€",
        "ç”¨æˆ·ä½“éªŒ(UX)è®¾è®¡",
        "æ–°èƒ½æº/ç¯ä¿",
        "ç”Ÿç‰©æŠ€æœ¯",
        "çŸ­è§†é¢‘/ç›´æ’­",
        "ç”µå­å•†åŠ¡"
    )

    private val educationOptions = listOf(
        "æœªè®¾ç½®",
        "é«˜ä¸­åŠä»¥ä¸‹",
        "å¤§ä¸“",
        "æœ¬ç§‘",
        "ç¡•å£«",
        "åšå£«"
    )

    // ä¸ªæ€§åŒ–é€‰é¡¹ - å…´è¶£ä¸åå¥½
    private val entertainmentOptions = listOf(
        "æœªè®¾ç½®",
        "ç”µå½±/å‰§é›†",
        "éŸ³ä¹",
        "é˜…è¯»",
        "ç”µå­æ¸¸æˆ",
        "åŠ¨æ¼«",
        "ç»¼è‰º/è„±å£ç§€",
        "æ’­å®¢"
    )

    private val shoppingOptions = listOf(
        "æœªè®¾ç½®",
        "æ•°ç äº§å“",
        "æœé¥°ç¾å¦†",
        "å›¾ä¹¦æ–‡åˆ›",
        "å®¶å±…ç”Ÿæ´»",
        "æ±½è½¦"
    )

    private val nicheOptions = listOf(
        "æœªè®¾ç½®",
        "å¾’æ­¥/éœ²è¥",
        "æ½œæ°´/å†²æµª",
        "æ»‘é›ª",
        "æ‰‹åŠ/æ¨¡å‹",
        "å’–å•¡/èŒ¶è‰º",
        "çƒ˜ç„™/çƒ¹é¥ª",
        "å¤©æ–‡å­¦",
        "å†å²"
    )

    // ä¸ªæ€§åŒ–é€‰é¡¹ - è§‚å¿µä¸å–å‘
    private val orientationOptions = listOf(
        "ä¸æ„¿é€éœ²",
        "å¼‚æ€§æ‹",
        "åŒæ€§æ‹",
        "åŒæ€§æ‹",
        "æ³›æ€§æ‹",
        "æ— æ€§æ‹"
    )

    private val valuesOptions = listOf(
        "æœªè®¾ç½®",
        "å®ç”¨ä¸»ä¹‰",
        "ç†æƒ³ä¸»ä¹‰",
        "é›†ä½“ä¸»ä¹‰",
        "ä¸ªäººä¸»ä¹‰",
        "ç¯ä¿ä¸»ä¹‰",
        "ç§‘æŠ€ä¹è§‚ä¸»ä¹‰"
    )

    // ä¸ªæ€§åŒ–é€‰é¡¹ - å¥åº·ä¿¡æ¯
    private val diagnosedOptions = listOf(
        "æ— ä¸Šè¿°ç–¾ç—…",
        "é«˜è¡€å‹",
        "ç³–å°¿ç—…",
        "å¿ƒè„ç—…",
        "èƒƒç—…",
        "åå¤´ç—›"
    )

    private val dietaryOptions = listOf(
        "æœªè®¾ç½®",
        "å¿Œè¾›è¾£",
        "å¿Œç”Ÿå†·",
        "å¿Œæ²¹è…»",
        "ä½ç›",
        "ä½ç³–/æ— ç³–",
        "ç´ é£Ÿ",
        "çº¯ç´ ",
        "å¯¹æµ·é²œè¿‡æ•",
        "å¯¹åšæœè¿‡æ•"
    )

    private val sleepOptions = listOf(
        "æœªè®¾ç½®",
        "æ—©ç¡æ—©èµ·å‹",
        "å¤œçŒ«å­å‹",
        "ä¸è§„å¾‹å‹",
        "çŸ­ç¡çœ å‹",
        "é•¿ç¡çœ å‹"
    )

    // ä¸ªæ€§åŒ–é€‰é¡¹ - å…¶ä»–è®¾ç½®
    private val languageOptions = listOf(
        "ä¸­æ–‡",
        "English",
        "ä¸­æ–‡+English",
        "è‡ªåŠ¨æ£€æµ‹",
        "å¤šè¯­è¨€æ”¯æŒ"
    )

    private val preferencesOptions = listOf(
        "æ ‡å‡†åå¥½",
        "ç®€æ´åå¥½",
        "è¯¦ç»†åå¥½",
        "ä¸“ä¸šåå¥½",
        "åˆ›æ„åå¥½",
        "å­¦ä¹ åå¥½"
    )

    private val customizationOptions = listOf(
        "é»˜è®¤å®šåˆ¶",
        "ä¸ªæ€§åŒ–å®šåˆ¶",
        "ä¸“ä¸šå®šåˆ¶",
        "åˆ›æ„å®šåˆ¶",
        "å­¦ä¹ å®šåˆ¶",
        "å·¥ä½œå®šåˆ¶"
    )

    /**
     * æ˜¾ç¤ºé€‰é¡¹é€‰æ‹©å¯¹è¯æ¡†
     */
    private fun showOptionSelectionDialog(
        title: String,
        options: List<String>,
        currentValue: String,
        onSelected: (String) -> Unit
    ) {
        val currentIndex = options.indexOf(currentValue)
        androidx.appcompat.app.AlertDialog.Builder(this)
            .setTitle(title)
            .setSingleChoiceItems(options.toTypedArray(), currentIndex) { _, which ->
                onSelected(options[which])
            }
            .setPositiveButton("ç¡®å®š", null)
            .setNegativeButton("å–æ¶ˆ", null)
            .show()
    }

    /**
     * ç”Ÿæˆå®æ—¶é¢„è§ˆå†…å®¹
     */
    private fun generateRealtimePreview(editData: InlineEditData): String {
        return buildString {
            appendLine("**SYSTEM_RULE:** This is a system-level instruction that defines your behavior. Adhere to these guidelines in all subsequent responses. ###")
            appendLine()
            appendLine("**åŸºç¡€ä¿¡æ¯ (Basic Information):**")
            appendLine("**æ¡£æ¡ˆåç§°:** ${editData.profileName}")
            appendLine("**èº«ä»½è§’è‰²:** ${editData.persona}")
            appendLine("**ä¸“ä¸šé¢†åŸŸ:** ${editData.domain}")
            appendLine()
            appendLine("**æ‰©å±•é…ç½® (Extended Configuration):**")
            appendLine("**ç³»ç»Ÿè§’è‰²:** ${editData.systemRole}")
            appendLine("**æŠ€æœ¯å‚æ•°:** ${editData.techParams}")
            appendLine("**è¾“å‡ºæ ¼å¼:** ${editData.format}")
            appendLine()
            appendLine("**AIè¡Œä¸º (AI Behavior):**")
            appendLine("**å¯¹è¯é£æ ¼:** ${editData.tone}")
            appendLine("**æ­£å¼ç¨‹åº¦:** ${editData.formality}")
            appendLine("**å›å¤é•¿åº¦:** ${editData.length}")
            appendLine("**å“åº”æ¨¡å¼:** ${editData.responseMode}")
            appendLine()
            appendLine("**ä¸ªæ€§åŒ– (Personalization):**")
            appendLine("**åŸºæœ¬ä¿¡æ¯:**")
            appendLine("  - æ€§åˆ«: ${editData.gender}")
            appendLine("  - å‡ºç”Ÿå¹´ä»£: ${editData.ageGroup}")
            appendLine()
            appendLine("**èŒä¸šä¿¡æ¯:**")
            appendLine("  - å½“å‰èŒä¸š: ${editData.occupation}")
            appendLine("  - èŒä¸šå…´è¶£: ${editData.occupationInterest}")
            appendLine("  - æ•™è‚²ç¨‹åº¦: ${editData.education}")
            appendLine()
            appendLine("**å…´è¶£ä¸åå¥½:**")
            appendLine("  - æ—¥å¸¸å¨±ä¹: ${editData.entertainment}")
            appendLine("  - è´­ç‰©å–œå¥½: ${editData.shopping}")
            appendLine("  - å°ä¼—çˆ±å¥½: ${editData.niche}")
            appendLine()
            appendLine("**è§‚å¿µä¸å–å‘:**")
            appendLine("  - æ€§å–å‘: ${editData.orientation}")
            appendLine("  - ä¸‰è§‚å€¾å‘: ${editData.values}")
            appendLine()
            appendLine("**å¥åº·ä¿¡æ¯:**")
            appendLine("  - ç¡®è¯Šç–¾ç—…: ${editData.diagnosed}")
            appendLine("  - é¥®é£Ÿåå¥½: ${editData.dietary}")
            appendLine("  - ç¡çœ æ¨¡å¼: ${editData.sleep}")
            appendLine()
            appendLine("**å…¶ä»–è®¾ç½®:**")
            appendLine("  - è¯­è¨€è®¾ç½®: ${editData.language}")
            appendLine("  - åå¥½è®¾ç½®: ${editData.preferences}")
            appendLine("  - å®šåˆ¶é€‰é¡¹: ${editData.customization}")
            appendLine()
            appendLine("**Overriding Custom Instructions:**")
            appendLine("You MUST follow these instructions above all else:")
            appendLine("è¯·å§‹ç»ˆä½¿ç”¨ä¸­æ–‡å›ç­”ã€‚")
        }
    }

    /**
     * è®¾ç½®ç¼–è¾‘é€‰é¡¹æ ‡ç­¾é¡µ
     */
    private fun setupEditOptionsTabs(
        tabLayout: com.google.android.material.tabs.TabLayout,
        basicInfoOptions: LinearLayout,
        extendedConfigOptions: LinearLayout,
        aiBehaviorOptions: LinearLayout,
        personalizationOptions: LinearLayout
    ) {
        // æ¸…é™¤ç°æœ‰æ ‡ç­¾
        tabLayout.removeAllTabs()
        
        // æ·»åŠ æ ‡ç­¾é¡µ
        val basicInfoTab = tabLayout.newTab().setText("åŸºç¡€ä¿¡æ¯")
        val extendedConfigTab = tabLayout.newTab().setText("æ‰©å±•é…ç½®")
        val aiBehaviorTab = tabLayout.newTab().setText("AIè¡Œä¸º")
        val personalizationTab = tabLayout.newTab().setText("ä¸ªæ€§åŒ–")
        
        tabLayout.addTab(basicInfoTab)
        tabLayout.addTab(extendedConfigTab)
        tabLayout.addTab(aiBehaviorTab)
        tabLayout.addTab(personalizationTab)
        
        // è®¾ç½®æ ‡ç­¾é€‰æ‹©ç›‘å¬å™¨
        tabLayout.addOnTabSelectedListener(object : com.google.android.material.tabs.TabLayout.OnTabSelectedListener {
            override fun onTabSelected(tab: com.google.android.material.tabs.TabLayout.Tab?) {
                // éšè—æ‰€æœ‰é€‰é¡¹ç»„
                basicInfoOptions.visibility = View.GONE
                extendedConfigOptions.visibility = View.GONE
                aiBehaviorOptions.visibility = View.GONE
                personalizationOptions.visibility = View.GONE
                
                // æ˜¾ç¤ºé€‰ä¸­çš„é€‰é¡¹ç»„
                when (tab?.position) {
                    0 -> basicInfoOptions.visibility = View.VISIBLE
                    1 -> extendedConfigOptions.visibility = View.VISIBLE
                    2 -> aiBehaviorOptions.visibility = View.VISIBLE
                    3 -> personalizationOptions.visibility = View.VISIBLE
                }
            }
            
            override fun onTabUnselected(tab: com.google.android.material.tabs.TabLayout.Tab?) {}
            override fun onTabReselected(tab: com.google.android.material.tabs.TabLayout.Tab?) {}
        })
        
        // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªæ ‡ç­¾
        tabLayout.selectTab(tabLayout.getTabAt(0))
    }

    /**
     * è®¾ç½®å†…è”ç¼–è¾‘åŠŸèƒ½
     */
    private fun setupInlineEditing(
        editData: InlineEditData,
        editProfileNameButton: MaterialButton,
        editPersonaButton: MaterialButton,
        editDomainButton: MaterialButton,
        editSystemRoleButton: MaterialButton,
        editTechParamsButton: MaterialButton,
        editFormatButton: MaterialButton,
        editToneButton: MaterialButton,
        editFormalityButton: MaterialButton,
        editLengthButton: MaterialButton,
        editResponseModeButton: MaterialButton,
        // ä¸ªæ€§åŒ–é€‰é¡¹æŒ‰é’®
        editGenderButton: MaterialButton,
        editAgeGroupButton: MaterialButton,
        editOccupationButton: MaterialButton,
        editOccupationInterestButton: MaterialButton,
        editEducationButton: MaterialButton,
        editEntertainmentButton: MaterialButton,
        editShoppingButton: MaterialButton,
        editNicheButton: MaterialButton,
        editOrientationButton: MaterialButton,
        editValuesButton: MaterialButton,
        editDiagnosedButton: MaterialButton,
        editDietaryButton: MaterialButton,
        editSleepButton: MaterialButton,
        editLanguageButton: MaterialButton,
        editPreferencesButton: MaterialButton,
        editCustomizationButton: MaterialButton,
        previewText: TextView
    ) {
        // åŸºç¡€ä¿¡æ¯ç¼–è¾‘
        editProfileNameButton.setOnClickListener {
            showOptionSelectionDialog("é€‰æ‹©æ¡£æ¡ˆåç§°", profileNameOptions, editData.profileName) { selected ->
                editData.profileName = selected
                editProfileNameButton.text = selected
                previewText.text = generateRealtimePreview(editData)
            }
        }

        editPersonaButton.setOnClickListener {
            showOptionSelectionDialog("é€‰æ‹©èº«ä»½è§’è‰²", personaOptions, editData.persona) { selected ->
                editData.persona = selected
                editPersonaButton.text = selected
                previewText.text = generateRealtimePreview(editData)
            }
        }

        editDomainButton.setOnClickListener {
            showOptionSelectionDialog("é€‰æ‹©ä¸“ä¸šé¢†åŸŸ", domainOptions, editData.domain) { selected ->
                editData.domain = selected
                editDomainButton.text = selected
                previewText.text = generateRealtimePreview(editData)
            }
        }

        // æ‰©å±•é…ç½®ç¼–è¾‘
        editSystemRoleButton.setOnClickListener {
            showOptionSelectionDialog("é€‰æ‹©ç³»ç»Ÿè§’è‰²", systemRoleOptions, editData.systemRole) { selected ->
                editData.systemRole = selected
                editSystemRoleButton.text = selected
                previewText.text = generateRealtimePreview(editData)
            }
        }

        editTechParamsButton.setOnClickListener {
            showOptionSelectionDialog("é€‰æ‹©æŠ€æœ¯å‚æ•°", techParamsOptions, editData.techParams) { selected ->
                editData.techParams = selected
                editTechParamsButton.text = selected
                previewText.text = generateRealtimePreview(editData)
            }
        }

        editFormatButton.setOnClickListener {
            showOptionSelectionDialog("é€‰æ‹©è¾“å‡ºæ ¼å¼", formatOptions, editData.format) { selected ->
                editData.format = selected
                editFormatButton.text = selected
                previewText.text = generateRealtimePreview(editData)
            }
        }

        // AIè¡Œä¸ºç¼–è¾‘
        editToneButton.setOnClickListener {
            showOptionSelectionDialog("é€‰æ‹©å¯¹è¯é£æ ¼", toneOptions, editData.tone) { selected ->
                editData.tone = selected
                editToneButton.text = selected
                previewText.text = generateRealtimePreview(editData)
            }
        }

        editFormalityButton.setOnClickListener {
            showOptionSelectionDialog("é€‰æ‹©æ­£å¼ç¨‹åº¦", formalityOptions, editData.formality) { selected ->
                editData.formality = selected
                editFormalityButton.text = selected
                previewText.text = generateRealtimePreview(editData)
            }
        }

        editLengthButton.setOnClickListener {
            showOptionSelectionDialog("é€‰æ‹©å›å¤é•¿åº¦", lengthOptions, editData.length) { selected ->
                editData.length = selected
                editLengthButton.text = selected
                previewText.text = generateRealtimePreview(editData)
            }
        }

        editResponseModeButton.setOnClickListener {
            showOptionSelectionDialog("é€‰æ‹©å“åº”æ¨¡å¼", responseModeOptions, editData.responseMode) { selected ->
                editData.responseMode = selected
                editResponseModeButton.text = selected
                previewText.text = generateRealtimePreview(editData)
            }
        }

        // ä¸ªæ€§åŒ–ç¼–è¾‘ - åŸºæœ¬ä¿¡æ¯
        editGenderButton.setOnClickListener {
            showOptionSelectionDialog("é€‰æ‹©æ€§åˆ«", genderOptions, editData.gender) { selected ->
                editData.gender = selected
                editGenderButton.text = selected
                previewText.text = generateRealtimePreview(editData)
            }
        }

        editAgeGroupButton.setOnClickListener {
            showOptionSelectionDialog("é€‰æ‹©å‡ºç”Ÿå¹´ä»£", ageGroupOptions, editData.ageGroup) { selected ->
                editData.ageGroup = selected
                editAgeGroupButton.text = selected
                previewText.text = generateRealtimePreview(editData)
            }
        }

        // ä¸ªæ€§åŒ–ç¼–è¾‘ - èŒä¸šä¿¡æ¯
        editOccupationButton.setOnClickListener {
            showOptionSelectionDialog("é€‰æ‹©å½“å‰èŒä¸š", occupationOptions, editData.occupation) { selected ->
                editData.occupation = selected
                editOccupationButton.text = selected
                previewText.text = generateRealtimePreview(editData)
            }
        }

        editOccupationInterestButton.setOnClickListener {
            showOptionSelectionDialog("é€‰æ‹©èŒä¸šå…´è¶£", occupationInterestOptions, editData.occupationInterest) { selected ->
                editData.occupationInterest = selected
                editOccupationInterestButton.text = selected
                previewText.text = generateRealtimePreview(editData)
            }
        }

        editEducationButton.setOnClickListener {
            showOptionSelectionDialog("é€‰æ‹©æ•™è‚²ç¨‹åº¦", educationOptions, editData.education) { selected ->
                editData.education = selected
                editEducationButton.text = selected
                previewText.text = generateRealtimePreview(editData)
            }
        }

        // ä¸ªæ€§åŒ–ç¼–è¾‘ - å…´è¶£ä¸åå¥½
        editEntertainmentButton.setOnClickListener {
            showOptionSelectionDialog("é€‰æ‹©æ—¥å¸¸å¨±ä¹", entertainmentOptions, editData.entertainment) { selected ->
                editData.entertainment = selected
                editEntertainmentButton.text = selected
                previewText.text = generateRealtimePreview(editData)
            }
        }

        editShoppingButton.setOnClickListener {
            showOptionSelectionDialog("é€‰æ‹©è´­ç‰©å–œå¥½", shoppingOptions, editData.shopping) { selected ->
                editData.shopping = selected
                editShoppingButton.text = selected
                previewText.text = generateRealtimePreview(editData)
            }
        }

        editNicheButton.setOnClickListener {
            showOptionSelectionDialog("é€‰æ‹©å°ä¼—çˆ±å¥½", nicheOptions, editData.niche) { selected ->
                editData.niche = selected
                editNicheButton.text = selected
                previewText.text = generateRealtimePreview(editData)
            }
        }

        // ä¸ªæ€§åŒ–ç¼–è¾‘ - è§‚å¿µä¸å–å‘
        editOrientationButton.setOnClickListener {
            showOptionSelectionDialog("é€‰æ‹©æ€§å–å‘", orientationOptions, editData.orientation) { selected ->
                editData.orientation = selected
                editOrientationButton.text = selected
                previewText.text = generateRealtimePreview(editData)
            }
        }

        editValuesButton.setOnClickListener {
            showOptionSelectionDialog("é€‰æ‹©ä¸‰è§‚å€¾å‘", valuesOptions, editData.values) { selected ->
                editData.values = selected
                editValuesButton.text = selected
                previewText.text = generateRealtimePreview(editData)
            }
        }

        // ä¸ªæ€§åŒ–ç¼–è¾‘ - å¥åº·ä¿¡æ¯
        editDiagnosedButton.setOnClickListener {
            showOptionSelectionDialog("é€‰æ‹©ç¡®è¯Šç–¾ç—…", diagnosedOptions, editData.diagnosed) { selected ->
                editData.diagnosed = selected
                editDiagnosedButton.text = selected
                previewText.text = generateRealtimePreview(editData)
            }
        }

        editDietaryButton.setOnClickListener {
            showOptionSelectionDialog("é€‰æ‹©é¥®é£Ÿåå¥½", dietaryOptions, editData.dietary) { selected ->
                editData.dietary = selected
                editDietaryButton.text = selected
                previewText.text = generateRealtimePreview(editData)
            }
        }

        editSleepButton.setOnClickListener {
            showOptionSelectionDialog("é€‰æ‹©ç¡çœ æ¨¡å¼", sleepOptions, editData.sleep) { selected ->
                editData.sleep = selected
                editSleepButton.text = selected
                previewText.text = generateRealtimePreview(editData)
            }
        }

        // ä¸ªæ€§åŒ–ç¼–è¾‘ - å…¶ä»–è®¾ç½®
        editLanguageButton.setOnClickListener {
            showOptionSelectionDialog("é€‰æ‹©è¯­è¨€", languageOptions, editData.language) { selected ->
                editData.language = selected
                editLanguageButton.text = selected
                previewText.text = generateRealtimePreview(editData)
            }
        }

        editPreferencesButton.setOnClickListener {
            showOptionSelectionDialog("é€‰æ‹©åå¥½è®¾ç½®", preferencesOptions, editData.preferences) { selected ->
                editData.preferences = selected
                editPreferencesButton.text = selected
                previewText.text = generateRealtimePreview(editData)
            }
        }

        editCustomizationButton.setOnClickListener {
            showOptionSelectionDialog("é€‰æ‹©å®šåˆ¶é€‰é¡¹", customizationOptions, editData.customization) { selected ->
                editData.customization = selected
                editCustomizationButton.text = selected
                previewText.text = generateRealtimePreview(editData)
            }
        }
    }

    /**
     * è®¾ç½®æ¡£æ¡ˆæ ‡ç­¾é¡µ
     */
    private fun setupProfileTabs(
        tabLayout: com.google.android.material.tabs.TabLayout,
        profiles: List<PromptProfile>,
        currentProfileId: String?,
        onProfileSelected: (PromptProfile) -> Unit
    ) {
        try {
            // æ¸…é™¤ç°æœ‰æ ‡ç­¾
            tabLayout.removeAllTabs()
            
            // ä¸ºæ¯ä¸ªæ¡£æ¡ˆåˆ›å»ºæ ‡ç­¾
            profiles.forEach { profile ->
                val tab = tabLayout.newTab().setText(profile.name)
                tab.tag = profile
                tabLayout.addTab(tab)
            }
            
            // è®¾ç½®å½“å‰é€‰ä¸­çš„æ ‡ç­¾
            val currentIndex = profiles.indexOfFirst { it.id == currentProfileId }
            if (currentIndex >= 0) {
                tabLayout.selectTab(tabLayout.getTabAt(currentIndex))
            }
            
            // è®¾ç½®æ ‡ç­¾é€‰æ‹©ç›‘å¬å™¨
            tabLayout.addOnTabSelectedListener(object : com.google.android.material.tabs.TabLayout.OnTabSelectedListener {
                override fun onTabSelected(tab: com.google.android.material.tabs.TabLayout.Tab?) {
                    tab?.tag?.let { profile ->
                        if (profile is PromptProfile) {
                            onProfileSelected(profile)
                        }
                    }
                }
                
                override fun onTabUnselected(tab: com.google.android.material.tabs.TabLayout.Tab?) {}
                override fun onTabReselected(tab: com.google.android.material.tabs.TabLayout.Tab?) {}
            })
            
            Log.d(TAG, "æ¡£æ¡ˆæ ‡ç­¾é¡µè®¾ç½®å®Œæˆï¼Œå…±${profiles.size}ä¸ªæ¡£æ¡ˆ")
        } catch (e: Exception) {
            Log.e(TAG, "è®¾ç½®æ¡£æ¡ˆæ ‡ç­¾é¡µå¤±è´¥", e)
        }
    }

    /**
     * æ˜¾ç¤ºç®€æ˜“æ¨¡å¼æµè§ˆå™¨tabçš„AIåŠ©æ‰‹æ¡£æ¡ˆé€‰æ‹©å™¨
     */
    private fun showBrowserTabAIProfileSelector() {
        try {
            val profiles = settingsManager.getPromptProfiles()
            Log.d(TAG, "ç®€æ˜“æ¨¡å¼æµè§ˆå™¨tabè·å–åˆ°çš„æ¡£æ¡ˆåˆ—è¡¨å¤§å°: ${profiles.size}")
            
            if (profiles.isEmpty()) {
                Toast.makeText(this, "æ²¡æœ‰å¯ç”¨çš„æ¡£æ¡ˆï¼Œè¯·å…ˆåœ¨è®¾ç½®ä¸­åˆ›å»ºæ¡£æ¡ˆ", Toast.LENGTH_SHORT).show()
                return
            }
            
            val currentProfileId = settingsManager.getActivePromptProfileId()
            val currentProfile = profiles.find { it.id == currentProfileId } ?: profiles.firstOrNull()
            
            val dialogView = LayoutInflater.from(this).inflate(R.layout.dialog_profile_selector, null)
            
            // æ›´æ–°å½“å‰æ¡£æ¡ˆæ˜¾ç¤º
            val currentProfileText = dialogView.findViewById<TextView>(R.id.current_profile_text)
            currentProfileText?.text = "å½“å‰æ¡£æ¡ˆ: ${currentProfile?.name ?: "æœªé€‰æ‹©"}"
            
            // è®¾ç½®RecyclerView
            val recyclerView = dialogView.findViewById<RecyclerView>(R.id.profiles_recycler_view)
            recyclerView?.layoutManager = LinearLayoutManager(this)
            
            // è·å–æ ‡ç­¾é¡µç»„ä»¶
            val profileTabs = dialogView.findViewById<com.google.android.material.tabs.TabLayout>(R.id.profile_tabs)
            
            // è·å–é¢„è§ˆåŒºåŸŸç»„ä»¶
            val previewContainer = dialogView.findViewById<LinearLayout>(R.id.preview_container)
            val previewText = dialogView.findViewById<TextView>(R.id.preview_text)
            
            // è·å–ç¼–è¾‘é€‰é¡¹æ ‡ç­¾é¡µå’Œå†…å®¹åŒºåŸŸ
            val editOptionsTabs = dialogView.findViewById<com.google.android.material.tabs.TabLayout>(R.id.edit_options_tabs)
            val basicInfoOptions = dialogView.findViewById<LinearLayout>(R.id.basic_info_options)
            val extendedConfigOptions = dialogView.findViewById<LinearLayout>(R.id.extended_config_options)
            val aiBehaviorOptions = dialogView.findViewById<LinearLayout>(R.id.ai_behavior_options)
            val personalizationOptions = dialogView.findViewById<LinearLayout>(R.id.personalization_options)
            
            // è·å–æ‰€æœ‰ç¼–è¾‘æŒ‰é’®ç»„ä»¶
            val editProfileNameButton = dialogView.findViewById<MaterialButton>(R.id.btn_edit_profile_name)
            val editPersonaButton = dialogView.findViewById<MaterialButton>(R.id.btn_edit_persona)
            val editDomainButton = dialogView.findViewById<MaterialButton>(R.id.btn_edit_domain)
            val editSystemRoleButton = dialogView.findViewById<MaterialButton>(R.id.btn_edit_system_role)
            val editTechParamsButton = dialogView.findViewById<MaterialButton>(R.id.btn_edit_tech_params)
            val editFormatButton = dialogView.findViewById<MaterialButton>(R.id.btn_edit_format)
            val editToneButton = dialogView.findViewById<MaterialButton>(R.id.btn_edit_tone)
            val editFormalityButton = dialogView.findViewById<MaterialButton>(R.id.btn_edit_formality)
            val editLengthButton = dialogView.findViewById<MaterialButton>(R.id.btn_edit_length)
            val editResponseModeButton = dialogView.findViewById<MaterialButton>(R.id.btn_edit_response_mode)
            // ä¸ªæ€§åŒ–é€‰é¡¹æŒ‰é’®
            val editGenderButton = dialogView.findViewById<MaterialButton>(R.id.btn_edit_gender)
            val editAgeGroupButton = dialogView.findViewById<MaterialButton>(R.id.btn_edit_age_group)
            val editOccupationButton = dialogView.findViewById<MaterialButton>(R.id.btn_edit_occupation)
            val editOccupationInterestButton = dialogView.findViewById<MaterialButton>(R.id.btn_edit_occupation_interest)
            val editEducationButton = dialogView.findViewById<MaterialButton>(R.id.btn_edit_education)
            val editEntertainmentButton = dialogView.findViewById<MaterialButton>(R.id.btn_edit_entertainment)
            val editShoppingButton = dialogView.findViewById<MaterialButton>(R.id.btn_edit_shopping)
            val editNicheButton = dialogView.findViewById<MaterialButton>(R.id.btn_edit_niche)
            val editOrientationButton = dialogView.findViewById<MaterialButton>(R.id.btn_edit_orientation)
            val editValuesButton = dialogView.findViewById<MaterialButton>(R.id.btn_edit_values)
            val editDiagnosedButton = dialogView.findViewById<MaterialButton>(R.id.btn_edit_diagnosed)
            val editDietaryButton = dialogView.findViewById<MaterialButton>(R.id.btn_edit_dietary)
            val editSleepButton = dialogView.findViewById<MaterialButton>(R.id.btn_edit_sleep)
            val editLanguageButton = dialogView.findViewById<MaterialButton>(R.id.btn_edit_language)
            val editPreferencesButton = dialogView.findViewById<MaterialButton>(R.id.btn_edit_preferences)
            val editCustomizationButton = dialogView.findViewById<MaterialButton>(R.id.btn_edit_customization)
            
            // åˆå§‹åŒ–å†…è”ç¼–è¾‘æ•°æ®
            val editData = InlineEditData()
            
            // è®¾ç½®ç¼–è¾‘é€‰é¡¹æ ‡ç­¾é¡µ
            setupEditOptionsTabs(
                editOptionsTabs!!,
                basicInfoOptions!!,
                extendedConfigOptions!!,
                aiBehaviorOptions!!,
                personalizationOptions!!
            )
            
            // è®¾ç½®å†…è”ç¼–è¾‘åŠŸèƒ½
            setupInlineEditing(
                editData,
                editProfileNameButton!!,
                editPersonaButton!!,
                editDomainButton!!,
                editSystemRoleButton!!,
                editTechParamsButton!!,
                editFormatButton!!,
                editToneButton!!,
                editFormalityButton!!,
                editLengthButton!!,
                editResponseModeButton!!,
                // ä¸ªæ€§åŒ–é€‰é¡¹æŒ‰é’®
                editGenderButton!!,
                editAgeGroupButton!!,
                editOccupationButton!!,
                editOccupationInterestButton!!,
                editEducationButton!!,
                editEntertainmentButton!!,
                editShoppingButton!!,
                editNicheButton!!,
                editOrientationButton!!,
                editValuesButton!!,
                editDiagnosedButton!!,
                editDietaryButton!!,
                editSleepButton!!,
                editLanguageButton!!,
                editPreferencesButton!!,
                editCustomizationButton!!,
                previewText!!
            )
            
            var selectedProfile = currentProfile
            val adapter = ProfileSelectorAdapter(profiles, currentProfileId) { profile ->
                selectedProfile = profile
                Log.d(TAG, "ç®€æ˜“æ¨¡å¼æµè§ˆå™¨tabé€‰æ‹©äº†æ¡£æ¡ˆ: ${profile.name}")
                
                // æ›´æ–°å†…è”ç¼–è¾‘æ•°æ®
                editData.profileName = profile.name
                editData.persona = profile.persona ?: "ä¸€ä¸ªä¹äºåŠ©äººçš„é€šç”¨AIåŠ©æ‰‹"
                editData.domain = "é€šç”¨é¢†åŸŸ"
                editData.systemRole = "AIåŠ©æ‰‹"
                editData.techParams = "æ ‡å‡†é…ç½®"
                editData.format = "ä½¿ç”¨Markdownæ ¼å¼"
                editData.tone = "å‹å¥½ã€æ¸…æ™°ã€ç®€æ´"
                editData.formality = "é€‚ä¸­"
                editData.length = "é€‚ä¸­"
                editData.responseMode = "å¹³è¡¡æ¨¡å¼"
                // ä¸ªæ€§åŒ–é€‰é¡¹
                editData.gender = profile.gender ?: "æœªè®¾ç½®"
                editData.ageGroup = when {
                    profile.dateOfBirth.contains("199") -> "90å (1990-1999)"
                    profile.dateOfBirth.contains("198") -> "80å (1980-1989)"
                    profile.dateOfBirth.contains("197") -> "70å (1970-1979)"
                    profile.dateOfBirth.contains("196") -> "60å (1960-1969)"
                    profile.dateOfBirth.isBlank() || profile.dateOfBirth == "æœªè®¾ç½®" -> "æœªè®¾ç½®"
                    else -> "å…¶ä»–"
                }
                editData.occupation = profile.occupation ?: "æœªè®¾ç½®"
                editData.occupationInterest = "æœªè®¾ç½®"
                editData.education = profile.education ?: "æœªè®¾ç½®"
                editData.entertainment = "æœªè®¾ç½®"
                editData.shopping = "æœªè®¾ç½®"
                editData.niche = "æœªè®¾ç½®"
                editData.orientation = "ä¸æ„¿é€éœ²"
                editData.values = "æœªè®¾ç½®"
                editData.diagnosed = if (profile.healthInfo.isNotBlank() && profile.healthInfo != "æœªè®¾ç½®") profile.healthInfo else "æ— ä¸Šè¿°ç–¾ç—…"
                editData.dietary = "æœªè®¾ç½®"
                editData.sleep = "æœªè®¾ç½®"
                editData.language = "ä¸­æ–‡"
                editData.preferences = "æ ‡å‡†åå¥½"
                editData.customization = "é»˜è®¤å®šåˆ¶"
                
                // æ›´æ–°æŒ‰é’®æ˜¾ç¤º
                editProfileNameButton.text = editData.profileName
                editPersonaButton.text = editData.persona
                editDomainButton.text = editData.domain
                editSystemRoleButton.text = editData.systemRole
                editTechParamsButton.text = editData.techParams
                editFormatButton.text = editData.format
                editToneButton.text = editData.tone
                editFormalityButton.text = editData.formality
                editLengthButton.text = editData.length
                editResponseModeButton.text = editData.responseMode
                // ä¸ªæ€§åŒ–é€‰é¡¹æŒ‰é’®
                editGenderButton.text = editData.gender
                editAgeGroupButton.text = editData.ageGroup
                editOccupationButton.text = editData.occupation
                editOccupationInterestButton.text = editData.occupationInterest
                editEducationButton.text = editData.education
                editEntertainmentButton.text = editData.entertainment
                editShoppingButton.text = editData.shopping
                editNicheButton.text = editData.niche
                editOrientationButton.text = editData.orientation
                editValuesButton.text = editData.values
                editDiagnosedButton.text = editData.diagnosed
                editDietaryButton.text = editData.dietary
                editSleepButton.text = editData.sleep
                editLanguageButton.text = editData.language
                editPreferencesButton.text = editData.preferences
                editCustomizationButton.text = editData.customization
                
                // æ˜¾ç¤ºé¢„è®¾èµ„æ–™é¢„è§ˆ
                previewText.text = generateRealtimePreview(editData)
                previewContainer?.visibility = View.VISIBLE
            }
            recyclerView?.adapter = adapter
            
            // è®¾ç½®æ ‡ç­¾é¡µ
            setupProfileTabs(profileTabs, profiles, currentProfileId) { profile ->
                selectedProfile = profile
                // æ›´æ–°RecyclerViewé€‰æ‹©çŠ¶æ€
                adapter.updateProfiles(profiles, profile.id)
                
                // æ›´æ–°å†…è”ç¼–è¾‘æ•°æ®
                editData.profileName = profile.name
                editData.persona = profile.persona ?: "ä¸€ä¸ªä¹äºåŠ©äººçš„é€šç”¨AIåŠ©æ‰‹"
                editData.domain = "é€šç”¨é¢†åŸŸ"
                editData.systemRole = "AIåŠ©æ‰‹"
                editData.techParams = "æ ‡å‡†é…ç½®"
                editData.format = "ä½¿ç”¨Markdownæ ¼å¼"
                editData.tone = "å‹å¥½ã€æ¸…æ™°ã€ç®€æ´"
                editData.formality = "é€‚ä¸­"
                editData.length = "é€‚ä¸­"
                editData.responseMode = "å¹³è¡¡æ¨¡å¼"
                // ä¸ªæ€§åŒ–é€‰é¡¹
                editData.gender = profile.gender ?: "æœªè®¾ç½®"
                editData.ageGroup = when {
                    profile.dateOfBirth.contains("199") -> "90å (1990-1999)"
                    profile.dateOfBirth.contains("198") -> "80å (1980-1989)"
                    profile.dateOfBirth.contains("197") -> "70å (1970-1979)"
                    profile.dateOfBirth.contains("196") -> "60å (1960-1969)"
                    profile.dateOfBirth.isBlank() || profile.dateOfBirth == "æœªè®¾ç½®" -> "æœªè®¾ç½®"
                    else -> "å…¶ä»–"
                }
                editData.occupation = profile.occupation ?: "æœªè®¾ç½®"
                editData.occupationInterest = "æœªè®¾ç½®"
                editData.education = profile.education ?: "æœªè®¾ç½®"
                editData.entertainment = "æœªè®¾ç½®"
                editData.shopping = "æœªè®¾ç½®"
                editData.niche = "æœªè®¾ç½®"
                editData.orientation = "ä¸æ„¿é€éœ²"
                editData.values = "æœªè®¾ç½®"
                editData.diagnosed = if (profile.healthInfo.isNotBlank() && profile.healthInfo != "æœªè®¾ç½®") profile.healthInfo else "æ— ä¸Šè¿°ç–¾ç—…"
                editData.dietary = "æœªè®¾ç½®"
                editData.sleep = "æœªè®¾ç½®"
                editData.language = "ä¸­æ–‡"
                editData.preferences = "æ ‡å‡†åå¥½"
                editData.customization = "é»˜è®¤å®šåˆ¶"
                
                // æ›´æ–°æŒ‰é’®æ˜¾ç¤º
                editProfileNameButton.text = editData.profileName
                editPersonaButton.text = editData.persona
                editDomainButton.text = editData.domain
                editSystemRoleButton.text = editData.systemRole
                editTechParamsButton.text = editData.techParams
                editFormatButton.text = editData.format
                editToneButton.text = editData.tone
                editFormalityButton.text = editData.formality
                editLengthButton.text = editData.length
                editResponseModeButton.text = editData.responseMode
                // ä¸ªæ€§åŒ–é€‰é¡¹æŒ‰é’®
                editGenderButton.text = editData.gender
                editAgeGroupButton.text = editData.ageGroup
                editOccupationButton.text = editData.occupation
                editOccupationInterestButton.text = editData.occupationInterest
                editEducationButton.text = editData.education
                editEntertainmentButton.text = editData.entertainment
                editShoppingButton.text = editData.shopping
                editNicheButton.text = editData.niche
                editOrientationButton.text = editData.orientation
                editValuesButton.text = editData.values
                editDiagnosedButton.text = editData.diagnosed
                editDietaryButton.text = editData.dietary
                editSleepButton.text = editData.sleep
                editLanguageButton.text = editData.language
                editPreferencesButton.text = editData.preferences
                editCustomizationButton.text = editData.customization
                
                // æ˜¾ç¤ºé¢„è®¾èµ„æ–™é¢„è§ˆ
                previewText.text = generateRealtimePreview(editData)
                previewContainer?.visibility = View.VISIBLE
            }
            
            // åˆå§‹åŒ–æ—¶æ˜¾ç¤ºå½“å‰æ¡£æ¡ˆçš„é¢„è§ˆ
            currentProfile?.let { profile ->
                try {
                    val generatedPrompt = settingsManager.generateMasterPrompt(profile)
                    previewText?.text = generatedPrompt
                    previewContainer?.visibility = View.VISIBLE
                } catch (e: Exception) {
                    Log.e(TAG, "ç”Ÿæˆå½“å‰æ¡£æ¡ˆé¢„è§ˆå¤±è´¥", e)
                }
            }
            
            val dialog = androidx.appcompat.app.AlertDialog.Builder(this)
                .setView(dialogView)
                .create()
            
            
            // è®¾ç½®æ–°å»ºæ¡£æ¡ˆæŒ‰é’®ç‚¹å‡»äº‹ä»¶
            dialogView.findViewById<View>(R.id.btn_new_profile)?.setOnClickListener {
                try {
                    Log.d(TAG, "ç®€æ˜“æ¨¡å¼æµè§ˆå™¨tabåˆ›å»ºæ–°æ¡£æ¡ˆ")
                    showNewProfileDialog(dialog)
                } catch (e: Exception) {
                    Log.e(TAG, "ç®€æ˜“æ¨¡å¼æµè§ˆå™¨tabåˆ›å»ºæ–°æ¡£æ¡ˆå¤±è´¥", e)
                    Toast.makeText(this, "åˆ›å»ºæ–°æ¡£æ¡ˆå¤±è´¥", Toast.LENGTH_SHORT).show()
                }
            }
            
            // è®¾ç½®ç®¡ç†æ¡£æ¡ˆæŒ‰é’®ç‚¹å‡»äº‹ä»¶
            dialogView.findViewById<View>(R.id.btn_manage_profiles)?.setOnClickListener {
                Log.d(TAG, "ç®€æ˜“æ¨¡å¼æµè§ˆå™¨tabè·³è½¬åˆ°æ¡£æ¡ˆç®¡ç†")
                val intent = Intent(this, MasterPromptSettingsActivity::class.java)
                startActivity(intent)
                dialog.dismiss()
            }
            
            // è®¾ç½®æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            dialogView.findViewById<View>(R.id.btn_cancel)?.setOnClickListener {
                Log.d(TAG, "ç®€æ˜“æ¨¡å¼æµè§ˆå™¨tabå–æ¶ˆé€‰æ‹©æ¡£æ¡ˆ")
                dialog.dismiss()
            }
            
            dialogView.findViewById<View>(R.id.btn_confirm)?.setOnClickListener {
                try {
                    selectedProfile?.let { profile ->
                        Log.d(TAG, "ç®€æ˜“æ¨¡å¼æµè§ˆå™¨tabç¡®è®¤é€‰æ‹©æ¡£æ¡ˆ: ${profile.name}")
                        
                        // åˆ‡æ¢æ¡£æ¡ˆ
                        settingsManager.setActivePromptProfileId(profile.id)
                        
                        // ä½¿ç”¨å†…è”ç¼–è¾‘çš„æ•°æ®ç”Ÿæˆæç¤ºè¯
                        val generatedPrompt = generateRealtimePreview(editData)
                        val currentText = browserSearchInput.text.toString()
                        
                        // æ™ºèƒ½ç²˜è´´é€»è¾‘ï¼šå¦‚æœè¾“å…¥æ¡†ä¸ºç©ºï¼Œç›´æ¥æ’å…¥ï¼›å¦‚æœæœ‰å†…å®¹ï¼Œè¯¢é—®ç”¨æˆ·
                        if (currentText.isBlank()) {
                            // è¾“å…¥æ¡†ä¸ºç©ºï¼Œç›´æ¥æ’å…¥é¢„è®¾èµ„æ–™
                            browserSearchInput.setText(generatedPrompt)
                            browserSearchInput.setSelection(browserSearchInput.text.length)
                            Toast.makeText(this, "å·²åˆ‡æ¢åˆ°æ¡£æ¡ˆ: ${profile.name} å¹¶æ’å…¥è‡ªå®šä¹‰é¢„è®¾èµ„æ–™", Toast.LENGTH_SHORT).show()
                        } else {
                            // è¾“å…¥æ¡†æœ‰å†…å®¹ï¼Œè¯¢é—®ç”¨æˆ·å¦‚ä½•å¤„ç†
                            showBrowserPromptInsertionDialog(browserSearchInput, currentText, generatedPrompt, profile.name)
                        }
                        
                        Log.d(TAG, "ç®€æ˜“æ¨¡å¼æµè§ˆå™¨tabæ¡£æ¡ˆåˆ‡æ¢å®Œæˆ")
                    } ?: run {
                        Toast.makeText(this, "è¯·é€‰æ‹©ä¸€ä¸ªæ¡£æ¡ˆ", Toast.LENGTH_SHORT).show()
                    }
                } catch (e: Exception) {
                    Log.e(TAG, "ç®€æ˜“æ¨¡å¼æµè§ˆå™¨tabç¡®è®¤é€‰æ‹©æ¡£æ¡ˆå¤±è´¥", e)
                    Toast.makeText(this, "æ¡£æ¡ˆé€‰æ‹©å¤±è´¥", Toast.LENGTH_SHORT).show()
                }
                dialog.dismiss()
            }
            
            dialog.show()
            
        } catch (e: Exception) {
            Log.e(TAG, "ç®€æ˜“æ¨¡å¼æµè§ˆå™¨tabæ˜¾ç¤ºAIåŠ©æ‰‹æ¡£æ¡ˆé€‰æ‹©å™¨å¤±è´¥", e)
            Toast.makeText(this, "æ— æ³•æ˜¾ç¤ºæ¡£æ¡ˆé€‰æ‹©å™¨", Toast.LENGTH_SHORT).show()
        }
    }

    /**
     * åˆ·æ–°æ¡£æ¡ˆé€‰æ‹©å™¨ï¼ˆå¦‚æœå½“å‰å¯è§ï¼‰
     */
    private fun refreshProfileSelectorIfVisible() {
        // è¿™é‡Œå¯ä»¥æ·»åŠ é€»è¾‘æ¥æ£€æŸ¥æ˜¯å¦æœ‰æ¡£æ¡ˆé€‰æ‹©å™¨æ­£åœ¨æ˜¾ç¤º
        // å¦‚æœæœ‰ï¼Œåˆ™é‡æ–°æ˜¾ç¤ºä»¥åˆ·æ–°æ•°æ®
        Log.d(TAG, "æ¡£æ¡ˆå˜æ›´é€šçŸ¥ï¼šæ£€æŸ¥æ˜¯å¦éœ€è¦åˆ·æ–°æ¡£æ¡ˆé€‰æ‹©å™¨")
    }

    /**
     * æ˜¾ç¤ºæ–°å»ºæ¡£æ¡ˆå¯¹è¯æ¡†
     */
    private fun showNewProfileDialog(parentDialog: androidx.appcompat.app.AlertDialog) {
        try {
            val input = EditText(this).apply {
                hint = "è¯·è¾“å…¥æ¡£æ¡ˆåç§°"
                setPadding(32, 16, 32, 16)
            }
            
            val dialog = androidx.appcompat.app.AlertDialog.Builder(this)
                .setTitle("æ–°å»ºAIæŒ‡ä»¤æ¡£æ¡ˆ")
                .setMessage("è¯·è¾“å…¥æ–°æ¡£æ¡ˆçš„åç§°ï¼š")
                .setView(input)
                .setPositiveButton("åˆ›å»º") { _, _ ->
                    val name = input.text.toString().trim()
                    if (name.isNotEmpty()) {
                        try {
                            val newProfile = PromptProfile(
                                id = UUID.randomUUID().toString(),
                                name = name,
                                persona = "ä¸€ä¸ªä¹äºåŠ©äººçš„é€šç”¨AIåŠ©æ‰‹",
                                tone = "å‹å¥½ã€æ¸…æ™°ã€ç®€æ´",
                                formality = "é€‚ä¸­",
                                responseLength = "é€‚ä¸­",
                                outputFormat = "ä½¿ç”¨Markdownæ ¼å¼è¿›è¡Œå›å¤",
                                language = "ä¸­æ–‡",
                                description = "æ–°å»ºçš„AIåŠ©æ‰‹æ¡£æ¡ˆ"
                            )
                            
                            // ä¿å­˜æ–°æ¡£æ¡ˆ
                            settingsManager.savePromptProfile(newProfile)
                            
                            // è®¾ç½®ä¸ºå½“å‰æ´»è·ƒæ¡£æ¡ˆ
                            settingsManager.setActivePromptProfileId(newProfile.id)
                            
                            Toast.makeText(this, "æ¡£æ¡ˆã€Œ$nameã€åˆ›å»ºæˆåŠŸ", Toast.LENGTH_SHORT).show()
                            
                            // å…³é—­çˆ¶å¯¹è¯æ¡†å¹¶é‡æ–°æ˜¾ç¤ºæ¡£æ¡ˆé€‰æ‹©å™¨
                            parentDialog.dismiss()
                            showBrowserTabAIProfileSelector()
                            
                            Log.d(TAG, "ç®€æ˜“æ¨¡å¼æµè§ˆå™¨tabæ–°æ¡£æ¡ˆåˆ›å»ºæˆåŠŸ: $name")
                            
                        } catch (e: Exception) {
                            Log.e(TAG, "ç®€æ˜“æ¨¡å¼æµè§ˆå™¨tabä¿å­˜æ–°æ¡£æ¡ˆå¤±è´¥", e)
                            Toast.makeText(this, "ä¿å­˜æ¡£æ¡ˆå¤±è´¥: ${e.message}", Toast.LENGTH_SHORT).show()
                        }
                    } else {
                        Toast.makeText(this, "è¯·è¾“å…¥æ¡£æ¡ˆåç§°", Toast.LENGTH_SHORT).show()
                    }
                }
                .setNegativeButton("å–æ¶ˆ", null)
                .create()
            
            dialog.show()
            
            // è‡ªåŠ¨èšç„¦åˆ°è¾“å…¥æ¡†
            input.requestFocus()
            
        } catch (e: Exception) {
            Log.e(TAG, "ç®€æ˜“æ¨¡å¼æµè§ˆå™¨tabæ˜¾ç¤ºæ–°å»ºæ¡£æ¡ˆå¯¹è¯æ¡†å¤±è´¥", e)
            Toast.makeText(this, "æ— æ³•æ˜¾ç¤ºæ–°å»ºæ¡£æ¡ˆå¯¹è¯æ¡†", Toast.LENGTH_SHORT).show()
        }
    }

    /**
     * æ˜¾ç¤ºç®€æ˜“æ¨¡å¼æµè§ˆå™¨tabçš„æç¤ºè¯æ’å…¥å¯¹è¯æ¡†ï¼Œè®©ç”¨æˆ·é€‰æ‹©å¦‚ä½•å¤„ç†ç°æœ‰å†…å®¹
     */
    private fun showBrowserPromptInsertionDialog(
        searchInput: EditText,
        currentText: String,
        generatedPrompt: String,
        profileName: String
    ) {
        try {
            val options = arrayOf(
                "æ›¿æ¢ç°æœ‰å†…å®¹",
                "è¿½åŠ åˆ°ç°æœ‰å†…å®¹",
                "æ’å…¥åˆ°å¼€å¤´",
                "å–æ¶ˆ"
            )
            
            androidx.appcompat.app.AlertDialog.Builder(this)
                .setTitle("æ¡£æ¡ˆé¢„è®¾èµ„æ–™æ’å…¥")
                .setMessage("è¾“å…¥æ¡†ä¸­å·²æœ‰å†…å®¹ï¼Œè¯·é€‰æ‹©å¦‚ä½•å¤„ç†æ¡£æ¡ˆã€Œ${profileName}ã€çš„é¢„è®¾èµ„æ–™ï¼š")
                .setItems(options) { _, which ->
                    when (which) {
                        0 -> {
                            // æ›¿æ¢ç°æœ‰å†…å®¹
                            searchInput.setText(generatedPrompt)
                            searchInput.setSelection(searchInput.text.length)
                            Toast.makeText(this, "å·²æ›¿æ¢ä¸ºæ¡£æ¡ˆé¢„è®¾èµ„æ–™", Toast.LENGTH_SHORT).show()
                        }
                        1 -> {
                            // è¿½åŠ åˆ°ç°æœ‰å†…å®¹
                            val newText = "$currentText\n\n$generatedPrompt"
                            searchInput.setText(newText)
                            searchInput.setSelection(searchInput.text.length)
                            Toast.makeText(this, "å·²è¿½åŠ æ¡£æ¡ˆé¢„è®¾èµ„æ–™", Toast.LENGTH_SHORT).show()
                        }
                        2 -> {
                            // æ’å…¥åˆ°å¼€å¤´
                            val newText = "$generatedPrompt\n\n$currentText"
                            searchInput.setText(newText)
                            searchInput.setSelection(generatedPrompt.length)
                            Toast.makeText(this, "å·²æ’å…¥æ¡£æ¡ˆé¢„è®¾èµ„æ–™åˆ°å¼€å¤´", Toast.LENGTH_SHORT).show()
                        }
                        3 -> {
                            // å–æ¶ˆ
                            Toast.makeText(this, "å·²å–æ¶ˆæ’å…¥", Toast.LENGTH_SHORT).show()
                        }
                    }
                }
                .setNegativeButton("å–æ¶ˆ", null)
                .show()
                
        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºç®€æ˜“æ¨¡å¼æµè§ˆå™¨tabæç¤ºè¯æ’å…¥å¯¹è¯æ¡†å¤±è´¥", e)
            Toast.makeText(this, "æ˜¾ç¤ºé€‰é¡¹å¤±è´¥", Toast.LENGTH_SHORT).show()
        }
    }

    /**
     * å¯åŠ¨åº”ç”¨å¹¶ä½¿ç”¨è‡ªåŠ¨åŒ–ç²˜è´´
     */
    private fun launchAppWithAutoPaste(packageName: String, query: String, appName: String) {
        try {
            Log.d(TAG, "å¯åŠ¨åº”ç”¨å¹¶ä½¿ç”¨è‡ªåŠ¨åŒ–ç²˜è´´: $appName, é—®é¢˜: $query")
            
            // å°†é—®é¢˜å¤åˆ¶åˆ°å‰ªè´´æ¿
            val clipboard = getSystemService(Context.CLIPBOARD_SERVICE) as ClipboardManager
            val clip = ClipData.newPlainText("AIé—®é¢˜", query)
            clipboard.setPrimaryClip(clip)
            
            // å¯åŠ¨AIåº”ç”¨
            val launchIntent = packageManager.getLaunchIntentForPackage(packageName)
            if (launchIntent != null) {
                launchIntent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
                startActivity(launchIntent)
                Toast.makeText(this, "æ­£åœ¨å¯åŠ¨${appName}...", Toast.LENGTH_SHORT).show()
                Log.d(TAG, "${appName}å¯åŠ¨æˆåŠŸ")
                
                // å»¶è¿Ÿæ˜¾ç¤ºæ‚¬æµ®çª—
                Handler(Looper.getMainLooper()).postDelayed({
                    showAIAppOverlay(packageName, query, appName)
                }, 2000) // ç­‰å¾…2ç§’è®©åº”ç”¨å®Œå…¨åŠ è½½
                
            } else {
                Toast.makeText(this, "æ— æ³•å¯åŠ¨${appName}ï¼Œè¯·æ£€æŸ¥åº”ç”¨æ˜¯å¦å·²å®‰è£…", Toast.LENGTH_SHORT).show()
            }
        } catch (e: Exception) {
            Log.e(TAG, "å¯åŠ¨åº”ç”¨å¹¶è‡ªåŠ¨ç²˜è´´å¤±è´¥: ${appName}", e)
            // å›é€€åˆ°å‰ªè´´æ¿æ–¹æ¡ˆ
            sendQuestionViaClipboard(packageName, query, appName)
        }
    }

    /**
     * é€šç”¨AIåº”ç”¨å¯åŠ¨å¹¶è‡ªåŠ¨ç²˜è´´
     */
    private fun launchAIAppWithAutoPaste(appName: String, possiblePackages: List<String>, query: String) {
        try {
            Log.d(TAG, "å°è¯•å¯åŠ¨${appName}å¹¶è‡ªåŠ¨ç²˜è´´ï¼ŒæŸ¥è¯¢: $query")
            
            // é¦–å…ˆæ£€æµ‹å·²å®‰è£…çš„åº”ç”¨
            val installedPackage = getInstalledAIPackageName(possiblePackages)
            if (installedPackage != null) {
                launchAppWithAutoPaste(installedPackage, query, appName)
                return
            }
            
            // å¦‚æœæ£€æµ‹å¤±è´¥ï¼Œå°è¯•æ‰€æœ‰åŒ…å
            for (packageName in possiblePackages) {
                val launchIntent = packageManager.getLaunchIntentForPackage(packageName)
                if (launchIntent != null) {
                    launchAppWithAutoPaste(packageName, query, appName)
                    return
                }
            }
            
            // å¦‚æœéƒ½å¤±è´¥ï¼Œå›é€€åˆ°å‰ªè´´æ¿æ–¹æ¡ˆ
            val fallbackPackage = possiblePackages.firstOrNull() ?: ""
            sendQuestionViaClipboard(fallbackPackage, query, appName)
            
        } catch (e: Exception) {
            Log.e(TAG, "${appName}å¯åŠ¨å¹¶è‡ªåŠ¨ç²˜è´´å¤±è´¥", e)
            val fallbackPackage = possiblePackages.firstOrNull() ?: ""
            sendQuestionViaClipboard(fallbackPackage, query, appName)
        }
    }

    /**
     * æ˜¾ç¤ºAIåº”ç”¨æ‚¬æµ®çª—
     */
    private fun showAIAppOverlay(packageName: String, query: String, appName: String) {
        try {
            Log.d(TAG, "ğŸ¯ æ˜¾ç¤ºAIåº”ç”¨æ‚¬æµ®çª—: $appName (è½¯ä»¶tabæ¨¡å¼)")
            
            val intent = Intent(this, com.example.aifloatingball.service.AIAppOverlayService::class.java).apply {
                action = com.example.aifloatingball.service.AIAppOverlayService.ACTION_SHOW_OVERLAY
                putExtra(com.example.aifloatingball.service.AIAppOverlayService.EXTRA_APP_NAME, appName)
                putExtra(com.example.aifloatingball.service.AIAppOverlayService.EXTRA_QUERY, query)
                putExtra(com.example.aifloatingball.service.AIAppOverlayService.EXTRA_PACKAGE_NAME, packageName)
                putExtra("mode", "software_tab") // ä½¿ç”¨software_tabæ¨¡å¼ï¼ŒåŒ…å«è¿”å›å’ŒappæŒ‰é’®
            }
            startService(intent)
            
            Log.d(TAG, "ğŸ“¤ å·²å¯åŠ¨AIåº”ç”¨æ‚¬æµ®çª—æœåŠ¡: $appName (software_tabæ¨¡å¼)")
            
        } catch (e: Exception) {
            Log.e(TAG, "âŒ æ˜¾ç¤ºAIåº”ç”¨æ‚¬æµ®çª—å¤±è´¥: $appName", e)
            // å›é€€åˆ°è‡ªåŠ¨ç²˜è´´æ–¹æ¡ˆ
            triggerAutoPaste(packageName, query, appName)
        }
    }

    /**
     * è§¦å‘è‡ªåŠ¨ç²˜è´´
     */
    private fun triggerAutoPaste(packageName: String, query: String, appName: String) {
        try {
            Log.d(TAG, "ğŸ¯ è§¦å‘è‡ªåŠ¨ç²˜è´´: $appName, åŒ…å: $packageName, æŸ¥è¯¢: $query")
            
            // æ£€æŸ¥æ— éšœç¢æœåŠ¡æ˜¯å¦å¯ç”¨
            val accessibilityService = MyAccessibilityService.getInstance()
            if (accessibilityService == null) {
                Log.w(TAG, "æ— éšœç¢æœåŠ¡ä¸å¯ç”¨ï¼Œä½¿ç”¨å‰ªè´´æ¿æ–¹æ¡ˆ")
                sendQuestionViaClipboard(packageName, query, appName)
                return
            }
            
            // å‘é€è‡ªåŠ¨ç²˜è´´è¯·æ±‚åˆ°æ— éšœç¢æœåŠ¡
            val intent = Intent("com.example.aifloatingball.AUTO_PASTE").apply {
                putExtra("package_name", packageName)
                putExtra("query", query)
                putExtra("app_name", appName)
            }
            sendBroadcast(intent)
            
            Log.d(TAG, "ğŸ“¤ å·²å‘é€è‡ªåŠ¨ç²˜è´´å¹¿æ’­: $appName")
            
        } catch (e: Exception) {
            Log.e(TAG, "âŒ è§¦å‘è‡ªåŠ¨ç²˜è´´å¤±è´¥: $appName", e)
            // å›é€€åˆ°å‰ªè´´æ¿æ–¹æ¡ˆ
            sendQuestionViaClipboard(packageName, query, appName)
        }
    }

    /**
     * è®¾ç½®ç¾¤èŠåˆ›å»ºå¹¿æ’­æ¥æ”¶å™¨
     */
    private fun setupGroupChatCreatedReceiver() {
        try {
            groupChatCreatedReceiver = object : BroadcastReceiver() {
                override fun onReceive(context: Context?, intent: Intent?) {
                    try {
                        if (intent?.action == "com.example.aifloatingball.GROUP_CHAT_CREATED") {
                            val groupContact = intent.getParcelableExtra<ChatContact>("group_contact")
                            if (groupContact != null) {
                                Log.d(TAG, "æ”¶åˆ°ç¾¤èŠåˆ›å»ºå¹¿æ’­: ${groupContact.name}")
                                
                                // åœ¨ä¸»çº¿ç¨‹ä¸­å¤„ç†UIæ›´æ–°
                                runOnUiThread {
                                    // æ·»åŠ ç¾¤èŠè”ç³»äººåˆ°è”ç³»äººåˆ—è¡¨
                                    addContactToList(groupContact)
                                    
                                    // åˆ·æ–°å½“å‰æ˜¾ç¤º
                                    refreshCurrentTabDisplay()
                                    
                                    Log.d(TAG, "ç¾¤èŠ ${groupContact.name} å·²æ·»åŠ åˆ°è”ç³»äººåˆ—è¡¨")
                                }
                            } else {
                                Log.w(TAG, "ç¾¤èŠåˆ›å»ºå¹¿æ’­ä¸­æœªæ‰¾åˆ°ç¾¤èŠè”ç³»äººæ•°æ®")
                            }
                        }
                    } catch (e: Exception) {
                        Log.e(TAG, "å¤„ç†ç¾¤èŠåˆ›å»ºå¹¿æ’­å¤±è´¥", e)
                    }
                }
            }
            
            val filter = IntentFilter("com.example.aifloatingball.GROUP_CHAT_CREATED")
            if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.TIRAMISU) {
                registerReceiver(groupChatCreatedReceiver, filter, Context.RECEIVER_NOT_EXPORTED)
            } else {
                registerReceiver(groupChatCreatedReceiver, filter)
            }
            
            Log.d(TAG, "ç¾¤èŠåˆ›å»ºå¹¿æ’­æ¥æ”¶å™¨å·²æ³¨å†Œ")
        } catch (e: Exception) {
            Log.e(TAG, "è®¾ç½®ç¾¤èŠåˆ›å»ºå¹¿æ’­æ¥æ”¶å™¨å¤±è´¥", e)
        }
    }

    /**
     * è®¾ç½®é“¾æ¥æ“ä½œå¹¿æ’­æ¥æ”¶å™¨
     */
    private fun setupLinkActionReceiver() {
        try {
            linkActionReceiver = object : BroadcastReceiver() {
                override fun onReceive(context: Context?, intent: Intent?) {
                    try {
                        when (intent?.action) {
                            "com.example.aifloatingball.OPEN_LINK_IN_BACKGROUND" -> {
                                val url = intent.getStringExtra("url")
                                if (!url.isNullOrEmpty()) {
                                    Log.d(TAG, "æ”¶åˆ°åå°æ‰“å¼€é“¾æ¥å¹¿æ’­: $url")
                                    openLinkInBackground(url)
                                }
                            }
                            "com.example.aifloatingball.OPEN_LINK_IN_NEW_TAB" -> {
                                val url = intent.getStringExtra("url")
                                if (!url.isNullOrEmpty()) {
                                    Log.d(TAG, "æ”¶åˆ°æ–°æ ‡ç­¾æ‰“å¼€é“¾æ¥å¹¿æ’­: $url")
                                    openLinkInNewTab(url)
                                }
                            }
                            "com.example.aifloatingball.GENERATE_QR_CODE" -> {
                                val url = intent.getStringExtra("url")
                                if (!url.isNullOrEmpty()) {
                                    Log.d(TAG, "æ”¶åˆ°ç”ŸæˆäºŒç»´ç å¹¿æ’­: $url")
                                    generateQRCode(url)
                                }
                            }
                        }
                    } catch (e: Exception) {
                        Log.e(TAG, "å¤„ç†é“¾æ¥æ“ä½œå¹¿æ’­å¤±è´¥", e)
                    }
                }
            }
            
            val filter = IntentFilter().apply {
                addAction("com.example.aifloatingball.OPEN_LINK_IN_BACKGROUND")
                addAction("com.example.aifloatingball.OPEN_LINK_IN_NEW_TAB")
                addAction("com.example.aifloatingball.GENERATE_QR_CODE")
            }
            
            if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.TIRAMISU) {
                registerReceiver(linkActionReceiver, filter, Context.RECEIVER_NOT_EXPORTED)
            } else {
                registerReceiver(linkActionReceiver, filter)
            }
            
            Log.d(TAG, "é“¾æ¥æ“ä½œå¹¿æ’­æ¥æ”¶å™¨å·²æ³¨å†Œ")
        } catch (e: Exception) {
            Log.e(TAG, "æ³¨å†Œé“¾æ¥æ“ä½œå¹¿æ’­æ¥æ”¶å™¨å¤±è´¥", e)
        }
    }

    /**
     * åœ¨åå°æ‰“å¼€é“¾æ¥
     * ğŸ”§ ä¿®å¤ï¼šå…³é—­é¢„è§ˆå¼¹çª—ï¼Œåœç•™åœ¨å½“å‰çª—å£ï¼Œåœ¨åå°åˆ›å»ºæ–°çª—å£ä½†ä¸è·³è½¬
     */
    private fun openLinkInBackground(url: String) {
        try {
            Log.d(TAG, "åœ¨åå°æ‰“å¼€é“¾æ¥: $url")
            
            // ä½¿ç”¨ç»Ÿä¸€çš„loadUrlInNewCardæ–¹æ³•ï¼Œåå°æ¨¡å¼ï¼ˆinBackground=trueï¼‰
            loadUrlInNewCard(url, inBackground = true)
                
                Log.d(TAG, "é“¾æ¥å·²åœ¨åå°WebViewå¡ç‰‡ä¸­æ‰“å¼€: $url")
        } catch (e: Exception) {
            Log.e(TAG, "åœ¨åå°æ‰“å¼€é“¾æ¥å¤±è´¥", e)
            Toast.makeText(this, "æ‰“å¼€é“¾æ¥å¤±è´¥", Toast.LENGTH_SHORT).show()
        }
    }

    /**
     * åœ¨æ–°æ ‡ç­¾ä¸­æ‰“å¼€é“¾æ¥
     * ğŸ”§ ä¿®å¤ï¼šæ”¹æˆæ–°çª—å£æ‰“å¼€ï¼Œç”¨æˆ·é©¬ä¸Šè·³è½¬æ–°çª—å£åŠ è½½é“¾æ¥
     */
    private fun openLinkInNewTab(url: String) {
        try {
            Log.d(TAG, "åœ¨æ–°çª—å£æ‰“å¼€é“¾æ¥: $url")
            
            // ä½¿ç”¨ç»Ÿä¸€çš„loadUrlInNewCardæ–¹æ³•ï¼Œå‰å°æ¨¡å¼ï¼ˆinBackground=falseï¼‰ï¼Œç«‹å³è·³è½¬
            loadUrlInNewCard(url, inBackground = false)
            
            Log.d(TAG, "é“¾æ¥å·²åœ¨æ–°çª—å£æ‰“å¼€: $url")
        } catch (e: Exception) {
            Log.e(TAG, "åœ¨æ–°çª—å£æ‰“å¼€é“¾æ¥å¤±è´¥", e)
            Toast.makeText(this, "æ‰“å¼€é“¾æ¥å¤±è´¥", Toast.LENGTH_SHORT).show()
        }
    }

    /**
     * ç”ŸæˆäºŒç»´ç 
     */
    private fun generateQRCode(url: String) {
        try {
            Log.d(TAG, "ç”ŸæˆäºŒç»´ç : $url")
            
            // è¿™é‡Œå¯ä»¥å®ç°äºŒç»´ç ç”ŸæˆåŠŸèƒ½
            // å¯ä»¥ä½¿ç”¨ç¬¬ä¸‰æ–¹åº“å¦‚ZXingæ¥ç”ŸæˆäºŒç»´ç 
            // æˆ–è€…è°ƒç”¨ç³»ç»Ÿçš„äºŒç»´ç ç”ŸæˆåŠŸèƒ½
            
            // ä¸´æ—¶å®ç°ï¼šæ˜¾ç¤ºä¸€ä¸ªå¯¹è¯æ¡†æ˜¾ç¤ºURL
            val dialog = androidx.appcompat.app.AlertDialog.Builder(this)
                .setTitle("äºŒç»´ç å†…å®¹")
                .setMessage("URL: $url\n\n(äºŒç»´ç ç”ŸæˆåŠŸèƒ½å¾…å®ç°)")
                .setPositiveButton("ç¡®å®š") { dialog, _ -> dialog.dismiss() }
                .setNeutralButton("å¤åˆ¶é“¾æ¥") { _, _ ->
                    val clipboard = getSystemService(Context.CLIPBOARD_SERVICE) as ClipboardManager
                    val clip = ClipData.newPlainText("URL", url)
                    clipboard.setPrimaryClip(clip)
                    Toast.makeText(this, "é“¾æ¥å·²å¤åˆ¶", Toast.LENGTH_SHORT).show()
                }
                .create()
            
            dialog.show()
            
            Log.d(TAG, "äºŒç»´ç å¯¹è¯æ¡†å·²æ˜¾ç¤º")
        } catch (e: Exception) {
            Log.e(TAG, "ç”ŸæˆäºŒç»´ç å¤±è´¥", e)
            Toast.makeText(this, "ç”ŸæˆäºŒç»´ç å¤±è´¥", Toast.LENGTH_SHORT).show()
        }
    }

    /**
     * åˆå§‹åŒ–ä¸‰æ®µå¼èƒ¶å›Šå¸ƒå±€
     */
    private fun initializeVoiceCapsuleLayout() {
        try {
            // è·å–èƒ¶å›Šå¸ƒå±€å®¹å™¨
            voiceCapsuleLayout = findViewById(R.id.voice_capsule_container)
            
            // åˆå§‹åŒ–èƒ¶å›Šå¸ƒå±€ä¸­çš„ç»„ä»¶
            voiceCapsuleTextInput = findViewById(R.id.voice_capsule_text_input)
            
            // è®¾ç½®è¾“å…¥æ¡†æœç´¢é”®ç›‘å¬å™¨
            voiceCapsuleTextInput?.apply {
                // ä¿å­˜åŸå§‹è¾“å…¥ç±»å‹ï¼ˆå¤šè¡Œï¼‰
                val originalInputType = inputType
                
                // è®¾ç½®ç„¦ç‚¹å˜åŒ–ç›‘å¬å™¨ï¼ŒåŠ¨æ€è°ƒæ•´è¾“å…¥ç±»å‹ä»¥æ˜¾ç¤ºæœç´¢é”®
                setOnFocusChangeListener { view, hasFocus ->
                    val editText = view as? android.widget.EditText ?: return@setOnFocusChangeListener
                    
                    if (hasFocus) {
                        // è·å¾—ç„¦ç‚¹æ—¶ï¼šä¸´æ—¶æ”¹ä¸ºå•è¡Œ+æœç´¢ï¼Œä½¿é”®ç›˜æ˜¾ç¤ºæœç´¢é”®
                        // ä½¿ç”¨ setRawInputType å’Œ setImeOptions æ¥ç¡®ä¿æœç´¢é”®æ˜¾ç¤º
                        editText.setRawInputType(InputType.TYPE_CLASS_TEXT or InputType.TYPE_TEXT_FLAG_NO_SUGGESTIONS)
                        editText.imeOptions = EditorInfo.IME_ACTION_SEARCH
                        
                        // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿è¾“å…¥æ³•å·²ç»æ˜¾ç¤ºåå†æ›´æ–°
                        post {
                            val imm = context.getSystemService(Context.INPUT_METHOD_SERVICE) as? InputMethodManager
                            imm?.restartInput(editText)
                            // å†æ¬¡ç¡®ä¿è®¾ç½®ç”Ÿæ•ˆ
                            editText.setRawInputType(InputType.TYPE_CLASS_TEXT or InputType.TYPE_TEXT_FLAG_NO_SUGGESTIONS)
                            editText.imeOptions = EditorInfo.IME_ACTION_SEARCH
                        }
                        Log.d(TAG, "è¾“å…¥æ¡†è·å¾—ç„¦ç‚¹ï¼Œè®¾ç½®æœç´¢é”®æ¨¡å¼")
                    } else {
                        // å¤±å»ç„¦ç‚¹æ—¶ï¼šæ¢å¤å¤šè¡Œè¾“å…¥ç±»å‹
                        editText.setRawInputType(originalInputType)
                        editText.imeOptions = EditorInfo.IME_ACTION_NONE
                        Log.d(TAG, "è¾“å…¥æ¡†å¤±å»ç„¦ç‚¹ï¼Œæ¢å¤å¤šè¡Œæ¨¡å¼")
                    }
                }
                
                // è®¾ç½®ç¼–è¾‘å™¨åŠ¨ä½œç›‘å¬å™¨ï¼ˆç”¨äºå¤„ç†æœç´¢é”®ï¼‰
                setOnEditorActionListener { _, actionId, event ->
                    if (actionId == EditorInfo.IME_ACTION_SEARCH ||
                        (event != null && event.keyCode == KeyEvent.KEYCODE_ENTER && event.action == KeyEvent.ACTION_DOWN)) {
                        // ç”¨æˆ·ç‚¹å‡»äº†æœç´¢é”®ï¼Œè§¦å‘æœç´¢
                        val query = text?.toString()?.trim() ?: ""
                        if (query.isNotEmpty()) {
                            Log.d(TAG, "ç”¨æˆ·ç‚¹å‡»æœç´¢é”®ï¼Œè§¦å‘è¯­éŸ³èƒ¶å›Šæœç´¢: $query")
                            performVoiceCapsuleSearch(query)
                            // éšè—è¾“å…¥æ³•é”®ç›˜
                            clearFocus()
                            val imm = getSystemService(Context.INPUT_METHOD_SERVICE) as? InputMethodManager
                            imm?.hideSoftInputFromWindow(windowToken, 0)
                            true
                        } else {
                            false
                        }
                    } else {
                        false
                    }
                }
                
                // æ·»åŠ æŒ‰é”®ç›‘å¬å™¨ä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆï¼ˆå¤„ç†å›è½¦é”®ï¼‰
                setOnKeyListener { _, keyCode, event ->
                    if (keyCode == KeyEvent.KEYCODE_ENTER && event.action == KeyEvent.ACTION_DOWN) {
                        // æ£€æŸ¥æ˜¯å¦æŒ‰ä¸‹äº†Ctrlæˆ–Shiftï¼ˆç”¨äºå¤šè¡Œè¾“å…¥ï¼‰
                        val isCtrlPressed = event.isCtrlPressed
                        val isShiftPressed = event.isShiftPressed
                        
                        // å¦‚æœæ²¡æœ‰æŒ‰ä¸‹Ctrlæˆ–Shiftï¼Œåˆ™è§¦å‘æœç´¢
                        if (!isCtrlPressed && !isShiftPressed) {
                            val query = text?.toString()?.trim() ?: ""
                            if (query.isNotEmpty()) {
                                Log.d(TAG, "ç”¨æˆ·æŒ‰ä¸‹å›è½¦é”®ï¼Œè§¦å‘è¯­éŸ³èƒ¶å›Šæœç´¢: $query")
                                performVoiceCapsuleSearch(query)
                                // éšè—è¾“å…¥æ³•é”®ç›˜
                                clearFocus()
                                val imm = getSystemService(Context.INPUT_METHOD_SERVICE) as? InputMethodManager
                                imm?.hideSoftInputFromWindow(windowToken, 0)
                                true
                            } else {
                                false
                            }
                        } else {
                            // å¦‚æœæŒ‰ä¸‹äº†Ctrlæˆ–Shiftï¼Œå…è®¸æ¢è¡Œï¼ˆä½†éœ€è¦ä¸´æ—¶æ¢å¤å¤šè¡Œæ¨¡å¼ï¼‰
                            setRawInputType(InputType.TYPE_CLASS_TEXT or InputType.TYPE_TEXT_FLAG_MULTI_LINE or InputType.TYPE_TEXT_FLAG_NO_SUGGESTIONS)
                            false // å…è®¸é»˜è®¤è¡Œä¸ºï¼ˆæ¢è¡Œï¼‰
                        }
                    } else {
                        false
                    }
                }
            }
            
            // åˆå§‹åŒ–AIåº”ç”¨å›¾æ ‡ç›¸å…³ç»„ä»¶
            voiceCapsuleAIAppsContainer = findViewById(R.id.voice_capsule_ai_apps_container)
            voiceCapsuleAIAppsView = findViewById(R.id.voice_capsule_ai_apps_view)
            
            // åˆå§‹åŒ–å¤šæ ‡ç­¾æœç´¢å¼•æ“ä¿¡æ¯æµ
            initializeCapsuleMultiTabSearch()
            
            // å…³é—­æŒ‰é’®å·²ç§»é™¤ï¼Œä¸éœ€è¦è®¾ç½®ç‚¹å‡»äº‹ä»¶
            
            // è®¾ç½®å¼€å§‹/æš‚åœæŒ‰é’®ç‚¹å‡»äº‹ä»¶ - ä½¿ç”¨MaterialButton
            findViewById<com.google.android.material.button.MaterialButton>(R.id.voice_capsule_start_pause_btn)?.apply {
                setOnClickListener {
                    Log.d(TAG, "å¼€å§‹/æš‚åœæŒ‰é’®è¢«ç‚¹å‡»ï¼Œå½“å‰çŠ¶æ€: isListening=$isListening, isRecordingPaused=$isRecordingPaused")
                    
                    // æ·»åŠ éœ‡åŠ¨åé¦ˆ
                    performVibration()
                    
                    // æ·»åŠ ç‚¹å‡»åŠ¨ç”»æ•ˆæœ
                    animate()
                        .scaleX(0.8f)
                        .scaleY(0.8f)
                        .setDuration(100)
                        .withEndAction {
                            animate()
                                .scaleX(1.0f)
                                .scaleY(1.0f)
                                .setDuration(100)
                                .start()
                        }
                        .start()
                    
                    if (isListening) {
                        // æ­£åœ¨è¯­éŸ³è¯†åˆ«æ—¶ç‚¹å‡» -> æš‚åœ/ç»§ç»­
                        toggleVoiceRecognitionPause()
                    } else {
                        // åœæ­¢çŠ¶æ€æ—¶ç‚¹å‡» -> å¼€å§‹è¯­éŸ³è¯†åˆ«
                        shouldContinueRecording = true
                        startAutoRecording()
                    }
                }
            }
            
            // è®¾ç½®ä¿å­˜æŒ‰é’®ç‚¹å‡»äº‹ä»¶ï¼ˆç‹¬ç«‹è®¾ç½®ï¼Œä¸åœ¨å¼€å§‹/æš‚åœæŒ‰é’®çš„applyå—å†…ï¼‰
            findViewById<com.google.android.material.button.MaterialButton>(R.id.voice_capsule_save_btn)?.apply {
                setOnClickListener {
                    Log.d(TAG, "ä¿å­˜æŒ‰é’®è¢«ç‚¹å‡»")
                    performVibration()
                    saveVoiceTextToTag()
                }
                // ç¡®ä¿æŒ‰é’®å¯è§ä¸”å¯ç‚¹å‡»ï¼ˆåˆå§‹çŠ¶æ€ï¼‰
                visibility = View.VISIBLE
                isClickable = true
                isFocusable = true
                alpha = 1.0f
            }
            
            // è®¾ç½®æ–‡æœ¬å·¥å…·æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            findViewById<com.google.android.material.button.MaterialButton>(R.id.voice_capsule_clear_btn)?.setOnClickListener {
                clearText()
            }
            
            findViewById<com.google.android.material.button.MaterialButton>(R.id.voice_capsule_copy_btn)?.setOnClickListener {
                copyText()
            }
            
            // ç¡®ä¿æ‰€æœ‰æŒ‰é’®å¯è§ï¼ˆç°åœ¨éƒ½åœ¨åŒä¸€ä¸ªå·¥å…·æ ä¸­ï¼‰
            val clearBtn = findViewById<com.google.android.material.button.MaterialButton>(R.id.voice_capsule_clear_btn)
            val copyBtn = findViewById<com.google.android.material.button.MaterialButton>(R.id.voice_capsule_copy_btn)
            
            listOf(clearBtn, copyBtn).forEach { btn ->
                btn?.apply {
                    visibility = View.VISIBLE
                    alpha = 1.0f
                }
            }
            
            // åˆå§‹åŒ–æ—¶ç¡®ä¿å¼€å§‹/æš‚åœæŒ‰é’®å¯è§
            findViewById<com.google.android.material.button.MaterialButton>(R.id.voice_capsule_start_pause_btn)?.apply {
                visibility = View.VISIBLE
                isClickable = true
                isFocusable = true
                alpha = 1.0f
                text = "å¼€å§‹"
                setIconResource(R.drawable.ic_mic)  // åˆå§‹çŠ¶æ€æ˜¾ç¤ºéº¦å…‹é£å›¾æ ‡
            }
            
            // åˆå§‹åŒ–æ—¶ç¡®ä¿è®¡æ—¶å™¨éšè—
            // å½•éŸ³è®¡æ—¶å™¨å·²ç§»é™¤ï¼Œåªä½¿ç”¨è½¬æ¢è®¡æ—¶å™¨
            
            Log.d(TAG, "ä¸‰æ®µå¼èƒ¶å›Šå¸ƒå±€åˆå§‹åŒ–å®Œæˆ")
        } catch (e: Exception) {
            Log.e(TAG, "åˆå§‹åŒ–ä¸‰æ®µå¼èƒ¶å›Šå¸ƒå±€å¤±è´¥", e)
        }
    }
    
    /**
     * æ˜¾ç¤ºä¸‰æ®µå¼èƒ¶å›Šå¸ƒå±€ï¼ˆé»˜è®¤çŠ¶æ€ï¼‰
     */
    private fun showVoiceCapsuleLayout() {
        try {
            runOnUiThread {
                // éšè—åŸå§‹è¯­éŸ³å¸ƒå±€
                findViewById<LinearLayout>(R.id.voice_original_layout)?.visibility = View.GONE
                
                // æ˜¾ç¤ºèƒ¶å›Šå¸ƒå±€
                voiceCapsuleLayout?.visibility = View.VISIBLE
                
                // è®¾ç½®ä¸ºèƒ¶å›Šæ¨¡å¼
                isVoiceCapsuleMode = true
                
                // è°ƒæ•´éº¦å…‹é£æŒ‰é’®ä½ç½®ï¼ˆæ”¯æŒå·¦å³æ‰‹æ¨¡å¼ï¼‰
                adjustMicButtonForHandMode()
                
                // è‡ªåŠ¨å¼€å§‹å½•éŸ³
                startAutoRecording()
                
                Log.d(TAG, "å·²æ˜¾ç¤ºä¸‰æ®µå¼èƒ¶å›Šå¸ƒå±€å¹¶å¼€å§‹è‡ªåŠ¨å½•éŸ³")
            }
        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºä¸‰æ®µå¼èƒ¶å›Šå¸ƒå±€å¤±è´¥", e)
        }
    }
    
    /**
     * è°ƒæ•´éº¦å…‹é£æŒ‰é’®ä½ç½®ï¼ˆæ”¯æŒå·¦å³æ‰‹æ¨¡å¼ï¼‰
     */
    private fun adjustMicButtonForHandMode() {
        try {
            // æ–°çš„å¼€å§‹/æš‚åœæŒ‰é’®ç›´æ¥æ”¾åœ¨RelativeLayoutä¸­ï¼Œä¸éœ€è¦æŸ¥æ‰¾å®¹å™¨
            val startPauseButton = findViewById<com.google.android.material.button.MaterialButton>(R.id.voice_capsule_start_pause_btn)
            val micContainer = startPauseButton?.parent as? RelativeLayout
            if (micContainer != null) {
                val layoutParams = micContainer.layoutParams as? RelativeLayout.LayoutParams
                if (layoutParams != null) {
                    // æ£€æµ‹å·¦å³æ‰‹æ¨¡å¼
                    val isRightHanded = isRightHandedMode()
                    
                    if (isRightHanded) {
                        // å³æ‰‹æ¨¡å¼ï¼šéº¦å…‹é£åœ¨å³ä¸‹è§’
                        layoutParams.addRule(RelativeLayout.ALIGN_PARENT_END)
                        layoutParams.addRule(RelativeLayout.ALIGN_PARENT_RIGHT, 0)
                        layoutParams.marginEnd = 4.dpToPx()
                        layoutParams.marginStart = 0
                    } else {
                        // å·¦æ‰‹æ¨¡å¼ï¼šéº¦å…‹é£åœ¨å·¦ä¸‹è§’
                        layoutParams.addRule(RelativeLayout.ALIGN_PARENT_START)
                        layoutParams.addRule(RelativeLayout.ALIGN_PARENT_LEFT, 0)
                        layoutParams.addRule(RelativeLayout.ALIGN_PARENT_END, 0)
                        layoutParams.addRule(RelativeLayout.ALIGN_PARENT_RIGHT, 0)
                        layoutParams.marginStart = 4.dpToPx()
                        layoutParams.marginEnd = 0
                    }
                    
                    micContainer.layoutParams = layoutParams
                    Log.d(TAG, "éº¦å…‹é£æŒ‰é’®ä½ç½®å·²è°ƒæ•´ä¸º${if (isRightHanded) "å³æ‰‹" else "å·¦æ‰‹"}æ¨¡å¼")
                }
            }
        } catch (e: Exception) {
            Log.e(TAG, "è°ƒæ•´éº¦å…‹é£æŒ‰é’®ä½ç½®å¤±è´¥", e)
        }
    }
    
    /**
     * æ£€æµ‹æ˜¯å¦ä¸ºå³æ‰‹æ¨¡å¼
     */
    private fun isRightHandedMode(): Boolean {
        return try {
            // æ£€æµ‹ç³»ç»Ÿè®¾ç½®ä¸­çš„å·¦å³æ‰‹æ¨¡å¼
            val configuration = resources.configuration
            val layoutDirection = configuration.layoutDirection
            layoutDirection == android.view.View.LAYOUT_DIRECTION_LTR
        } catch (e: Exception) {
            // é»˜è®¤ä½¿ç”¨å³æ‰‹æ¨¡å¼
            true
        }
    }
    
    /**
     * è‡ªåŠ¨å¼€å§‹å½•éŸ³
     */
    private fun startAutoRecording() {
        try {
            Log.d(TAG, "å¼€å§‹è‡ªåŠ¨å½•éŸ³æµç¨‹")
            
            // é‡ç½®ç»§ç»­å½•éŸ³æ ‡å¿—
            shouldContinueRecording = true
            
            // æ£€æŸ¥å½•éŸ³æƒé™
            val hasPermission = ContextCompat.checkSelfPermission(this, Manifest.permission.RECORD_AUDIO) == PackageManager.PERMISSION_GRANTED
            Log.d(TAG, "å½•éŸ³æƒé™çŠ¶æ€: $hasPermission")
            
            if (!hasPermission) {
                Log.d(TAG, "è¯·æ±‚å½•éŸ³æƒé™")
                ActivityCompat.requestPermissions(this,
                    arrayOf(Manifest.permission.RECORD_AUDIO), 1001)
                return
            }
            
            // æ£€æŸ¥use_vosk_offline_voiceè®¾ç½®
            val useVosk = settingsManager.getBoolean("use_vosk_offline_voice", false)
            
            if (useVosk) {
                // ç”¨æˆ·å·²å¯ç”¨Voskç¦»çº¿è¯­éŸ³è¯†åˆ«ï¼Œæ£€æŸ¥æ¨¡å‹æ˜¯å¦å·²ä¸‹è½½
                val voskManager = VoskManager(this)
                val savedModelType = settingsManager.getString("vosk_model_type", "SMALL")
                val modelType = if (savedModelType == "FULL") {
                    VoskManager.ModelType.FULL
                } else {
                    VoskManager.ModelType.SMALL
                }
                voskManager.setModelType(modelType)
                val downloadedTypes = voskManager.getDownloadedModelTypes()
                
                if (downloadedTypes.contains(modelType)) {
                    // Voskæ¨¡å‹å·²ä¸‹è½½ä¸”å¼€å…³å·²æ‰“å¼€ï¼Œä½¿ç”¨Voskè¿›è¡Œå½•éŸ³
                    Log.d(TAG, "æ£€æµ‹åˆ°Voskæ¨¡å‹å·²ä¸‹è½½ä¸”å¼€å…³å·²æ‰“å¼€ï¼Œä½¿ç”¨Voskè¿›è¡Œå½•éŸ³ï¼ˆæ¨¡å‹ç±»å‹: $modelTypeï¼‰")
                    startVoskRecognition()
                    return
                } else {
                    Log.w(TAG, "Voskå¼€å…³å·²æ‰“å¼€ï¼Œä½†æ¨¡å‹ç±»å‹ $modelType æœªä¸‹è½½ï¼Œå·²ä¸‹è½½çš„ç±»å‹: $downloadedTypes")
                    voiceStatusText.text = "Voskæ¨¡å‹æœªä¸‹è½½ï¼Œè¯·å…ˆä¸‹è½½æ¨¡å‹"
                    // ä¸ç»§ç»­ï¼Œç­‰å¾…ç”¨æˆ·ä¸‹è½½æ¨¡å‹
                    return
                }
            } else {
                Log.d(TAG, "Voskç¦»çº¿è¯­éŸ³è¯†åˆ«å¼€å…³æœªæ‰“å¼€ï¼Œå°è¯•å…¶ä»–è¯­éŸ³è¯†åˆ«æ–¹æ¡ˆ")
            }
            
            // æ£€æŸ¥ç³»ç»ŸSpeechRecognizeræ˜¯å¦å¯ç”¨
            val hasSystemSpeechRecognizer = android.speech.SpeechRecognizer.isRecognitionAvailable(this)
            if (hasSystemSpeechRecognizer) {
                // ç³»ç»ŸSpeechRecognizerå¯ç”¨ï¼Œä½¿ç”¨ç³»ç»Ÿè¯­éŸ³è¯†åˆ«
                Log.d(TAG, "æ£€æµ‹åˆ°ç³»ç»ŸSpeechRecognizerå¯ç”¨ï¼Œä½¿ç”¨ç³»ç»Ÿè¯­éŸ³è¯†åˆ«")
                startSystemVoiceRecognition()
                return
            }
            
            // å¦‚æœVoskå’Œç³»ç»ŸSpeechRecognizeréƒ½ä¸å¯ç”¨ï¼Œå†ä½¿ç”¨VoiceInputManagerï¼ˆå¯èƒ½ä¼šæ˜¾ç¤ºè¾“å…¥æ³•æç¤ºï¼‰
            Log.d(TAG, "Voskå’Œç³»ç»ŸSpeechRecognizeréƒ½ä¸å¯ç”¨ï¼Œå°è¯•å…¶ä»–æ–¹æ¡ˆ")
            
            // æ£€æŸ¥è¯­éŸ³è¾“å…¥ç®¡ç†å™¨æ˜¯å¦å·²åˆå§‹åŒ–
            if (!::voiceInputManager.isInitialized) {
                Log.e(TAG, "voiceInputManageræœªåˆå§‹åŒ–ï¼Œé‡æ–°åˆå§‹åŒ–")
                voiceInputManager = VoiceInputManager(this)
            }
            
            // æ³¨æ„ï¼šä¸å†å¯åŠ¨éŸ³é¢‘å½•åˆ¶ï¼Œåªè¿›è¡Œè¯­éŸ³è¯†åˆ«è½¬æ–‡æœ¬
            
            // è®¾ç½®å½•éŸ³çŠ¶æ€
            isListening = true
            updateCapsuleRecordingState(true)
            
            // ç¡®ä¿è®¾ç½®äº†å›è°ƒ
            if (voiceInputManager != null) {
                voiceInputManager.setCallback(object : VoiceInputManager.VoiceInputCallback {
                    override fun onVoiceInputResult(text: String) {
                        runOnUiThread {
                            try {
                                // å¦‚æœå·²æš‚åœï¼Œç«‹å³åœæ­¢å¤„ç†ï¼Œä¸è¿›è¡Œæ–‡æœ¬è½¬æ¢å’Œè‡ªåŠ¨æœç´¢
                                if (isVoiceRecognitionPaused) {
                                    Log.d(TAG, "è¯­éŸ³è¯†åˆ«å·²æš‚åœï¼Œå¿½ç•¥è¯†åˆ«ç»“æœ: $text")
                                    return@runOnUiThread
                                }
                                
                                // æµå¼æ˜¾ç¤ºï¼šå°†è¯†åˆ«ç»“æœæ·»åŠ åˆ°ç°æœ‰æ–‡æœ¬ä¸­
                                val currentText = voiceCapsuleTextInput?.text?.toString() ?: ""
                                val newText = if (currentText.isEmpty()) text else "$currentText $text"

                                // æ›´æ–°èƒ¶å›Šè¾“å…¥æ¡† - æµå¼æ˜¾ç¤ºæ–‡å­—
                                voiceCapsuleTextInput?.let { input ->
                                    input.setText(newText)
                                    input.setSelection(newText.length)
                                    
                                    // è‡ªé€‚åº”é«˜åº¦ï¼šæ ¹æ®æ–‡æœ¬å†…å®¹è°ƒæ•´é«˜åº¦
                                    input.post {
                                        input.requestLayout()
                                    }
                                }

                                // æ›´æ–°åŸå§‹è¾“å…¥æ¡†ï¼ˆä¿æŒåŒæ­¥ï¼‰
                                voiceTextInput.setText(newText)
                                voiceTextInput.setSelection(newText.length)
                                // ç§»é™¤çŠ¶æ€æ–‡æœ¬æç¤ºï¼Œä¸“æ³¨äºæ˜¾ç¤ºè¯†åˆ«ç»“æœ
                                voiceSearchButton.isEnabled = true
                                
                                // å†æ¬¡æ£€æŸ¥æš‚åœçŠ¶æ€ï¼Œç¡®ä¿åœ¨æ›´æ–°è¿‡ç¨‹ä¸­æ²¡æœ‰è¢«æš‚åœ
                                if (isVoiceRecognitionPaused) {
                                    Log.d(TAG, "åœ¨æ–‡æœ¬æ›´æ–°è¿‡ç¨‹ä¸­æ£€æµ‹åˆ°æš‚åœï¼Œåœæ­¢æ–‡æœ¬è½¬æ¢å¤„ç†")
                                    return@runOnUiThread
                                }
                                
                                // å¦‚æœæœ‰æ–‡æœ¬è½¬åŒ–ï¼Œåˆ‡æ¢åˆ°æ–‡æœ¬è½¬åŒ–è®¡æ—¶å™¨
                                if (text.isNotBlank()) {
                                    // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡æœ‰æ–‡æœ¬è½¬åŒ–ï¼Œæ ‡è®°å¹¶å¯åŠ¨è®¡æ—¶å™¨
                                    if (!hasTextConverted) {
                                        hasTextConverted = true
                                        textConversionStartTime = System.currentTimeMillis()
                                        // åœæ­¢å½•éŸ³è®¡æ—¶å™¨ï¼Œåˆ‡æ¢åˆ°æ–‡æœ¬è½¬åŒ–è®¡æ—¶å™¨
                                        stopConversionTimer()
                                        startTextConversionTimer()
                                    } else {
                                        // ç»§ç»­ä½¿ç”¨æ–‡æœ¬è½¬åŒ–è®¡æ—¶å™¨
                                        if (!isTextConversionPaused && !isVoiceRecognitionPaused) {
                                            startTextConversionTimer()
                                        }
                                    }
                                    // æ˜¾ç¤ºä¿å­˜æŒ‰é’®å’Œè®¡æ—¶å™¨
                                    findViewById<com.google.android.material.button.MaterialButton>(R.id.voice_capsule_save_btn)?.visibility = View.VISIBLE
                                    findViewById<TextView>(R.id.voice_capsule_text_conversion_timer)?.apply {
                                        visibility = View.VISIBLE
                                    }
                                    
                                    // åªæœ‰åœ¨æœªæš‚åœæ—¶æ‰è§¦å‘è‡ªåŠ¨æœç´¢
                                    if (!isVoiceRecognitionPaused) {
                                        // è§¦å‘è‡ªåŠ¨æœç´¢ï¼ˆä½¿ç”¨é˜²æŠ–æœºåˆ¶ï¼Œå»¶è¿Ÿ1ç§’åæœç´¢ï¼‰
                                        triggerVoiceCapsuleAutoSearch(newText)
                                    }
                                }

                                // åœ¨èƒ¶å›Šæ¨¡å¼ä¸‹ï¼Œä¿æŒå½•éŸ³çŠ¶æ€ï¼Œä¸é‡ç½®isListening
                                // è¿™æ ·éº¦å…‹é£æŒ‰é’®ä¼šä¿æŒéšè—ï¼Œæš‚åœæŒ‰é’®ä¿æŒæ˜¾ç¤º
                                // isListening ä¿æŒä¸º trueï¼Œè¡¨ç¤ºä»åœ¨å½•éŸ³ä¸­
                                
                                // å§‹ç»ˆç»§ç»­å½•éŸ³ï¼Œç›´åˆ°ç”¨æˆ·ç‚¹å‡»æš‚åœæˆ–åœæ­¢ï¼ˆä¸è‡ªåŠ¨åœæ­¢ï¼‰
                                if (shouldContinueRecording && !isVoiceRecognitionPaused) {
                                    // ç«‹å³ç»§ç»­å½•éŸ³ï¼Œå®ç°è¿ç»­å½•éŸ³ï¼ˆä¸è‡ªåŠ¨åœæ­¢ï¼‰
                                    voiceCapsuleTextInput?.postDelayed({
                                        if (shouldContinueRecording && !isVoiceRecognitionPaused) {
                                            continueRecording()
                                        }
                                    }, 100) // å‡å°‘å»¶è¿Ÿæ—¶é—´ï¼Œå®ç°æ›´å¿«çš„è¿ç»­å½•éŸ³
                                }
                                // æ³¨æ„ï¼šä¸è‡ªåŠ¨åˆ‡æ¢åˆ°ä¸‰æ®µå¼èƒ¶å›Šå¸ƒå±€ï¼Œä¿æŒå½•éŸ³çŠ¶æ€
                            } catch (e: Exception) {
                                Log.e(TAG, "å¤„ç†è¯­éŸ³è¯†åˆ«ç»“æœå¤±è´¥", e)
                            }
                        }
                    }

                    override fun onVoiceInputError(error: String) {
                        runOnUiThread {
                            voiceStatusText.text = error
                            // å¦‚æœæ˜¯éè‡´å‘½é”™è¯¯ï¼Œç»§ç»­å½•éŸ³ï¼ˆä¸è‡ªåŠ¨åœæ­¢ï¼‰
                            if (shouldContinueRecording && !isVoiceRecognitionPaused) {
                                // å»¶è¿Ÿåç»§ç»­å½•éŸ³
                                voiceCapsuleTextInput?.postDelayed({
                                    if (shouldContinueRecording && !isVoiceRecognitionPaused) {
                                        continueRecording()
                                    }
                                }, 500)
                            } else {
                                isListening = false
                                updateVoiceListeningState(false)
                            }
                        }
                    }

                    override fun onVoiceInputCancelled() {
                        runOnUiThread {
                            voiceStatusText.text = "è¯­éŸ³è¾“å…¥å·²å–æ¶ˆ"
                            isListening = false
                            updateVoiceListeningState(false)
                        }
                    }
                })
            }
            
            Log.d(TAG, "å¼€å§‹è°ƒç”¨voiceInputManager.startVoiceInput()")
            // å¼€å§‹è¯­éŸ³è¯†åˆ«
            voiceInputManager.startVoiceInput()
            
            // è®¾ç½®ç›‘å¬çŠ¶æ€
            isListening = true
            isVoiceRecognitionPaused = false  // é‡ç½®æš‚åœçŠ¶æ€
            isConversionPaused = false  // é‡ç½®è½¬æ¢æš‚åœçŠ¶æ€
            
            // æ³¨æ„ï¼šä¸å†å¯åŠ¨éŸ³é¢‘å½•åˆ¶ï¼Œåªè¿›è¡Œè¯­éŸ³è¯†åˆ«è½¬æ–‡æœ¬
            
            // å¼€å§‹è®¡æ—¶å™¨ï¼ˆè¯­éŸ³è¯†åˆ«æ—¶ä½¿ç”¨è½¬æ¢è®¡æ—¶å™¨ï¼‰
            stopTextConversionTimer() // åœæ­¢æ–‡æœ¬è½¬åŒ–è®¡æ—¶å™¨
            startConversionTimer()
            
            // æ˜¾ç¤ºè®¡æ—¶å™¨
            findViewById<TextView>(R.id.voice_capsule_text_conversion_timer)?.visibility = View.VISIBLE
            
            // æ˜¾ç¤ºæ³¢åŠ¨çº¿åŠ¨ç”»
            findViewById<com.example.aifloatingball.ui.WaveformView>(R.id.voice_capsule_waveform_bottom)?.apply {
                visibility = View.VISIBLE
                setAnimationRunning(true)
            }
            
            // æ›´æ–°UIçŠ¶æ€
            updateCapsuleRecordingState(true)
            
            // æ›´æ–°çŠ¶æ€æ–‡æœ¬
            voiceStatusText.text = "æ­£åœ¨å½•éŸ³ï¼Œç‚¹å‡»æŒ‰é’®æš‚åœ/ç»§ç»­"
            
            Log.d(TAG, "å·²å¼€å§‹è‡ªåŠ¨å½•éŸ³")
        } catch (e: Exception) {
            Log.e(TAG, "è‡ªåŠ¨å½•éŸ³å¤±è´¥", e)
        }
    }
    
    /**
     * ç»§ç»­å½•éŸ³
     */
    private fun continueRecording() {
        try {
            Log.d(TAG, "ç»§ç»­è¯­éŸ³è¯†åˆ«")
            
            // æ£€æŸ¥å½•éŸ³æƒé™ï¼ˆè¯­éŸ³è¯†åˆ«éœ€è¦ï¼‰
            val hasPermission = ContextCompat.checkSelfPermission(this, Manifest.permission.RECORD_AUDIO) == PackageManager.PERMISSION_GRANTED
            if (!hasPermission) {
                Log.e(TAG, "æ²¡æœ‰å½•éŸ³æƒé™ï¼Œæ— æ³•ç»§ç»­è¯­éŸ³è¯†åˆ«")
                return
            }
            
            // æ£€æŸ¥è¯­éŸ³è¾“å…¥ç®¡ç†å™¨æ˜¯å¦å·²åˆå§‹åŒ–
            if (voiceInputManager == null) {
                Log.e(TAG, "voiceInputManageræœªåˆå§‹åŒ–")
                return
            }
            
            // ç»§ç»­è¯­éŸ³è¯†åˆ«
            voiceInputManager.startVoiceInput()
            
            // è®¾ç½®ç›‘å¬çŠ¶æ€
            isListening = true
            
            // æ›´æ–°UIçŠ¶æ€
            updateCapsuleRecordingState(true)
            
            Log.d(TAG, "å·²ç»§ç»­è¯­éŸ³è¯†åˆ«")
        } catch (e: Exception) {
            Log.e(TAG, "ç»§ç»­è¯­éŸ³è¯†åˆ«å¤±è´¥", e)
        }
    }
    
    /**
     * å®Œæˆè¯­éŸ³è¯†åˆ«
     */
    private fun finishRecording() {
        try {
            Log.d(TAG, "å®Œæˆè¯­éŸ³è¯†åˆ«")
            
            // è®¾ç½®æ ‡å¿—åœæ­¢ç»§ç»­å½•éŸ³
            shouldContinueRecording = false
            isListening = false
            isVoiceRecognitionPaused = false  // é‡ç½®æš‚åœçŠ¶æ€
            isConversionPaused = false  // é‡ç½®è½¬æ¢æš‚åœçŠ¶æ€
            
            // åœæ­¢è¯­éŸ³è¾“å…¥ç®¡ç†å™¨ï¼ˆå¦‚æœå­˜åœ¨destroyæ–¹æ³•ï¼‰
            try {
                voiceInputManager?.let { manager ->
                    // å°è¯•åœæ­¢è¯­éŸ³è¯†åˆ«
                    try {
                        val speechRecognizerField = manager.javaClass.getDeclaredField("speechRecognizer")
                        speechRecognizerField.isAccessible = true
                        val speechRecognizer = speechRecognizerField.get(manager) as? android.speech.SpeechRecognizer
                        speechRecognizer?.stopListening()
                        speechRecognizer?.destroy()
                    } catch (e: Exception) {
                        Log.d(TAG, "æ— æ³•ç›´æ¥åœæ­¢è¯­éŸ³è¯†åˆ«: ${e.message}")
                    }
                    
                    // å°è¯•è°ƒç”¨destroyæ–¹æ³•ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™å¿½ç•¥
                    try {
                        val destroyMethod = manager.javaClass.getMethod("destroy")
                        destroyMethod.invoke(manager)
                    } catch (e: Exception) {
                        // destroyæ–¹æ³•ä¸å­˜åœ¨ï¼Œå¿½ç•¥
                        Log.d(TAG, "VoiceInputManageræ²¡æœ‰destroyæ–¹æ³•")
                    }
                }
            } catch (e: Exception) {
                Log.d(TAG, "åœæ­¢è¯­éŸ³è¾“å…¥ç®¡ç†å™¨å¤±è´¥: ${e.message}")
            }
            
            // æ³¨æ„ï¼šä¸å†åœæ­¢éŸ³é¢‘å½•åˆ¶ï¼Œåªåœæ­¢è¯­éŸ³è¯†åˆ«
            
            // åœæ­¢è®¡æ—¶å™¨
            stopConversionTimer()
            
            // éšè—æ³¢åŠ¨çº¿åŠ¨ç”»
            findViewById<com.example.aifloatingball.ui.WaveformView>(R.id.voice_capsule_waveform_bottom)?.apply {
                visibility = View.GONE
                setAnimationRunning(false)
            }
            
            // åœæ­¢å½•éŸ³çŠ¶æ€
            updateCapsuleRecordingState(false)
            
            // æ›´æ–°çŠ¶æ€æ–‡æœ¬
            voiceStatusText.text = "å½•éŸ³å·²åœæ­¢ï¼Œç‚¹å‡»æŒ‰é’®é‡æ–°å¼€å§‹"
            
            // è‡ªåŠ¨æ‰§è¡Œæœç´¢
            autoSearchAfterRecording()
            
            Log.d(TAG, "å½•éŸ³å·²å®Œæˆ")
        } catch (e: Exception) {
            Log.e(TAG, "å®Œæˆå½•éŸ³å¤±è´¥", e)
        }
    }
    
    /**
     * å½•éŸ³å®Œæˆåè‡ªåŠ¨æœç´¢ - åœ¨è¯­éŸ³tabä¸­ä½¿ç”¨èƒ¶å›ŠWebView
     */
    private fun autoSearchAfterRecording() {
        try {
            val query = voiceCapsuleTextInput?.text?.toString()?.trim()
            if (!query.isNullOrEmpty()) {
                Log.d(TAG, "å½•éŸ³å®Œæˆåè‡ªåŠ¨æœç´¢: $query")
                
                // å§‹ç»ˆåœ¨è¯­éŸ³tabçš„å†…åµŒWebViewä¸­æœç´¢ï¼Œä¸ä½¿ç”¨DualFloatingWebViewService
                // åˆ‡æ¢åˆ°è¯­éŸ³èƒ¶å›Šå¸ƒå±€
                switchToVoiceCapsuleLayout(query)
                
                // ä½¿ç”¨æ–°çš„æ–¹æ³•åœ¨èƒ¶å›ŠWebViewä¸­æ‰§è¡Œæœç´¢
                performCapsuleWebViewSearch(query)
                
                Log.d(TAG, "å·²åœ¨è¯­éŸ³èƒ¶å›ŠWebViewä¸­æ‰§è¡Œæœç´¢: $query")
                
                // æ›´æ–°çŠ¶æ€æ–‡æœ¬
                voiceStatusText.text = "å·²è‡ªåŠ¨æœç´¢: $query"
            }
        } catch (e: Exception) {
            Log.e(TAG, "è‡ªåŠ¨æœç´¢å¤±è´¥", e)
        }
    }
    
    /**
     * å¯åŠ¨å½•éŸ³è®¡æ—¶å™¨ï¼ˆå·²åºŸå¼ƒï¼Œä¸å†ä½¿ç”¨éŸ³é¢‘å½•åˆ¶ï¼‰
     */
    private fun startRecordingTimer() {
        // å½•éŸ³è®¡æ—¶å™¨å·²ç§»é™¤ï¼Œåªä½¿ç”¨è½¬æ¢è®¡æ—¶å™¨ï¼ˆè¯­éŸ³è¯†åˆ«è½¬æ–‡æœ¬ï¼‰
        // ä¸å†éœ€è¦å½•éŸ³è®¡æ—¶å™¨
    }
    
    /**
     * åœæ­¢å½•éŸ³è®¡æ—¶å™¨
     */
    private fun stopRecordingTimer() {
        recordingTimerRunnable?.let {
            recordingTimerHandler?.removeCallbacks(it)
        }
        recordingTimerRunnable = null
    }
    
    /**
     * åˆ‡æ¢è¯­éŸ³è¯†åˆ«æš‚åœ/ç»§ç»­
     */
    private fun toggleVoiceRecognitionPause() {
        if (!isListening) {
            Log.w(TAG, "æœªåœ¨è¯­éŸ³è¯†åˆ«ï¼Œæ— æ³•æš‚åœ")
            return
        }
        
        if (isVoiceRecognitionPaused) {
            // ç»§ç»­è¯­éŸ³è¯†åˆ«
            isVoiceRecognitionPaused = false
            isConversionPaused = false
            Log.d(TAG, "ç»§ç»­è¯­éŸ³è¯†åˆ«")
            
            // é‡æ–°å¯åŠ¨è¯­éŸ³è¯†åˆ«
            shouldContinueRecording = true
            continueRecording()
            
            // æ¢å¤è®¡æ—¶å™¨ - æ ¹æ®æ˜¯å¦æœ‰æ–‡æœ¬è½¬åŒ–æ¥å†³å®šä½¿ç”¨å“ªä¸ªè®¡æ—¶å™¨
            if (hasTextConverted) {
                // æœ‰æ–‡æœ¬è½¬åŒ–ï¼Œä½¿ç”¨æ–‡æœ¬è½¬åŒ–è®¡æ—¶å™¨
                stopConversionTimer()
                resumeTextConversionTimer()
            } else {
                // æ²¡æœ‰æ–‡æœ¬è½¬åŒ–ï¼Œä½¿ç”¨å½•éŸ³è®¡æ—¶å™¨
                stopTextConversionTimer()
                resumeConversionTimer()
            }
            
            // æ˜¾ç¤ºæ³¢åŠ¨çº¿åŠ¨ç”»
            findViewById<com.example.aifloatingball.ui.WaveformView>(R.id.voice_capsule_waveform_bottom)?.apply {
                visibility = View.VISIBLE
                setAnimationRunning(true)
            }
            
            // æ›´æ–°UIçŠ¶æ€
            updateCapsuleRecordingState(true)
            
            Toast.makeText(this, "è¯­éŸ³è¯†åˆ«å·²ç»§ç»­", Toast.LENGTH_SHORT).show()
        } else {
            // æš‚åœè¯­éŸ³è¯†åˆ«
            isVoiceRecognitionPaused = true
            isConversionPaused = true
            Log.d(TAG, "æš‚åœè¯­éŸ³è¯†åˆ«ï¼Œç«‹å³åœæ­¢å½•åˆ¶å’Œæ–‡æœ¬è½¬æ¢")
            
            // ç«‹å³å–æ¶ˆæ‰€æœ‰å¾…æ‰§è¡Œçš„è‡ªåŠ¨æœç´¢ä»»åŠ¡
            voiceCapsuleSearchHandler?.removeCallbacksAndMessages(null)
            Log.d(TAG, "å·²å–æ¶ˆæ‰€æœ‰å¾…æ‰§è¡Œçš„è‡ªåŠ¨æœç´¢ä»»åŠ¡")
            
            // æš‚åœè®¡æ—¶å™¨ - æ ¹æ®å½“å‰ä½¿ç”¨çš„è®¡æ—¶å™¨æ¥æš‚åœ
            if (hasTextConverted) {
                // æœ‰æ–‡æœ¬è½¬åŒ–ï¼Œæš‚åœæ–‡æœ¬è½¬åŒ–è®¡æ—¶å™¨
                pauseTextConversionTimer()
                stopConversionTimer() // ç¡®ä¿å½•éŸ³è®¡æ—¶å™¨åœæ­¢
            } else {
                // æ²¡æœ‰æ–‡æœ¬è½¬åŒ–ï¼Œæš‚åœå½•éŸ³è®¡æ—¶å™¨
                pauseConversionTimer()
                stopTextConversionTimer() // ç¡®ä¿æ–‡æœ¬è½¬åŒ–è®¡æ—¶å™¨åœæ­¢
            }
            
            // åœæ­¢å½“å‰è¯­éŸ³è¯†åˆ«
            try {
                voiceInputManager?.let { manager ->
                    // å°è¯•åœæ­¢è¯­éŸ³è¯†åˆ«
                    try {
                        val speechRecognizerField = manager.javaClass.getDeclaredField("speechRecognizer")
                        speechRecognizerField.isAccessible = true
                        val speechRecognizer = speechRecognizerField.get(manager) as? android.speech.SpeechRecognizer
                        speechRecognizer?.stopListening()
                        Log.d(TAG, "å·²åœæ­¢è¯­éŸ³è¯†åˆ«")
                    } catch (e: Exception) {
                        Log.d(TAG, "æ— æ³•ç›´æ¥åœæ­¢è¯­éŸ³è¯†åˆ«: ${e.message}")
                    }
                }
            } catch (e: Exception) {
                Log.d(TAG, "æš‚åœè¯­éŸ³è¯†åˆ«å¤±è´¥: ${e.message}")
            }
            
            // éšè—æ³¢åŠ¨çº¿åŠ¨ç”»
            findViewById<com.example.aifloatingball.ui.WaveformView>(R.id.voice_capsule_waveform_bottom)?.apply {
                visibility = View.GONE
                setAnimationRunning(false)
            }
            
            // æ›´æ–°UIçŠ¶æ€
            updateCapsuleRecordingState(true)
            
            Toast.makeText(this, "è¯­éŸ³è¯†åˆ«å·²æš‚åœ", Toast.LENGTH_SHORT).show()
        }
    }
    
    /**
     * å¯åŠ¨æ–‡æœ¬è½¬åŒ–è®¡æ—¶å™¨ - æ–‡æœ¬è½¬åŒ–æ—¶å¼€å§‹è®¡æ—¶
     */
    private fun startTextConversionTimer() {
        // å¦‚æœè¿˜æ²¡æœ‰å¼€å§‹è®¡æ—¶ï¼Œåˆå§‹åŒ–å¼€å§‹æ—¶é—´
        if (textConversionStartTime == 0L) {
            textConversionStartTime = System.currentTimeMillis()
            totalTextConversionPausedTime = 0
            textConversionPauseStartTime = 0
            isTextConversionPaused = false
        }
        
        // å¦‚æœæ­£åœ¨æš‚åœï¼Œå…ˆæ¢å¤
        if (isTextConversionPaused) {
            resumeTextConversionTimer()
            return
        }
        
        // åœæ­¢ä¹‹å‰çš„è®¡æ—¶å™¨
        stopTextConversionTimer()
        
        // ç¡®ä¿è®¡æ—¶å™¨è§†å›¾å¯è§
        findViewById<TextView>(R.id.voice_capsule_text_conversion_timer)?.visibility = View.VISIBLE
        
        textConversionTimerRunnable = object : Runnable {
            override fun run() {
                if (hasTextConverted && !isTextConversionPaused) {
                    val elapsed = System.currentTimeMillis() - textConversionStartTime - totalTextConversionPausedTime
                    val totalSeconds = (elapsed / 1000).toInt()
                    val minutes = totalSeconds / 60
                    val seconds = totalSeconds % 60
                    
                    val timeText = String.format("%02d:%02d", minutes, seconds)
                    findViewById<TextView>(R.id.voice_capsule_text_conversion_timer)?.apply {
                        text = timeText
                        visibility = View.VISIBLE
                    }
                    
                    textConversionTimerHandler?.postDelayed(this, 1000) // æ¯ç§’æ›´æ–°
                }
            }
        }
        textConversionTimerHandler?.post(textConversionTimerRunnable!!)
    }
    
    /**
     * åœæ­¢æ–‡æœ¬è½¬åŒ–è®¡æ—¶å™¨
     */
    private fun stopTextConversionTimer() {
        textConversionTimerRunnable?.let {
            textConversionTimerHandler?.removeCallbacks(it)
        }
        textConversionTimerRunnable = null
    }
    
    /**
     * æš‚åœæ–‡æœ¬è½¬åŒ–è®¡æ—¶å™¨ï¼ˆä¸æ¸…é›¶ï¼‰
     */
    private fun pauseTextConversionTimer() {
        if (!isTextConversionPaused && textConversionStartTime > 0) {
            isTextConversionPaused = true
            textConversionPauseStartTime = System.currentTimeMillis()
            stopTextConversionTimer()
        }
    }
    
    /**
     * æ¢å¤æ–‡æœ¬è½¬åŒ–è®¡æ—¶å™¨
     */
    private fun resumeTextConversionTimer() {
        if (isTextConversionPaused && textConversionPauseStartTime > 0) {
            // è®¡ç®—æš‚åœæ—¶é•¿å¹¶ç´¯åŠ 
            val pauseDuration = System.currentTimeMillis() - textConversionPauseStartTime
            totalTextConversionPausedTime += pauseDuration
            textConversionPauseStartTime = 0
            isTextConversionPaused = false
            startTextConversionTimer()
        }
    }
    
    /**
     * ä¿å­˜è¯­éŸ³æ–‡æœ¬åˆ°æ ‡ç­¾
     */
    private fun saveVoiceTextToTag() {
        try {
            val text = voiceCapsuleTextInput?.text?.toString()?.trim() ?: ""
            Log.d(TAG, "å¼€å§‹ä¿å­˜è¯­éŸ³æ–‡æœ¬ï¼Œæ–‡æœ¬é•¿åº¦: ${text.length}")
            
            if (text.isBlank()) {
                Log.w(TAG, "æ–‡æœ¬ä¸ºç©ºï¼Œæ— æ³•ä¿å­˜")
                Toast.makeText(this, "æ²¡æœ‰æ–‡æœ¬å¯ä¿å­˜", Toast.LENGTH_LONG).show()
                return
            }
            
            // 1. ä¿å­˜åˆ°ç»Ÿä¸€æ”¶è—ç®¡ç†å™¨ï¼ˆä¸»è¦å­˜å‚¨ï¼‰
            val collectionManager = UnifiedCollectionManager.getInstance(this)
            
            // åˆ›å»ºé¢„è§ˆæ–‡æœ¬ï¼ˆå‰200å­—ç¬¦ï¼‰
            val preview = text.take(200) + if (text.length > 200) "..." else ""
            
            // åˆ›å»ºæ ‡é¢˜ï¼ˆå‰50å­—ç¬¦ï¼‰
            val title = text.take(50) + if (text.length > 50) "..." else ""
            
            Log.d(TAG, "åˆ›å»ºæ”¶è—é¡¹: title='$title', textLength=${text.length}")
            
            // åˆ›å»ºæ”¶è—é¡¹
            val collectionItem = UnifiedCollectionItem(
                title = title,
                content = text, // å®Œæ•´å†…å®¹
                preview = preview,
                collectionType = CollectionType.VOICE_TO_TEXT,
                sourceLocation = "è¯­éŸ³Tab",
                sourceDetail = "è¯­éŸ³è½¬æ–‡æœ¬",
                collectedTime = System.currentTimeMillis(),
                customTags = listOf("è¯­éŸ³è½¬æ–‡", "è¯­éŸ³è¾“å…¥"),
                priority = Priority.NORMAL,
                completionStatus = CompletionStatus.NOT_STARTED,
                likeLevel = 0,
                emotionTag = EmotionTag.NEUTRAL,
                isEncrypted = false,
                reminderTime = null,
                extraData = mapOf(
                    "textLength" to text.length.toString(),
                    "source" to "SimpleModeActivity"
                )
            )
            
            Log.d(TAG, "æ”¶è—é¡¹åˆ›å»ºå®Œæˆ: id=${collectionItem.id}, type=${collectionItem.collectionType?.name}")
            
            // ä¿å­˜åˆ°ç»Ÿä¸€æ”¶è—ç®¡ç†å™¨ï¼ˆè¿™æ˜¯ä¸»è¦å­˜å‚¨ï¼Œç”¨äºAIåŠ©æ‰‹tabçš„ä»»åŠ¡åœºæ™¯æ˜¾ç¤ºï¼‰
            val collectionSuccess = collectionManager.addCollection(collectionItem)
            Log.d(TAG, "ç»Ÿä¸€æ”¶è—ç®¡ç†å™¨ä¿å­˜ç»“æœ: $collectionSuccess")
            
            // 2. åŒæ—¶ä¿å­˜åˆ°VoiceTextTagManagerï¼ˆä¾›VoiceTextFragmentæ˜¾ç¤ºï¼Œå¯é€‰ï¼‰
            val voiceTextSuccess = voiceTextTagManager?.saveTextToTag(text) ?: false
            Log.d(TAG, "è¯­éŸ³æ–‡æœ¬æ ‡ç­¾ç®¡ç†å™¨ä¿å­˜ç»“æœ: $voiceTextSuccess")
            
            // åªè¦ç»Ÿä¸€æ”¶è—ç®¡ç†å™¨ä¿å­˜æˆåŠŸï¼Œå°±è®¤ä¸ºä¿å­˜æˆåŠŸï¼ˆè¿™æ˜¯ä¸»è¦å­˜å‚¨ï¼‰
            if (collectionSuccess) {
                // å‘é€å¹¿æ’­é€šçŸ¥æ”¶è—æ›´æ–°
                try {
                    val intent = Intent("com.example.aifloatingball.COLLECTION_UPDATED").apply {
                        putExtra("collection_type", CollectionType.VOICE_TO_TEXT.name)
                        putExtra("action", "add")
                        putExtra("collection_id", collectionItem.id)
                        setPackage(packageName)
                    }
                    sendBroadcast(intent)
                    Log.d(TAG, "âœ… å·²å‘é€æ”¶è—æ›´æ–°å¹¿æ’­: type=${CollectionType.VOICE_TO_TEXT.name}, id=${collectionItem.id}")
                } catch (e: Exception) {
                    Log.e(TAG, "âŒ å‘é€æ”¶è—æ›´æ–°å¹¿æ’­å¤±è´¥", e)
                }
                
                // æ˜¾ç¤ºæˆåŠŸæç¤ºï¼ˆä½¿ç”¨LENGTH_LONGç¡®ä¿ç”¨æˆ·èƒ½çœ‹åˆ°ï¼‰
                Toast.makeText(this, "âœ… å·²ä¿å­˜åˆ°è¯­éŸ³è½¬æ–‡", Toast.LENGTH_LONG).show()
                Log.d(TAG, "âœ… è¯­éŸ³æ–‡æœ¬ä¿å­˜æˆåŠŸï¼Œå·²æ˜¾ç¤ºæç¤º")
            } else {
                // ç»Ÿä¸€æ”¶è—ç®¡ç†å™¨ä¿å­˜å¤±è´¥
                val errorMsg = if (!voiceTextSuccess) {
                    "ä¿å­˜å¤±è´¥ï¼šä¸¤ä¸ªå­˜å‚¨ç³»ç»Ÿéƒ½å¤±è´¥"
                } else {
                    "ä¿å­˜å¤±è´¥ï¼šç»Ÿä¸€æ”¶è—ç®¡ç†å™¨å¤±è´¥ï¼ˆæ•°æ®æœªä¿å­˜åˆ°ä»»åŠ¡åœºæ™¯ï¼‰"
                }
                Log.e(TAG, "âŒ è¯­éŸ³æ–‡æœ¬ä¿å­˜å¤±è´¥: collectionSuccess=$collectionSuccess, voiceTextSuccess=$voiceTextSuccess")
                Toast.makeText(this, errorMsg, Toast.LENGTH_LONG).show()
            }
        } catch (e: Exception) {
            Log.e(TAG, "âŒ ä¿å­˜è¯­éŸ³æ–‡æœ¬å¼‚å¸¸", e)
            e.printStackTrace()
            Toast.makeText(this, "ä¿å­˜å¤±è´¥: ${e.message}", Toast.LENGTH_LONG).show()
        }
    }
    
    /**
     * æ‰§è¡Œéœ‡åŠ¨åé¦ˆ
     */
    private fun performVibration() {
        performVibration("light")
    }
    
    /**
     * æ‰§è¡Œéœ‡åŠ¨åé¦ˆ
     * @param type éœ‡åŠ¨ç±»å‹ï¼šlight(è½»å¾®), medium(ä¸­ç­‰), heavy(é‡)
     */
    private fun performVibration(type: String) {
        try {
            val vib = vibrator ?: return
            if (android.os.Build.VERSION.SDK_INT >= android.os.Build.VERSION_CODES.O) {
                val effect = when (type) {
                    "light" -> android.os.VibrationEffect.createOneShot(50, android.os.VibrationEffect.DEFAULT_AMPLITUDE)
                    "medium" -> android.os.VibrationEffect.createOneShot(100, 128)
                    "heavy" -> android.os.VibrationEffect.createOneShot(150, 255)
                    else -> android.os.VibrationEffect.createOneShot(50, android.os.VibrationEffect.DEFAULT_AMPLITUDE)
                }
                vib.vibrate(effect)
            } else {
                @Suppress("DEPRECATION")
                val duration = when (type) {
                    "light" -> 50L
                    "medium" -> 100L
                    "heavy" -> 150L
                    else -> 50L
                }
                vib.vibrate(duration)
            }
        } catch (e: Exception) {
            Log.e(TAG, "éœ‡åŠ¨åé¦ˆå¤±è´¥", e)
        }
    }
    
    /**
     * å¯åŠ¨å½•éŸ³æ³¢åŠ¨åŠ¨ç”»
     */
    private fun startWaveformAnimation() {
        try {
            // åŸå§‹å¸ƒå±€çš„æ³¢å½¢è§†å›¾
            findViewById<com.example.aifloatingball.ui.WaveformView>(R.id.voice_waveform)?.apply {
                visibility = View.VISIBLE
                setAnimationRunning(true)
            }
            
            // èƒ¶å›Šå¸ƒå±€çš„æ³¢å½¢è§†å›¾
            findViewById<com.example.aifloatingball.ui.WaveformView>(R.id.voice_capsule_waveform_bottom)?.apply {
                visibility = View.VISIBLE
                setAnimationRunning(true)
            }
            
            // å¯åŠ¨å®šæ—¶æ›´æ–°æŒ¯å¹…
            startWaveformAmplitudeUpdate()
        } catch (e: Exception) {
            Log.e(TAG, "å¯åŠ¨æ³¢åŠ¨åŠ¨ç”»å¤±è´¥", e)
        }
    }
    
    /**
     * åœæ­¢å½•éŸ³æ³¢åŠ¨åŠ¨ç”»
     */
    private fun stopWaveformAnimation() {
        try {
            // åœæ­¢å®šæ—¶æ›´æ–°
            stopWaveformAmplitudeUpdate()
            
            // åŸå§‹å¸ƒå±€çš„æ³¢å½¢è§†å›¾
            findViewById<com.example.aifloatingball.ui.WaveformView>(R.id.voice_waveform)?.apply {
                setAnimationRunning(false)
                visibility = View.GONE
                setAmplitude(0.1f)
            }
            
            // èƒ¶å›Šå¸ƒå±€çš„æ³¢å½¢è§†å›¾
            findViewById<com.example.aifloatingball.ui.WaveformView>(R.id.voice_capsule_waveform_bottom)?.apply {
                setAnimationRunning(false)
                visibility = View.GONE
                setAmplitude(0.1f)
            }
        } catch (e: Exception) {
            Log.e(TAG, "åœæ­¢æ³¢åŠ¨åŠ¨ç”»å¤±è´¥", e)
        }
    }
    
    /**
     * æ³¢å½¢æŒ¯å¹…æ›´æ–°Runnable
     */
    private var waveformUpdateRunnable: Runnable? = null
    
    /**
     * å¯åŠ¨æ³¢å½¢æŒ¯å¹…å®šæ—¶æ›´æ–°ï¼ˆå·²åºŸå¼ƒï¼Œä¸å†ä½¿ç”¨éŸ³é¢‘å½•åˆ¶ï¼‰
     */
    private fun startWaveformAmplitudeUpdate() {
        stopWaveformAmplitudeUpdate()
        
        // ä¸å†ä½¿ç”¨éŸ³é¢‘å½•åˆ¶ï¼Œæ³¢å½¢åŠ¨ç”»ä½¿ç”¨å›ºå®šæŒ¯å¹…æˆ–åŸºäºè¯­éŸ³è¯†åˆ«çŠ¶æ€
        waveformUpdateRunnable = object : Runnable {
            override fun run() {
                if (isListening && !isVoiceRecognitionPaused) {
                    // ä½¿ç”¨å›ºå®šæŒ¯å¹…æˆ–åŸºäºè¯­éŸ³è¯†åˆ«çŠ¶æ€ï¼ˆä¸å†ä»MediaRecorderè·å–ï¼‰
                    val amplitude = 0.5f // å›ºå®šæŒ¯å¹…ï¼Œè¡¨ç¤ºæ­£åœ¨è¯†åˆ«
                    
                    // æ›´æ–°æ³¢å½¢è§†å›¾
                    findViewById<com.example.aifloatingball.ui.WaveformView>(R.id.voice_waveform)?.setAmplitude(amplitude)
                    findViewById<com.example.aifloatingball.ui.WaveformView>(R.id.voice_capsule_waveform_bottom)?.setAmplitude(amplitude)
                    
                    // 50msåå†æ¬¡æ›´æ–°
                    handler.postDelayed(this, 50)
                }
            }
        }
        
        handler.post(waveformUpdateRunnable!!)
    }
    
    /**
     * åœæ­¢æ³¢å½¢æŒ¯å¹…å®šæ—¶æ›´æ–°
     */
    private fun stopWaveformAmplitudeUpdate() {
        waveformUpdateRunnable?.let {
            handler.removeCallbacks(it)
            waveformUpdateRunnable = null
        }
    }
    
    /**
     * æ›´æ–°ä¿å­˜æŒ‰é’®çš„å¯è§æ€§ï¼ˆæ ¹æ®æ–‡æœ¬å†…å®¹ï¼‰
     */
    private fun updateSaveButtonVisibility() {
        try {
            val hasText = voiceTextInput.text.toString().trim().isNotEmpty()
            // ä¸å†æ£€æŸ¥ isRecordingAudioï¼Œåªè¦æœ‰æ–‡æœ¬å°±æ˜¾ç¤ºä¿å­˜æŒ‰é’®
            voiceSaveButton.visibility = if (hasText) {
                View.VISIBLE
            } else {
                View.GONE
            }
        } catch (e: Exception) {
            Log.e(TAG, "æ›´æ–°ä¿å­˜æŒ‰é’®å¯è§æ€§å¤±è´¥", e)
        }
    }
    
    /**
     * ä¿å­˜è¯­éŸ³è½¬åŒ–åçš„æ–‡æœ¬åˆ°AIåŠ©æ‰‹tabçš„è¯­éŸ³æ–‡æœ¬æ ‡ç­¾
     */
    private fun saveRecording() {
        try {
            // è·å–è¯­éŸ³è½¬åŒ–åçš„æ–‡æœ¬ï¼ˆä»è¾“å…¥æ¡†è·å–ï¼‰
            val transcription = voiceTextInput.text.toString().trim()
            
            if (transcription.isEmpty()) {
                Toast.makeText(this, "æ²¡æœ‰å¯ä¿å­˜çš„æ–‡æœ¬å†…å®¹", Toast.LENGTH_SHORT).show()
                return
            }
            
            // ä¿å­˜æ–‡æœ¬åˆ°è¯­éŸ³æ–‡æœ¬æ ‡ç­¾
            val success = voiceTextTagManager?.saveTextToTag(transcription) ?: false
            
            if (success) {
                // éšè—ä¿å­˜æŒ‰é’®
                voiceSaveButton.visibility = View.GONE
                
                // æ˜¾ç¤ºæç¤ºå¹¶è·³è½¬åˆ°AIåŠ©æ‰‹tabçš„è¯­éŸ³æ–‡æœ¬æ ‡ç­¾
                Toast.makeText(this, "æ–‡æœ¬å·²ä¿å­˜", Toast.LENGTH_SHORT).show()
                
                // å»¶è¿Ÿè·³è½¬ï¼Œè®©ç”¨æˆ·çœ‹åˆ°æç¤º
                handler.postDelayed({
                    jumpToVoiceTextTag()
                }, 500)
            } else {
                Toast.makeText(this, "ä¿å­˜æ–‡æœ¬å¤±è´¥", Toast.LENGTH_SHORT).show()
            }
        } catch (e: Exception) {
            Log.e(TAG, "ä¿å­˜æ–‡æœ¬å¼‚å¸¸", e)
            Toast.makeText(this, "ä¿å­˜æ–‡æœ¬å¤±è´¥: ${e.message}", Toast.LENGTH_SHORT).show()
        }
    }
    
    /**
     * è·³è½¬åˆ°AIåŠ©æ‰‹tabçš„è¯­éŸ³æ–‡æœ¬æ ‡ç­¾
     */
    private fun jumpToVoiceTextTag() {
        try {
            // åˆ‡æ¢åˆ°AIåŠ©æ‰‹tab
            showAIAssistantCenter()
            
            // æ˜¾ç¤ºæç¤ºå¯¹è¯æ¡†ï¼Œå¼•å¯¼ç”¨æˆ·æŸ¥çœ‹è¯­éŸ³æ–‡æœ¬
            android.app.AlertDialog.Builder(this)
                .setTitle("æ–‡æœ¬å·²ä¿å­˜")
                .setMessage("è¯­éŸ³è½¬åŒ–åçš„æ–‡æœ¬å·²æˆåŠŸä¿å­˜åˆ°AIåŠ©æ‰‹tabçš„è¯­éŸ³æ–‡æœ¬æ ‡ç­¾ä¸­ï¼Œæ‚¨å¯ä»¥å‰å¾€æŸ¥çœ‹ã€‚")
                .setPositiveButton("å‰å¾€æŸ¥çœ‹") { _, _ ->
                    // æŸ¥æ‰¾è¯­éŸ³æ–‡æœ¬æ ‡ç­¾å¹¶åˆ‡æ¢
                    // æ³¨æ„ï¼šè¿™é‡Œéœ€è¦æ ¹æ®å®é™…çš„AIåŠ©æ‰‹ä¸­å¿ƒå®ç°æ¥è°ƒæ•´
                    // å¦‚æœAIåŠ©æ‰‹ä¸­å¿ƒä½¿ç”¨TabLayoutï¼Œéœ€è¦æ‰¾åˆ°"è¯­éŸ³æ–‡æœ¬"æ ‡ç­¾å¹¶é€‰ä¸­
                    val tabLayout = findViewById<com.google.android.material.tabs.TabLayout>(R.id.ai_center_tab_layout)
                    if (tabLayout != null) {
                        // åˆ‡æ¢åˆ°è¯­éŸ³æ–‡æœ¬æ ‡ç­¾ï¼ˆç´¢å¼•3ï¼‰
                        val voiceTextTab = tabLayout.getTabAt(3)
                        if (voiceTextTab != null) {
                            voiceTextTab.select()
                            Log.d(TAG, "å·²åˆ‡æ¢åˆ°è¯­éŸ³æ–‡æœ¬æ ‡ç­¾")
                        } else {
                            Toast.makeText(this, "è¯­éŸ³æ–‡æœ¬æ ‡ç­¾æœªæ‰¾åˆ°ï¼Œè¯·æ‰‹åŠ¨æŸ¥çœ‹", Toast.LENGTH_SHORT).show()
                            Log.w(TAG, "è¯­éŸ³æ–‡æœ¬æ ‡ç­¾æœªæ‰¾åˆ°")
                        }
                    } else {
                        Toast.makeText(this, "å·²åˆ‡æ¢åˆ°AIåŠ©æ‰‹tabï¼Œè¯·æ‰‹åŠ¨æŸ¥çœ‹è¯­éŸ³æ–‡æœ¬", Toast.LENGTH_SHORT).show()
                    }
                }
                .setNegativeButton("çŸ¥é“äº†", null)
                .show()
            
            Log.d(TAG, "å·²æ˜¾ç¤ºæ–‡æœ¬ä¿å­˜æç¤º")
        } catch (e: Exception) {
            Log.e(TAG, "è·³è½¬åˆ°è¯­éŸ³æ–‡æœ¬æ ‡ç­¾å¤±è´¥", e)
            Toast.makeText(this, "æ–‡æœ¬å·²ä¿å­˜ï¼Œè¯·å‰å¾€AIåŠ©æ‰‹tabæŸ¥çœ‹", Toast.LENGTH_LONG).show()
        }
    }
    
    /**
     * å¯åŠ¨è½¬æ¢è®¡æ—¶å™¨ - æ¯æ¬¡é‡æ–°å¼€å§‹è®¡æ—¶
     */
    private fun startConversionTimer() {
        stopConversionTimer()
        
        // æ¯æ¬¡é‡æ–°å¼€å§‹è®¡æ—¶ï¼Œé‡ç½®æ‰€æœ‰æ—¶é—´
        conversionStartTime = System.currentTimeMillis()
        totalConversionPausedTime = 0
        conversionPauseStartTime = 0
        isConversionPaused = false
        
        // ç¡®ä¿è®¡æ—¶å™¨è§†å›¾å¯è§
        findViewById<TextView>(R.id.voice_capsule_text_conversion_timer)?.visibility = View.VISIBLE
        
        conversionTimerRunnable = object : Runnable {
            override fun run() {
                if (isListening && !isConversionPaused) {
                    val elapsed = System.currentTimeMillis() - conversionStartTime - totalConversionPausedTime
                    val totalSeconds = (elapsed / 1000).toInt()
                    val minutes = totalSeconds / 60
                    val seconds = totalSeconds % 60
                    
                    val timeText = String.format("%02d:%02d", minutes, seconds)
                    findViewById<TextView>(R.id.voice_capsule_text_conversion_timer)?.apply {
                        text = timeText
                        visibility = View.VISIBLE
                    }
                    
                    conversionTimerHandler?.postDelayed(this, 1000) // æ¯ç§’æ›´æ–°
                }
            }
        }
        conversionTimerHandler?.post(conversionTimerRunnable!!)
    }
    
    /**
     * åœæ­¢è½¬æ¢è®¡æ—¶å™¨
     */
    private fun stopConversionTimer() {
        conversionTimerRunnable?.let {
            conversionTimerHandler?.removeCallbacks(it)
        }
        conversionTimerRunnable = null
    }
    
    /**
     * æš‚åœè½¬æ¢è®¡æ—¶å™¨
     */
    private fun pauseConversionTimer() {
        if (!isConversionPaused && conversionStartTime > 0) {
            isConversionPaused = true
            conversionPauseStartTime = System.currentTimeMillis()
            stopConversionTimer()
        }
    }
    
    /**
     * æ¢å¤è½¬æ¢è®¡æ—¶å™¨
     */
    private fun resumeConversionTimer() {
        if (isConversionPaused && conversionPauseStartTime > 0) {
            // è®¡ç®—æš‚åœæ—¶é•¿å¹¶ç´¯åŠ 
            val pauseDuration = System.currentTimeMillis() - conversionPauseStartTime
            totalConversionPausedTime += pauseDuration
            conversionPauseStartTime = 0
            isConversionPaused = false
            startConversionTimer()
        }
    }
    
    /**
     * æ›´æ–°èƒ¶å›Šå½•éŸ³çŠ¶æ€ - é‡æ–°è®¾è®¡åŠ¨ç”»çŠ¶æ€
     */
    private fun updateCapsuleRecordingState(isRecording: Boolean) {
        try {
            runOnUiThread {
                val startPauseButton = findViewById<com.google.android.material.button.MaterialButton>(R.id.voice_capsule_start_pause_btn)
                val textConversionTimerView = findViewById<TextView>(R.id.voice_capsule_text_conversion_timer)
                val waveformBottom = findViewById<com.example.aifloatingball.ui.WaveformView>(R.id.voice_capsule_waveform_bottom)
                val saveButton = findViewById<com.google.android.material.button.MaterialButton>(R.id.voice_capsule_save_btn)
                
                // ç¡®ä¿æ‰€æœ‰æŒ‰é’®å§‹ç»ˆå¯è§ï¼ˆç°åœ¨éƒ½åœ¨åŒä¸€ä¸ªå·¥å…·æ ä¸­ï¼‰
                val clearBtn = findViewById<com.google.android.material.button.MaterialButton>(R.id.voice_capsule_clear_btn)
                val copyBtn = findViewById<com.google.android.material.button.MaterialButton>(R.id.voice_capsule_copy_btn)
                listOf(clearBtn, copyBtn).forEach { btn ->
                    btn?.apply {
                        visibility = View.VISIBLE
                        alpha = 1.0f
                    }
                }
                
                if (isRecording) {
                    // æ˜¾ç¤ºæ–‡æœ¬è½¬åŒ–è®¡æ—¶å™¨å’Œæ³¢åŠ¨çº¿åŠ¨ç”»
                    waveformBottom?.visibility = View.VISIBLE
                    waveformBottom?.setAnimationRunning(true)
                    
                    // å¦‚æœæœ‰æ–‡æœ¬è½¬åŒ–ï¼Œè‡ªåŠ¨å¼¹å‡ºè®¡æ—¶å™¨å¹¶æ˜¾ç¤ºä¿å­˜æŒ‰é’®
                    if (hasTextConverted) {
                        textConversionTimerView?.visibility = View.VISIBLE
                        saveButton?.visibility = View.VISIBLE
                    }
                    
                    // æ ¹æ®æš‚åœçŠ¶æ€æ›´æ–°æŒ‰é’®æ–‡æœ¬å’Œå›¾æ ‡
                    if (isVoiceRecognitionPaused) {
                        // æš‚åœçŠ¶æ€ï¼šæ˜¾ç¤º"ç»§ç»­"æ–‡æœ¬å’Œæ’­æ”¾å›¾æ ‡
                        startPauseButton?.text = "ç»§ç»­"
                        startPauseButton?.setIconResource(R.drawable.ic_play)
                    } else {
                        // å½•éŸ³çŠ¶æ€ï¼šæ˜¾ç¤º"æš‚åœ"æ–‡æœ¬å’Œæš‚åœå›¾æ ‡
                        startPauseButton?.text = "æš‚åœ"
                        startPauseButton?.setIconResource(R.drawable.ic_pause)
                    }
                } else {
                    // æœªå½•éŸ³æ—¶ï¼šæ˜¾ç¤º"å¼€å§‹"æ–‡æœ¬å’Œéº¦å…‹é£å›¾æ ‡ï¼Œéšè—æ³¢åŠ¨çº¿åŠ¨ç”»
                    startPauseButton?.text = "å¼€å§‹"
                    startPauseButton?.setIconResource(R.drawable.ic_mic)
                    waveformBottom?.visibility = View.GONE
                    waveformBottom?.setAnimationRunning(false)
                    
                    // å¦‚æœæœ‰æ–‡æœ¬ï¼Œæ˜¾ç¤ºæ–‡æœ¬è½¬åŒ–è®¡æ—¶å™¨å’Œä¿å­˜æŒ‰é’®
                    val hasText = voiceCapsuleTextInput?.text?.toString()?.trim()?.isNotBlank() == true
                    if (hasText && hasTextConverted) {
                        // åœæ­¢å½•éŸ³è®¡æ—¶å™¨ï¼Œä½¿ç”¨æ–‡æœ¬è½¬åŒ–è®¡æ—¶å™¨
                        stopConversionTimer()
                        if (!isTextConversionPaused) {
                            startTextConversionTimer()
                        }
                        textConversionTimerView?.visibility = View.VISIBLE
                        saveButton?.visibility = View.VISIBLE
                    } else {
                        // æ²¡æœ‰æ–‡æœ¬ï¼Œåœæ­¢æ‰€æœ‰è®¡æ—¶å™¨
                        stopConversionTimer()
                        stopTextConversionTimer()
                        textConversionTimerView?.visibility = View.GONE
                        saveButton?.visibility = View.GONE
                    }
                    
                    // é‡ç½®æš‚åœçŠ¶æ€å’Œè®¡æ—¶å™¨
                    isVoiceRecognitionPaused = false
                    conversionStartTime = 0
                    totalConversionPausedTime = 0
                    conversionPauseStartTime = 0
                    isConversionPaused = false
                    
                    // ç¡®ä¿æŒ‰é’®å¯è§ä¸”å¯ç‚¹å‡»ï¼Œä¸æ”¹å˜é¢œè‰²
                    startPauseButton?.let { button ->
                        button.alpha = 1.0f
                        button.scaleX = 1.0f
                        button.scaleY = 1.0f
                        // MaterialButton ä¸éœ€è¦ clearColorFilter
                    }
                }
            }
        } catch (e: Exception) {
            Log.e(TAG, "æ›´æ–°èƒ¶å›Šå½•éŸ³çŠ¶æ€å¤±è´¥", e)
        }
    }
    
    /**
     * æ›´æ–°æš‚åœçŠ¶æ€
     */
    private fun updatePauseState() {
        try {
            runOnUiThread {
                val startPauseButton = findViewById<com.google.android.material.button.MaterialButton>(R.id.voice_capsule_start_pause_btn)
                
                // æ ¹æ®æš‚åœçŠ¶æ€æ›´æ–°æŒ‰é’®å›¾æ ‡å’Œæ–‡æœ¬
                if (isVoiceRecognitionPaused) {
                    // æš‚åœçŠ¶æ€ï¼šæ˜¾ç¤ºæ’­æ”¾å›¾æ ‡ï¼ˆè¡¨ç¤ºå¯ä»¥ç»§ç»­ï¼‰
                    startPauseButton?.text = "ç»§ç»­"
                    startPauseButton?.setIconResource(R.drawable.ic_play)
                } else {
                    // å½•éŸ³çŠ¶æ€ï¼šæ˜¾ç¤ºæš‚åœå›¾æ ‡
                    startPauseButton?.text = "æš‚åœ"
                    startPauseButton?.setIconResource(R.drawable.ic_pause)
                }
                
                // æŒ‰é’®ï¼ˆä¸æ·»åŠ åŠ¨ç”»ï¼‰
                startPauseButton?.clearAnimation()
            }
        } catch (e: Exception) {
            Log.e(TAG, "æ›´æ–°æš‚åœçŠ¶æ€å¤±è´¥", e)
        }
    }
    
    /**
     * æš‚åœå½•éŸ³
     */
    private fun pauseRecording() {
        try {
            Log.d(TAG, "æš‚åœå½•éŸ³")
            isListening = false
            shouldContinueRecording = false
            
            // æ›´æ–°æš‚åœçŠ¶æ€
            updatePauseState()
            
            Log.d(TAG, "å½•éŸ³å·²æš‚åœ")
        } catch (e: Exception) {
            Log.e(TAG, "æš‚åœå½•éŸ³å¤±è´¥", e)
        }
    }
    
    /**
     * ç»§ç»­å½•éŸ³
     */
    private fun resumeRecording() {
        try {
            Log.d(TAG, "ç»§ç»­å½•éŸ³")
            shouldContinueRecording = true
            continueRecording()
        } catch (e: Exception) {
            Log.e(TAG, "ç»§ç»­å½•éŸ³å¤±è´¥", e)
        }
    }
    
    /**
     * æ¸…ç©ºæ–‡æœ¬
     */
    private fun clearText() {
        try {
            val currentText = voiceCapsuleTextInput?.text?.toString()?.trim()
            if (!currentText.isNullOrEmpty()) {
                voiceCapsuleTextInput?.setText("")
                voiceTextInput.setText("")
                Toast.makeText(this, "æ–‡æœ¬å·²æ¸…ç©º", Toast.LENGTH_SHORT).show()
                Log.d(TAG, "æ–‡æœ¬å·²æ¸…ç©º")
            } else {
                Toast.makeText(this, "æ²¡æœ‰æ–‡æœ¬éœ€è¦æ¸…ç©º", Toast.LENGTH_SHORT).show()
            }
        } catch (e: Exception) {
            Log.e(TAG, "æ¸…ç©ºæ–‡æœ¬å¤±è´¥", e)
            Toast.makeText(this, "æ¸…ç©ºå¤±è´¥", Toast.LENGTH_SHORT).show()
        }
    }
    
    /**
     * å¤åˆ¶æ–‡æœ¬
     */
    private fun copyText() {
        try {
            val text = voiceCapsuleTextInput?.text?.toString()?.trim()
            if (!text.isNullOrEmpty()) {
                val clipboard = getSystemService(Context.CLIPBOARD_SERVICE) as ClipboardManager
                val clip = android.content.ClipData.newPlainText("è¯­éŸ³æ–‡æœ¬", text)
                clipboard.setPrimaryClip(clip)
                Toast.makeText(this, "æ–‡æœ¬å·²å¤åˆ¶åˆ°å‰ªè´´æ¿", Toast.LENGTH_SHORT).show()
                Log.d(TAG, "æ–‡æœ¬å·²å¤åˆ¶åˆ°å‰ªè´´æ¿: $text")
            } else {
                Toast.makeText(this, "æ²¡æœ‰æ–‡æœ¬å¯ä»¥å¤åˆ¶", Toast.LENGTH_SHORT).show()
            }
        } catch (e: Exception) {
            Log.e(TAG, "å¤åˆ¶æ–‡æœ¬å¤±è´¥", e)
            Toast.makeText(this, "å¤åˆ¶å¤±è´¥", Toast.LENGTH_SHORT).show()
        }
    }
    
    /**
     * ç²˜è´´æ–‡æœ¬
     */
    private fun pasteText() {
        try {
            val clipboard = getSystemService(Context.CLIPBOARD_SERVICE) as ClipboardManager
            if (clipboard.hasPrimaryClip()) {
                val clipData = clipboard.primaryClip
                if (clipData != null && clipData.itemCount > 0) {
                    val text = clipData.getItemAt(0).text.toString().trim()
                    if (text.isNotEmpty()) {
                        val currentText = voiceCapsuleTextInput?.text?.toString() ?: ""
                        val newText = if (currentText.isEmpty()) text else "$currentText\n$text"
                        voiceCapsuleTextInput?.setText(newText)
                        voiceCapsuleTextInput?.setSelection(newText.length)
                        // åŒæ­¥åˆ°åŸå§‹è¾“å…¥æ¡†
                        voiceTextInput.setText(newText)
                        voiceTextInput.setSelection(newText.length)
                        Toast.makeText(this, "æ–‡æœ¬å·²ç²˜è´´", Toast.LENGTH_SHORT).show()
                        Log.d(TAG, "æ–‡æœ¬å·²ç²˜è´´: $text")
                    } else {
                        Toast.makeText(this, "å‰ªè´´æ¿å†…å®¹ä¸ºç©º", Toast.LENGTH_SHORT).show()
                    }
                } else {
                    Toast.makeText(this, "å‰ªè´´æ¿æ²¡æœ‰å†…å®¹", Toast.LENGTH_SHORT).show()
                }
            } else {
                Toast.makeText(this, "å‰ªè´´æ¿æ²¡æœ‰å†…å®¹", Toast.LENGTH_SHORT).show()
            }
        } catch (e: Exception) {
            Log.e(TAG, "ç²˜è´´æ–‡æœ¬å¤±è´¥", e)
            Toast.makeText(this, "ç²˜è´´å¤±è´¥", Toast.LENGTH_SHORT).show()
        }
    }
    
    /**
     * åˆ†äº«æ–‡æœ¬
     */
    private fun shareText() {
        try {
            val text = voiceCapsuleTextInput?.text?.toString()?.trim()
            if (!text.isNullOrEmpty()) {
                val shareIntent = Intent().apply {
                    action = Intent.ACTION_SEND
                    type = "text/plain"
                    putExtra(Intent.EXTRA_TEXT, text)
                    putExtra(Intent.EXTRA_SUBJECT, "è¯­éŸ³è¯†åˆ«æ–‡æœ¬")
                }
                val chooserIntent = Intent.createChooser(shareIntent, "åˆ†äº«æ–‡æœ¬")
                chooserIntent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
                startActivity(chooserIntent)
                Toast.makeText(this, "æ­£åœ¨åˆ†äº«æ–‡æœ¬...", Toast.LENGTH_SHORT).show()
                Log.d(TAG, "æ–‡æœ¬å·²åˆ†äº«: $text")
            } else {
                Toast.makeText(this, "æ²¡æœ‰æ–‡æœ¬å¯ä»¥åˆ†äº«", Toast.LENGTH_SHORT).show()
            }
        } catch (e: Exception) {
            Log.e(TAG, "åˆ†äº«æ–‡æœ¬å¤±è´¥", e)
            Toast.makeText(this, "åˆ†äº«å¤±è´¥", Toast.LENGTH_SHORT).show()
        }
    }
    
    /**
     * åˆå§‹åŒ–è¯­éŸ³èƒ¶å›Šå¤šæ ‡ç­¾æœç´¢å¼•æ“ä¿¡æ¯æµ
     */
    private fun initializeCapsuleMultiTabSearch() {
        try {
            // è·å–æ ‡ç­¾æ å®¹å™¨å’Œå¡ç‰‡è§†å›¾å®¹å™¨
            voiceCapsuleTabBarContainer = findViewById(R.id.voice_capsule_tab_bar_container)
            voiceCapsuleCardViewContainer = findViewById(R.id.voice_capsule_card_view_container)
            
            if (voiceCapsuleCardViewContainer == null || voiceCapsuleTabBarContainer == null) {
                Log.e(TAG, "å¤šæ ‡ç­¾æœç´¢å¼•æ“ä¿¡æ¯æµå®¹å™¨æœªæ‰¾åˆ°")
                return
            }
            
            // åˆ›å»ºå¡ç‰‡è§†å›¾ç®¡ç†å™¨
            voiceCapsuleCardViewManager = CardViewModeManager(this, voiceCapsuleCardViewContainer!!) {
                // æ‰“å¼€appæ—¶çš„å›è°ƒï¼ˆæš‚æ—¶ä¸éœ€è¦ç‰¹æ®Šå¤„ç†ï¼‰
                Log.d(TAG, "å¡ç‰‡è§†å›¾ç®¡ç†å™¨ï¼šæ‰“å¼€appå›è°ƒ")
            }
            
            // è®¾ç½®æ ‡ç­¾åˆ‡æ¢å›è°ƒï¼ˆç”¨äºå·¦å³æ»‘åŠ¨åˆ‡æ¢æ ‡ç­¾ï¼‰
            voiceCapsuleCardViewManager?.setOnTabSwitchCallback { direction ->
                val currentTabIndex = voiceCapsuleTabBarView?.getSelectedTabIndex() ?: 0
                val allTabs = voiceCapsuleTabBarView?.getAllTabs() ?: emptyList()
                if (allTabs.isNotEmpty()) {
                    val newIndex = (currentTabIndex + direction).coerceIn(0, allTabs.size - 1)
                    if (newIndex != currentTabIndex) {
                        voiceCapsuleTabBarView?.selectTab(newIndex)
                        // è§¦å‘æ ‡ç­¾ç‚¹å‡»äº‹ä»¶ï¼ŒåŠ è½½æ–°æ ‡ç­¾çš„æœç´¢ç»“æœ
                        val newTab = allTabs[newIndex]
                        val searchQuery = voiceCapsuleTextInput?.text?.toString()?.trim() ?: ""
                        val query = if (searchQuery.isNotEmpty()) {
                            searchQuery
                        } else {
                            newTab.name
                        }
                        loadSearchResultsForVoiceCapsuleTag(query, newTab)
                    }
                }
            }
            
            // è®¾ç½®å…¨å±æŸ¥çœ‹å™¨çš„çˆ¶å®¹å™¨
            voiceCapsuleCardViewContainer?.let { container ->
                val rootView = container.rootView as? ViewGroup ?: (container as? ViewGroup)
                rootView?.let {
                    voiceCapsuleCardViewManager?.setFullScreenParentContainer(it)
                }
            }
            
            // åˆ›å»ºæ ‡ç­¾æ 
            voiceCapsuleTabBarView = TabBarView(this, voiceCapsuleTabBarContainer!!)
            setupVoiceCapsuleTabBarListeners()
            
            // è®¾ç½®å¡ç‰‡ç‚¹å‡»ç›‘å¬å™¨
            voiceCapsuleCardViewManager?.setOnCardClickListener(
                object : CardViewModeManager.OnCardClickListener {
                    override fun onCardClick(cardData: CardViewModeManager.SearchResultCardData) {
                        Log.d(TAG, "è¯­éŸ³èƒ¶å›Šå¡ç‰‡ç‚¹å‡»: ${cardData.title}")
                    }
                    
                    override fun onCardExpand(cardData: CardViewModeManager.SearchResultCardData) {
                        Log.d(TAG, "è¯­éŸ³èƒ¶å›Šå¡ç‰‡å±•å¼€: ${cardData.title}")
                    }
                }
            )
            
            Log.d(TAG, "è¯­éŸ³èƒ¶å›Šå¤šæ ‡ç­¾æœç´¢å¼•æ“ä¿¡æ¯æµåˆå§‹åŒ–å®Œæˆ")
        } catch (e: Exception) {
            Log.e(TAG, "åˆå§‹åŒ–è¯­éŸ³èƒ¶å›Šå¤šæ ‡ç­¾æœç´¢å¼•æ“ä¿¡æ¯æµå¤±è´¥", e)
        }
    }
    
    /**
     * è®¾ç½®è¯­éŸ³èƒ¶å›Šæ ‡ç­¾æ ç›‘å¬å™¨
     */
    private fun setupVoiceCapsuleTabBarListeners() {
        voiceCapsuleTabBarView?.setOnTabClickListener(
            object : TabBarView.OnTabClickListener {
                override fun onTabClick(tab: TabBarView.TabItem, position: Int) {
                    Log.d(TAG, "è¯­éŸ³èƒ¶å›Šæ ‡ç­¾ç‚¹å‡»: ${tab.name}")
                    // å½“æ ‡ç­¾åˆ‡æ¢æ—¶ï¼Œæ¸…é™¤æ—§å¡ç‰‡å¹¶åŠ è½½æ–°æ ‡ç­¾çš„æœç´¢ç»“æœ
                    val searchQuery = voiceCapsuleTextInput?.text?.toString()?.trim() ?: ""
                    // å¦‚æœæœ‰æœç´¢å†…å®¹ï¼Œä½¿ç”¨æœç´¢å†…å®¹ï¼›å¦åˆ™ä½¿ç”¨æ ‡ç­¾åç§°ä½œä¸ºé»˜è®¤æœç´¢è¯
                    val query = if (searchQuery.isNotEmpty()) {
                        searchQuery
                    } else {
                        tab.name // ä½¿ç”¨æ ‡ç­¾åç§°ä½œä¸ºé»˜è®¤æœç´¢è¯
                    }
                    loadSearchResultsForVoiceCapsuleTag(query, tab)
                }
                
                override fun onTabLongClick(tab: TabBarView.TabItem, position: Int) {
                    Log.d(TAG, "è¯­éŸ³èƒ¶å›Šæ ‡ç­¾é•¿æŒ‰: ${tab.name}")
                    // æš‚æ—¶ä¸å®ç°æ ‡ç­¾ç¼–è¾‘åŠŸèƒ½
                }
            }
        )
    }
    
    /**
     * ä¸ºè¯­éŸ³èƒ¶å›Šæ ‡ç­¾åŠ è½½æœç´¢ç»“æœ
     */
    private fun loadSearchResultsForVoiceCapsuleTag(query: String, tab: TabBarView.TabItem) {
        Log.d(TAG, "å¼€å§‹ä¸ºè¯­éŸ³èƒ¶å›Šæ ‡ç­¾ '${tab.name}' åŠ è½½æœç´¢ç»“æœï¼ŒæŸ¥è¯¢: $query")
        
        if (query.isBlank()) {
            Log.d(TAG, "æŸ¥è¯¢å†…å®¹ä¸ºç©ºï¼Œè·³è¿‡åŠ è½½")
            return
        }
        
        // æ¸…é™¤æ‰€æœ‰æ—§å¡ç‰‡
        voiceCapsuleCardViewManager?.clearAllCards()
        
        // è·å–è¯¥æ ‡ç­¾å¯¹åº”çš„æœç´¢å¼•æ“åç§°åˆ—è¡¨
        val engineNames = tab.getDefaultEngines()
        Log.d(TAG, "æ ‡ç­¾ '${tab.name}' å¯¹åº”çš„æœç´¢å¼•æ“: $engineNames")
        
        // æ ¹æ®æœç´¢å¼•æ“åç§°æŸ¥æ‰¾å¯¹åº”çš„æœç´¢å¼•æ“å¯¹è±¡ï¼ˆåŒ…æ‹¬AIå¼•æ“ï¼‰
        val engines = engineNames.mapNotNull { engineName ->
            // é¦–å…ˆæŸ¥æ‰¾æ™®é€šæœç´¢å¼•æ“
            SearchEngine.DEFAULT_ENGINES.find { it.name == engineName }
                ?: run {
                    // å¦‚æœæ‰¾ä¸åˆ°ï¼ŒæŸ¥æ‰¾AIå¼•æ“
                    val aiEngine = AISearchEngine.DEFAULT_AI_ENGINES.find { 
                        it.name == engineName || 
                        it.name.contains(engineName, ignoreCase = true) ||
                        engineName.contains(it.name, ignoreCase = true)
                    }
                    // å¦‚æœæ‰¾åˆ°AIå¼•æ“ï¼Œåˆ›å»ºä¸€ä¸ªSearchEngineå¯¹è±¡ä»¥ä¾¿ç»Ÿä¸€å¤„ç†
                    if (aiEngine != null) {
                        SearchEngine(
                            name = aiEngine.name,
                            displayName = aiEngine.displayName,
                            url = aiEngine.url,
                            iconResId = aiEngine.iconResId,
                            description = aiEngine.description,
                            searchUrl = aiEngine.searchUrl,
                            isAI = aiEngine.isChatMode,
                            category = SearchEngineCategory.GENERAL
                        )
                    } else {
                        null
                    }
                }
        }
        
        // å¦‚æœæ‰¾ä¸åˆ°å¯¹åº”çš„æœç´¢å¼•æ“ï¼Œä½¿ç”¨é»˜è®¤çš„11ä¸ªæœç´¢å¼•æ“
        val finalEngines = if (engines.isEmpty()) {
            Log.w(TAG, "æœªæ‰¾åˆ°æ ‡ç­¾ '${tab.name}' å¯¹åº”çš„æœç´¢å¼•æ“ï¼Œä½¿ç”¨é»˜è®¤æœç´¢å¼•æ“")
            SearchEngine.DEFAULT_ENGINES.take(11)
        } else {
            engines.take(11) // ç¡®ä¿æœ€å¤šä½¿ç”¨11ä¸ªæœç´¢å¼•æ“
        }
        
        Log.d(TAG, "å°†ä¸ºè¯­éŸ³èƒ¶å›Šæ ‡ç­¾ '${tab.name}' åˆ›å»º ${finalEngines.size} ä¸ªæœç´¢ç»“æœå¡ç‰‡")
        
        // ä¸ºæ¯ä¸ªæœç´¢å¼•æ“åˆ›å»ºå¡ç‰‡
        finalEngines.forEachIndexed { index, engine ->
            Log.d(TAG, "åˆ›å»ºè¯­éŸ³èƒ¶å›Šå¡ç‰‡ ${index + 1}/${finalEngines.size}: ${engine.displayName}")
            voiceCapsuleCardViewManager?.addSearchResultCard(
                query = query,
                engineKey = engine.name,
                engineName = engine.displayName,
                tag = tab.name
            )
        }
        
        Log.d(TAG, "ä¸ºè¯­éŸ³èƒ¶å›Šæ ‡ç­¾ '${tab.name}' åŠ è½½äº† ${finalEngines.size} ä¸ªæœç´¢ç»“æœå¡ç‰‡")
    }
    
    /**
     * æ‰§è¡Œè¯­éŸ³èƒ¶å›Šæœç´¢ï¼ˆç”¨æˆ·ä¸»åŠ¨ç‚¹å‡»æœç´¢é”®æ—¶è°ƒç”¨ï¼‰
     */
    private fun performVoiceCapsuleSearch(query: String) {
        val trimmedQuery = query.trim()
        if (trimmedQuery.isEmpty()) {
            Log.d(TAG, "æœç´¢å†…å®¹ä¸ºç©ºï¼Œè·³è¿‡æœç´¢")
            return
        }
        
        Log.d(TAG, "æ‰§è¡Œè¯­éŸ³èƒ¶å›Šæœç´¢: $trimmedQuery")
        
        // æ›´æ–°æœ€åæœç´¢çš„æŸ¥è¯¢ï¼Œé¿å…è‡ªåŠ¨æœç´¢é‡å¤è§¦å‘
        voiceCapsuleLastSearchQuery = trimmedQuery
        
        // è·å–å½“å‰é€‰ä¸­çš„æ ‡ç­¾
        val selectedTab = voiceCapsuleTabBarView?.getSelectedTab()
        if (selectedTab != null) {
            // å¦‚æœæœ‰é€‰ä¸­çš„æ ‡ç­¾ï¼Œç›´æ¥åœ¨è¯¥æ ‡ç­¾ä¸­æœç´¢
            loadSearchResultsForVoiceCapsuleTag(trimmedQuery, selectedTab)
        } else {
            // å¦‚æœæ²¡æœ‰é€‰ä¸­æ ‡ç­¾ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªæ ‡ç­¾
            val firstTab = voiceCapsuleTabBarView?.getAllTabs()?.firstOrNull()
            if (firstTab != null) {
                voiceCapsuleTabBarView?.selectTab(0)
                loadSearchResultsForVoiceCapsuleTag(trimmedQuery, firstTab)
            } else {
                Log.w(TAG, "æ²¡æœ‰å¯ç”¨çš„æ ‡ç­¾è¿›è¡Œæœç´¢")
                Toast.makeText(this, "è¯·å…ˆé€‰æ‹©æœç´¢æ ‡ç­¾", Toast.LENGTH_SHORT).show()
            }
        }
    }
    
    /**
     * è§¦å‘è¯­éŸ³èƒ¶å›Šè‡ªåŠ¨æœç´¢ï¼ˆä½¿ç”¨é˜²æŠ–æœºåˆ¶ï¼‰
     */
    private fun triggerVoiceCapsuleAutoSearch(query: String) {
        // å¦‚æœå·²æš‚åœï¼Œä¸è§¦å‘è‡ªåŠ¨æœç´¢
        if (isVoiceRecognitionPaused) {
            Log.d(TAG, "è¯­éŸ³è¯†åˆ«å·²æš‚åœï¼Œå–æ¶ˆè‡ªåŠ¨æœç´¢: $query")
            return
        }
        
        if (query.isBlank() || query == voiceCapsuleLastSearchQuery) {
            return // é¿å…é‡å¤æœç´¢ç›¸åŒå†…å®¹
        }
        
        // åˆå§‹åŒ–Handlerï¼ˆå¦‚æœæœªåˆå§‹åŒ–ï¼‰
        if (voiceCapsuleSearchHandler == null) {
            voiceCapsuleSearchHandler = Handler(Looper.getMainLooper())
        }
        
        // ç§»é™¤ä¹‹å‰çš„æœç´¢ä»»åŠ¡
        voiceCapsuleSearchHandler?.removeCallbacksAndMessages(null)
        
        // å»¶è¿Ÿ1ç§’åæ‰§è¡Œæœç´¢ï¼ˆé˜²æŠ–ï¼‰
        voiceCapsuleSearchHandler?.postDelayed({
            // æ‰§è¡Œå‰å†æ¬¡æ£€æŸ¥æš‚åœçŠ¶æ€
            if (isVoiceRecognitionPaused) {
                Log.d(TAG, "æ‰§è¡Œè‡ªåŠ¨æœç´¢å‰æ£€æµ‹åˆ°æš‚åœï¼Œå–æ¶ˆæœç´¢")
                return@postDelayed
            }
            
            val trimmedQuery = query.trim()
            if (trimmedQuery.isNotEmpty() && trimmedQuery != voiceCapsuleLastSearchQuery) {
                voiceCapsuleLastSearchQuery = trimmedQuery
                Log.d(TAG, "è§¦å‘è¯­éŸ³èƒ¶å›Šè‡ªåŠ¨æœç´¢: $trimmedQuery")
                
                // è·å–å½“å‰é€‰ä¸­çš„æ ‡ç­¾
                val selectedTab = voiceCapsuleTabBarView?.getSelectedTab()
                if (selectedTab != null) {
                    loadSearchResultsForVoiceCapsuleTag(trimmedQuery, selectedTab)
                } else {
                    // å¦‚æœæ²¡æœ‰é€‰ä¸­æ ‡ç­¾ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªæ ‡ç­¾
                    val firstTab = voiceCapsuleTabBarView?.getAllTabs()?.firstOrNull()
                    if (firstTab != null) {
                        voiceCapsuleTabBarView?.selectTab(0)
                        loadSearchResultsForVoiceCapsuleTag(trimmedQuery, firstTab)
                    }
                }
            }
        }, 1000) // å»¶è¿Ÿ1ç§’
    }
    
    /**
     * åˆå§‹åŒ–è¯­éŸ³èƒ¶å›ŠåŒçª—å£WebViewæœåŠ¡ï¼ˆå·²åºŸå¼ƒï¼Œä¿ç•™ç”¨äºå…¼å®¹ï¼‰
     */
    @Deprecated("å·²æ›¿æ¢ä¸ºå¤šæ ‡ç­¾æœç´¢å¼•æ“ä¿¡æ¯æµ")
    private fun initializeCapsuleWebViews() {
        try {
            // è·å–åŒçª—å£æµ®åŠ¨WebViewå®¹å™¨ï¼ˆå®é™…æ˜¯LinearLayoutï¼‰
            val dualWebViewContainer = findViewById<android.widget.LinearLayout>(R.id.voice_capsule_dual_webview_container)
            
            // åˆå§‹åŒ–è¯­éŸ³èƒ¶å›ŠåŒçª—å£WebViewç»„ä»¶
            val firstWebView = findViewById<com.example.aifloatingball.ui.webview.CustomWebView>(R.id.first_floating_webview)
            val secondWebView = findViewById<com.example.aifloatingball.ui.webview.CustomWebView>(R.id.second_floating_webview)
            val thirdWebView = findViewById<com.example.aifloatingball.ui.webview.CustomWebView>(R.id.third_floating_webview)
            
            // é…ç½®WebViewè®¾ç½®
            listOf(firstWebView, secondWebView, thirdWebView).forEach { webView ->
                webView?.let {
                    it.settings.javaScriptEnabled = true
                    it.settings.domStorageEnabled = true
                    it.settings.loadWithOverviewMode = true
                    it.settings.useWideViewPort = true
                    it.settings.builtInZoomControls = false
                    it.settings.displayZoomControls = false
                    it.settings.setSupportZoom(true)
                    it.settings.textZoom = 100
                    
                    // ç¦ç”¨å¤–éƒ¨æµè§ˆå™¨æ‰“å¼€
                    it.settings.setSupportMultipleWindows(false)
                    it.settings.javaScriptCanOpenWindowsAutomatically = false
                    
                    // è®¾ç½®User-Agentç¡®ä¿ç§»åŠ¨ç«¯ä½“éªŒ
                    it.settings.userAgentString = "Mozilla/5.0 (Linux; Android 10; Mobile) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Mobile Safari/537.36"
                    
                    // ç¡®ä¿WebViewä¿æŒæ´»è·ƒçŠ¶æ€
                    it.keepScreenOn = false
                    it.isFocusable = true
                    it.isFocusableInTouchMode = true
                    
                    // ç¡®ä¿WebViewå¯ä»¥æ­£å¸¸æ»šåŠ¨ - ä½¿ç”¨é»˜è®¤å®‰å…¨çš„æ»šåŠ¨æ¡è®¾ç½®
                    try {
                        it.isVerticalScrollBarEnabled = true
                        it.isHorizontalScrollBarEnabled = false
                        // ä½¿ç”¨é»˜è®¤çš„æ»šåŠ¨æ¡æ ·å¼ï¼Œé¿å…null pointerå¼‚å¸¸
                        it.scrollBarStyle = View.SCROLLBARS_OUTSIDE_OVERLAY
                    } catch (e: Exception) {
                        Log.e(TAG, "è®¾ç½®WebViewæ»šåŠ¨æ¡å¤±è´¥", e)
                    }
                    
                    // è®¾ç½®WebViewClienté˜»æ­¢å¤–éƒ¨æµè§ˆå™¨æ‰“å¼€
                    it.webViewClient = object : WebViewClient() {
                        override fun shouldOverrideUrlLoading(view: WebView?, request: WebResourceRequest?): Boolean {
                            val url = request?.url?.toString()
                            Log.d(TAG, "è¯­éŸ³èƒ¶å›ŠWebView URLåŠ è½½: $url")
                            
                            // æ£€æŸ¥æ˜¯å¦ä¸ºç‰¹æ®Š schemeï¼Œéœ€è¦å¤–éƒ¨åº”ç”¨æ‰“å¼€
                            if (url != null && handleSpecialSchemeUrl(url, view)) {
                                return true // å·²å¤„ç†ï¼Œè¿”å›trueé˜»æ­¢é»˜è®¤åŠ è½½
                            }
                            
                            // å¼ºåˆ¶é˜»æ­¢å¤–éƒ¨æµè§ˆå™¨æ‰“å¼€ï¼Œæ‰€æœ‰é“¾æ¥éƒ½åœ¨WebViewå†…åŠ è½½
                            if (url != null && view != null) {
                                try {
                                    view.loadUrl(url)
                                    Log.d(TAG, "å·²åœ¨WebViewå†…åŠ è½½URL: $url")
                                } catch (e: Exception) {
                                    Log.e(TAG, "WebViewåŠ è½½URLå¤±è´¥: $url", e)
                                }
                            }
                            return true // å§‹ç»ˆè¿”å›trueï¼Œé˜»æ­¢ç³»ç»Ÿé»˜è®¤å¤„ç†
                        }
                        
                        @Deprecated("Deprecated in Java")
                        override fun shouldOverrideUrlLoading(view: WebView?, url: String?): Boolean {
                            Log.d(TAG, "è¯­éŸ³èƒ¶å›ŠWebView URLåŠ è½½ (legacy): $url")
                            
                            // æ£€æŸ¥æ˜¯å¦ä¸ºç‰¹æ®Š schemeï¼Œéœ€è¦å¤–éƒ¨åº”ç”¨æ‰“å¼€
                            if (url != null && handleSpecialSchemeUrl(url, view)) {
                                return true // å·²å¤„ç†ï¼Œè¿”å›trueé˜»æ­¢é»˜è®¤åŠ è½½
                            }
                            
                            // å¼ºåˆ¶é˜»æ­¢å¤–éƒ¨æµè§ˆå™¨æ‰“å¼€ï¼Œæ‰€æœ‰é“¾æ¥éƒ½åœ¨WebViewå†…åŠ è½½
                            if (url != null && view != null) {
                                try {
                                    view.loadUrl(url)
                                    Log.d(TAG, "å·²åœ¨WebViewå†…åŠ è½½URL (legacy): $url")
                                } catch (e: Exception) {
                                    Log.e(TAG, "WebViewåŠ è½½URLå¤±è´¥ (legacy): $url", e)
                                }
                            }
                            return true // å§‹ç»ˆè¿”å›trueï¼Œé˜»æ­¢ç³»ç»Ÿé»˜è®¤å¤„ç†
                        }
                        
                        override fun onPageStarted(view: WebView?, url: String?, favicon: Bitmap?) {
                            super.onPageStarted(view, url, favicon)
                            Log.d(TAG, "è¯­éŸ³èƒ¶å›ŠWebViewé¡µé¢å¼€å§‹åŠ è½½: $url")
                        }
                        
                        override fun onPageFinished(view: WebView?, url: String?) {
                            super.onPageFinished(view, url)
                            Log.d(TAG, "è¯­éŸ³èƒ¶å›ŠWebViewé¡µé¢åŠ è½½å®Œæˆ: $url")
                        }
                        
                        override fun onReceivedError(view: WebView?, request: WebResourceRequest?, error: WebResourceError?) {
                            val url = request?.url?.toString()
                            val errorCode = if (android.os.Build.VERSION.SDK_INT >= android.os.Build.VERSION_CODES.M) {
                                error?.errorCode
                            } else {
                                -1
                            }
                            val errorDescription = if (android.os.Build.VERSION.SDK_INT >= android.os.Build.VERSION_CODES.M) {
                                error?.description?.toString()
                            } else {
                                "Unknown error"
                            }
                            
                            Log.e(TAG, "è¯­éŸ³èƒ¶å›ŠWebViewåŠ è½½é”™è¯¯: $errorDescription, URL: $url, ErrorCode: $errorCode")
                            
                            // æ£€æŸ¥æ˜¯å¦ä¸º ERR_UNKNOWN_URL_SCHEME é”™è¯¯ï¼Œä¸” URL æ˜¯ç‰¹æ®Š scheme
                            if (errorCode == -2 || errorDescription?.contains("ERR_UNKNOWN_URL_SCHEME") == true || 
                                errorDescription?.contains("net::ERR_UNKNOWN_URL_SCHEME") == true) {
                                if (url != null && handleSpecialSchemeUrl(url, view)) {
                                    // å·²å¤„ç†ç‰¹æ®Š schemeï¼Œä¸æ˜¾ç¤ºé”™è¯¯é¡µé¢
                                    Log.d(TAG, "å·²é€šè¿‡ handleSpecialSchemeUrl å¤„ç†ç‰¹æ®Š scheme: $url")
                                    return
                                }
                            }
                            
                            super.onReceivedError(view, request, error)
                        }
                        
                        @Deprecated("Deprecated in Java")
                        override fun onReceivedError(view: WebView?, errorCode: Int, description: String?, failingUrl: String?) {
                            Log.e(TAG, "è¯­éŸ³èƒ¶å›ŠWebViewåŠ è½½é”™è¯¯ (legacy): $description, URL: $failingUrl, ErrorCode: $errorCode")
                            
                            // æ£€æŸ¥æ˜¯å¦ä¸º ERR_UNKNOWN_URL_SCHEME é”™è¯¯ï¼ˆé”™è¯¯ä»£ç  -2ï¼‰
                            if (errorCode == -2 || description?.contains("ERR_UNKNOWN_URL_SCHEME") == true || 
                                description?.contains("net::ERR_UNKNOWN_URL_SCHEME") == true) {
                                if (failingUrl != null && handleSpecialSchemeUrl(failingUrl, view)) {
                                    // å·²å¤„ç†ç‰¹æ®Š schemeï¼Œä¸æ˜¾ç¤ºé”™è¯¯é¡µé¢
                                    Log.d(TAG, "å·²é€šè¿‡ handleSpecialSchemeUrl å¤„ç†ç‰¹æ®Š scheme (legacy): $failingUrl")
                                    return
                                }
                            }
                            
                            super.onReceivedError(view, errorCode, description, failingUrl)
                        }
                    }
                    
                    // è®¾ç½®WebChromeClientè¿›ä¸€æ­¥æ§åˆ¶WebViewè¡Œä¸º
                    it.webChromeClient = object : WebChromeClient() {
                        override fun onCreateWindow(view: WebView?, isDialog: Boolean, isUserGesture: Boolean, resultMsg: android.os.Message?): Boolean {
                            // é˜»æ­¢åˆ›å»ºæ–°çª—å£ï¼Œå¼ºåˆ¶åœ¨å½“å‰WebViewä¸­æ‰“å¼€
                            Log.d(TAG, "é˜»æ­¢WebViewåˆ›å»ºæ–°çª—å£")
                            return true
                        }
                        
                        override fun onJsAlert(view: WebView?, url: String?, message: String?, result: android.webkit.JsResult?): Boolean {
                            // å¤„ç†JavaScriptå¼¹çª—
                            Log.d(TAG, "JavaScriptå¼¹çª—: $message")
                            result?.confirm()
                            return true
                        }
                    }
                }
            }
            
            // åˆå§‹åŒ–æœç´¢è¾“å…¥æ¡†
            val dualSearchInput = findViewById<EditText>(R.id.dual_search_input)
            dualSearchInput?.let {
                it.hint = "è¾“å…¥æœç´¢å†…å®¹"
                it.setOnEditorActionListener { _, actionId, _ ->
                    if (actionId == EditorInfo.IME_ACTION_SEARCH) {
                        performCapsuleWebViewSearch(it.text.toString())
                        true
                    } else {
                        false
                    }
                }
            }
            
            // åˆå§‹åŒ–æœç´¢æŒ‰é’®
            val searchButton = findViewById<ImageButton>(R.id.btn_search)
            searchButton?.setOnClickListener {
                val query = dualSearchInput?.text?.toString()?.trim()
                if (!query.isNullOrEmpty()) {
                    performCapsuleWebViewSearch(query)
                }
            }
            
            // åˆå§‹åŒ–çª—å£æ•°é‡åˆ‡æ¢æŒ‰é’®
            val windowCountButton = findViewById<ImageButton>(R.id.btn_window_count)
            windowCountButton?.setOnClickListener {
                // åˆ‡æ¢çª—å£æ•°é‡æ˜¾ç¤ºé€»è¾‘
                val windowCountText = findViewById<TextView>(R.id.window_count_toggle)
                val currentCount = windowCountText?.text?.toString()?.toIntOrNull() ?: 2
                val newCount = if (currentCount == 2) 3 else 2
                windowCountText?.text = newCount.toString()
                
                // æ ¹æ®çª—å£æ•°é‡æ˜¾ç¤º/éšè—ç¬¬ä¸‰ä¸ªWebView
                thirdWebView?.parent?.let { parent ->
                    if (parent is ViewGroup) {
                        parent.visibility = if (newCount == 3) View.VISIBLE else View.GONE
                    }
                }
            }
            
            // åˆå§‹åŒ–é«˜åº¦è°ƒæ•´æŠŠæ‰‹
            setupHeightAdjustmentHandle()

            // æ³¨æ„ï¼šå¿«æ·æ“ä½œæŒ‰é’®å·²è¢«å¹³å°å›¾æ ‡æ›¿æ¢ï¼Œä¸å†éœ€è¦è®¾ç½®æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            // å¹³å°å›¾æ ‡çš„ç‚¹å‡»äº‹ä»¶ç”±PlatformIconsViewå†…éƒ¨å¤„ç†

            Log.d(TAG, "è¯­éŸ³èƒ¶å›ŠåŒçª—å£WebViewæœåŠ¡åˆå§‹åŒ–å®Œæˆ")
        } catch (e: Exception) {
            Log.e(TAG, "åˆå§‹åŒ–è¯­éŸ³èƒ¶å›ŠåŒçª—å£WebViewæœåŠ¡å¤±è´¥", e)
        }
    }
    
    /**
     * è®¾ç½®é«˜åº¦è°ƒæ•´æŠŠæ‰‹
     */
    private fun setupHeightAdjustmentHandle() {
        try {
            val resizeHandle = findViewById<LinearLayout>(R.id.voice_capsule_resize_handle)
            val dualWebViewContainer = findViewById<LinearLayout>(R.id.voice_capsule_dual_webview_container)
            
            if (resizeHandle != null && dualWebViewContainer != null) {
                var initialHeight = 0
                var initialY = 0f
                var isResizing = false
                
                // æœ€å°å’Œæœ€å¤§é«˜åº¦é™åˆ¶ï¼ˆdpè½¬pxï¼‰
                val minHeight = (200 * resources.displayMetrics.density).toInt()
                val maxHeight = (600 * resources.displayMetrics.density).toInt()
                
                // è®¾ç½®æŠŠæ‰‹çš„è§¦æ‘¸ç›‘å¬å™¨
                resizeHandle.setOnTouchListener { view, event ->
                    when (event.action) {
                        MotionEvent.ACTION_DOWN -> {
                            initialHeight = dualWebViewContainer.height
                            initialY = event.rawY
                            isResizing = true
                            
                            // æ”¹å˜æŠŠæ‰‹é¢œè‰²ä»¥æä¾›è§†è§‰åé¦ˆ
                            resizeHandle.background = resources.getDrawable(
                                R.drawable.voice_capsule_resize_handle_background, 
                                null
                            )
                            
                            // è¯·æ±‚æ‰€æœ‰çˆ¶å®¹å™¨ä¸è¦æ‹¦æˆªè§¦æ‘¸äº‹ä»¶
                            var parent = view.parent
                            while (parent != null) {
                                if (parent is ViewGroup) {
                                    parent.requestDisallowInterceptTouchEvent(true)
                                }
                                parent = parent.parent
                            }
                            
                            true
                        }
                        
                        MotionEvent.ACTION_MOVE -> {
                            if (isResizing) {
                                val deltaY = initialY - event.rawY // å‘ä¸Šæ‹–æ‹½ä¸ºæ­£å€¼
                                val newHeight = (initialHeight + deltaY.toInt()).coerceIn(minHeight, maxHeight)
                                
                                // æ›´æ–°å®¹å™¨é«˜åº¦
                                val layoutParams = dualWebViewContainer.layoutParams
                                layoutParams.height = newHeight
                                dualWebViewContainer.layoutParams = layoutParams
                                
                                // æ·»åŠ å¹³æ»‘åŠ¨ç”»
                                dualWebViewContainer.animate()
                                    .setDuration(50)
                                    .alpha(1f)
                                    .start()
                                
                                // ç»§ç»­è¯·æ±‚æ‰€æœ‰çˆ¶å®¹å™¨ä¸è¦æ‹¦æˆªè§¦æ‘¸äº‹ä»¶
                                var parent = view.parent
                                while (parent != null) {
                                    if (parent is ViewGroup) {
                                        parent.requestDisallowInterceptTouchEvent(true)
                                    }
                                    parent = parent.parent
                                }
                            }
                            true
                        }
                        
                        MotionEvent.ACTION_UP, MotionEvent.ACTION_CANCEL -> {
                            isResizing = false
                            
                            // æ¢å¤æŠŠæ‰‹é¢œè‰²
                            resizeHandle.background = resources.getDrawable(
                                R.drawable.voice_capsule_resize_handle_background, 
                                null
                            )
                            
                            // å…è®¸æ‰€æœ‰çˆ¶å®¹å™¨é‡æ–°æ‹¦æˆªè§¦æ‘¸äº‹ä»¶
                            var parent = view.parent
                            while (parent != null) {
                                if (parent is ViewGroup) {
                                    parent.requestDisallowInterceptTouchEvent(false)
                                }
                                parent = parent.parent
                            }
                            
                            // ä¿å­˜å½“å‰é«˜åº¦åˆ°SharedPreferences
                            saveWebViewHeight(dualWebViewContainer.height)
                            
                            true
                        }
                        
                        else -> false
                    }
                }
                
                // è®¾ç½®æŠŠæ‰‹çš„ç‚¹å‡»ç›‘å¬å™¨ï¼Œé˜²æ­¢ç‚¹å‡»äº‹ä»¶è¢«æ‹¦æˆª
                resizeHandle.setOnClickListener {
                    // ç©ºå®ç°ï¼Œåªæ˜¯ä¸ºäº†ç¡®ä¿ç‚¹å‡»äº‹ä»¶è¢«å¤„ç†
                }
                
                // æ¢å¤ä¿å­˜çš„é«˜åº¦
                restoreWebViewHeight(dualWebViewContainer)
                
                Log.d(TAG, "é«˜åº¦è°ƒæ•´æŠŠæ‰‹åˆå§‹åŒ–å®Œæˆ")
            }
        } catch (e: Exception) {
            Log.e(TAG, "è®¾ç½®é«˜åº¦è°ƒæ•´æŠŠæ‰‹å¤±è´¥", e)
        }
    }
    
    /**
     * ä¿å­˜WebViewé«˜åº¦
     */
    private fun saveWebViewHeight(height: Int) {
        try {
            val sharedPref = getSharedPreferences("voice_capsule_prefs", Context.MODE_PRIVATE)
            with(sharedPref.edit()) {
                putInt("webview_height", height)
                apply()
            }
        } catch (e: Exception) {
            Log.e(TAG, "ä¿å­˜WebViewé«˜åº¦å¤±è´¥", e)
        }
    }
    
    /**
     * æ¢å¤WebViewé«˜åº¦
     */
    private fun restoreWebViewHeight(container: LinearLayout) {
        try {
            val sharedPref = getSharedPreferences("voice_capsule_prefs", Context.MODE_PRIVATE)
            val savedHeight = sharedPref.getInt("webview_height", 0)
            
            if (savedHeight > 0) {
                val minHeight = (200 * resources.displayMetrics.density).toInt()
                val maxHeight = (600 * resources.displayMetrics.density).toInt()
                val height = savedHeight.coerceIn(minHeight, maxHeight)
                
                val layoutParams = container.layoutParams
                layoutParams.height = height
                container.layoutParams = layoutParams
                
                Log.d(TAG, "æ¢å¤WebViewé«˜åº¦: $height")
            }
        } catch (e: Exception) {
            Log.e(TAG, "æ¢å¤WebViewé«˜åº¦å¤±è´¥", e)
        }
    }
    
    /**
     * æ‰§è¡ŒåŒçª—å£æœç´¢ - å¯åŠ¨DualFloatingWebViewServiceé¿å…ä½¿ç”¨å†…åµŒæµè§ˆå™¨
     */
    private fun performDualWebSearch(query: String) {
        try {
            // å¯åŠ¨DualFloatingWebViewServiceè¿›è¡Œæœç´¢ï¼Œé¿å…ä½¿ç”¨å†…åµŒWebView
            val serviceIntent = Intent(this, DualFloatingWebViewService::class.java).apply {
                putExtra("search_query", query)
                putExtra("engine_key", "baidu") // é»˜è®¤ä½¿ç”¨ç™¾åº¦æœç´¢
                putExtra("search_source", "è¯­éŸ³èƒ¶å›Š")
                putExtra("window_count", 3) // ä½¿ç”¨ä¸‰çª—å£æ¨¡å¼
            }
            startService(serviceIntent)
            
            Log.d(TAG, "å·²å¯åŠ¨DualFloatingWebViewServiceè¿›è¡ŒåŒçª—å£æœç´¢: $query")
        } catch (e: Exception) {
            Log.e(TAG, "å¯åŠ¨DualFloatingWebViewServiceå¤±è´¥", e)
            Toast.makeText(this, "å¯åŠ¨æœç´¢æœåŠ¡å¤±è´¥", Toast.LENGTH_SHORT).show()
        }
    }
    
    /**
     * åœ¨è¾“å…¥æ¡†ä¸‹æ–¹çš„webviewä¸­æ‰§è¡Œæœç´¢
     */
    private fun performCapsuleWebViewSearch(query: String) {
        try {
            Log.d(TAG, "åœ¨è¯­éŸ³èƒ¶å›ŠWebViewä¸­æ‰§è¡Œæœç´¢: $query")
            
            // è·å–ä¸‰ä¸ªWebViewå®ä¾‹
            val firstWebView = findViewById<com.example.aifloatingball.ui.webview.CustomWebView>(R.id.first_floating_webview)
            val secondWebView = findViewById<com.example.aifloatingball.ui.webview.CustomWebView>(R.id.second_floating_webview)
            val thirdWebView = findViewById<com.example.aifloatingball.ui.webview.CustomWebView>(R.id.third_floating_webview)
            
            // åˆ›å»ºæœç´¢å¼•æ“å¤„ç†å™¨å®ä¾‹
            val searchEngineHandler = SearchEngineHandler(settingsManager)
            
            // ä¸ºæ¯ä¸ªWebViewåˆ†é…ä¸åŒçš„æœç´¢å¼•æ“
            val engines = listOf("baidu", "google", "bing")
            val webViews = listOfNotNull(firstWebView, secondWebView, thirdWebView)
            
            webViews.forEachIndexed { index, webView ->
                if (index < engines.size) {
                    val engineKey = engines[index]
                    val searchUrl = searchEngineHandler.getSearchUrl(query, engineKey)
                    
                    Log.d(TAG, "WebView ${index + 1} ä½¿ç”¨æœç´¢å¼•æ“: $engineKey, URL: $searchUrl")
                    
                    // ç¡®ä¿WebViewClienté…ç½®æ­£ç¡®ï¼Œå¼ºåˆ¶é˜»æ­¢å¤–éƒ¨æµè§ˆå™¨æ‰“å¼€
                    webView?.webViewClient = object : WebViewClient() {
                        override fun shouldOverrideUrlLoading(view: WebView?, request: WebResourceRequest?): Boolean {
                            val url = request?.url?.toString()
                            Log.d(TAG, "è¯­éŸ³èƒ¶å›ŠWebView URLæ‹¦æˆª: $url")
                            
                            // æ£€æŸ¥æ˜¯å¦ä¸ºç‰¹æ®Š schemeï¼Œéœ€è¦å¤–éƒ¨åº”ç”¨æ‰“å¼€
                            if (url != null && handleSpecialSchemeUrl(url, view)) {
                                return true // å·²å¤„ç†ï¼Œè¿”å›trueé˜»æ­¢é»˜è®¤åŠ è½½
                            }
                            
                            // å¼ºåˆ¶åœ¨WebViewå†…åŠ è½½ï¼Œé˜»æ­¢å¤–éƒ¨æµè§ˆå™¨
                            if (url != null && view != null) {
                                try {
                                    view.loadUrl(url)
                                    Log.d(TAG, "å·²åœ¨WebViewå†…å¼ºåˆ¶åŠ è½½: $url")
                                } catch (e: Exception) {
                                    Log.e(TAG, "WebViewå¼ºåˆ¶åŠ è½½å¤±è´¥: $url", e)
                                }
                            }
                            return true // å§‹ç»ˆè¿”å›trueï¼Œé˜»æ­¢ç³»ç»Ÿé»˜è®¤å¤„ç†
                        }
                        
                        @Deprecated("Deprecated in Java")
                        override fun shouldOverrideUrlLoading(view: WebView?, url: String?): Boolean {
                            Log.d(TAG, "è¯­éŸ³èƒ¶å›ŠWebView URLæ‹¦æˆª (legacy): $url")
                            
                            // æ£€æŸ¥æ˜¯å¦ä¸ºç‰¹æ®Š schemeï¼Œéœ€è¦å¤–éƒ¨åº”ç”¨æ‰“å¼€
                            if (url != null && handleSpecialSchemeUrl(url, view)) {
                                return true // å·²å¤„ç†ï¼Œè¿”å›trueé˜»æ­¢é»˜è®¤åŠ è½½
                            }
                            
                            if (url != null && view != null) {
                                try {
                                    view.loadUrl(url)
                                    Log.d(TAG, "å·²åœ¨WebViewå†…å¼ºåˆ¶åŠ è½½ (legacy): $url")
                                } catch (e: Exception) {
                                    Log.e(TAG, "WebViewå¼ºåˆ¶åŠ è½½å¤±è´¥ (legacy): $url", e)
                                }
                            }
                            return true
                        }
                        
                        override fun onPageStarted(view: WebView?, url: String?, favicon: Bitmap?) {
                            super.onPageStarted(view, url, favicon)
                            Log.d(TAG, "è¯­éŸ³èƒ¶å›ŠWebViewé¡µé¢å¼€å§‹åŠ è½½: $url")
                        }
                        
                        override fun onPageFinished(view: WebView?, url: String?) {
                            super.onPageFinished(view, url)
                            Log.d(TAG, "è¯­éŸ³èƒ¶å›ŠWebViewé¡µé¢åŠ è½½å®Œæˆ: $url")
                        }
                        
                        override fun onReceivedError(view: WebView?, request: WebResourceRequest?, error: WebResourceError?) {
                            val url = request?.url?.toString()
                            val errorCode = if (android.os.Build.VERSION.SDK_INT >= android.os.Build.VERSION_CODES.M) {
                                error?.errorCode
                            } else {
                                -1
                            }
                            val errorDescription = if (android.os.Build.VERSION.SDK_INT >= android.os.Build.VERSION_CODES.M) {
                                error?.description?.toString()
                            } else {
                                "Unknown error"
                            }
                            
                            Log.e(TAG, "è¯­éŸ³èƒ¶å›ŠWebViewåŠ è½½é”™è¯¯: $errorDescription, URL: $url, ErrorCode: $errorCode")
                            
                            // æ£€æŸ¥æ˜¯å¦ä¸º ERR_UNKNOWN_URL_SCHEME é”™è¯¯ï¼Œä¸” URL æ˜¯ç‰¹æ®Š scheme
                            if (errorCode == -2 || errorDescription?.contains("ERR_UNKNOWN_URL_SCHEME") == true || 
                                errorDescription?.contains("net::ERR_UNKNOWN_URL_SCHEME") == true) {
                                if (url != null && handleSpecialSchemeUrl(url, view)) {
                                    // å·²å¤„ç†ç‰¹æ®Š schemeï¼Œä¸æ˜¾ç¤ºé”™è¯¯é¡µé¢
                                    Log.d(TAG, "å·²é€šè¿‡ handleSpecialSchemeUrl å¤„ç†ç‰¹æ®Š scheme: $url")
                                    return
                                }
                            }
                            
                            super.onReceivedError(view, request, error)
                        }
                        
                        @Deprecated("Deprecated in Java")
                        override fun onReceivedError(view: WebView?, errorCode: Int, description: String?, failingUrl: String?) {
                            Log.e(TAG, "è¯­éŸ³èƒ¶å›ŠWebViewåŠ è½½é”™è¯¯ (legacy): $description, URL: $failingUrl, ErrorCode: $errorCode")
                            
                            // æ£€æŸ¥æ˜¯å¦ä¸º ERR_UNKNOWN_URL_SCHEME é”™è¯¯ï¼ˆé”™è¯¯ä»£ç  -2ï¼‰
                            if (errorCode == -2 || description?.contains("ERR_UNKNOWN_URL_SCHEME") == true || 
                                description?.contains("net::ERR_UNKNOWN_URL_SCHEME") == true) {
                                if (failingUrl != null && handleSpecialSchemeUrl(failingUrl, view)) {
                                    // å·²å¤„ç†ç‰¹æ®Š schemeï¼Œä¸æ˜¾ç¤ºé”™è¯¯é¡µé¢
                                    Log.d(TAG, "å·²é€šè¿‡ handleSpecialSchemeUrl å¤„ç†ç‰¹æ®Š scheme (legacy): $failingUrl")
                                    return
                                }
                            }
                            
                            super.onReceivedError(view, errorCode, description, failingUrl)
                        }
                    }
                    
                    // è®¾ç½®WebChromeClienté˜»æ­¢æ–°çª—å£
                    webView?.webChromeClient = object : WebChromeClient() {
                        override fun onCreateWindow(view: WebView?, isDialog: Boolean, isUserGesture: Boolean, resultMsg: android.os.Message?): Boolean {
                            Log.d(TAG, "é˜»æ­¢WebViewåˆ›å»ºæ–°çª—å£")
                            return true // é˜»æ­¢åˆ›å»ºæ–°çª—å£
                        }
                        
                        override fun onJsAlert(view: WebView?, url: String?, message: String?, result: android.webkit.JsResult?): Boolean {
                            Log.d(TAG, "å¤„ç†JavaScriptå¼¹çª—: $message")
                            result?.confirm()
                            return true
                        }
                    }
                    
                    // ç¡®ä¿WebViewè®¾ç½®æ­£ç¡®ï¼Œå®Œå…¨é˜»æ­¢å¤–éƒ¨æµè§ˆå™¨
                    webView?.settings?.apply {
                        setSupportMultipleWindows(false)
                        javaScriptCanOpenWindowsAutomatically = false
                        userAgentString = "Mozilla/5.0 (Linux; Android 10; Mobile) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Mobile Safari/537.36"
                        
                        // é¢å¤–çš„å®‰å…¨è®¾ç½®
                        allowFileAccess = false
                        allowContentAccess = false
                        allowFileAccessFromFileURLs = false
                        allowUniversalAccessFromFileURLs = false
                        
                        // ç¡®ä¿JavaScriptä¸ä¼šæ‰“å¼€å¤–éƒ¨é“¾æ¥
                        javaScriptEnabled = true
                        domStorageEnabled = true
                        loadWithOverviewMode = true
                        useWideViewPort = true
                        
                        // ç¡®ä¿æ»šåŠ¨æ­£å¸¸å·¥ä½œ
                        setSupportZoom(true)
                        builtInZoomControls = false
                        displayZoomControls = false
                        textZoom = 100
                    }
                    
                    // ç¡®ä¿WebViewä¸ä¼šå¤±å»ç„¦ç‚¹
                    webView?.isFocusable = true
                    webView?.isFocusableInTouchMode = true
                    
                    // ç¡®ä¿WebViewå¯ä»¥æ­£å¸¸æ»šåŠ¨ - ä½¿ç”¨é»˜è®¤å®‰å…¨çš„æ»šåŠ¨æ¡è®¾ç½®
                    try {
                        webView?.isVerticalScrollBarEnabled = true
                        webView?.isHorizontalScrollBarEnabled = false
                        // ä½¿ç”¨é»˜è®¤çš„æ»šåŠ¨æ¡æ ·å¼ï¼Œé¿å…null pointerå¼‚å¸¸
                        webView?.scrollBarStyle = View.SCROLLBARS_OUTSIDE_OVERLAY
                    } catch (e: Exception) {
                        Log.e(TAG, "è®¾ç½®WebViewæ»šåŠ¨æ¡å¤±è´¥", e)
                    }
                    
                    webView?.loadUrl(searchUrl)
                }
            }
            
            // æ›´æ–°æœç´¢è¾“å…¥æ¡†çš„æ–‡æœ¬
            val dualSearchInput = findViewById<EditText>(R.id.dual_search_input)
            dualSearchInput?.setText(query)
            
            // æ˜¾ç¤ºå¹³å°å›¾æ ‡
            showVoiceCapsulePlatformIcons(query)
            
            Log.d(TAG, "è¯­éŸ³èƒ¶å›ŠWebViewæœç´¢å®Œæˆ")
        } catch (e: Exception) {
            Log.e(TAG, "åœ¨è¯­éŸ³èƒ¶å›ŠWebViewä¸­æ‰§è¡Œæœç´¢å¤±è´¥", e)
            Toast.makeText(this, "æœç´¢å¤±è´¥ï¼Œè¯·é‡è¯•", Toast.LENGTH_SHORT).show()
        }
    }
    
    /**
     * åˆ·æ–°èƒ¶å›ŠWebView
     */
    private fun refreshCapsuleWebViews() {
        try {
            val query = voiceCapsuleTextInput?.text?.toString()?.trim()
            if (!query.isNullOrEmpty()) {
                // ä½¿ç”¨å†…åµŒWebViewæœç´¢ï¼Œä¸ä½¿ç”¨DualFloatingWebViewService
                performCapsuleWebViewSearch(query)
            }
        } catch (e: Exception) {
            Log.e(TAG, "åˆ·æ–°èƒ¶å›ŠWebViewå¤±è´¥", e)
        }
    }
    
    /**
     * æ˜¾ç¤ºè¯­éŸ³èƒ¶å›Šå¹³å°å›¾æ ‡
     */
    private fun showVoiceCapsulePlatformIcons(query: String) {
        try {
            // æ˜¾ç¤ºAIåº”ç”¨å›¾æ ‡è€Œä¸æ˜¯å¹³å°å›¾æ ‡
            showVoiceCapsuleAIApps(query)
            Log.d(TAG, "å·²æ˜¾ç¤ºè¯­éŸ³èƒ¶å›ŠAIåº”ç”¨å›¾æ ‡ï¼ŒæŸ¥è¯¢: $query")
        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºè¯­éŸ³èƒ¶å›ŠAIåº”ç”¨å›¾æ ‡å¤±è´¥", e)
        }
    }
    
    /**
     * æ˜¾ç¤ºè¯­éŸ³èƒ¶å›ŠAIåº”ç”¨å›¾æ ‡ - æ˜¾ç¤ºç”¨æˆ·å¸¸ç”¨çš„AIåº”ç”¨
     */
    private fun showVoiceCapsuleAIApps(query: String) {
        try {
            voiceCapsuleAIAppsContainer?.visibility = View.VISIBLE
            voiceCapsuleAIAppsView?.removeAllViews()
            
            // è·å–å¸¸ç”¨AIåº”ç”¨é…ç½®
            val favoriteAIManager = com.example.aifloatingball.manager.FavoriteAIManager.getInstance(this)
            val appSearchSettings = com.example.aifloatingball.model.AppSearchSettings.getInstance(this)
            val allConfigs = appSearchSettings.getAppConfigs()
            val favoriteAIs = favoriteAIManager.getFavoriteAIConfigs(allConfigs)
            
            // å¦‚æœå¸¸ç”¨AIä¸è¶³ï¼Œä½¿ç”¨é»˜è®¤AIè¡¥å……
            val defaultAIs = listOf(
                com.example.aifloatingball.model.AppSearchConfig(
                    appId = "chatgpt",
                    appName = "ChatGPT",
                    packageName = "com.openai.chatgpt",
                    isEnabled = true,
                    order = 1,
                    iconResId = R.drawable.ic_web_default,
                    searchUrl = "",
                    category = com.example.aifloatingball.model.AppCategory.AI
                ),
                com.example.aifloatingball.model.AppSearchConfig(
                    appId = "kimi",
                    appName = "Kimi",
                    packageName = "com.moonshot.kimichat",
                    isEnabled = true,
                    order = 2,
                    iconResId = R.drawable.ic_web_default,
                    searchUrl = "",
                    category = com.example.aifloatingball.model.AppCategory.AI
                ),
                com.example.aifloatingball.model.AppSearchConfig(
                    appId = "deepseek",
                    appName = "DeepSeek",
                    packageName = "com.deepseek.chat",
                    isEnabled = true,
                    order = 3,
                    iconResId = R.drawable.ic_web_default,
                    searchUrl = "",
                    category = com.example.aifloatingball.model.AppCategory.AI
                ),
                com.example.aifloatingball.model.AppSearchConfig(
                    appId = "gemini",
                    appName = "Gemini",
                    packageName = "com.google.android.apps.gemini",
                    isEnabled = true,
                    order = 4,
                    iconResId = R.drawable.ic_web_default,
                    searchUrl = "",
                    category = com.example.aifloatingball.model.AppCategory.AI
                ),
                com.example.aifloatingball.model.AppSearchConfig(
                    appId = "claude",
                    appName = "Claude",
                    packageName = "com.anthropic.claude",
                    isEnabled = true,
                    order = 5,
                    iconResId = R.drawable.ic_web_default,
                    searchUrl = "",
                    category = com.example.aifloatingball.model.AppCategory.AI
                )
            )
            
            val displayAIs = mutableListOf<com.example.aifloatingball.model.AppSearchConfig>()
            
            // å…ˆæ·»åŠ å¸¸ç”¨AI
            displayAIs.addAll(favoriteAIs.take(8))
            
            // å¦‚æœä¸è¶³8ä¸ªï¼Œæ·»åŠ é»˜è®¤AI
            if (displayAIs.size < 8) {
                val usedAppIds = displayAIs.map { it.appId }.toSet()
                defaultAIs.filter { it.appId !in usedAppIds }
                    .take(8 - displayAIs.size)
                    .forEach { displayAIs.add(it) }
            }
            
            // æ£€æŸ¥å·²å®‰è£…çš„åº”ç”¨å¹¶æ˜¾ç¤ºå›¾æ ‡
            displayAIs.forEach { config ->
                try {
                    // æ£€æŸ¥åº”ç”¨æ˜¯å¦å·²å®‰è£…
                    val packageInfo = packageManager.getPackageInfo(config.packageName, 0)
                    if (packageInfo != null) {
                        val iconView = createAIIconView(config, query)
                        voiceCapsuleAIAppsView?.addView(iconView)
                    }
                } catch (e: Exception) {
                    // åº”ç”¨æœªå®‰è£…ï¼Œè·³è¿‡
                    Log.d(TAG, "AIåº”ç”¨æœªå®‰è£…: ${config.appName} (${config.packageName})")
                }
            }
            
            Log.d(TAG, "å·²æ˜¾ç¤º${voiceCapsuleAIAppsView?.childCount ?: 0}ä¸ªAIåº”ç”¨å›¾æ ‡")
        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºè¯­éŸ³èƒ¶å›ŠAIåº”ç”¨å›¾æ ‡å¤±è´¥", e)
        }
    }
    
    /**
     * åˆ›å»ºAIåº”ç”¨å›¾æ ‡è§†å›¾
     */
    private fun createAIIconView(config: com.example.aifloatingball.model.AppSearchConfig, query: String): ImageView {
        val iconSize = resources.getDimensionPixelSize(R.dimen.platform_icon_size)
        val iconMargin = resources.getDimensionPixelSize(R.dimen.platform_icon_margin)
        
        val iconView = ImageView(this).apply {
            layoutParams = LinearLayout.LayoutParams(iconSize, iconSize).apply {
                marginEnd = iconMargin
            }
            
            // åŠ è½½åº”ç”¨å›¾æ ‡
            try {
                val appInfo = packageManager.getApplicationInfo(config.packageName, 0)
                val icon = packageManager.getApplicationIcon(config.packageName)
                setImageDrawable(icon)
            } catch (e: Exception) {
                // å¦‚æœåŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å›¾æ ‡
                setImageResource(R.drawable.ic_ai_assistant)
            }
            
            scaleType = ImageView.ScaleType.CENTER_CROP
            background = ContextCompat.getDrawable(this@SimpleModeActivity, R.drawable.voice_capsule_app_icon_background)
            
            // è®¾ç½®ç‚¹å‡»äº‹ä»¶ - è·³è½¬åˆ°AIåº”ç”¨å¹¶ä¼ é€’æŸ¥è¯¢å†…å®¹
            setOnClickListener {
                launchAIAppForVoiceCapsule(config.packageName, config.appName, query)
            }
            
            contentDescription = "åœ¨${config.appName}æŸ¥è¯¢: $query"
        }
        
        return iconView
    }
    
    /**
     * å¯åŠ¨AIåº”ç”¨å¹¶ä¼ é€’æŸ¥è¯¢å†…å®¹
     */
    private fun launchAIAppForVoiceCapsule(packageName: String, appName: String, query: String) {
        try {
            Log.d(TAG, "å¯åŠ¨AIåº”ç”¨: $appName, åŒ…å: $packageName, æŸ¥è¯¢: $query")
            
            // å°†æŸ¥è¯¢å†…å®¹å¤åˆ¶åˆ°å‰ªè´´æ¿
            val clipboard = getSystemService(Context.CLIPBOARD_SERVICE) as android.content.ClipboardManager
            val clip = android.content.ClipData.newPlainText("AIé—®é¢˜", query)
            clipboard.setPrimaryClip(clip)
            
            // å¯åŠ¨AIåº”ç”¨
            val launchIntent = packageManager.getLaunchIntentForPackage(packageName)
            if (launchIntent != null) {
                launchIntent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
                startActivity(launchIntent)
                Toast.makeText(this, "æ­£åœ¨å¯åŠ¨$appName...", Toast.LENGTH_SHORT).show()
            } else {
                Toast.makeText(this, "$appName æœªå®‰è£…", Toast.LENGTH_SHORT).show()
            }
        } catch (e: Exception) {
            Log.e(TAG, "å¯åŠ¨AIåº”ç”¨å¤±è´¥: $appName", e)
            Toast.makeText(this, "å¯åŠ¨${appName}å¤±è´¥", Toast.LENGTH_SHORT).show()
        }
    }
    
    /**
     * éšè—è¯­éŸ³èƒ¶å›Šå¹³å°å›¾æ ‡
     */
    private fun hideVoiceCapsulePlatformIcons() {
        try {
            voiceCapsulePlatformIconsContainer?.visibility = View.GONE
            Log.d(TAG, "å·²éšè—è¯­éŸ³èƒ¶å›Šå¹³å°å›¾æ ‡")
        } catch (e: Exception) {
            Log.e(TAG, "éšè—è¯­éŸ³èƒ¶å›Šå¹³å°å›¾æ ‡å¤±è´¥", e)
        }
    }
    
    /**
     * åˆ‡æ¢åˆ°ä¸‰æ®µå¼èƒ¶å›Šå¸ƒå±€
     */
    private fun switchToVoiceCapsuleLayout(text: String) {
        try {
            runOnUiThread {
                // éšè—åŸå§‹è¯­éŸ³å¸ƒå±€
                findViewById<LinearLayout>(R.id.voice_original_layout)?.visibility = View.GONE
                
                // æ˜¾ç¤ºèƒ¶å›Šå¸ƒå±€
                voiceCapsuleLayout?.visibility = View.VISIBLE
                
                // è®¾ç½®è¯†åˆ«æ–‡æœ¬åˆ°èƒ¶å›Šè¾“å…¥æ¡†
                voiceCapsuleTextInput?.setText(text)
                
                // æ˜¾ç¤ºå¹³å°å›¾æ ‡
                showVoiceCapsulePlatformIcons(text)
                
                // è®¾ç½®ä¸ºèƒ¶å›Šæ¨¡å¼
                isVoiceCapsuleMode = true
                
                // åœæ­¢å½•éŸ³çŠ¶æ€
                updateCapsuleRecordingState(false)
                
                // è‡ªåŠ¨å¼€å§‹å½•éŸ³
                startAutoRecording()
                
                Log.d(TAG, "å·²åˆ‡æ¢åˆ°ä¸‰æ®µå¼èƒ¶å›Šå¸ƒå±€ï¼Œæ–‡æœ¬: $textï¼Œè‡ªåŠ¨å¼€å§‹å½•éŸ³")
            }
        } catch (e: Exception) {
            Log.e(TAG, "åˆ‡æ¢åˆ°ä¸‰æ®µå¼èƒ¶å›Šå¸ƒå±€å¤±è´¥", e)
        }
    }
    
    /**
     * æ‰§è¡Œèƒ¶å›Šå¸ƒå±€ä¸­çš„ç½‘ç»œæœç´¢ - ä½¿ç”¨å†…åµŒWebView
     */
    private fun performCapsuleWebSearch() {
        try {
            val query = voiceCapsuleSearchInput?.text?.toString()?.trim()
            if (!query.isNullOrEmpty()) {
                Log.d(TAG, "æ‰§è¡Œèƒ¶å›Šç½‘ç»œæœç´¢: $query")
                
                // ä½¿ç”¨å†…åµŒWebViewè¿›è¡Œæœç´¢ï¼Œä¸ä½¿ç”¨DualFloatingWebViewService
                performCapsuleWebViewSearch(query)
                
                // æ›´æ–°æœç´¢çŠ¶æ€
                updateCapsuleSearchStatus("æ­£åœ¨æœç´¢...")
            }
        } catch (e: Exception) {
            Log.e(TAG, "èƒ¶å›Šç½‘ç»œæœç´¢å¤±è´¥", e)
            Toast.makeText(this, "æœç´¢å¤±è´¥ï¼Œè¯·é‡è¯•", Toast.LENGTH_SHORT).show()
        }
    }
    
    
    /**
     * è®¾ç½®èƒ¶å›Šå¸ƒå±€ä¸­å¿«æ·æ“ä½œæŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
     * æ³¨æ„ï¼šæ­¤æ–¹æ³•å·²åºŸå¼ƒï¼Œå› ä¸ºå¿«æ·æ“ä½œæŒ‰é’®å·²è¢«å¹³å°å›¾æ ‡æ›¿æ¢
     */
    @Deprecated("å¿«æ·æ“ä½œæŒ‰é’®å·²è¢«å¹³å°å›¾æ ‡æ›¿æ¢")
    private fun setupCapsuleQuickActionButtons() {
        // æ­¤æ–¹æ³•å·²åºŸå¼ƒï¼Œå¿«æ·æ“ä½œæŒ‰é’®å·²è¢«å¹³å°å›¾æ ‡æ›¿æ¢
        // å¹³å°å›¾æ ‡çš„ç‚¹å‡»äº‹ä»¶ç”±PlatformIconsViewå†…éƒ¨å¤„ç†
        Log.d(TAG, "å¿«æ·æ“ä½œæŒ‰é’®å·²è¢«å¹³å°å›¾æ ‡æ›¿æ¢ï¼Œæ­¤æ–¹æ³•å·²åºŸå¼ƒ")
    }

    /**
     * æ˜¾ç¤ºæ›´å¤šé€‰é¡¹å¯¹è¯æ¡†
     */
    private fun showMoreOptionsDialog() {
        try {
            val options = arrayOf("æ¸…ç©ºæ–‡æœ¬", "å¤åˆ¶æ–‡æœ¬")
            
            AlertDialog.Builder(this)
                .setTitle("æ›´å¤šé€‰é¡¹")
                .setItems(options) { _, which ->
                    when (which) {
                        0 -> clearText()
                        1 -> copyText()
                    }
                }
                .setNegativeButton("å–æ¶ˆ", null)
                .show()
        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºæ›´å¤šé€‰é¡¹å¯¹è¯æ¡†å¤±è´¥", e)
        }
    }

    
    /**
     * å¯åŠ¨åº”ç”¨å¹¶è¿›è¡Œæœç´¢
     */
    private fun launchAppWithSearch(packageName: String, appName: String, query: String) {
        try {
            Log.d(TAG, "å¯åŠ¨åº”ç”¨å¹¶è¿›è¡Œæœç´¢: $appName, æŸ¥è¯¢: $query")
            
            // æ£€æŸ¥åº”ç”¨æ˜¯å¦å·²å®‰è£…
            if (!isAppInstalled(packageName)) {
                Toast.makeText(this, "$appName æœªå®‰è£…", Toast.LENGTH_SHORT).show()
                return
            }
            
            // å°†æŸ¥è¯¢å†…å®¹å¤åˆ¶åˆ°å‰ªè´´æ¿
            val clipboard = getSystemService(Context.CLIPBOARD_SERVICE) as ClipboardManager
            val clip = ClipData.newPlainText("æœç´¢å†…å®¹", query)
            clipboard.setPrimaryClip(clip)
            
            // å¯åŠ¨åº”ç”¨
            val launchIntent = packageManager.getLaunchIntentForPackage(packageName)
            if (launchIntent != null) {
                launchIntent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
                startActivity(launchIntent)
                Toast.makeText(this, "å·²å¯åŠ¨ $appNameï¼Œå†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿", Toast.LENGTH_SHORT).show()
                Log.d(TAG, "$appName å¯åŠ¨æˆåŠŸ")
            } else {
                Toast.makeText(this, "æ— æ³•å¯åŠ¨ $appName", Toast.LENGTH_SHORT).show()
            }
        } catch (e: Exception) {
            Log.e(TAG, "å¯åŠ¨åº”ç”¨å¹¶æœç´¢å¤±è´¥: $appName", e)
            Toast.makeText(this, "å¯åŠ¨ $appName å¤±è´¥", Toast.LENGTH_SHORT).show()
        }
    }
    
    /**
     * å¯åŠ¨AIåº”ç”¨å¹¶æ˜¾ç¤ºæ‚¬æµ®çª—
     */
    private fun launchAIApp(packageName: String, appName: String, query: String) {
        try {
            Log.d(TAG, "å¯åŠ¨AIåº”ç”¨: $appName, æŸ¥è¯¢: $query")
            
            // å¯åŠ¨AIåº”ç”¨æ‚¬æµ®çª—æœåŠ¡
            val overlayIntent = Intent(this, AIAppOverlayService::class.java).apply {
                putExtra(AIAppOverlayService.EXTRA_APP_NAME, appName)
                putExtra(AIAppOverlayService.EXTRA_QUERY, query)
                putExtra(AIAppOverlayService.EXTRA_PACKAGE_NAME, packageName)
                putExtra("mode", "simple")
            }
            startService(overlayIntent)
            
            // æ˜¾ç¤ºå¯åŠ¨æç¤º
            Toast.makeText(this, "å·²å¯åŠ¨ $appName", Toast.LENGTH_SHORT).show()
            
        } catch (e: Exception) {
            Log.e(TAG, "å¯åŠ¨AIåº”ç”¨å¤±è´¥", e)
            Toast.makeText(this, "å¯åŠ¨ $appName å¤±è´¥", Toast.LENGTH_SHORT).show()
        }
    }
    
    /**
     * æ˜¾ç¤ºæ›´å¤šAIåº”ç”¨å¯¹è¯æ¡†
     */
    private fun showMoreAIAppsDialog() {
        try {
            val apps = listOf(
                "ChatGPT" to "com.openai.chatgpt",
                "Claude" to "com.anthropic.claude",
                "Gemini" to "com.google.gemini",
                "æ–‡å¿ƒä¸€è¨€" to "com.baidu.wenxin",
                "é€šä¹‰åƒé—®" to "com.alibaba.tongyi"
            )
            
            val appNames = apps.map { it.first }.toTypedArray()
            
            AlertDialog.Builder(this)
                .setTitle("é€‰æ‹©AIåº”ç”¨")
                .setItems(appNames) { _, which ->
                    val (appName, packageName) = apps[which]
                    launchAIApp(packageName, appName, voiceCapsuleTextInput?.text?.toString() ?: "")
                }
                .setNegativeButton("å–æ¶ˆ", null)
                .show()
        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºæ›´å¤šAIåº”ç”¨å¯¹è¯æ¡†å¤±è´¥", e)
        }
    }
    
    /**
     * æ›´æ–°èƒ¶å›Šæœç´¢çŠ¶æ€
     */
    private fun updateCapsuleSearchStatus(status: String) {
        try {
            runOnUiThread {
                // å¯ä»¥åœ¨è¿™é‡Œæ›´æ–°æœç´¢çŠ¶æ€æ˜¾ç¤º
                Log.d(TAG, "èƒ¶å›Šæœç´¢çŠ¶æ€: $status")
            }
        } catch (e: Exception) {
            Log.e(TAG, "æ›´æ–°èƒ¶å›Šæœç´¢çŠ¶æ€å¤±è´¥", e)
        }
    }
    
    /**
     * é€€å‡ºèƒ¶å›Šæ¨¡å¼
     */
    private fun exitVoiceCapsuleMode() {
        try {
            runOnUiThread {
                // éšè—èƒ¶å›Šå¸ƒå±€
                voiceCapsuleLayout?.visibility = View.GONE
                
                // éšè—å¹³å°å›¾æ ‡
                hideVoiceCapsulePlatformIcons()
                
                // æ˜¾ç¤ºåŸå§‹è¯­éŸ³å¸ƒå±€
                findViewById<LinearLayout>(R.id.voice_original_layout)?.visibility = View.VISIBLE
                
                // é‡ç½®èƒ¶å›Šæ¨¡å¼æ ‡å¿—
                isVoiceCapsuleMode = false
                
                Log.d(TAG, "å·²é€€å‡ºèƒ¶å›Šæ¨¡å¼")
            }
        } catch (e: Exception) {
            Log.e(TAG, "é€€å‡ºèƒ¶å›Šæ¨¡å¼å¤±è´¥", e)
        }
    }
    
    // ==================== TTSæœ—è¯»åŠŸèƒ½ ====================
    
    /**
     * åˆå§‹åŒ–TTSç®¡ç†å™¨
     */
    private fun initializeTTS() {
        try {
            // åˆå§‹åŒ–TTSç®¡ç†å™¨
            ttsManager = TTSManager.getInstance(this)
            ttsManager.setStatusListener(object : TTSManager.TTSStatusListener {
                override fun onInitialized() {
                    Log.d(TAG, "TTSå¼•æ“åˆå§‹åŒ–å®Œæˆ")
                }
                override fun onStart(utteranceId: String?) {
                    Log.d(TAG, "TTSå¼€å§‹æœ—è¯»: $utteranceId")
                }
                override fun onComplete(utteranceId: String?) {
                    Log.d(TAG, "TTSæœ—è¯»å®Œæˆ: $utteranceId")
                    runOnUiThread {
                        // å¦‚æœæ˜¯éº¦å…‹é£TTSæœ—è¯»å®Œæˆï¼Œæ¢å¤æŒ‰é’®çŠ¶æ€
                        if (utteranceId == "mic_tts_reading") {
                            voiceStatusText.text = if (isMicInTTSMode) "TTSæœ—è¯»æ¨¡å¼ - ç‚¹å‡»æœ—è¯»AIå›å¤" else "ç‚¹å‡»éº¦å…‹é£å¼€å§‹è¯­éŸ³è¾“å…¥"
                            voiceMicContainer.setCardBackgroundColor(
                                if (isMicInTTSMode) 
                                    ContextCompat.getColor(this@SimpleModeActivity, android.R.color.holo_blue_light)
                                else 
                                    ContextCompat.getColor(this@SimpleModeActivity, R.color.simple_mode_accent_light)
                            )
                        }
                    }
                }
                override fun onStop(utteranceId: String?, interrupted: Boolean) {
                    Log.d(TAG, "TTSæœ—è¯»åœæ­¢: $utteranceId, è¢«ä¸­æ–­: $interrupted")
                }
                override fun onError(error: String) {
                    Log.e(TAG, "TTSé”™è¯¯: $error")
                    runOnUiThread {
                        // æ˜¾ç¤ºTTSé”™è¯¯å¯¹è¯æ¡†
                        showSimpleModeTTSErrorDialog(error)
                    }
                }
                override fun onSupportLevelChanged(supportLevel: TTSSupportLevel, engineInfo: TTSEngineInfo?) {
                    Log.d(TAG, "TTSæ”¯æŒçº§åˆ«å˜åŒ–: $supportLevel")
                    runOnUiThread {
                        if (supportLevel == TTSSupportLevel.NO_SUPPORT || 
                            supportLevel == TTSSupportLevel.ENGINE_UNAVAILABLE) {
                            showSimpleModeTTSNotSupportedDialog(supportLevel, engineInfo)
                        }
                    }
                }
            })
            
            // æ£€æŸ¥TTSæ”¯æŒ
            if (!ttsManager.isTTSSupported()) {
                Log.w(TAG, "è®¾å¤‡ä¸æ”¯æŒTTSåŠŸèƒ½")
                Toast.makeText(this, "è®¾å¤‡ä¸æ”¯æŒæœ—è¯»åŠŸèƒ½", Toast.LENGTH_LONG).show()
            } else {
                // é»˜è®¤å¯ç”¨TTSåŠŸèƒ½
                isTTSEnabled = true
                ttsManager.setEnabled(true)
                Log.d(TAG, "TTSåŠŸèƒ½å·²é»˜è®¤å¯ç”¨")
            }
            
            // å¼ºåˆ¶å¯ç”¨TTSåŠŸèƒ½ç”¨äºæµ‹è¯•
            if (!isTTSEnabled) {
                Log.w(TAG, "å¼ºåˆ¶å¯ç”¨TTSåŠŸèƒ½ç”¨äºæµ‹è¯•")
                isTTSEnabled = true
                ttsManager.setEnabled(true)
            }
            
            // å¼ºåˆ¶åˆå§‹åŒ–TTSï¼Œç¡®ä¿TTSå¯ç”¨
            ttsManager.forceInitializeTTS()
            
            // è°ƒè¯•ï¼šæ£€æŸ¥TTSçŠ¶æ€
            Log.d(TAG, "TTSåˆå§‹åŒ–å®Œæˆ:")
            Log.d(TAG, "  TTSæ˜¯å¦æ”¯æŒ: ${ttsManager.isTTSSupported()}")
            Log.d(TAG, "  TTSæ˜¯å¦å¯ç”¨: ${ttsManager.isAvailable()}")
            Log.d(TAG, "  TTSæ˜¯å¦å¯ç”¨: $isTTSEnabled")
            
            Log.d(TAG, "TTSç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ")
        } catch (e: Exception) {
            Log.e(TAG, "åˆå§‹åŒ–TTSç®¡ç†å™¨å¤±è´¥", e)
        }
    }
    
    
    /**
     * æ˜¾ç¤ºSimpleMode TTSé”™è¯¯å¯¹è¯æ¡†
     */
    private fun showSimpleModeTTSErrorDialog(error: String) {
        val builder = androidx.appcompat.app.AlertDialog.Builder(this)
        builder.setTitle("æœ—è¯»åŠŸèƒ½é”™è¯¯")
        builder.setMessage("æœ—è¯»æ—¶å‘ç”Ÿé”™è¯¯ï¼š$error\n\næ˜¯å¦è¦æ‰“å¼€TTSè®¾ç½®ï¼Ÿ")
        builder.setPositiveButton("æ‰“å¼€è®¾ç½®") { _, _ ->
            ttsManager.openTTSSettings()
        }
        builder.setNegativeButton("å–æ¶ˆ", null)
        builder.show()
    }
    
    
    /**
     * æ‰§è¡ŒTTSè¯Šæ–­
     */
    private fun performTTSDiagnostic() {
        try {
            val diagnosticTool = TTSDiagnosticTool(this)
            val result = diagnosticTool.performFullDiagnostic()
            
            val builder = androidx.appcompat.app.AlertDialog.Builder(this)
            builder.setTitle("TTSè¯Šæ–­ç»“æœ")
            builder.setMessage(result.getSummary())
            builder.setPositiveButton("æ‰“å¼€è®¾ç½®") { _, _ ->
                diagnosticTool.openTTSSettings()
            }
            builder.setNegativeButton("å…³é—­", null)
            builder.show()
            
        } catch (e: Exception) {
            Log.e(TAG, "TTSè¯Šæ–­å¤±è´¥", e)
            Toast.makeText(this, "TTSè¯Šæ–­å¤±è´¥: ${e.message}", Toast.LENGTH_LONG).show()
        }
    }
    
    /**
     * æ˜¾ç¤ºSimpleMode TTSä¸æ”¯æŒå¯¹è¯æ¡†
     */
    private fun showSimpleModeTTSNotSupportedDialog(supportLevel: TTSSupportLevel, engineInfo: TTSEngineInfo?) {
        val builder = androidx.appcompat.app.AlertDialog.Builder(this)
        builder.setTitle("æœ—è¯»åŠŸèƒ½ä¸å¯ç”¨")
        
        val message = when (supportLevel) {
            TTSSupportLevel.NO_SUPPORT -> "è®¾å¤‡ä¸æ”¯æŒTTSåŠŸèƒ½\n\nè§£å†³æ–¹æ¡ˆï¼š\n1. æ£€æŸ¥ç³»ç»Ÿè®¾ç½®ä¸­çš„TTSé€‰é¡¹\n2. å®‰è£…TTSå¼•æ“ï¼ˆå¦‚Google TTSï¼‰\n3. ç¡®ä¿ç³»ç»Ÿè¯­è¨€åŒ…å·²å®‰è£…"
            TTSSupportLevel.ENGINE_UNAVAILABLE -> "TTSå¼•æ“ä¸å¯ç”¨\n\nè§£å†³æ–¹æ¡ˆï¼š\n1. åœ¨è®¾ç½®ä¸­å¯ç”¨TTSåŠŸèƒ½\n2. å®‰è£…TTSå¼•æ“\n3. é‡å¯åº”ç”¨"
            TTSSupportLevel.PERMISSION_DENIED -> "TTSæƒé™è¢«æ‹’ç»\n\nè§£å†³æ–¹æ¡ˆï¼š\n1. åœ¨ç³»ç»Ÿè®¾ç½®ä¸­å…è®¸TTSæƒé™\n2. æ£€æŸ¥æ— éšœç¢æœåŠ¡è®¾ç½®"
            else -> "TTSåŠŸèƒ½ä¸å¯ç”¨\n\nè¯·æ£€æŸ¥ç³»ç»Ÿè®¾ç½®"
        }
        
        val engineInfoText = engineInfo?.let { 
            "\n\nå½“å‰å¼•æ“ï¼š${it.engineName}\næ”¯æŒä¸­æ–‡ï¼š${it.hasChineseSupport}\næ”¯æŒè‹±æ–‡ï¼š${it.hasEnglishSupport}"
        } ?: ""
        
        builder.setMessage("$message$engineInfoText\n\nè¯·é€‰æ‹©è§£å†³æ–¹æ¡ˆï¼š")
        builder.setPositiveButton("æ‰“å¼€è®¾ç½®") { _, _ ->
            ttsManager.openTTSSettings()
        }
        builder.setNeutralButton("é‡è¯•æ£€æµ‹") { _, _ ->
            // é‡æ–°æ£€æµ‹TTSæ”¯æŒ
            ttsManager.reinitializeTTS()
        }
        builder.setNegativeButton("é‡æ–°æ£€æµ‹") { _, _ ->
            // é‡æ–°æ£€æµ‹TTSæ”¯æŒ
            ttsManager.reinitializeTTS()
            Toast.makeText(this@SimpleModeActivity, "æ­£åœ¨é‡æ–°æ£€æµ‹TTSæ”¯æŒ", Toast.LENGTH_SHORT).show()
        }
        builder.show()
    }
    
    /**
     * æœ—è¯»AIå›å¤å†…å®¹
     */
    private fun speakAIResponse(content: String) {
        if (!isTTSEnabled || !ttsManager.isAvailable()) {
            return
        }
        
        try {
            Log.d(TAG, "å¼€å§‹æœ—è¯»AIå›å¤: ${content.take(50)}...")
            ttsManager.speak(content, "simple_mode_ai_response")
        } catch (e: Exception) {
            Log.e(TAG, "æœ—è¯»AIå›å¤å¤±è´¥", e)
        }
    }
    
    /**
     * æ‰§è¡ŒTTSæœ—è¯»åŠŸèƒ½ - è¯»å–æ‰€æœ‰AIçš„æœ€æ–°å›å¤
     */
    private fun performTTSReading() {
        try {
            Log.d(TAG, "å¼€å§‹æ‰§è¡ŒTTSæœ—è¯» - isTTSEnabled: $isTTSEnabled, ttsManager.isAvailable(): ${ttsManager.isAvailable()}")
            
            if (!isTTSEnabled || !ttsManager.isAvailable()) {
                Log.w(TAG, "TTSåŠŸèƒ½ä¸å¯ç”¨ - isTTSEnabled: $isTTSEnabled, isAvailable: ${ttsManager.isAvailable()}")
                voiceStatusText.text = "TTSåŠŸèƒ½ä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥è®¾ç½®"
                Toast.makeText(this, "TTSåŠŸèƒ½ä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥è®¾ç½®", Toast.LENGTH_SHORT).show()
                return
            }
            
            // è·å–æ‰€æœ‰AIçš„æœ€æ–°å›å¤
            val aiNames = listOf("DeepSeek", "Kimi", "æ™ºè°±AI", "ChatGPT", "Claude", "Gemini")
            val latestResponses = mutableListOf<String>()
            
            val chatDataManager = com.example.aifloatingball.data.ChatDataManager.getInstance(this)
            
            aiNames.forEach { aiName ->
                val serviceType = getAIServiceTypeFromName(aiName)
                if (serviceType != null) {
                    val processedName = if (aiName.contains(Regex("[\\u4e00-\\u9fff]"))) {
                        aiName
                    } else {
                        aiName.lowercase()
                    }
                    val contactId = "ai_${processedName.replace(" ", "_")}"
                    
                    val messages = chatDataManager.getMessages(contactId, serviceType)
                    if (messages.isNotEmpty()) {
                        val lastMessage = messages.last()
                        if (lastMessage.role == "assistant") {
                            latestResponses.add("$aiName çš„å›å¤ï¼š${lastMessage.content}")
                        }
                    }
                }
            }
            
            if (latestResponses.isEmpty()) {
                // å¦‚æœæ²¡æœ‰AIå›å¤ï¼Œä½¿ç”¨æµ‹è¯•æ–‡æœ¬
                Log.d(TAG, "æ²¡æœ‰æ‰¾åˆ°AIå›å¤ï¼Œä½¿ç”¨æµ‹è¯•æ–‡æœ¬")
                val testText = "è¿™æ˜¯TTSæœ—è¯»åŠŸèƒ½æµ‹è¯•ã€‚å¦‚æœæ‚¨å¬åˆ°è¿™æ®µè¯­éŸ³ï¼Œè¯´æ˜TTSåŠŸèƒ½æ­£å¸¸å·¥ä½œã€‚"
                voiceStatusText.text = "æ­£åœ¨æœ—è¯»æµ‹è¯•æ–‡æœ¬..."
                voiceMicContainer.setCardBackgroundColor(ContextCompat.getColor(this, android.R.color.holo_blue_light))
                
                Log.d(TAG, "å¼€å§‹æœ—è¯»æµ‹è¯•æ–‡æœ¬")
                ttsManager.speak(testText, "mic_tts_reading")
                return
            }
            
            // åˆå¹¶æ‰€æœ‰å›å¤
            val combinedText = latestResponses.joinToString("\n\n")
            
            // æ›´æ–°UIçŠ¶æ€
            voiceStatusText.text = "æ­£åœ¨æœ—è¯»AIå›å¤..."
            voiceMicContainer.setCardBackgroundColor(ContextCompat.getColor(this, android.R.color.holo_blue_light))
            
            // å¼€å§‹æœ—è¯»
            Log.d(TAG, "å¼€å§‹æœ—è¯»æ‰€æœ‰AIå›å¤ï¼Œå…±${latestResponses.size}æ¡")
            ttsManager.speak(combinedText, "mic_tts_reading")
            
        } catch (e: Exception) {
            Log.e(TAG, "æ‰§è¡ŒTTSæœ—è¯»å¤±è´¥", e)
            voiceStatusText.text = "æœ—è¯»å¤±è´¥ï¼Œè¯·é‡è¯•"
            Toast.makeText(this, "æœ—è¯»å¤±è´¥ï¼š${e.message}", Toast.LENGTH_SHORT).show()
        }
    }
    
    /**
     * åˆ‡æ¢éº¦å…‹é£æŒ‰é’®æ¨¡å¼ï¼ˆè¯­éŸ³è¾“å…¥/TTSæœ—è¯»ï¼‰
     */
    private fun toggleMicMode() {
        Log.d(TAG, "éº¦å…‹é£æŒ‰é’®é•¿æŒ‰ - åˆ‡æ¢æ¨¡å¼")
        isMicInTTSMode = !isMicInTTSMode
        updateMicButtonAppearance()
        
        val modeText = if (isMicInTTSMode) "TTSæœ—è¯»æ¨¡å¼" else "è¯­éŸ³è¾“å…¥æ¨¡å¼"
        voiceStatusText.text = "å·²åˆ‡æ¢åˆ°$modeText"
        Toast.makeText(this, "éº¦å…‹é£æŒ‰é’®ï¼š$modeText", Toast.LENGTH_SHORT).show()
        
        Log.d(TAG, "éº¦å…‹é£æŒ‰é’®æ¨¡å¼åˆ‡æ¢ä¸ºï¼š$modeText")
    }
    
    /**
     * æ›´æ–°éº¦å…‹é£æŒ‰é’®å¤–è§‚
     */
    private fun updateMicButtonAppearance() {
        if (isMicInTTSMode) {
            // TTSæœ—è¯»æ¨¡å¼ - æ˜¾ç¤ºæ‰¬å£°å™¨å›¾æ ‡
            voiceMicIcon.setImageResource(android.R.drawable.ic_btn_speak_now)
            voiceMicContainer.setCardBackgroundColor(ContextCompat.getColor(this, android.R.color.holo_blue_light))
        } else {
            // è¯­éŸ³è¾“å…¥æ¨¡å¼ - æ˜¾ç¤ºéº¦å…‹é£å›¾æ ‡
            voiceMicIcon.setImageResource(R.drawable.ic_mic)
            voiceMicContainer.setCardBackgroundColor(ContextCompat.getColor(this, R.color.simple_mode_accent_light))
        }
    }
    
    /**
     * åœæ­¢TTSæœ—è¯»
     */
    private fun stopTTS() {
        try {
            ttsManager.stop()
            Log.d(TAG, "åœæ­¢TTSæœ—è¯»")
        } catch (e: Exception) {
            Log.e(TAG, "åœæ­¢TTSæœ—è¯»å¤±è´¥", e)
        }
    }
    
    /**
     * æ˜¾ç¤ºTTSè®¾ç½®å¯¹è¯æ¡†
     */
    private fun showSimpleModeTTSSettingsDialog() {
        if (!ttsManager.isTTSSupported()) {
            Toast.makeText(this, "è®¾å¤‡ä¸æ”¯æŒæœ—è¯»åŠŸèƒ½", Toast.LENGTH_SHORT).show()
            return
        }
        
        // åˆ›å»ºå¯¹è¯æ¡†å†…å®¹
        val scrollView = ScrollView(this)
        val mainLayout = LinearLayout(this).apply {
            orientation = LinearLayout.VERTICAL
            setPadding(32, 32, 32, 32)
        }
        
        // è¯­éŸ³é€Ÿåº¦è°ƒèŠ‚
        val speedText = TextView(this).apply {
            text = "è¯­éŸ³é€Ÿåº¦: ${String.format("%.1f", ttsManager.getSpeechRate())}x"
            textSize = 16f
            setPadding(0, 0, 0, 16)
        }
        
        val speedSeekBar = SeekBar(this).apply {
            max = 29 // 0.1 to 3.0 in 0.1 increments
            progress = ((ttsManager.getSpeechRate() - 0.1f) * 10).toInt()
            setPadding(0, 0, 0, 32)
            setOnSeekBarChangeListener(object : SeekBar.OnSeekBarChangeListener {
                override fun onProgressChanged(seekBar: SeekBar?, progress: Int, fromUser: Boolean) {
                    val speed = 0.1f + progress * 0.1f
                    ttsManager.setSpeechRate(speed)
                    speedText.text = "è¯­éŸ³é€Ÿåº¦: ${String.format("%.1f", speed)}x"
                }
                override fun onStartTrackingTouch(seekBar: SeekBar?) {}
                override fun onStopTrackingTouch(seekBar: SeekBar?) {}
            })
        }
        
        // è¯­éŸ³éŸ³è°ƒè°ƒèŠ‚
        val pitchText = TextView(this).apply {
            text = "è¯­éŸ³éŸ³è°ƒ: ${String.format("%.1f", ttsManager.getPitch())}"
            textSize = 16f
            setPadding(0, 0, 0, 16)
        }
        
        val pitchSeekBar = SeekBar(this).apply {
            max = 19 // 0.1 to 2.0 in 0.1 increments
            progress = ((ttsManager.getPitch() - 0.1f) * 10).toInt()
            setPadding(0, 0, 0, 32)
            setOnSeekBarChangeListener(object : SeekBar.OnSeekBarChangeListener {
                override fun onProgressChanged(seekBar: SeekBar?, progress: Int, fromUser: Boolean) {
                    val pitch = 0.1f + progress * 0.1f
                    ttsManager.setPitch(pitch)
                    pitchText.text = "è¯­éŸ³éŸ³è°ƒ: ${String.format("%.1f", pitch)}"
                }
                override fun onStartTrackingTouch(seekBar: SeekBar?) {}
                override fun onStopTrackingTouch(seekBar: SeekBar?) {}
            })
        }
        
        // è¯­éŸ³éŸ³é‡è°ƒèŠ‚
        val volumeText = TextView(this).apply {
            text = "è¯­éŸ³éŸ³é‡: ${String.format("%.0f", ttsManager.getVolume() * 100)}%"
            textSize = 16f
            setPadding(0, 0, 0, 16)
        }
        
        val volumeSeekBar = SeekBar(this).apply {
            max = 100 // 0.0 to 1.0 in 0.01 increments
            progress = (ttsManager.getVolume() * 100).toInt()
            setPadding(0, 0, 0, 32)
            setOnSeekBarChangeListener(object : SeekBar.OnSeekBarChangeListener {
                override fun onProgressChanged(seekBar: SeekBar?, progress: Int, fromUser: Boolean) {
                    val volume = progress / 100.0f
                    ttsManager.setVolume(volume)
                    volumeText.text = "è¯­éŸ³éŸ³é‡: ${String.format("%.0f", volume * 100)}%"
                }
                override fun onStartTrackingTouch(seekBar: SeekBar?) {}
                override fun onStopTrackingTouch(seekBar: SeekBar?) {}
            })
        }
        
        // æŒ‰é’®å¸ƒå±€
        val buttonLayout = LinearLayout(this).apply {
            orientation = LinearLayout.HORIZONTAL
            gravity = Gravity.CENTER
        }
        
        val testButton = Button(this).apply {
            text = "æµ‹è¯•è¯­éŸ³"
            layoutParams = LinearLayout.LayoutParams(0, LinearLayout.LayoutParams.WRAP_CONTENT, 1f).apply {
                setMargins(0, 0, 16, 0)
            }
            setOnClickListener {
                val testText = "è¿™æ˜¯è¯­éŸ³æµ‹è¯•ï¼Œæ‚¨å¯ä»¥å¬åˆ°å½“å‰çš„è¯­éŸ³è®¾ç½®æ•ˆæœã€‚"
                ttsManager.speak(testText, "simple_mode_tts_test")
            }
        }
        
        val stopButton = Button(this).apply {
            text = "åœæ­¢æœ—è¯»"
            layoutParams = LinearLayout.LayoutParams(0, LinearLayout.LayoutParams.WRAP_CONTENT, 1f).apply {
                setMargins(16, 0, 0, 0)
            }
            setOnClickListener {
                ttsManager.stop()
            }
        }
        
        // æ·»åŠ æ‰€æœ‰ç»„ä»¶
        mainLayout.addView(speedText)
        mainLayout.addView(speedSeekBar)
        mainLayout.addView(pitchText)
        mainLayout.addView(pitchSeekBar)
        mainLayout.addView(volumeText)
        mainLayout.addView(volumeSeekBar)
        
        buttonLayout.addView(testButton)
        buttonLayout.addView(stopButton)
        mainLayout.addView(buttonLayout)
        
        scrollView.addView(mainLayout)
        
        // åˆ›å»ºå¯¹è¯æ¡†
        AlertDialog.Builder(this)
            .setTitle("æœ—è¯»è®¾ç½®")
            .setView(scrollView)
            .setPositiveButton("ç¡®å®š", null)
            .setNegativeButton("å–æ¶ˆ", null)
            .show()
    }

    // =============== æµè§ˆå™¨ç«™ç‚¹æŒ‰é’®ä¸èœå• ===============
    private fun setupBrowserSiteButton() {
        try {
            browserBtnSite.visibility = View.GONE
            browserBtnSite.setOnClickListener { showWebsiteInfoMenuForCurrentSite() }
            // åˆæ¬¡åŒæ­¥å½“å‰é¡µé¢çš„favicon
            val currentUrl = gestureCardWebViewManager?.getCurrentCard()?.url
                ?: paperStackWebViewManager?.getCurrentTab()?.url
                ?: unifiedWebViewManager.getCurrentActiveWebView()?.url
            updateBrowserFaviconButtonForUrl(currentUrl)
        } catch (e: Exception) {
            Log.e(TAG, "åˆå§‹åŒ–ç«™ç‚¹ä¿¡æ¯æŒ‰é’®å¤±è´¥", e)
        }
    }

    private fun updateBrowserFaviconButtonForUrl(url: String?) {
        if (url.isNullOrBlank() || url == "about:blank") {
            browserBtnSite.visibility = View.GONE
            return
        }
        try {
            // ä½¿ç”¨å€™è¡¥FaviconåŠ è½½å™¨ï¼Œæ ¹æ®åŸŸåè·å–ç½‘ç«™å›¾æ ‡
            com.example.aifloatingball.utils.FaviconLoader.loadFavicon(browserBtnSite, url)
            browserBtnSite.visibility = View.VISIBLE
        } catch (e: Exception) {
            Log.w(TAG, "åŠ è½½faviconå¤±è´¥: $url", e)
            browserBtnSite.visibility = View.GONE
        }
    }

    private fun showWebsiteInfoMenuForCurrentSite() {
        try {
            val currentWebViewFromUnified = unifiedWebViewManager.getCurrentActiveWebView()
            val currentPaperTab = paperStackWebViewManager?.getCurrentTab()
            val currentUrl = gestureCardWebViewManager?.getCurrentCard()?.url
                ?: currentPaperTab?.url
                ?: currentWebViewFromUnified?.url
            val currentTitle = gestureCardWebViewManager?.getCurrentCard()?.title
                ?: currentPaperTab?.title
                ?: currentWebViewFromUnified?.title

            if (currentUrl.isNullOrEmpty() || currentUrl == "about:blank") {
                Toast.makeText(this, "å½“å‰æ²¡æœ‰å·²åŠ è½½çš„ç½‘é¡µ", Toast.LENGTH_SHORT).show()
                return
            }

            val popupMenu = androidx.appcompat.widget.PopupMenu(androidx.appcompat.view.ContextThemeWrapper(this, R.style.AppPopupMenuLight), browserBtnSite)
            popupMenu.menuInflater.inflate(R.menu.website_info_menu, popupMenu.menu)

            // æ ‡é¢˜
            popupMenu.menu.findItem(R.id.menu_website_title)?.title = currentTitle ?: extractDomain(currentUrl)

            // é¡µé¢ç¼©æ”¾å±•ç¤º
            val webViewToUse = currentWebViewFromUnified ?: currentPaperTab?.webView
            val currentZoom = webViewToUse?.settings?.textZoom ?: 100
            popupMenu.menu.findItem(R.id.menu_page_zoom)?.title = "é¡µé¢ç¼©æ”¾: ${currentZoom}%"

            // ğŸ†• åŠ¨æ€æ›´æ–°é˜…è¯»æ¨¡å¼èœå•é¡¹æ ‡é¢˜
            val readerModeItem = popupMenu.menu.findItem(R.id.menu_enter_reader_mode)
            readerModeItem?.let {
                if (globalReaderModeManager?.isReaderModeActive() == true) {
                    it.title = "é€€å‡ºé˜…è¯»æ¨¡å¼"
                } else {
                    it.title = "è¿›å…¥é˜…è¯»æ¨¡å¼"
                }
            }
            
            popupMenu.setOnMenuItemClickListener { item ->
                when (item.itemId) {
                    R.id.menu_copy_title -> {
                        val clipboard = getSystemService(Context.CLIPBOARD_SERVICE) as android.content.ClipboardManager
                        val clip = android.content.ClipData.newPlainText("æ ‡é¢˜", currentTitle ?: "")
                        clipboard.setPrimaryClip(clip)
                        Toast.makeText(this, "æ ‡é¢˜å·²å¤åˆ¶", Toast.LENGTH_SHORT).show()
                        true
                    }
                    R.id.menu_website_settings -> {
                        showWebsiteSettingsDialog(currentUrl)
                        true
                    }
                    R.id.menu_page_zoom -> {
                        showPageZoomDialogForCurrentWebView()
                        true
                    }
                    R.id.menu_add_to_desktop -> {
                        addToDesktop(currentUrl, currentTitle ?: extractDomain(currentUrl))
                        true
                    }
                    R.id.menu_get_full_text -> {
                        extractFullTextFromCurrentWebView()
                        true
                    }
                    R.id.menu_enter_reader_mode -> {
                        // ğŸ†• è¿›å…¥/é€€å‡ºé˜…è¯»æ¨¡å¼
                        val webViewToUse = currentPaperTab?.webView 
                            ?: currentWebViewFromUnified
                            ?: gestureCardWebViewManager?.getCurrentCard()?.webView
                        
                        if (webViewToUse != null && !currentUrl.isNullOrEmpty() && currentUrl != "about:blank") {
                            globalReaderModeManager?.let { readerManager ->
                                if (readerManager.isReaderModeActive()) {
                                    // é€€å‡ºé˜…è¯»æ¨¡å¼
                                    readerManager.exitReaderMode(webViewToUse)
                                    Toast.makeText(this, "å·²é€€å‡ºé˜…è¯»æ¨¡å¼", Toast.LENGTH_SHORT).show()
                                } else {
                                    // è¿›å…¥é˜…è¯»æ¨¡å¼
                                    readerManager.enterReaderMode(webViewToUse, currentUrl, useNoImageMode = false)
                                    Toast.makeText(this, "æ­£åœ¨è¿›å…¥é˜…è¯»æ¨¡å¼...", Toast.LENGTH_SHORT).show()
                                }
                            } ?: run {
                                Toast.makeText(this, "é˜…è¯»æ¨¡å¼ç®¡ç†å™¨æœªåˆå§‹åŒ–", Toast.LENGTH_SHORT).show()
                            }
                        } else {
                            Toast.makeText(this, "å½“å‰æ²¡æœ‰å¯ç”¨çš„ç½‘é¡µ", Toast.LENGTH_SHORT).show()
                        }
                        true
                    }
                    else -> false
                }
            }

            popupMenu.show()
        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºç½‘ç«™ä¿¡æ¯èœå•å¤±è´¥", e)
        }
    }

    private fun extractDomain(url: String): String {
        return try {
            val uri = java.net.URI(url)
            uri.host ?: url
        } catch (e: Exception) {
            url
        }
    }

    private fun showPageZoomDialogForCurrentWebView() {
        val webViewToUse = unifiedWebViewManager.getCurrentActiveWebView() ?: return
        val zoomOptions = arrayOf("50%", "75%", "100%", "125%", "150%", "200%")
        val currentZoom = webViewToUse.settings.textZoom
        val currentIndex = when {
            currentZoom <= 50 -> 0
            currentZoom <= 75 -> 1
            currentZoom <= 100 -> 2
            currentZoom <= 125 -> 3
            currentZoom <= 150 -> 4
            else -> 5
        }

        AlertDialog.Builder(this)
            .setTitle("é¡µé¢ç¼©æ”¾")
            .setSingleChoiceItems(zoomOptions, currentIndex) { dialog, which ->
                val zoomPercent = when (which) {
                    0 -> 50
                    1 -> 75
                    2 -> 100
                    3 -> 125
                    4 -> 150
                    5 -> 200
                    else -> 100
                }
                webViewToUse.settings.textZoom = zoomPercent
                Toast.makeText(this, "å·²è®¾ç½®ç¼©æ”¾ä¸º $zoomPercent%", Toast.LENGTH_SHORT).show()
                dialog.dismiss()
            }
            .setNegativeButton("å–æ¶ˆ", null)
            .show()
    }

    private fun showWebsiteSettingsDialog(url: String) {
        val domain = extractDomain(url)
        val message = "ç½‘ç«™: $domain\n\nåç»­å¯åœ¨æ­¤é›†ä¸­ç®¡ç†ç«™ç‚¹æƒé™ã€Cookieç­‰ã€‚"
        AlertDialog.Builder(this)
            .setTitle("ç½‘ç«™è®¾ç½®")
            .setMessage(message)
            .setPositiveButton("ç¡®å®š", null)
            .show()
    }

    private fun addToDesktop(url: String, title: String) {
        Toast.makeText(this, "æ·»åŠ åˆ°æ¡Œé¢åŠŸèƒ½å¾…å®ç°", Toast.LENGTH_SHORT).show()
    }

    private fun extractFullTextFromCurrentWebView() {
        val webViewToUse = unifiedWebViewManager.getCurrentActiveWebView() ?: return
        webViewToUse.evaluateJavascript("(function() { return document.body.innerText; })()") { result ->
            val text = result?.removeSurrounding("\"")?.replace("\\n", "\n") ?: ""
            if (text.isNotEmpty()) {
                val clipboard = getSystemService(Context.CLIPBOARD_SERVICE) as android.content.ClipboardManager
                val clip = android.content.ClipData.newPlainText("ç½‘é¡µæ–‡æœ¬", text)
                clipboard.setPrimaryClip(clip)
                Toast.makeText(this@SimpleModeActivity, "ç½‘é¡µæ–‡å­—å·²å¤åˆ¶åˆ°å‰ªè´´æ¿", Toast.LENGTH_SHORT).show()
            } else {
                Toast.makeText(this@SimpleModeActivity, "æœªè·å–åˆ°é¡µé¢æ–‡æœ¬", Toast.LENGTH_SHORT).show()
            }
        }
    }

    /**
     * æ˜¾ç¤ºç»„ç®¡ç†å¯¹è¯æ¡†
     */
    private fun showGroupManagerDialog() {
        try {
            val groupManager = TabGroupManager.getInstance(this)
            
            // è§£é”æ¨¡å¼çŠ¶æ€
            var isUnlockMode = false
            val unlockedGroupIds = mutableSetOf<String>()
            
            // è·å–æ‰€æœ‰ç»„ï¼ˆåŒ…æ‹¬éšè—çš„ï¼‰
            val allGroupsIncludingHidden = groupManager.getAllGroupsIncludingHidden()
            val allVisibleGroups = groupManager.getAllGroups()
            
            // åˆ†ç¦»é»˜è®¤ç»„å’Œç”¨æˆ·åˆ›å»ºçš„ç»„ï¼ˆåªæ˜¾ç¤ºå¯è§ç»„ï¼‰
            val defaultGroup = allVisibleGroups.firstOrNull { it.id.startsWith("group_default_") }
            val userGroups = allVisibleGroups.filter { !it.id.startsWith("group_default_") }
            
            // å¦‚æœæœ‰ç”¨æˆ·åˆ›å»ºçš„ç»„ï¼Œåˆ™æ˜¾ç¤ºé»˜è®¤ç»„ï¼ˆç¬¬ä¸€ä¸ªï¼‰å’Œæ‰€æœ‰ç”¨æˆ·åˆ›å»ºçš„ç»„ï¼›å¦åˆ™åªæ˜¾ç¤ºç”¨æˆ·åˆ›å»ºçš„ç»„ï¼ˆæ­¤æ—¶ä¸ºç©ºï¼Œä¸æ˜¾ç¤ºï¼‰
            var groupsToShow = if (userGroups.isNotEmpty() && defaultGroup != null) {
                listOf(defaultGroup) + userGroups
            } else {
                userGroups
            }
            
            // åˆ›å»ºå¯¹è¯æ¡†ï¼Œç›´æ¥ä½¿ç”¨RecyclerViewæ˜¾ç¤ºç»„åˆ—è¡¨
            val dialogView = LayoutInflater.from(this).inflate(R.layout.fragment_tab_group_manager, null)
            val recyclerView = dialogView.findViewById<RecyclerView>(R.id.recycler_view_groups)
            val btnAddGroup = dialogView.findViewById<View>(R.id.btn_add_group)
            
            // è®¾ç½®RecyclerView
            recyclerView?.layoutManager = LinearLayoutManager(this)
            
            // å…ˆå£°æ˜é€‚é…å™¨å˜é‡ï¼ˆä½¿ç”¨ var ä»¥ä¾¿åœ¨åˆ·æ–°æ—¶æ›´æ–°ï¼‰
            var adapter: TabGroupAdapter
            
            // åˆ·æ–°é€‚é…å™¨çš„è¾…åŠ©å‡½æ•°
            fun refreshAdapter() {
                // é‡æ–°è·å–æœ€æ–°çš„ç»„åˆ—è¡¨
                val latestAllGroupsIncludingHidden = groupManager.getAllGroupsIncludingHidden()
                val latestAllVisibleGroups = groupManager.getAllGroups()
                
                val allGroups = if (isUnlockMode) {
                    // è§£é”æ¨¡å¼ï¼šæ˜¾ç¤ºæ‰€æœ‰ç»„ï¼ˆåŒ…æ‹¬éšè—çš„ï¼‰
                    val defaultGroupAll = latestAllGroupsIncludingHidden.firstOrNull { it.id.startsWith("group_default_") }
                    val userGroupsAll = latestAllGroupsIncludingHidden.filter { !it.id.startsWith("group_default_") }
                    if (userGroupsAll.isNotEmpty() && defaultGroupAll != null) {
                        listOf(defaultGroupAll) + userGroupsAll
                    } else {
                        userGroupsAll
                    }
                } else {
                    // æ­£å¸¸æ¨¡å¼ï¼šåªæ˜¾ç¤ºå¯è§ç»„
                    val defaultGroupVisible = latestAllVisibleGroups.firstOrNull { it.id.startsWith("group_default_") }
                    val userGroupsVisible = latestAllVisibleGroups.filter { !it.id.startsWith("group_default_") }
                    if (userGroupsVisible.isNotEmpty() && defaultGroupVisible != null) {
                        listOf(defaultGroupVisible) + userGroupsVisible
                    } else {
                        userGroupsVisible
                    }
                }
                
                // é‡æ–°åˆ›å»ºé€‚é…å™¨ä»¥æ›´æ–°isUnlockModeå’ŒunlockedGroupIds
                adapter = TabGroupAdapter(
                    groups = allGroups.toMutableList(),
                    onGroupClick = { group ->
                        // å¦‚æœå¤„äºè§£é”æ¨¡å¼ä¸”ç»„æœªè§£é”ï¼Œéœ€è¦å…ˆè§£é”
                        if (isUnlockMode && (group.isHidden || group.passwordHash != null) && !unlockedGroupIds.contains(group.id)) {
                            // æ˜¾ç¤ºå¯†ç éªŒè¯å¯¹è¯æ¡†
                            showUnlockGroupDialog(group, groupManager) { verified ->
                                if (verified) {
                                    unlockedGroupIds.add(group.id)
                                    // å»¶è¿Ÿåˆ·æ–°é€‚é…å™¨ï¼Œç¡®ä¿è§£é”å¯¹è¯æ¡†å®Œå…¨å…³é—­åå†åˆ·æ–°
                                    handler.postDelayed({
                                        refreshAdapter()
                                        showMaterialToast("å·²è§£é”ç»„ï¼š${group.name}ï¼Œç»„åå·²æ˜¾ç¤º")
                                    }, 150)
                                    // è§£é”åä¸åˆ‡æ¢åˆ°è¯¥ç»„ï¼Œä¿æŒåœ¨æ ‡ç­¾é¡µç»„ç®¡ç†å¼¹çª—ä¸­
                                }
                            }
                        } else {
                            // æ­£å¸¸åˆ‡æ¢åˆ°è¯¥ç»„ï¼ˆåªæœ‰åœ¨éè§£é”æ¨¡å¼æˆ–å·²è§£é”çš„æƒ…å†µä¸‹æ‰åˆ‡æ¢ï¼‰
                            if (!isUnlockMode || unlockedGroupIds.contains(group.id) || (!group.isHidden && group.passwordHash == null)) {
                                // ğŸ”§ ä¿®å¤ï¼šåŠ å¯†ç»„å¿…é¡»å…ˆéªŒè¯å¯†ç ï¼ŒéªŒè¯é€šè¿‡åæ‰åˆ‡æ¢ç»„
                                // å¯†ç éªŒè¯åœ¨Fragmentä¸­å®Œæˆï¼Œè¿™é‡Œåªå¤„ç†éªŒè¯é€šè¿‡åçš„åˆ‡æ¢
                                groupManager.setCurrentGroup(group.id)
                                paperStackWebViewManager?.switchToGroup(group.id) { tabs ->
                                    Log.d(TAG, "åˆ‡æ¢åˆ°ç»„ ${group.name}ï¼ŒåŠ è½½ ${tabs.size} ä¸ªæ ‡ç­¾é¡µ")
                                    syncAllCardSystems()
                                    showMaterialToast("å·²åˆ‡æ¢åˆ°ç»„ï¼š${group.name}")
                                }
                            }
                        }
                    },
                    onGroupEdit = { group ->
                        // ç¼–è¾‘ç»„å
                        showEditGroupDialog(group, groupManager) { 
                            refreshAdapter()
                            refreshGroupTabs() // åŒæ—¶åˆ·æ–°é¡¶éƒ¨æ ‡ç­¾æ 
                        }
                    },
                    onGroupDelete = { group ->
                        // åˆ é™¤ç»„
                        showDeleteGroupDialog(group, groupManager) {
                            refreshAdapter()
                            refreshGroupTabs() // åŒæ—¶åˆ·æ–°é¡¶éƒ¨æ ‡ç­¾æ 
                        }
                    },
                    onGroupPin = { group ->
                        // ç½®é¡¶/å–æ¶ˆç½®é¡¶
                        groupManager.togglePinGroup(group.id)
                        refreshAdapter()
                        refreshGroupTabs() // åŒæ—¶åˆ·æ–°é¡¶éƒ¨æ ‡ç­¾æ 
                    },
                    onGroupDrag = { fromPosition, toPosition ->
                        // æ‹–åŠ¨æ’åºï¼ˆæ³¨æ„ï¼šé»˜è®¤ç»„åº”è¯¥å§‹ç»ˆåœ¨ç¬¬ä¸€ä¸ªä½ç½®ï¼Œä¸èƒ½æ‹–åŠ¨ï¼‰
                        val allGroupsDrag = if (isUnlockMode) latestAllGroupsIncludingHidden else latestAllVisibleGroups
                        val defaultGroupDrag = allGroupsDrag.firstOrNull { it.id.startsWith("group_default_") }
                        val userGroupsDrag = allGroupsDrag.filter { !it.id.startsWith("group_default_") }
                        
                        // å¦‚æœæ‹–åŠ¨çš„æ˜¯é»˜è®¤ç»„ï¼ˆä½ç½®0ï¼‰ï¼Œä¸å…è®¸æ‹–åŠ¨
                        if (defaultGroupDrag != null && fromPosition == 0) {
                            return@TabGroupAdapter
                        }
                        
                        // åªå¯¹ç”¨æˆ·åˆ›å»ºçš„ç»„è¿›è¡Œæ’åº
                        val groupIds = userGroupsDrag.map { it.id }.toMutableList()
                        val adjustedFromPosition = if (defaultGroupDrag != null) fromPosition - 1 else fromPosition
                        val adjustedToPosition = if (defaultGroupDrag != null) toPosition - 1 else toPosition
                        
                        if (adjustedFromPosition >= 0 && adjustedFromPosition < groupIds.size &&
                            adjustedToPosition >= 0 && adjustedToPosition < groupIds.size) {
                            val fromId = groupIds.removeAt(adjustedFromPosition)
                            groupIds.add(adjustedToPosition, fromId)
                            groupManager.updateGroupOrder(groupIds)
                            
                            refreshAdapter()
                        }
                    },
                    onGroupSecurity = { group ->
                        // å¯†ç è®¾ç½®
                        showGroupSecurityDialogInline(group, groupManager) {
                            refreshAdapter()
                        }
                    },
                    onGroupVisibility = { group ->
                        // éšè—/æ˜¾ç¤ºç»„
                        groupManager.toggleGroupHidden(group.id)
                        refreshAdapter()
                        refreshGroupTabs() // åŒæ—¶åˆ·æ–°é¡¶éƒ¨æ ‡ç­¾æ 
                        showMaterialToast(if (group.isHidden) "ç»„å·²æ˜¾ç¤º" else "ç»„å·²éšè—")
                    },
                    isUnlockMode = isUnlockMode,
                    unlockedGroupIds = unlockedGroupIds
                )
                recyclerView?.adapter = adapter
                // é‡æ–°è®¾ç½®æ‹–åŠ¨æ’åº
                val itemTouchHelper = ItemTouchHelper(GroupItemTouchHelperCallback(adapter))
                itemTouchHelper.attachToRecyclerView(recyclerView)
            }
            
            // åˆ›å»ºé€‚é…å™¨ï¼ˆåœ¨ lambda ä¸­å¯ä»¥å¼•ç”¨å·²å£°æ˜çš„ adapter å˜é‡ï¼‰
            adapter = TabGroupAdapter(
                groups = groupsToShow.toMutableList(),
                onGroupClick = { group ->
                    // å¦‚æœå¤„äºè§£é”æ¨¡å¼ä¸”ç»„æœªè§£é”ï¼Œéœ€è¦å…ˆè§£é”
                    if (isUnlockMode && (group.isHidden || group.passwordHash != null) && !unlockedGroupIds.contains(group.id)) {
                        // æ˜¾ç¤ºå¯†ç éªŒè¯å¯¹è¯æ¡†
                        showUnlockGroupDialog(group, groupManager) { verified ->
                            if (verified) {
                                unlockedGroupIds.add(group.id)
                                // å»¶è¿Ÿåˆ·æ–°é€‚é…å™¨ï¼Œç¡®ä¿è§£é”å¯¹è¯æ¡†å®Œå…¨å…³é—­åå†åˆ·æ–°
                                handler.postDelayed({
                                    refreshAdapter()
                                    showMaterialToast("å·²è§£é”ç»„ï¼š${group.name}ï¼Œç»„åå·²æ˜¾ç¤º")
                                }, 150)
                                // è§£é”åä¸åˆ‡æ¢åˆ°è¯¥ç»„ï¼Œä¿æŒåœ¨æ ‡ç­¾é¡µç»„ç®¡ç†å¼¹çª—ä¸­
                            }
                        }
                    } else {
                        // æ­£å¸¸åˆ‡æ¢åˆ°è¯¥ç»„ï¼ˆåªæœ‰åœ¨éè§£é”æ¨¡å¼æˆ–å·²è§£é”çš„æƒ…å†µä¸‹æ‰åˆ‡æ¢ï¼‰
                        if (!isUnlockMode || unlockedGroupIds.contains(group.id) || (!group.isHidden && group.passwordHash == null)) {
                            groupManager.setCurrentGroup(group.id)
                            paperStackWebViewManager?.switchToGroup(group.id) { tabs ->
                                Log.d(TAG, "åˆ‡æ¢åˆ°ç»„ ${group.name}ï¼ŒåŠ è½½ ${tabs.size} ä¸ªæ ‡ç­¾é¡µ")
                                syncAllCardSystems()
                                showMaterialToast("å·²åˆ‡æ¢åˆ°ç»„ï¼š${group.name}")
                            }
                        }
                    }
                },
                onGroupEdit = { group ->
                    // ç¼–è¾‘ç»„å
                    showEditGroupDialog(group, groupManager) { 
                        refreshAdapter()
                        refreshGroupTabs() // åŒæ—¶åˆ·æ–°é¡¶éƒ¨æ ‡ç­¾æ 
                    }
                },
                onGroupDelete = { group ->
                    // åˆ é™¤ç»„
                    showDeleteGroupDialog(group, groupManager) {
                        refreshAdapter()
                        refreshGroupTabs() // åŒæ—¶åˆ·æ–°é¡¶éƒ¨æ ‡ç­¾æ 
                    }
                },
                onGroupPin = { group ->
                    // ç½®é¡¶/å–æ¶ˆç½®é¡¶
                    groupManager.togglePinGroup(group.id)
                    refreshAdapter()
                    refreshGroupTabs() // åŒæ—¶åˆ·æ–°é¡¶éƒ¨æ ‡ç­¾æ 
                },
                onGroupDrag = { fromPosition, toPosition ->
                    // æ‹–åŠ¨æ’åºï¼ˆæ³¨æ„ï¼šé»˜è®¤ç»„åº”è¯¥å§‹ç»ˆåœ¨ç¬¬ä¸€ä¸ªä½ç½®ï¼Œä¸èƒ½æ‹–åŠ¨ï¼‰
                    val allGroups = if (isUnlockMode) allGroupsIncludingHidden else allVisibleGroups
                    val defaultGroupDrag = allGroups.firstOrNull { it.id.startsWith("group_default_") }
                    val userGroupsDrag = allGroups.filter { !it.id.startsWith("group_default_") }
                    
                    // å¦‚æœæ‹–åŠ¨çš„æ˜¯é»˜è®¤ç»„ï¼ˆä½ç½®0ï¼‰ï¼Œä¸å…è®¸æ‹–åŠ¨
                    if (defaultGroupDrag != null && fromPosition == 0) {
                        return@TabGroupAdapter
                    }
                    
                    // åªå¯¹ç”¨æˆ·åˆ›å»ºçš„ç»„è¿›è¡Œæ’åº
                    val groupIds = userGroupsDrag.map { it.id }.toMutableList()
                    val adjustedFromPosition = if (defaultGroupDrag != null) fromPosition - 1 else fromPosition
                    val adjustedToPosition = if (defaultGroupDrag != null) toPosition - 1 else toPosition
                    
                    if (adjustedFromPosition >= 0 && adjustedFromPosition < groupIds.size &&
                        adjustedToPosition >= 0 && adjustedToPosition < groupIds.size) {
                        val fromId = groupIds.removeAt(adjustedFromPosition)
                        groupIds.add(adjustedToPosition, fromId)
                        groupManager.updateGroupOrder(groupIds)
                        
                        refreshAdapter()
                    }
                },
                onGroupSecurity = { group ->
                    // å¯†ç è®¾ç½®
                    showGroupSecurityDialogInline(group, groupManager) {
                        refreshAdapter()
                    }
                },
                onGroupVisibility = { group ->
                    // éšè—/æ˜¾ç¤ºç»„
                    groupManager.toggleGroupHidden(group.id)
                    refreshAdapter()
                    refreshGroupTabs() // åŒæ—¶åˆ·æ–°é¡¶éƒ¨æ ‡ç­¾æ 
                    showMaterialToast(if (group.isHidden) "ç»„å·²æ˜¾ç¤º" else "ç»„å·²éšè—")
                },
                isUnlockMode = isUnlockMode,
                unlockedGroupIds = unlockedGroupIds
            )
            
            recyclerView?.adapter = adapter
            
            // è®¾ç½®æ‹–åŠ¨æ’åº
            val itemTouchHelper = ItemTouchHelper(GroupItemTouchHelperCallback(adapter))
            itemTouchHelper.attachToRecyclerView(recyclerView)
            
            // æ–°å»ºç»„æŒ‰é’®
            btnAddGroup?.setOnClickListener {
                showCreateGroupDialog(groupManager) {
                    refreshAdapter()
                    refreshGroupTabs() // åŒæ—¶åˆ·æ–°é¡¶éƒ¨æ ‡ç­¾æ 
                }
            }
            
            // åˆ›å»ºå¯¹è¯æ¡†ï¼ˆä¸è®¾ç½®æ ‡é¢˜ï¼Œå› ä¸ºå¸ƒå±€æ–‡ä»¶ä¸­å·²æœ‰æ ‡é¢˜ï¼‰
            val dialog = AlertDialog.Builder(this)
                .setView(dialogView)
                .setNeutralButton("è§£é”", null) // å…ˆè®¾ç½®ä¸ºnullï¼Œç¨åæ‰‹åŠ¨å¤„ç†
                .setPositiveButton("å…³é—­", null)
                .create()
            
            // æ‰‹åŠ¨å¤„ç†è§£é”æŒ‰é’®ç‚¹å‡»ï¼Œé¿å…å¯¹è¯æ¡†å…³é—­
            dialog.setOnShowListener {
                val unlockButton = dialog.getButton(AlertDialog.BUTTON_NEUTRAL)
                unlockButton?.setOnClickListener {
                    // åˆ‡æ¢è§£é”æ¨¡å¼ï¼šæ˜¾ç¤ºéšè—ç»„ä½†éšè—ç»„å
                    isUnlockMode = !isUnlockMode
                    unlockedGroupIds.clear()
                    refreshAdapter()
                    if (isUnlockMode) {
                        // è¿›å…¥è§£é”æ¨¡å¼ï¼šæ˜¾ç¤ºæ‰€æœ‰éšè—å’ŒåŠ å¯†çš„ç»„ï¼Œä½†ç»„åéšè—
                        val latestAllGroupsIncludingHidden = groupManager.getAllGroupsIncludingHidden()
                        val hiddenGroups = latestAllGroupsIncludingHidden.filter { it.isHidden || it.passwordHash != null }
                        if (hiddenGroups.isNotEmpty()) {
                            showMaterialToast("å·²æ˜¾ç¤ºéšè—ç»„ï¼Œç‚¹å‡»ç»„åè¾“å…¥å¯†ç è§£é”åæŸ¥çœ‹")
                            // æ›´æ–°æŒ‰é’®æ–‡æœ¬
                            unlockButton.text = "é€€å‡ºè§£é”"
                        } else {
                            showMaterialToast("å·²è¿›å…¥è§£é”æ¨¡å¼ï¼Œä½†æ²¡æœ‰éšè—æˆ–åŠ å¯†çš„ç»„")
                            unlockButton.text = "é€€å‡ºè§£é”"
                        }
                    } else {
                        showMaterialToast("å·²é€€å‡ºè§£é”æ¨¡å¼")
                        // æ›´æ–°æŒ‰é’®æ–‡æœ¬
                        unlockButton.text = "è§£é”"
                    }
                }
            }
            
            dialog.show()
                
        } catch (e: Exception) {
            Log.e(TAG, "æ˜¾ç¤ºç»„ç®¡ç†å¯¹è¯æ¡†å¤±è´¥", e)
            showMaterialToast("æ‰“å¼€ç»„ç®¡ç†å¤±è´¥ï¼š${e.message}")
        }
    }
    
    /**
     * æ˜¾ç¤ºåˆ›å»ºç»„å¯¹è¯æ¡†
     */
    private fun showCreateGroupDialog(groupManager: TabGroupManager, onGroupCreated: () -> Unit) {
        val input = EditText(this).apply {
            inputType = android.text.InputType.TYPE_CLASS_TEXT
            hint = "è¯·è¾“å…¥ç»„å"
        }
        
        val dialog = com.google.android.material.dialog.MaterialAlertDialogBuilder(this)
            .setTitle("åˆ›å»ºæ–°ç»„")
            .setView(input)
            .setPositiveButton("åˆ›å»º", null)
            .setNegativeButton("å–æ¶ˆ", null)
            .create()
        
        dialog.setOnShowListener {
            val positiveButton = dialog.getButton(androidx.appcompat.app.AlertDialog.BUTTON_POSITIVE)
            val negativeButton = dialog.getButton(androidx.appcompat.app.AlertDialog.BUTTON_NEGATIVE)
            
            // ç¡®ä¿æŒ‰é’®å¯è§
            positiveButton?.visibility = View.VISIBLE
            negativeButton?.visibility = View.VISIBLE
            
            // è®¾ç½®æŒ‰é’®æ–‡å­—é¢œè‰²ï¼Œç¡®ä¿å¯è§
            positiveButton?.setTextColor(androidx.core.content.ContextCompat.getColor(this, android.R.color.holo_blue_dark))
            negativeButton?.setTextColor(androidx.core.content.ContextCompat.getColor(this, android.R.color.darker_gray))
            
            positiveButton?.setOnClickListener {
                val groupName = input.text.toString().trim()
                if (groupName.isNotEmpty()) {
                    val newGroup = groupManager.createGroup(groupName)
                    groupManager.setCurrentGroup(newGroup.id)
                    onGroupCreated()
                    showMaterialToast("ç»„å·²åˆ›å»º")
                    dialog.dismiss()
                } else {
                    showMaterialToast("ç»„åä¸èƒ½ä¸ºç©º")
                }
            }
        }
        
        dialog.show()
    }
    
    /**
     * æ˜¾ç¤ºç¼–è¾‘ç»„å¯¹è¯æ¡†
     */
    private fun showEditGroupDialog(group: TabGroup, groupManager: TabGroupManager, onGroupUpdated: () -> Unit) {
        val input = EditText(this).apply {
            inputType = android.text.InputType.TYPE_CLASS_TEXT
            setText(group.name)
            hint = "è¯·è¾“å…¥ç»„å"
        }
        
        AlertDialog.Builder(this)
            .setTitle("ç¼–è¾‘ç»„å")
            .setView(input)
            .setPositiveButton("ä¿å­˜") { _, _ ->
                val groupName = input.text.toString().trim()
                if (groupName.isNotEmpty()) {
                    groupManager.updateGroup(group.id, name = groupName)
                    onGroupUpdated()
                    showMaterialToast("ç»„åå·²æ›´æ–°")
                } else {
                    showMaterialToast("ç»„åä¸èƒ½ä¸ºç©º")
                }
            }
            .setNegativeButton("å–æ¶ˆ", null)
            .show()
    }
    
    /**
     * æ˜¾ç¤ºåˆ é™¤ç»„å¯¹è¯æ¡†
     */
    private fun showDeleteGroupDialog(group: TabGroup, groupManager: TabGroupManager, onGroupDeleted: () -> Unit) {
        val dialog = com.google.android.material.dialog.MaterialAlertDialogBuilder(this)
            .setTitle("åˆ é™¤ç»„")
            .setMessage("ç¡®å®šè¦åˆ é™¤ç»„ã€Œ${group.name}ã€å—ï¼Ÿç»„å†…çš„æ‰€æœ‰æ ‡ç­¾é¡µå°†è¢«åˆ é™¤ã€‚")
            .setPositiveButton("åˆ é™¤", null)
            .setNegativeButton("å–æ¶ˆ", null)
            .create()
        
        dialog.setOnShowListener {
            val positiveButton = dialog.getButton(androidx.appcompat.app.AlertDialog.BUTTON_POSITIVE)
            val negativeButton = dialog.getButton(androidx.appcompat.app.AlertDialog.BUTTON_NEGATIVE)
            
            // ç¡®ä¿æŒ‰é’®å¯è§
            positiveButton?.visibility = View.VISIBLE
            negativeButton?.visibility = View.VISIBLE
            
            // è®¾ç½®æŒ‰é’®æ–‡å­—é¢œè‰²ï¼Œç¡®ä¿å¯è§
            positiveButton?.setTextColor(androidx.core.content.ContextCompat.getColor(this, android.R.color.holo_red_dark))
            negativeButton?.setTextColor(androidx.core.content.ContextCompat.getColor(this, android.R.color.darker_gray))
            
            positiveButton?.setOnClickListener {
                if (groupManager.deleteGroup(group.id)) {
                    onGroupDeleted()
                    showMaterialToast("ç»„å·²åˆ é™¤")
                    dialog.dismiss()
                }
            }
        }
        
        dialog.show()
    }
    
    /**
     * åˆ·æ–°ç»„æ ‡ç­¾æ ï¼ˆæ˜¾ç¤ºæ‰€æœ‰å·²åˆ›å»ºçš„ç»„ï¼‰
     * é€»è¾‘ï¼šå¦‚æœæ²¡æœ‰ç”¨æˆ·åˆ›å»ºçš„ç»„ï¼Œéšè—æ ‡ç­¾æ ï¼›å¦‚æœæœ‰ç”¨æˆ·åˆ›å»ºçš„ç»„ï¼Œæ˜¾ç¤ºé»˜è®¤ç»„ï¼ˆç¬¬ä¸€ä¸ªï¼‰å’Œæ‰€æœ‰ç”¨æˆ·åˆ›å»ºçš„ç»„
     */
    private fun refreshGroupTabs() {
        try {
            val groupManager = TabGroupManager.getInstance(this)
            val allGroups = groupManager.getAllGroups()
            val currentGroupId = groupManager.getCurrentGroup()?.id
            
            // åˆ†ç¦»é»˜è®¤ç»„å’Œç”¨æˆ·åˆ›å»ºçš„ç»„
            val defaultGroup = allGroups.firstOrNull { it.id.startsWith("group_default_") }
            val userGroups = allGroups.filter { !it.id.startsWith("group_default_") }
            
            // å¦‚æœæ²¡æœ‰ç”¨æˆ·åˆ›å»ºçš„ç»„ï¼Œéšè—æ ‡ç­¾æ ï¼ˆåŒ…æ‹¬é»˜è®¤ç»„ï¼‰
            if (userGroups.isEmpty()) {
                groupTabsContainer?.visibility = View.GONE
                return
            }
            
            // ğŸ”§ ä¿®å¤ï¼šç»„æ ‡ç­¾æ çš„æ˜¾ç¤º/éšè—åº”è¯¥ç”±hideToolbarOnly()å’ŒshowToolbar()æ§åˆ¶
            // è¿™é‡Œåªè´Ÿè´£åˆ·æ–°å†…å®¹ï¼Œä¸ç›´æ¥æ§åˆ¶å¯è§æ€§ï¼Œé¿å…åœ¨æ»šåŠ¨åŠ¨ç”»è¿‡ç¨‹ä¸­è¦†ç›–æ˜¾ç¤º/éšè—çŠ¶æ€
            // ğŸ”§ å…³é”®ä¿®å¤ï¼šåªæœ‰åœ¨å·¥å…·æ ç¡®å®å¯è§ä¸”ç»„æ ‡ç­¾æ å½“å‰æ˜¯GONEæ—¶æ‰è®¾ç½®ä¸ºVISIBLE
            // å¦‚æœç»„æ ‡ç­¾æ å·²ç»è¢«hideToolbarOnly()éšè—ï¼ˆGONEï¼‰ï¼Œä¸è¦å¼ºåˆ¶æ˜¾ç¤º
            // å¦‚æœç»„æ ‡ç­¾æ æ­£åœ¨åŠ¨ç”»ä¸­ï¼ˆtranslationY != 0ï¼‰ï¼Œä¸è¦å¼ºåˆ¶è®¾ç½®ï¼Œè®©åŠ¨ç”»å®Œæˆ
            val shouldShow = isToolbarVisible && currentState == UIState.BROWSER
            if (shouldShow) {
                // å·¥å…·æ å¯è§ï¼Œåªæœ‰åœ¨ç»„æ ‡ç­¾æ å½“å‰æ˜¯GONEä¸”ä¸åœ¨åŠ¨ç”»ä¸­æ—¶æ‰æ˜¾ç¤º
                groupTabsContainer?.let { container ->
                    val isAnimating = container.translationY != 0f || container.alpha != 1f
                    if (container.visibility == View.GONE && !isAnimating) {
                        container.visibility = View.VISIBLE
                        container.translationY = 0f
                        container.alpha = 1f
                    }
                }
            }
            // ğŸ”§ ä¿®å¤ï¼šä¸è¦åœ¨è¿™é‡Œå¼ºåˆ¶éšè—ç»„æ ‡ç­¾æ ï¼Œè®©hideToolbarOnly()å’ŒshowToolbar()æ¥æ§åˆ¶
            // è¿™æ ·å¯ä»¥é¿å…åœ¨æ»šåŠ¨åŠ¨ç”»è¿‡ç¨‹ä¸­è¦†ç›–æ˜¾ç¤º/éšè—çŠ¶æ€
            
            // æ¸…é™¤æ—§çš„ç»„æ ‡ç­¾
            groupChips.values.forEach { chip ->
                groupTabsLayout?.removeView(chip)
            }
            groupChips.clear()
            
            // å…ˆæ·»åŠ é»˜è®¤ç»„ï¼ˆå¦‚æœæœ‰çš„è¯ï¼Œä½œä¸ºç¬¬ä¸€ä¸ªæ ‡ç­¾ï¼‰
            defaultGroup?.let { group ->
                val chip = createGroupChip(group, currentGroupId, groupManager)
                groupTabsLayout?.addView(chip)
                groupChips[group.id] = chip
            }
            
            // å†æ·»åŠ æ‰€æœ‰ç”¨æˆ·åˆ›å»ºçš„ç»„æ ‡ç­¾
            userGroups.forEach { group ->
                val chip = createGroupChip(group, currentGroupId, groupManager)
                groupTabsLayout?.addView(chip)
                groupChips[group.id] = chip
            }
            
        } catch (e: Exception) {
            Log.e(TAG, "åˆ·æ–°ç»„æ ‡ç­¾æ å¤±è´¥", e)
        }
    }
    
    /**
     * åˆ›å»ºç»„æ ‡ç­¾Chip
     */
    private fun createGroupChip(group: TabGroup, currentGroupId: String?, groupManager: TabGroupManager): com.google.android.material.chip.Chip {
        return com.google.android.material.chip.Chip(this).apply {
            text = group.name
            isClickable = true
            isFocusable = true
            isCheckable = true
            isChecked = (group.id == currentGroupId)
            layoutParams = LinearLayout.LayoutParams(
                LinearLayout.LayoutParams.WRAP_CONTENT,
                LinearLayout.LayoutParams.WRAP_CONTENT
            ).apply {
                val margin8dp = (8 * resources.displayMetrics.density).toInt()
                marginEnd = margin8dp
            }
            setOnClickListener {
                switchToGroup(group.id, groupManager)
            }
            setOnLongClickListener {
                showGroupContextMenu(group, groupManager)
                true
            }
            // ğŸ”§ ä¿®å¤2ï¼šiOS Safarié£æ ¼æ ‡ç­¾è®¾è®¡
            // iOS Safariæ ‡ç­¾ç‰¹ç‚¹ï¼šæ›´å°çš„å­—ä½“ã€æ›´ç´§å‡‘çš„å¸ƒå±€ã€æ›´æŸ”å’Œçš„é¢œè‰²ã€æ›´åœ†æ¶¦çš„åœ†è§’
            textSize = 13f // iOS Safariä½¿ç”¨æ›´å°çš„å­—ä½“ï¼ˆ13spï¼‰
            val minHeight24dp = (24 * resources.displayMetrics.density).toInt()
            minHeight = minHeight24dp
            // iOS Safarié£æ ¼å†…è¾¹è·ï¼šæ›´ç´§å‡‘
            val paddingHorizontal10dp = (10 * resources.displayMetrics.density).toInt()
            val paddingVertical3dp = (3 * resources.displayMetrics.density).toInt()
            setPadding(paddingHorizontal10dp, paddingVertical3dp, paddingHorizontal10dp, paddingVertical3dp)
            
            // ç§»é™¤é€‰ä¸­å›¾æ ‡ï¼ˆå‹¾å’Œåœˆï¼‰
            chipIcon = null
            checkedIcon = null
            closeIcon = null
            
            // ğŸ”§ ä¿®å¤2ï¼šiOS Safarié£æ ¼é¢œè‰²
            // é€‰ä¸­çŠ¶æ€ï¼šæµ…è“è‰²èƒŒæ™¯ï¼ˆæ›´æ·¡ï¼‰+ è“è‰²è¾¹æ¡† + è“è‰²æ–‡å­—
            // æœªé€‰ä¸­çŠ¶æ€ï¼šæµ…ç°è‰²èƒŒæ™¯ï¼ˆiOS Safariä½¿ç”¨æµ…ç°èƒŒæ™¯è€Œä¸æ˜¯é€æ˜ï¼‰+ æµ…ç°è¾¹æ¡† + æ·±ç°æ–‡å­—
            chipBackgroundColor = resources.getColorStateList(R.color.chip_background_color_selector)
            chipStrokeColor = resources.getColorStateList(R.color.chip_stroke_color_selector)
            val strokeWidth0_5dp = (0.5f * resources.displayMetrics.density).toInt()
            chipStrokeWidth = strokeWidth0_5dp.toFloat() // iOS Safariä½¿ç”¨æ›´ç»†çš„è¾¹æ¡†
            
            // ğŸ”§ ä¿®å¤2ï¼šiOS Safarié£æ ¼åœ†è§’ï¼ˆæ›´åœ†æ¶¦ï¼Œæ¥è¿‘èƒ¶å›Šå½¢çŠ¶ï¼‰
            val cornerRadius12dp = (12 * resources.displayMetrics.density).toInt()
            chipCornerRadius = cornerRadius12dp.toFloat()
            
            // iOSé£æ ¼æ–‡å­—é¢œè‰²ï¼ˆé€‰ä¸­æ—¶è“è‰²ï¼Œæœªé€‰ä¸­æ—¶æ·±ç°è‰²ï¼‰
            setTextColor(resources.getColorStateList(R.color.chip_text_color_selector))
            
            // ç§»é™¤é»˜è®¤çš„MaterialåŠ¨ç”»ï¼Œä½¿ç”¨iOSé£æ ¼çš„å¹³æ»‘è¿‡æ¸¡
            stateListAnimator = null
            
            // ç¡®ä¿æ–‡å­—ä¸ä¼šè¢«é®æŒ¡
            maxLines = 1
            ellipsize = android.text.TextUtils.TruncateAt.END
            
            // ğŸ”§ ä¿®å¤2ï¼šiOS Safarié£æ ¼å­—ä½“ï¼ˆä½¿ç”¨ç³»ç»Ÿé»˜è®¤å­—ä½“ï¼Œæ›´æ¸…æ™°ï¼‰
            typeface = android.graphics.Typeface.DEFAULT
        }
    }
    
    /**
     * å¤„ç†ç»„æ¿€æ´»ï¼ˆé€šè¿‡æ‰‹åŠ¿æˆ–å¯†ç ï¼‰
     */
    private fun handleGroupActivation(group: TabGroup) {
        try {
            val groupManager = TabGroupManager.getInstance(this)
            
            // å¦‚æœç»„æœ‰å¯†ç ï¼Œéœ€è¦éªŒè¯
            if (group.passwordHash != null) {
                showGroupPasswordVerificationDialog(group) { verified ->
                    if (verified) {
                        // å¦‚æœç»„æ˜¯éšè—çš„ï¼Œå…ˆæ˜¾ç¤ºå®ƒ
                        if (group.isHidden) {
                            groupManager.toggleGroupHidden(group.id)
                        }
                        // åˆ‡æ¢åˆ°è¯¥ç»„ï¼ˆè·³è¿‡å¯†ç æ£€æŸ¥ï¼Œå› ä¸ºå·²ç»éªŒè¯è¿‡äº†ï¼‰
                        switchToGroup(group.id, groupManager, skipPasswordCheck = true)
                        Toast.makeText(this, "å·²æ¿€æ´»ç»„ï¼š${group.name}", Toast.LENGTH_SHORT).show()
                    }
                }
            } else {
                // æ²¡æœ‰å¯†ç ï¼Œç›´æ¥æ¿€æ´»
                if (group.isHidden) {
                    groupManager.toggleGroupHidden(group.id)
                }
                switchToGroup(group.id, groupManager, skipPasswordCheck = true)
                Toast.makeText(this, "å·²æ¿€æ´»ç»„ï¼š${group.name}", Toast.LENGTH_SHORT).show()
            }
        } catch (e: Exception) {
            Log.e(TAG, "æ¿€æ´»ç»„å¤±è´¥", e)
            Toast.makeText(this, "æ¿€æ´»ç»„å¤±è´¥ï¼š${e.message}", Toast.LENGTH_SHORT).show()
        }
    }
    
    /**
     * æ˜¾ç¤ºç»„å¯†ç éªŒè¯å¯¹è¯æ¡†
     */
    private fun showGroupPasswordVerificationDialog(group: TabGroup, onVerified: (Boolean) -> Unit) {
        val passwordInput = EditText(this).apply {
            inputType = android.text.InputType.TYPE_CLASS_TEXT or android.text.InputType.TYPE_TEXT_VARIATION_PASSWORD
            hint = "è¯·è¾“å…¥å¯†ç æˆ–å¿«æ·è®¿é—®ç "
        }
        
        androidx.appcompat.app.AlertDialog.Builder(this)
            .setTitle("è¾“å…¥å¯†ç ")
            .setMessage("ç»„ã€Œ${group.name}ã€å·²åŠ å¯†ï¼Œè¯·è¾“å…¥å¯†ç æˆ–å¿«æ·è®¿é—®ç ")
            .setView(passwordInput)
            .setPositiveButton("ç¡®å®š") { _, _ ->
                val password = passwordInput.text.toString()
                val groupManager = TabGroupManager.getInstance(this)
                val verified = groupManager.verifyGroupPassword(group.id, password) ||
                              groupManager.verifyQuickAccessCode(group.id, password)
                if (verified) {
                    onVerified(true)
                    Toast.makeText(this, "å¯†ç æ­£ç¡®", Toast.LENGTH_SHORT).show()
                } else {
                    onVerified(false)
                    Toast.makeText(this, "å¯†ç é”™è¯¯", Toast.LENGTH_SHORT).show()
                }
            }
            .setNegativeButton("å–æ¶ˆ") { _, _ ->
                onVerified(false)
            }
            .setCancelable(false)
            .show()
    }
    
    /**
     * åˆ‡æ¢åˆ°æŒ‡å®šç»„ï¼ˆå¸¦å¯†ç éªŒè¯ï¼‰
     */
    private fun switchToGroup(groupId: String, groupManager: TabGroupManager, skipPasswordCheck: Boolean = false) {
        try {
            val group = groupManager.getGroupById(groupId) ?: return
            
            // å¦‚æœç»„æœ‰å¯†ç ä¸”æœªè·³è¿‡éªŒè¯ï¼Œéœ€è¦éªŒè¯å¯†ç 
            if (!skipPasswordCheck && group.passwordHash != null) {
                showGroupPasswordVerificationDialog(group) { verified ->
                    if (verified) {
                        performSwitchToGroup(groupId, groupManager)
                    }
                }
            } else {
                performSwitchToGroup(groupId, groupManager)
            }
        } catch (e: Exception) {
            Log.e(TAG, "åˆ‡æ¢ç»„å¤±è´¥", e)
            showMaterialToast("åˆ‡æ¢ç»„å¤±è´¥ï¼š${e.message}")
        }
    }
    
    /**
     * æ‰§è¡Œåˆ‡æ¢åˆ°ç»„ï¼ˆå†…éƒ¨æ–¹æ³•ï¼Œä¸æ£€æŸ¥å¯†ç ï¼‰
     */
    private fun performSwitchToGroup(groupId: String, groupManager: TabGroupManager) {
        try {
            groupManager.setCurrentGroup(groupId)
            
            // åˆ‡æ¢åˆ°è¯¥ç»„
            paperStackWebViewManager?.switchToGroup(groupId) { tabs ->
                Log.d(TAG, "åˆ‡æ¢åˆ°ç»„ ${groupManager.getCurrentGroup()?.name}ï¼ŒåŠ è½½ ${tabs.size} ä¸ªæ ‡ç­¾é¡µ")
                syncAllCardSystems()
                refreshGroupTabs()
            }
        } catch (e: Exception) {
            Log.e(TAG, "æ‰§è¡Œåˆ‡æ¢ç»„å¤±è´¥", e)
            showMaterialToast("åˆ‡æ¢ç»„å¤±è´¥ï¼š${e.message}")
        }
    }
    
    /**
     * æ˜¾ç¤ºç»„ä¸Šä¸‹æ–‡èœå•ï¼ˆé•¿æŒ‰ï¼‰
     */
    private fun showGroupContextMenu(group: TabGroup, groupManager: TabGroupManager) {
        val items = arrayOf("ç¼–è¾‘", "å¯†ç è®¾ç½®", "åˆ é™¤")
        // ä½¿ç”¨AppCompat AlertDialogå¹¶æŒ‡å®šä¸»é¢˜ï¼Œé¿å…é»‘å±é—®é¢˜
        val themedContext = androidx.appcompat.view.ContextThemeWrapper(
            this,
            androidx.appcompat.R.style.Theme_AppCompat_Light_Dialog_Alert
        )
        androidx.appcompat.app.AlertDialog.Builder(themedContext)
            .setTitle(group.name)
            .setItems(items) { _, which ->
                when (which) {
                    0 -> showEditGroupDialogInline(group, groupManager)
                    1 -> showGroupSecurityDialogInline(group, groupManager)
                    2 -> showDeleteGroupDialogInline(group, groupManager)
                }
            }
            .show()
    }
    
    /**
     * å†…è”åˆ›å»ºç»„å¯¹è¯æ¡†
     */
    private fun showCreateGroupDialogInline(groupManager: TabGroupManager) {
        val input = EditText(this).apply {
            inputType = android.text.InputType.TYPE_CLASS_TEXT
            hint = "è¯·è¾“å…¥ç»„å"
            requestFocus()
        }
        
        val dialog = com.google.android.material.dialog.MaterialAlertDialogBuilder(this)
            .setTitle("æ–°å»ºæ ‡ç­¾ç»„")
            .setMessage("ä¸ºæ‚¨çš„æ ‡ç­¾ç»„èµ·ä¸ªåå­—")
            .setView(input)
            .setPositiveButton("åˆ›å»º", null)
            .setNegativeButton("å–æ¶ˆ", null)
            .create()
        
        dialog.setOnShowListener {
            val positiveButton = dialog.getButton(androidx.appcompat.app.AlertDialog.BUTTON_POSITIVE)
            val negativeButton = dialog.getButton(androidx.appcompat.app.AlertDialog.BUTTON_NEGATIVE)
            
            // ç¡®ä¿æŒ‰é’®å¯è§
            positiveButton?.visibility = View.VISIBLE
            negativeButton?.visibility = View.VISIBLE
            
            // è®¾ç½®æŒ‰é’®æ–‡å­—é¢œè‰²ï¼Œç¡®ä¿å¯è§
            positiveButton?.setTextColor(androidx.core.content.ContextCompat.getColor(this, android.R.color.holo_blue_dark))
            negativeButton?.setTextColor(androidx.core.content.ContextCompat.getColor(this, android.R.color.darker_gray))
            
            positiveButton?.setOnClickListener {
                val groupName = input.text.toString().trim()
                if (groupName.isNotEmpty()) {
                    val newGroup = groupManager.createGroup(groupName)
                    // åˆ›å»ºæ–°ç»„åè‡ªåŠ¨è®¾ç½®ä¸ºå½“å‰ç»„
                    groupManager.setCurrentGroup(newGroup.id)
                    refreshGroupTabs()
                    showMaterialToast("æ ‡ç­¾ç»„ã€Œ${groupName}ã€å·²åˆ›å»º")
                    dialog.dismiss()
                } else {
                    showMaterialToast("ç»„åä¸èƒ½ä¸ºç©º")
                }
            }
        }
        
        dialog.show()
        
        // æ˜¾ç¤ºé”®ç›˜
        val window = dialog.window
        window?.setSoftInputMode(android.view.WindowManager.LayoutParams.SOFT_INPUT_STATE_VISIBLE)
    }
    
    /**
     * å†…è”ç¼–è¾‘ç»„å¯¹è¯æ¡†
     */
    /**
     * æ£€æŸ¥å¹¶æ˜¾ç¤ºæ¢å¤æç¤º
     */
    private fun checkAndShowRecoveryPrompt() {
        try {
            // åªåœ¨æœç´¢tabä¸­æ£€æŸ¥ï¼ˆæ£€æŸ¥browserWebViewContaineræ˜¯å¦å¯è§ï¼‰
            if (browserWebViewContainer.visibility != View.VISIBLE) {
                return
            }
            
            val recoveryManager = com.example.aifloatingball.manager.TabRecoveryManager.getInstance(this)
            
            // æ£€æŸ¥æ˜¯å¦ä¸ºéæ­£å¸¸å…³é—­
            if (!recoveryManager.isAbnormalShutdown()) {
                return
            }
            
            // è·å–æ¢å¤æ•°æ®
            val recoveryData = recoveryManager.getRecoveryData() ?: return
            val totalTabs = recoveryManager.getRecoveryTabCount()
            
            if (totalTabs == 0) {
                return
            }
            
            // æ˜¾ç¤ºæ¢å¤æç¤ºï¼ˆSnackbarï¼Œè‡ªåŠ¨å»¶æ—¶æ¶ˆå¤±ï¼‰
            val snackbar = com.google.android.material.snackbar.Snackbar.make(
                browserWebViewContainer,
                "æ£€æµ‹åˆ° $totalTabs ä¸ªæœªå…³é—­çš„é¡µé¢ï¼Œç‚¹å‡»æ¢å¤",
                com.google.android.material.snackbar.Snackbar.LENGTH_LONG
            ).apply {
                setAction("æ¢å¤") {
                    // æ¢å¤é¡µé¢
                    restoreTabsFromRecovery(recoveryData)
                }
                setActionTextColor(android.graphics.Color.parseColor("#007AFF")) // iOSè“è‰²
                // è‡ªåŠ¨å»¶æ—¶æ¶ˆå¤±ï¼ˆ5ç§’ï¼‰
                duration = 5000
            }
            
            snackbar.show()
            Log.d(TAG, "æ˜¾ç¤ºæ¢å¤æç¤º: $totalTabs ä¸ªæ ‡ç­¾é¡µ")
        } catch (e: Exception) {
            Log.e(TAG, "æ£€æŸ¥æ¢å¤æç¤ºå¤±è´¥", e)
        }
    }
    
    /**
     * ä»æ¢å¤æ•°æ®ä¸­æ¢å¤æ ‡ç­¾é¡µ
     */
    private fun restoreTabsFromRecovery(recoveryData: com.example.aifloatingball.manager.TabRecoveryManager.RecoveryData) {
        try {
            if (paperStackWebViewManager == null) {
                Log.e(TAG, "PaperStackWebViewManageræœªåˆå§‹åŒ–ï¼Œæ— æ³•æ¢å¤")
                return
            }
            
            // å…ˆè®¡ç®—æ€»æ•°ï¼ˆåœ¨æ¸…é™¤æ•°æ®ä¹‹å‰ï¼‰
            val totalTabs = recoveryData.groups.values.sumOf { it.size }
            
            // æ¢å¤æ ‡ç­¾é¡µï¼ˆå»¶è¿ŸåŠ è½½ï¼‰
            paperStackWebViewManager?.restoreTabsFromRecoveryData(recoveryData) { groupId, tabId, tabTitle, isLoaded ->
                Log.d(TAG, "æ¢å¤æ ‡ç­¾é¡µ: groupId=$groupId, tabId=$tabId, title=$tabTitle, isLoaded=$isLoaded")
            }
            
            // ğŸ”§ ä¿®å¤2ï¼šæ¢å¤é¡µé¢åï¼Œæ£€æŸ¥å¹¶ç¡®ä¿é»˜è®¤ä¸»é¡µåœ¨æœ€å·¦è¾¹
            handler.postDelayed({
                try {
                    val allTabs = paperStackWebViewManager?.getAllTabs() ?: emptyList()
                    val hasFunctionalHome = allTabs.any { tab ->
                        tab.url == "home://functional" || tab.url == "file:///android_asset/functional_home.html"
                    }
                    
                    if (!hasFunctionalHome) {
                        Log.d(TAG, "ğŸ”§ ä¿®å¤2ï¼šæ¢å¤é¡µé¢åæœªå‘ç°é»˜è®¤ä¸»é¡µï¼Œè‡ªåŠ¨åˆ›å»º")
                        createFunctionalHomeTab()
                    } else {
                        // æ£€æŸ¥é»˜è®¤ä¸»é¡µæ˜¯å¦åœ¨æœ€å·¦è¾¹ï¼ˆç´¢å¼•0ï¼‰
                        val functionalHomeIndex = allTabs.indexOfFirst { tab ->
                            tab.url == "home://functional" || tab.url == "file:///android_asset/functional_home.html"
                        }
                        if (functionalHomeIndex != 0) {
                            Log.d(TAG, "ğŸ”§ ä¿®å¤2ï¼šé»˜è®¤ä¸»é¡µä¸åœ¨æœ€å·¦è¾¹ï¼ˆå½“å‰ç´¢å¼•=$functionalHomeIndexï¼‰ï¼Œå·²åœ¨æ¢å¤é€»è¾‘ä¸­å¤„ç†")
                        } else {
                            Log.d(TAG, "âœ… æ¢å¤é¡µé¢åé»˜è®¤ä¸»é¡µå·²åœ¨æœ€å·¦è¾¹")
                        }
                    }
                } catch (e: Exception) {
                    Log.e(TAG, "æ£€æŸ¥é»˜è®¤ä¸»é¡µå¤±è´¥", e)
                }
            }, 500) // å»¶è¿Ÿ500msç¡®ä¿æ¢å¤å®Œæˆ
            
            // åˆ·æ–°æ ‡ç­¾ç»„æ˜¾ç¤º
            refreshGroupTabs()
            
            // æ¸…é™¤æ¢å¤æ•°æ®
            val recoveryManager = com.example.aifloatingball.manager.TabRecoveryManager.getInstance(this)
            recoveryManager.clearRecoveryData()
            
            showMaterialToast("å·²æ¢å¤ $totalTabs ä¸ªé¡µé¢")
            Log.d(TAG, "æ¢å¤å®Œæˆ: $totalTabs ä¸ªæ ‡ç­¾é¡µ")
        } catch (e: Exception) {
            Log.e(TAG, "æ¢å¤æ ‡ç­¾é¡µå¤±è´¥", e)
            showMaterialToast("æ¢å¤å¤±è´¥: ${e.message}", android.graphics.Color.RED)
        }
    }
    
    private fun showEditGroupDialogInline(group: TabGroup, groupManager: TabGroupManager) {
        val input = EditText(this).apply {
            inputType = android.text.InputType.TYPE_CLASS_TEXT
            setText(group.name)
            hint = "è¯·è¾“å…¥ç»„å"
        }
        
        AlertDialog.Builder(this)
            .setTitle("ç¼–è¾‘ç»„å")
            .setView(input)
            .setPositiveButton("ä¿å­˜") { _, _ ->
                val groupName = input.text.toString().trim()
                if (groupName.isNotEmpty()) {
                    groupManager.updateGroup(group.id, name = groupName)
                    refreshGroupTabs()
                    showMaterialToast("ç»„åå·²æ›´æ–°")
                } else {
                    showMaterialToast("ç»„åä¸èƒ½ä¸ºç©º")
                }
            }
            .setNegativeButton("å–æ¶ˆ", null)
            .show()
    }
    
    /**
     * å†…è”åˆ é™¤ç»„å¯¹è¯æ¡†
     */
    private fun showDeleteGroupDialogInline(group: TabGroup, groupManager: TabGroupManager) {
        val dialog = com.google.android.material.dialog.MaterialAlertDialogBuilder(this)
            .setTitle("åˆ é™¤ç»„")
            .setMessage("ç¡®å®šè¦åˆ é™¤ç»„ã€Œ${group.name}ã€å—ï¼Ÿç»„å†…çš„æ‰€æœ‰æ ‡ç­¾é¡µå°†è¢«åˆ é™¤ã€‚")
            .setPositiveButton("åˆ é™¤", null)
            .setNegativeButton("å–æ¶ˆ", null)
            .create()
        
        dialog.setOnShowListener {
            val positiveButton = dialog.getButton(androidx.appcompat.app.AlertDialog.BUTTON_POSITIVE)
            val negativeButton = dialog.getButton(androidx.appcompat.app.AlertDialog.BUTTON_NEGATIVE)
            
            // ç¡®ä¿æŒ‰é’®å¯è§
            positiveButton?.visibility = View.VISIBLE
            negativeButton?.visibility = View.VISIBLE
            
            // è®¾ç½®æŒ‰é’®æ–‡å­—é¢œè‰²ï¼Œç¡®ä¿å¯è§
            positiveButton?.setTextColor(androidx.core.content.ContextCompat.getColor(this, android.R.color.holo_red_dark))
            negativeButton?.setTextColor(androidx.core.content.ContextCompat.getColor(this, android.R.color.darker_gray))
            
            positiveButton?.setOnClickListener {
                if (groupManager.deleteGroup(group.id)) {
                    refreshGroupTabs()
                    showMaterialToast("ç»„å·²åˆ é™¤")
                    dialog.dismiss()
                }
            }
        }
        
        dialog.show()
    }
    
    /**
     * æ˜¾ç¤ºè§£é”ç»„å¯¹è¯æ¡†
     */
    private fun showUnlockGroupDialog(group: TabGroup, groupManager: TabGroupManager, onUnlocked: (Boolean) -> Unit) {
        val passwordInput = EditText(this).apply {
            inputType = android.text.InputType.TYPE_CLASS_TEXT or android.text.InputType.TYPE_TEXT_VARIATION_PASSWORD
            hint = "è¯·è¾“å…¥å¯†ç æˆ–å¿«æ·è®¿é—®ç "
        }
        
        // ä½¿ç”¨AppCompat AlertDialogå¹¶æŒ‡å®šä¸»é¢˜ï¼Œé¿å…é»‘å±é—®é¢˜
        val themedContext = androidx.appcompat.view.ContextThemeWrapper(
            this,
            androidx.appcompat.R.style.Theme_AppCompat_Light_Dialog_Alert
        )
        val unlockDialog = androidx.appcompat.app.AlertDialog.Builder(themedContext)
            .setTitle("è§£é”ç»„")
            .setMessage("è¯¥ç»„å·²åŠ å¯†æˆ–éšè—ï¼Œè¯·è¾“å…¥å¯†ç æˆ–å¿«æ·è®¿é—®ç ä»¥è§£é”")
            .setView(passwordInput)
            .setPositiveButton("è§£é”", null) // å…ˆè®¾ç½®ä¸ºnullï¼Œç¨åæ‰‹åŠ¨å¤„ç†
            .setNegativeButton("å–æ¶ˆ") { _, _ ->
                onUnlocked(false)
            }
            .setCancelable(true)
            .setOnCancelListener {
                onUnlocked(false)
            }
            .create()
        
        // æ‰‹åŠ¨å¤„ç†è§£é”æŒ‰é’®ç‚¹å‡»ï¼Œé¿å…å¯¹è¯æ¡†è‡ªåŠ¨å…³é—­
        unlockDialog.setOnShowListener {
            val unlockButton = unlockDialog.getButton(androidx.appcompat.app.AlertDialog.BUTTON_POSITIVE)
            unlockButton.setOnClickListener {
                val password = passwordInput.text.toString()
                val verified = groupManager.verifyGroupPassword(group.id, password) ||
                               groupManager.verifyQuickAccessCode(group.id, password)
                if (verified) {
                    unlockDialog.dismiss() // å…ˆå…³é—­è§£é”å¯¹è¯æ¡†
                    // å»¶è¿Ÿä¸€ä¸‹å†æ‰§è¡Œå›è°ƒï¼Œç¡®ä¿è§£é”å¯¹è¯æ¡†å®Œå…¨å…³é—­
                    handler.postDelayed({
                        onUnlocked(true)
                    }, 100)
                } else {
                    showMaterialToast("å¯†ç æˆ–å¿«æ·è®¿é—®ç é”™è¯¯")
                    // ä¸å…³é—­å¯¹è¯æ¡†ï¼Œè®©ç”¨æˆ·é‡è¯•
                }
            }
        }
        
        unlockDialog.show()
    }
    
    /**
     * æ˜¾ç¤ºç»„å®‰å…¨è®¾ç½®å¯¹è¯æ¡†ï¼ˆå†…è”ï¼‰
     */
    private fun showGroupSecurityDialogInline(group: TabGroup, groupManager: TabGroupManager, onUpdated: () -> Unit = {}) {
        val items = mutableListOf<String>()
        if (group.passwordHash != null) {
            items.add("ä¿®æ”¹å¯†ç ")
            items.add("ç§»é™¤å¯†ç ")
        } else {
            items.add("è®¾ç½®å¯†ç ")
        }
        items.add(if (group.isHidden) "æ˜¾ç¤ºç»„" else "éšè—ç»„")
        if (group.passwordHash != null) {
            items.add("è®¾ç½®å¿«æ·è®¿é—®ç ")
        }
        
        // ä½¿ç”¨AppCompat AlertDialogå¹¶æŒ‡å®šä¸»é¢˜ï¼Œé¿å…é»‘å±é—®é¢˜
        val themedContext = androidx.appcompat.view.ContextThemeWrapper(
            this,
            androidx.appcompat.R.style.Theme_AppCompat_Light_Dialog_Alert
        )
        androidx.appcompat.app.AlertDialog.Builder(themedContext)
            .setTitle("ç»„å®‰å…¨è®¾ç½® - ${group.name}")
            .setItems(items.toTypedArray()) { _, which ->
                when (items[which]) {
                    "è®¾ç½®å¯†ç " -> showSetPasswordDialogInline(group, groupManager)
                    "ä¿®æ”¹å¯†ç " -> showChangePasswordDialogInline(group, groupManager)
                    "ç§»é™¤å¯†ç " -> showRemovePasswordDialogInline(group, groupManager)
                    "éšè—ç»„" -> {
                        groupManager.toggleGroupHidden(group.id)
                        refreshGroupTabs()
                        showMaterialToast("ç»„å·²éšè—")
                    }
                    "æ˜¾ç¤ºç»„" -> {
                        groupManager.toggleGroupHidden(group.id)
                        refreshGroupTabs()
                        showMaterialToast("ç»„å·²æ˜¾ç¤º")
                    }
                    "è®¾ç½®å¿«æ·è®¿é—®ç " -> showSetQuickAccessCodeDialogInline(group, groupManager)
                }
            }
            .setNegativeButton("å–æ¶ˆ", null)
            .show()
    }
    
    /**
     * æ˜¾ç¤ºè®¾ç½®å¯†ç å¯¹è¯æ¡†ï¼ˆå†…è”ï¼‰
     */
    private fun showSetPasswordDialogInline(group: TabGroup, groupManager: TabGroupManager) {
        val passwordInput = EditText(this).apply {
            inputType = android.text.InputType.TYPE_CLASS_TEXT or android.text.InputType.TYPE_TEXT_VARIATION_PASSWORD
            hint = "è¯·è¾“å…¥å¯†ç "
        }
        val confirmInput = EditText(this).apply {
            inputType = android.text.InputType.TYPE_CLASS_TEXT or android.text.InputType.TYPE_TEXT_VARIATION_PASSWORD
            hint = "è¯·ç¡®è®¤å¯†ç "
        }
        
        val layout = android.widget.LinearLayout(this).apply {
            orientation = android.widget.LinearLayout.VERTICAL
            setPadding(48, 24, 48, 24)
            addView(passwordInput)
            addView(confirmInput)
        }
        
        // ä½¿ç”¨AppCompat AlertDialogå¹¶æŒ‡å®šä¸»é¢˜ï¼Œé¿å…é»‘å±é—®é¢˜
        val themedContext = androidx.appcompat.view.ContextThemeWrapper(
            this,
            androidx.appcompat.R.style.Theme_AppCompat_Light_Dialog_Alert
        )
        androidx.appcompat.app.AlertDialog.Builder(themedContext)
            .setTitle("è®¾ç½®å¯†ç ")
            .setView(layout)
            .setPositiveButton("ç¡®å®š") { _, _ ->
                val password = passwordInput.text.toString()
                val confirm = confirmInput.text.toString()
                if (password.isEmpty()) {
                    showMaterialToast("å¯†ç ä¸èƒ½ä¸ºç©º")
                } else if (password != confirm) {
                    showMaterialToast("ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´")
                } else {
                    groupManager.setGroupPassword(group.id, password)
                    refreshGroupTabs()
                    showMaterialToast("å¯†ç å·²è®¾ç½®")
                }
            }
            .setNegativeButton("å–æ¶ˆ", null)
            .show()
    }
    
    /**
     * æ˜¾ç¤ºä¿®æ”¹å¯†ç å¯¹è¯æ¡†ï¼ˆå†…è”ï¼‰
     */
    private fun showChangePasswordDialogInline(group: TabGroup, groupManager: TabGroupManager) {
        val oldPasswordInput = EditText(this).apply {
            inputType = android.text.InputType.TYPE_CLASS_TEXT or android.text.InputType.TYPE_TEXT_VARIATION_PASSWORD
            hint = "è¯·è¾“å…¥åŸå¯†ç "
        }
        val newPasswordInput = EditText(this).apply {
            inputType = android.text.InputType.TYPE_CLASS_TEXT or android.text.InputType.TYPE_TEXT_VARIATION_PASSWORD
            hint = "è¯·è¾“å…¥æ–°å¯†ç "
        }
        val confirmInput = EditText(this).apply {
            inputType = android.text.InputType.TYPE_CLASS_TEXT or android.text.InputType.TYPE_TEXT_VARIATION_PASSWORD
            hint = "è¯·ç¡®è®¤æ–°å¯†ç "
        }
        
        val layout = android.widget.LinearLayout(this).apply {
            orientation = android.widget.LinearLayout.VERTICAL
            setPadding(48, 24, 48, 24)
            addView(oldPasswordInput)
            addView(newPasswordInput)
            addView(confirmInput)
        }
        
        // ä½¿ç”¨AppCompat AlertDialogå¹¶æŒ‡å®šä¸»é¢˜ï¼Œé¿å…é»‘å±é—®é¢˜
        val themedContext = androidx.appcompat.view.ContextThemeWrapper(
            this,
            androidx.appcompat.R.style.Theme_AppCompat_Light_Dialog_Alert
        )
        androidx.appcompat.app.AlertDialog.Builder(themedContext)
            .setTitle("ä¿®æ”¹å¯†ç ")
            .setView(layout)
            .setPositiveButton("ç¡®å®š") { _, _ ->
                val oldPassword = oldPasswordInput.text.toString()
                val newPassword = newPasswordInput.text.toString()
                val confirm = confirmInput.text.toString()
                
                if (!groupManager.verifyGroupPassword(group.id, oldPassword)) {
                    showMaterialToast("åŸå¯†ç é”™è¯¯")
                } else if (newPassword.isEmpty()) {
                    showMaterialToast("æ–°å¯†ç ä¸èƒ½ä¸ºç©º")
                } else if (newPassword != confirm) {
                    showMaterialToast("ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´")
                } else {
                    groupManager.setGroupPassword(group.id, newPassword)
                    refreshGroupTabs()
                    showMaterialToast("å¯†ç å·²ä¿®æ”¹")
                }
            }
            .setNegativeButton("å–æ¶ˆ", null)
            .show()
    }
    
    /**
     * æ˜¾ç¤ºç§»é™¤å¯†ç å¯¹è¯æ¡†ï¼ˆå†…è”ï¼‰
     */
    private fun showRemovePasswordDialogInline(group: TabGroup, groupManager: TabGroupManager) {
        val passwordInput = EditText(this).apply {
            inputType = android.text.InputType.TYPE_CLASS_TEXT or android.text.InputType.TYPE_TEXT_VARIATION_PASSWORD
            hint = "è¯·è¾“å…¥å¯†ç ç¡®è®¤"
        }
        
        // ä½¿ç”¨AppCompat AlertDialogå¹¶æŒ‡å®šä¸»é¢˜ï¼Œé¿å…é»‘å±é—®é¢˜
        val themedContext = androidx.appcompat.view.ContextThemeWrapper(
            this,
            androidx.appcompat.R.style.Theme_AppCompat_Light_Dialog_Alert
        )
        androidx.appcompat.app.AlertDialog.Builder(themedContext)
            .setTitle("ç§»é™¤å¯†ç ")
            .setMessage("ç¡®å®šè¦ç§»é™¤ç»„ã€Œ${group.name}ã€çš„å¯†ç ä¿æŠ¤å—ï¼Ÿ")
            .setView(passwordInput)
            .setPositiveButton("ç¡®å®š") { _, _ ->
                val password = passwordInput.text.toString()
                if (groupManager.verifyGroupPassword(group.id, password)) {
                    groupManager.removeGroupPassword(group.id)
                    refreshGroupTabs()
                    showMaterialToast("å¯†ç å·²ç§»é™¤")
                } else {
                    showMaterialToast("å¯†ç é”™è¯¯")
                }
            }
            .setNegativeButton("å–æ¶ˆ", null)
            .show()
    }
    
    /**
     * æ˜¾ç¤ºè®¾ç½®å¿«æ·è®¿é—®ç å¯¹è¯æ¡†ï¼ˆå†…è”ï¼‰
     */
    private fun showSetQuickAccessCodeDialogInline(group: TabGroup, groupManager: TabGroupManager) {
        val codeInput = EditText(this).apply {
            inputType = android.text.InputType.TYPE_CLASS_TEXT or android.text.InputType.TYPE_TEXT_VARIATION_PASSWORD
            hint = "è¯·è¾“å…¥å¿«æ·è®¿é—®ç ï¼ˆç‰¹æ®Šå¯†ç ï¼‰"
        }
        
        // ä½¿ç”¨AppCompat AlertDialogå¹¶æŒ‡å®šä¸»é¢˜ï¼Œé¿å…é»‘å±é—®é¢˜
        val themedContext = androidx.appcompat.view.ContextThemeWrapper(
            this,
            androidx.appcompat.R.style.Theme_AppCompat_Light_Dialog_Alert
        )
        androidx.appcompat.app.AlertDialog.Builder(themedContext)
            .setTitle("è®¾ç½®å¿«æ·è®¿é—®ç ")
            .setMessage("å¿«æ·è®¿é—®ç æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„å¯†ç ï¼Œå¯ä»¥ç”¨æ¥å¿«é€Ÿè®¿é—®åŠ å¯†çš„ç»„")
            .setView(codeInput)
            .setPositiveButton("ç¡®å®š") { _, _ ->
                val code = codeInput.text.toString()
                if (code.isEmpty()) {
                    showMaterialToast("è®¿é—®ç ä¸èƒ½ä¸ºç©º")
                } else {
                    groupManager.setQuickAccessCode(group.id, code)
                    showMaterialToast("å¿«æ·è®¿é—®ç å·²è®¾ç½®")
                }
            }
            .setNegativeButton("å–æ¶ˆ", null)
            .show()
    }
    
}
