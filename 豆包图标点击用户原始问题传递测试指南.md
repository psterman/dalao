# 豆包图标点击用户原始问题传递测试指南

## 功能描述

当用户在AI回复下方点击豆包图标时，应该将用户原始提问的"你好"作为关键词提取出来，跳转到豆包应用并将"你好"发送给豆包，确保用户能够准确获取对应的回复跳转。

## 数据流分析

### 1. 用户提问到AI回复的数据流

**用户操作**：
1. 用户在输入框中输入："你好"
2. 点击发送按钮
3. AI回复："你好! 有什么可以帮您的吗?"
4. AI回复下方显示平台图标（包括豆包图标）

**数据传递流程**：
```kotlin
// 1. ChatActivity.sendMessage()
val userMessage = ChatMessage("你好", true, System.currentTimeMillis())
val aiMessage = ChatMessage("正在思考中...", false, System.currentTimeMillis(), "你好")
//                                                                                    ↑
//                                                                            用户原始问题
```

### 2. 平台图标显示的数据流

**ChatMessageAdapter.bind()**：
```kotlin
// 检查是否包含平台图标标记
val hasPlatformIcons = message.content.contains("[PLATFORM_ICONS]")

if (hasPlatformIcons) {
    // 分离内容和平台图标标记
    val contentParts = message.content.split("[PLATFORM_ICONS]")
    val actualContent = contentParts[0].trim()
    
    // 显示平台图标
    showPlatformIcons(message.userQuery ?: "")  // "你好"
    //                    ↑
    //              用户原始问题
}
```

### 3. 豆包图标点击的数据流

**PlatformIconsView.createPlatformIcon()**：
```kotlin
// 设置点击效果
setOnClickListener {
    platformJumpManager.jumpToPlatform(platform.name, query)  // query = "你好"
    //                                                      ↑
    //                                              用户原始问题
}
```

**PlatformJumpManager.jumpToPlatform()**：
```kotlin
fun jumpToPlatform(platformName: String, query: String) {
    // platformName = "豆包", query = "你好"
    
    if (config != null) {
        // 预设平台处理
    } else {
        // 动态应用处理
        jumpToDynamicApp(platformName, query)  // "豆包", "你好"
    }
}
```

**PlatformJumpManager.jumpToDynamicApp()**：
```kotlin
private fun jumpToDynamicApp(appName: String, query: String) {
    // appName = "豆包", query = "你好"
    
    // 1. 检查是否是AI应用
    if (isAIApp(appName)) {  // "豆包" -> true
        jumpToAIApp(appName, query)  // "豆包", "你好"
        return
    }
}
```

**PlatformJumpManager.jumpToAIApp()**：
```kotlin
private fun jumpToAIApp(appName: String, query: String) {
    // appName = "豆包", query = "你好"
    
    Log.d(TAG, "跳转到AI应用: $appName, 查询: $query")
    // 输出：跳转到AI应用: 豆包, 查询: 你好
    
    // 获取AI应用的包名列表
    val possiblePackages = getAIPackages(appName)  // ["com.larus.nova"]
    
    // 检查是否有已安装的AI应用
    val installedPackage = getInstalledAIPackageName(possiblePackages)
    if (installedPackage != null) {
        // 使用软件tab的AI跳转方法
        launchAIAppWithIntent(installedPackage, query, appName)
        //                                    ↑
        //                              用户原始问题"你好"
    }
}
```

**PlatformJumpManager.launchAIAppWithIntent()**：
```kotlin
private fun launchAIAppWithIntent(packageName: String, query: String, appName: String) {
    // packageName = "com.larus.nova", query = "你好", appName = "豆包"
    
    Log.d(TAG, "启动AI应用: $appName, 包名: $packageName, 查询: $query")
    // 输出：启动AI应用: 豆包, 包名: com.larus.nova, 查询: 你好
    
    // 参考软件tab的AI跳转方法：启动应用并使用自动化粘贴
    launchAppWithAutoPaste(packageName, query, appName)
    //                                    ↑
    //                              用户原始问题"你好"
}
```

**PlatformJumpManager.launchAppWithAutoPaste()**：
```kotlin
private fun launchAppWithAutoPaste(packageName: String, query: String, appName: String) {
    // packageName = "com.larus.nova", query = "你好", appName = "豆包"
    
    Log.d(TAG, "启动应用并使用自动化粘贴: $appName, 问题: $query")
    // 输出：启动应用并使用自动化粘贴: 豆包, 问题: 你好
    
    // 将问题复制到剪贴板
    val clipboard = context.getSystemService(Context.CLIPBOARD_SERVICE) as ClipboardManager
    val clip = ClipData.newPlainText("AI问题", query)  // query = "你好"
    clipboard.setPrimaryClip(clip)
    
    // 启动AI应用
    val launchIntent = context.packageManager.getLaunchIntentForPackage(packageName)
    context.startActivity(launchIntent)
    Toast.makeText(context, "正在启动${appName}...", Toast.LENGTH_SHORT).show()
    
    // 延迟显示悬浮窗
    Handler(Looper.getMainLooper()).postDelayed({
        showAIAppOverlay(packageName, query, appName)  // query = "你好"
        //                                    ↑
        //                              用户原始问题"你好"
    }, 2000)
}
```

## 测试步骤

### 1. 基础功能测试

#### 1.1 用户提问测试
1. **进入对话tab**
   - 打开应用，进入对话tab
   - 选择任意AI助手

2. **发送测试问题**
   - 在输入框中输入："你好"
   - 点击发送按钮
   - 等待AI回复完成

3. **验证AI回复**
   - 确认AI回复："你好! 有什么可以帮您的吗?"
   - 确认AI回复下方显示了平台图标
   - 确认包含豆包图标

#### 1.2 豆包图标点击测试
1. **点击豆包图标**
   - 点击AI回复下方的豆包图标
   - 观察跳转行为

2. **验证日志输出**
   - 检查日志中是否显示：
     - "跳转到AI应用: 豆包, 查询: 你好"
     - "启动AI应用: 豆包, 包名: com.larus.nova, 查询: 你好"
     - "启动应用并使用自动化粘贴: 豆包, 问题: 你好"

3. **验证剪贴板内容**
   - 检查系统剪贴板是否包含"你好"
   - 验证剪贴板标签是否为"AI问题"

4. **验证豆包应用启动**
   - 豆包应用应该启动
   - 显示"正在启动豆包..."提示

5. **验证悬浮窗显示**
   - 2秒后应该显示悬浮窗
   - 悬浮窗应该包含"你好"这个用户原始问题
   - 悬浮窗应该提供粘贴指导

### 2. 不同问题类型测试

#### 2.1 短问题测试
1. **发送短问题**
   - 输入："你好"
   - 点击豆包图标
   - 验证"你好"正确传递

2. **发送单字问题**
   - 输入："好"
   - 点击豆包图标
   - 验证"好"正确传递

#### 2.2 长问题测试
1. **发送长问题**
   - 输入："请详细解释人工智能的发展历史和未来趋势"
   - 点击豆包图标
   - 验证完整问题正确传递

2. **发送多行问题**
   - 输入："请推荐几部好看的电影\n并说明推荐理由"
   - 点击豆包图标
   - 验证多行问题正确传递

#### 2.3 特殊字符测试
1. **发送包含特殊字符的问题**
   - 输入："@#$%^&*()"
   - 点击豆包图标
   - 验证特殊字符正确传递

2. **发送包含emoji的问题**
   - 输入："😊请推荐一些好电影"
   - 点击豆包图标
   - 验证emoji正确传递

### 3. 数据传递完整性测试

#### 3.1 userQuery字段测试
1. **验证userQuery设置**
   - 检查`ChatMessage`的`userQuery`字段是否正确设置为用户原始问题
   - 验证`message.userQuery ?: ""`是否正确获取用户问题

2. **验证userQuery传递**
   - 检查`showPlatformIcons(message.userQuery ?: "")`是否正确传递
   - 验证平台图标点击时是否正确使用用户原始问题

#### 3.2 关键词提取测试
1. **验证关键词提取**
   - 用户输入："你好"
   - 验证提取的关键词为："你好"
   - 验证关键词完整性和准确性

2. **验证关键词传递**
   - 验证关键词从用户输入到豆包应用的完整传递链路
   - 确保无数据丢失或截断

### 4. 豆包应用交互测试

#### 4.1 剪贴板粘贴测试
1. **验证剪贴板内容**
   - 点击豆包图标后，检查剪贴板内容
   - 验证剪贴板内容为用户原始问题"你好"

2. **测试手动粘贴**
   - 在豆包应用中手动粘贴
   - 验证粘贴内容为"你好"

#### 4.2 悬浮窗功能测试
1. **验证悬浮窗显示**
   - 悬浮窗应该在2秒后显示
   - 悬浮窗应该包含用户原始问题"你好"

2. **测试悬浮窗粘贴**
   - 点击悬浮窗中的粘贴按钮
   - 验证"你好"是否正确粘贴到豆包应用

#### 4.3 豆包应用响应测试
1. **验证豆包接收**
   - 在豆包应用中验证是否接收到"你好"
   - 验证豆包是否能够正确理解并回复

2. **验证回复相关性**
   - 验证豆包对"你好"的回复是否相关
   - 验证回复质量是否满足用户期望

### 5. 错误处理测试

#### 5.1 豆包应用未安装测试
1. **卸载豆包应用**
   - 如果已安装，先卸载豆包应用
   - 点击豆包图标

2. **验证错误处理**
   - 应该显示"无法启动豆包，请检查应用是否已安装"提示
   - 不应该崩溃或异常

#### 5.2 剪贴板权限测试
1. **测试剪贴板权限**
   - 验证剪贴板写入权限
   - 验证剪贴板读取权限

2. **测试剪贴板异常**
   - 模拟剪贴板操作失败
   - 验证错误处理机制

## 预期结果

### 1. 数据传递完整性
- ✅ 用户原始问题"你好"完整传递
- ✅ 无数据丢失或截断
- ✅ 特殊字符正确处理

### 2. 豆包应用跳转
- ✅ 豆包应用正常启动
- ✅ 用户问题"你好"复制到剪贴板
- ✅ 悬浮窗正常显示并包含"你好"

### 3. 用户交互体验
- ✅ 点击豆包图标响应及时
- ✅ 用户提示清晰友好
- ✅ 操作流程顺畅

### 4. 豆包应用响应
- ✅ 豆包正确接收"你好"
- ✅ 豆包回复相关且有用
- ✅ 用户体验良好

## 技术实现验证

### 1. 数据流完整性
```kotlin
// 用户输入："你好"
val userMessage = ChatMessage("你好", true, System.currentTimeMillis())
val aiMessage = ChatMessage("正在思考中...", false, System.currentTimeMillis(), "你好")
//                                                                                    ↑
//                                                                            用户原始问题

// 平台图标显示
showPlatformIcons(message.userQuery ?: "")  // "你好"

// 豆包图标点击
platformJumpManager.jumpToPlatform("豆包", "你好")

// 豆包应用跳转
launchAppWithAutoPaste("com.larus.nova", "你好", "豆包")

// 剪贴板复制
val clip = ClipData.newPlainText("AI问题", "你好")
clipboard.setPrimaryClip(clip)

// 悬浮窗显示
showAIAppOverlay("com.larus.nova", "你好", "豆包")
```

### 2. 关键词提取准确性
- **输入**：用户输入"你好"
- **提取**：系统提取关键词"你好"
- **传递**：关键词"你好"完整传递到豆包应用
- **使用**：豆包应用使用"你好"进行回复

### 3. 用户体验优化
- **即时响应**：点击豆包图标后立即响应
- **清晰提示**：显示"正在启动豆包..."提示
- **操作指导**：悬浮窗提供粘贴指导
- **无缝体验**：从点击到豆包回复的完整流程

## 注意事项
- 确保豆包应用已安装（包名：`com.larus.nova`）
- 验证剪贴板权限正常
- 检查悬浮窗服务状态
- 测试不同问题类型的传递
- 验证数据传递的完整性
- 确保用户体验的流畅性


