# 纸堆系统加载逻辑梳理

## 📋 系统概述

纸堆系统（PaperStackWebViewManager）是一个标签页管理系统，用于管理多个WebView标签页，实现类似iOS Safari的卡片叠加效果。

## 🔄 加载流程

### 1. 标签页创建流程（addTab方法）

```
用户操作（创建新标签页）
    ↓
PaperStackWebViewManager.addTab()
    ↓
创建PaperWebView实例
    ↓
设置WebView背景为白色（避免透视）
    ↓
添加到容器（container.addView）
    ↓
添加到标签页列表（tabs.add）
    ↓
设置当前标签页索引（currentTabIndex）
    ↓
确保功能主页存在（ensureFunctionalHomeExists）
    ↓
【关键】调用onTabCreatedListener（在updateTabPositions之前）
    ├─ 隐藏browser_home_content（功能主页按钮）
    ├─ 设置WebView容器背景为白色
    ├─ 设置WebView背景为白色
    └─ 显示加载遮罩层（showLoadingOverlay）
    ↓
更新标签页位置（updateTabPositions）
    ├─ 设置当前标签页可见
    ├─ 设置其他标签页隐藏
    └─ 设置WebView背景为白色
    ↓
加载URL（webView.loadUrl）
    ↓
通知监听器（onTabSwitchedListener）
```

### 2. 页面加载流程

#### 2.1 页面开始加载（onPageStarted）

```
WebView开始加载URL
    ↓
PaperStackWebViewManager.onPageStarted()
    ├─ 重新设置视频拦截接口
    ├─ 重置错误状态
    ├─ 设置WebView背景为白色（避免透视）
    └─ 调用onPageStartedListener
        ↓
SimpleModeActivity.onPageStartedListener
    ├─ 显示加载遮罩层（showLoadingOverlay）
    ├─ 隐藏阅读模式按钮
    ├─ 更新地址栏URL
    └─ 隐藏悬浮播放器
```

#### 2.2 页面加载完成（onPageFinished）

```
WebView页面加载完成
    ↓
PaperStackWebViewManager.onPageFinished()
    ├─ 设置视频拦截接口
    ├─ 注入视频拦截脚本
    ├─ 检查网页背景色（如果透明则设置为白色）
    ├─ 设置WebView背景为白色
    └─ 调用onPageFinishedListener
        ↓
SimpleModeActivity.onPageFinishedListener
    ├─ 隐藏加载遮罩层（hideLoadingOverlay）
    ├─ 更新地址栏URL
    ├─ 注入视频检测脚本
    └─ 保存页面截图
```

### 3. 标签页切换流程（switchToTab方法）

```
用户滑动切换标签页
    ↓
PaperStackWebViewManager.switchToTab()
    ├─ 检查是否正在动画中
    ├─ 延迟加载目标标签页（如果需要）
    ├─ 判断滑动方向
    ├─ 【关键】设置WebView背景为白色（在动画开始前）
    ├─ 创建切换动画（createCardStackAnimation）
    │   ├─ 设置目标WebView背景为白色
    │   ├─ 设置当前WebView背景为白色
    │   └─ 创建滑动动画
    ├─ 动画开始（onAnimationStart）
    │   └─ 再次确保WebView背景为白色
    └─ 动画结束（onAnimationEnd）
        ├─ 隐藏当前标签页
        ├─ 显示目标标签页
        ├─ 设置目标WebView背景为白色
        └─ 调用onTabSwitchedListener
            ↓
SimpleModeActivity.onTabSwitchedListener
    ├─ 隐藏快捷操作栏（如果可见）
    ├─ 隐藏阅读模式按钮
    ├─ 更新页面数量
    ├─ 更新地址栏URL
    └─ 添加滚动监听器
```

## 🎨 加载遮罩层机制

### 显示时机
1. **标签页创建时**：在`setOnTabCreatedListener`中立即显示
2. **页面开始加载时**：在`setOnPageStartedListener`中显示

### 隐藏时机
1. **页面加载完成时**：在`setOnPageFinishedListener`中隐藏

### 动画效果
- **显示**：淡入动画（200ms，DecelerateInterpolator）
- **隐藏**：淡出动画（200ms，AccelerateInterpolator）

### 作用
- 遮挡功能主页按钮（`browser_home_content`）
- 提供加载反馈（显示加载指示器和文字）
- 避免用户看到背面的组件

## 🔧 关键修复点

### 1. 背景色设置
- **问题**：WebView背景透明导致透视到功能主页按钮
- **解决**：
  - 在标签页创建时设置背景为白色
  - 在页面开始加载时保持白色背景
  - 在页面加载完成时保持白色背景
  - 在标签页切换时保持白色背景

### 2. 功能主页按钮隐藏时机
- **问题**：`browser_home_content`在WebView可见后才隐藏
- **解决**：将`onTabCreatedListener`调用提前到`updateTabPositions()`之前

### 3. 加载遮罩层
- **问题**：在页面加载过程中仍能看到功能主页按钮
- **解决**：添加加载遮罩层，在加载时完全遮挡功能主页按钮

## 📊 组件层级关系

```
browser_webview_container (FrameLayout)
├── browser_pull_down_toolbar (下拉工具栏)
├── paper_stack_layout (纸堆WebView布局)
│   └── WebView容器（PaperStackWebViewManager的container）
│       └── PaperWebView (多个标签页)
├── browser_quick_actions_bar (快捷操作栏)
├── browser_home_content (功能主页按钮) ← 需要被遮挡
├── browser_progress_bar (进度条)
└── browser_loading_overlay (加载遮罩层) ← 新增，用于遮挡
```

## 🎯 优化建议

1. **预加载机制**：可以考虑在后台预加载常用标签页
2. **缓存策略**：保存标签页截图，切换时先显示截图
3. **加载优化**：对于功能主页，可以提前加载HTML文件
4. **动画优化**：可以添加更流畅的页面切换动画

## 📝 相关文件

- `PaperStackWebViewManager.kt` - 纸堆系统核心逻辑
- `SimpleModeActivity.kt` - 主Activity，处理UI交互
- `activity_simple_mode.xml` - 布局文件
- `functional_home.html` - 功能主页HTML


