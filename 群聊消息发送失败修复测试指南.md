# 群聊消息发送失败修复测试指南

## 问题描述
在简易模式的对话tab的群聊中，用户发送消息后如果失败，弹窗提示失败，但用户输入的文字会直接消失，无法恢复。

## 修复内容

### 1. 主要修复
- **输入框恢复机制**：发送失败时自动恢复用户输入的文字到输入框
- **消息列表清理**：发送失败时从消息列表中移除失败的用户消息
- **错误信息优化**：提供更详细和用户友好的错误提示

### 2. 具体改进
- 在`handleGroupChatMessage`方法中添加了`restoreUserInput`函数
- 添加了`getGroupChatErrorMessage`函数提供详细的错误诊断
- 改进了异常处理，根据错误类型提供不同的提示信息

## 测试步骤

### 测试1：正常发送消息
1. 进入简易模式
2. 切换到对话tab
3. 选择一个群聊
4. 输入消息并发送
5. **预期结果**：消息正常发送，输入框清空

### 测试2：网络断开时发送消息
1. 断开网络连接
2. 在群聊中输入消息并发送
3. **预期结果**：
   - 显示"网络连接失败，请检查网络设置后重试"
   - 用户输入的文字恢复到输入框
   - 消息列表中没有显示失败的用户消息

### 测试3：API密钥未配置时发送消息
1. 确保群聊中有需要API密钥的AI（如DeepSeek、智谱AI）
2. 在设置中删除对应的API密钥
3. 在群聊中输入消息并发送
4. **预期结果**：
   - 显示具体的API密钥配置错误提示
   - 用户输入的文字恢复到输入框
   - 消息列表中没有显示失败的用户消息

### 测试4：群聊配置错误时发送消息
1. 创建一个没有AI成员的群聊
2. 在该群聊中输入消息并发送
3. **预期结果**：
   - 显示"群聊中没有AI成员，无法发送消息"
   - 用户输入的文字恢复到输入框

### 测试5：群聊数据加载失败时发送消息
1. 模拟群聊数据损坏的情况
2. 在群聊中输入消息并发送
3. **预期结果**：
   - 显示"群聊数据加载失败，请重新进入群聊"
   - 用户输入的文字恢复到输入框

## 验证要点

### 1. 输入框恢复
- ✅ 发送失败时，用户输入的文字应该完整恢复到输入框
- ✅ 光标应该定位到文字末尾
- ✅ 用户可以继续编辑或重新发送

### 2. 消息列表清理
- ✅ 发送失败时，失败的用户消息不应该显示在消息列表中
- ✅ 消息列表应该保持发送前的状态

### 3. 错误提示
- ✅ 错误提示应该具体明确，帮助用户了解问题原因
- ✅ 不同错误类型应该显示不同的提示信息
- ✅ 提示信息应该包含解决建议

### 4. 用户体验
- ✅ 发送按钮应该重新启用
- ✅ 发送状态应该正确重置
- ✅ 界面应该保持响应状态

## 技术实现细节

### 1. 核心修复代码
```kotlin
// 恢复用户输入到输入框
private fun restoreUserInput(messageText: String) {
    messageInput.setText(messageText)
    messageInput.setSelection(messageText.length)
    
    // 从消息列表中移除失败的用户消息
    if (messages.isNotEmpty() && messages.last().isFromUser) {
        messages.removeAt(messages.size - 1)
        messageAdapter.updateMessages(messages.toList())
    }
}
```

### 2. 错误诊断代码
```kotlin
private fun getGroupChatErrorMessage(groupChat: GroupChat): String {
    val aiMembers = groupChat.members.filter { it.type == MemberType.AI }
    
    return when {
        aiMembers.isEmpty() -> "群聊中没有AI成员，无法发送消息"
        aiMembers.all { it.aiServiceType == null } -> "群聊中AI成员配置不完整，请检查设置"
        aiMembers.any { it.aiServiceType == AIServiceType.ZHIPU_AI && getApiKeyForService(AIServiceType.ZHIPU_AI).isBlank() } -> 
            "智谱AI API密钥未配置，请检查设置"
        aiMembers.any { it.aiServiceType == AIServiceType.DEEPSEEK && getApiKeyForService(AIServiceType.DEEPSEEK).isBlank() } -> 
            "DeepSeek API密钥未配置，请检查设置"
        else -> "发送消息失败，请检查网络连接或稍后重试"
    }
}
```

## 注意事项

1. **向后兼容**：修复不影响正常的消息发送流程
2. **性能考虑**：错误诊断只在发送失败时执行，不影响正常性能
3. **用户体验**：所有错误恢复操作都在主线程执行，确保界面响应及时

## 测试完成标准

- [ ] 所有测试用例通过
- [ ] 用户输入在发送失败时能够完整恢复
- [ ] 错误提示信息准确且有用
- [ ] 界面状态正确重置
- [ ] 不影响正常消息发送功能
