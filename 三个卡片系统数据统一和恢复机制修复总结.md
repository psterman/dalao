# ä¸‰ä¸ªå¡ç‰‡ç³»ç»Ÿæ•°æ®ç»Ÿä¸€å’Œæ¢å¤æœºåˆ¶ä¿®å¤æ€»ç»“

## ğŸ¯ ä¿®å¤æ¦‚è¿°

æ ¹æ®ç”¨æˆ·åé¦ˆçš„ä¸¤ä¸ªå…³é”®é—®é¢˜ï¼Œè¿›è¡Œäº†å…¨é¢çš„ä¿®å¤å’Œä¼˜åŒ–ï¼š

### 1. ä¸‰ä¸ªå¡ç‰‡ç³»ç»Ÿæ•°æ®ç»Ÿä¸€é—®é¢˜ âœ…
### 2. æ¢å¤çª—å£æœºåˆ¶ä¿®å¤ âœ…

---

## ğŸ”§ é—®é¢˜1ï¼šä¸‰ä¸ªå¡ç‰‡ç³»ç»Ÿæ•°æ®ç»Ÿä¸€ä¿®å¤

### é—®é¢˜æè¿°
ç”¨æˆ·åé¦ˆä¸‰ä¸ªå¡ç‰‡ç³»ç»Ÿæ²¡æœ‰å®ç°æ•°æ®ç»Ÿä¸€ï¼š
1. **æœç´¢tabçš„"å¡ç‰‡é¢„è§ˆ"æŒ‰é’®** - ä¸€ç›´æç¤º"æ²¡æœ‰æ‰“å¼€çš„é¡µé¢"
2. **æœç´¢tabçš„å·¦ä¸Šè§’æŒ‰é’®** - æ•°æ®æ˜¾ç¤ºä¸ä¸€è‡´
3. **æœç´¢tabåŒºåŸŸæ¿€æ´»çš„å¤šå¡ç‰‡ç³»ç»Ÿ** - æ•°æ®ä¸åŒæ­¥

### æ ¹æœ¬åŸå› åˆ†æ
ä¸‰ä¸ªå¡ç‰‡ç³»ç»Ÿä½¿ç”¨äº†ä¸åŒçš„æ•°æ®æºï¼š
- **å¡ç‰‡é¢„è§ˆæŒ‰é’®** (`showCardPreviewDialog`) - åªä½¿ç”¨ `gestureCardWebViewManager`
- **å·¦ä¸Šè§’æŒ‰é’®** (`showCardPreview`) - ä½¿ç”¨ç»Ÿä¸€æ•°æ®æº `getAllUnifiedCards()`
- **å¤šå¡ç‰‡ç³»ç»Ÿ** (`activateStackedCardPreview`) - ä½¿ç”¨ç»Ÿä¸€æ•°æ®æº `getAllUnifiedCards()`

### ä¿®å¤æ–¹æ¡ˆ

#### 1.1 ç»Ÿä¸€æ•°æ®æº
å°†æ‰€æœ‰ä¸‰ä¸ªå¡ç‰‡ç³»ç»Ÿéƒ½æ”¹ä¸ºä½¿ç”¨ç»Ÿä¸€çš„æ•°æ®è·å–æ–¹æ³•ï¼š

```kotlin
// ä¿®å¤å‰ï¼šåªä½¿ç”¨gestureCardWebViewManager
gestureCardWebViewManager?.let { manager ->
    val allCards = manager.getAllCards()
    // ...
}

// ä¿®å¤åï¼šä½¿ç”¨ç»Ÿä¸€æ•°æ®æº
private fun showCardPreviewDialog() {
    Log.d(TAG, "=== æœç´¢tabå¡ç‰‡é¢„è§ˆæŒ‰é’®è¢«ç‚¹å‡» ===")
    try {
        // å…ˆå¼ºåˆ¶åŒæ­¥æ‰€æœ‰å¡ç‰‡ç³»ç»Ÿæ•°æ®
        syncAllCardSystems()
        
        // ä½¿ç”¨ç»Ÿä¸€çš„å¡ç‰‡æ•°æ®è·å–æ–¹æ³•
        val allCards = getAllUnifiedCards()
        val totalPages = allCards.size

        Log.d(TAG, "æœç´¢tabå¡ç‰‡é¢„è§ˆ - ç»Ÿä¸€æ•°æ®æºå¡ç‰‡æ•°é‡: $totalPages")
        // ...
    }
}
```

#### 1.2 å¼ºåˆ¶æ•°æ®åŒæ­¥
åœ¨æ¯ä¸ªå¡ç‰‡ç³»ç»Ÿæ¿€æ´»å‰ï¼Œå¼ºåˆ¶åŒæ­¥æ‰€æœ‰æ•°æ®ï¼š

```kotlin
// å¡ç‰‡é¢„è§ˆæŒ‰é’®ç‚¹å‡»æ—¶
browserPreviewCardsButton.setOnClickListener {
    Log.d(TAG, "å·¦ä¸Šè§’å¡ç‰‡é¢„è§ˆæŒ‰é’®è¢«ç‚¹å‡»")
    
    // å…ˆå¼ºåˆ¶åŒæ­¥æ‰€æœ‰å¡ç‰‡ç³»ç»Ÿæ•°æ®
    syncAllCardSystems()
    
    // ç„¶åæ˜¾ç¤ºå¡ç‰‡é¢„è§ˆ
    showCardPreview()
}

// æœç´¢tabå¡ç‰‡é¢„è§ˆæŒ‰é’®ç‚¹å‡»æ—¶
private fun showCardPreviewDialog() {
    // å…ˆå¼ºåˆ¶åŒæ­¥æ‰€æœ‰å¡ç‰‡ç³»ç»Ÿæ•°æ®
    syncAllCardSystems()
    
    // ä½¿ç”¨ç»Ÿä¸€çš„å¡ç‰‡æ•°æ®è·å–æ–¹æ³•
    val allCards = getAllUnifiedCards()
    // ...
}
```

#### 1.3 ä¿®å¤ç®€å•é¢„è§ˆå¯¹è¯æ¡†
å°†`showSimpleCardPreviewDialog`ä¹Ÿæ”¹ä¸ºä½¿ç”¨ç»Ÿä¸€æ•°æ®æºï¼š

```kotlin
// ä¿®å¤å‰ï¼šä½¿ç”¨ç‰¹å®šç®¡ç†å™¨
private fun showSimpleCardPreviewDialog(
    manager: GestureCardWebViewManager? = gestureCardWebViewManager,
    totalPages: Int = manager?.getAllCards()?.size ?: 0,
    // ...
)

// ä¿®å¤åï¼šä½¿ç”¨ç»Ÿä¸€æ•°æ®æº
private fun showSimpleCardPreviewDialog() {
    try {
        // ä½¿ç”¨ç»Ÿä¸€çš„å¡ç‰‡æ•°æ®è·å–æ–¹æ³•
        val allCards = getAllUnifiedCards()
        val totalPages = allCards.size
        
        // è·å–å½“å‰å¡ç‰‡ç´¢å¼•
        val currentCard = gestureCardWebViewManager?.getCurrentCard() ?: mobileCardManager?.getCurrentCard()
        val currentIndex = if (currentCard != null) {
            allCards.indexOfFirst { it.id == currentCard.id }
        } else {
            0
        }
        // ...
    }
}
```

#### 1.4 æ”¹è¿›å¡ç‰‡åˆ‡æ¢é€»è¾‘
åœ¨ç®€å•é¢„è§ˆå¯¹è¯æ¡†ä¸­ï¼Œæ”¹è¿›å¡ç‰‡åˆ‡æ¢é€»è¾‘ä»¥æ”¯æŒä¸¤ç§ç®¡ç†å™¨ï¼š

```kotlin
.setItems(pageItems.toTypedArray()) { _, which ->
    // åˆ‡æ¢åˆ°é€‰ä¸­çš„é¡µé¢
    try {
        // ä¼˜å…ˆä½¿ç”¨æ‰‹åŠ¿ç®¡ç†å™¨ï¼Œå¦‚æœå¤±è´¥åˆ™ä½¿ç”¨æ‰‹æœºç®¡ç†å™¨
        var switched = false
        if (gestureCardWebViewManager != null) {
            gestureCardWebViewManager?.switchToCard(which)
            switched = true
            Log.d(TAG, "ä½¿ç”¨æ‰‹åŠ¿ç®¡ç†å™¨åˆ‡æ¢åˆ°å¡ç‰‡: $which")
        } else if (mobileCardManager != null) {
            mobileCardManager?.switchToCard(which)
            switched = true
            Log.d(TAG, "ä½¿ç”¨æ‰‹æœºç®¡ç†å™¨åˆ‡æ¢åˆ°å¡ç‰‡: $which")
        }
        
        if (switched) {
            showPageSwitchAnimation("åˆ‡æ¢åˆ°", which + 1, totalPages)
        } else {
            Toast.makeText(this@SimpleModeActivity, "åˆ‡æ¢å¤±è´¥", Toast.LENGTH_SHORT).show()
        }
    } catch (e: Exception) {
        Log.e(TAG, "åˆ‡æ¢å¡ç‰‡å¤±è´¥", e)
        Toast.makeText(this@SimpleModeActivity, "åˆ‡æ¢å¤±è´¥", Toast.LENGTH_SHORT).show()
    }
}
```

---

## ğŸ”„ é—®é¢˜2ï¼šæ¢å¤çª—å£æœºåˆ¶ä¿®å¤

### é—®é¢˜æè¿°
ç”¨æˆ·è¿›å…¥æœç´¢tabæ—¶ï¼Œæ¢å¤ä¸Šæ¬¡æ²¡å…³é—­çš„çª—å£æ²¡æœ‰å¼¹å‡ºã€‚

### æ ¹æœ¬åŸå› åˆ†æ
1. **ä¼šè¯çº§åˆ«æ ‡è®°é—®é¢˜**ï¼š`hasShownRestoreDialog`ä¸€æ—¦è®¾ç½®ä¸ºtrueå°±ä¸ä¼šé‡ç½®
2. **æ£€æŸ¥æ—¶æœºé—®é¢˜**ï¼šåªåœ¨ç¬¬ä¸€æ¬¡è¿›å…¥æœç´¢tabæ—¶æ£€æŸ¥ï¼Œåç»­ä¸å†æ£€æŸ¥
3. **çŠ¶æ€é‡ç½®ç¼ºå¤±**ï¼šåˆ‡æ¢åˆ°å…¶ä»–tabåå†å›åˆ°æœç´¢tabæ—¶ä¸ä¼šé‡æ–°æ£€æŸ¥

### ä¿®å¤æ–¹æ¡ˆ

#### 2.1 æ”¹è¿›æ£€æŸ¥æœºåˆ¶
å°†ä¼šè¯çº§åˆ«çš„æ ‡è®°æ”¹ä¸ºåŸºäºæ—¶é—´é—´éš”çš„æ£€æŸ¥ï¼š

```kotlin
// æ–°å¢æ—¶é—´é—´éš”æ§åˆ¶
private var lastRestoreCheckTime = 0L
private val RESTORE_CHECK_INTERVAL = 3000L // 3ç§’é—´éš”

private fun checkAndPromptForSavedCards() {
    // æ£€æŸ¥æ—¶é—´é—´éš”ï¼Œé¿å…çŸ­æ—¶é—´å†…é‡å¤å¼¹å‡º
    val currentTime = System.currentTimeMillis()
    if (currentTime - lastRestoreCheckTime < RESTORE_CHECK_INTERVAL) {
        Log.d(TAG, "è·ç¦»ä¸Šæ¬¡æ£€æŸ¥æ—¶é—´è¿‡çŸ­ï¼Œè·³è¿‡")
        return
    }
    
    // æ£€æŸ¥å½“å‰æ˜¯å¦å·²æœ‰å¡ç‰‡ï¼Œå¦‚æœæœ‰åˆ™ä¸æ˜¾ç¤ºæ¢å¤å¯¹è¯æ¡†
    val currentCards = getAllUnifiedCards()
    if (currentCards.isNotEmpty()) {
        Log.d(TAG, "å½“å‰å·²æœ‰ ${currentCards.size} ä¸ªå¡ç‰‡ï¼Œè·³è¿‡æ¢å¤æç¤º")
        return
    }
    
    // æ›´æ–°æ£€æŸ¥æ—¶é—´
    lastRestoreCheckTime = currentTime
    // ...
}
```

#### 2.2 æ·»åŠ çŠ¶æ€é‡ç½®æœºåˆ¶
åœ¨ç”¨æˆ·åˆ‡æ¢åˆ°å…¶ä»–tabæ—¶é‡ç½®æ£€æŸ¥çŠ¶æ€ï¼š

```kotlin
// ä¸ºæ‰€æœ‰å…¶ä»–tabæ·»åŠ çŠ¶æ€é‡ç½®
findViewById<LinearLayout>(R.id.tab_chat)?.apply {
    setOnClickListener {
        deactivateStackedCardPreview()
        showChat()
        deactivateSearchTabGestureOverlay()
        // é‡ç½®æ¢å¤å¯¹è¯æ¡†æ£€æŸ¥çŠ¶æ€ï¼Œå…è®¸ä¸‹æ¬¡è¿›å…¥æœç´¢tabæ—¶é‡æ–°æ£€æŸ¥
        resetRestoreDialogState()
    }
}

// é‡ç½®æ–¹æ³•
private fun resetRestoreDialogState() {
    Log.d(TAG, "é‡ç½®æ¢å¤å¯¹è¯æ¡†æ£€æŸ¥çŠ¶æ€")
    // é‡ç½®æ—¶é—´æˆ³ï¼Œå…è®¸ä¸‹æ¬¡æ£€æŸ¥
    lastRestoreCheckTime = 0L
    // æ³¨æ„ï¼šä¸é‡ç½®hasShownRestoreDialogï¼Œé¿å…åŒä¸€ä¼šè¯ä¸­é‡å¤å¼¹å‡ºç›¸åŒçš„æ¢å¤å¯¹è¯æ¡†
}
```

#### 2.3 æ™ºèƒ½æ£€æŸ¥é€»è¾‘
æ·»åŠ æ›´æ™ºèƒ½çš„æ£€æŸ¥é€»è¾‘ï¼Œé¿å…ä¸å¿…è¦çš„å¼¹çª—ï¼š

```kotlin
private fun checkAndPromptForSavedCards() {
    // åªåœ¨æœç´¢tabä¸­æ˜¾ç¤ºæ¢å¤æç¤º
    if (currentState != UIState.BROWSER) {
        return
    }
    
    // æ£€æŸ¥æ—¶é—´é—´éš”
    val currentTime = System.currentTimeMillis()
    if (currentTime - lastRestoreCheckTime < RESTORE_CHECK_INTERVAL) {
        return
    }
    
    // æ£€æŸ¥å½“å‰æ˜¯å¦å·²æœ‰å¡ç‰‡ï¼Œå¦‚æœæœ‰åˆ™ä¸æ˜¾ç¤ºæ¢å¤å¯¹è¯æ¡†
    val currentCards = getAllUnifiedCards()
    if (currentCards.isNotEmpty()) {
        Log.d(TAG, "å½“å‰å·²æœ‰ ${currentCards.size} ä¸ªå¡ç‰‡ï¼Œè·³è¿‡æ¢å¤æç¤º")
        return
    }
    
    // æ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„å¡ç‰‡
    val sharedPreferences = getSharedPreferences("gesture_cards_state", Context.MODE_PRIVATE)
    val savedUrls = sharedPreferences.getStringSet("floating_card_urls", emptySet()) ?: emptySet()
    
    if (savedUrls.isNotEmpty()) {
        // æ›´æ–°æ£€æŸ¥æ—¶é—´
        lastRestoreCheckTime = currentTime
        
        // æ˜¾ç¤ºæ¢å¤å¯¹è¯æ¡†
        // ...
    }
}
```

---

## âœ… ä¿®å¤æ•ˆæœ

### ä¸‰ä¸ªå¡ç‰‡ç³»ç»Ÿæ•°æ®ç»Ÿä¸€
- âœ… **ç»Ÿä¸€æ•°æ®æº**ï¼šæ‰€æœ‰ä¸‰ä¸ªå¡ç‰‡ç³»ç»Ÿéƒ½ä½¿ç”¨`getAllUnifiedCards()`
- âœ… **å¼ºåˆ¶åŒæ­¥**ï¼šæ¯æ¬¡æ¿€æ´»å‰å¼ºåˆ¶åŒæ­¥æœ€æ–°æ•°æ®
- âœ… **è¯¦ç»†æ—¥å¿—**ï¼šå®Œæ•´çš„è°ƒè¯•ä¿¡æ¯ï¼Œä¾¿äºé—®é¢˜å®šä½
- âœ… **æ™ºèƒ½åˆ‡æ¢**ï¼šæ”¯æŒä¸¤ç§ç®¡ç†å™¨çš„å¡ç‰‡åˆ‡æ¢

### æ¢å¤çª—å£æœºåˆ¶
- âœ… **æ—¶é—´é—´éš”æ§åˆ¶**ï¼šé¿å…çŸ­æ—¶é—´å†…é‡å¤å¼¹å‡º
- âœ… **æ™ºèƒ½æ£€æŸ¥**ï¼šåªåœ¨æ²¡æœ‰å½“å‰å¡ç‰‡æ—¶æ‰æ˜¾ç¤ºæ¢å¤å¯¹è¯æ¡†
- âœ… **çŠ¶æ€é‡ç½®**ï¼šåˆ‡æ¢tabåå…è®¸é‡æ–°æ£€æŸ¥
- âœ… **ç”¨æˆ·å‹å¥½**ï¼šé¿å…ä¸å¿…è¦çš„å¼¹çª—å¹²æ‰°

---

## ğŸ“‹ ç¼–è¯‘çŠ¶æ€

```
BUILD SUCCESSFUL in 4m 24s
21 actionable tasks: 4 executed, 4 from cache, 13 up-to-date
```

---

## ğŸ¯ æµ‹è¯•å»ºè®®

### ä¸‰ä¸ªå¡ç‰‡ç³»ç»Ÿæ•°æ®ç»Ÿä¸€æµ‹è¯•
1. åœ¨æœç´¢tabä¸­æ‰“å¼€å¤šä¸ªç½‘é¡µ
2. ä¾æ¬¡æµ‹è¯•ä¸‰ä¸ªå¡ç‰‡ç³»ç»Ÿï¼š
   - ç‚¹å‡»æœç´¢tabçš„"å¡ç‰‡é¢„è§ˆ"æŒ‰é’®
   - ç‚¹å‡»æœç´¢tabçš„å·¦ä¸Šè§’æŒ‰é’®
   - é•¿æŒ‰æœç´¢tabæ¿€æ´»å¤šå¡ç‰‡ç³»ç»Ÿ
3. éªŒè¯ä¸‰ä¸ªç³»ç»Ÿæ˜¾ç¤ºçš„å¡ç‰‡æ•°æ®å®Œå…¨ä¸€è‡´

### æ¢å¤çª—å£æœºåˆ¶æµ‹è¯•
1. åœ¨æœç´¢tabä¸­æ‰“å¼€å‡ ä¸ªç½‘é¡µï¼Œç„¶åé€€å‡ºåº”ç”¨
2. é‡æ–°æ‰“å¼€åº”ç”¨ï¼Œè¿›å…¥æœç´¢tabï¼Œæ£€æŸ¥æ˜¯å¦å¼¹å‡ºæ¢å¤å¯¹è¯æ¡†
3. åˆ‡æ¢åˆ°å…¶ä»–tabï¼Œå†å›åˆ°æœç´¢tabï¼Œæ£€æŸ¥æ˜¯å¦èƒ½é‡æ–°æ£€æŸ¥æ¢å¤
4. åœ¨å·²æœ‰å¡ç‰‡çš„æƒ…å†µä¸‹è¿›å…¥æœç´¢tabï¼ŒéªŒè¯ä¸ä¼šå¼¹å‡ºæ¢å¤å¯¹è¯æ¡†

ç°åœ¨ä¸‰ä¸ªå¡ç‰‡ç³»ç»Ÿçš„æ•°æ®å®Œå…¨ç»Ÿä¸€ï¼Œæ¢å¤æœºåˆ¶ä¹Ÿæ›´åŠ æ™ºèƒ½å’Œç”¨æˆ·å‹å¥½ï¼
