# 剪贴板监听问题诊断和修复指南

## 问题描述
1. **用户复制文本无法激活灵动岛** - 剪贴板监听功能不工作
2. **无法穿透屏幕下方** - 触摸事件无法穿透到下层应用

## 已实施的修复

### 1. 修复窗口穿透问题
**问题**: 窗口参数缺少 `FLAG_NOT_FOCUSABLE` 标志，导致无法穿透屏幕下方。

**修复**: 在所有窗口参数设置中添加了 `FLAG_NOT_FOCUSABLE` 标志：
```kotlin
windowParams.flags = WindowManager.LayoutParams.FLAG_LAYOUT_IN_SCREEN or
    WindowManager.LayoutParams.FLAG_LAYOUT_NO_LIMITS or
    WindowManager.LayoutParams.FLAG_HARDWARE_ACCELERATED or
    WindowManager.LayoutParams.FLAG_NOT_TOUCH_MODAL or
    WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE  // 新增：确保穿透性
```

### 2. 增强剪贴板监听调试
**问题**: 剪贴板内容可能被过滤器误过滤，缺少详细的调试信息。

**修复**: 
- 添加了详细的日志输出，显示每个验证步骤的结果
- 添加了调试模式 `DEBUG_MODE = true`，在调试模式下放宽过滤条件
- 增强了错误信息，便于定位问题

### 3. 创建测试工具
**新增**: `ClipboardTestActivity` - 专门用于测试剪贴板监听功能的调试界面。

## 诊断步骤

### 步骤1: 使用测试工具
1. 在Android Studio中运行应用
2. 通过以下方式启动测试界面：
   ```kotlin
   // 在任意Activity中添加测试按钮
   val intent = Intent(this, ClipboardTestActivity::class.java)
   startActivity(intent)
   ```
3. 或者通过adb命令启动：
   ```bash
   adb shell am start -n com.example.aifloatingball/.debug.ClipboardTestActivity
   ```

### 步骤2: 检查无障碍服务状态
1. 在测试界面中查看无障碍服务状态
2. 如果显示"❌ 无障碍服务未开启"，点击"开启无障碍服务"按钮
3. 在系统设置中找到本应用并开启无障碍服务

### 步骤3: 测试剪贴板监听
1. 点击"测试剪贴板监听"按钮，应用会自动复制一段测试文本
2. 观察测试界面的日志输出
3. 如果收到"📋 收到剪贴板广播"消息，说明监听正常工作

### 步骤4: 查看详细日志
使用以下命令查看详细的系统日志：
```bash
# 查看无障碍服务日志
adb logcat -s MyAccessibilityService

# 查看灵动岛服务日志
adb logcat -s DynamicIslandService

# 查看所有相关日志
adb logcat | grep -E "(MyAccessibilityService|DynamicIslandService|剪贴板|clipboard)"
```

## 常见问题和解决方案

### 问题1: 无障碍服务无法开启
**症状**: 在系统设置中找不到应用或无法开启
**解决方案**:
1. 检查 `AndroidManifest.xml` 中的无障碍服务配置
2. 确保应用已安装且有相应权限
3. 重启应用或重新安装

### 问题2: 剪贴板内容被过滤
**症状**: 复制文本但没有触发灵动岛展开
**解决方案**:
1. 查看日志中的过滤原因（❌ 标记的日志）
2. 临时启用调试模式（`DEBUG_MODE = true`）
3. 调整过滤条件或添加例外规则

### 问题3: 广播通信失败
**症状**: 无障碍服务检测到剪贴板变化但灵动岛不响应
**解决方案**:
1. 检查 `LocalBroadcastManager` 是否正确注册
2. 确认广播Action常量一致
3. 检查DynamicIslandService是否正在运行

### 问题4: 触摸穿透不工作
**症状**: 灵动岛遮挡下层应用的触摸事件
**解决方案**:
1. 确认窗口参数包含 `FLAG_NOT_FOCUSABLE`
2. 检查是否在搜索模式下（搜索模式需要接收触摸事件）
3. 验证窗口布局参数是否正确应用

## 调试技巧

### 1. 实时监控剪贴板
```bash
# 持续监控剪贴板相关日志
adb logcat | grep -i clipboard
```

### 2. 检查服务状态
```bash
# 查看正在运行的服务
adb shell dumpsys activity services | grep -E "(MyAccessibilityService|DynamicIslandService)"
```

### 3. 测试不同类型的文本
- 普通文本："Hello World"
- 中文文本："你好世界"
- 数字："123456"（应该被过滤）
- URL："https://example.com"（应该被过滤）
- 混合内容："Hello 123"

## 性能优化建议

1. **防抖时间调整**: 当前设置为1秒，可根据需要调整
2. **过滤条件优化**: 在正式版本中关闭调试模式，启用严格过滤
3. **内存管理**: 定期清理广播接收器和监听器
4. **电池优化**: 避免频繁的剪贴板检查

## 下一步行动

1. **立即测试**: 使用 `ClipboardTestActivity` 验证修复效果
2. **日志分析**: 收集详细日志以确定具体问题
3. **用户测试**: 在实际使用场景中测试功能
4. **性能监控**: 观察电池和内存使用情况
5. **代码优化**: 根据测试结果进一步优化代码
