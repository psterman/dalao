# 档案同步问题修复测试指南

## 问题描述
用户反馈的问题：
1. **设置中看不到AI助手tab和搜索tab新建的档案资料**
2. **在设置中新建档案会覆盖AI助手tab和搜索tab中的档案**

## 问题原因分析
经过检查发现，SettingsManager中存在两套档案管理方法：
1. **旧的方法**：`getAllPromptProfiles()` / `saveAllPromptProfiles()` - 有通知机制
2. **新的方法**：`getPromptProfiles()` / `savePromptProfiles()` - 缺少通知机制

**核心问题**：
- `savePromptProfiles()` 方法没有调用 `notifyListeners()`，导致档案变更通知机制失效
- `savePromptProfile()` 方法使用 `getAllPromptProfiles()` 而不是 `getPromptProfiles()`，导致数据不一致
- 不同界面使用不同的档案管理方法，造成数据不同步

## 修复内容

### 1. 统一档案管理方法
- 修复 `savePromptProfiles()` 方法，添加通知机制
- 修复 `savePromptProfile()` 方法，使用统一的 `getPromptProfiles()` 方法
- 修复 `deletePromptProfile()` 方法，使用统一的档案管理方法
- 修复 `getPromptProfile()` 方法，使用统一的档案管理方法

### 2. 修复通知机制
```kotlin
// 修复前
fun savePromptProfiles(profiles: List<PromptProfile>) {
    val json = gson.toJson(profiles)
    prefs.edit().putString(KEY_PROMPT_PROFILES, json).apply()
    // 缺少 notifyListeners(KEY_PROMPT_PROFILES, profiles)
}

// 修复后
fun savePromptProfiles(profiles: List<PromptProfile>) {
    val json = gson.toJson(profiles)
    prefs.edit().putString(KEY_PROMPT_PROFILES, json).apply()
    notifyListeners(KEY_PROMPT_PROFILES, profiles) // 添加通知机制
}
```

### 3. 统一数据源
```kotlin
// 修复前
fun savePromptProfile(profile: PromptProfile) {
    val profiles = getAllPromptProfiles() // 使用旧方法
    // ...
    saveAllPromptProfiles(profiles) // 使用旧方法
}

// 修复后
fun savePromptProfile(profile: PromptProfile) {
    val profiles = getPromptProfiles() // 使用新方法
    // ...
    savePromptProfiles(profiles) // 使用新方法
}
```

## 测试步骤

### 测试1：搜索tab新建档案同步测试
1. 进入搜索tab
2. 点击AI助手按钮
3. 点击"新建档案"按钮
4. 输入档案名称（如"搜索tab档案1"）
5. 点击"创建"按钮
6. **验证结果**：
   - 搜索tab显示"档案「搜索tab档案1」创建成功"
   - 切换到AI助手tab的基础信息，档案管理卡片显示"搜索tab档案1"
   - 进入应用设置的AI助手中心，档案列表中包含"搜索tab档案1"

### 测试2：AI助手tab新建档案同步测试
1. 进入AI助手tab
2. 切换到基础信息标签页
3. 点击"新建档案"按钮
4. 输入档案名称（如"AI助手tab档案1"）
5. 点击"创建"按钮
6. **验证结果**：
   - AI助手tab显示"档案「AI助手tab档案1」创建成功"
   - 切换到搜索tab，档案选择器中包含"AI助手tab档案1"
   - 进入应用设置的AI助手中心，档案列表中包含"AI助手tab档案1"

### 测试3：应用设置新建档案同步测试
1. 进入应用设置
2. 进入提示词管理 -> AI助手中心
3. 点击"+"按钮新建档案
4. 输入档案名称（如"设置档案1"）
5. 保存档案
6. **验证结果**：
   - 设置页面显示档案创建成功
   - 切换到搜索tab，档案选择器中包含"设置档案1"
   - 切换到AI助手tab的基础信息，档案管理卡片可以选择"设置档案1"

### 测试4：档案覆盖问题测试
1. 在搜索tab中新建档案（如"测试档案A"）
2. 在AI助手tab中新建档案（如"测试档案B"）
3. 在应用设置中新建档案（如"测试档案C"）
4. **验证结果**：
   - 所有三个界面都能看到所有档案
   - 没有档案被覆盖
   - 档案列表包含：测试档案A、测试档案B、测试档案C

### 测试5：档案编辑同步测试
1. 在AI助手tab的基础信息中编辑档案名称
2. 点击"保存档案"按钮
3. **验证结果**：
   - 切换到搜索tab，档案选择器中显示更新后的档案名称
   - 进入应用设置的AI助手中心，档案列表中显示更新后的档案名称

### 测试6：档案删除同步测试
1. 在应用设置的AI助手中心中删除一个档案
2. **验证结果**：
   - 切换到搜索tab，档案选择器中不再显示被删除的档案
   - 切换到AI助手tab的基础信息，档案选择器中不再显示被删除的档案

### 测试7：实时同步测试
1. 同时打开多个界面（通过不同方式）
2. 在任意一个界面进行档案操作
3. **验证结果**：
   - 其他界面立即显示变更
   - 无需手动刷新
   - 档案变更通知机制正常工作

### 测试8：应用重启后数据一致性测试
1. 在三个界面中分别进行档案操作
2. 关闭应用
3. 重新启动应用
4. **验证结果**：
   - 所有界面的档案数据完全一致
   - 没有档案丢失
   - 没有档案重复

## 预期结果

### 修复前的问题
- ❌ 设置中看不到AI助手tab和搜索tab新建的档案
- ❌ 在设置中新建档案会覆盖其他界面的档案
- ❌ 档案变更通知机制失效
- ❌ 不同界面使用不同的档案管理方法

### 修复后的改进
- ✅ 设置中可以看到所有界面新建的档案
- ✅ 在设置中新建档案不会覆盖其他界面的档案
- ✅ 档案变更通知机制正常工作
- ✅ 所有界面使用统一的档案管理方法
- ✅ 档案操作完全同步
- ✅ 数据一致性得到保证

## 技术细节

### 1. 统一的档案管理方法
- 所有界面都使用 `getPromptProfiles()` 和 `savePromptProfiles()` 方法
- 确保数据源的一致性
- 避免不同方法之间的数据冲突

### 2. 完善的通知机制
- `savePromptProfiles()` 方法调用 `notifyListeners()`
- 所有档案变更都会触发通知
- 确保UI实时更新

### 3. 数据一致性保证
- 统一的档案ID管理
- 统一的档案存储格式
- 统一的档案加载逻辑

## 测试完成标准

- [ ] 搜索tab新建档案同步到其他界面
- [ ] AI助手tab新建档案同步到其他界面
- [ ] 应用设置新建档案同步到其他界面
- [ ] 没有档案被覆盖
- [ ] 档案编辑操作同步
- [ ] 档案删除操作同步
- [ ] 实时同步机制正常工作
- [ ] 应用重启后数据一致性
- [ ] 档案变更通知机制正常
- [ ] 用户体验良好

通过以上测试，确保档案同步问题得到完全解决，用户可以在任意界面管理档案，所有操作都会正确同步到其他界面。


