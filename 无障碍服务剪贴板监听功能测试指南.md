# 无障碍服务剪贴板监听功能测试指南

## 功能概述

本次更新将剪贴板监听功能从WindowManager移至无障碍服务，实现更稳定和可靠的剪贴板监听，当用户复制文本时自动展开灵动岛。

## 主要更改

### 1. 移除DynamicIslandService中的剪贴板监听
- 移除了`initClipboardListener()`、`handleClipboardChange()`等方法
- 移除了相关的clipboardManager变量和监听器
- 改用广播接收器接收来自无障碍服务的通知

### 2. 增强MyAccessibilityService
- 添加了详细的剪贴板内容验证逻辑
- 实现防抖处理，避免频繁触发
- 过滤系统自动生成的内容
- 通过LocalBroadcastManager发送剪贴板变化事件

### 3. 权限管理界面更新
- 在权限管理中添加了无障碍服务权限项
- 提供一键跳转到无障碍设置页面
- 实时显示无障碍服务权限状态

## 测试步骤

### 步骤1：检查权限管理界面
1. 打开应用设置
2. 进入"权限管理"
3. 确认"无障碍服务权限"项已显示
4. 点击该项应该跳转到系统无障碍设置页面

### 步骤2：开启无障碍服务
1. 在系统无障碍设置中找到本应用
2. 开启无障碍服务
3. 返回权限管理页面，确认状态显示为"✓ 已授权"

### 步骤3：测试剪贴板监听功能
1. 确保灵动岛服务正在运行
2. 在任意应用中复制一段文本（如浏览器中的文字）
3. 观察灵动岛是否自动展开并显示相关内容

### 步骤4：测试内容过滤
1. 复制纯数字（如验证码）- 应该被过滤，不触发展开
2. 复制URL链接 - 应该被过滤，不触发展开
3. 复制正常文本内容 - 应该触发展开
4. 快速连续复制 - 应该有防抖处理，不会频繁触发

## 预期行为

### 正常情况
- 复制有效文本内容时，灵动岛自动展开
- 显示最近使用的应用图标列表
- 5秒后自动缩小为球状

### 过滤情况
- 纯数字内容（验证码等）不触发
- URL链接不触发
- 系统自动生成的内容不触发
- 过短或过长的内容不触发

## 故障排除

### 如果剪贴板监听不工作
1. 检查无障碍服务是否已开启
2. 检查应用是否有无障碍权限
3. 查看日志中是否有相关错误信息
4. 重启应用或重新开启无障碍服务

### 如果频繁触发
1. 检查防抖时间设置（当前为1秒）
2. 检查内容过滤逻辑是否正常工作
3. 查看日志确认触发原因

## 技术细节

### 广播通信
- Action: `com.example.aifloatingball.ACTION_CLIPBOARD_CHANGED`
- Extra: `clipboard_content` - 剪贴板内容

### 内容验证规则
- 最小长度：2个字符
- 最大长度：500个字符
- 过滤纯数字、纯符号
- 过滤URL、文件路径、包名等系统内容
- 过滤特殊字符比例过高的内容

### 防抖机制
- 时间间隔：1000ms
- 避免快速连续的剪贴板变化触发多次展开

## 日志标签
- `MyAccessibilityService` - 无障碍服务相关日志
- `DynamicIslandService` - 灵动岛服务相关日志
- 关键词：`剪贴板`、`clipboard`、`广播`、`broadcast`
