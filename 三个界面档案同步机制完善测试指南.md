# 三个界面档案同步机制完善测试指南

## 功能概述
本次更新完善了三个界面的档案同步机制，确保用户可以在任意一个界面都能管理档案，所有档案操作都会实时同步到其他界面。

## 三个界面档案管理功能

### 1. 搜索tab中的输入框按钮弹出界面
- **位置**: 搜索tab的AI助手按钮
- **功能**: 档案选择、新建、管理
- **实现**: `showBrowserTabAIProfileSelector()` 方法
- **同步机制**: ✅ 已实现

### 2. AI助手tab中的基础信息部分
- **位置**: AI助手tab的基础信息标签页
- **功能**: 档案选择、新建、管理、编辑、保存
- **实现**: `BasicInfoFragment` 类
- **同步机制**: ✅ 已实现

### 3. 应用设置中的提示词管理中的AI助手中心
- **位置**: 设置页面的提示词管理
- **功能**: 完整的档案管理功能
- **实现**: `MasterPromptSettingsActivity` 和 `MasterPromptFragment`
- **同步机制**: ✅ 已实现

## 技术实现细节

### 1. 统一的档案保存机制
所有三个界面都使用 `settingsManager.savePromptProfile()` 方法：
```kotlin
// 统一的档案保存方法
settingsManager.savePromptProfile(profile)
```

### 2. 档案变更通知机制
所有三个界面都注册了档案变更监听器：
```kotlin
settingsManager.registerOnSettingChangeListener<List<PromptProfile>>("prompt_profiles") { key, value ->
    // 在主线程中刷新UI
    runOnUiThread {
        loadProfiles() // 或 loadCurrentProfile()
    }
}
```

### 3. AI助手tab新增功能
- **档案管理卡片**: 显示当前档案名称
- **选择档案按钮**: 弹出档案选择对话框
- **新建档案按钮**: 创建新档案
- **管理档案按钮**: 跳转到档案管理页面
- **保存档案按钮**: 保存当前编辑的档案

## 测试步骤

### 测试1：搜索tab档案管理功能
1. 进入搜索tab
2. 点击AI助手按钮
3. **验证功能**:
   - 档案选择器正常显示
   - 可以新建档案
   - 可以管理档案
   - 档案切换正常

### 测试2：AI助手tab档案管理功能
1. 进入AI助手tab
2. 切换到基础信息标签页
3. **验证功能**:
   - 档案管理卡片显示当前档案
   - 选择档案按钮正常工作
   - 新建档案按钮正常工作
   - 管理档案按钮正常工作
   - 保存档案按钮正常工作

### 测试3：应用设置档案管理功能
1. 进入设置页面
2. 进入提示词管理 -> AI助手中心
3. **验证功能**:
   - 档案列表正常显示
   - 可以新建、编辑、删除档案
   - 档案管理功能完整

### 测试4：三界面同步测试

#### 4.1 搜索tab新建档案同步测试
1. 在搜索tab中新建档案（如"测试档案1"）
2. 切换到AI助手tab的基础信息
3. **预期结果**: 档案管理卡片显示"测试档案1"
4. 进入应用设置的AI助手中心
5. **预期结果**: 档案列表中包含"测试档案1"

#### 4.2 AI助手tab新建档案同步测试
1. 在AI助手tab的基础信息中新建档案（如"测试档案2"）
2. 切换到搜索tab
3. **预期结果**: 档案选择器中包含"测试档案2"
4. 进入应用设置的AI助手中心
5. **预期结果**: 档案列表中包含"测试档案2"

#### 4.3 应用设置新建档案同步测试
1. 在应用设置的AI助手中心中新建档案（如"测试档案3"）
2. 切换到搜索tab
3. **预期结果**: 档案选择器中包含"测试档案3"
4. 切换到AI助手tab的基础信息
5. **预期结果**: 档案管理卡片可以选择"测试档案3"

#### 4.4 档案编辑同步测试
1. 在AI助手tab的基础信息中编辑档案名称
2. 点击保存档案按钮
3. 切换到搜索tab
4. **预期结果**: 档案选择器中显示更新后的档案名称
5. 进入应用设置的AI助手中心
6. **预期结果**: 档案列表中显示更新后的档案名称

#### 4.5 档案删除同步测试
1. 在应用设置的AI助手中心中删除一个档案
2. 切换到搜索tab
3. **预期结果**: 档案选择器中不再显示被删除的档案
4. 切换到AI助手tab的基础信息
5. **预期结果**: 档案选择器中不再显示被删除的档案

### 测试5：实时同步测试
1. 同时打开多个界面（通过不同方式）
2. 在任意一个界面进行档案操作
3. **预期结果**: 其他界面立即显示变更，无需手动刷新

### 测试6：应用重启后数据一致性测试
1. 在三个界面中分别进行档案操作
2. 关闭应用
3. 重新启动应用
4. **预期结果**: 所有界面的档案数据完全一致

## 预期结果总结

### 修复前的问题
- ❌ AI助手tab只有保存功能，没有档案选择、新建、管理功能
- ❌ 三个界面的档案操作不同步
- ❌ 用户需要在不同界面重复操作

### 修复后的改进
- ✅ AI助手tab具备完整的档案管理功能
- ✅ 三个界面的档案操作完全同步
- ✅ 用户可以在任意界面管理档案
- ✅ 所有档案操作都使用统一的保存机制
- ✅ 所有界面都注册了档案变更监听器
- ✅ 档案变更实时同步，无需手动刷新

## 技术架构

### 1. 数据层
- **SettingsManager**: 统一的数据管理和通知机制
- **PromptProfile**: 档案数据模型
- **SharedPreferences**: 数据持久化

### 2. 业务层
- **档案保存**: `savePromptProfile()` 方法
- **档案加载**: `getPromptProfiles()` 方法
- **档案切换**: `setActivePromptProfileId()` 方法

### 3. 表现层
- **搜索tab**: `showBrowserTabAIProfileSelector()`
- **AI助手tab**: `BasicInfoFragment`
- **应用设置**: `MasterPromptSettingsActivity` + `MasterPromptFragment`

### 4. 同步机制
- **通知机制**: `registerOnSettingChangeListener()`
- **UI更新**: 在主线程中刷新界面
- **数据一致性**: 统一的保存和加载方法

## 测试完成标准

- [ ] 搜索tab档案管理功能正常
- [ ] AI助手tab档案管理功能正常
- [ ] 应用设置档案管理功能正常
- [ ] 三个界面档案操作完全同步
- [ ] 档案新建、编辑、删除操作同步
- [ ] 实时同步机制正常工作
- [ ] 应用重启后数据一致性
- [ ] 错误处理机制完善
- [ ] 用户体验良好，无卡顿现象

通过以上测试，确保三个界面的档案同步机制得到完美实现，用户可以在任意界面管理档案，所有操作都会实时同步到其他界面。


