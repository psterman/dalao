# AI指令档案同步机制测试指南

## 修复内容概述
本次修复解决了AI指令档案在修改、新增、删减时与设置中档案管理的通信同步问题：

### 1. 主要修复内容
- **统一保存方法**：确保所有档案操作都使用正确的保存方法触发通知机制
- **添加监听器**：在SimpleModeActivity和DynamicIslandService中添加档案变更监听器
- **同步通知机制**：利用SettingsManager的通知机制实现各界面间的数据同步

### 2. 技术实现
- 修改MasterPromptSettingsActivity中的保存、新增、删除方法，使用`savePromptProfile`和`saveAllPromptProfiles`方法
- 在SimpleModeActivity和DynamicIslandService中注册档案变更监听器
- 确保所有档案操作都通过SettingsManager的通知机制进行同步

## 测试步骤

### 1. 档案管理页面操作测试

#### 1.1 测试新增档案
1. 启动应用
2. 进入搜索tab
3. 点击AI助手按钮，选择"管理档案"
4. 在档案管理页面点击"+"按钮新增档案
5. 输入档案名称并保存
6. **预期结果**：
   - 档案管理页面显示新档案
   - 返回档案选择器时能看到新档案
   - 新档案可以正常选择和使用

#### 1.2 测试修改档案
1. 在档案管理页面选择一个档案
2. 修改档案的各种配置（基础信息、扩展配置、AI行为、个性化等）
3. 点击保存按钮
4. **预期结果**：
   - 档案管理页面显示修改后的配置
   - 返回档案选择器时能看到更新后的档案信息
   - 选择该档案时应用的是修改后的配置

#### 1.3 测试删除档案
1. 在档案管理页面选择一个非默认档案
2. 点击删除按钮
3. 确认删除
4. **预期结果**：
   - 档案管理页面不再显示该档案
   - 返回档案选择器时该档案已消失
   - 如果删除的是当前活跃档案，会自动切换到其他档案

### 2. 档案选择器操作测试

#### 2.1 测试新建档案
1. 在档案选择器中点击"新建档案"按钮
2. 输入档案名称并创建
3. **预期结果**：
   - 档案选择器自动刷新显示新档案
   - 新档案自动被设置为当前活跃档案
   - 档案管理页面也能看到新档案

#### 2.2 测试档案选择
1. 在档案选择器中选择不同档案
2. 点击确认按钮
3. **预期结果**：
   - 档案切换成功
   - 生成相应的提示词
   - 档案管理页面中的活跃档案状态同步更新

### 3. 跨界面同步测试

#### 3.1 测试档案管理页面到档案选择器的同步
1. 在档案管理页面新增一个档案
2. 返回档案选择器
3. **预期结果**：
   - 档案选择器立即显示新档案
   - 不需要重新打开应用或刷新界面

#### 3.2 测试档案选择器到档案管理页面的同步
1. 在档案选择器中新建一个档案
2. 点击"管理档案"按钮进入档案管理页面
3. **预期结果**：
   - 档案管理页面显示新创建的档案
   - 档案列表是最新的

#### 3.3 测试多界面同时操作
1. 同时打开档案管理页面和档案选择器（通过不同方式）
2. 在档案管理页面修改档案
3. **预期结果**：
   - 档案选择器中的档案信息自动更新
   - 两个界面的数据保持同步

### 4. 数据持久化测试

#### 4.1 测试应用重启后的数据一致性
1. 在档案管理页面创建、修改、删除档案
2. 关闭应用
3. 重新启动应用
4. **预期结果**：
   - 所有档案操作的结果都正确保存
   - 档案管理页面和档案选择器显示一致的数据

#### 4.2 测试不同服务间的数据同步
1. 在DynamicIslandService中新建档案
2. 在SimpleModeActivity中查看档案列表
3. **预期结果**：
   - 两个服务中的档案数据完全一致
   - 档案变更实时同步

### 5. 错误处理测试

#### 5.1 测试网络异常情况
1. 断开网络连接
2. 进行档案操作
3. **预期结果**：
   - 本地操作正常进行
   - 数据正确保存到本地存储

#### 5.2 测试存储异常情况
1. 模拟存储空间不足
2. 尝试保存档案
3. **预期结果**：
   - 显示适当的错误提示
   - 不会导致应用崩溃

## 预期结果总结

### 修复前的问题
- 档案管理页面的操作不会同步到档案选择器
- 档案选择器的新建档案不会同步到档案管理页面
- 不同界面间的档案数据不一致
- 需要手动刷新才能看到最新数据

### 修复后的改进
- ✅ 所有档案操作都通过统一的通知机制同步
- ✅ 档案管理页面和档案选择器数据实时同步
- ✅ 新建、修改、删除档案后各界面立即更新
- ✅ 跨服务间的档案数据保持一致
- ✅ 数据持久化正确工作

## 技术细节

### 1. 通知机制
- 使用SettingsManager的`registerOnSettingChangeListener`注册监听器
- 监听`prompt_profiles`键的变化
- 档案变更时自动触发`notifyListeners`方法

### 2. 保存方法统一
- 新增档案：使用`savePromptProfile`方法
- 修改档案：使用`savePromptProfile`方法
- 删除档案：使用`saveAllPromptProfiles`方法
- 所有方法都会触发通知机制

### 3. 监听器注册
- SimpleModeActivity在onCreate中注册监听器
- DynamicIslandService在onCreate中注册监听器
- 监听器会在档案变更时自动刷新相关界面

## 测试完成标准

- [ ] 档案管理页面的所有操作都能同步到档案选择器
- [ ] 档案选择器的操作都能同步到档案管理页面
- [ ] 跨界面操作时数据实时同步
- [ ] 应用重启后数据一致性正确
- [ ] 不同服务间的数据完全同步
- [ ] 错误处理机制完善
- [ ] 性能表现良好，无卡顿现象

通过以上测试，确保AI指令档案的同步机制完全正常工作，各界面间的数据始终保持一致。


