# 滑动冲突解决方案使用指南

## 🚀 快速开始

### 1. 基本集成

在您的Activity中添加触摸冲突解决器：

```kotlin
class YourActivity : AppCompatActivity() {
    private var touchConflictResolver: TouchConflictResolver? = null
    
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        
        // 初始化触摸冲突解决器
        touchConflictResolver = TouchConflictResolver(this)
    }
}
```

### 2. WebView集成

为您的WebView添加增强的触摸处理：

```kotlin
// 在WebView创建时
val webView = WebView(context)
val touchHandler = EnhancedWebViewTouchHandler(context, webView, viewPager)
touchHandler.setupWebViewTouchHandling()
```

### 3. ViewPager2配置

确保ViewPager2正确配置：

```kotlin
viewPager.apply {
    // 启用用户输入，通过智能处理器管理冲突
    isUserInputEnabled = true
    
    // 其他配置
    offscreenPageLimit = 2
}
```

## 🎯 核心功能

### 滑动方向检测

系统会自动检测用户的滑动方向：

- **垂直滑动** (角度 > 60°) → WebView处理页面滚动
- **水平滑动** (角度 < 30°) → ViewPager2处理tab切换  
- **对角线滑动** → 优先WebView处理

### 多指操作支持

- **双指缩放** → 自动禁用ViewPager2
- **双指滑动** → WebView处理
- **三指手势** → 可自定义处理

### 实时状态管理

```kotlin
// 垂直滑动时的状态
viewPager.isUserInputEnabled = false
parent?.requestDisallowInterceptTouchEvent(true)

// 水平滑动时的状态  
viewPager.isUserInputEnabled = true
parent?.requestDisallowInterceptTouchEvent(false)
```

## 🔧 高级配置

### 自定义阈值

您可以调整检测阈值以适应不同的使用场景：

```kotlin
// 在TouchConflictResolver中
companion object {
    private const val MIN_DISTANCE = 30f      // 最小滑动距离
    private const val ANGLE_THRESHOLD = 30f   // 角度阈值
    private const val VELOCITY_THRESHOLD = 500f // 速度阈值
}
```

### 自定义手势监听

```kotlin
val gestureManager = MobileGestureManager(context, targetView)
gestureManager.setGestureListener(object : MobileGestureManager.MobileGestureListener {
    override fun onSwipeLeft() {
        // 处理左滑
    }
    
    override fun onSwipeRight() {
        // 处理右滑
    }
    
    override fun onSwipeUp() {
        // 处理上滑
    }
    
    override fun onSwipeDown() {
        // 处理下滑
    }
})
```

## 📊 性能优化

### 内存管理

```kotlin
override fun onDestroy() {
    super.onDestroy()
    
    // 清理资源
    touchHandler?.reset()
    gestureManager?.cleanup()
}
```

### 响应速度优化

- 触摸事件处理在16ms内完成
- 避免在主线程进行复杂计算
- 合理设置触摸阈值

## 🐛 常见问题

### Q: 滑动方向判断不准确？
A: 调整`ANGLE_THRESHOLD`和`MIN_DISTANCE`参数

### Q: 双指缩放时仍然切换tab？
A: 检查`EnhancedWebViewTouchHandler`是否正确设置

### Q: 页面滚动不流畅？
A: 确保垂直滑动时`requestDisallowInterceptTouchEvent(true)`被调用

### Q: 内存泄漏？
A: 确保在Activity销毁时调用`cleanup()`方法

## 🧪 测试验证

### 基础测试
```bash
# 运行单元测试
./gradlew test

# 运行特定测试
./gradlew test --tests TouchConflictResolverTest
```

### 手动测试清单

- [ ] 垂直滑动WebView页面流畅
- [ ] 水平滑动正常切换tab
- [ ] 双指缩放不触发tab切换
- [ ] 快速滑动方向判断准确
- [ ] 边界情况处理正确

## 📈 监控和分析

### 添加日志监控

```kotlin
// 启用详细日志
Log.d("TouchConflict", "滑动方向: $direction, 角度: $angle")
```

### 性能监控

```kotlin
// 监控触摸事件处理时间
val startTime = System.currentTimeMillis()
val result = resolver.analyzeTouchEvent(event)
val duration = System.currentTimeMillis() - startTime
Log.d("Performance", "触摸处理耗时: ${duration}ms")
```

这个解决方案为您的应用提供了智能的滑动冲突处理，确保用户获得流畅的交互体验！
