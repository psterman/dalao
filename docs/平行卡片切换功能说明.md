# 平行卡片切换功能说明

## 🎯 功能概述

全新的平行卡片切换功能，类似手机多任务管理器的交互体验：
- **长按激活** → 多张卡片按比例平行显示
- **继续长按左右滑动** → 可以切换卡片顺序
- **停下来在中间显示的卡片** → 就是当前选中的卡片

## 🚀 激活和使用方法

### 激活方式
1. 切换到搜索tab（底部导航栏第二个图标）
2. **长按搜索tab图标** 或 **长按底部导航栏**
3. 系统显示所有网页卡片的平行排列

### 交互操作
1. **查看卡片**：所有卡片平行显示，可以看到每张卡片的内容
2. **左右滑动**：继续长按并左右滑动来切换卡片顺序
3. **选择卡片**：停止滑动，中间显示的卡片就是当前选中的
4. **确认选择**：松开手指选择当前中心卡片

## 🎨 视觉设计

### 卡片布局
- **卡片大小**：屏幕宽度70%，高度60%
- **排列方式**：水平平行排列，有20%重叠
- **间距计算**：卡片间距为卡片宽度的80%

### 视觉效果
- **中心卡片**：最大尺寸（缩放1.0），最高透明度（1.0）
- **边缘卡片**：逐渐缩小（最小0.7），透明度降低（最低0.5）
- **平滑过渡**：滑动时所有卡片平滑缩放和透明度变化

### 交互反馈
- **中心指示器**：屏幕中央有白色指示线，标明中心位置
- **实时缩放**：滑动时卡片实时缩放和透明度变化
- **对齐动画**：松手后自动对齐到最近的卡片（200ms动画）

## 🎮 详细交互流程

### 阶段1：激活平行显示
```
长按搜索tab → 检查卡片数量 → 显示平行排列
```
- 所有webview卡片水平平行排列
- 第一张卡片默认在中心位置
- 显示中心指示器

### 阶段2：滑动切换卡片
```
继续长按 + 左右滑动 → 实时切换中心卡片
```
- **向左滑动**：下一张卡片移到中心
- **向右滑动**：上一张卡片移到中心
- **实时反馈**：滑动过程中实时更新缩放和透明度
- **灵敏度控制**：滑动灵敏度为50%，避免过于敏感

### 阶段3：选择确认
```
停止滑动 → 自动对齐 → 松手选择
```
- **自动对齐**：停止滑动后自动对齐到最近的卡片
- **松手选择**：松开手指选择当前中心卡片
- **切换网页**：自动切换到选中的网页并隐藏预览

## 🔧 技术实现

### 核心算法
```kotlin
// 计算卡片位置
val cardCenterX = startX + i * cardSpacing
val startX = centerX - scrollOffset

// 计算缩放和透明度
val distanceFromCenter = abs(cardCenterX - centerX)
val normalizedDistance = (distanceFromCenter / maxDistance).coerceIn(0f, 1f)
val scale = 1.0f - normalizedDistance * 0.3f // 0.7 到 1.0
val alpha = 1.0f - normalizedDistance * 0.5f // 0.5 到 1.0
```

### 滑动处理
```kotlin
// 更新滚动偏移
scrollOffset -= deltaX * 0.5f // 减少灵敏度

// 限制滚动范围
val maxOffset = (webViewCards.size - 1) * cardSpacing
scrollOffset = scrollOffset.coerceIn(0f, maxOffset)

// 计算当前中心卡片
val newCardIndex = (scrollOffset / cardSpacing + 0.5f).toInt()
```

### 对齐动画
```kotlin
private fun snapToNearestCard() {
    val targetOffset = currentCardIndex * cardSpacing
    
    ValueAnimator.ofFloat(scrollOffset, targetOffset).apply {
        duration = 200
        addUpdateListener { animator ->
            scrollOffset = animator.animatedValue as Float
            invalidate()
        }
        start()
    }
}
```

## 📱 使用场景

### 适用情况
- 打开了多个网页标签
- 需要快速预览和切换网页
- 想要直观地选择特定网页

### 最佳体验
1. **先打开多个网页**：确保有3-5个网页卡片
2. **长按激活**：在搜索tab中长按激活功能
3. **滑动预览**：左右滑动查看所有网页
4. **精确选择**：将想要的网页移到中心位置
5. **确认选择**：松手选择中心网页

## 🎯 与传统层叠模式的区别

### 传统层叠模式
- ❌ 卡片重叠，只能看到最上面的卡片
- ❌ 需要悬停才能看到其他卡片
- ❌ 交互复杂，需要多个步骤

### 新平行模式
- ✅ 所有卡片平行显示，都能看到
- ✅ 直观的左右滑动切换
- ✅ 简单的交互：滑动 → 选择 → 确认

## 🧪 测试方法

### 基础测试
1. **切换到搜索tab**
2. **长按底部导航栏**（调试模式）
3. **观察效果**：
   - 应该看到多张卡片平行排列
   - 中间的卡片最大最亮
   - 边缘的卡片较小较暗

### 交互测试
1. **长按并左右滑动**
2. **观察变化**：
   - 卡片位置实时移动
   - 中心卡片实时变化
   - 缩放和透明度平滑过渡

### 选择测试
1. **滑动到想要的卡片**
2. **松开手指**
3. **验证结果**：
   - 自动对齐到最近卡片
   - 切换到选中的网页
   - 预览界面消失

## 📋 调试信息

### 关键日志
```
StackedCardPreview: 平行模式初始化: 卡片宽度=756.0, 间距=604.8, 卡片数=3
StackedCardPreview: 开始拖拽滑动
StackedCardPreview: 切换到卡片: 1
StackedCardPreview: 对齐到卡片 1，目标偏移: 604.8
StackedCardPreview: 选择卡片: 1
```

### 状态监控
- `currentCardIndex`: 当前中心卡片索引
- `scrollOffset`: 当前滚动偏移量
- `cardSpacing`: 卡片间距
- `isDragging`: 是否正在拖拽

这个新的平行卡片切换功能提供了更直观、更流畅的多任务管理体验，让用户可以轻松预览和选择任意网页！
