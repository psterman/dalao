# 搜索Tab长按激活层叠卡片功能说明

## 🎯 功能概述

在搜索tab中长按可以激活层叠卡片预览功能，提供现代化的多任务管理体验，类似于手机的多任务切换界面。

## 🚀 激活方式

### 方法1：长按搜索Tab
1. 切换到搜索tab（底部导航栏第二个图标）
2. **长按搜索tab图标**
3. 系统会检查是否有打开的网页卡片
4. 如果有卡片，自动激活层叠预览模式

### 方法2：调试测试（开发用）
1. 切换到搜索tab
2. **长按底部导航栏**（任意位置）
3. 触发测试功能

## 📱 交互流程

### 第一阶段：层叠预览模式
```
长按搜索tab → 显示所有网页卡片的智能层叠布局
```

**特点：**
- 所有webview卡片以层叠方式显示
- 卡片大小为屏幕的50%
- 智能偏移布局，减少遮挡
- 支持实时悬停交互

**操作：**
- **手指移动**：悬停在某张卡片上
- **悬停效果**：右边的卡片会智能推开80px，只遮挡边缘
- **突出显示**：悬停的卡片会放大并减少偏移

### 第二阶段：悬浮交互模式
```
手指离开屏幕 → 进入悬浮模式（单卡片全屏显示）
```

**特点：**
- 单张卡片全屏显示
- 显示网页标题和截图
- 底部圆点指示器显示当前位置
- 支持完整的手势操作

## 🎮 悬浮模式手势操作

### 1. 左右滑动 - 切换卡片
- **向左滑动**：切换到下一张卡片
- **向右滑动**：切换到上一张卡片
- **循环切换**：最后一张切换到第一张，第一张切换到最后一张
- **视觉反馈**：底部指示器实时更新

### 2. 向上滑动 - 关闭卡片
- **手势**：向上滑动超过150px
- **动画效果**：
  - 卡片向上飞出
  - 缩放从1.0到0.7
  - 透明度从1.0到0.0
  - 动画时长300ms
- **结果**：卡片被永久关闭，从WebView管理器中移除

### 3. 点击卡片 - 选择并退出
- **操作**：轻点当前显示的卡片
- **结果**：
  - 切换到选中的网页
  - 退出悬浮模式
  - 返回正常浏览状态

### 4. 其他拖拽 - 平滑回弹
- **触发**：垂直拖拽距离不足以关闭卡片
- **效果**：卡片平滑回弹到原位置
- **动画时长**：250ms

## 🎨 视觉设计

### 层叠模式布局
- **基础偏移**：水平15px，垂直8px
- **卡片旋转**：±2度轻微旋转
- **智能推开**：悬停时右边卡片推开80px
- **透明度**：悬停卡片1.0，其他0.85

### 悬浮模式显示
- **卡片大小**：屏幕宽高的50%
- **居中显示**：屏幕中央
- **标题显示**：底部居中，最多12字符
- **指示器**：底部圆点，当前卡片高亮

### 动画效果
- **切换动画**：无缝过渡，重置拖拽偏移
- **关闭动画**：向上飞出 + 缩放 + 透明度
- **回弹动画**：平滑回到原位置
- **所有动画**：使用硬件加速，流畅60fps

## 🔧 技术实现

### 长按检测
```kotlin
findViewById<LinearLayout>(R.id.tab_search)?.apply {
    setOnLongClickListener {
        activateStackedCardPreview()
        true
    }
}
```

### 触摸事件处理
```kotlin
browserWebViewContainer.setOnTouchListener { _, event ->
    val isStackedPreviewVisible = stackedCardPreview?.visibility == View.VISIBLE
    
    if (isStackedPreviewVisible) {
        handleStackedCardPreviewTouch(event)
    } else {
        browserGestureDetector.onTouchEvent(event)
    }
    false
}
```

### 坐标转换
```kotlin
private fun handleStackedCardPreviewTouch(event: MotionEvent) {
    // 获取容器和预览器的屏幕坐标
    val location = IntArray(2)
    browserWebViewContainer.getLocationOnScreen(location)
    val previewLocation = IntArray(2)
    preview.getLocationOnScreen(previewLocation)

    // 计算相对坐标
    val relativeX = location[0] - previewLocation[0] + event.x
    val relativeY = location[1] - previewLocation[1] + event.y
    
    // 传递给预览器处理
    preview.updateFingerPosition(relativeX, relativeY)
}
```

## 📋 使用场景

### 适用情况
- 打开了多个网页标签
- 需要快速切换和管理网页
- 想要关闭不需要的网页
- 需要预览网页内容

### 最佳实践
1. **先打开网页**：确保有多个网页卡片可供切换
2. **长按激活**：在搜索tab中长按激活功能
3. **悬停预览**：用手指移动来预览不同卡片
4. **进入悬浮**：手指离开屏幕进入详细操作模式
5. **手势操作**：使用各种手势进行卡片管理

## 🐛 故障排除

### 长按无反应
- 确保当前在搜索tab
- 确保已经打开了网页卡片
- 检查是否有其他手势冲突

### 触摸不响应
- 确保手指在WebView容器区域内
- 避免在抽屉打开时操作
- 重启应用重新初始化

### 动画卡顿
- 检查设备性能
- 关闭其他占用资源的应用
- 确保硬件加速已启用

## 🔄 更新日志

### v1.0.0
- ✅ 实现搜索tab长按激活
- ✅ 智能层叠布局显示
- ✅ 悬停交互优化
- ✅ 悬浮模式完整手势支持
- ✅ 向上滑动关闭动画
- ✅ 左右滑动切换卡片
- ✅ 点击选择并退出
- ✅ 平滑回弹效果
- ✅ 底部指示器显示
- ✅ 卡片标题显示

这个功能为用户提供了现代化的多任务管理体验，让网页切换变得更加直观和高效！
