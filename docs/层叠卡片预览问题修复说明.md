# 层叠卡片预览问题修复说明

## 🐛 问题描述

**问题**：长按搜索tab只能看到一张悬浮卡片，看不到所有的后台卡片

**期望行为**：长按搜索tab后应该显示所有webview卡片的层叠预览，用户可以看到多张卡片层叠排列

**实际行为**：直接进入悬浮模式，只显示单张卡片

## 🔍 问题分析

### 根本原因
`activateStackedCardPreview()`方法在激活预览时没有正确重置为层叠模式，导致系统可能保持在悬浮模式状态。

### 问题定位
1. **状态管理问题**：`isFloatingMode`标志可能没有正确重置
2. **初始化顺序问题**：卡片数据更新和模式重置的顺序可能有问题
3. **绘制逻辑问题**：`onDraw`方法根据`isFloatingMode`决定绘制模式

## 🔧 修复方案

### 1. 添加`resetToStackedMode()`方法
```kotlin
fun resetToStackedMode() {
    Log.d("StackedCardPreview", "重置为层叠模式，当前状态: isFloatingMode=$isFloatingMode")
    
    // 重置所有状态
    isFloatingMode = false
    currentCardIndex = 0
    hoveredCardIndex = -1
    isDragging = false
    cardDragOffsetX = 0f
    cardDragOffsetY = 0f
    
    // 设置为不可交互（层叠模式下触摸事件穿透）
    isClickable = false
    isFocusable = false
    isEnabled = false
    
    // 重置动画状态
    scaleX = 1f
    scaleY = 1f
    alpha = 1f
    translationY = 0f
    
    Log.d("StackedCardPreview", "层叠模式重置完成，新状态: isFloatingMode=$isFloatingMode")
}
```

### 2. 修改激活方法
```kotlin
private fun activateStackedCardPreview() {
    stackedCardPreview?.apply {
        // 确保重置为层叠模式（不是悬浮模式）
        resetToStackedMode()
        
        // 更新卡片数据
        updateWaveTrackerCards()
        
        // 显示预览器
        visibility = View.VISIBLE
        
        Log.d(TAG, "层叠卡片预览已激活，显示 ${allCards.size} 张卡片")
    }
}
```

### 3. 添加调试日志
在关键方法中添加详细的调试日志：
- `onDraw()`: 显示当前模式和卡片数量
- `drawStackedCards()`: 确认层叠绘制被调用
- `setWebViewCards()`: 跟踪卡片数据设置过程
- `resetToStackedMode()`: 跟踪状态重置过程

### 4. 创建调试测试方法
```kotlin
private fun debugShowStackedCards() {
    // 如果没有真实卡片，创建测试卡片
    if (allCards.isEmpty()) {
        val testCards = listOf(
            WebViewCardData(title = "测试卡片1", url = "https://www.baidu.com"),
            WebViewCardData(title = "测试卡片2", url = "https://www.google.com"),
            WebViewCardData(title = "测试卡片3", url = "https://www.github.com")
        )
        
        stackedCardPreview?.apply {
            resetToStackedMode()
            setWebViewCards(testCards)
            visibility = View.VISIBLE
        }
    }
}
```

## 🧪 测试方法

### 方法1：长按搜索Tab测试
1. 切换到搜索tab
2. 长按搜索tab图标
3. 观察是否显示多张卡片的层叠预览

### 方法2：底部导航栏长按调试
1. 切换到搜索tab
2. **长按底部导航栏任意位置**
3. 触发调试方法，强制显示层叠预览
4. 如果没有真实卡片，会显示3张测试卡片

### 方法3：日志调试
查看Logcat中的调试信息：
```
StackedCardPreview: 重置为层叠模式，当前状态: isFloatingMode=false
StackedCardPreview: setWebViewCards: 设置 3 张卡片，当前模式: 层叠
StackedCardPreview: onDraw: 模式=层叠, 卡片数=3
StackedCardPreview: drawStackedCards: 开始绘制 3 张层叠卡片
```

## 📋 验证清单

### ✅ 功能验证
- [ ] 长按搜索tab能显示层叠预览
- [ ] 可以看到多张卡片层叠排列
- [ ] 手指移动时右边卡片智能推开
- [ ] 悬停卡片突出显示
- [ ] 手指抬起进入悬浮模式

### ✅ 状态验证
- [ ] `isFloatingMode`初始为false
- [ ] 层叠模式下触摸事件穿透
- [ ] 悬浮模式下触摸事件被处理
- [ ] 模式切换正确

### ✅ 视觉验证
- [ ] 卡片大小为屏幕50%
- [ ] 基础偏移：水平15px，垂直8px
- [ ] 悬停时右边卡片推开80px
- [ ] 透明度变化正确

## 🔄 修复后的完整流程

1. **激活**：长按搜索tab → `activateStackedCardPreview()`
2. **重置**：`resetToStackedMode()` → 确保层叠模式
3. **更新**：`updateWaveTrackerCards()` → 设置卡片数据
4. **显示**：`visibility = View.VISIBLE` → 显示预览器
5. **绘制**：`onDraw()` → 检查`isFloatingMode=false` → 调用`drawStackedCards()`
6. **交互**：手指移动 → 悬停检测 → 智能重排
7. **切换**：手指抬起 → `stopWave()` → `enterFloatingMode()`

## 🎯 预期结果

修复后，用户长按搜索tab应该能看到：
- **多张卡片**：所有打开的webview卡片都显示
- **层叠排列**：卡片按智能偏移算法排列
- **减少遮挡**：右边卡片不会完全遮挡中间卡片
- **交互反馈**：手指移动时实时响应
- **平滑过渡**：从层叠模式到悬浮模式的平滑切换

## 📝 注意事项

1. **测试环境**：确保在搜索tab中测试
2. **卡片数据**：如果没有真实网页，使用调试方法创建测试卡片
3. **日志监控**：通过Logcat监控状态变化
4. **性能考虑**：多张卡片绘制可能影响性能，注意优化

这个修复确保了层叠卡片预览功能按预期工作，用户可以看到所有后台卡片的完整预览！
