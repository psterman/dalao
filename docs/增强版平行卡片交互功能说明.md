# 增强版平行卡片交互功能说明

## 🎯 功能概述

全新的增强版平行卡片交互系统，提供更直观、更流畅的多任务管理体验：

1. **Tab区域滑动控制** → 在tab区域左右滑动时，卡片跟随滑动
2. **自动打开机制** → 当卡片位于中间时，自动打开这个卡片
3. **向上滑动关闭** → 往上滑时中间卡片向上移动，超过阈值时关闭

## 🚀 激活和使用方法

### 激活方式
1. 切换到搜索tab（底部导航栏第二个图标）
2. **长按搜索tab图标** 或 **长按底部导航栏**
3. 系统显示所有网页卡片的平行排列

### 核心交互

#### 1. Tab区域左右滑动控制
- **操作**：在tab区域（WebView容器）左右滑动
- **效果**：卡片跟随滑动，实时切换中心卡片
- **视觉反馈**：中心卡片最大最亮，边缘卡片较小较暗

#### 2. 手指释放打开机制
- **触发条件**：手指释放时，中间的卡片自动打开
- **自动行为**：对齐到最近卡片后自动切换到该网页并隐藏预览
- **用户体验**：简单直观，释放即打开

#### 3. 向上滑动关闭卡片
- **操作**：在tab区域向上滑动
- **效果**：只有中间的卡片向上移动
- **关闭条件**：向上移动超过卡片高度的50%
- **动画效果**：300ms向上飞出动画

## 🎨 视觉设计

### 卡片布局
- **卡片大小**：屏幕宽度70%，高度60%
- **排列方式**：水平平行排列，有20%重叠
- **间距计算**：卡片间距为卡片宽度的80%

### 视觉效果
- **中心卡片**：缩放1.0，透明度1.0（最大最亮）
- **边缘卡片**：缩放0.7-1.0，透明度0.5-1.0（逐渐变小变暗）
- **垂直偏移**：只有中心卡片可以垂直移动

### 交互反馈
- **中心指示器**：屏幕中央有白色指示线
- **实时缩放**：滑动时卡片实时缩放和透明度变化
- **关闭阈值**：卡片高度的50%，视觉反馈清晰

## 🎮 详细交互流程

### 阶段1：激活平行显示
```
长按搜索tab → 显示平行卡片排列 → 第一张卡片居中
```

### 阶段2：Tab区域滑动控制
```
在tab区域左右滑动 → 卡片跟随滑动 → 实时切换中心卡片
```
- **坐标转换**：将tab区域的触摸坐标转换为StackedCardPreview坐标
- **实时响应**：滑动过程中卡片实时移动和缩放
- **平滑过渡**：所有视觉效果都有平滑的动画过渡

### 阶段3：手指释放打开机制
```
手指释放 → 对齐到最近卡片 → 自动打开中间卡片
```
- **释放检测**：检测手指离开屏幕
- **自动对齐**：平滑对齐到最近的卡片
- **立即打开**：对齐完成后立即打开中间卡片

### 阶段4：向上滑动关闭
```
向上滑动 → 中心卡片向上移动 → 检查阈值 → 关闭或回弹
```
- **垂直检测**：检测垂直拖拽方向
- **单卡片移动**：只有中心卡片响应垂直移动
- **阈值判断**：超过卡片高度50%触发关闭

## 🔧 技术实现

### 坐标转换系统
```kotlin
// 获取容器和预览器的屏幕坐标
val location = IntArray(2)
browserWebViewContainer.getLocationOnScreen(location)
val previewLocation = IntArray(2)
preview.getLocationOnScreen(previewLocation)

// 计算相对坐标
val relativeX = location[0] - previewLocation[0] + event.x
val relativeY = location[1] - previewLocation[1] + event.y

// 创建相对坐标的触摸事件
val relativeEvent = MotionEvent.obtain(...)
```

### 双向拖拽检测
```kotlin
// 判断拖拽方向
if (abs(deltaX) > abs(deltaY)) {
    isDragging = true // 水平拖拽
} else {
    isVerticalDragging = true // 垂直拖拽
}

// 水平拖拽处理
private fun handleHorizontalDrag(deltaX: Float) {
    scrollOffset -= deltaX * 0.5f
    // 计算新的中心卡片
    val newCardIndex = (scrollOffset / cardSpacing + 0.5f).toInt()
}

// 垂直拖拽处理
private fun handleVerticalDrag(deltaY: Float) {
    if (deltaY < 0) { // 只有向上拖拽有效
        centerCardOffsetY = deltaY
    }
}
```

### 手指释放打开机制
```kotlin
private fun snapToNearestCardAndOpen() {
    val targetOffset = currentCardIndex * cardSpacing

    if (abs(scrollOffset - targetOffset) > 5f) {
        // 使用动画平滑对齐，然后打开卡片
        ValueAnimator.ofFloat(scrollOffset, targetOffset).apply {
            duration = 200
            addListener(object : AnimatorListenerAdapter() {
                override fun onAnimationEnd(animation: Animator) {
                    // 对齐完成后，打开中间卡片
                    selectCurrentCard()
                }
            })
            start()
        }
    } else {
        // 已经对齐，直接打开卡片
        selectCurrentCard()
    }
}
```

### 关闭动画系统
```kotlin
private fun animateCardClose() {
    ValueAnimator.ofFloat(centerCardOffsetY, -height.toFloat()).apply {
        duration = 300
        addUpdateListener { animator ->
            centerCardOffsetY = animator.animatedValue as Float
            invalidate()
        }
        addListener(object : AnimatorListenerAdapter() {
            override fun onAnimationEnd(animation: Animator) {
                onCardCloseListener?.invoke(currentCardIndex)
                removeCard(currentCardIndex)
            }
        })
        start()
    }
}
```

## 📱 使用场景

### 适用情况
- 打开了多个网页标签
- 需要快速预览和切换网页
- 想要关闭不需要的网页

### 最佳体验
1. **激活预览**：长按搜索tab激活平行卡片显示
2. **滑动浏览**：在tab区域左右滑动浏览所有网页
3. **释放打开**：滑动到想要的网页后释放手指，自动打开
4. **关闭网页**：向上滑动关闭不需要的网页

## 🎯 交互优势

### 与传统方式对比
| 特性 | 传统方式 | 增强版平行模式 |
|------|---------|---------------|
| 激活方式 | 复杂手势 | ✅ 长按激活 |
| 滑动控制 | 需要精确触摸卡片 | ✅ 整个tab区域都可滑动 |
| 打开方式 | 手动点击 | ✅ 释放即打开 |
| 关闭方式 | 复杂操作 | ✅ 简单向上滑动 |
| 视觉反馈 | 不够直观 | ✅ 清晰的视觉层次 |

### 用户体验优势
- **操作简单**：整个tab区域都可以滑动控制
- **反馈及时**：实时的视觉反馈和动画效果
- **简单直观**：释放即打开，操作简单
- **直观明确**：清晰的关闭阈值和动画反馈

## 🧪 测试方法

### 基础功能测试
1. **切换到搜索tab**
2. **长按底部导航栏**（调试模式）
3. **观察平行显示**：应该看到3张测试卡片

### 滑动控制测试
1. **在tab区域左右滑动**
2. **观察卡片跟随**：卡片应该跟随滑动
3. **观察视觉变化**：中心卡片最大最亮

### 释放打开测试
1. **滑动到某张卡片**
2. **释放手指**：手指离开屏幕
3. **观察自动打开**：应该对齐并自动切换网页

### 关闭功能测试
1. **向上滑动**：在tab区域向上滑动
2. **观察中心卡片移动**：只有中心卡片向上移动
3. **测试关闭阈值**：移动超过卡片高度50%应该关闭

## 📋 调试信息

### 关键日志
```
StackedCardPreview: 平行模式初始化: 卡片宽度=756.0, 间距=604.8, 关闭阈值=576.0
StackedCardPreview: 开始水平拖拽滑动
StackedCardPreview: 切换到卡片: 1
StackedCardPreview: 自动打开中心卡片: 1
StackedCardPreview: 开始垂直拖拽（关闭卡片）
StackedCardPreview: 关闭中心卡片: 1
```

这个增强版平行卡片交互系统提供了更加直观、流畅、智能的多任务管理体验！
