# 临时专线重新规划测试指南

## 重新规划内容

根据临时专线服务介绍，重新规划了发送、接收、转换、排版的逻辑：

### 1. URL构建逻辑
- **原实现**：使用查询参数 `https://818233.xyz/?q=问题`
- **新实现**：直接拼接路径 `https://818233.xyz/问题内容`

### 2. 消息编码处理
- **空格处理**：空格替换为 `+`
- **特殊字符处理**：
  - `+` 用 `++` 替换
  - `/` 用 `//` 替换
- **URL编码**：对处理后的消息进行URL编码

### 3. 请求头优化
- 添加了更完整的User-Agent
- 添加了Accept和Accept-Language头
- 增加了超时时间（15秒连接，45秒读取）

### 4. 响应处理增强
- **HTML内容提取**：使用多种正则表达式模式提取AI回复
- **文本清理**：移除HTML标签，合并空白字符
- **格式化**：优化文本格式，合并多余空行

## 测试步骤

### 1. 基础功能测试
1. 启动应用
2. 进入对话tab，点击"临时专线"
3. 发送简单消息："你好"
4. 验证是否能收到回复

### 2. 特殊字符测试
测试以下消息，验证特殊字符处理：
- `"hello world"` - 测试空格处理
- `"1+1=?"` - 测试加号处理
- `"path/to/file"` - 测试斜杠处理
- `"hello+world/path"` - 测试组合特殊字符

### 3. 中文消息测试
- `"你好，请介绍一下自己"`
- `"什么是人工智能？"`
- `"请帮我写一首诗"`

### 4. 长消息测试
- 发送较长的消息，验证URL长度限制处理
- 发送包含换行的消息

### 5. 响应格式测试
验证以下响应处理：
- HTML标签是否正确移除
- 文本格式是否正确
- 空行是否合理合并
- 响应长度是否在合理范围内

## 预期结果

### 1. URL构建验证
**测试消息**：`"hello world"`
**预期URL**：`https://818233.xyz/hello+world`

**测试消息**：`"1+1=?"`
**预期URL**：`https://818233.xyz/1%2B%2B1%3D%3F`

**测试消息**：`"path/to/file"`
**预期URL**：`https://818233.xyz/path%2F%2Fto%2F%2Ffile`

### 2. 响应处理验证
- 响应应该移除所有HTML标签
- 文本应该格式整洁，无多余空白
- 响应长度应该在合理范围内（不超过2000字符）
- 如果响应为空或过短，应显示友好的错误消息

### 3. 错误处理验证
- 网络错误时显示友好提示
- 服务不可用时显示相应消息
- 响应解析失败时有备用处理

## 技术实现细节

### 1. 消息处理函数
```kotlin
private fun processMessageForTempService(message: String): String {
    val processed = message
        .replace("+", "++")  // + 用 ++ 替换
        .replace("/", "//")  // / 用 // 替换
        .replace(" ", "+")   // 空格用 + 替换
    
    return java.net.URLEncoder.encode(processed, "UTF-8")
}
```

### 2. URL构建
```kotlin
val processedMessage = processMessageForTempService(message)
val url = URL("${config.apiUrl}$processedMessage")
```

### 3. 响应提取
使用多种正则表达式模式提取AI回复：
- `<main[^>]*>(.*?)</main>`
- `<div[^>]*class="[^"]*content[^"]*"[^>]*>(.*?)</div>`
- `<div[^>]*class="[^"]*response[^"]*"[^>]*>(.*?)</div>`
- `<p[^>]*>(.*?)</p>`

### 4. 文本格式化
- 移除HTML标签
- 合并多个空白字符
- 合并多个空行
- 限制最大长度

## 验证要点

### 1. 功能验证
- [ ] 简单消息能正常发送和接收
- [ ] 特殊字符处理正确
- [ ] 中文消息处理正常
- [ ] 长消息处理合理

### 2. 格式验证
- [ ] URL构建符合服务规范
- [ ] 响应文本格式整洁
- [ ] HTML标签正确移除
- [ ] 错误处理友好

### 3. 性能验证
- [ ] 请求响应时间合理
- [ ] 内存使用正常
- [ ] 无内存泄漏

### 4. 兼容性验证
- [ ] 与现有AI服务兼容
- [ ] 不影响其他功能
- [ ] 在不同设备上正常工作

## 日志监控

在测试过程中，注意观察以下日志：
- `临时专线请求URL: ...`
- `原始消息: ...`
- `处理后消息: ...`
- `临时专线响应成功，长度: ...`
- `清理后响应长度: ...`

这些日志有助于诊断问题和验证实现是否正确。

