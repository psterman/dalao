# AI回复文本排版优化测试指南

## 优化概述

本次优化全面改进了对话tab中AI回复文本的排版，实现了以下增强：

1. **分层格式化处理**：将文本格式化分为7个步骤，确保处理顺序正确
2. **增强的Markdown支持**：改进标题、列表、代码块等格式的显示
3. **智能断行和分段**：根据内容结构自动添加适当的换行和空格
4. **分类清晰的排版**：使用序号、符号和表情符号让内容更有层次感

## 技术实现

### 1. 分层格式化架构
```kotlin
// 第一步：处理标题格式 - 增强版
cleanedContent = formatHeadings(cleanedContent)

// 第二步：处理列表格式 - 增强版
cleanedContent = formatLists(cleanedContent)

// 第三步：处理代码块和行内代码
cleanedContent = formatCodeBlocks(cleanedContent)

// 第四步：处理强调和粗体
cleanedContent = formatEmphasis(cleanedContent)

// 第五步：处理段落和换行
cleanedContent = formatParagraphs(cleanedContent)

// 第六步：处理特殊格式和结构
cleanedContent = formatSpecialStructures(cleanedContent)

// 第七步：最终清理和优化
cleanedContent = finalCleanup(cleanedContent)
```

### 2. 标题格式化
- **一级标题**：`# 标题` → `■ 标题`
- **二级标题**：`## 标题` → `▪ 标题`
- **三级标题**：`### 标题` → `▫ 标题`
- **多级标题**：自动处理H1-H6标签

### 3. 列表格式化
- **有序列表**：`1. 项目` → `  1. 项目`（保持数字序号）
- **无序列表**：`- 项目` → `  • 项目`
- **嵌套列表**：
  - 二级：`    ◦ 项目`
  - 三级：`      ▪ 项目`

### 4. 代码格式化
- **代码块**：```代码``` → 带边框的代码块
- **行内代码**：`代码` → `「代码」`

### 5. 特殊结构格式化
- **问答格式**：`问：` → `❓ 问：`，`答：` → `💡 答：`
- **步骤格式**：`步骤1：` → `📋 步骤1：`
- **要点格式**：`要点1：` → `🔹 要点1：`
- **注意事项**：`注意：` → `⚠️ 注意：`
- **总结格式**：`总结：` → `📝 总结：`

## 测试步骤

### 测试1：标题格式化
1. 向AI发送包含标题的消息，如：
   ```
   请解释以下内容：
   # 主要概念
   ## 详细说明
   ### 具体例子
   ```
2. **预期结果**：
   - `# 主要概念` 显示为 `■ 主要概念`
   - `## 详细说明` 显示为 `▪ 详细说明`
   - `### 具体例子` 显示为 `▫ 具体例子`

### 测试2：列表格式化
1. 向AI发送包含列表的消息，如：
   ```
   请列出以下步骤：
   1. 第一步
   2. 第二步
   - 子项目1
   - 子项目2
   ```
2. **预期结果**：
   - 有序列表保持数字序号，有适当缩进
   - 无序列表使用 `•` 符号
   - 嵌套列表有层级缩进

### 测试3：代码格式化
1. 向AI发送包含代码的消息，如：
   ```
   请提供以下代码：
   ```python
   def hello():
       print("Hello World")
   ```
   使用 `print` 函数输出。
   ```
2. **预期结果**：
   - 代码块有边框显示
   - 行内代码用 `「」` 包围

### 测试4：特殊结构格式化
1. 向AI发送包含特殊结构的消息，如：
   ```
   请回答：
   问：什么是人工智能？
   答：人工智能是...
   步骤1：理解概念
   步骤2：学习应用
   注意：需要多练习
   总结：AI很重要
   ```
2. **预期结果**：
   - 问答格式有表情符号标识
   - 步骤格式有编号和图标
   - 注意事项有警告图标
   - 总结有文档图标

### 测试5：段落和换行优化
1. 向AI发送长文本消息
2. **预期结果**：
   - 句号、问号、感叹号后自动换行
   - 冒号后适当换行
   - 段落之间有适当间距
   - 没有过多的连续换行

### 测试6：群聊模式格式化
1. 在群聊中向AI发送包含各种格式的消息
2. **预期结果**：
   - 群聊中的AI回复也应用相同的格式化
   - 多个AI的回复都正确格式化
   - 格式化不影响群聊的其他功能

## 格式化效果对比

### 优化前
```
# 标题
## 子标题
1. 列表项1
2. 列表项2
- 子项目
**粗体** *斜体* `代码`
问：问题
答：答案
```

### 优化后
```
■ 标题

▪ 子标题

  1. 列表项1
  2. 列表项2
    ◦ 子项目

【粗体】 斜体 「代码」

❓ 问：问题

💡 答：答案
```

## 验证要点

### 1. 格式正确性
- [ ] 标题格式正确显示
- [ ] 列表格式层次清晰
- [ ] 代码块有边框显示
- [ ] 特殊结构有图标标识

### 2. 可读性提升
- [ ] 文本分段合理
- [ ] 换行位置恰当
- [ ] 缩进层次清晰
- [ ] 没有格式混乱

### 3. 兼容性
- [ ] 单聊模式格式化正常
- [ ] 群聊模式格式化正常
- [ ] 不同AI的回复都格式化
- [ ] 不影响其他功能

### 4. 性能表现
- [ ] 格式化处理速度快
- [ ] 不影响消息发送速度
- [ ] 内存使用合理
- [ ] 没有明显的性能问题

## 特殊格式说明

### 1. 标题层级
- `■` 一级标题（最重要）
- `▪` 二级标题（重要）
- `▫` 三级标题（一般）

### 2. 列表符号
- `•` 主要列表项
- `◦` 二级列表项
- `▪` 三级列表项

### 3. 特殊标识
- `❓` 问题
- `💡` 答案/提示
- `📋` 步骤
- `🔹` 要点
- `⚠️` 注意
- `📝` 总结

### 4. 代码格式
- `「」` 行内代码
- `┌─ 代码块 ─┐` 代码块边框
- `└─────────┘` 代码块边框

## 测试完成标准

- [ ] 所有格式类型正确显示
- [ ] 文本排版整齐有序
- [ ] 分类清晰易读
- [ ] 单聊和群聊模式都正常
- [ ] 性能表现良好
- [ ] 用户体验提升明显

## 注意事项

1. **向后兼容**：格式化不影响现有功能
2. **性能优化**：格式化处理高效快速
3. **可读性优先**：确保文本易于阅读
4. **一致性**：所有AI回复使用统一格式
